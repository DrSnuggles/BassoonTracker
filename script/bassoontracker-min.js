/*BassoonTracker v0.3.7 by Steffest - build 2020-04-09 - Full source on https://github.com/steffest/BassoonTracker */var BassoonTracker=function(){function audioBufferToWav(a,b){b=b||{};var c,d=a.numberOfChannels,e=a.sampleRate,f=b.float32?3:1,g=3===f?32:16;return c=2===d?function(a,b){for(var c=a.length+b.length,d=new Float32Array(c),e=0,f=0;e<c;)d[e++]=a[f],d[e++]=b[f],f++;return d}(a.getChannelData(0),a.getChannelData(1)):a.getChannelData(0),encodeWAV(c,f,e,d,g)}function encodeWAV(a,b,c,d,e){function f(a,b,c){for(var d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))}var g=e/8,h=d*g,i=44+a.length*g,j=new ArrayBuffer(i),k=new DataView(j);f(k,0,"RIFF"),k.setUint32(4,36+a.length*g,!0),f(k,8,"WAVE"),f(k,12,"fmt "),k.setUint32(16,16,!0),k.setUint16(20,b,!0),k.setUint16(22,d,!0),k.setUint32(24,c,!0),k.setUint32(28,c*h,!0),k.setUint16(32,h,!0),k.setUint16(34,e,!0),f(k,36,"data"),k.setUint32(40,a.length*g,!0);var l,m=44;if(1===b)for(l=0;l<a.length;l++,m+=2){var n=Math.max(-1,Math.min(1,a[l]));k.setInt16(m,n<0?32768*n:32767*n,!0)}else for(l=0;l<a.length;l++,m+=4)k.setFloat32(m,a[l],!0);return j}function getUrlParameter(a){if(window.location.getParameter)return window.location.getParameter(a);if(location.search)for(var b=location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");if(d[0]&&d[0]==a)return d[1]||!0}}function formatFileSize(a){var b="k";return isNaN(a)&&(a=0),a=Math.round(a/1e3),a>1e3&&(a=Math.round(a/100)/10,b="MB"),a+b}function createSlug(a){var b={"Á":"A","Ă":"A","Ắ":"A","Ặ":"A","Ằ":"A","Ẳ":"A","Ẵ":"A","Ǎ":"A","Â":"A","Ấ":"A","Ậ":"A","Ầ":"A","Ẩ":"A","Ẫ":"A","Ä":"A","Ǟ":"A","Ȧ":"A","Ǡ":"A","Ạ":"A","Ȁ":"A","À":"A","Ả":"A","Ȃ":"A","Ā":"A","Ą":"A","Å":"A","Ǻ":"A","Ḁ":"A","Ⱥ":"A","Ã":"A","Ꜳ":"AA","Æ":"AE","Ǽ":"AE","Ǣ":"AE","Ꜵ":"AO","Ꜷ":"AU","Ꜹ":"AV","Ꜻ":"AV","Ꜽ":"AY","Ḃ":"B","Ḅ":"B","Ɓ":"B","Ḇ":"B","Ƀ":"B","Ƃ":"B","Ć":"C","Č":"C","Ç":"C","Ḉ":"C","Ĉ":"C","Ċ":"C","Ƈ":"C","Ȼ":"C","Ď":"D","Ḑ":"D","Ḓ":"D","Ḋ":"D","Ḍ":"D","Ɗ":"D","Ḏ":"D","ǲ":"D","ǅ":"D","Đ":"D","Ƌ":"D","Ǳ":"DZ","Ǆ":"DZ","É":"E","Ĕ":"E","Ě":"E","Ȩ":"E","Ḝ":"E","Ê":"E","Ế":"E","Ệ":"E","Ề":"E","Ể":"E","Ễ":"E","Ḙ":"E","Ë":"E","Ė":"E","Ẹ":"E","Ȅ":"E","È":"E","Ẻ":"E","Ȇ":"E","Ē":"E","Ḗ":"E","Ḕ":"E","Ę":"E","Ɇ":"E","Ẽ":"E","Ḛ":"E","Ꝫ":"ET","Ḟ":"F","Ƒ":"F","Ǵ":"G","Ğ":"G","Ǧ":"G","Ģ":"G","Ĝ":"G","Ġ":"G","Ɠ":"G","Ḡ":"G","Ǥ":"G","Ḫ":"H","Ȟ":"H","Ḩ":"H","Ĥ":"H","Ⱨ":"H","Ḧ":"H","Ḣ":"H","Ḥ":"H","Ħ":"H","Í":"I","Ĭ":"I","Ǐ":"I","Î":"I","Ï":"I","Ḯ":"I","İ":"I","Ị":"I","Ȉ":"I","Ì":"I","Ỉ":"I","Ȋ":"I","Ī":"I","Į":"I","Ɨ":"I","Ĩ":"I","Ḭ":"I","Ꝺ":"D","Ꝼ":"F","Ᵹ":"G","Ꞃ":"R","Ꞅ":"S","Ꞇ":"T","Ꝭ":"IS","Ĵ":"J","Ɉ":"J","Ḱ":"K","Ǩ":"K","Ķ":"K","Ⱪ":"K","Ꝃ":"K","Ḳ":"K","Ƙ":"K","Ḵ":"K","Ꝁ":"K","Ꝅ":"K","Ĺ":"L","Ƚ":"L","Ľ":"L","Ļ":"L","Ḽ":"L","Ḷ":"L","Ḹ":"L","Ⱡ":"L","Ꝉ":"L","Ḻ":"L","Ŀ":"L","Ɫ":"L","ǈ":"L","Ł":"L","Ǉ":"LJ","Ḿ":"M","Ṁ":"M","Ṃ":"M","Ɱ":"M","Ń":"N","Ň":"N","Ņ":"N","Ṋ":"N","Ṅ":"N","Ṇ":"N","Ǹ":"N","Ɲ":"N","Ṉ":"N","Ƞ":"N","ǋ":"N","Ñ":"N","Ǌ":"NJ","Ó":"O","Ŏ":"O","Ǒ":"O","Ô":"O","Ố":"O","Ộ":"O","Ồ":"O","Ổ":"O","Ỗ":"O","Ö":"O","Ȫ":"O","Ȯ":"O","Ȱ":"O","Ọ":"O","Ő":"O","Ȍ":"O","Ò":"O","Ỏ":"O","Ơ":"O","Ớ":"O","Ợ":"O","Ờ":"O","Ở":"O","Ỡ":"O","Ȏ":"O","Ꝋ":"O","Ꝍ":"O","Ō":"O","Ṓ":"O","Ṑ":"O","Ɵ":"O","Ǫ":"O","Ǭ":"O","Ø":"O","Ǿ":"O","Õ":"O","Ṍ":"O","Ṏ":"O","Ȭ":"O","Ƣ":"OI","Ꝏ":"OO","Ɛ":"E","Ɔ":"O","Ȣ":"OU","Ṕ":"P","Ṗ":"P","Ꝓ":"P","Ƥ":"P","Ꝕ":"P","Ᵽ":"P","Ꝑ":"P","Ꝙ":"Q","Ꝗ":"Q","Ŕ":"R","Ř":"R","Ŗ":"R","Ṙ":"R","Ṛ":"R","Ṝ":"R","Ȑ":"R","Ȓ":"R","Ṟ":"R","Ɍ":"R","Ɽ":"R","Ꜿ":"C","Ǝ":"E","Ś":"S","Ṥ":"S","Š":"S","Ṧ":"S","Ş":"S","Ŝ":"S","Ș":"S","Ṡ":"S","Ṣ":"S","Ṩ":"S","Ť":"T","Ţ":"T","Ṱ":"T","Ț":"T","Ⱦ":"T","Ṫ":"T","Ṭ":"T","Ƭ":"T","Ṯ":"T","Ʈ":"T","Ŧ":"T","Ɐ":"A","Ꞁ":"L","Ɯ":"M","Ʌ":"V","Ꜩ":"TZ","Ú":"U","Ŭ":"U","Ǔ":"U","Û":"U","Ṷ":"U","Ü":"U","Ǘ":"U","Ǚ":"U","Ǜ":"U","Ǖ":"U","Ṳ":"U","Ụ":"U","Ű":"U","Ȕ":"U","Ù":"U","Ủ":"U","Ư":"U","Ứ":"U","Ự":"U","Ừ":"U","Ử":"U","Ữ":"U","Ȗ":"U","Ū":"U","Ṻ":"U","Ų":"U","Ů":"U","Ũ":"U","Ṹ":"U","Ṵ":"U","Ꝟ":"V","Ṿ":"V","Ʋ":"V","Ṽ":"V","Ꝡ":"VY","Ẃ":"W","Ŵ":"W","Ẅ":"W","Ẇ":"W","Ẉ":"W","Ẁ":"W","Ⱳ":"W","Ẍ":"X","Ẋ":"X","Ý":"Y","Ŷ":"Y","Ÿ":"Y","Ẏ":"Y","Ỵ":"Y","Ỳ":"Y","Ƴ":"Y","Ỷ":"Y","Ỿ":"Y","Ȳ":"Y","Ɏ":"Y","Ỹ":"Y","Ź":"Z","Ž":"Z","Ẑ":"Z","Ⱬ":"Z","Ż":"Z","Ẓ":"Z","Ȥ":"Z","Ẕ":"Z","Ƶ":"Z","Ĳ":"IJ","Œ":"OE","ᴀ":"A","ᴁ":"AE","ʙ":"B","ᴃ":"B","ᴄ":"C","ᴅ":"D","ᴇ":"E","ꜰ":"F","ɢ":"G","ʛ":"G","ʜ":"H","ɪ":"I","ʁ":"R","ᴊ":"J","ᴋ":"K","ʟ":"L","ᴌ":"L","ᴍ":"M","ɴ":"N","ᴏ":"O","ɶ":"OE","ᴐ":"O","ᴕ":"OU","ᴘ":"P","ʀ":"R","ᴎ":"N","ᴙ":"R","ꜱ":"S","ᴛ":"T","ⱻ":"E","ᴚ":"R","ᴜ":"U","ᴠ":"V","ᴡ":"W","ʏ":"Y","ᴢ":"Z","á":"a","ă":"a","ắ":"a","ặ":"a","ằ":"a","ẳ":"a","ẵ":"a","ǎ":"a","â":"a","ấ":"a","ậ":"a","ầ":"a","ẩ":"a","ẫ":"a","ä":"a","ǟ":"a","ȧ":"a","ǡ":"a","ạ":"a","ȁ":"a","à":"a","ả":"a","ȃ":"a","ā":"a","ą":"a","ᶏ":"a","ẚ":"a","å":"a","ǻ":"a","ḁ":"a","ⱥ":"a","ã":"a","ꜳ":"aa","æ":"ae","ǽ":"ae","ǣ":"ae","ꜵ":"ao","ꜷ":"au","ꜹ":"av","ꜻ":"av","ꜽ":"ay","ḃ":"b","ḅ":"b","ɓ":"b","ḇ":"b","ᵬ":"b","ᶀ":"b","ƀ":"b","ƃ":"b","ɵ":"o","ć":"c","č":"c","ç":"c","ḉ":"c","ĉ":"c","ɕ":"c","ċ":"c","ƈ":"c","ȼ":"c","ď":"d","ḑ":"d","ḓ":"d","ȡ":"d","ḋ":"d","ḍ":"d","ɗ":"d","ᶑ":"d","ḏ":"d","ᵭ":"d","ᶁ":"d","đ":"d","ɖ":"d","ƌ":"d","ı":"i","ȷ":"j","ɟ":"j","ʄ":"j","ǳ":"dz","ǆ":"dz","é":"e","ĕ":"e","ě":"e","ȩ":"e","ḝ":"e","ê":"e","ế":"e","ệ":"e","ề":"e","ể":"e","ễ":"e","ḙ":"e","ë":"e","ė":"e","ẹ":"e","ȅ":"e","è":"e","ẻ":"e","ȇ":"e","ē":"e","ḗ":"e","ḕ":"e","ⱸ":"e","ę":"e","ᶒ":"e","ɇ":"e","ẽ":"e","ḛ":"e","ꝫ":"et","ḟ":"f","ƒ":"f","ᵮ":"f","ᶂ":"f","ǵ":"g","ğ":"g","ǧ":"g","ģ":"g","ĝ":"g","ġ":"g","ɠ":"g","ḡ":"g","ᶃ":"g","ǥ":"g","ḫ":"h","ȟ":"h","ḩ":"h","ĥ":"h","ⱨ":"h","ḧ":"h","ḣ":"h","ḥ":"h","ɦ":"h","ẖ":"h","ħ":"h","ƕ":"hv","í":"i","ĭ":"i","ǐ":"i","î":"i","ï":"i","ḯ":"i","ị":"i","ȉ":"i","ì":"i","ỉ":"i","ȋ":"i","ī":"i","į":"i","ᶖ":"i","ɨ":"i","ĩ":"i","ḭ":"i","ꝺ":"d","ꝼ":"f","ᵹ":"g","ꞃ":"r","ꞅ":"s","ꞇ":"t","ꝭ":"is","ǰ":"j","ĵ":"j","ʝ":"j","ɉ":"j","ḱ":"k","ǩ":"k","ķ":"k","ⱪ":"k","ꝃ":"k","ḳ":"k","ƙ":"k","ḵ":"k","ᶄ":"k","ꝁ":"k","ꝅ":"k","ĺ":"l","ƚ":"l","ɬ":"l","ľ":"l","ļ":"l","ḽ":"l","ȴ":"l","ḷ":"l","ḹ":"l","ⱡ":"l","ꝉ":"l","ḻ":"l","ŀ":"l","ɫ":"l","ᶅ":"l","ɭ":"l","ł":"l","ǉ":"lj",ſ:"s","ẜ":"s","ẛ":"s","ẝ":"s","ḿ":"m","ṁ":"m","ṃ":"m","ɱ":"m","ᵯ":"m","ᶆ":"m","ń":"n","ň":"n","ņ":"n","ṋ":"n","ȵ":"n","ṅ":"n","ṇ":"n","ǹ":"n","ɲ":"n","ṉ":"n","ƞ":"n","ᵰ":"n","ᶇ":"n","ɳ":"n","ñ":"n","ǌ":"nj","ó":"o","ŏ":"o","ǒ":"o","ô":"o","ố":"o","ộ":"o","ồ":"o","ổ":"o","ỗ":"o","ö":"o","ȫ":"o","ȯ":"o","ȱ":"o","ọ":"o","ő":"o","ȍ":"o","ò":"o","ỏ":"o","ơ":"o","ớ":"o","ợ":"o","ờ":"o","ở":"o","ỡ":"o","ȏ":"o","ꝋ":"o","ꝍ":"o","ⱺ":"o","ō":"o","ṓ":"o","ṑ":"o","ǫ":"o","ǭ":"o","ø":"o","ǿ":"o","õ":"o","ṍ":"o","ṏ":"o","ȭ":"o","ƣ":"oi","ꝏ":"oo","ɛ":"e","ᶓ":"e","ɔ":"o","ᶗ":"o","ȣ":"ou","ṕ":"p","ṗ":"p","ꝓ":"p","ƥ":"p","ᵱ":"p","ᶈ":"p","ꝕ":"p","ᵽ":"p","ꝑ":"p","ꝙ":"q","ʠ":"q","ɋ":"q","ꝗ":"q","ŕ":"r","ř":"r","ŗ":"r","ṙ":"r","ṛ":"r","ṝ":"r","ȑ":"r","ɾ":"r","ᵳ":"r","ȓ":"r","ṟ":"r","ɼ":"r","ᵲ":"r","ᶉ":"r","ɍ":"r","ɽ":"r","ↄ":"c","ꜿ":"c","ɘ":"e","ɿ":"r","ś":"s","ṥ":"s","š":"s","ṧ":"s","ş":"s","ŝ":"s","ș":"s","ṡ":"s","ṣ":"s","ṩ":"s","ʂ":"s","ᵴ":"s","ᶊ":"s","ȿ":"s","ɡ":"g","ᴑ":"o","ᴓ":"o","ᴝ":"u","ť":"t","ţ":"t","ṱ":"t","ț":"t","ȶ":"t","ẗ":"t","ⱦ":"t","ṫ":"t","ṭ":"t","ƭ":"t","ṯ":"t","ᵵ":"t","ƫ":"t","ʈ":"t","ŧ":"t","ᵺ":"th","ɐ":"a","ᴂ":"ae","ǝ":"e","ᵷ":"g","ɥ":"h","ʮ":"h","ʯ":"h","ᴉ":"i","ʞ":"k","ꞁ":"l","ɯ":"m","ɰ":"m","ᴔ":"oe","ɹ":"r","ɻ":"r","ɺ":"r","ⱹ":"r","ʇ":"t","ʌ":"v","ʍ":"w","ʎ":"y","ꜩ":"tz","ú":"u","ŭ":"u","ǔ":"u","û":"u","ṷ":"u","ü":"u","ǘ":"u","ǚ":"u","ǜ":"u","ǖ":"u","ṳ":"u","ụ":"u","ű":"u","ȕ":"u","ù":"u","ủ":"u","ư":"u","ứ":"u","ự":"u","ừ":"u","ử":"u","ữ":"u","ȗ":"u","ū":"u","ṻ":"u","ų":"u","ᶙ":"u","ů":"u","ũ":"u","ṹ":"u","ṵ":"u","ᵫ":"ue","ꝸ":"um","ⱴ":"v","ꝟ":"v","ṿ":"v","ʋ":"v","ᶌ":"v","ⱱ":"v","ṽ":"v","ꝡ":"vy","ẃ":"w","ŵ":"w","ẅ":"w","ẇ":"w","ẉ":"w","ẁ":"w","ⱳ":"w","ẘ":"w","ẍ":"x","ẋ":"x","ᶍ":"x","ý":"y","ŷ":"y","ÿ":"y","ẏ":"y","ỵ":"y","ỳ":"y","ƴ":"y","ỷ":"y","ỿ":"y","ȳ":"y","ẙ":"y","ɏ":"y","ỹ":"y","ź":"z","ž":"z","ẑ":"z","ʑ":"z","ⱬ":"z","ż":"z","ẓ":"z","ȥ":"z","ẕ":"z","ᵶ":"z","ᶎ":"z","ʐ":"z","ƶ":"z","ɀ":"z","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ĳ":"ij","œ":"oe","ﬆ":"st","ₐ":"a","ₑ":"e","ᵢ":"i","ⱼ":"j","ₒ":"o","ᵣ":"r","ᵤ":"u","ᵥ":"v","ₓ":"x"};return a=a.split(" ").join("-"),a=a.replace(/[^A-Za-z0-9\[\] ]/g,function(a){return b[a]||a}),a=a.toLowerCase(),a=a.replace(/[^a-z0-9\-]+/g,"")}function loadFile(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="arraybuffer",c.onload=function(a){var d=c.response;d&&200===c.status?b&&b(d):void 0!==Editor&&b&&b(!1)},c.send(null)}function saveFile(a,b){var c=document.createElement("a");document.body.appendChild(c),c.style="display: none",url=window.URL.createObjectURL(a),c.href=url,c.download=b,c.click(),window.URL.revokeObjectURL(url)}function BinaryStream(a,b){function c(a){a=0===a?a:a||d.index,a<0&&(a=0),a>=d.length&&(a=d.length-1),d.index=a}var d={index:0,litteEndian:!b};if(d.goto=function(a){c(a)},d.jump=function(a){this.goto(this.index+a)},d.readByte=function(a){c(a);var b=this.dataView.getInt8(this.index);return this.index++,b},d.writeByte=function(a,b){c(b),this.dataView.setInt8(this.index,a),this.index++},d.readUbyte=function(a){c(a);var b=this.dataView.getUint8(this.index);return this.index++,b},d.writeUByte=function(a,b){c(b),this.dataView.setUint8(this.index,a),this.index++},d.readUint=function(a){c(a);var b=this.dataView.getUint32(this.index,this.litteEndian);return this.index+=4,b},d.writeUint=function(a,b){c(b),this.dataView.setUint32(this.index,a,this.litteEndian),this.index+=4},d.readBytes=function(a,b){c(b);var d=new Uint8Array(a),e=this.index;(a+=e)>this.length&&(a=this.length);for(var f=0;e<a;++e)d.setUint8(f++,this.dataView.getUint8(e));return this.index=a,d},d.readString=function(a,b){c(b);var d=this.index,e=this.dataView,f="";for((a+=d)>this.length&&(a=this.length);d<a;++d){var g=e.getUint8(d);if(0==g)break;f+=String.fromCharCode(g)}return this.index=a,f},d.writeString=function(a,b){c(b);for(var d=this.dataView,e=a.length,f=0;f<e;f++)d.setUint8(this.index+f,a.charCodeAt(f));this.index+=e},d.writeStringSection=function(a,b,e,f){c(f),b=b||1,a=a||"",e=e||0;var g=a.length;g>b&&(a=a.substr(0,b)),d.writeString(a),d.fill(e,b-g)},d.readWord=function(a){c(a);var b=this.dataView.getUint16(this.index,this.litteEndian);return this.index+=2,b},d.writeWord=function(a,b){c(b),this.dataView.setUint16(this.index,a,this.litteEndian),this.index+=2},d.readLong=d.readDWord=d.readUint,d.writeLong=d.writeDWord=d.writeUint,d.readShort=function(a,b){c(b);var d=this.dataView.getInt16(this.index,this.litteEndian);return this.index+=2,d},d.clear=function(a){d.fill(0,a)},d.fill=function(a,b){a=a||0,b=b||0;for(var c=0;c<b;c++)d.writeByte(a)},d.isEOF=function(a){return a=a||0,this.index>=this.length-a},a)return d.buffer=a,d.dataView=new DataView(a),d.length=a.byteLength,d}function read8SVXsample(a,b){function c(){var b={};return b.name=a.readString(4),b.size=a.readDWord(),b}a.litteEndian=!1,a.goto(12);for(var d=c();"BODY"!=d.name&&!a.isEOF(10);)"NAME"==d.name?b.name=a.readString(d.size):a.jump(d.size),d=c();if("BODY"==d.name)for(var e=0;e<d.size;e++){var f=a.readByte();b.data.push(f/127)}}function detectSampleType(a,b,c){var d=SAMPLETYPE.RAW_8BIT,e=readRAWsample;a.goto(0);var f=a.readString(4);if("RIFF"==f&&(d=SAMPLETYPE.WAVE_PCM,e=readRIFFsample),"FORM"==f){a.goto(8);"8SVX"==a.readString(4)&&(d=SAMPLETYPE.IFF_8SVX,e=read8SVXsample)}if(b&&b.name&&".mp3"==b.name.toLowerCase().slice(-4)&&(d=SAMPLETYPE.MP3,e=decodeFileWithAudioContext),b&&e)e(a,b,c);else{if(!c)return d;c(d)}}function decodeFileWithAudioContext(a,b,c){Audio.context.decodeAudioData(a.buffer,function(a){if(!a)return void alert("error decoding file data: "+url);b.data=a.getChannelData(0),b.length=a.length,c&&c()},function(a){c&&c()})}function readRAWsample(a,b){a.goto(0);for(var c=0;c<b.length;c++){b.data.push(a.readByte()/127)}}function readRIFFsample(a,b,c){a.litteEndian=!0,a.goto(4);var d={};d.chunkSize=a.readDWord(),d.format=a.readString(4),d.subChunk=a.readString(4),d.subChuckSize=a.readDWord();var e=a.index+d.subChuckSize;if(d.audioFormat=a.readWord(),d.numberOfChannels=a.readWord(),d.sampleRate=a.readDWord(),d.byteRate=a.readDWord(),d.blockalign=a.readWord(),d.bits=a.readWord(),a.goto(e),d.dataChunk=a.readString(4),d.dataChuckSize=a.readDWord(),8===d.bits){b.length=d.dataChuckSize;for(var f=0;f<b.length;f++){var g=a.readUbyte();g-=128,b.data.push(g/128)}}else decodeFileWithAudioContext(a,b,c)}function encodeRIFFsample(a,b){var c=a.length,d=8e3;16===b&&(c=2*a.length,d=16e3);var e=c;e%2==1&&e++;var f=new ArrayBuffer(46+e),g=new BinaryStream(f,!1);if(g.goto(0),g.writeString("RIFF"),g.writeDWord(38+e),g.writeString("WAVE"),g.writeString("fmt "),g.writeDWord(18),g.writeWord(1),g.writeWord(1),g.writeDWord(8e3),g.writeDWord(d),g.writeWord(Math.floor(b/8)),g.writeWord(b),g.writeWord(0),g.writeString("data"),g.writeDWord(c),16===b)for(var h=0;h<a.length;h++)g.writeWord(32767*a[h]);else for(var h=0;h<a.length;h++)g.writeUByte(Math.round(127*a[h])+127);return c<e&&g.writeUByte(0),g}var cachedAssets={images:{},audio:{},json:{},arrayBuffer:{}},sprites={},UI=void 0,PRELOADTYPE={image:1,audio:2,json:3,binary:4},EVENT={instrumentChange:1,patternChange:2,patternPosChange:3,patternTableChange:4,recordingChange:5,cursorPositionChange:6,trackStateChange:7,playingChange:8,playTypeChange:9,songPositionChange:10,songSpeedChange:11,songBPMChange:12,samplePlay:13,screenRefresh:14,screenRender:15,songPropertyChange:16,instrumentNameChange:17,command:18,pianoNoteOn:19,pianoNoteOff:20,statusChange:21,diskOperationTargetChange:22,diskOperationActionChange:23,trackCountChange:24,patternHorizontalScrollChange:25,songLoaded:26,songLoading:27,trackerModeChanged:28,instrumentListChange:29,showView:30,toggleView:31,visibleTracksCountChange:32,filterChainCountChange:33,fxPanelToggle:34,samplePropertyChange:35,sampleIndexChange:36,second:37,minute:38,dropboxConnect:39,dropboxConnectCancel:40,trackScopeClick:41,octaveChanged:42,skipFrameChanged:43,showContextMenu:44,hideContextMenu:45,clockEventExpired:46,commandUndo:50,commandRedo:51,commandSelectAll:52,songEnd:53},COMMAND={newFile:1,openFile:2,saveFile:3,clearTrack:4,clearPattern:5,clearSong:6,clearInstruments:7,showMain:8,showOptions:9,showFileOperations:10,showSampleEditor:11,showAbout:12,showHelp:13,togglePiano:14,showTopMain:15,showBottomMain:16,randomSong:17,randomSongXM:18,showGithub:19,showStats:20,cut:21,copy:22,paste:23,pattern2Sample:24,toggleAppSideBar:25},PLAYTYPE={song:1,pattern:2},FILETYPE={module:1,sample:2,pattern:3,track:4},MODULETYPE={mod:1,xm:2},SAMPLETYPE={RAW_8BIT:1,WAVE_PCM:2,IFF_8SVX:3,MP3:4,RIFF_8BIT:5,RIFF_16BIT:6},STEREOSEPARATION={FULL:1,BALANCED:2,NONE:3},FREQUENCYTABLE={AMIGA:1,LINEAR:2},LOOPTYPE={NONE:0,FORWARD:1,PINGPONG:2},SELECTION={RESET:1,CLEAR:2,CUT:3,COPY:4,PASTE:5,POSITION:6},EDITACTION={PATTERN:1,TRACK:2,NOTE:3},AMIGA_PALFREQUENCY=7093790,PC_FREQUENCY=7158728,AMIGA_PALFREQUENCY_HALF=3546895,PC_FREQUENCY_HALF=3579364,LAYOUTS={column4:4,column5:5,column5Full:6,column6:7},NOTEPERIOD={C1:{period:856,name:"C-1",tune:[907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814]},Cs1:{period:808,name:"C#1",tune:[856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768]},D1:{period:762,name:"D-1",tune:[808,802,796,791,785,779,774,768,762,757,752,746,741,736,730,725]},Ds1:{period:720,name:"D#1",tune:[762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684]},E1:{period:678,name:"E-1",tune:[720,715,709,704,699,694,689,684,678,674,670,665,660,655,651,646]},F1:{period:640,name:"F-1",tune:[678,675,670,665,660,655,651,646,640,637,632,628,623,619,614,610]},Fs1:{period:604,name:"F#1",tune:[640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575]},G1:{period:570,name:"G-1",tune:[604,601,597,592,588,584,580,575,570,567,563,559,555,551,547,543]},Gs1:{period:538,name:"G#1",tune:[570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513]},A1:{period:508,name:"A-1",tune:[538,535,532,528,524,520,516,513,508,505,502,498,495,491,487,484]},As1:{period:480,name:"A#1",tune:[508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457]},B1:{period:453,name:"B-1",tune:[480,477,474,470,467,463,460,457,453,450,447,444,441,437,434,431]},C2:{period:428,name:"C-2",tune:[453,450,447,444,441,437,434,431,428,425,422,419,416,413,410,407]},Cs2:{period:404,name:"C#2",tune:[428,425,422,419,416,413,410,407,404,401,398,395,392,390,387,384]},D2:{period:381,name:"D-2",tune:[404,401,398,395,392,390,387,384,381,379,376,373,370,368,365,363]},Ds2:{period:360,name:"D#2",tune:[381,379,376,373,370,368,365,363,360,357,355,352,350,347,345,342]},E2:{period:339,name:"E-2",tune:[360,357,355,352,350,347,345,342,339,337,335,332,330,328,325,323]},F2:{period:320,name:"F-2",tune:[339,337,335,332,330,328,325,323,320,318,316,314,312,309,307,305]},Fs2:{period:302,name:"F#2",tune:[320,318,316,314,312,309,307,305,302,300,298,296,294,292,290,288]},G2:{period:285,name:"G-2",tune:[302,300,298,296,294,292,290,288,285,284,282,280,278,276,274,272]},Gs2:{period:269,name:"G#2",tune:[285,284,282,280,278,276,274,272,269,268,266,264,262,260,258,256]},A2:{period:254,name:"A-2",tune:[269,268,266,264,262,260,258,256,254,253,251,249,247,245,244,242]},As2:{period:240,name:"A#2",tune:[254,253,251,249,247,245,244,242,240,239,237,235,233,232,230,228]},B2:{period:226,name:"B-2",tune:[240,238,237,235,233,232,230,228,226,225,224,222,220,219,217,216]},C3:{period:214,name:"C-3",tune:[226,225,223,222,220,219,217,216,214,213,211,209,208,206,205,204]},Cs3:{period:202,name:"C#3",tune:[214,212,211,209,208,206,205,203,202,201,199,198,196,195,193,192]},D3:{period:190,name:"D-3",tune:[202,200,199,198,196,195,193,192,190,189,188,187,185,184,183,181]},Ds3:{period:180,name:"D#3",tune:[190,189,188,187,185,184,183,181,180,179,177,176,175,174,172,171]},E3:{period:170,name:"E-3",tune:[180,179,177,176,175,174,172,171,170,169,167,166,165,164,163,161]},F3:{period:160,name:"F-3",tune:[170,169,167,166,165,164,163,161,160,159,158,157,156,155,154,152]},Fs3:{period:151,name:"F#3",tune:[160,159,158,157,156,155,154,152,151,150,149,148,147,146,145,144]},G3:{period:143,name:"G-3",tune:[151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136]},Gs3:{period:135,name:"G#3",tune:[143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128]},A3:{period:127,name:"A-3",tune:[135,134,133,132,131,130,129,128,127,126,125,125,124,123,122,121]},As3:{period:120,name:"A#3",tune:[127,126,125,125,123,123,122,121,120,119,118,118,117,116,115,114]},B3:{period:113,name:"B-3",tune:[120,119,118,118,117,116,115,114,113,113,112,111,110,109,109,108]}},FTNOTEPERIOD={None:{name:"---"},C0:{name:"C-0",period:6848},Cs0:{name:"C#0",period:6464},D0:{name:"D-0",period:6096},Ds0:{name:"D#0",period:5760},E0:{name:"E-0",period:5424},F0:{name:"F-0",period:5120},Fs0:{name:"F#0",period:4832},G0:{name:"G-0",period:4560},Gs0:{name:"G#0",period:4304},A0:{name:"A-0",period:4064},As0:{name:"A#0",period:3840},B0:{name:"B-0",period:3624},C1:{name:"C-1",period:3424},Cs1:{name:"C#1",period:3232},D1:{name:"D-1",period:3048},Ds1:{name:"D#1",period:2880},E1:{name:"E-1",period:2712},F1:{name:"F-1",period:2560},Fs1:{name:"F#1",period:2416},G1:{name:"G-1",period:2280},Gs1:{name:"G#1",period:2152},A1:{name:"A-1",period:2032},As1:{name:"A#1",period:1920},B1:{name:"B-1",period:1812},C2:{name:"C-2",period:1712},Cs2:{name:"C#2",period:1616},D2:{name:"D-2",period:1524},Ds2:{name:"D#2",period:1440},E2:{name:"E-2",period:1356},F2:{name:"F-2",period:1280},Fs2:{name:"F#2",period:1208},G2:{name:"G-2",period:1140},Gs2:{name:"G#2",period:1076},A2:{name:"A-2",period:1016},As2:{name:"A#2",period:960},B2:{name:"B-2",period:906},C3:{name:"C-3",period:856},Cs3:{name:"C#3",period:808},D3:{name:"D-3",period:762},Ds3:{name:"D#3",period:720},E3:{name:"E-3",period:678},F3:{name:"F-3",period:640},Fs3:{name:"F#3",period:604},G3:{name:"G-3",period:570},Gs3:{name:"G#3",period:538},A3:{name:"A-3",period:508},As3:{name:"A#3",period:480},B3:{name:"B-3",period:453},C4:{name:"C-4",period:428},Cs4:{name:"C#4",period:404},D4:{name:"D-4",period:381},Ds4:{name:"D#4",period:360},E4:{name:"E-4",period:339},F4:{name:"F-4",period:320},Fs4:{name:"F#4",period:302},G4:{name:"G-4",period:285},Gs4:{name:"G#4",period:269},A4:{name:"A-4",period:254},As4:{name:"A#4",period:240},B4:{name:"B-4",period:226.5,modPeriod:226},C5:{name:"C-5",period:214},Cs5:{name:"C#5",period:202},D5:{name:"D-5",period:190.5,modPeriod:190},Ds5:{name:"D#5",period:180},E5:{name:"E-5",period:169.5,modPeriod:170},F5:{name:"F-5",period:160},Fs5:{name:"F#5",period:151},G5:{name:"G-5",period:142.5,modPeriod:143},Gs5:{name:"G#5",period:134.5,modPeriod:135},A5:{name:"A-5",period:127},As5:{name:"A#5",period:120},B5:{name:"B-5",period:113.25,modPeriod:113},C6:{name:"C-6",period:107},Cs6:{name:"C#6",period:101},D6:{name:"D-6",period:95.25,modPeriod:95},Ds6:{name:"D#6",period:90},E6:{name:"E-6",period:84.75,modPeriod:85},F6:{name:"F-6",period:80},Fs6:{name:"F#6",period:75.5,modPeriod:75},G6:{name:"G-6",period:71.25,modPeriod:71},Gs6:{name:"G#6",period:67.25,modPeriod:67},A6:{name:"A-6",period:63.5,modPeriod:63},As6:{name:"A#6",period:60},B6:{name:"B-6",period:56.625,modPeriod:56},C7:{name:"C-7",period:53.5,modPeriod:53},Cs7:{name:"C#7",period:50.5,modPeriod:50},D7:{name:"D-7",period:47.625,modPeriod:47},Ds7:{name:"D#7",period:45},E7:{name:"E-7",period:42.375,modPeriod:42},F7:{name:"F-7",period:40},Fs7:{name:"F#7",period:37.75,modPeriod:37},G7:{name:"G-7",period:35.625,modPeriod:35},Gs7:{name:"G#7",period:33.625,modPeriod:33},A7:{name:"A-7",period:31.75,modPeriod:31},As7:{name:"A#7",period:30},B7:{name:"B-7",period:28.3125,modPeriod:28},C8:{name:"C-8",period:26.75},Cs8:{name:"C#8",period:25.25},D8:{name:"D-8",period:23.8125},Ds8:{name:"D#8",period:22.5},E8:{name:"E-8",period:21.1875},F8:{name:"F-8",period:20},Fs8:{name:"F#8",period:18.875},G8:{name:"G-8",period:17.8125},Gs8:{name:"G#8",period:16.8125},A8:{name:"A-8",period:15.875},As8:{name:"A#8",period:15},B8:{name:"B-8",period:14.15625},C9:{name:"C-9",period:13.375},Cs9:{name:"C#9",period:12.625},D9:{name:"D-9",period:11.90625},Ds9:{name:"D#9",period:11.25},E9:{name:"E-9",period:10.59375},F9:{name:"F-9",period:10},Fs9:{name:"F#9",period:9.4375},G9:{name:"G-9",period:8.90625},Gs9:{name:"G#9",period:8.40625},A9:{name:"A-9",period:7.9375},As9:{name:"A#9",period:7.5},B9:{name:"B-9",period:7.078125},C10:{name:"C-10",period:6.6875},Cs10:{name:"C#10",period:6.3125},D10:{name:"D-10",period:5.953125},Ds10:{name:"D#10",period:5.625},E10:{name:"E-10",period:5.296875},F10:{name:"F-10",period:5},Fs10:{name:"F#10",period:4.71875},G10:{name:"G-10",period:4.453125},Gs10:{name:"G#10",period:4.203125},A10:{name:"A-10",period:3.96875},As10:{name:"A#10",period:3.75},B10:{name:"B-10",period:3.5390625},C11:{name:"C-11",period:3.34375},Cs11:{name:"C#11",period:3.15625},D11:{name:"D-11",period:2.9765625},Ds11:{name:"D#11",period:2.8125},E11:{name:"E-11",period:2.6484375},F11:{name:"F-11",period:2.5},Fs11:{name:"F#11",period:2.359375},G11:{name:"G-11",period:2.2265625},Gs11:{name:"G#11",period:2.1015625},A11:{name:"A-11",period:1.984375},As11:{name:"A#11",period:1.875},B11:{name:"B-11",period:1.76953125},OFF:{name:"OFF",period:0}},NOTEOFF=145,KEYBOARDKEYS={OFF:0,C:1,Csharp:2,D:3,Dsharp:4,E:5,F:6,Fsharp:7,G:8,Gsharp:9,A:10,Asharp:11,B:12,COctaveUp:13,CsharpOctaveUp:14,DOctaveUp:15,DsharpOctaveUp:16,EOctaveUp:17,FOctaveUp:18,FsharpOctaveUp:19,GOctaveUp:20,GsharpOctaveUp:21,AOctaveUp:22,AsharpOctaveUp:23,BOctaveUp:24,COctaveUp2:25,CsharpOctaveUp2:26,DOctaveUp2:27},OCTAVENOTES={0:{name:"OFF"},1:{name:"C"},2:{name:"Cs"},3:{name:"D"},4:{name:"Ds"},5:{name:"E"},6:{name:"F"},7:{name:"Fs"},8:{name:"G"},9:{name:"Gs"},10:{name:"A"},11:{name:"As"},12:{name:"B"}},KEYBOARDTABLE={azerty:{a:KEYBOARDKEYS.COctaveUp,z:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,y:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,"é":KEYBOARDKEYS.CsharpOctaveUp,'"':KEYBOARDKEYS.DsharpOctaveUp,"(":KEYBOARDKEYS.FsharpOctaveUp,"§":KEYBOARDKEYS.GsharpOctaveUp,"è":KEYBOARDKEYS.AsharpOctaveUp,"ç":KEYBOARDKEYS.CsharpOctaveUp2,w:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,",":KEYBOARDKEYS.B,";":KEYBOARDKEYS.COctaveUp,":":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"<":KEYBOARDKEYS.OFF},dvorak:{"'":KEYBOARDKEYS.COctaveUp,",":KEYBOARDKEYS.DOctaveUp,".":KEYBOARDKEYS.EOctaveUp,p:KEYBOARDKEYS.FOctaveUp,y:KEYBOARDKEYS.GOctaveUp,f:KEYBOARDKEYS.AOctaveUp,g:KEYBOARDKEYS.BOctaveUp,c:KEYBOARDKEYS.COctaveUp2,r:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,";":KEYBOARDKEYS.C,q:KEYBOARDKEYS.D,j:KEYBOARDKEYS.E,k:KEYBOARDKEYS.F,x:KEYBOARDKEYS.G,b:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,w:KEYBOARDKEYS.COctaveUp,v:KEYBOARDKEYS.DOctaveUp,o:KEYBOARDKEYS.Csharp,e:KEYBOARDKEYS.Dsharp,i:KEYBOARDKEYS.Fsharp,d:KEYBOARDKEYS.Gsharp,h:KEYBOARDKEYS.Asharp,n:KEYBOARDKEYS.CsharpOctaveUp,"\\":KEYBOARDKEYS.OFF},qwerty:{q:KEYBOARDKEYS.COctaveUp,w:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,y:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,z:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,",":KEYBOARDKEYS.COctaveUp,".":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"\\":KEYBOARDKEYS.OFF},qwertz:{q:KEYBOARDKEYS.COctaveUp,w:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,z:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,y:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,",":KEYBOARDKEYS.COctaveUp,".":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"\\":KEYBOARDKEYS.OFF}},TRACKERMODE={PROTRACKER:1,FASTTRACKER:2},SETTINGS={unrollLoops:!1,unrollShortLoops:!1,sustainKeyboardNotes:!1,useHover:!0,keyboardTable:"qwerty",vubars:!0,stereoSeparation:STEREOSEPARATION.BALANCED,emulateProtracker1OffsetBug:!0},EventBus=function(){var a={},b={};return b.on=function(b,c){var d=a[b];d||(d=[],a[b]=d),d.push(c)},b.trigger=function(b,c){var d=a[b];if(d){var e,f=d.length;for(e=0;e<f;e++)d[e](c,b)}},b}(),Audio=function(){function a(a){e=a.createGain(),e.gain.setValueAtTime(1,0),e.connect(a.destination),d=a.createGain(),d.connect(e),b.setMasterVolume(1),f=a.createBiquadFilter(),f.type="lowpass",f.frequency.setValueAtTime(2e4,0),f.connect(d),b.masterVolume=d,b.cutOffVolume=e,b.lowPassfilter=f}var b={};window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var c,d,e,f,g,h,i,j,k,l,m=[],n=[],o=STEREOSEPARATION.BALANCED,p=0,q=[[],[],[]],r=0,s=4143.569,t={volume:!0,panning:!0,high:!0,mid:!0,low:!0,lowPass:!0,reverb:!0,distortion:!1},u=!1;return AudioContext&&(c=new AudioContext),b.init=function(d){function e(){var a=FilterChain(t);a.output().connect(f),m.push(a)}if(d=d||c){k=!!Audio.context.createStereoPanner,l=void 0!==Editor,a(d);var h=Tracker.getTrackCount();for(m=[],g=0;g<h;g++)e();b.filterChains=m,b.usePanning=k,u||(EventBus.on(EVENT.trackStateChange,function(a){void 0!==a.track&&m[a.track]&&m[a.track].volumeValue(a.mute?0:70)}),EventBus.on(EVENT.trackCountChange,function(a){for(g=m.length;g<a;g++)e();EventBus.trigger(EVENT.filterChainCountChange,a),b.setStereoSeparation(o)}),EventBus.on(EVENT.trackerModeChanged,function(a){b.setStereoSeparation()}))}},b.enable=function(){e.gain.setValueAtTime(1,0),b.cutOff=!1},b.disable=function(){e.gain.setValueAtTime(0,0),b.cutOff=!0;var a=0;q.forEach(function(b,c){a+=b.length,b.forEach(function(a){a.gain.cancelScheduledValues(0),a.gain.setValueAtTime(0,0)}),q[c]=[]})},b.checkState=function(){c&&"suspended"===c.state&&c.resume&&c.resume()},b.playSample=function(a,d,e,f,h,i,n){var o;u?o=j:(o=c,b.enable()),d=d||428,void 0===f&&(f=l?Editor.getCurrentTrack():0),i=i||c.currentTime,n===NOTEOFF&&(e=0);var p,t,v,w=Tracker.getInstrument(a),x=d,y=0;if(w){var z,A=0,B=0;e=void 0===e?100*w.sample.volume/64:e,y=(w.sample.panning||0)/128;var C;Tracker.inFTMode()?Tracker.useLinearFrequency?d-=w.getFineTune()/2:w.getFineTune()&&(d=b.getFineTuneForNote(n,w.getFineTune())):w.getFineTune()&&(d=b.getFineTuneForPeriod(d,w.getFineTune())),C=b.getSampleRateForPeriod(d);var D=1;w.sample.data.length?(B=w.sample.data.length,h&&h.offset&&(h.offset.value>=B&&(h.offset.value=B-1),A=h.offset.value/o.sampleRate),z=o.createBuffer(1,B,o.sampleRate),D=C/o.sampleRate):(z=o.createBuffer(1,1,o.sampleRate),A=0);var E=z.getChannelData(0);for(g=0;g<B;g++)E[g]=w.sample.data[g];s=C;var F=o.createBufferSource();F.buffer=z;var G=o.createGain();if(G.gain.value=e/100,G.gain.setValueAtTime(e/100,i),w.sample.loop.enabled&&w.sample.loop.length>2&&(SETTINGS.unrollLoops||(F.loop=!0,F.loopStart=w.sample.loop.start/o.sampleRate,F.loopEnd=(w.sample.loop.start+w.sample.loop.length)/o.sampleRate)),w.volumeEnvelope.enabled||w.panningEnvelope.enabled||w.hasVibrato()){var H=w.noteOn(i),I=F;H.volume&&(p=H.volume,F.connect(p),I=p),H.panning&&(t=H.panning,I.connect(t),I=t),v=H.scheduled,I.connect(G)}else F.connect(G);var J=Audio.context.createGain();if(J.gain.setValueAtTime(0,i),J.gain.linearRampToValueAtTime(1,i+.01),G.connect(J),k){var K=Audio.context.createStereoPanner();K.pan.setValueAtTime(y,i),J.connect(K),K.connect(m[f].input())}else J.connect(m[f].input());F.playbackRate.value=D;F.start(i+0,A);var L={source:F,volume:G,panning:K,volumeEnvelope:p,panningEnvelope:t,volumeFadeOut:J,startVolume:e,currentVolume:e,startPeriod:d,basePeriod:x,noteIndex:n,startPlaybackRate:D,sampleRate:C,instrumentIndex:a,effects:h,track:f,time:i,scheduled:v};return q[r].push(G),u||EventBus.trigger(EVENT.samplePlay,L),L}return{}},b.playSilence=function(){if(c){var a=c.createBufferSource();a.connect(d),a.start()}},b.playRaw=function(a,b){if(c&&a&&a.length){var e;e=c.createBuffer(1,a.length,c.sampleRate);var f=b/audioContext.sampleRate,g=c.createBufferSource();g.buffer=e,g.loop=!0,g.playbackRate.value=f,g.connect(d),g.start()}},b.isRecording=function(){return h},b.startRecording=function(){if(!h&&c&&c.createMediaStreamDestination){var a=c.createMediaStreamDestination();i=new MediaRecorder(a.stream),i.ondataavailable=function(a){n.push(a.data)},i.onstop=function(a){saveAs(new Blob(n,{type:"audio/ogg; codecs=opus"}),"recording.opus")},d.connect(a),i.start(),h=!0}},b.stopRecording=function(){h&&(h=!1,i.stop())},b.startRendering=function(a){u=!0,j=new OfflineAudioContext(2,44100*a,44100),b.context=j,b.init(j)},b.stopRendering=function(d){u=!1,j.startRendering().then(function(a){d&&d(a)}).catch(function(a){}),b.context=c,a(c),b.init(c)},b.setStereoSeparation=function(a){var b,c=Tracker.getTrackCount();if(Tracker.inFTMode())b=0;else switch(a=a||o,o=a,a){case STEREOSEPARATION.NONE:b=0,SETTINGS.stereoSeparation=STEREOSEPARATION.NONE;break;case STEREOSEPARATION.FULL:b=1,SETTINGS.stereoSeparation=STEREOSEPARATION.FULL;break;default:b=.5,SETTINGS.stereoSeparation=STEREOSEPARATION.BALANCED}for(g=0;g<c;g++){var d=m[g];d&&d.panningValue(g%2==0?-b:b)}},b.getPrevSampleRate=function(){return s},b.context=c,b.getSemiToneFrom=function(a,c,d){var e=a;if(d&&((a=b.getFineTuneBasePeriod(a,d))||(a=e)),c){var f=periodNoteTable[a];if(f){
var g=noteNames.indexOf(f.name),h=noteNames[g+c];if(h){var i=nameNoteTable[h];i&&(e=i.period,d&&(e=b.getFineTuneForPeriod(e,d)))}}}return e},b.getNearestSemiTone=function(a,b){var c=8;if(b){var d=Tracker.getInstrument(b);d&&d.sample.finetune&&(c+=d.sample.finetune)}var e=1e5,f=a;for(var g in NOTEPERIOD)if(NOTEPERIOD.hasOwnProperty(g)){var h=NOTEPERIOD[g].tune[c],i=Math.abs(h-a);i<e&&(e=i,f=h)}return f},b.getFineTuneForPeriod=function(a,b){var c=a,d=periodNoteTable[a];if(d&&d.tune){var e=8+b;e>=0&&e<d.tune.length&&(c=d.tune[e])}return c},b.getFineTuneForNote=function(a,b){if(a===NOTEOFF)return 1;var c=FTNotes[a],d=b>0?FTNotes[a+1]:FTNotes[a-1];if(c&&d){return c.period-Math.abs(d.period-c.period)/127*b}return c?c.period:1e5},b.getFineTuneBasePeriod=function(a,b){var c=a,d=periodFinetuneTable[b];return d&&(c=d[a]),c},b.getSampleRateForPeriod=function(a){return Tracker.inFTMode()?Tracker.useLinearFrequency?8363*Math.pow(2,(4608-a)/768):3579364/a:3546895/a},b.limitAmigaPeriod=function(a){return a=Math.max(a,113),a=Math.min(a,856)},b.setAmigaLowPassFilter=function(a,b){f.frequency.setValueAtTime(a?2e3:2e4,b)},b.setMasterVolume=function(a,b){b=b||c.currentTime,a*=.7,d.gain.setValueAtTime(p,b),d.gain.linearRampToValueAtTime(a,b+.02),p=a},b.slideMasterVolume=function(a,b){b=b||c.currentTime,a*=.7,d.gain.linearRampToValueAtTime(a,b),p=a},b.getLastMasterVolume=function(){return p/.7},b.clearScheduledNotesCache=function(){r++,r>2&&(r=0),q[r]=[]},b.waveFormFunction={sine:function(a,b,c,d){return a+Math.sin(b*c*.8)*d*1.7},saw:function(a,b,c,d){var e=1-Math.abs(b*c/7%1);return e=2*e-1,e=e*d*-2,a+e},square:function(a,b,c,d){var e=Math.sin(b*c)<=0?-1:1;return e=e*d*2,a+e},sawInverse:function(a,b,c,d){var e=Math.abs(b*c/7%1);return e=2*e-1,e=e*d*-2,a+e}},b}();!function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a[a.__dropbox_export||"dropboxService"]=b()}(this,function(){"use strict";function a(a,b){return"[object Function]"==e.call(a)}function b(a,b){return"[object String]"==e.call(a)}function c(a,b){return"[object Object]"==e.call(a)}function d(){return window.location.hash.replace(/^#/,"").split("&").reduce(function(a,b){return""==b?a:(b=b.split("="),a[decodeURIComponent(b[0])]=decodeURIComponent(b[1]),a)},{})}var e={}.toString,f="https://content.dropboxapi.com/2/",g=function(a,b){return arguments.length>1?localStorage[a]=b:localStorage[a]},h=void 0,i={"auth/token/revoke":{contentType:null},"users/get_current_account":{contentType:"application/json"},"files/upload":{baseUri:f,format:"content-upload"},"files/get_thumbnail":{baseUri:f,format:"content-download"},"files/download":{baseUri:f,format:"content-download"},"files/get_preview":{baseUri:f,format:"content-download"},"files/upload_session/append":{baseUri:f,format:"content-upload"},"files/upload_session/append_v2":{baseUri:f,format:"content-upload"},"files/upload_session/finish":{baseUri:f,format:"content-upload"},"files/upload_session/start":{baseUri:f,format:"content-upload"},"files/get_shared_link_file":{baseUri:f,format:"content-download"}},j={rpc:"application/json","content-upload":"application/octet-stream"},k=function(b,d){var e=[].slice.call(arguments),f=i[b]||{},k=f.baseUri||"https://api.dropboxapi.com/2/",l=f.format||"rpc",m=f.contentType||null===f.contentType?null:j[l],n=e[e.length-1],o=e.length>2&&(c(n)||a(n))?n:{};a(o)&&(o={onComplete:o});var p,q={};Promise&&(p=new Promise(function(a,b){q.resolve=a,q.reject=b}));var r=new XMLHttpRequest;r.open("POST",k+b,!0),r.setRequestHeader("Authorization","Bearer "+(g("__dbat")||"000000000000000000000000_00000-000000000000000000000000000000000")),"content-download"==l&&(r.responseType="blob"),d&&d.responseType&&(r.responseType=d.responseType,delete d.responseType),m&&r.setRequestHeader("Content-Type",m),!d||"content-upload"!=l&&"content-download"!=l||r.setRequestHeader("Dropbox-API-Arg",JSON.stringify(d)),o.onDownloadProgress&&r.addEventListener("progress",o.onDownloadProgress),o.onUploadProgress&&r.upload&&r.upload.addEventListener("progress",o.onUploadProgress),(o.onError||h)&&r.addEventListener("error",function(a){var b=o.onError&&o.onError(a.target);p&&q.reject&&q.reject(a.target),h&&h(a.target,b)}),r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status){var a=JSON.parse(r.getResponseHeader("dropbox-api-result")||r.responseText);"auth/token/revoke"==b&&g("__dbat",""),o.onComplete&&o.onComplete(a,r.response,r),p&&q.resolve&&q.resolve(a,r.response,r)}else{var c=o.onError&&o.onError(r);p&&q.reject&&q.reject(r),h&&h(r,c)}};var s=e.length>2&&"content-upload"==l?e[2]:void 0;return s=s||(d&&"rpc"==l?JSON.stringify(d):null),s?r.send(s):r.send(),p};return k.setGlobalErrorHandler=function(a){h=a},k.setTokenStore=function(a){g=a},k.authenticate=function(c,e){e=e||{},a(e)&&(e={onComplete:e}),c=c||{},b(c)&&(c={client_id:c}),c.redirect_uri=c.redirect_uri||window.location.href;var f,i={};if(Promise&&(f=new Promise(function(a,b){i.resolve=a,i.reject=b})),g("__dbat"))return e.onComplete(),f&&f.resolve&&f.resolve(),f;var j=d(),k=g("__dbcsrf");if(j.state&&k&&j.state==k)if(j.access_token)g("__dbat",j.access_token),g("__dbcsrf",""),window.location.replace(window.location.href.replace(/#.*/,""));else{var l=e.onError&&e.onError(j);f&&f.reject&&f.reject(j),h&&h(j,l)}else k=""+Math.floor(1e5*Math.random()),g("__dbcsrf",k),window.location="https://www.dropbox.com/1/oauth2/authorize?response_type=token&client_id="+encodeURIComponent(c.client_id)+"&redirect_uri="+encodeURIComponent(c.redirect_uri)+"&state="+encodeURIComponent(k);return f},k.getAccessToken=function(){return g("__dbat")},k.clearAccessToken=function(){return g("__dbat","")},k});var saveAs=saveAs||function(a){"use strict";if(!(void 0===a||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e="download"in d,f=function(a){a.dispatchEvent(new MouseEvent("click"))},g=/constructor/i.test(a.HTMLElement)||a.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent),i=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},j=function(a){var b=function(){"string"==typeof a?c().revokeObjectURL(a):a.remove()};setTimeout(b,4e4)},k=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(a){i(a)}}},l=function(a){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob([String.fromCharCode(65279),a],{type:a.type}):a},m=function(b,i,m){m||(b=l(b));var n,o=this,p=b.type,q="application/octet-stream"===p,r=function(){k(o,"writestart progress write writeend".split(" "))};if(o.readyState=o.INIT,e)return n=c().createObjectURL(b),void setTimeout(function(){d.href=n,d.download=i,f(d),r(),j(n),o.readyState=o.DONE});!function(){if((h||q&&g)&&a.FileReader){var d=new FileReader;return d.onloadend=function(){var b=h?d.result:d.result.replace(/^data:[^;]*;/,"data:attachment/file;");a.open(b,"_blank")||(a.location.href=b),b=void 0,o.readyState=o.DONE,r()},d.readAsDataURL(b),void(o.readyState=o.INIT)}if(n||(n=c().createObjectURL(b)),q)a.location.href=n;else{a.open(n,"_blank")||(a.location.href=n)}o.readyState=o.DONE,r(),j(n)}()},n=m.prototype,o=function(a,b,c){return new m(a,b||a.name||"download",c)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(a,b,c){return b=b||a.name||"download",c||(a=l(a)),navigator.msSaveOrOpenBlob(a,b)}:(n.abort=function(){},n.readyState=n.INIT=0,n.WRITING=1,n.DONE=2,n.error=n.onwritestart=n.onprogress=n.onwrite=n.onabort=n.onerror=n.onwriteend=null,o)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});var UZIP={};"object"==typeof module&&(module.exports=UZIP),UZIP.parse=function(a,b){for(var c=UZIP.bin.readUshort,d=UZIP.bin.readUint,e=0,f={},g=new Uint8Array(a),h=g.length-4;101010256!=d(g,h);)h--;var e=h;e+=4,e+=4;var i=c(g,e);e+=2;c(g,e);e+=2;var j=d(g,e);e+=4;var k=d(g,e);e+=4,e=k;for(var l=0;l<i;l++){d(g,e);e+=4,e+=4,e+=4,e+=4;d(g,e);e+=4;var j=d(g,e);e+=4;var m=d(g,e);e+=4;var n=c(g,e),o=c(g,e+2),p=c(g,e+4);e+=6,e+=8;var q=d(g,e);e+=4,e+=n+o+p,UZIP._readLocal(g,q,f,j,m,b)}return f},UZIP._readLocal=function(a,b,c,d,e,f){var g=UZIP.bin.readUshort,h=UZIP.bin.readUint;h(a,b);b+=4;g(a,b);b+=2;g(a,b);b+=2;var i=g(a,b);b+=2;h(a,b);b+=4;h(a,b);b+=4,b+=8;var j=g(a,b);b+=2;var k=g(a,b);b+=2;var l=UZIP.bin.readUTF8(a,b,j);if(b+=j,b+=k,f)return void(c[l]={size:e,csize:d});var m=new Uint8Array(a.buffer,b);if(0==i)c[l]=new Uint8Array(m.buffer.slice(b,b+d));else{if(8!=i)throw"unknown compression method: "+i;var n=new Uint8Array(e);UZIP.inflateRaw(m,n),c[l]=n}},UZIP.inflateRaw=function(a,b){return UZIP.F.inflate(a,b)},UZIP.inflate=function(a,b){return UZIP.inflateRaw(new Uint8Array(a.buffer,a.byteOffset+2,a.length-6),b)},UZIP.deflate=function(a,b){null==b&&(b={level:6});var c=0,d=new Uint8Array(50+Math.floor(1.1*a.length));d[c]=120,d[c+1]=156,c+=2,c=UZIP.F.deflateRaw(a,d,c,b.level);var e=UZIP.adler(a,0,a.length);return d[c+0]=e>>>24&255,d[c+1]=e>>>16&255,d[c+2]=e>>>8&255,d[c+3]=e>>>0&255,new Uint8Array(d.buffer,0,c+4)},UZIP.deflateRaw=function(a,b){null==b&&(b={level:6});var c=new Uint8Array(50+Math.floor(1.1*a.length)),d=UZIP.F.deflateRaw(a,c,d,b.level);return new Uint8Array(c.buffer,0,d)},UZIP.encode=function(a,b){null==b&&(b=!1);var c=0,d=UZIP.bin.writeUint,e=UZIP.bin.writeUshort,f={};for(var g in a){var h=!UZIP._noNeed(g)&&!b,i=a[g];f[g]={cpr:h,usize:i.length,crc:UZIP.crc.crc(i,0,i.length),file:h?UZIP.deflateRaw(i):i}}for(var g in f)c+=f[g].file.length+30+46+2*UZIP.bin.sizeUTF8(g);c+=22;var j=new Uint8Array(c),k=0,l=[];for(var g in f){var m=f[g];l.push(k),k=UZIP._writeHeader(j,k,g,m,0)}var n=0,o=k;for(var g in f){var m=f[g];l.push(k),k=UZIP._writeHeader(j,k,g,m,1,l[n++])}var p=k-o;return d(j,k,101010256),k+=4,k+=4,e(j,k,n),k+=2,e(j,k,n),k+=2,d(j,k,p),k+=4,d(j,k,o),k+=4,k+=2,j.buffer},UZIP._noNeed=function(a){return"png,jpg,jpeg,zip".indexOf(a.split(".").pop().toLowerCase())!=-1},UZIP._writeHeader=function(a,b,c,d,e,f){var g=UZIP.bin.writeUint,h=UZIP.bin.writeUshort,i=d.file;return g(a,b,0==e?67324752:33639248),b+=4,1==e&&(b+=2),h(a,b,20),b+=2,h(a,b,0),b+=2,h(a,b,d.cpr?8:0),b+=2,g(a,b,0),b+=4,g(a,b,d.crc),b+=4,g(a,b,i.length),b+=4,g(a,b,d.usize),b+=4,h(a,b,UZIP.bin.sizeUTF8(c)),b+=2,h(a,b,0),b+=2,1==e&&(b+=2,b+=2,b+=6,g(a,b,f),b+=4),b+=UZIP.bin.writeUTF8(a,b,c),0==e&&(a.set(i,b),b+=i.length),b},UZIP.crc={table:function(){for(var a=new Uint32Array(256),b=0;b<256;b++){for(var c=b,d=0;d<8;d++)1&c?c=3988292384^c>>>1:c>>>=1;a[b]=c}return a}(),update:function(a,b,c,d){for(var e=0;e<d;e++)a=UZIP.crc.table[255&(a^b[c+e])]^a>>>8;return a},crc:function(a,b,c){return 4294967295^UZIP.crc.update(4294967295,a,b,c)}},UZIP.adler=function(a,b,c){for(var d=1,e=0,f=b,g=b+c;f<g;){for(var h=Math.min(f+5552,g);f<h;)d+=a[f++],e+=d;d%=65521,e%=65521}return e<<16|d},UZIP.bin={readUshort:function(a,b){return a[b]|a[b+1]<<8},writeUshort:function(a,b,c){a[b]=255&c,a[b+1]=c>>8&255},readUint:function(a,b){return 16777216*a[b+3]+(a[b+2]<<16|a[b+1]<<8|a[b])},writeUint:function(a,b,c){a[b]=255&c,a[b+1]=c>>8&255,a[b+2]=c>>16&255,a[b+3]=c>>24&255},readASCII:function(a,b,c){for(var d="",e=0;e<c;e++)d+=String.fromCharCode(a[b+e]);return d},writeASCII:function(a,b,c){for(var d=0;d<c.length;d++)a[b+d]=c.charCodeAt(d)},pad:function(a){return a.length<2?"0"+a:a},readUTF8:function(a,b,c){for(var d,e="",f=0;f<c;f++)e+="%"+UZIP.bin.pad(a[b+f].toString(16));try{d=decodeURIComponent(e)}catch(d){return UZIP.bin.readASCII(a,b,c)}return d},writeUTF8:function(a,b,c){for(var d=c.length,e=0,f=0;f<d;f++){var g=c.charCodeAt(f);if(0==(4294967168&g))a[b+e]=g,e++;else if(0==(4294965248&g))a[b+e]=192|g>>6,a[b+e+1]=128|g>>0&63,e+=2;else if(0==(4294901760&g))a[b+e]=224|g>>12,a[b+e+1]=128|g>>6&63,a[b+e+2]=128|g>>0&63,e+=3;else{if(0!=(4292870144&g))throw"e";a[b+e]=240|g>>18,a[b+e+1]=128|g>>12&63,a[b+e+2]=128|g>>6&63,a[b+e+3]=128|g>>0&63,e+=4}}return e},sizeUTF8:function(a){for(var b=a.length,c=0,d=0;d<b;d++){var e=a.charCodeAt(d);if(0==(4294967168&e))c++;else if(0==(4294965248&e))c+=2;else if(0==(4294901760&e))c+=3;else{if(0!=(4292870144&e))throw"e";c+=4}}return c}},UZIP.F={},UZIP.F.deflateRaw=function(a,b,c,d){var e=[[0,0,0,0,0],[4,4,8,4,0],[4,5,16,8,0],[4,6,16,16,0],[4,10,16,32,0],[8,16,32,32,0],[8,16,128,128,0],[8,32,128,256,0],[32,128,258,1024,1],[32,258,258,4096,1]],f=e[d],g=UZIP.F.U,h=UZIP.F._goodIndex,i=UZIP.F._putsE,j=0,k=c<<3,l=0,m=a.length;if(0==d){for(;j<m;){var n=Math.min(65535,m-j);i(b,k,j+n==m?1:0),k=UZIP.F._copyExact(a,j,n,b,k+8),j+=n}return k>>>3}var o=g.lits,p=g.strt,q=g.prev,r=0,s=0,t=0,u=0,v=0,w=0;m>2&&(w=UZIP.F._hash(a,0),p[w]=0);for(j=0;j<m;j++){if(v=w,j+1<m-2){w=UZIP.F._hash(a,j+1);var x=j+1&32767;q[x]=p[w],p[w]=x}if(l<=j){(r>14e3||s>26697)&&m-j>100&&(l<j&&(o[r]=j-l,r+=2,l=j),k=UZIP.F._writeBlock(j==m-1||l==m?1:0,o,r,u,a,t,j-t,b,k),r=s=u=0,t=j);var y=0;j<m-2&&(y=UZIP.F._bestMatch(a,j,q,v,Math.min(f[2],m-j),f[3]));var n=y>>>16,z=65535&y;if(0!=y){var n=y>>>16,z=65535&y,A=h(n,g.of0);g.lhst[257+A]++;var B=h(z,g.df0);g.dhst[B]++,u+=g.exb[A]+g.dxb[B],o[r]=n<<23|j-l,o[r+1]=z<<16|A<<8|B,r+=2,l=j+n}else g.lhst[a[j]]++;s++}}for(t==j&&0!=a.length||(l<j&&(o[r]=j-l,r+=2,l=j),k=UZIP.F._writeBlock(1,o,r,u,a,t,j-t,b,k),r=0,s=0,r=s=u=0,t=j);0!=(7&k);)k++;return k>>>3},UZIP.F._bestMatch=function(a,b,c,d,e,f){var g=32767&b,h=c[g],i=g-h+32768&32767;if(h==g||d!=UZIP.F._hash(a,b-i))return 0;for(var j=0,k=0,l=Math.min(32767,b);i<=l&&0!=--f&&h!=g;){if(0==j||a[b+j]==a[b+j-i]){var m=UZIP.F._howLong(a,b,i);if(m>j){if(j=m,k=i,j>=e)break;i+2<m&&(m=i+2);for(var n=0,o=0;o<m-2;o++){var p=b-i+o+32768&32767,q=c[p],r=p-q+32768&32767;r>n&&(n=r,h=p)}}}g=h,h=c[g],i+=g-h+32768&32767}return j<<16|k},UZIP.F._howLong=function(a,b,c){if(a[b]!=a[b-c]||a[b+1]!=a[b+1-c]||a[b+2]!=a[b+2-c])return 0;var d=b,e=Math.min(a.length,b+258);for(b+=3;b<e&&a[b]==a[b-c];)b++;return b-d},UZIP.F._hash=function(a,b){return(a[b]<<8|a[b+1])+(a[b+2]<<4)&65535},UZIP.saved=0,UZIP.F._writeBlock=function(a,b,c,d,e,f,g,h,i){var j,k,l,m,n,o,p,q,r,s=UZIP.F.U,t=UZIP.F._putsF,u=UZIP.F._putsE;s.lhst[256]++,j=UZIP.F.getTrees(),k=j[0],l=j[1],m=j[2],n=j[3],o=j[4],p=j[5],q=j[6],r=j[7];var v=32+(0==(i+3&7)?0:8-(i+3&7))+(g<<3),w=d+UZIP.F.contSize(s.fltree,s.lhst)+UZIP.F.contSize(s.fdtree,s.dhst),x=d+UZIP.F.contSize(s.ltree,s.lhst)+UZIP.F.contSize(s.dtree,s.dhst);x+=14+3*p+UZIP.F.contSize(s.itree,s.ihst)+(2*s.ihst[16]+3*s.ihst[17]+7*s.ihst[18]);for(var y=0;y<286;y++)s.lhst[y]=0;for(var y=0;y<30;y++)s.dhst[y]=0;for(var y=0;y<19;y++)s.ihst[y]=0;var z=v<w&&v<x?0:w<x?1:2;t(h,i,a),t(h,i+1,z),i+=3;if(0==z){for(;0!=(7&i);)i++;i=UZIP.F._copyExact(e,f,g,h,i)}else{var A,B;if(1==z&&(A=s.fltree,B=s.fdtree),2==z){UZIP.F.makeCodes(s.ltree,k),UZIP.F.revCodes(s.ltree,k),UZIP.F.makeCodes(s.dtree,l),UZIP.F.revCodes(s.dtree,l),UZIP.F.makeCodes(s.itree,m),UZIP.F.revCodes(s.itree,m),A=s.ltree,B=s.dtree,u(h,i,n-257),i+=5,u(h,i,o-1),i+=5,u(h,i,p-4),i+=4;for(var C=0;C<p;C++)u(h,i+3*C,s.itree[1+(s.ordr[C]<<1)]);i+=3*p,i=UZIP.F._codeTiny(q,s.itree,h,i),i=UZIP.F._codeTiny(r,s.itree,h,i)}for(var D=f,E=0;E<c;E+=2){for(var F=b[E],G=F>>>23,H=D+(8388607&F);D<H;)i=UZIP.F._writeLit(e[D++],A,h,i);if(0!=G){var I=b[E+1],J=I>>16,K=I>>8&255,L=255&I;i=UZIP.F._writeLit(257+K,A,h,i),u(h,i,G-s.of0[K]),i+=s.exb[K],i=UZIP.F._writeLit(L,B,h,i),t(h,i,J-s.df0[L]),i+=s.dxb[L],D+=G}}i=UZIP.F._writeLit(256,A,h,i)}return i},UZIP.F._copyExact=function(a,b,c,d,e){var f=e>>>3;return d[f]=c,d[f+1]=c>>>8,d[f+2]=255-d[f],d[f+3]=255-d[f+1],f+=4,d.set(new Uint8Array(a.buffer,b,c),f),e+(c+4<<3)},UZIP.F.getTrees=function(){for(var a=UZIP.F.U,b=UZIP.F._hufTree(a.lhst,a.ltree,15),c=UZIP.F._hufTree(a.dhst,a.dtree,15),d=[],e=UZIP.F._lenCodes(a.ltree,d),f=[],g=UZIP.F._lenCodes(a.dtree,f),h=0;h<d.length;h+=2)a.ihst[d[h]]++;for(var h=0;h<f.length;h+=2)a.ihst[f[h]]++;for(var i=UZIP.F._hufTree(a.ihst,a.itree,7),j=19;j>4&&0==a.itree[1+(a.ordr[j-1]<<1)];)j--;return[b,c,i,e,g,j,d,f]},UZIP.F.getSecond=function(a){for(var b=[],c=0;c<a.length;c+=2)b.push(a[c+1]);return b},UZIP.F.nonZero=function(a){for(var b="",c=0;c<a.length;c+=2)0!=a[c+1]&&(b+=(c>>1)+",");return b},UZIP.F.contSize=function(a,b){for(var c=0,d=0;d<b.length;d++)c+=b[d]*a[1+(d<<1)];return c},UZIP.F._codeTiny=function(a,b,c,d){for(var e=0;e<a.length;e+=2){var f=a[e],g=a[e+1];d=UZIP.F._writeLit(f,b,c,d);var h=16==f?2:17==f?3:7;f>15&&(UZIP.F._putsE(c,d,g,h),d+=h)}return d},UZIP.F._lenCodes=function(a,b){for(var c=a.length;2!=c&&0==a[c-1];)c-=2;for(var d=0;d<c;d+=2){var e=a[d+1],f=d+3<c?a[d+3]:-1,g=d+5<c?a[d+5]:-1,h=0==d?-1:a[d-1];if(0==e&&f==e&&g==e){for(var i=d+5;i+2<c&&a[i+2]==e;)i+=2;var j=Math.min(i+1-d>>>1,138);j<11?b.push(17,j-3):b.push(18,j-11),d+=2*j-2}else if(e==h&&f==e&&g==e){for(var i=d+5;i+2<c&&a[i+2]==e;)i+=2;var j=Math.min(i+1-d>>>1,6);b.push(16,j-3),d+=2*j-2}else b.push(e,0)}return c>>>1},UZIP.F._hufTree=function(a,b,c){var d=[],e=a.length,f=b.length,g=0;for(g=0;g<f;g+=2)b[g]=0,b[g+1]=0;for(g=0;g<e;g++)0!=a[g]&&d.push({lit:g,f:a[g]});var h=d.length,i=d.slice(0);if(0==h)return 0;if(1==h){var j=d[0].lit,i=0==j?1:0;return b[1+(j<<1)]=1,b[1+(i<<1)]=1,1}d.sort(function(a,b){return a.f-b.f});var k=d[0],l=d[1],m=0,n=1,o=2;for(d[0]={lit:-1,f:k.f+l.f,l:k,r:l,d:0};n!=h-1;)k=m!=n&&(o==h||d[m].f<d[o].f)?d[m++]:d[o++],l=m!=n&&(o==h||d[m].f<d[o].f)?d[m++]:d[o++],d[n++]={lit:-1,f:k.f+l.f,l:k,r:l};var p=UZIP.F.setDepth(d[n-1],0);for(p>c&&(UZIP.F.restrictDepth(i,c,p),p=c),g=0;g<h;g++)b[1+(i[g].lit<<1)]=i[g].d;return p},UZIP.F.setDepth=function(a,b){return a.lit!=-1?(a.d=b,b):Math.max(UZIP.F.setDepth(a.l,b+1),UZIP.F.setDepth(a.r,b+1))},UZIP.F.restrictDepth=function(a,b,c){var d=0,e=1<<c-b,f=0;for(a.sort(function(a,b){return b.d==a.d?a.f-b.f:b.d-a.d}),d=0;d<a.length&&a[d].d>b;d++){var g=a[d].d;a[d].d=b,f+=e-(1<<c-g)}for(f>>>=c-b;f>0;){var g=a[d].d;g<b?(a[d].d++,f-=1<<b-g-1):d++}for(;d>=0;d--)a[d].d==b&&f<0&&(a[d].d--,f++)},UZIP.F._goodIndex=function(a,b){var c=0;return b[16|c]<=a&&(c|=16),b[8|c]<=a&&(c|=8),b[4|c]<=a&&(c|=4),b[2|c]<=a&&(c|=2),b[1|c]<=a&&(c|=1),c},UZIP.F._writeLit=function(a,b,c,d){return UZIP.F._putsF(c,d,b[a<<1]),d+b[1+(a<<1)]},UZIP.F.inflate=function(a,b){var c=Uint8Array;if(3==a[0]&&0==a[1])return b?b:new c(0);var d=UZIP.F,e=d._bitsF,f=d._bitsE,g=d._decodeTiny,h=d.makeCodes,i=d.codes2map,j=d._get17,k=d.U,l=null==b;l&&(b=new c(a.length>>>2<<3));for(var m,n,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0;0==o;)if(o=e(a,w,1),p=e(a,w+1,2),w+=3,0!=p){if(l&&(b=UZIP.F._check(b,v+(1<<17))),1==p&&(m=k.flmap,n=k.fdmap,t=511,u=31),2==p){q=f(a,w,5)+257,r=f(a,w+5,5)+1,s=f(a,w+10,4)+4,w+=14;for(var x=0;x<38;x+=2)k.itree[x]=0,k.itree[x+1]=0;for(var y=1,x=0;x<s;x++){var z=f(a,w+3*x,3);k.itree[1+(k.ordr[x]<<1)]=z,z>y&&(y=z)}w+=3*s,h(k.itree,y),i(k.itree,y,k.imap),m=k.lmap,n=k.dmap,w=g(k.imap,(1<<y)-1,q+r,a,w,k.ttree);var A=d._copyOut(k.ttree,0,q,k.ltree);t=(1<<A)-1;var B=d._copyOut(k.ttree,q,r,k.dtree);u=(1<<B)-1,h(k.ltree,A),i(k.ltree,A,m),h(k.dtree,B),i(k.dtree,B,n)}for(;;){var C=m[j(a,w)&t];w+=15&C;var D=C>>>4;if(D>>>8==0)b[v++]=D;else{if(256==D)break;var E=v+D-254;if(D>264){var F=k.ldef[D-257];E=v+(F>>>3)+f(a,w,7&F),w+=7&F}var G=n[j(a,w)&u];w+=15&G;var H=G>>>4,I=k.ddef[H],J=(I>>>4)+e(a,w,15&I);for(w+=15&I,l&&(b=UZIP.F._check(b,v+(1<<17)));v<E;)b[v]=b[v++-J],b[v]=b[v++-J],b[v]=b[v++-J],b[v]=b[v++-J];v=E}}}else{0!=(7&w)&&(w+=8-(7&w));var K=4+(w>>>3),L=a[K-4]|a[K-3]<<8;l&&(b=UZIP.F._check(b,v+L)),b.set(new c(a.buffer,a.byteOffset+K,L),v),w=K+L<<3,v+=L}return b.length==v?b:b.slice(0,v)},UZIP.F._check=function(a,b){var c=a.length;if(b<=c)return a;var d=new Uint8Array(Math.max(c<<1,b));return d.set(a,0),d},UZIP.F._decodeTiny=function(a,b,c,d,e,f){for(var g=UZIP.F._bitsE,h=UZIP.F._get17,i=0;i<c;){var j=a[h(d,e)&b];e+=15&j;var k=j>>>4;if(k<=15)f[i]=k,i++;else{var l=0,m=0;16==k?(m=3+g(d,e,2),e+=2,l=f[i-1]):17==k?(m=3+g(d,e,3),e+=3):18==k&&(m=11+g(d,e,7),e+=7);for(var n=i+m;i<n;)f[i]=l,i++}}return e},UZIP.F._copyOut=function(a,b,c,d){for(var e=0,f=0,g=d.length>>>1;f<c;){var h=a[f+b];d[f<<1]=0,d[1+(f<<1)]=h,h>e&&(e=h),f++}for(;f<g;)d[f<<1]=0,d[1+(f<<1)]=0,f++;return e},UZIP.F.makeCodes=function(a,b){for(var c,d,e,f,g,h=UZIP.F.U,i=a.length,j=h.bl_count,f=0;f<=b;f++)j[f]=0;for(f=1;f<i;f+=2)j[a[f]]++;var k=h.next_code;for(c=0,j[0]=0,d=1;d<=b;d++)c=c+j[d-1]<<1,k[d]=c;for(e=0;e<i;e+=2)0!=(g=a[e+1])&&(a[e]=k[g],k[g]++)},UZIP.F.codes2map=function(a,b,c){for(var d=a.length,e=UZIP.F.U,f=e.rev15,g=0;g<d;g+=2)if(0!=a[g+1])for(var h=g>>1,i=a[g+1],j=h<<4|i,k=b-i,l=a[g]<<k,m=l+(1<<k);l!=m;){var n=f[l]>>>15-b;c[n]=j,l++}},UZIP.F.revCodes=function(a,b){for(var c=UZIP.F.U.rev15,d=15-b,e=0;e<a.length;e+=2){a[e]=c[a[e]<<b-a[e+1]]>>>d}},UZIP.F._putsE=function(a,b,c){c<<=7&b;var d=b>>>3;a[d]|=c,a[d+1]|=c>>>8},UZIP.F._putsF=function(a,b,c){c<<=7&b;var d=b>>>3;a[d]|=c,a[d+1]|=c>>>8,a[d+2]|=c>>>16},UZIP.F._bitsE=function(a,b,c){return(a[b>>>3]|a[1+(b>>>3)]<<8)>>>(7&b)&(1<<c)-1},UZIP.F._bitsF=function(a,b,c){return(a[b>>>3]|a[1+(b>>>3)]<<8|a[2+(b>>>3)]<<16)>>>(7&b)&(1<<c)-1},UZIP.F._get17=function(a,b){return(a[b>>>3]|a[1+(b>>>3)]<<8|a[2+(b>>>3)]<<16)>>>(7&b)},UZIP.F._get25=function(a,b){return(a[b>>>3]|a[1+(b>>>3)]<<8|a[2+(b>>>3)]<<16|a[3+(b>>>3)]<<24)>>>(7&b)},UZIP.F.U=function(){var a=Uint16Array,b=Uint32Array;return{next_code:new a(16),bl_count:new a(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new a(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new b(32),flmap:new a(512),fltree:[],fdmap:new a(32),fdtree:[],lmap:new a(32768),ltree:[],ttree:[],dmap:new a(32768),dtree:[],imap:new a(512),itree:[],rev15:new a(32768),lhst:new b(286),dhst:new b(30),ihst:new b(19),lits:new b(15e3),strt:new a(65536),prev:new a(32768)}}(),function(){function a(a,b,c){for(;0!=b--;)a.push(0,c)}for(var b=UZIP.F.U,c=0;c<32768;c++){var d=c;d=(2863311530&d)>>>1|(1431655765&d)<<1,d=(3435973836&d)>>>2|(858993459&d)<<2,d=(4042322160&d)>>>4|(252645135&d)<<4,d=(4278255360&d)>>>8|(16711935&d)<<8,b.rev15[c]=(d>>>16|d<<16)>>>17}for(var c=0;c<32;c++)b.ldef[c]=b.of0[c]<<3|b.exb[c],b.ddef[c]=b.df0[c]<<4|b.dxb[c];a(b.fltree,144,8),a(b.fltree,112,9),a(b.fltree,24,7),a(b.fltree,8,8),UZIP.F.makeCodes(b.fltree,9),UZIP.F.codes2map(b.fltree,9,b.flmap),UZIP.F.revCodes(b.fltree,9),a(b.fdtree,32,5),UZIP.F.makeCodes(b.fdtree,5),UZIP.F.codes2map(b.fdtree,5,b.fdmap),UZIP.F.revCodes(b.fdtree,5),a(b.itree,19,0),a(b.ltree,286,0),a(b.dtree,30,0),a(b.ttree,320,0)}();var UZIP={};for("object"==typeof module&&(module.exports=UZIP),UZIP.parse=function(a,b){for(var c=UZIP.bin.readUshort,d=UZIP.bin.readUint,e=0,f={},g=new Uint8Array(a),h=g.length-4;101010256!=d(g,h);)h--;var e=h;e+=4,e+=4;var i=c(g,e);e+=2,c(g,e),e+=2;var j=d(g,e);e+=4;var k=d(g,e);e+=4,e=k;for(var l=0;l<i;l++){d(g,e),e+=4,e+=4,e+=4,e+=4,d(g,e),e+=4;var j=d(g,e);e+=4;var m=d(g,e);e+=4;var n=c(g,e),o=c(g,e+2),p=c(g,e+4);e+=6,e+=8;var q=d(g,e);e+=4,e+=n+o+p,UZIP._readLocal(g,q,f,j,m,b)}return f},UZIP._readLocal=function(a,b,c,d,e,f){var g=UZIP.bin.readUshort,h=UZIP.bin.readUint;h(a,b),b+=4,g(a,b),b+=2,g(a,b),b+=2;var i=g(a,b);b+=2,h(a,b),b+=4,h(a,b),b+=4,b+=8;var j=g(a,b);b+=2;var k=g(a,b);b+=2;var l=UZIP.bin.readUTF8(a,b,j);if(b+=j,b+=k,f)return void(c[l]={size:e,csize:d});var m=new Uint8Array(a.buffer,b);if(0==i)c[l]=new Uint8Array(m.buffer.slice(b,b+d));else{if(8!=i)throw"unknown compression method: "+i;var n=new Uint8Array(e);UZIP.inflateRaw(m,n),c[l]=n}},UZIP.inflateRaw=function(a,b){return UZIP.F.inflate(a,b)},UZIP.inflate=function(a,b){return UZIP.inflateRaw(new Uint8Array(a.buffer,a.byteOffset+2,a.length-6),b)},UZIP.deflate=function(a,b){null==b&&(b={level:6});var c=0,d=new Uint8Array(50+Math.floor(1.1*a.length));d[c]=120,d[c+1]=156,c+=2,c=UZIP.F.deflateRaw(a,d,c,b.level);var e=UZIP.adler(a,0,a.length);return d[c+0]=e>>>24&255,d[c+1]=e>>>16&255,d[c+2]=e>>>8&255,d[c+3]=e>>>0&255,new Uint8Array(d.buffer,0,c+4)},UZIP.deflateRaw=function(a,b){null==b&&(b={level:6});var c=new Uint8Array(50+Math.floor(1.1*a.length)),d=UZIP.F.deflateRaw(a,c,d,b.level);return new Uint8Array(c.buffer,0,d)},UZIP.encode=function(a,b){null==b&&(b=!1);var c=0,d=UZIP.bin.writeUint,e=UZIP.bin.writeUshort,f={};for(var g in a){var h=!UZIP._noNeed(g)&&!b,i=a[g];f[g]={cpr:h,usize:i.length,crc:UZIP.crc.crc(i,0,i.length),file:h?UZIP.deflateRaw(i):i}}for(var g in f)c+=f[g].file.length+30+46+2*UZIP.bin.sizeUTF8(g);c+=22;var j=new Uint8Array(c),k=0,l=[];for(var g in f){var m=f[g];l.push(k),k=UZIP._writeHeader(j,k,g,m,0)}var n=0,o=k;for(var g in f){var m=f[g];l.push(k),k=UZIP._writeHeader(j,k,g,m,1,l[n++])}var p=k-o;return d(j,k,101010256),k+=4,k+=4,e(j,k,n),k+=2,e(j,k,n),k+=2,d(j,k,p),k+=4,d(j,k,o),k+=4,k+=2,j.buffer},UZIP._noNeed=function(a){return-1!="png,jpg,jpeg,zip".indexOf(a.split(".").pop().toLowerCase())},UZIP._writeHeader=function(a,b,c,d,e,f){var g=UZIP.bin.writeUint,h=UZIP.bin.writeUshort,i=d.file;return g(a,b,0==e?67324752:33639248),b+=4,1==e&&(b+=2),h(a,b,20),b+=2,h(a,b,0),b+=2,h(a,b,d.cpr?8:0),b+=2,g(a,b,0),b+=4,g(a,b,d.crc),b+=4,g(a,b,i.length),b+=4,g(a,b,d.usize),b+=4,h(a,b,UZIP.bin.sizeUTF8(c)),b+=2,h(a,b,0),b+=2,1==e&&(b+=2,b+=2,b+=6,g(a,b,f),b+=4),b+=UZIP.bin.writeUTF8(a,b,c),0==e&&(a.set(i,b),b+=i.length),b},UZIP.crc={table:function(){for(var a=new Uint32Array(256),b=0;b<256;b++){for(var c=b,d=0;d<8;d++)1&c?c=3988292384^c>>>1:c>>>=1;a[b]=c}return a}(),update:function(a,b,c,d){for(var e=0;e<d;e++)a=UZIP.crc.table[255&(a^b[c+e])]^a>>>8;return a},crc:function(a,b,c){return 4294967295^UZIP.crc.update(4294967295,a,b,c)}},UZIP.adler=function(a,b,c){for(var d=1,e=0,f=b,g=b+c;f<g;){for(var h=Math.min(f+5552,g);f<h;)d+=a[f++],e+=d;d%=65521,e%=65521}return e<<16|d},UZIP.bin={readUshort:function(a,b){return a[b]|a[b+1]<<8},writeUshort:function(a,b,c){a[b]=255&c,a[b+1]=c>>8&255},readUint:function(a,b){return 16777216*a[b+3]+(a[b+2]<<16|a[b+1]<<8|a[b])},writeUint:function(a,b,c){a[b]=255&c,a[b+1]=c>>8&255,a[b+2]=c>>16&255,a[b+3]=c>>24&255},readASCII:function(a,b,c){for(var d="",e=0;e<c;e++)d+=String.fromCharCode(a[b+e]);return d},writeASCII:function(a,b,c){for(var d=0;d<c.length;d++)a[b+d]=c.charCodeAt(d)},pad:function(a){return a.length<2?"0"+a:a},readUTF8:function(a,b,c){for(var d,e="",f=0;f<c;f++)e+="%"+UZIP.bin.pad(a[b+f].toString(16));try{d=decodeURIComponent(e)}catch(d){return UZIP.bin.readASCII(a,b,c)}return d},writeUTF8:function(a,b,c){for(var d=c.length,e=0,f=0;f<d;f++){var g=c.charCodeAt(f);if(0==(4294967168&g))a[b+e]=g,e++;else if(0==(4294965248&g))a[b+e]=192|g>>6,a[b+e+1]=128|g>>0&63,e+=2;else if(0==(4294901760&g))a[b+e]=224|g>>12,a[b+e+1]=128|g>>6&63,a[b+e+2]=128|g>>0&63,e+=3;else{if(0!=(4292870144&g))throw"e";a[b+e]=240|g>>18,a[b+e+1]=128|g>>12&63,a[b+e+2]=128|g>>6&63,a[b+e+3]=128|g>>0&63,e+=4}}return e},sizeUTF8:function(a){for(var b=a.length,c=0,d=0;d<b;d++){var e=a.charCodeAt(d);if(0==(4294967168&e))c++;else if(0==(4294965248&e))c+=2;else if(0==(4294901760&e))c+=3;else{if(0!=(4292870144&e))throw"e";c+=4}}return c}},UZIP.F={},UZIP.F.deflateRaw=function(a,b,c,d){var e=[[0,0,0,0,0],[4,4,8,4,0],[4,5,16,8,0],[4,6,16,16,0],[4,10,16,32,0],[8,16,32,32,0],[8,16,128,128,0],[8,32,128,256,0],[32,128,258,1024,1],[32,258,258,4096,1]],f=e[d],g=UZIP.F.U,h=UZIP.F._goodIndex,i=UZIP.F._putsE,j=0,k=c<<3,l=0,m=a.length;if(0==d){for(;j<m;){var n=Math.min(65535,m-j);i(b,k,j+n==m?1:0),k=UZIP.F._copyExact(a,j,n,b,k+8),j+=n}return k>>>3}var o=g.lits,p=g.strt,q=g.prev,r=0,s=0,t=0,u=0,v=0,w=0;for(m>2&&(w=UZIP.F._hash(a,0),p[w]=0),j=0;j<m;j++){if(v=w,j+1<m-2){w=UZIP.F._hash(a,j+1);var x=j+1&32767;q[x]=p[w],p[w]=x}if(l<=j){(r>14e3||s>26697)&&m-j>100&&(l<j&&(o[r]=j-l,r+=2,l=j),k=UZIP.F._writeBlock(j==m-1||l==m?1:0,o,r,u,a,t,j-t,b,k),r=s=u=0,t=j);var y=0;j<m-2&&(y=UZIP.F._bestMatch(a,j,q,v,Math.min(f[2],m-j),f[3]));var n=y>>>16,z=65535&y;if(0!=y){var n=y>>>16,z=65535&y,A=h(n,g.of0);g.lhst[257+A]++;var B=h(z,g.df0);g.dhst[B]++,u+=g.exb[A]+g.dxb[B],o[r]=n<<23|j-l,o[r+1]=z<<16|A<<8|B,r+=2,l=j+n}else g.lhst[a[j]]++;s++}}for(t==j&&0!=a.length||(l<j&&(o[r]=j-l,r+=2,l=j),k=UZIP.F._writeBlock(1,o,r,u,a,t,j-t,b,k),r=0,s=0,r=s=u=0,t=j);0!=(7&k);)k++;return k>>>3},UZIP.F._bestMatch=function(a,b,c,d,e,f){var g=32767&b,h=c[g],i=g-h+32768&32767;if(h==g||d!=UZIP.F._hash(a,b-i))return 0;for(var j=0,k=0,l=Math.min(32767,b);i<=l&&0!=--f&&h!=g;){if(0==j||a[b+j]==a[b+j-i]){var m=UZIP.F._howLong(a,b,i);if(m>j){if(j=m,k=i,j>=e)break;i+2<m&&(m=i+2);for(var n=0,o=0;o<m-2;o++){var p=b-i+o+32768&32767,q=c[p],r=p-q+32768&32767;r>n&&(n=r,h=p)}}}g=h,h=c[g],i+=g-h+32768&32767}return j<<16|k},UZIP.F._howLong=function(a,b,c){if(a[b]!=a[b-c]||a[b+1]!=a[b+1-c]||a[b+2]!=a[b+2-c])return 0;var d=b,e=Math.min(a.length,b+258);for(b+=3;b<e&&a[b]==a[b-c];)b++;return b-d},UZIP.F._hash=function(a,b){return(a[b]<<8|a[b+1])+(a[b+2]<<4)&65535},UZIP.saved=0,UZIP.F._writeBlock=function(a,b,c,d,e,f,g,h,i){var j,k,l,m,n,o,p,q,r,s=UZIP.F.U,t=UZIP.F._putsF,u=UZIP.F._putsE;s.lhst[256]++,j=UZIP.F.getTrees(),k=j[0],l=j[1],m=j[2],n=j[3],o=j[4],p=j[5],q=j[6],r=j[7];var v=32+(0==(i+3&7)?0:8-(i+3&7))+(g<<3),w=d+UZIP.F.contSize(s.fltree,s.lhst)+UZIP.F.contSize(s.fdtree,s.dhst),x=d+UZIP.F.contSize(s.ltree,s.lhst)+UZIP.F.contSize(s.dtree,s.dhst);x+=14+3*p+UZIP.F.contSize(s.itree,s.ihst)+(2*s.ihst[16]+3*s.ihst[17]+7*s.ihst[18]);for(var y=0;y<286;y++)s.lhst[y]=0;for(var y=0;y<30;y++)s.dhst[y]=0;for(var y=0;y<19;y++)s.ihst[y]=0;var z=v<w&&v<x?0:w<x?1:2;if(t(h,i,a),t(h,i+1,z),i+=3,0==z){for(;0!=(7&i);)i++;i=UZIP.F._copyExact(e,f,g,h,i)}else{var A,B;if(1==z&&(A=s.fltree,B=s.fdtree),2==z){UZIP.F.makeCodes(s.ltree,k),UZIP.F.revCodes(s.ltree,k),UZIP.F.makeCodes(s.dtree,l),UZIP.F.revCodes(s.dtree,l),UZIP.F.makeCodes(s.itree,m),UZIP.F.revCodes(s.itree,m),A=s.ltree,B=s.dtree,u(h,i,n-257),i+=5,u(h,i,o-1),i+=5,u(h,i,p-4),i+=4;for(var C=0;C<p;C++)u(h,i+3*C,s.itree[1+(s.ordr[C]<<1)]);i+=3*p,i=UZIP.F._codeTiny(q,s.itree,h,i),i=UZIP.F._codeTiny(r,s.itree,h,i)}for(var D=f,E=0;E<c;E+=2){for(var F=b[E],G=F>>>23,H=D+(8388607&F);D<H;)i=UZIP.F._writeLit(e[D++],A,h,i);if(0!=G){var I=b[E+1],J=I>>16,K=I>>8&255,L=255&I;i=UZIP.F._writeLit(257+K,A,h,i),u(h,i,G-s.of0[K]),i+=s.exb[K],i=UZIP.F._writeLit(L,B,h,i),t(h,i,J-s.df0[L]),i+=s.dxb[L],D+=G}}i=UZIP.F._writeLit(256,A,h,i)}return i},UZIP.F._copyExact=function(a,b,c,d,e){var f=e>>>3;return d[f]=c,d[f+1]=c>>>8,d[f+2]=255-d[f],d[f+3]=255-d[f+1],f+=4,d.set(new Uint8Array(a.buffer,b,c),f),e+(c+4<<3)},UZIP.F.getTrees=function(){for(var a=UZIP.F.U,b=UZIP.F._hufTree(a.lhst,a.ltree,15),c=UZIP.F._hufTree(a.dhst,a.dtree,15),d=[],e=UZIP.F._lenCodes(a.ltree,d),f=[],g=UZIP.F._lenCodes(a.dtree,f),h=0;h<d.length;h+=2)a.ihst[d[h]]++;for(var h=0;h<f.length;h+=2)a.ihst[f[h]]++;for(var i=UZIP.F._hufTree(a.ihst,a.itree,7),j=19;j>4&&0==a.itree[1+(a.ordr[j-1]<<1)];)j--;return[b,c,i,e,g,j,d,f]},UZIP.F.getSecond=function(a){for(var b=[],c=0;c<a.length;c+=2)b.push(a[c+1]);return b},UZIP.F.nonZero=function(a){for(var b="",c=0;c<a.length;c+=2)0!=a[c+1]&&(b+=(c>>1)+",");return b},UZIP.F.contSize=function(a,b){for(var c=0,d=0;d<b.length;d++)c+=b[d]*a[1+(d<<1)];return c},UZIP.F._codeTiny=function(a,b,c,d){for(var e=0;e<a.length;e+=2){var f=a[e],g=a[e+1];d=UZIP.F._writeLit(f,b,c,d);var h=16==f?2:17==f?3:7;f>15&&(UZIP.F._putsE(c,d,g,h),d+=h)}return d},UZIP.F._lenCodes=function(a,b){for(var c=a.length;2!=c&&0==a[c-1];)c-=2;for(var d=0;d<c;d+=2){var e=a[d+1],f=d+3<c?a[d+3]:-1,g=d+5<c?a[d+5]:-1,h=0==d?-1:a[d-1];if(0==e&&f==e&&g==e){for(var i=d+5;i+2<c&&a[i+2]==e;)i+=2;var j=Math.min(i+1-d>>>1,138);j<11?b.push(17,j-3):b.push(18,j-11),d+=2*j-2}else if(e==h&&f==e&&g==e){for(var i=d+5;i+2<c&&a[i+2]==e;)i+=2;var j=Math.min(i+1-d>>>1,6)
;b.push(16,j-3),d+=2*j-2}else b.push(e,0)}return c>>>1},UZIP.F._hufTree=function(a,b,c){var d=[],e=a.length,f=b.length,g=0;for(g=0;g<f;g+=2)b[g]=0,b[g+1]=0;for(g=0;g<e;g++)0!=a[g]&&d.push({lit:g,f:a[g]});var h=d.length,i=d.slice(0);if(0==h)return 0;if(1==h){var j=d[0].lit,i=0==j?1:0;return b[1+(j<<1)]=1,b[1+(i<<1)]=1,1}d.sort(function(a,b){return a.f-b.f});var k=d[0],l=d[1],m=0,n=1,o=2;for(d[0]={lit:-1,f:k.f+l.f,l:k,r:l,d:0};n!=h-1;)k=m!=n&&(o==h||d[m].f<d[o].f)?d[m++]:d[o++],l=m!=n&&(o==h||d[m].f<d[o].f)?d[m++]:d[o++],d[n++]={lit:-1,f:k.f+l.f,l:k,r:l};var p=UZIP.F.setDepth(d[n-1],0);for(p>c&&(UZIP.F.restrictDepth(i,c,p),p=c),g=0;g<h;g++)b[1+(i[g].lit<<1)]=i[g].d;return p},UZIP.F.setDepth=function(a,b){return-1!=a.lit?(a.d=b,b):Math.max(UZIP.F.setDepth(a.l,b+1),UZIP.F.setDepth(a.r,b+1))},UZIP.F.restrictDepth=function(a,b,c){var d=0,e=1<<c-b,f=0;for(a.sort(function(a,b){return b.d==a.d?a.f-b.f:b.d-a.d}),d=0;d<a.length&&a[d].d>b;d++){var g=a[d].d;a[d].d=b,f+=e-(1<<c-g)}for(f>>>=c-b;f>0;){var g=a[d].d;g<b?(a[d].d++,f-=1<<b-g-1):d++}for(;d>=0;d--)a[d].d==b&&f<0&&(a[d].d--,f++)},UZIP.F._goodIndex=function(a,b){var c=0;return b[16|c]<=a&&(c|=16),b[8|c]<=a&&(c|=8),b[4|c]<=a&&(c|=4),b[2|c]<=a&&(c|=2),b[1|c]<=a&&(c|=1),c},UZIP.F._writeLit=function(a,b,c,d){return UZIP.F._putsF(c,d,b[a<<1]),d+b[1+(a<<1)]},UZIP.F.inflate=function(a,b){var c=Uint8Array;if(3==a[0]&&0==a[1])return b||new c(0);var d=UZIP.F,e=d._bitsF,f=d._bitsE,g=d._decodeTiny,h=d.makeCodes,i=d.codes2map,j=d._get17,k=d.U,l=null==b;l&&(b=new c(a.length>>>2<<3));for(var m,n,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0;0==o;)if(o=e(a,w,1),p=e(a,w+1,2),w+=3,0!=p){if(l&&(b=UZIP.F._check(b,v+(1<<17))),1==p&&(m=k.flmap,n=k.fdmap,t=511,u=31),2==p){q=f(a,w,5)+257,r=f(a,w+5,5)+1,s=f(a,w+10,4)+4,w+=14;for(var x=0;x<38;x+=2)k.itree[x]=0,k.itree[x+1]=0;for(var y=1,x=0;x<s;x++){var z=f(a,w+3*x,3);k.itree[1+(k.ordr[x]<<1)]=z,z>y&&(y=z)}w+=3*s,h(k.itree,y),i(k.itree,y,k.imap),m=k.lmap,n=k.dmap,w=g(k.imap,(1<<y)-1,q+r,a,w,k.ttree);var A=d._copyOut(k.ttree,0,q,k.ltree);t=(1<<A)-1;var B=d._copyOut(k.ttree,q,r,k.dtree);u=(1<<B)-1,h(k.ltree,A),i(k.ltree,A,m),h(k.dtree,B),i(k.dtree,B,n)}for(;;){var C=m[j(a,w)&t];w+=15&C;var D=C>>>4;if(D>>>8==0)b[v++]=D;else{if(256==D)break;var E=v+D-254;if(D>264){var F=k.ldef[D-257];E=v+(F>>>3)+f(a,w,7&F),w+=7&F}var G=n[j(a,w)&u];w+=15&G;var H=G>>>4,I=k.ddef[H],J=(I>>>4)+e(a,w,15&I);for(w+=15&I,l&&(b=UZIP.F._check(b,v+(1<<17)));v<E;)b[v]=b[v++-J],b[v]=b[v++-J],b[v]=b[v++-J],b[v]=b[v++-J];v=E}}}else{0!=(7&w)&&(w+=8-(7&w));var K=4+(w>>>3),L=a[K-4]|a[K-3]<<8;l&&(b=UZIP.F._check(b,v+L)),b.set(new c(a.buffer,a.byteOffset+K,L),v),w=K+L<<3,v+=L}return b.length==v?b:b.slice(0,v)},UZIP.F._check=function(a,b){var c=a.length;if(b<=c)return a;var d=new Uint8Array(Math.max(c<<1,b));return d.set(a,0),d},UZIP.F._decodeTiny=function(a,b,c,d,e,f){for(var g=UZIP.F._bitsE,h=UZIP.F._get17,i=0;i<c;){var j=a[h(d,e)&b];e+=15&j;var k=j>>>4;if(k<=15)f[i]=k,i++;else{var l=0,m=0;16==k?(m=3+g(d,e,2),e+=2,l=f[i-1]):17==k?(m=3+g(d,e,3),e+=3):18==k&&(m=11+g(d,e,7),e+=7);for(var n=i+m;i<n;)f[i]=l,i++}}return e},UZIP.F._copyOut=function(a,b,c,d){for(var e=0,f=0,g=d.length>>>1;f<c;){var h=a[f+b];d[f<<1]=0,d[1+(f<<1)]=h,h>e&&(e=h),f++}for(;f<g;)d[f<<1]=0,d[1+(f<<1)]=0,f++;return e},UZIP.F.makeCodes=function(a,b){for(var c,d,e,f,g,h=UZIP.F.U,i=a.length,j=h.bl_count,f=0;f<=b;f++)j[f]=0;for(f=1;f<i;f+=2)j[a[f]]++;var k=h.next_code;for(c=0,j[0]=0,d=1;d<=b;d++)c=c+j[d-1]<<1,k[d]=c;for(e=0;e<i;e+=2)0!=(g=a[e+1])&&(a[e]=k[g],k[g]++)},UZIP.F.codes2map=function(a,b,c){for(var d=a.length,e=UZIP.F.U,f=e.rev15,g=0;g<d;g+=2)if(0!=a[g+1])for(var h=g>>1,i=a[g+1],j=h<<4|i,k=b-i,l=a[g]<<k,m=l+(1<<k);l!=m;){var n=f[l]>>>15-b;c[n]=j,l++}},UZIP.F.revCodes=function(a,b){for(var c=UZIP.F.U.rev15,d=15-b,e=0;e<a.length;e+=2){a[e]=c[a[e]<<b-a[e+1]]>>>d}},UZIP.F._putsE=function(a,b,c){c<<=7&b;var d=b>>>3;a[d]|=c,a[d+1]|=c>>>8},UZIP.F._putsF=function(a,b,c){c<<=7&b;var d=b>>>3;a[d]|=c,a[d+1]|=c>>>8,a[d+2]|=c>>>16},UZIP.F._bitsE=function(a,b,c){return(a[b>>>3]|a[1+(b>>>3)]<<8)>>>(7&b)&(1<<c)-1},UZIP.F._bitsF=function(a,b,c){return(a[b>>>3]|a[1+(b>>>3)]<<8|a[2+(b>>>3)]<<16)>>>(7&b)&(1<<c)-1},UZIP.F._get17=function(a,b){return(a[b>>>3]|a[1+(b>>>3)]<<8|a[2+(b>>>3)]<<16)>>>(7&b)},UZIP.F._get25=function(a,b){return(a[b>>>3]|a[1+(b>>>3)]<<8|a[2+(b>>>3)]<<16|a[3+(b>>>3)]<<24)>>>(7&b)},UZIP.F.U=function(){var a=Uint16Array,b=Uint32Array;return{next_code:new a(16),bl_count:new a(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new a(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new b(32),flmap:new a(512),fltree:[],fdmap:new a(32),fdtree:[],lmap:new a(32768),ltree:[],ttree:[],dmap:new a(32768),dtree:[],imap:new a(512),itree:[],rev15:new a(32768),lhst:new b(286),dhst:new b(30),ihst:new b(19),lits:new b(15e3),strt:new a(65536),prev:new a(32768)}}(),function(){function a(a,b,c){for(;0!=b--;)a.push(0,c)}for(var b=UZIP.F.U,c=0;c<32768;c++){var d=c;d=(2863311530&d)>>>1|(1431655765&d)<<1,d=(3435973836&d)>>>2|(858993459&d)<<2,d=(4042322160&d)>>>4|(252645135&d)<<4,d=(4278255360&d)>>>8|(16711935&d)<<8,b.rev15[c]=(d>>>16|d<<16)>>>17}for(var c=0;c<32;c++)b.ldef[c]=b.of0[c]<<3|b.exb[c],b.ddef[c]=b.df0[c]<<4|b.dxb[c];a(b.fltree,144,8),a(b.fltree,112,9),a(b.fltree,24,7),a(b.fltree,8,8),UZIP.F.makeCodes(b.fltree,9),UZIP.F.codes2map(b.fltree,9,b.flmap),UZIP.F.revCodes(b.fltree,9),a(b.fdtree,32,5),UZIP.F.makeCodes(b.fdtree,5),UZIP.F.codes2map(b.fdtree,5,b.fdmap),UZIP.F.revCodes(b.fdtree,5),a(b.itree,19,0),a(b.ltree,286,0),a(b.dtree,30,0),a(b.ttree,320,0)}(),_='.buffer\\hst/3276@return G){Qfor(`var qQ`q~UZIP.$$F.#+#contSize(h.K0,0,0JflateRawY,fX$bin.W==Vfunction(r,e=,t=#_r[e+<<},#++]=>>>+=&&aVf&&iVf~U=n+5;U+2<t&&U+2=f;)U2;qu=Math.min(U+1-n1new ],ode,1Qreturn(e3]|1+(e3)]8|2+(e3)]16\fif(\v&&(\t);\bwrite=0,=0;),Uint8Array(tree.lengthqUZIP={};"object"Vtypeof module\tmodule.exports=UZIP$parse=~t=WreadUshort,n=WreadUintXa={},i=ro=i-4;101010256!=n(i,o\b)o--;qf=o;f4X4;qU=t(iX\bf2;t(iX\bf2;qu=n(iX\bf4;ql=n(iX\bf4X=l;`qvv<U;vQn(iX\bf4X4X4X4;n(iX\bf4;qu=n(iX\bf4;qI=n(iX\bf4;qd=t(iXZ=t(iX+2P=t(iX+4\bf6X8;qc=n(iX\bf4Xd+Z+P,$_readLocal(i,c,a,u,I,e)}Ga},$_readLocal,nX,aQqi=WreadUshort,o=WreadUint;oe\be4;ie\be2;ie\be2;qU=ie\be2;oe\be4;oe\be4,e8;qu=ie\be2;ql=ie\be2;qv=WreadUTF8e,u\b\veu,el,a)Gvoid(t[v{size:f,csize:n}\bqI=r\\,e\b\v0VU)t[vI\\.slice(e,e+n)\belse{\v8!=U)throw"unknown compression method: "+U;qd=f\b$inY(I,dt[vd}},$inY=QG#inflatee)},$inflate=Q01];G$inY(r\\,r.byteOffset+2,r-6e)},$deflate=QnullVe\te={level:6}\bqtn=50+Math.floor(1.1*r)\bn[t120,n[t+1156,t2,t=#deYn,t,e.level\bqf=$adler0,r\bGn[t+0f24&255,n[t+1f16&255,n[t+2f8&255,n[t+3f0&255,n\\,0,t+4)},$deY=QnullVe\te={level:6}\bqt=50+Math.floor(1.1*r)n=#deYt,n,e.level\bGt\\,0,n)},$enc=QnullVe\te=!1\bqtn=WUintX=WUshort,a={};`qi in rQqo=!$_noNeed(i)&&!e,U=iu=$crc.crc(U,0,U\ba[i{cpr:o,usize:U,crc:uXile:o?$deY(U):U}}`qi in a)ta[i].file+30+46+2*WsizeUTF8(i\bt22;ql=tvI=[];`qi in aQqd=a[i];I.push(vv=$_Header(l,v,i,d,0)}qZP=v;`qi in aQqd=a[i];I.push(vv=$_Header(l,v,i,d,I[Z])}qc=v-P;Gn(l,v01010256v4,v4X(l,v,Zv2X(l,v,Zv2,n(l,v,cv4,n(l,v,Pv4,v2,l\\},$_noNeed=(rQreturn-1!="png,jpg,jpeg,zip".indexOf(r.split(".").pop().toLowerCase())},$_Header,nX,aQqi=WUint,o=WUshort,U=n.file;Gie,0Vf?67324752:33639248e4Vf\te2oe,20e2,oe,0e2,oe,n.cpr?8:0e2,ie,0e4,ie,n.crce4,ie,Ue4,ie,n.usizee4,oe,WsizeUTF8(t)e2,oe,0e2Vf\te2,e2,e6,ie,ae4eWUTF8e,t0Vf\tr.set(U,eeUe},$crc={table:(~r=Uint32Array(256ee<256;e~t=e,nn<8;n)1&t?t=3988292384^t1:t=1;et}Gr}(update:,t,n~ff<n;f)r=$crc.table[255&(r^e[t+f])]^r8;Gr},crc:,tQG4294967295^$crc.update(4294967295,r,e,t)}},$adler~n=1Xa=e,i=e+t;a<i;~o=Math.min(a+5552,i\ba<o;)nafn;n%=65521X%=65521}Gf16|n},$bin={readUshort:QGe]|1]8},Ushort:,tQe255&t,1t>>8&255},readUint:QG16777216*3]+(2]16|1]8|e])},Uint:,tQe255&t,1t>>8&255,2t>>16&255,3t>>24&255},readASCII:,t~n=""Xf<t;f)nString.fromCharC(f]\bGn},ASCII:,t~nn<t;n)nt.charCAt(n)},pad:(rQGr<2?"0"+r:r},readUTF8:,t~nX="",aa<t;a)f"%"+Wpad(a].toString(16)\btry{n=decURIComponent(f)}catch(nQGWreadASCIIe,t)}Gn},UTF8:,t~n=tXaa<n;aQqi=t.charCAt(a\b\v0V(4294967168&i))fiX;else \v0V(4294965248&i))f192|i>>6,f+1128|i>>0&63X2;else \v0V(4294901760&i))f224|i>>12,f+1128|i>>6&63,f+2128|i>>0&63X3;else{\v0!=(4292870144&i))throw"e";f240|i>>18,f+1128|i>>12&63,f+2128|i>>6&63,f+3128|i>>0&63X4}}Gf},sizeUTF8:(r~e=r,tnn<e;nQqf=r.charCAt(n\b\v0V(4294967168&f))t;else \v0V(4294965248&f))t2;else \v0V(4294901760&f))t3;else{\v0!=(4292870144&f))throw"e";t4}}Gt}},$F={deY,nQqf=[[J,0,0[4,4,8,4,0[4,56,8,0[4,666,0[406,32,0[86,32,32,0[862828,0[8,3228,256,0[3228,258024[32,258,258,4096]a=f[ni=#U,ogoodIndex,U=(#_hash,#_putsEul=t3,vI=r;\v0VnQ`;u<I;Qqd=Math.min(65535,I-u\bU(e,l,u+dVI?1:0lcopyExactu,d,e,l+8ud}Gl3}qZ=i.lits,P=i.strt,c=i.prev,shF_wpI>2\tphash0P[p0\b`uu<I;uQ\vw=p,u+1<I-2Qphashu+1\bqg=u+1&@7;c[gP[pP[pg}\vv<=uQ(s>14e3||h>26697)&&I-u>100\tv<u\tZ[su-v,s2,v=ulBlock(uVI-1||vVI?1:0,Z,s,_,r,F,u-F,e,ls=h=_F=u\bqbu<I-2\tbbestMatchu,c,w,Math.min(a[2I-ua[3])\bqd=b16,m=65535&b;\v0!=bQqd=b16,m=65535&b,y=o(d,i.of0\bi.l/[257+y];qC=o(m,i.df0\bi.d/[C],_i.exb[y]+i.dxb[CZ[sd23|u-v,Z[s+1m16|y8|C,s2,v=u+d}else i.l/[u]];h}}`FVu&&0!=r||(v<u\tZ[su-v,s2,v=ulBlock(1,Z,s,_,r,F,u-F,e,lshs=h=_F=u\b0!=(7&l\b)l;Gl3_bestMatch,nX,aQqi=@7&e,o=t[iU=i-o+@8&@7;\voVi||n!hashe-U))G0;`qulv=Math.min(@7,e\bU<=v&&0!=--a&&o!=i;Q\v0Vu||u=u-U]QqIhowLonge,U\b\vI>uQ\vu=I,l=U,u>=f)break;U+2<I\tI=U+2\b`qdZZ<I-2;ZQqP=e-U+Z+@8&@7,c=t[Ps=P-c+@8&@7;s>d\td=s,o=P)}}}i=o,o=t[iUi-o+@8&@7}Gu16|l_howLongQ\ve]!=e-t]||1]!=1-t]||2]!=2-t])G0;qn=eX=Math.min(r,e+258\b`e3;e<f&&e=e-t];)e;Ge-n_hash=Qreturn(e]8|1])+(2]4)&65535},$saved#_Block,nX,a,i,o,UQqu,l,v,I,d,Z,P,c,s,h=#U,FputsF,_putsE;h.l/[256],u=#getTrees(l=u[0v=u[1I=u[2d=u[3Z=u[4P=u[5c=u[6s=u[7];qw=32+(0V(U+3&7)?0:8-(U+3&7))+(i3p=nKfl,h.l/)Kfd,h.d/g=nKl,h.l/)Kd,h.d/\bg14+3*PKi,h.i/)+(2*h.i/[16]+3*h.i/[17]+7*h.i/[18]\b`qbb<286;b)h.l/[b]`qbb<30;b)h.d/[b]`qbb<19;b)h.i/[b]qm=w<p&&w<g?0:p<g?1:2;F(o,U,rF(o,U+1,mU3;\v0VmQ`;0!=(7&U\b)U;UcopyExact(f,a,i,o,U)}else{qy,C;\v1Vm\ty=h.fl,C=h.fd2VmQ#makeCs(h.l,l#revCs(h.l,l#makeCs(h.d,v#revCs(h.d,v#makeCs(h.i,I#revCs(h.i,Iy=h.l,C=h.d,_(o,U,d-257U5,_(o,U,Z-1U5,_(o,U,P-4U4;`qAA<P;A)_(o,U+3*A,h.i[1+(h.ordA]1)]\bU3*P,UcTiny(c,h.i,o,UUcTiny(s,h.i,o,U)}`qx=a,TT<t;T2~k=e[Tz=k23,M=x+(8388607&k\bx<M;)ULit(f[xy,o,U\b\v0!=zQqS=e[T+1L=S>>16,E=S>>8&255,R=255&S;ULit(257+E,y,o,U_(o,U,z-h.of0[E]Uh.exb[EULit(R,C,o,UF(o,U,L-h.df0[R]Uh.dxb[Rxz}}ULit(256,y,o,U)}GU_copyExact,nXQqa=f3;Gn[at,n[a+1t8,n[a+2255-n[an[a+3255-n[a+1a4,n.set(r\\,e,taf+(t+43)getTrees=(~r=#U,ehufTree(r.l/,r.l5thufTree(r.d/,r.d5n=[flenCs(r.l,na=[ilenCs(r.d,aoo<n;o2)r.i/[n[o]];`qoo<a;o2)r.i/[a[o]];`qUhufTree(r.i/,r.i,7u=19;u>4&&0Vr.i[1+(r.ordu-1]1)];)u--;return[e,t,UX,i,u,n,a]getSecond=(r~e=[tt<r;t2)e.push(t+1]\bGenonZero=(r~e="",tt<r;t2)0!=t+1]\te(t>>1)+","\bGecontSize=~tnn<e;n)te[n]*1+(n1)];Gt_cTiny,n~ff<r;f2Qqa=fi=f+1];nLit(a,e,t,n\bqo=16Va?2:17Va?3:7;a>15\t#_putsE(t,n,i,ono)}Gn_lenCs=~t=r;2!=t&&0Vt-1];)t-=2;`qnn<t;n2Qqf=n+1a=n+3<t?n+3]:-1,i=n+5<t?n+5]:-1,o=0Vn?-1:n-1];\v0Vf38\bu<11?e.push(17,u-3):e.push(18,u-11n2*u-2}else \vfVo,6\be.push(16,u-3n2*u-2}else e.push(f,0)}Gt1_hufTreeQqn=[f=r,a=e,i`ii<a;i2)e[i]e[i+1]`ii<f;i)0!=i]&&n.push({lit:iX:i]}\bqo=n,U=n.slice(0\b\v0Vo)G0;\v1VoQqu=n[0].lit,U=0Vu?1:0;Ge[1+(u1)1,e[1+(U1)1}n.sort(QGr.f-e.f}\bql=n[0v=n[1Id=1,Z=2;`n[0{lit:-1X:l.f+v.f,l:l,r:v,d:0};d!=o-1;)l=I!=d\tZVo||n[I].f<n[Z].f)?n[I]:n[Zv=I!=d\tZVo||n[I].f<n[Z].f)?n[I]:n[Zn[d{lit:-1X:l.f+v.f,l:l,r:v};qP=#setDepth(n[d-10\b`P>t\t#restrictDepth(U,t,PP=tii<o;i)e[1+(U[i].lit1)U[i].d;GPsetDepth=Qreturn-1!=r.lit?(r.d=e,e):Math.max(#setDepth(r.l,e+1#setDepth(r.r,e+1))restrictDepthQqnf=1t-e,a`r.sort(QGe.dVr.d?r.f-e.f:e.d-r.d}nn<r&&n].d>e;nQqi=n].d;n].d=e,af-(1t-i)}`a=t-e;a>0;Qqi=n].d;i<e?(n].d,a-=1e-i-1):n}`;n>n--)n].dVe&&a<0\tn].d--,a\b0!=a&&console.log("debt left")_goodIndex=QqtGe[16|t]<=r\tt|=16e[8|t]<=r\tt|=8e[4|t]<=r\tt|=4e[2|t]<=r\tt|=2e[1|t]<=r\tt|=1t_Lit,nQG#_putsF(t,n,e[r1]n+e[1+(r1)]inflate=Qqt=Uint8Array;\v3V0]&&0V1])Ge||t(0\bqn=$FX=n._bitsF,a=n._bitsE,i=n._decTiny,o=n.makeCs,U=n.cs2map,u=n._get17,l=n.U,v=nullVe;v\te=t(r23)\b`qI,d,ZPcshF_wp0VZ;)\vZ=fpP=fp+1,2p3,0!=PQ\vv\techeck(e,w+(117))1VP\tI=l.flmap,d=l.fdmap,F=511,_=312VPQc=ap,5)+257,s=ap+5,5)+1,h=ap+10,4)+4,p14;`qgg<38;g2)l.i[g]l.i[g+1]`qb=1,gg<h;gQqm=ap+3*g,3\bl.i[1+(l.ordg]1)m,m>b\tb=m)}p3*h,o(l.i,bU(l.i,b,l.imapI=l.lmap,d=l.dmap,p=i(l.imap,(1b)-1,c+s,r,p,l.t\bqy=n._copyOut(l.t,0,c,l.l\bF=(1y)-1;qC=n._copyOut(l.t,c,s,l.d\b_=(1C)-1,o(l.l,yU(l.l,y,Io(l.d,CU(l.d,C,d)}`;;QqA=I[up)&F];p15&A;qx=A4;\vx8V0)e[wx;else{\v256Vx)break;qT=w+x-254;\vx>264Qqk=l.ldef[x-257];T=w+(k3)+ap,7&kp7&k}qz=d[up)&_];p15&z;qM=z4,S=l.ddef[ML=(S4)+fp5&S\b`p15&S,v\techeck(e,w+(117))\bw<T;)e[we[w-Le[we[w-Le[we[w-Le[we[w-L];w=T}}}else{0!=(7&p)\tp8-(7&p)\bqE=4+(p3R=E-4]|E-3]8;v\techeck(e,w+R)e.set(t(r\\,r.byteOffset+E,Rwp=E+R3,wR}GeVw?e:e.slice(0,w)_check=Qqt=r;\ve<=t)Gr;qn=Math.max(t1,e)\bGn.set0n_decTiny,nX,a~ibitsE,oget17,UU<t;Qqu=o(nX)&e];f15&u;ql=u4;\vl<=15)a[Ul,U;else{qvI16Vl?(I=3+i(nX,2f2,v=a[U-1]):17Vl?(I=3+i(nX,3f3):18Vl\tI=11+i(nX,7f7\b`qd=U+I;U<d;)a[Uv,U}}Gf_copyOut,n~fai=n1;a<t;Qqo=a+e];n[a1]n[1+(a1)o,o>f\tf=oa}`;a<i;)n[a1]n[1+(a1)]a;GfmakeCs=~t,nX,a,i,o=#U,U=r,u=o.bl_count,aa<=e;a)u[a]`a=1;a<U;a2)u[a]];ql=o.next_c;`tu[0]n=1;n<=e;n)t=t+u[n-1]1,l[nt;`ff<U;f2)0!=(i=f+1])\tfl[il[i])cs2map~n=rX=#U,a=f.rev15,ii<n;i2)\v0!=i+1])`qo=i>>1,U=i+1u=o4|U,l=e-U,v=i]l,I=v+(1l\bv!=I;Qqd=a[v]15-e;t[du,v}revCs=~t=#U.rev15,n=15-eXf<r;f2Qqa=f]e-f+1];ft[a]n}_putsEQt=7&e;qn=e3;n]|=t,n+1]|=t8_putsFQt=7&e;qn=e3;n]|=t,n+1]|=t8,n+2]|=t16_bitsEQreturn(e3]|1+(e3)]8)(7&e)&(1t)-1_bitsF\f)(7&e)&(1t)-1_get17=\f)(7&e)_get25=\f|3+(e3)]24)(7&e)U=(Qqr=Uint16Array,e=Uint32Array;return{next_c:r(16bl_count:r(16ordr:[1678,0,8,7,9,60,51,42,33,245of0:[3,4,5,6,7,8,9013579,23,27,31,35,43,51,59,67,83,9915316395,227,258,999,999,999exb:[J,J,0,0,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,J,0ldef:r(32df0:[1,2,3,4,5,7,937,25,33,49,65,972993,257,385,513,769025537,2049,3073,4097,6145,819322896385,24577,65535,65535dxb:[J,0,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,900112233,0,0ddef:e(32flmap:r(512fl:[fdmap:r(32fd:[lmap:r(@8l:[t:[dmap:r(@8d:[imap:r(512i:[rev15:r(@8l/:e(286d/:e(30i/:e(19lits:e(15e3strt:r(65536prev:r(@8)}}((Q re,tQ`;0!=e--;)r.push(0,t)}`qe=#U,tt<@8;tQqn=t;n=(2863311530&n)1|(1431655765&n)1,n=(3435973836&n)2|(858993459&n)2,n=(4042322160&n)4|(252645135&n)4,n=(4278255360&n)8|(16711935&n)8,e.rev15[t(n16|n16)17}`qtt<32;t)e.ldef[te.of0[t]3|e.exb[te.ddef[te.df0[t]4|e.dxb[t];r(e.fl44,8r(e.fl12,9r(e.fl,24,7r(e.fl,8,8#makeCs(e.fl,9#cs2map(e.fl,9,e.flmap#revCs(e.fl,9r(e.fd,32,5#makeCs(e.fd,5#cs2map(e.fd,5,e.fdmap#revCs(e.fd,5r(e.i9,0r(e.l,286,0r(e.d,30,0r(e.t,320,0)}(\b';G=/[-V-YJK#$~q`QG@\/\\]/.exec(_);)with(_.split(G))_=join(shift());eval(_),function(a,b,c){function d(c,f){if(!b[c]){if(!a[c]){var g="function"==typeof require&&require;if(!f&&g)return g(c,!0);if(e)return e(c,!0);throw new Error("Cannot find module '"+c+"'")}var h=b[c]={exports:{}};a[c][0].call(h.exports,function(b){var e=a[c][1][b];return d(e?e:b)},h,h.exports)}return b[c].exports}for(var e="function"==typeof require&&require,f=0;f<c.length;f++)d(c[f]);d}({1:[function(a,b,c){var d=a("./lib/WAAClock");b.exports=d,"undefined"!=typeof window&&(window.WAAClock=d)},{"./lib/WAAClock":2}],3:[function(a,b,c){var d=b.exports={};d.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){var b=a.source;if((b===window||null===b)&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){c.shift()()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.binding=function(a){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(a){throw new Error("process.chdir is not supported")}},{}],2:[function(a,b,c){var d=a("__browserify_process");if("undefined"!=typeof window&&!AudioContext)throw new Error("This browser doesn't seem to support web audio API");var e={toleranceLate:.1,toleranceEarly:.001},f=function(a,b,c){this.clock=a,this.func=c,this.repeatTime=null,this.toleranceLate=e.toleranceLate,this.toleranceEarly=e.toleranceEarly,this._armed=!1,this._latestTime=null,this._earliestTime=null,this.schedule(b)};f.prototype.clear=function(){return this.clock._removeEvent(this),this},f.prototype.repeat=function(a){if(0===a)throw new Error("delay cannot be 0");return this.repeatTime=a,this},f.prototype.tolerance=function(a){return"number"==typeof a.late&&(this.toleranceLate=a.late),"number"==typeof a.early&&(this.toleranceEarly=a.early),this._update(),this},f.prototype.isRepeated=function(){return null!==this.repeatTime},f.prototype.schedule=function(a){this._armed=!0,this.deadline=a,this._update(),this.clock.context.currentTime>=this._earliestTime&&(this.clock._removeEvent(this),this._execute())},f.prototype._execute=function(){this._armed=!1,this.clock.context.currentTime<this._latestTime?this.func(this):EventBus&&EventBus.trigger(EVENT.clockEventExpired),this._armed===!1&&this.isRepeated()&&this.schedule(this.deadline+this.repeatTime)},f.prototype._update=function(){this._latestTime=this.deadline+this.toleranceLate,this._earliestTime=this.deadline-this.toleranceEarly,this.clock._removeEvent(this),this.clock._insertEvent(this)};var g=b.exports=function(a,b){b=b||{},this.toleranceEarly=b.toleranceEarly||e.toleranceEarly,this.toleranceLate=b.toleranceLate||e.toleranceLate,this.context=a,this._events=[],this._started=!1};g.prototype.setTimeout=function(a,b){return this._createEvent(a,this._absTime(b))},g.prototype.callbackAtTime=function(a,b){return this._createEvent(a,b)},g.prototype.timeStretch=function(a,b,c){var d=this,e=d.context.currentTime;return b.forEach(function(b){b.isRepeated()&&b.repeat(b.repeatTime*c);var d=a+c*(b.deadline-a);if(b.isRepeated())for(;e>=d-b.toleranceEarly;)d+=b.repeatTime;b.schedule(d)}),b},g.prototype.start=function(){if(this._started===!1){var a=this;this._started=!0,this._events=[];this._clockNode=this.context.createScriptProcessor(256,1,1),this._clockNode.connect(this.context.destination),this._clockNode.onaudioprocess=function(){d.nextTick(function(){a._tick()})}}},g.prototype.stop=function(){this._started===!0&&(this._started=!1,this._clockNode.disconnect())},g.prototype._tick=function(){for(var a=this._events.shift();a&&a._earliestTime<=this.context.currentTime;)a._execute(),a=this._events.shift();a&&this._events.unshift(a)},g.prototype._createEvent=function(a,b){var c=new f(this,b,a);return c.tolerance({late:this.toleranceLate,early:this.toleranceEarly}),c},g.prototype._insertEvent=function(a){this._events.splice(this._indexByTime(a._earliestTime),0,a)},g.prototype._removeEvent=function(a){var b=this._events.indexOf(a);b!==-1&&this._events.splice(b,1)},g.prototype._indexByTime=function(a){for(var b,c=0,d=this._events.length;c<d;)b=Math.floor((c+d)/2),this._events[b]._earliestTime<a?c=b+1:d=b;return c},g.prototype._absTime=function(a){return a+this.context.currentTime},g.prototype._relTime=function(a){return a-this.context.currentTime}},{__browserify_process:3}]},{},[1]),function(a){"use strict";function b(){this.crc=-1}function c(){}function d(a,b,c){if(b<0||c<0||b+c>a.size)throw new RangeError("offset:"+b+", length:"+c+", size:"+a.size);return a.slice?a.slice(b,b+c):a.webkitSlice?a.webkitSlice(b,b+c):a.mozSlice?a.mozSlice(b,b+c):a.msSlice?a.msSlice(b,b+c):void 0}function e(a,b){var c,d;return c=new ArrayBuffer(a),d=new Uint8Array(c),b&&d.set(b,0),{buffer:c,array:d,view:new DataView(c)}}function f(){}function g(a){function b(b,c){d=new i(new Blob([a],{type:R})),d.init(function(){e.size=d.size,b()},c)}function c(a,b,c,e){d.readUint8Array(a,b,c,e)}var d,e=this;e.size=0,e.init=b,e.readUint8Array=c}function h(b){function c(a){for(var c=b.length;"="==b.charAt(c-1);)c--;f=b.indexOf(",")+1,g.size=Math.floor(.75*(c-f)),a()}function d(c,d,g){var h,i=e(d),j=4*Math.floor(c/3),k=4*Math.ceil((c+d)/3),l=a.atob(b.substring(j+f,k+f)),m=c-3*Math.floor(j/4);for(h=m;h<m+d;h++)i.array[h-m]=l.charCodeAt(h);g(i.array)}var f,g=this;g.size=0,g.init=c,g.readUint8Array=d}function i(a){function b(b){e.size=a.size,b()}function c(b,c,e,f){var g=new FileReader;g.onload=function(a){e(new Uint8Array(a.target.result))},g.onerror=f;try{g.readAsArrayBuffer(d(a,b,c))}catch(a){f(a)}}var e=this;e.size=0,e.init=b,e.readUint8Array=c}function j(a){function b(b,c){d.size=a.byteLength,b()}function c(b,c,d,e){d(new Uint8Array(a.slice(b,b+c)))}var d=this;d.size=0,d.init=b,d.readUint8Array=c}function k(){}function l(a){function b(a){e=new Blob([],{type:R}),a()}function c(a,b){e=new Blob([e,G?a:a.buffer],{type:R}),b()}function d(b,c){var d=new FileReader;d.onload=function(a){b(a.target.result)},d.onerror=c,d.readAsText(e,a)}var e,f=this;f.init=b,f.writeUint8Array=c,f.getData=d}function m(b){function c(a){g+="data:"+(b||"")+";base64,",a()}function d(b,c){var d,e=h.length,f=h;for(h="",d=0;d<3*Math.floor((e+b.length)/3)-e;d++)f+=String.fromCharCode(b[d]);for(;d<b.length;d++)h+=String.fromCharCode(b[d]);f.length>2?g+=a.btoa(f):h=f,c()}function e(b){b(g+a.btoa(h))}var f=this,g="",h="";f.init=c,f.writeUint8Array=d,f.getData=e}function n(a){function b(b){e=new Blob([],{type:a}),b()}function c(b,c){e=new Blob([e,G?b:b.buffer],{type:a}),c()}function d(a){a(e)}var e,f=this;f.init=b,f.writeUint8Array=c,f.getData=d}function o(){function a(a,b){d=new Uint8Array,a()}function b(a,b,c){var e=new Uint8Array(d.length+a.length);e.set(d),e.set(a,d.length),d=e,b()}function c(a){a(d.buffer)}var d,e=this;e.init=a,e.writeUint8Array=b,e.getData=c}function p(a,b,c,d,e,f,g,h,i,j){function k(){a.removeEventListener("message",l,!1),h(o,p)}function l(b){var c=b.data,e=c.data,h=c.error;if(h)return h.toString=function(){return"Error: "+this.message},void i(h);if(c.sn===r)switch("number"==typeof c.codecTime&&(a.codecTime+=c.codecTime),"number"==typeof c.crcTime&&(a.crcTime+=c.crcTime),c.type){case"append":e?(o+=e.length,d.writeUint8Array(e,function(){m()},j)):m();break;case"flush":p=c.crc,e?(o+=e.length,d.writeUint8Array(e,function(){k()},j)):k();break;case"progress":g&&g(n+c.loaded,f);break;case"importScripts":case"newTask":case"echo":}}function m(){n=q*Q,n<=f?c.readUint8Array(e+n,Math.min(Q,f-n),function(c){g&&g(n,f);var d=0===n?b:{sn:r};d.type="append",d.data=c;try{a.postMessage(d,[c.buffer])}catch(b){a.postMessage(d)}q++},i):a.postMessage({sn:r,type:"flush"})}var n,o,p,q=0,r=b.sn;o=0,a.addEventListener("message",l,!1),m()}function q(a,c,d,e,f,g,h,i,j,k){function l(){var b;if((m=n*Q)<f)c.readUint8Array(e+m,Math.min(Q,f-m),function(b){var c;try{c=a.append(b,function(a){h&&h(m+a,f)})}catch(a){return void j(a)}c?(o+=c.length,d.writeUint8Array(c,function(){n++,setTimeout(l,1)},k),q&&r.append(c)):(n++,setTimeout(l,1)),p&&r.append(b),h&&h(m,f)},j);else{try{b=a.flush()}catch(a){return void j(a)}b?(q&&r.append(b),o+=b.length,d.writeUint8Array(b,function(){i(o,r.get())},k)):i(o,r.get())}}var m,n=0,o=0,p="input"===g,q="output"===g,r=new b;l()}function r(b,c,d,e,f,g,h,i,j,k,l){var m=h?"output":"none";if(a.zip.useWebWorkers){p(b,{sn:c,codecClass:"Inflater",crcType:m},d,e,f,g,j,i,k,l)}else q(new a.zip.Inflater,d,e,f,g,m,j,i,k,l)}function s(b,c,d,e,f,g,h,i,j){if(a.zip.useWebWorkers){p(b,{sn:c,options:{level:f},codecClass:"Deflater",crcType:"input"},d,e,0,d.size,h,g,i,j)}else q(new a.zip.Deflater,d,e,0,d.size,"input",h,g,i,j)}function t(b,d,e,f,g,h,i,j,k,l,m){if(a.zip.useWebWorkers&&i){p(b,{sn:d,codecClass:"NOOP",crcType:"input"},e,f,g,h,k,j,l,m)}else q(new c,e,f,g,h,"input",k,j,l,m)}function u(a){var b,c,d="",e=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(b=0;b<a.length;b++)c=255&a.charCodeAt(b),d+=c>127?e[c-128]:String.fromCharCode(c);return d}function v(a){return decodeURIComponent(escape(a))}function w(a){var b,c="";for(b=0;b<a.length;b++)c+=String.fromCharCode(a[b]);return c}function x(a){var b=(4294901760&a)>>16,c=65535&a;try{return new Date(1980+((65024&b)>>9),((480&b)>>5)-1,31&b,(63488&c)>>11,(2016&c)>>5,2*(31&c),0)}catch(a){}}function y(a,b,c,d,e){return a.version=b.view.getUint16(c,!0),a.bitFlag=b.view.getUint16(c+2,!0),a.compressionMethod=b.view.getUint16(c+4,!0),a.lastModDateRaw=b.view.getUint32(c+6,!0),a.lastModDate=x(a.lastModDateRaw),1==(1&a.bitFlag)?void e(J):((d||8!=(8&a.bitFlag))&&(a.crc32=b.view.getUint32(c+10,!0),a.compressedSize=b.view.getUint32(c+14,!0),a.uncompressedSize=b.view.getUint32(c+18,!0)),4294967295===a.compressedSize||4294967295===a.uncompressedSize?void e(K):(a.filenameLength=b.view.getUint16(c+22,!0),void(a.extraFieldLength=b.view.getUint16(c+24,!0))))}function z(b,c,d){function f(){}function g(a){function c(c,f){b.readUint8Array(b.size-c,c,function(b){for(var c=b.length-e;c>=0;c--)if(80===b[c]&&75===b[c+1]&&5===b[c+2]&&6===b[c+3])return void a(new DataView(b.buffer,c,e));f()},function(){d(L)})}var e=22;if(b.size<e)return void d(H);var f=e+65536;c(e,function(){c(Math.min(f,b.size),function(){d(H)})})}var h=0;f.prototype.getData=function(a,c,f,g){function i(a){var b=e(4);return b.view.setUint32(0,a),m.crc32==b.view.getUint32(0)}function j(b,e){g&&!i(e)?d(I):a.getData(function(a){c(a)})}function k(a){d(a||O)}function l(a){d(a||N)}var m=this;b.readUint8Array(m.offset,30,function(c){var i,n=e(c.length,c);if(1347093252!=n.view.getUint32(0))return void d(H);y(m,n,4,!1,d),i=m.offset+30+m.filenameLength+m.extraFieldLength,a.init(function(){0===m.compressionMethod?t(m._worker,h++,b,a,i,m.compressedSize,g,j,f,k,l):r(m._worker,h++,b,a,i,m.compressedSize,g,j,f,k,l)},l)},k)};var i={getEntries:function(a){var c=this._worker;g(function(g){var h,i;if(h=g.getUint32(16,!0),i=g.getUint16(8,!0),h<0||h>=b.size)return void d(H);b.readUint8Array(h,b.size-h,function(b){var g,h,j,k,l=0,m=[],n=e(b.length,b);for(g=0;g<i;g++){if(h=new f,h._worker=c,1347092738!=n.view.getUint32(l))return void d(H);y(h,n,l+6,!0,d),h.commentLength=n.view.getUint16(l+32,!0),h.directory=16==(16&n.view.getUint8(l+38)),h.offset=n.view.getUint32(l+42,!0),j=w(n.array.subarray(l+46,l+46+h.filenameLength)),h.filename=2048==(2048&h.bitFlag)?v(j):u(j),h.directory||"/"!=h.filename.charAt(h.filename.length-1)||(h.directory=!0),k=w(n.array.subarray(l+46+h.filenameLength+h.extraFieldLength,l+46+h.filenameLength+h.extraFieldLength+h.commentLength)),h.comment=2048==(2048&h.bitFlag)?v(k):u(k),m.push(h),l+=46+h.filenameLength+h.extraFieldLength+h.commentLength}a(m)},function(){d(L)})})},close:function(a){this._worker&&(this._worker.terminate(),this._worker=null),a&&a()},_worker:null};a.zip.useWebWorkers?E("inflater",function(a){i._worker=a,c(i)},function(a){d(a)}):c(i)}function A(a){return unescape(encodeURIComponent(a))}function B(a){var b,c=[];for(b=0;b<a.length;b++)c.push(a.charCodeAt(b));return c}function C(b,c,d,f){function g(a){d(a||M)}function h(a){d(a||O)}var i={},j=[],k=0,l=0,m={add:function(a,c,m,n,o){function p(c){var d;w=o.lastModDate||new Date,u=e(26),i[a]={headerArray:u.array,directory:o.directory,filename:v,offset:k,comment:B(A(o.comment||""))},u.view.setUint32(0,335546376),o.version&&u.view.setUint8(0,o.version),f||0===o.level||o.directory||u.view.setUint16(4,2048),u.view.setUint16(6,(w.getHours()<<6|w.getMinutes())<<5|w.getSeconds()/2,!0),u.view.setUint16(8,(w.getFullYear()-1980<<4|w.getMonth()+1)<<5|w.getDate(),!0),u.view.setUint16(22,v.length,!0),d=e(30+v.length),d.view.setUint32(0,1347093252),d.array.set(u.array,4),d.array.set(v,30),k+=d.array.length,b.writeUint8Array(d.array,c,g)}function q(a,d){var f=e(16);k+=a||0,f.view.setUint32(0,1347094280),void 0!==d&&(u.view.setUint32(10,d,!0),f.view.setUint32(4,d,!0)),c&&(f.view.setUint32(8,a,!0),u.view.setUint32(14,a,!0),f.view.setUint32(12,c.size,!0),u.view.setUint32(18,c.size,!0)),b.writeUint8Array(f.array,function(){k+=16,m()},g)}function r(){if(o=o||{},a=a.trim(),o.directory&&"/"!=a.charAt(a.length-1)&&(a+="/"),i.hasOwnProperty(a))return void d(P);v=B(A(a)),j.push(a),p(function(){c?f||0===o.level?t(x,l++,c,b,0,c.size,!0,q,n,h,g):s(x,l++,c,b,o.level,q,n,h,g):q()},g)}var u,v,w,x=this._worker;c?c.init(r,h):r()},close:function(a){this._worker&&(this._worker.terminate(),this._worker=null);var c,d,f,h=0,l=0;for(d=0;d<j.length;d++)f=i[j[d]],h+=46+f.filename.length+f.comment.length;for(c=e(h+22),d=0;d<j.length;d++)f=i[j[d]],c.view.setUint32(l,1347092738),c.view.setUint16(l+4,5120),c.array.set(f.headerArray,l+6),c.view.setUint16(l+32,f.comment.length,!0),f.directory&&c.view.setUint8(l+38,16),c.view.setUint32(l+42,f.offset,!0),c.array.set(f.filename,l+46),c.array.set(f.comment,l+46+f.filename.length),l+=46+f.filename.length+f.comment.length;c.view.setUint32(l,1347093766),c.view.setUint16(l+8,j.length,!0),c.view.setUint16(l+10,j.length,!0),c.view.setUint32(l+12,h,!0),c.view.setUint32(l+16,k,!0),b.writeUint8Array(c.array,function(){b.getData(a)},g)},_worker:null};a.zip.useWebWorkers?E("deflater",function(a){m._worker=a,c(m)},function(a){d(a)}):c(m)}function D(a){var b=document.createElement("a");return a.map(function(a){return b.href=a})}function E(b,c,d){function e(a){var b=a.data;if(b.error)return h.terminate(),void d(b.error);"importScripts"===b.type&&(h.removeEventListener("message",e),h.removeEventListener("error",f),c(h))}function f(a){h.terminate(),d(a)}if(null!==a.zip.workerScripts&&null!==a.zip.workerScriptsPath)return void d(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));var g;if(a.zip.workerScripts){if(g=a.zip.workerScripts[b],!Array.isArray(g))return void d(new Error("zip.workerScripts."+b+" is not an array!"));g=D(g)}else g=S[b].slice(0),g[0]=(a.zip.workerScriptsPath||"")+g[0];var h=new Worker(g[0]);h.codecTime=h.crcTime=0,h.postMessage({type:"importScripts",scripts:g.slice(1)}),h.addEventListener("message",e),h.addEventListener("error",f)}function F(a){}
var G,H="File format is not recognized.",I="CRC failed.",J="File contains encrypted entry.",K="File is using Zip64 (4gb+ file size).",L="Error while reading zip file.",M="Error while writing zip file.",N="Error while writing file data.",O="Error while reading file data.",P="File already exists.",Q=524288,R="text/plain";try{G=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(a){}b.prototype.append=function(a){for(var b=0|this.crc,c=this.table,d=0,e=0|a.length;d<e;d++)b=b>>>8^c[255&(b^a[d])];this.crc=b},b.prototype.get=function(){return~this.crc},b.prototype.table=function(){var a,b,c,d=[];for(a=0;a<256;a++){for(c=a,b=0;b<8;b++)1&c?c=c>>>1^3988292384:c>>>=1;d[a]=c}return d}(),c.prototype.append=function(a,b){return a},c.prototype.flush=function(){},g.prototype=new f,g.prototype.constructor=g,h.prototype=new f,h.prototype.constructor=h,i.prototype=new f,i.prototype.constructor=i,j.prototype=new f,j.prototype.constructor=j,k.prototype.getData=function(a){a(this.data)},l.prototype=new k,l.prototype.constructor=l,m.prototype=new k,m.prototype.constructor=m,n.prototype=new k,n.prototype.constructor=n,o.prototype=new k,o.prototype.constructor=o;var S={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};a.zip={Reader:f,Writer:k,BlobReader:i,ArrayBufferReader:j,Data64URIReader:h,TextReader:g,BlobWriter:n,ArrayBufferWriter:o,Data64URIWriter:m,TextWriter:l,createReader:function(a,b,c){c=c||F,a.init(function(){z(a,b,c)},c)},createWriter:function(a,b,c,d){c=c||F,d=!!d,a.init(function(){C(a,b,c,d)},c)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(this);var App=function(){var a={};return a.buildNumber="undefined"==typeof buildNumber?"":buildNumber,a.init=function(){EventBus.on(EVENT.command,function(a){switch(window.focus(),a){case COMMAND.newFile:Tracker.new();break;case COMMAND.openFile:EventBus.trigger(EVENT.showView,"diskop_modules_load");break;case COMMAND.saveFile:EventBus.trigger(EVENT.showView,"diskop_modules_save");break;case COMMAND.clearTrack:Editor.clearTrack();break;case COMMAND.clearPattern:Editor.clearPattern();break;case COMMAND.clearInstruments:Tracker.clearInstruments();break;case COMMAND.clearSong:Editor.clearSong();break;case COMMAND.showMain:EventBus.trigger(EVENT.showView,"main");break;case COMMAND.showTopMain:EventBus.trigger(EVENT.showView,"topmain");break;case COMMAND.showBottomMain:EventBus.trigger(EVENT.showView,"bottommain");break;case COMMAND.showOptions:EventBus.trigger(EVENT.showView,"options");break;case COMMAND.showFileOperations:EventBus.trigger(EVENT.showView,"diskop_load");break;case COMMAND.showSampleEditor:EventBus.trigger(EVENT.showView,"sample");break;case COMMAND.togglePiano:EventBus.trigger(EVENT.toggleView,"piano");break;case COMMAND.toggleAppSideBar:EventBus.trigger(EVENT.toggleView,"sidebar");break;case COMMAND.showAbout:var b=UI.modalDialog();b.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0}),b.onClick=b.close;var c=Host.getVersionNumber();Host.getBuildNumber();b.setText("BassoonTracker//Old School Amiga MOD and XM tracker/in plain javascript//©2017-2020 by Steffest//version "+c+"//Fork me on Github!"),UI.setModalElement(b);break;case COMMAND.showHelp:window.open("https://www.stef.be/bassoontracker/docs/");break;case COMMAND.randomSong:UI.diskOperations.playRandomSong();break;case COMMAND.randomSongXM:UI.diskOperations.playRandomSong("xm");break;case COMMAND.showGithub:window.open("https://github.com/steffest/bassoontracker");break;case COMMAND.showStats:if(!document.getElementById("MrDStats")){var d=document.createElement("script");d.onload=function(){var a=new Stats;document.body.appendChild(a.dom),requestAnimationFrame(function b(){a.update(),requestAnimationFrame(b)})},d.src="script/plugins/stats.js",document.head.appendChild(d);break}break;case COMMAND.cut:UI.cutSelection(!0);break;case COMMAND.copy:UI.copySelection(!0);break;case COMMAND.paste:UI.pasteSelection(!0);break;case COMMAND.pattern2Sample:Editor.renderTrackToBuffer()}})},a.doCommand=function(a){EventBus.trigger(EVENT.command,a)},a}(),Editor=function(){var a,b={},c=0,d=0,e=0,f=0,g=0,h={};return b.getStepsPerTrack=function(){return Tracker.inFTMode()?8:6},b.setCurrentCursorPosition=function(f){e=f;var g=b.getStepsPerTrack();c=Math.floor(e/g),d=e%g,a!==e&&EventBus.trigger(EVENT.cursorPositionChange,e),a=e},b.getCurrentCursorPosition=function(){return e},b.moveCursorPosition=function(a){var c=b.getStepsPerTrack(),d=e+a,f=Tracker.getTrackCount()*c-1;d>f&&(d=0),d<0&&(d=f),b.setCurrentCursorPosition(d)},b.getCurrentTrack=function(){return c},b.setCurrentTrack=function(a){b.setCurrentCursorPosition(a*b.getStepsPerTrack()+d)},b.getCurrentTrackPosition=function(){return d},b.setCurrentTrackPosition=function(a){b.setCurrentCursorPosition(c*b.getStepsPerTrack()+a)},b.putNote=function(a,b,d){var e=Tracker.getSong().patterns[f][g][c]||new Note,h=StateManager.createNoteUndo(f,c,g,e);e&&(e.instrument=a,d?e.setIndex(d):e.setPeriod(b)),h.data[0].to=e.duplicate(),StateManager.registerEdit(h),Tracker.getSong().patterns[f][g][c]=e,EventBus.trigger(EVENT.patternChange,f)},b.putNoteParam=function(a,b){var d,e,h=Tracker.getSong().patterns[f][g][c],i=StateManager.createNoteUndo(f,c,g,h);if(h){if(1==a||2==a){var j=h.instrument;d=j>>4,e=15&j,1==a&&(d=b),2==a&&(e=b),h.instrument=(d<<4)+e}var k=0;if(Tracker.inFTMode()&&(k=2,3==a||4==a)){var l=h.volumeEffect;d=l>>4||1,e=15&l,3==a&&(d=b+1),4==a&&(e=b),h.volumeEffect=(d<<4)+e,h.volumeEffect<16&&(h.volumeEffect=0)}if(a==3+k&&(h.effect=b),a==4+k||a==5+k){var m=h.param;d=m>>4,e=15&m,a==4+k&&(d=b),a==5+k&&(e=b),h.param=(d<<4)+e}}i.data[0].to=h.duplicate(),StateManager.registerEdit(i),Tracker.getSong().patterns[f][g][c]=h,EventBus.trigger(EVENT.patternChange,f)},b.clearTrack=function(){for(var a=Tracker.getCurrentPatternData().length,b=StateManager.createTrackUndo(f),d=0;d<a;d++){var e=Tracker.getSong().patterns[f][d][c];e&&(StateManager.addNote(b,c,d,e),e.clear())}StateManager.registerEdit(b),EventBus.trigger(EVENT.patternChange,f)},b.clearPattern=function(){for(var a=Tracker.getCurrentPatternData().length,b=StateManager.createPatternUndo(f),c=0;c<a;c++)for(var d=0;d<Tracker.getTrackCount();d++){var e=Tracker.getSong().patterns[f][c][d];e&&(StateManager.addNote(b,d,c,e),e.clear())}StateManager.registerEdit(b),EventBus.trigger(EVENT.patternChange,f)},b.clearSong=function(){var a=Tracker.getSong();Tracker.setCurrentPattern(0),b.clearPattern(),a.patterns=[a.patterns[0]],a.length=1,a.restartPosition=0;for(var c=[],d=0;d<128;++d)c[d]=0;a.patternTable=c,Tracker.setAmigaSpeed(6),Tracker.setBPM(125),Tracker.setCurrentSongPosition(1),EventBus.trigger(EVENT.songPropertyChange,a),EventBus.trigger(EVENT.patternTableChange)},b.copyTrack=function(a){var b=void 0!==a;b||(a=c);for(var d=Tracker.getCurrentPatternData().length,e=[],g=0;g<d;g++){e.push(Tracker.getSong().patterns[f][g][a].duplicate())}if(b)return e;h.track=e},b.copyPattern=function(){for(var a=[],c=0;c<Tracker.getTrackCount();c++){a.push(b.copyTrack(c))}h.pattern=a},b.getPasteData=function(){return h},b.pasteTrack=function(a,b){var d=void 0!==a,e=b;if(d||(a=c,e=h.track),e){for(var g=StateManager.createTrackUndo(f),i=Tracker.getCurrentPatternData().length,j=0;j<i;j++){var k=Tracker.getSong().patterns[f][j][a],l=e[j];StateManager.addNote(g,a,j,k).to=l,k.populate(l)}return d||EventBus.trigger(EVENT.patternChange,f),StateManager.registerEdit(g),!0}return!1},b.pastePattern=function(){var a=h.pattern;if(a){for(var c=0;c<Tracker.getTrackCount();c++)b.pasteTrack(c,a[c]);return EventBus.trigger(EVENT.patternChange,f),!0}return!1},b.insertNote=function(){for(var a=Tracker.getSong().patterns[f].length-2,b=g,d=a;d>=b;d--){var e=Tracker.getSong().patterns[f][d][c],h=Tracker.getSong().patterns[f][d+1][c];h.instrument=e.instrument,h.period=e.period,h.effect=e.effect,h.volumeEffect=e.volumeEffect,h.param=e.param,h.index=e.index}e=Tracker.getSong().patterns[f][g][c],e&&e.clear(),EventBus.trigger(EVENT.patternChange,f)},b.removeNote=function(a,b){if(void 0===a&&(a=c),void 0===b&&(b=g),0!==b){for(var d=b,e=Tracker.getSong().patterns[f].length-1,h=d;h<=e;h++){var i=Tracker.getSong().patterns[f][h][a],j=Tracker.getSong().patterns[f][h-1][a];j.instrument=i.instrument,j.period=i.period,j.effect=i.effect,j.volumeEffect=i.volumeEffect,j.param=i.param,j.index=i.index}i=Tracker.getSong().patterns[f][e][a],i&&i.clear(),EventBus.trigger(EVENT.patternChange,f)}},b.renderTrackToBuffer=function(a,c){var d=Tracker.getSong(),e=0,f=Tracker.getCurrentSongPosition(),g=Tracker.getCurrentPatternData().length,h=.1,i=Tracker.getProperties(),j=i.ticksPerStep,k=i.tickTime,l=1;f=0;var m=f+l;m=Math.min(m,d.length),l=m-f;var n=j*k*g*l+.2;for(Audio.startRendering(n);f<m;){var o=d.patternTable[f],p=d.patterns[o];for(g=p.length;e<g;)Tracker.playPatternStep(e,h,p),h+=j*k,e++;e=0,f++}Audio.stopRendering(function(a){b.buffer2Sample(a)})},b.save=function(a,c){UI.setStatus("Exporting ...",!0),b.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(d){var e=new Blob([d.buffer],{type:"application/octet-stream"}),f=a||b.getFileName();if("function"==typeof c)return void c(e);"dropbox"===c?(Logger.info("save to dropbox "+f),Dropbox.putFile("/"+f,e,function(a){UI.setStatus(a?"":"Error while saving to Dropbox ...")})):(Logger.info("save "+f),saveAs(e,f),UI.setStatus(""))})},b.importSample=function(a,b){function c(){if(Tracker.getTrackerMode()===TRACKERMODE.PROTRACKER&&d.sample.length>131070){var a=UI.modalDialog();a.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0}),a.onClick=a.close,a.setText("Warning//The maximum sample lenght in .MOD format is 128kb//If you save in .MOD format/this sample will be truncated.//Please try downsampling or trimming the sample/to below 131072 bytes/or switch to .XM format"),UI.setModalElement(a)}}var d=Tracker.getCurrentInstrument()||Instrument();d.name=b,d.sample.length=a.length,d.sample.loop.start=0,d.sample.loop.length=0,d.setFineTune(0),d.sample.volume=64,d.sample.data=[],d.sample.name=b,detectSampleType(a,d.sample,function(){EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex()),c()}),EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex())},b.buffer2Sample=function(a){var b=Tracker.getCurrentInstrument()||Instrument(),c="pattern "+Tracker.getCurrentPattern();b.name=c,b.sample.loop.start=0,b.sample.loop.length=0,b.setFineTune(0),b.sample.volume=64,b.sample.name=c;var d=a.getChannelData(0);b.sample.data=[];var e=Math.floor(Audio.context.sampleRate/10);for(i=e,len=d.length;i<len;i+=4)b.sample.data.push(d[i]);b.sample.length=b.sample.data.length,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex())},b.buildBinary=function(a,b){a=a||MODULETYPE.mod;var c;a===MODULETYPE.mod&&(c=ProTracker()),a===MODULETYPE.xm&&(c=FastTracker()),c&&c.write(b)},EventBus.on(EVENT.trackerModeChanged,function(a){b.setCurrentTrackPosition(0)}),EventBus.on(EVENT.patternChange,function(a){f=a}),EventBus.on(EVENT.patternPosChange,function(a){g=a.current}),EventBus.on(EVENT.trackCountChange,function(a){e>=a*b.getStepsPerTrack()&&b.setCurrentTrack(a-1)}),b}(),FetchService=function(){var a={};return a.get=function(b,c){a.ajax({url:b,success:function(a){c(a)},error:function(a){c(void 0,a)}})},a.post=function(b,c,d){var e=c;if("object"==typeof c){e="";for(var f in c)c.hasOwnProperty(f)&&(e+="&"+f+"="+encodeURIComponent(c[f]));e.length&&(e=e.substr(1))}a.ajax({method:"POST",url:b,data:e,datatype:"form",success:function(a){d(a)},error:function(a){d(void 0,a)}})},a.sendBinary=function(b,c,d){a.ajax({method:"POST",url:b,data:c,success:function(a){d(a)},error:function(a){d(void 0,a)}})},a.json=function(b,c){void 0===c&&(c=function(){}),a.ajax({url:b,cache:!1,datatype:"json",headers:[{key:"Accept",value:"application/json"}],success:function(a){c(a)},error:function(a){c(void 0,a)}})},a.html=function(b,c){a.ajax({url:b,cache:!1,datatype:"html",success:function(a){c(a)},error:function(a){c(void 0,a)}})},a.ajax=function(a){var b=new XMLHttpRequest;a.error=a.error||function(){a.success(!1)},"jsonp"===a.datatype&&a.error(b);var c=a.url;if("boolean"==typeof a.cache&&!a.cache&&Host.useUrlParams){var d=(new Date).getTime();c+=c.indexOf("?")>0?"&r="+d:"?r="+d}var e=a.method||"GET";b.onreadystatechange=function(){if(!(b.readyState<4)&&4===b.readyState)if(200!==b.status&&201!==b.status)a.error(b);else{var c=b.responseText;"json"===a.datatype&&(c=JSON.parse(c)),"html"===a.datatype&&(c=document.createElement("div"),c.innerHTML=b.responseText),a.success(c)}},b.ontimeout=function(a){},b.open(e,c,!0),b.timeout=a.timeout||3e4,a.headers&&a.headers.forEach(function(a){b.setRequestHeader(a.key,a.value)});var f=a.data||"";"POST"===e&&a.data&&"form"===a.datatype&&b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.send(f)},a}(),Host=function(){var a,b={};return b.useUrlParams=!0,b.useDropbox=!0,b.showInternalMenu=!0,b.useWebWorkers=!0,b.init=function(){"object"==typeof HostBridge&&(a=HostBridge,a.init(),"boolean"==typeof a.useUrlParams&&(b.useUrlParams=a.useUrlParams),"boolean"==typeof a.useDropbox&&(b.useDropbox=a.useDropboxs),"boolean"==typeof a.showInternalMenu&&(b.showInternalMenu=a.showInternalMenu),"boolean"==typeof a.useWebWorkers&&(b.useWebWorkers=a.useWebWorkers))},b.getBaseUrl=function(){return a&&a.getBaseUrl?a.getBaseUrl():void 0===Settings?"":Settings.baseUrl||""},b.getRemoteUrl=function(){return a&&a.getRemoteUrl?a.getRemoteUrl():""},b.getVersionNumber=function(){return"undefined"!=typeof versionNumber?versionNumber:a&&a.getVersionNumber?a.getVersionNumber():"dev"},b.getBuildNumber=function(){return"undefined"!=typeof buildNumber?buildNumber:a&&a.getBuildNumber?a.getBuildNumber():(new Date).getTime()},b.putFile=function(a,b){},b}(),Logger=function(){var a={};a.info=function(a){b("info",a)},a.warn=function(a){b("warn",a)},a.error=function(a){b("error",a)};var b=function(a,b){var c=UI.stats(),d="undefined"==typeof versionNumber?"dev":versionNumber;b=createSlug(b),FetchService.get("https://www.stef.be/bassoontracker/api/log/"+a+"/"+b+"/"+c.averageFps+"/"+c.skipRenderSteps+"/"+d+"/"+canvas.width+"x"+canvas.height+"/"+c.averageRenderFps,function(a){})};return a}(),debug=!1,Main=function(){var a={};return a.init=function(){Host.init(),Tracker.init(),Audio.init(),UI.init(function(){if(window.focus(),Audio.context)Settings.readSettings(),App.init();else{var a=UI.modalDialog();a.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0}),a.onDown=function(){window.location.href="https://www.google.com/chrome/"},a.setText("Sorry//Your browser does not support WebAudio//Supported browsers are/Chrome,Firefox,Safari and Edge"),UI.setModalElement(a)}})},a}();document.addEventListener("DOMContentLoaded",Main.init);var PreLoader=function(){var a={};a.load=function(c,d,e){a.type=d||PRELOADTYPE.image,a.loadCount=0,a.max=c.length,a.next=e;for(var f=0,g=c.length;f<g;f++)b(c[f])};var b=function(b){if(a.type==PRELOADTYPE.image){var c=new Image;c.onload=function(){cachedAssets.images[b]=this,++a.loadCount==a.max&&a.next&&a.next()},c.onerror=function(){alert("BufferLoader: XHR error")},c.src=b}if(a.type==PRELOADTYPE.audio){var d=new XMLHttpRequest;d.responseType="arraybuffer",d.open("GET",b,!0),d.onload=function(){Audio.context.decodeAudioData(d.response,function(c){if(!c)return void alert("error decoding file data: "+b);cachedAssets.audio[b]=c,++a.loadCount==a.max&&a.next&&a.next()},function(a){})},d.onerror=function(){alert("BufferLoader: XHR error")},d.send()}};return a},Settings=function(){function a(){SETTINGS.keyboardTable="qwerty",SETTINGS.vubars="colour",SETTINGS.stereoSeparation=STEREOSEPARATION.BALANCED,SETTINGS.dropboxMode="rename",SETTINGS.skipFrame=1,UI.skipFrame(SETTINGS.skipFrame)}var b={};return b.readSettings=function(){a();var b=Storage.get("bassoonTrackerSettings");if(b){try{b=JSON.parse(b)}catch(a){return!1}for(var c in b)if(SETTINGS.hasOwnProperty(c)&&b.hasOwnProperty(c)&&(SETTINGS[c]=b[c],"skipFrame"===c)){var d=parseInt(SETTINGS[c],10);isNaN(d)||UI.skipFrame(d)}SETTINGS.stereoSeparation&&Audio.setStereoSeparation(SETTINGS.stereoSeparation)}},b.saveSettings=function(){var a={vubars:SETTINGS.vubars,keyboardTable:SETTINGS.keyboardTable,stereoSeparation:SETTINGS.stereoSeparation,dropboxMode:SETTINGS.dropboxMode,skipFrame:UI.getSkipFrame()};Storage.set("bassoonTrackerSettings",JSON.stringify(a))},b.reset=function(){a(),b.saveSettings()},b}(),Storage=function(){var a={};return a.get=function(a){return localStorage.getItem(a)},a.set=function(a,b){return localStorage.setItem(a,b)},a}(),periodNoteTable={},periodFinetuneTable={},nameNoteTable={},noteNames=[],FTNotes=[],FTPeriods=[],Tracker=function(){function a(a){a=a||0,j=j||new WAAClock(Audio.context),j.start(),Audio.enable(),UI&&UI.setStatus("Playing"),M=[],N=[],o=k.patterns[a];var c=o.length,d={},e=0,g=Audio.context.currentTime+.1,h=.2,l=o,m=A;L=[],r=j.setTimeout(function(j){e>1&&(h=1,r.repeat(h));var n=j.deadline+h;for(Audio.clearScheduledNotesCache();g<n;){if(d.pause&&!Tracker.autoPlay){if(!d.pasuseHandled){var o=g-Audio.context.currentTime;o>0&&setTimeout(function(){s.pause(),s.setAmigaSpeed(6)},Math.round(1e3*o)+100),d.pasuseHandled=!0}return}if(s.setStateAtTime(g,{patternPos:e,songPos:m}),d.patternDelay){for(d.patternDelay--,O=0;O<F;O++)f(O,g);g+=D*E}else if(d=b(e,g,l,m),g+=D*E,++e>=c||d.patternBreak)if(d.positionBreak&&d.targetSongPosition==m||(M=[],N=[]),e=0,Tracker.getPlayType()==PLAYTYPE.song){var p=d.positionBreak?d.targetSongPosition:++m;p>=k.length&&(p=k.restartPosition?k.restartPosition-1:0,EventBus.trigger(EVENT.songEnd)),p>=k.length&&(p=0),m=p,a=k.patternTable[m],l=k.patterns[a],l||(l=i(),k.patterns[a]=l),c=l.length,d.patternBreak&&(e=d.targetPatternPosition||0)>l.length&&(e=0)}else d.patternBreak&&(e=d.targetPatternPosition||0)>G&&(e=0)}for(O=0;O<F;O++){var q=J[O];if(q&&q.time&&q.scheduled){var t=s.getInstrument(q.instrumentIndex);if(q.scheduled.volume&&g+h>=q.scheduled.volume){var u=t.scheduleEnvelopeLoop(q.volumeEnvelope,q.scheduled.volume,2);q.scheduled.volume+=u}q.scheduled.panning&&g+h>=q.scheduled.panning&&(u=t.scheduleEnvelopeLoop(q.panningEnvelope,q.scheduled.panning,2),q.scheduled.panning+=u)}}},.01).repeat(h).tolerance({early:.1})}function b(a,b,d,e){d=d||o;for(var g,h=d[a],i=F,j={},k=0;k<i;k++)(l=h[k])&&l.effect&&15===l.effect&&(l.param<=32?(Tracker.setAmigaSpeed(l.param),0===l.param&&(j.pause=!0)):Tracker.setBPM(l.param));for(var k=0;k<i;k++){var l=h[k];if(l){var m={position:e,step:a},n=b;if(I){n+=(Math.random()*I*2-I)/1e3}g=c(l,k,n,m),g.patternBreak&&(j.patternBreak=!0,j.targetPatternPosition=g.targetPatternPosition||0),g.positionBreak&&(j.positionBreak=!0,j.targetPatternPosition=g.targetPatternPosition||0,j.targetSongPosition=g.targetSongPosition||0),g.patternDelay&&(j.patternDelay=g.patternDelay)}}for(k=0;k<i;k++)f(k,b);return j}function c(a,b,c,e){var f=100,g={},h=a.instrument,i=a.period,j=a.index;i&&!h&&(h=J[b].currentInstrument,f="number"==typeof J[b].currentVolume?J[b].currentVolume:f,SETTINGS.emulateProtracker1OffsetBug&&h&&K[b].offset&&K[b].offset.instrument===h&&(g.offset=K[b].offset)),"number"==typeof a.instrument&&(A=s.getInstrument(a.instrument))&&(f=A.sample.volume/64*100,SETTINGS.emulateProtracker1OffsetBug&&(K[b].offset=K[b].offset||{},K[b].offset.value=0,K[b].offset.instrument=a.instrument));var k=f,l=!0;if("number"==typeof h&&(A=s.getInstrument(h)),j&&s.inFTMode())if(97===j&&(j=NOTEOFF),j===NOTEOFF){var m=A||s.getInstrument(J[b].currentInstrument);k=m?m.noteOff(c,J[b]):0,f=k,l=!1}else if(A&&(A.setSampleForNoteIndex(j),A.sample.relativeNote&&(j+=A.sample.relativeNote)),s.useLinearFrequency)i=7680-64*(j-1);else{var n=FTNotes[j];n&&(i=n.period)}var o,r,t=a.param,u={};if(a.volumeEffect&&s.inFTMode()){var v=a.volumeEffect;if(o=v>>4,r=15&v,v>15&&v<=80)k=(v-16)/64*100,f=k,g.volume={value:k};else switch(o){case 6:g.fade={value:r*-1*100/64};break;case 7:g.fade={value:100*r/64};break;case 8:g.fade={value:100*-r/64,fine:!0};break;case 9:g.fade={value:100*r/64,fine:!0};break;case 10:break;case 11:break;case 12:g.panning={value:17*(v-192),slide:!1};break;case 13:g.panning={value:v,slide:!0};break;case 14:break;case 15:}}switch(a.effect){case 0:if(t){o=t>>4,r=15&t;var w=0;if(A=A||s.getInstrument(J[b].currentInstrument),s.inFTMode()){if(A){var x=j||J[b].noteIndex,y=A.getPeriodForNote(x,!0);j===NOTEOFF?g.arpeggio=K[b].arpeggio:(g.arpeggio={root:y,interval1:y-A.getPeriodForNote(x+o,!0),interval2:y-A.getPeriodForNote(x+r,!0),step:1},K[b].arpeggio=g.arpeggio)}}else y=i||J[b].startPeriod,A&&(w=A.getFineTune())&&(y=Audio.getFineTuneForPeriod(y,w)),g.arpeggio={root:y,interval1:y-Audio.getSemiToneFrom(y,o,w),interval2:y-Audio.getSemiToneFrom(y,r,w),step:1}}a.instrument&&(g.volume={value:f});break;case 1:t*=-1,s.inFTMode()&&!t&&K[b].slideUp&&(t=K[b].slideUp.value),g.slide={value:t},K[b].slideUp=g.slide;break;case 2:s.inFTMode()&&!t&&K[b].slideDown&&(t=K[b].slideDown.value),g.slide={value:t},K[b].slideDown=g.slide;break;case 3:l=!1;var z=i;if(s.inFTMode()&&j===NOTEOFF&&(z=0),J[b].currentInstrument&&(h=J[b].currentInstrument),z&&h){var A=s.getInstrument(h);A&&A.getFineTune()&&(z=s.inFTMode()?A.getPeriodForNote(j,!0):Audio.getFineTuneForPeriod(z,A.getFineTune()))}var B=K[b].slide;B&&(t||(t=B.value)),z||(z=K[b].defaultSlideTarget),g.slide={value:t,target:z,canUseGlissando:!0,resetVolume:!!a.instrument,volume:f},K[b].slide=g.slide,a.instrument&&(g.volume={value:f});break;case 4:a.instrument&&(J[b].startVolume&&(g.volume={value:k}),J[b].vibratoTimer=0),o=t>>4,r=15&t;var C=o*D/64,F=K[b].vibrato;0==o&&F&&(C=F.freq),0==r&&F&&(r=F.amplitude),g.vibrato={amplitude:r,freq:C},K[b].vibrato=g.vibrato;break;case 5:l=!1,z=i,z&&h&&(A=s.getInstrument(h))&&A.getFineTune()&&(z=s.inFTMode()?Audio.getFineTuneForNote(j,A.getFineTune()):Audio.getFineTuneForPeriod(z,A.getFineTune())),t=1;var B=K[b].slide;B&&(z||(z=B.target||0),t=B.value),g.slide={value:t,target:z},K[b].slide=g.slide,a.instrument&&(g.volume={value:f}),t=a.param,t&&(a.param<16?t*=-1:t=a.param>>4,t=100*t/64,g.fade={value:t,resetOnStep:!!a.instrument},K[b].fade=g.fade);break;case 6:a.instrument&&(J[b].startVolume&&(g.volume={value:k}),J[b].vibratoTimer=0),a.param?(a.param<16?t*=-1:t=15&a.param,t=100*t/64,g.fade={value:t},K[b].fade=g.fade):Tracker.inFTMode()&&K[b].fade&&(g.fade=K[b].fade),K[b].vibrato&&(g.vibrato=K[b].vibrato);break;case 7:i&&!a.instrument&&(J[b].startVolume&&(g.volume={value:k}),J[b].tremoloTimer=0),o=t>>4,r=15&t;var G=r,C=o*D/64,H=K[b].tremolo;0==o&&H&&(C=H.freq),0==r&&H&&(G=H.amplitude),g.tremolo={amplitude:G,freq:C},K[b].tremolo=g.tremolo;break;case 8:g.panning={value:t,slide:!1};break;case 9:t<<=8,!t&&K[b].offset&&(t=K[b].offset.stepValue||K[b].offset.value||0);var I=t;SETTINGS.emulateProtracker1OffsetBug&&!a.instrument&&K[b].offset&&(t+=K[b].offset.value),g.offset={value:t,stepValue:I},K[b].offset=K[b].offset||{},K[b].offset.value=g.offset.value,K[b].offset.stepValue=g.offset.stepValue,SETTINGS.emulateProtracker1OffsetBug&&(a.instrument&&(K[b].offset.instrument=a.instrument),i&&(K[b].offset.value+=I)),a.instrument&&(g.volume={value:f});break;case 10:if(a.param<16?t*=-1:t=a.param>>4,t=100*t/64,!a.param){var L=K[b].fade;L&&(t=L.value)}g.fade={value:t,resetOnStep:!!a.instrument},s.inFTMode()&&(K[b].fade=g.fade);break;case 11:Tracker.autoPlay||(u.patternBreak=!0,u.positionBreak=!0,u.targetSongPosition=a.param,u.targetPatternPosition=0);break;case 12:k=a.param/64*100,g.volume={value:k};break;case 13:u.patternBreak=!0,o=t>>4,r=15&t,u.targetPatternPosition=10*o+r;break;case 14:var O=t>>4,P=15&t;switch(O){case 0:s.inFTMode()||Audio.setAmigaLowPassFilter(!P,c);break;case 1:P*=-1,!P&&K[b].fineSlide&&(P=K[b].fineSlide.value),g.slide={value:P,fine:!0},K[b].fineSlide=g.slide;break;case 2:!P&&K[b].fineSlide&&(P=K[b].fineSlide.value),g.slide={value:P,fine:!0},K[b].fineSlide=g.slide;break;case 3:K[b].glissando=!!P;break;case 4:switch(P){case 1:p=Audio.waveFormFunction.saw;break;case 2:p=Audio.waveFormFunction.square;break;case 3:p=Audio.waveFormFunction.sine;break;case 4:p=Audio.waveFormFunction.sine;break;case 5:p=Audio.waveFormFunction.saw;break;case 6:p=Audio.waveFormFunction.square;break;case 7:p=Audio.waveFormFunction.sine;break;default:p=Audio.waveFormFunction.sine}break;case 5:if(h){var A=s.getInstrument(h);g.fineTune={original:A.getFineTune(),instrument:A},A.setFineTune(P)}break;case 6:P?(N[b]=N[b]||0,N[b]<P?(N[b]++,u.patternBreak=!0,u.positionBreak=!0,u.targetSongPosition=e.position,u.targetPatternPosition=M[b]||0):N[b]=0):M[b]=e.step;break;case 7:switch(P){case 1:q=Audio.waveFormFunction.saw;break;case 2:q=Audio.waveFormFunction.square;break;case 3:q=Audio.waveFormFunction.sine;break;case 4:q=Audio.waveFormFunction.sine;break;case 5:q=Audio.waveFormFunction.saw;break;case 6:q=Audio.waveFormFunction.square;break;case 7:q=Audio.waveFormFunction.sine;break;default:q=Audio.waveFormFunction.sine}break;case 8:break;case 9:P&&(g.reTrigger={value:P});break;case 10:P=100*P/64,g.fade={value:P,fine:!0};break;case 11:P=100*P/64,g.fade={value:-P,fine:!0};break;case 12:P?P<D&&(g.cutNote={value:P}):l=!1;break;case 13:P&&(P<D?c+=E*P:l=!1);break;case 14:u.patternDelay=P;break;case 15:}break;case 15:a.param<=32?Tracker.setAmigaSpeed(a.param,c):Tracker.setBPM(a.param);break;case 16:t=Math.min(t,64),Audio.setMasterVolume(t/64,c);break;case 17:o=t>>4,r=15&t;var Q=64*Audio.getLastMasterVolume(),R=0;if(o){var S=c+o*E;R=o*(D-1)}else r&&(S=c+r*E,R=-r*(D-1));R&&(t=(Q+R)/64,t=Math.max(0,t),t=Math.min(1,t),Audio.slideMasterVolume(t,S));break;case 20:s.inFTMode()&&(m=A||s.getInstrument(J[b].currentInstrument),k=m?m.noteOff(c,J[b]):0,f=k,l=!1);break;case 21:break;case 25:break;case 27:g.reTrigger={value:a.param};break;case 29:break;case 33:}return l&&h&&i&&(d(b,c),J[b]={},A&&(J[b]=A.play(j,i,k,b,g,c)),K[b].defaultSlideTarget=J[b].startPeriod),h&&(J[b].currentInstrument=h,g.fineTune&&g.fineTune.instrument&&g.fineTune.instrument.setFineTune(g.fineTune.original||0)),A&&A.hasVibrato()&&(J[b].hasAutoVibrato=!0),J[b].effects=g,J[b].note=a,u}function d(a,b){try{if(J[a].source){var c=J[a].volume.gain;c.setValueAtTime(J[a].currentVolume/100,b-.002),c.linearRampToValueAtTime(0,b),J[a].source.stop(b+.02)}}catch(a){}}function e(a,b){var c=s.getInstrument(a.instrumentIndex);if(c){var d=-c.vibrato.rate/40,e=c.vibrato.depth/8;if(s.useLinearFrequency&&(e*=4),a.vibratoTimer=a.vibratoTimer||0,c.vibrato.sweep&&a.vibratoTimer<c.vibrato.sweep){e*=1-(c.vibrato.sweep-a.vibratoTimer)/c.vibrato.sweep}var f=c.getAutoVibratoFunction(),g=f(b,a.vibratoTimer,d,e);return a.vibratoTimer++,g}return b}function f(a,b){var c=J[a],f=c.effects;if(c&&f){var g,h=!1;if(c.startVibratoTimer=c.vibratoTimer||0,c.resetPeriodOnStep&&c.source){var i=c.currentPeriod||c.startPeriod;s.setPeriodAtTime(c,i,b),c.resetPeriodOnStep=!1}if(f.volume){var j=f.volume.value;c.volume&&c.volume.gain.setValueAtTime(j/100,b),c.currentVolume=j}if(f.panning&&(g=f.panning.value,255===g&&(g=254),c.panning&&c.panning.pan.setValueAtTime((g-127)/127,b)),f.fade){g=f.fade.value;var k,l=1;k=f.fade.resetOnStep?c.startVolume:c.currentVolume;var m=D;f.fade.fine&&(l=0,m=1);for(var n=l;n<m;n++)c.volume&&(c.volume.gain.setValueAtTime(k/100,b+n*E),k+=g,k=Math.max(k,0),k=Math.min(k,100));c.currentVolume=k}if(f.slide&&c.source){var o=c.currentPeriod||c.startPeriod,i=o,m=D;f.slide.fine&&(m=2);var r=f.slide.value;if(s.inFTMode()&&s.useLinearFrequency&&(r=4*f.slide.value),g=Math.abs(r),s.inFTMode()&&f.slide.resetVolume&&(c.volumeFadeOut||c.volumeEnvelope)){var t=s.getInstrument(c.instrumentIndex);t&&t.resetVolume(b,c)}c.vibratoTimer=c.startVibratoTimer;for(var n=1;n<m;n++){f.slide.target?(K[a].defaultSlideTarget=f.slide.target,i<f.slide.target?(i+=g)>f.slide.target&&(i=f.slide.target):(i-=g)<f.slide.target&&(i=f.slide.target)):(i+=r,K[a].defaultSlideTarget&&(K[a].defaultSlideTarget+=r)),s.inFTMode()||(i=Audio.limitAmigaPeriod(i));var u=i;f.slide.canUseGlissando&&K[a].glissando&&(u=Audio.getNearestSemiTone(i,c.instrumentIndex)),u!==c.currentPeriod&&(c.currentPeriod=i,c.hasAutoVibrato&&s.inFTMode()&&(i=e(c,i),h=!0),s.setPeriodAtTime(c,u,b+n*E))}}if(f.arpeggio&&c.source){var i,o=c.currentPeriod||c.startPeriod;c.resetPeriodOnStep=!0,c.vibratoTimer=c.startVibratoTimer;for(var n=0;n<D;n++){var v=n%3;0==v&&(i=o),1==v&&f.arpeggio.interval1&&(i=o-f.arpeggio.interval1),2==v&&f.arpeggio.interval2&&(i=o-f.arpeggio.interval2),c.hasAutoVibrato&&s.inFTMode()&&(i=e(c,i),h=!0),s.setPeriodAtTime(c,i,b+n*E)}}if(f.vibrato||c.hasAutoVibrato&&!h){f.vibrato=f.vibrato||{freq:0,amplitude:0};var w=f.vibrato.freq,x=f.vibrato.amplitude;if(s.inFTMode()&&s.useLinearFrequency&&(x*=4),c.vibratoTimer=c.vibratoTimer||0,c.source){c.resetPeriodOnStep=!0,o=c.currentPeriod||c.startPeriod,c.vibratoTimer=c.startVibratoTimer;for(var n=0;n<D;n++)i=p(o,c.vibratoTimer,w,x),c.hasAutoVibrato&&s.inFTMode()?(i=e(c,i),h=!0):c.vibratoTimer++,s.setPeriodAtTime(c,i,b+n*E)}}if(f.tremolo){var w=f.tremolo.freq,x=f.tremolo.amplitude;if(c.tremoloTimer=c.tremoloTimer||0,c.volume)for(var y=c.startVolume,n=0;n<D;n++)y=q(y,c.tremoloTimer,w,x),y<0&&(y=0),y>100&&(y=100),c.volume.gain.setValueAtTime(y/100,b+n*E),c.currentVolume=y,c.tremoloTimer++}if(f.cutNote&&(c.volume&&c.volume.gain.setValueAtTime(0,b+f.cutNote.value*E),c.currentVolume=0),f.reTrigger){var z=c.instrumentIndex,A=c.startPeriod;j=c.startVolume;for(var B=c.noteIndex,C=f.reTrigger.value||1,F=C;F<D;){var G=b+F*E;d(a,G),J[a]=Audio.playSample(z,A,j,a,f,G,B),F+=C}}}}function g(){UI&&UI.setInfo(k.title),k.channels&&s.setTrackCount(k.channels),n=void 0,l=void 0,m=void 0,B=void 0,s.setCurrentSongPosition(0),s.setCurrentPatternPos(0),s.setCurrentInstrumentIndex(1),s.clearEffectCache(),EventBus.trigger(EVENT.songLoaded,k),EventBus.trigger(EVENT.songPropertyChange,k)}function h(){s.setAmigaSpeed(6),s.setBPM(125),p=Audio.waveFormFunction.sine,q=Audio.waveFormFunction.sine,K=[],J=[];for(var a=0;a<F;a++)J.push({}),K.push({});s.useLinearFrequency=!1,s.setTrackerMode(TRACKERMODE.PROTRACKER),Audio.setMasterVolume(1),Audio.setAmigaLowPassFilter(!1,0)}function i(){for(var a=[],b=0;b<G;b++){var c,d=[];for(c=0;c<F;c++)d.push(Note());a.push(d)}return a}for(var j,k,l,m,n,o,p,q,r,s={},t=!1,u=!1,v=[],w=1,x=0,y=0,z=PLAYTYPE.song,A=0,B=0,C=125,D=6,E=2.5/C,F=4,G=64,H=TRACKERMODE.PROTRACKER,I=0,J=[],K=[],L=[],M=[],N=[],O=0;O<F;O++)J.push({}),K.push({});s.init=function(a){for(var b=-8;b<8;b++)periodFinetuneTable[b]={};for(var c in NOTEPERIOD)if(NOTEPERIOD.hasOwnProperty(c)){var d=NOTEPERIOD[c];if(periodNoteTable[d.period]=d,nameNoteTable[d.name]=d,noteNames.push(d.name),d.tune)for(b=-8;b<8;b++){var e=periodFinetuneTable[b],f=b+8;e[d.tune[f]]=d.period}}var g=0;for(c in FTNOTEPERIOD)if(FTNOTEPERIOD.hasOwnProperty(c)){var h=FTNOTEPERIOD[c];h.period||(h.period=1),FTNotes.push(h),FTPeriods[h.period]=g,h.modPeriod&&(FTPeriods[h.modPeriod]=g),g++}a&&(Audio.init(),a.plugin&&UI.initPlugin(a))},s.setCurrentInstrumentIndex=function(a){if(k.instruments[a])w=a,l!=w&&EventBus.trigger(EVENT.instrumentChange,w),l=w;else if(a<=s.getMaxInstruments()){for(var b=k.instruments.length,c=a;b<=c;b++)s.setInstrument(b,Instrument());var d=[];for(b=1;b<=c;b++){var e=k.instruments[b]||{name:""};d.push({label:b+" "+e.name,data:b}),EventBus.trigger(EVENT.instrumentListChange,d)}w=a,l!=w&&EventBus.trigger(EVENT.instrumentChange,w),l=w}},s.getCurrentInstrumentIndex=function(){return w},s.getCurrentInstrument=function(){return v[w]},s.getMaxInstruments=function(){return s.inFTMode()?128:31},s.setCurrentPattern=function(a){x=a,o=k.patterns[x],o||(o=i(),k.patterns[x]=o),G=o.length,m!=x&&EventBus.trigger(EVENT.patternChange,x),m=x},s.getCurrentPattern=function(){return x},s.getCurrentPatternData=function(){return o},s.updatePatternTable=function(a,b){
k.patternTable[a]=b,EventBus.trigger(EVENT.patternTableChange,b),a==A&&(m=void 0,Tracker.setCurrentPattern(b))},s.setCurrentPatternPos=function(a){y=a,n!=y&&EventBus.trigger(EVENT.patternPosChange,{current:y,prev:n}),n=y},s.getCurrentPatternPos=function(){return y},s.moveCurrentPatternPos=function(a){var b=y+a,c=G-1;b<0&&(b=c),b>c&&(b=0),s.setCurrentPatternPos(b)},s.getCurrentSongPosition=function(){return A},s.setCurrentSongPosition=function(a,b){(A=a)!=B&&(EventBus.trigger(EVENT.songPositionChange,A),k.patternTable&&s.setCurrentPattern(k.patternTable[A]),B=A,b&&s.isPlaying()&&(s.stop(),s.togglePlay()))},s.addToPatternTable=function(a,b){void 0===a&&(a=k.length),b=b||0,a==k.length&&(k.patternTable[a]=b,k.length++),EventBus.trigger(EVENT.songPropertyChange,k),EventBus.trigger(EVENT.patternTableChange)},s.removeFromPatternTable=function(a){k.length<2||(void 0===a&&(a=k.length-1),a==k.length-1&&(k.patternTable[a]=0,k.length--),A==k.length&&s.setCurrentSongPosition(A-1),EventBus.trigger(EVENT.songPropertyChange,k),EventBus.trigger(EVENT.patternTableChange))},s.setPlayType=function(a){z=a,EventBus.trigger(EVENT.playTypeChange,z)},s.getPlayType=function(){return z},s.playSong=function(){s.stop(),Audio.checkState(),s.setPlayType(PLAYTYPE.song),u=!0,a(x),EventBus.trigger(EVENT.playingChange,u)},s.playPattern=function(){s.stop(),Audio.checkState(),y=0,s.setPlayType(PLAYTYPE.pattern),u=!0,a(x),EventBus.trigger(EVENT.playingChange,u)},s.stop=function(){j&&j.stop(),Audio.disable(),Audio.setMasterVolume(1),UI&&(UI.setStatus("Ready"),Input.clearInputNotes()),s.clearEffectCache();for(var a=0;a<F;a++)if(J[a].source)try{J[a].source.stop()}catch(a){}u=!1,EventBus.trigger(EVENT.playingChange,u)},s.pause=function(){j&&j.stop(),u=!1,EventBus.trigger(EVENT.playingChange,u)},s.togglePlay=function(){s.isPlaying()?s.stop():z==PLAYTYPE.pattern?s.playPattern():s.playSong()},s.getProperties=function(){return{ticksPerStep:D,tickTime:E}},s.playPatternStep=b,s.cutNote=d,s.setBPM=function(a){j&&j.timeStretch(Audio.context.currentTime,[r],C/a),C=a,E=2.5/C,EventBus.trigger(EVENT.songBPMChange,C)},s.getBPM=function(){return C},s.setAmigaSpeed=function(a){D=a},s.getAmigaSpeed=function(){return D},s.getSwing=function(){return I},s.setSwing=function(a){I=a},s.getPatternLength=function(){return G},s.setPatternLength=function(a){G=a;var b=k.patterns[x].length;if(b!==G){if(b<G)for(var c=b;c<G;c++){var d,e=[];for(d=0;d<F;d++)e.push(Note());k.patterns[x].push(e)}else k.patterns[x]=k.patterns[x].splice(0,G),y>=G&&s.setCurrentPatternPos(G-1);EventBus.trigger(EVENT.patternChange,x)}},s.getTrackCount=function(){return F},s.setTrackCount=function(a){F=a;for(var b=J.length;b<F;b++)J.push({});for(b=K.length;b<F;b++)K.push({});EventBus.trigger(EVENT.trackCountChange,F)},s.toggleRecord=function(){s.stop(),t=!t,EventBus.trigger(EVENT.recordingChange,t)},s.isPlaying=function(){return u},s.isRecording=function(){return t},s.setStateAtTime=function(a,b){L.push({time:a,state:b})},s.getStateAtTime=function(a){for(var b=void 0,c=0,d=L.length;c<d;c++){if(!(L[0].time<a))return b;b=L.shift().state}return b},s.getTimeStates=function(){return L},s.setPeriodAtTime=function(a,b,c){if(b=Math.max(b,1),s.inFTMode()&&s.useLinearFrequency)var d=8363*Math.pow(2,(4608-b)/768),e=d/Audio.context.sampleRate;else e=a.startPeriod/b,e*=a.startPlaybackRate;a.source.playbackRate.setValueAtTime(e,c),a.source.playbackRate.setValueAtTime(e,c+.005)},s.load=function(a,b,c){a=a||"demomods/StardustMemories.mod",a.indexOf("://")<0&&0!==a.indexOf("/")&&(a=Host.getBaseUrl()+a),UI&&(UI.setInfo(""),UI.setLoading());var d=function(d){s.processFile(d,e,function(d){if(UI&&UI.setStatus("Ready"),d){var f="",g="";if("string"==typeof a){if(a.indexOf("modarchive.org")>0){var h=a.split("moduleid=")[1];k.filename=h.split("#")[1]||h,h=h.split("#")[0],h=h.split("&")[0],g="modArchive",f="https://modarchive.org/index.php?request=view_by_moduleid&query="+h,EventBus.trigger(EVENT.songPropertyChange,k)}a.indexOf("modules.pl")>0&&(h=a.split("modules.pl/")[1],k.filename=h.split("#")[1]||h,h=h.split("#")[0],h=h.split("&")[0],g="modules.pl",f="http://www.modules.pl/?id=module&mod="+h,EventBus.trigger(EVENT.songPropertyChange,k))}UI&&UI.setInfo(k.title,g,f)}if(UI&&d&&!b){var i=window.location.pathname,j=i.substring(i.lastIndexOf("/")+1);window.history.pushState&&window.history.pushState({},e,j+"?file="+encodeURIComponent(a))}d&&P(b),c&&c()})},e="";"string"==typeof a?(e=a.substr(a.lastIndexOf("/")+1),loadFile(a,function(a){d(a)})):(e=a.name||"",b=!0,d(a.buffer||a))};var P=function(a){var b=getUrlParameter("autoplay");Tracker.autoPlay&&(b="1"),!UI&&a&&(b="1"),"true"!=b&&"1"!=b||Tracker.playSong()};return s.handleUpload=function(a){if(a.length){var b=a[0],c=new FileReader;c.onload=function(){s.processFile(c.result,b.name,function(a){UI&&UI.setStatus("Ready")})},c.readAsArrayBuffer(b)}},s.processFile=function(a,b,c){var d=!1,e=new BinaryStream(a,!0),f=FileDetector.detect(e,b);if(f&&"ZIP"==f.name){if(UI&&UI.setStatus("Extracting Zip file",!0),void 0===UZIP)return!1;var i=UZIP.parse(a);for(var b in i){s.processFile(i[b].buffer,b,c);break}}f.isMod&&f.loader&&(d=!0,s.isPlaying()&&s.stop(),h(),k=f.loader().load(e,b),k.filename=b,g()),f.isSample&&void 0!==Editor&&Editor.importSample(e,b),c&&c(d)},s.getSong=function(){return k},s.getInstruments=function(){return v},s.getInstrument=function(a){return v[a]},s.setInstrument=function(a,b){b.instrumentIndex=a,v[a]=b},s.clearEffectCache=function(){K=[];for(var a=0;a<F;a++)K.push({})},s.clearInstruments=function(a){if(k){var b=[],c=a||k.instruments.length-1;for(v=[],O=1;O<=c;O++)s.setInstrument(O,Instrument()),b.push({label:O+" ",data:O});k.instruments=v,EventBus.trigger(EVENT.instrumentListChange,b),EventBus.trigger(EVENT.instrumentChange,w)}},s.setTrackerMode=function(a){H=a,SETTINGS.emulateProtracker1OffsetBug=!s.inFTMode(),EventBus.trigger(EVENT.trackerModeChanged,a)},s.getTrackerMode=function(){return H},s.inFTMode=function(){return H===TRACKERMODE.FASTTRACKER},s.new=function(){h(),k={patterns:[],instruments:[]},s.clearInstruments(31),k.typeId="M.K.",k.title="new song",k.length=1,k.restartPosition=0,k.patterns.push(i());for(var a=[],b=0;b<128;++b)a[b]=0;k.patternTable=a,g()},s.clearInstrument=function(){v[w]=Instrument(),EventBus.trigger(EVENT.instrumentChange,w),EventBus.trigger(EVENT.instrumentNameChange,w)},s.getFileName=function(){return k.filename||(k.title?k.title.replace(/ /g,"-").replace(/\W/g,"")+".mod":"new.mod")},s.useLinearFrequency=!0,s}(),Yascal=function(){var a={};return a.sprites={},a.getImage=function(b){return a.sprites[b]?a.sprites[b].canvas:void 0},a.loadImage=function(a,b){var c=new Image;c.onload=function(){b&&b(c)},c.onerror=function(){},c.src=a},a}(),Y=Yascal,canvas,ctx,UI=function(){function a(a){if(!a.length)return 0;for(var b=0,c=0,d=a.length;c<d;c++)b+=a[c];return b/d}var b,c,d,e,f,g,h,i,j,k={},l=[],m=1200,n=!0,o=0,p=0,q=0,r=0,s=0,t=0,u=100,v=[],w=[],x=0,y=!1,z={},A=getUrlParameter("tracks");8==A&&(m=1200),16==A&&(m=1600),A>=32&&(m=3200),k.init=function(a){canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");var b=window.innerWidth;b>m&&(b=m),canvas.width=b,canvas.height=window.innerHeight,ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),UI.Assets.preLoad(function(){B(),C();var b=getUrlParameter("file");b?(b=decodeURIComponent(b),"http://"===b.substr(0,7).toLowerCase()&&"https:"===document.location.protocol&&(b=BassoonProvider.proxyUrl(b))):b=Host.getBaseUrl()+"demomods/Tinytune.mod",Tracker.load(b,!0),"undefined"!=typeof versionNumber&&FetchService.json("package.json?ts="+(new Date).getTime(),function(a){if(a&&a.version&&a.version!==versionNumber){var b=localStorage.getItem("updatemessageshown")||0;if(b=parseInt(b,10),isNaN(b)&&(b=0),window.reload=function(){localStorage.setItem("updatemessageshown",(new Date).getTime()),window.location.reload(!0)},(new Date).getTime()-b>18e5){var c=document.createElement("div");c.className="message",c.innerHTML='A new version of BassoonTracker is available. Please <a href="#" onclick="reload()">refresh your browser</a>',document.body.appendChild(c)}}}),a&&a()})},k.initPlugin=function(a){if(a.canvas)canvas=a.canvas;else{canvas=document.getElementById("canvas");var b=window.innerWidth;b>m&&(b=m),canvas.width=b,canvas.height=window.innerHeight}ctx=canvas.getContext("2d"),ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),Settings.baseUrl=a.baseUrl,App.isPlugin=!0,buildNumber=Math.random(),UI.Assets.preLoad(function(){B(),C(),Settings.readSettings(),App.init(),a.callback&&a.callback()})},k.setSize=function(a,b){a>m&&(a=m),a==canvas.width&&b==canvas.height||(ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=a,canvas.height=b,k.mainPanel.setSize(a,b),g&&g.setProperties({width:a,height:b}),n=!0)};var B=function(){var a=Y.getImage("font");b=BitmapFont(),b.generate({image:a,startX:1,startY:1,charWidth:6,charHeight:6,spaceWidth:6,margin:0,charsPerLine:42,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.+-_#>",onlyUpperCase:!0}),window.fontSmall=b,c=BitmapFont(),c.generate({image:a,startX:1,startY:110,charWidth:8,charHeight:8,spaceWidth:8,margin:1,charsPerLine:26,lineSpacing:1,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789↑↓-#:.!©_?;()=/+<>&[]{}\\*%$'\"`°,",onlyUpperCase:!0}),c.generateColor("green","rgba(80, 140, 0,0.9)"),c.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontMed=c,d=BitmapFont(),d.generate({image:a,startX:1,startY:10,charWidth:11,charHeight:11,spaceWidth:11,margin:1,charsPerLine:20,onlyUpperCase:!0}),window.fontBig=d,e=BitmapFont(),e.generate({image:a,startX:1,startY:145,charHeight:12,spaceWidth:4,margin:1,charsPerLine:[26,26,40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890#©_-&\"'()!.,?+=*$/\\;:[]{}",charWidth:"888888883888998888888899987777757735739777757578987777777777778868864553348767888435555",onlyUpperCase:!1,debug:!0}),window.fontFT=e,f=BitmapFont(),f.generate({image:a,startX:1,startY:184,charHeight:10,spaceWidth:5,margin:0,charsPerLine:[26,26,10],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",charWidth:"6666556625656666666666666655555455245365555454566555",onlyUpperCase:!1}),window.fontCondensed=f;var g=BitmapFont();g.generate({image:a,startX:2,startY:208,charHeight:8,charWidth:4,spaceWidth:4,margin:0,charsPerLine:[45],lineSpacing:0,chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_.-#+><↑↓",onlyUpperCase:!0}),g.generateColor("green","rgba(80, 140, 0,0.9)"),g.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontSuperCondensed=g;var h=BitmapFont();h.generate({image:a,startX:107,startY:68,charWidth:8,charHeight:13,spaceWidth:8,margin:0,charsPerLine:20,chars:" 0123456789-"}),window.fontLed=h;var i=BitmapFont();i.generate({image:a,startX:9,startY:82,charWidth:14,charHeight:22,spaceWidth:8,margin:0,charsPerLine:11,chars:" 0123456789"}),window.fontLedBig=i;var j=BitmapFont();j.generate({image:a,startX:1,startY:216,charHeight:9,spaceWidth:5,margin:0,charsPerLine:[40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890():-",charWidth:"7777667736768777877778887746666666664434",onlyUpperCase:!0}),window.fontDark=j,UI.Assets.init(),UI.mainPanel=UI.MainPanel(),l.push(UI.mainPanel),Input.init()},C=function(a){var b=!0;if(Tracker.isPlaying()){var c=Tracker.getStateAtTime(Audio.context.currentTime+.01);c&&(c.patternPos!=z.patternPos&&(Tracker.setCurrentPatternPos(c.patternPos),z.patternPos=c.patternPos),c.songPos!=z.songPos&&(Tracker.setCurrentSongPosition(c.songPos),z.songPos=c.songPos))}o&&(p++,b=p>o);var d=Audio.context?Audio.context.currentTime:0;if(b){r=(performance||Date).now();var e=1e3/(r-s);w.push(e),w.length>20&&w.shift(),e>60&&(b=!1)}b&&(p=0,s=r,EventBus.trigger(EVENT.screenRefresh),n&&(l.forEach(function(a){a.needsRendering&&a.render()}),EventBus.trigger(EVENT.screenRender),g&&(g.render(),n=!1))),d&&(q=q||d,t++,d>q+1&&(h=t/(d-q),u=Math.min(u,h),q=d,t=0,v.push(h),v.length>20&&v.shift(),!y&&v.length>5&&(Logger.info("fps"),y=!0),EventBus.trigger(EVENT.second))),window.requestAnimationFrame(C)};return k.setModalElement=function(a){g=a},k.getModalElement=function(){return g},k.removeModalElement=function(){g=void 0,UI.mainPanel.refresh(),n=!0,window.requestAnimationFrame(C)},k.setSelection=function(a){i=a,j=i},k.getSelection=function(){return i},k.clearSelection=function(){if(i){i(SELECTION.RESET)&&(i=void 0)}},k.copySelection=function(a){i&&(i(SELECTION.COPY),a&&i(SELECTION.RESET)),i=void 0},k.cutSelection=function(a){i&&(i(SELECTION.CUT),a&&i(SELECTION.RESET)),i=void 0},k.pasteSelection=function(a){!i&&j&&(i=j)(SELECTION.POSITION),i&&(i(SELECTION.PASTE),a&&i(SELECTION.RESET)),i=void 0},k.showContextMenu=function(a){EventBus.trigger(EVENT.showContextMenu,a)},k.hideContextMenu=function(){EventBus.trigger(EVENT.hideContextMenu)},k.getChildren=function(){return l},k.getEventElement=function(a,b){for(var c=void 0,d=0,e=l.length;d<e;d++){var f=l[d];if(f.isVisible()&&f.containsPoint(a,b)){c=f;break}}return c&&c.children&&c.children.length&&(c=c.getElementAtPoint(a,b)),c},k.getInternalPoint=function(a,b,c){for(var d={left:0,top:0};c.parent;)d.left+=c.left,d.top+=c.top,c=c.parent;return{x:a-d.left,y:b-d.top}},k.setLoading=function(){k.setStatus("Loading",!0),EventBus.trigger(EVENT.songLoading)},k.setStatus=function(a,b){EventBus.trigger(EVENT.statusChange,{status:a,showSpinner:!!b})},k.setInfo=function(a,b,c){EventBus.trigger(EVENT.statusChange,{info:a,source:b,url:c})},k.stats=function(){return{fps:h,minFps:u,averageFps:a(v),averageRenderFps:a(w),fpsList:v,skipRenderSteps:o}},k.children=l,k.getAverageFps=function(){return v.length>2?a(v):60},k.resetAverageFps=function(){var a=v.pop();v=a?[a]:[]},k.skipFrame=function(a){o=a,SETTINGS.skipFrame=a,EventBus.trigger(EVENT.skipFrameChanged,o)},k.getSkipFrame=function(){return o},EventBus.on(EVENT.clockEventExpired,function(){var a=(new Date).getTime();a-x>2e3&&(Logger.warn("throttling back"),o<4?k.skipFrame(o+1):Logger.warn("Browser can't keep up"),x=a)}),k}();UI.app_sidebar=function(){function a(a){var b=k[a];b&&(j.setSelectedIndex(a),l=a,m=!0,Tracker.autoPlay=!0,Tracker.load(b.url))}function b(){m&&(l++,l>=k.length&&(l=0),Tracker.stop(),a(l))}var c=UI.panel(0,0,200,200);c.setProperties({name:"sideBar"});var d=UI.scale9Panel(0,0,c.width,c.height,{img:Y.getImage("background"),left:3,top:3,right:4,bottom:4});d.ignoreEvents=!0,c.addChild(d);var e=UI.label();e.setProperties({label:"Playlist:",font:fontFT}),c.addChild(e);var f=UI.Assets.generate("buttonKey");c.addChild(f),f.onClick=function(){App.doCommand(COMMAND.toggleAppSideBar)};var g=UI.Assets.generate("buttonKey");g.setLabel("Next"),g.onClick=function(){b()};var h=UI.Assets.generate("buttonKey");h.setLabel("Toggle UI"),h.onClick=function(){};var i=UI.scale9Panel(0,0,c.width,c.height,{img:Y.getImage("background"),left:3,top:3,right:4,bottom:4});i.ignoreEvents=!0,c.addChild(i),c.addChild(g),c.addChild(h);var j=UI.listbox(2,50,100,100);j.setProperties({font:window.fontFT}),c.addChild(j);var k=[{label:"Demomusic",url:"demomods/demomusic.mod"},{label:"Stardust Memories",url:"demomods/StardustMemories.mod"},{label:"Space Debry",url:"demomods/spacedeb.mod"}],l=0,m=!1;j.onChange=function(a){},j.onClick=function(){var b=j.getItemAtPosition(j.eventX,j.eventY);b&&b.url&&a(b.index)},c.onResize=function(){d.setSize(c.width,c.height),f.setPosition(c.width-22,2),e.setSize(c.width,Layout.trackControlHeight),i.setPosition(2,32),i.setSize(c.width-4,54),g.setPosition(8,36),g.setProperties({width:c.width<50?20:100}),g.setLabel(c.width<50?">":"Next"),h.setPosition(8,56),h.setProperties({width:c.width<50?20:100}),h.setLabel(c.width<50?"-":"Toggle UI");j.setProperties({left:2,top:88,width:c.width-4,height:c.height-88-Layout.defaultMargin}),c.width<50?(e.hide(),i.hide(),j.hide(),g.setPosition(2,36)):(e.show(),i.show(),j.show())},EventBus.on(EVENT.songEnd,function(){b()}),c.onResize();return FetchService.get("demomods/Playlist/list.txt",function(a){a=a.split("\n"),a.forEach(function(a){a&&k.push({label:a,url:"demomods/Playlist/"+a})}),k.forEach(function(a,b){a.index=b}),l=0,m=!1,j.setItems(k)}),c},UI.buttonGroup=function(a,b){var c=UI.panel();c.hide();var d=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);d.ignoreEvents=!0,c.addChild(d),c.addChild(UI.label({label:a,font:fontSmall,width:60,top:1}));var e=[];return b.forEach(function(a){if("number"===a.type){var b=UI.numberDisplay();b.setValue(a.value)}else b=UI.Assets.generate("buttonLight"),b.setLabel(a.label),b.onClick=a.onClick;b.widthParam=a.width||100,c.addChild(b),e.push(b),a.onSamplePropertyChange&&EventBus.on(EVENT.samplePropertyChange,function(c){a.onSamplePropertyChange(b,c)})}),c.onResize=function(){d.setSize(c.width,18);var a=20,b=(c.height-a-2)/4,f=c.width,g=0;e.forEach(function(c,d){c.setProperties({width:Math.floor(f*c.widthParam/100),height:b,left:Math.floor(g*f/100),top:a}),(g+=c.widthParam)>95&&(g=0,a+=b)})},c},UI.pattern_sidebar=function(){var a=UI.panel();a.setProperties({name:"sideButtonPanel"});var b=UI.label();b.setProperties({label:"DEMOSONGS:",font:fontFT}),a.addChild(b);for(var c=[],d=[{label:"Demomusic",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/demomusic.mod")}},{label:"Stardust",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/StardustMemories.mod")}},{label:"Space Debris",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/spacedeb.mod")}},{label:"Tinytune",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/Tinytune.mod")}},{label:"Lotus 2",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/lotus20.mod")}},{label:"Professionaltracker",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/hoffman_and_daytripper_-_professional_tracker.mod")}},{label:"XM: Ambrozia",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/Ambrozia.xm")}},{label:"8CHN: AceMan",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/AceMan.mod")}},{label:"Random MOD",onClick:function(){App.doCommand(COMMAND.randomSong)}},{label:"Random XM",onClick:function(){App.doCommand(COMMAND.randomSongXM)}}],e=0;e<d.length;e++){var f=d[e],g=UI.button();g.info=f,g.onClick=f.onClick,c[e]=g,a.addChild(g)}var h=UI.button();return h.setProperties({label:"",textAlign:"center",background:UI.Assets.buttonLightScale9,hoverBackground:UI.Assets.buttonLightHoverScale9,image:Y.getImage("piano"),font:window.fontMed}),h.onClick=function(){App.doCommand(COMMAND.togglePiano)},a.addChild(h),a.onResize=function(){b.setSize(a.width,Layout.trackControlHeight);for(h.setProperties({left:0,top:a.height-30,width:a.width,height:30}),e=0;e<d.length;e++){var f=c[e],g=30*e+b.height,i=0;g>h.top-30&&(i=-500),f.setProperties({left:i,top:g,width:a.width,height:30,label:f.info.label,textAlign:"left",background:UI.Assets.buttonLightScale9,hoverBackground:UI.Assets.buttonLightHoverScale9,font:window.fontFT})}},a.onResize(),a},UI.app_patternView=function(a,b,c,d){function e(a,b,c){if(Tracker.inFTMode())var d="i"+a.index+"."+q.charWidth;else d="p"+a.period+"."+q.charWidth;if(!C[d]){var e=document.createElement("canvas");e.height=y,e.width=3*q.charWidth+2;var f=e.getContext("2d");if(Tracker.inFTMode())if(a.index){var g=FTNotes[a.index];97===a.index&&(g=FTNotes[NOTEOFF]);var h=g?g.name:"???"}else{h="---";var i=FTPeriods[a.period];i&&(g=FTNotes[i])&&(h=g.name)}else i=periodNoteTable[a.period],h=i?i.name:"---";q.write(f,h,0,0,0),C[d]=e}v.ctx.drawImage(C[d],b,c)}function f(a,b,c){b+=3*q.charWidth+4;var d="n"+a.instrument+"."+(r?a.volumeEffect:"")+"."+a.effect+"."+a.param+"."+q.charWidth;if(!D[d]){var e=document.createElement("canvas");e.height=y,e.width=7*q.charWidth+10;var f=e.getContext("2d"),g=j(a.instrument,2,"0");"00"==g&&(g="..");var h=0;if(q.write(f,g,h,0,0,"green"),r){h+=2*q.charWidth+4;var i=a.volumeEffect||0;if(i&&(i-=16),i<80)g=j(i,2,"0");else{var l=(i>>4).toString(16).toUpperCase(),m=(15&i).toString(16).toUpperCase();l={5:"-",6:"+",7:"↓",8:"↑",9:"S",A:"V",B:"P",C:"<",D:">",E:"M"}[l]||l,g=l+m}a.volumeEffect||(g=".."),q.write(f,g,h,0,0)}h+=2*q.charWidth+4,g=a.effect>15?k(a.effect):j(a.effect),g+=j(a.param,2,"0"),"000"===g&&(g="..."),q.write(f,g,h,0,0,"orange"),D[d]=e}v.ctx.drawImage(D[d],b,c)}function g(a,b,c,d,e){if(Tracker.isPlaying()&&a&&a.period&&Q[d]!==e){var f=100;if(12===a.effect)f=100*a.param/64;else{var g=Tracker.getInstrument(a.instrument);g&&(f=100*g.sample.volume/64)}P[d]=f,Q[d]=e}if(P[d]){s=!0;var h=P[d]*S/100,i=100*h/S;if("colour"===SETTINGS.vubars){v.ctx.drawImage(Y.getImage("vubar"),0,100-i,26,i,b,c-h,10,h)}else"trans"===SETTINGS.vubars&&(v.ctx.fillStyle="rgba(120,190,255,0.3)",v.ctx.fillRect(b,c-h,10,h));P[d]-=R,P[d]<0&&(P[d]=0)}}function h(a,b,c){var d=""+a;a<10&&(d="0"+d);var e=d+"."+q.charWidth;if(!E[e]){var f=document.createElement("canvas");f.height=y,f.width=3*q.charWidth;var g=f.getContext("2d"),h=!1;a%4==0&&(h="orange"),q.write(g,d,0,0,0,h),E[e]=f}v.ctx.drawImage(E[e],b,c)}function i(a,b,c,d){q.write(v.ctx,a,b,c,0,d)}function j(a,b,c){if(d=a.toString(16).toUpperCase(),b&&d.length<b)for(c=c||"0";d.length<b;)d=c+d;return d}function k(a,b,c){if(d=a.toString(36).toUpperCase(),b&&d.length<b)for(c=c||"0";d.length<b;)d=c+d;return d}function l(){var a=Tracker.getCurrentPatternPos()||0;if(w){var b=1,c=v.height-2,d=c;A=0,p>1&&(d=Math.floor(w/p*c),d<12&&(d=12),A=(c-d)/(p-1)),a&&A&&(b=Math.floor(1+A*a)),J.setProperties({left:v.width-16,top:b,width:16,height:d})}}function m(){var a=v.width,b=Math.floor(a/Tracker.getTrackCount()*x),c=(a-b)/(Tracker.getTrackCount()-x),d=v.height-20;x>=Tracker.getTrackCount()&&(d=-200),K.setProperties({top:d,width:b,left:0+Math.floor(B*c)})}function n(){G={start:[F.start[0],F.start[1]],end:[F.end[0],F.end[1]]};for(var a=0;a<2;a++)F.start[a]>F.end[a]&&(G.start[a]=F.end[a],G.end[a]=F.start[a])}function o(a){I?(F.end=[Tracker.getCurrentPatternPos(),Editor.getCurrentTrack()],n(),v.refresh()):(F.start=[a.prev||0,Editor.getCurrentTrack()],F.end=[a.current,Editor.getCurrentTrack()],F.top=F.left=1e5,n(),I=!0,v.showSelectionUI(),v.refresh())}var p,q,r,s,t,u,v=UI.panel(a,b,c,d),w=0,x=8,y=13,z=0,A=0,B=0,C={},D={},E={},F={},G={},H=[],I=!1,J=UI.scale9Panel(c-28,18,16,d-3,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});J.onDragStart=function(){Tracker.isPlaying()||(J.startDragIndex=Tracker.getCurrentPatternPos())},J.onDrag=function(a){if(!Tracker.isPlaying()&&w&&A){var b=a.deltaY,c=Math.floor(J.startDragIndex+b/A);c=Math.min(c,p-1),c=Math.max(c,0),Tracker.setCurrentPatternPos(c)}},v.addChild(J),l();var K=UI.scale9Panel(c-28,18,16,16,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});K.onDragStart=function(){K.startDragIndex=B},K.onDrag=function(a){var b=Tracker.getTrackCount()-x,c=a.deltaX,d=v.width-K.width;v.setHorizontalScroll(K.startDragIndex+Math.floor(c/(d/b))),v.onResize()},v.addChild(K);for(var L=[],M=0,N=Tracker.getTrackCount();M<N;M++){var O=UI.fxPanel(M);L.push(O),v.addChild(O)}var P=[],Q=[],R=5,S=70;return v.setHorizontalScroll=function(a){var b=Tracker.getTrackCount()-x;a!=B&&a>=0&&a<=b&&(B=a,EventBus.trigger(EVENT.patternHorizontalScrollChange,B),m())},v.onResize=function(){t=Layout.firstTrackOffsetLeft,u=Layout.trackMargin,x=Layout.visibleTracks;var a=v.height;x<Tracker.getTrackCount()&&(a-=24);for(var b=0;b<x;b++){if((O=L[B+b])&&O.visible){O.setPosition(t+b*(Layout.trackWidth+u),0),O.setSize(Layout.trackWidth,a),O.setLayout(),O.show()}}},v.render=function(){if(v.isVisible()){if(this.needsRendering){v.clearCanvas();var a=Tracker.getCurrentPattern()||0,b=Tracker.getCurrentPatternPos()||0,c=Tracker.getSong();if(!c)return;q=Layout.trackFont,p=Tracker.getPatternLength();var d=x<Tracker.getTrackCount(),j=v.height-30;r=Tracker.inFTMode();var k=r?92:72,n=9,o=28;Layout.useCondensedTrackFont&&(k=r?46:36,n=5,o=15);var A=10,C=Math.floor((Layout.trackWidth-k)/2)+A,D=!1;t&&(A=0,C=0,D=!0),d&&(j-=24),w=Math.ceil(j/y),w%2==0&&w--;var E=Math.floor(w/2),H=b-E,M=H+w,N=y+2;z=Math.floor((j+N)/2);var O=z-E*y+4,Q=z,T=z+N,U=cachedAssets.darkPanel;if(!U&&Y.getImage("panel_dark")){cachedAssets.darkPanel=UI.scale9Panel(0,0,Layout.trackWidth,Q,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2}).render(!0),U=cachedAssets.darkPanel}var V=[];s=!1,S>Q&&(S=Q,R=S/10);for(var W=0;W<x;W++){var X=B+W;if(V[X]=!(L[X]&&L[X].visible)){var Z=t+W*(Layout.trackWidth+u);v.ctx.drawImage(U,Z,0,Layout.trackWidth,Q),v.ctx.drawImage(U,Z,T,Layout.trackWidth,Q),L[X]&&(L[X].left=Z)}}var $=c.patterns[a];if($){v.ctx.fillStyle=Tracker.isRecording()?"#A50B0F":"#202E58",v.ctx.fillRect(0,z,v.width-0,N);var _,aa=Editor.getCurrentTrackPosition(),ba=n;D?(Z=t+(Editor.getCurrentTrack()-B)*(Layout.trackWidth+u),_=Z+Math.floor((Layout.trackWidth-k)/2)+aa*ba-1):_=t+C+(Editor.getCurrentTrack()-B)*Layout.trackWidth+aa*ba-1,aa>0?(_+=2*ba+1,aa>2&&(_+=2),aa>4&&r&&(_+=2)):ba=o,v.ctx.fillStyle="rgba(220,220,220,.3)",v.ctx.fillRect(_,z,ba,y+2),v.ctx.fillStyle="rgba(200,150,70,.3)";var ca=8*q.charWidth+14;r&&(ca+=2*q.charWidth+2);for(var W=H;W<M;W++)if(W>=0&&W<Tracker.getPatternLength()){var da=$[W],ea=O+(W-H)*y,fa=!0;ea<z&&(ea-=3,fa=!1),ea>z+y&&(ea+=3,fa=!1),h(W,A,ea),fa&&(h(W,A,ea),h(W,A,ea));for(var ga=0;ga<x;ga++)if(X=ga+B,V[X]&&X<Tracker.getTrackCount()){var ha,ia=da[X]||Note();D?(Z=t+ga*(Layout.trackWidth+u),ha=Z+(Layout.trackWidth-k>>1)):ha=t+C+ga*Layout.trackWidth,I&&W>=G.start[0]&&W<=G.end[0]&&X>=G.start[1]&&X<=G.end[1]&&(F.top=Math.min(F.top,ea-2),F.left=Math.min(F.left,ha-2),v.ctx.fillRect(ha-2,ea-2,ca,y)),fa&&(e(ia,ha,ea),e(ia,ha,ea),(Tracker.isPlaying()||P[ga]&&"none"!==SETTINGS.vubars)&&g(ia,ha-12,z,ga,a+"."+b)),e(ia,ha,ea),f(ia,ha,ea)}s&&setTimeout(function(){v.refresh()},20)}}for(var ga=0;ga<x;ga++)X=ga+B,V[X]||L[X].render();for(l(),J.render(),d&&(m(),K.render()),ga=0;ga<x;ga++)X=ga+B,V[X]&&(Z=t+ga*(Layout.trackWidth+u)+2,i(""+(X+1),Z,2))}this.needsRendering=!1,v.parentCtx.drawImage(v.canvas,v.left,v.top,v.width,v.height)}},v.onMouseWheel=function(a){if(!Tracker.isPlaying()){var b=Tracker.getCurrentPatternPos();a.mouseWheels[0]>0?b&&Tracker.moveCurrentPatternPos(-1):b<p-1&&Tracker.moveCurrentPatternPos(1)}},v.onDragStart=function(a){if(K.startDragIndex=B,!Tracker.isPlaying()&&(v.startDragPos=Tracker.getCurrentPatternPos(),a.isMeta||Tracker.isRecording())){var b=Math.floor((a.x-Layout.firstTrackOffsetLeft)/(Layout.trackWidth+Layout.trackMargin));Editor.setCurrentCursorPosition((B+b)*Editor.getStepsPerTrack()),UI.clearSelection(),v.startDragTrackX=b*(Layout.trackWidth+Layout.trackMargin)+Layout.firstTrackOffsetLeft;var c=Math.floor((a.y-z)/y);F.start=[Tracker.getCurrentPatternPos()+c,Editor.getCurrentTrack()],F.end=F.start,F.top=F.left=1e5,v.refresh()}},v.onDrag=function(a){if(x<Tracker.getTrackCount()&&!a.isMeta&&!Tracker.isRecording()){var b=Tracker.getTrackCount()-x,c=a.deltaX,d=v.width-K.width;v.setHorizontalScroll(K.startDragIndex-Math.floor(c/(d/b)))}if(!Tracker.isPlaying()){c=Math.round(a.deltaY/y);var e=v.startDragPos-c;if(e=Math.max(e,0),e=Math.min(e,p-1),a.isMeta||Tracker.isRecording()){I=!0,c=Math.floor(a.deltaY/y);var f=Math.floor(a.deltaX/Layout.trackWidth);F.end=[F.start[0]+c,Editor.getCurrentTrack()+f],n(),v.refresh()}else Tracker.setCurrentPatternPos(e)}},v.onTouchUp=function(){I&&v.showSelectionUI()},v.onClick=function(a){Editor.setCurrentCursorPosition((B+Math.floor((a.x-Layout.firstTrackOffsetLeft)/(Layout.trackWidth+Layout.trackMargin)))*Editor.getStepsPerTrack())},v.getStartTrack=function(){return B},v.processSelection=function(a){if(v.isVisible())switch(a){case SELECTION.RESET:return I=!1,UI.hideContextMenu(),v.refresh(),!0;case SELECTION.CLEAR:var b=Tracker.getCurrentPatternData();if(b&&I)for(var c=G.start[0];c<=G.end[0];c++)for(var d=b[c],e=G.start[1];e<=G.end[1];e++){var f=d[e];f&&f.clear()}v.refresh();break;case SELECTION.COPY:case SELECTION.CUT:H=[];var b=Tracker.getCurrentPatternData();if(b&&I)for(var c=G.start[0];c<=G.end[0];c++){var d=b[c];if(d){for(var g=[],e=G.start[1];e<=G.end[1];e++){var f=d[e];f&&g.push(f.duplicate())}H.push(g)}}if(a===SELECTION.CUT&&I)for(var c=G.start[0];c<=G.end[0];c++){var d=b[c];if(d)for(var e=G.start[1];e<=G.end[1];e++){var f=d[e];f&&f.clear()}}v.refresh();break;case SELECTION.PASTE:var b=Tracker.getCurrentPatternData();if(b&&I&&H.length)for(var c=0;c<H.length;c++){var d=b[G.start[0]+c],g=H[c];if(d)for(var e=0;e<g.length;e++){var f=d[G.start[1]+e];f&&f.populate(g[e])}}v.refresh();break;case SELECTION.POSITION:F.start=F.end=[Tracker.getCurrentPatternPos(),Editor.getCurrentTrack()],n(),I=!0,v.refresh()}},v.showSelectionUI=function(){UI.setSelection(v.processSelection),UI.showContextMenu({name:"patternActions",items:[{label:"Clear",onClick:function(){v.processSelection(SELECTION.CLEAR)}},{label:"Cut",onClick:function(){v.processSelection(SELECTION.CUT)}},{label:"Copy",onClick:function(){v.processSelection(SELECTION.COPY)}},{label:"Paste",onClick:function(){v.processSelection(SELECTION.PASTE)}}],x:F.left+v.left+v.parent.left,y:F.top+v.top+v.parent.top})},EventBus.on(EVENT.patternPosChange,function(a){!Input.isMetaKeyDown()||Tracker.isRecording()||Tracker.isPlaying()||o(a)}),EventBus.on(EVENT.cursorPositionChange,function(a){!Input.isMetaKeyDown()||Tracker.isRecording()||Tracker.isPlaying()||o({current:Tracker.getCurrentPatternPos(),prev:Tracker.getCurrentPatternPos()})}),EventBus.on(EVENT.trackCountChange,function(a){x<a&&(x=a),B=Math.min(B,a-x),B=Math.max(B,0);for(var b=L.length,c=a;b<c;b++){var d=UI.fxPanel(b);L.push(d),v.addChild(d)}v.onResize(),v.refresh()}),EventBus.on(EVENT.songLoaded,function(){v.setHorizontalScroll(0)}),EventBus.on(EVENT.visibleTracksCountChange,function(){B=0,v.onResize(),v.refresh()}),EventBus.on(EVENT.trackerModeChanged,function(){v.refresh()}),EventBus.on(EVENT.fxPanelToggle,function(a){if(O=L[a],O.visible)O.hide();else{var b=v.height;x<Tracker.getTrackCount()&&(b-=24),O.setPosition(O.left,0),O.setSize(Layout.trackWidth,b),O.setLayout(),O.show()}v.refresh()}),EventBus.on(EVENT.skipFrameChanged,function(a){R=5*(a+1)}),EventBus.on(EVENT.commandSelectAll,function(){v.isVisible()&&(UI.clearSelection(),F.start=[0,Editor.getCurrentTrack()],F.end=[Tracker.getCurrentPatternData().length-1,Editor.getCurrentTrack()],n(),I=!0,F.top=F.left=1e5,v.showSelectionUI(),v.refresh())}),v},UI.app_songControl=function(a,b,c,d,e){var f=UI.element(a,b,c,d,e);f.type="songControl";var g=UI.radioGroup();g.setItems([{label:"song",active:!0},{label:"pattern",labels:[{width:10,label:"p"},{width:20,label:"pat"}],active:!1}]),g.onChange=function(a){Tracker.setPlayType(0==a?PLAYTYPE.song:PLAYTYPE.pattern)},f.addChild(g);var h={};h.play=UI.Assets.generate("buttonDarkGreen"),h.play.setProperties({image:Y.getImage("play_green"),hoverImage:Y.getImage("play_green_hover"),activeImage:Y.getImage("play_active_red"),activeBackground:UI.Assets.buttonDarkRedActiveScale9}),h.play.onClick=function(){h.play.toggleActive(),Tracker.isPlaying()?Tracker.stop():Tracker.getPlayType()==PLAYTYPE.song?Tracker.playSong():Tracker.playPattern()},h.play.setProperties({name:"buttonPlay"}),f.addChild(h.play),h.record=UI.Assets.generate("buttonDarkRed"),h.record.setProperties({image:Y.getImage("record"),hoverImage:Y.getImage("record_hover"),activeImage:Y.getImage("record_active")}),h.record.onClick=function(){Tracker.toggleRecord()},h.record.setProperties({name:"buttonRecord"}),f.addChild(h.record),h.song=UI.Assets.generate("buttonDark"),h.song.onClick=function(){Tracker.playSong()},h.song.setProperties({label:"Song"}),f.addChild(h.song),h.pattern=UI.Assets.generate("buttonDark"),h.pattern.onClick=function(){Tracker.playPattern()},h.pattern.setProperties({label:"Pattern"}),f.addChild(h.pattern),EventBus.on(EVENT.recordingChange,function(a){h.record.setActive(a)}),EventBus.on(EVENT.playingChange,function(a){h.play.setActive(a)}),EventBus.on(EVENT.playTypeChange,function(a){a==PLAYTYPE.song?g.setSelectedIndex(0,!0):g.setSelectedIndex(1,!0)});var i=["left","top","width","height","name","type","songPatternSelector"];return f.setProperties=function(a){i.forEach(function(b){if(void 0!==a[b])switch(b){default:f[b]=a[b]}}),f.setSize(f.width,f.height),
f.setPosition(f.left,f.top);var b=Math.floor(f.width/3);g.setProperties({left:0,width:b,top:0,height:f.height,align:"right"}),h.play.setProperties({left:b,width:b,top:0,height:f.height}),h.record.setProperties({left:2*b,width:b,top:0,height:f.height}),"big"==f.songPatternSelector&&(g.left=-500,b=Math.floor(f.width/4)+1,h.play.setProperties({left:0,width:b}),h.record.setProperties({left:b,width:b}),h.song.setProperties({left:2*b,width:b,top:0,height:f.height}),h.pattern.setProperties({left:3*b,width:b,top:0,height:f.height}))},f.render=function(a){if(a=!!a,f.needsRendering&&(f.clearCanvas(),"small"==f.songPatternSelector&&g.render(),h.play.render(),h.record.render(),"big"==f.songPatternSelector&&(h.song.render(),h.pattern.render())),f.needsRendering=!1,a)return f.canvas;f.parentCtx.drawImage(f.canvas,f.left,f.top,f.width,f.height)},f},UI.app_songPatternList=function(a){function b(a){return a=""+a,a.length<2&&(a="0"+a),a}var c=UI.panel(),d=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);c.addChild(d);var e=UI.listbox();e.setItems([{label:"01:00",data:1}]),e.onClick=function(){var a=e.getItemAtPosition(e.eventX,e.eventY);if(a){var b=a.index;a!==e.getSelectedIndex()&&e.setSelectedIndex(b)}},c.addChild(e);var f=UI.Assets.generate("button20_20");f.setLabel("↑"),f.onDown=function(){var a=e.getSelectedIndex(),b=Tracker.getSong().patternTable[a];b++,Tracker.updatePatternTable(a,b),UI.ticker.onEachTick4(function(){var a=e.getSelectedIndex(),b=Tracker.getSong().patternTable[a];b++,Tracker.updatePatternTable(a,b)},5)},f.onTouchUp=function(){UI.ticker.onEachTick4()},c.addChild(f);var g=UI.Assets.generate("button20_20");return g.setLabel("↓"),g.onDown=function(){var a=e.getSelectedIndex(),b=Tracker.getSong().patternTable[a];b>0&&b--,Tracker.updatePatternTable(a,b),UI.ticker.onEachTick4(function(){var a=e.getSelectedIndex(),b=Tracker.getSong().patternTable[a];b>0&&b--,Tracker.updatePatternTable(a,b)},5)},g.onTouchUp=function(){UI.ticker.onEachTick4()},c.addChild(g),c.onResize=function(){d.setSize(c.width,c.height),e.setProperties({left:0,top:0,width:c.width-42,height:c.height,centerSelection:!0,onChange:function(){Tracker.setCurrentSongPosition(e.getSelectedIndex(),!0)}}),g.setPosition(c.width-22,Math.floor(c.height/2)-10),f.setPosition(c.width-42,g.top)},EventBus.on(EVENT.patternTableChange,function(a){c.setPatternTable(Tracker.getSong().patternTable)}),c.setPatternTable=function(a){for(var c=[],d=0,f=Tracker.getSong().length;d<f;d++){var g=a[d];c.push({label:b(d+1)+":"+b(g),data:g,index:d})}e.setItems(c)},EventBus.on(EVENT.songLoaded,function(a){c.setPatternTable(a.patternTable)}),EventBus.on(EVENT.songPositionChange,function(a){e.setSelectedIndex(a,!0)}),c},UI.trackControl=function(a,b,c,d,e){function f(a){EventBus.trigger(EVENT.trackStateChange,{track:g.track,solo:j.solo.isActive,mute:j.mute.isActive,wasSolo:a})}var g=UI.element(a,b,c,d,e);g.type="trackControl",g.track=0;var h,i="",j={};j.solo=UI.Assets.generate("buttonDark"),j.solo.setProperties({activeImage:Y.getImage("solo.png"),activeBackground:UI.Assets.buttonDarkGreenActiveScale9}),j.solo.onClick=function(){var a=j.solo.isActive;j.solo.toggleActive(),j.mute.isActive&&j.mute.toggleActive(),f(a)},j.solo.setProperties({name:"buttonSolo",label:"S"}),g.addChild(j.solo),j.mute=UI.Assets.generate("buttonDark"),j.mute.setProperties({activeImage:Y.getImage("mute"),activeBackground:UI.Assets.buttonDarkRedActiveScale9}),j.mute.onClick=function(){j.mute.toggleActive(),j.solo.isActive&&j.solo.toggleActive(),f()},j.mute.setProperties({name:"buttonMute",label:"M"}),g.addChild(j.mute),j.fx=UI.Assets.generate("buttonDark"),j.fx.onClick=function(){j.fx.toggleActive(),EventBus.trigger(EVENT.fxPanelToggle,g.track)},j.fx.setProperties({name:"buttonFX",label:"FX"}),g.addChild(j.fx);var k=["left","top","width","height","name","type","track","solo","mute","visible"];return g.setProperties=function(a){k.forEach(function(b){if(void 0!==a[b])switch(b){case"solo":j.mute.isActive&&j.mute.setActive(!1),j.solo.setActive(a[b]),f();break;case"mute":j.solo.isActive&&j.solo.setActive(!1),j.mute.setActive(a[b]),f();break;default:g[b]=a[b]}}),g.setSize(g.width,g.height),g.setPosition(g.left,g.top);var b=Math.floor(g.width/3)+1;j.solo.setProperties({left:0,width:b,top:0,height:g.height}),j.mute.setProperties({left:b-1,width:b,top:0,height:g.height}),j.fx.setProperties({left:2*b-2,width:b,top:0,height:g.height})},g.render=function(a){if(g.isVisible()){if(a=!!a,g.needsRendering&&(g.clearCanvas(),h?h.write(g.ctx,i.toUpperCase(),6,11,0):(g.ctx.fillStyle="white",g.ctx.fillText(i,10,10)),j.solo.render(),j.mute.render(),j.fx.render()),g.needsRendering=!1,a)return g.canvas;g.parentCtx.drawImage(g.canvas,g.left,g.top,g.width,g.height)}},EventBus.on(EVENT.trackScopeClick,function(a){a===g.track&&j.mute.onClick()}),g},UI.visualiser=function(){function a(){j=[];var a=Tracker.getTrackCount(),b=d.height;Tracker.getTrackCount()>4&&(a=Math.ceil(Tracker.getTrackCount()/2),b=d.height/2);for(var c=d.width/a,e=0;e<Tracker.getTrackCount();e++){var f=e*c,g=0;e>=a&&(f=(e-a)*c,g=d.height-b),j[e]={left:Math.floor(f),top:Math.floor(g),width:Math.floor(c),height:Math.floor(b),lineLeft:Math.ceil(f+c/70),lineWidth:Math.floor(c-c/30)}}}var b,c,d=UI.panel(),e=["wave","spectrum","tracks"],f=2,g=e[f],h=[],i=[],j=[],k=256;d.ctx.fillStyle="black",d.ctx.lineWidth=2,d.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",d.init=function(){function e(){var a=Audio.context.createAnalyser();a.smoothingTimeConstant=0,a.fftSize=k,h.push(a)}if(Audio.context){b=Audio.context.createAnalyser(),b.minDecibels=-90,b.maxDecibels=-10,b.smoothingTimeConstant=.85;for(var f=0;f<Tracker.getTrackCount();f++)e();a()}c=Y.getImage("oscilloscope"),EventBus.on(EVENT.filterChainCountChange,function(b){for(var c=h.length;c<b;c++)e();a(),d.connect()}),EventBus.on(EVENT.trackStateChange,function(a){void 0!==a.track&&(i[a.track]=a.mute)}),d.needsRendering=!0},d.connect=function(a){if(Audio.context){a&&a.connect(b);for(var c=0;c<Tracker.getTrackCount();c++)Audio.filterChains[c].output().connect(h[c])}},d.nextMode=function(){f++,f>=e.length&&(f=0),g=e[f]};var l=function(){d.ctx.clearRect(0,0,d.width,d.height),d.ctx.lineWidth=2,d.ctx.strokeStyle="rgba(120, 255, 50, 0.5)";for(var a,b,e=!Audio.cutOff,f=0;f<Tracker.getTrackCount();f++){var g=h[f],l=j[f],m=i[f];if(d.ctx.drawImage(c,l.left,l.top,l.width,l.height),g){d.ctx.beginPath();var n,o=l.lineLeft,p=l.lineWidth;if(e&&!m){g.fftSize=k,a=g.fftSize,b=new Uint8Array(a),g.getByteTimeDomainData(b);for(var q=p/a,r=0;r<a;r++){n=b[r]/128*l.height/2+l.top,0===r?d.ctx.moveTo(o,n):d.ctx.lineTo(o,n),o+=q}}else n=l.height/2+l.top,d.ctx.moveTo(o,n),d.ctx.lineTo(o+p-1,n);d.ctx.stroke(),m&&(d.ctx.fillStyle="rgba(34, 49, 85, 0.5)",d.ctx.fillRect(l.left,l.top,l.width,l.height))}}ctx.drawImage(d.canvas,d.left,d.top)};return d.render=function(){Audio.context&&d.isVisible()&&l()},d.init(),d.onResize=function(){a()},EventBus.on(EVENT.screenRender,function(){d.render()}),EventBus.on(EVENT.second,function(){if(Tracker.isPlaying()){UI.getAverageFps()<32&&k>32&&(k>>=1,k=Math.max(k,32),UI.resetAverageFps())}}),d.onClick=function(a){if("tracks"===g)for(var b=0;b<Tracker.getTrackCount();b++){var c=j[b],d=a.x,e=a.y;if(d>c.left&&d<c.left+c.width&&e>c.top&&e<c.top+c.height){EventBus.trigger(EVENT.trackScopeClick,b);break}}},d},UI.vumeter=function(){function a(){m.width=n.width=i,m.height=n.height=j;var a=Math.floor(i/(k+l));o.clearRect(0,0,m.width,m.height),p.clearRect(0,0,n.width,n.height);for(var b=0;b<a;b++){var d=q,e=r;b>=a/3&&(d=s,e=t),b>=a/1.5&&(d=u,e=v),o.drawImage(d,b*(k+l),0,k,j),p.drawImage(e,b*(k+l),0,k,j)}c.ctx.fillStyle="#253352"}function b(a){for(var b=a.length,c=128,d=128,e=0;e<b;e++){var f=a[e];f<c?c=f:f>d&&(d=f)}return(d-c)/255}var c=UI.panel();c.left=400,c.top=7;var d,e,f,g,h;Audio.context&&(d=Audio.context.createAnalyser(),d.minDecibels=-90,d.maxDecibels=-10,d.smoothingTimeConstant=.85,e=Audio.context.createAnalyser(),e.minDecibels=-90,e.maxDecibels=-10,e.smoothingTimeConstant=.85,d.fftSize=32,e.fftSize=32,g=d.fftSize,h=new Uint8Array(g));var i=500,j=6,k=10,l=2,m=document.createElement("canvas"),n=document.createElement("canvas"),o=m.getContext("2d"),p=n.getContext("2d"),q=Y.getImage("vu_green"),r=Y.getImage("vu_green_active"),s=Y.getImage("vu_yellow"),t=Y.getImage("vu_yellow_active"),u=Y.getImage("vu_red"),v=Y.getImage("vu_red_active");return c.setSize(i,2*j+4),a(),c.needsRendering=!0,c.connect=function(a){if(Audio.context){var b=Audio.context.createChannelSplitter(2);a.connect(b),b.connect(d,0),b.connect(e,1),f=!0}},c.setProperties=function(b){i=b.width,c.left=b.left,c.setSize(i,2*j+4),a()},c.render=function(){if(f){d.getByteTimeDomainData(h);var a=b(h)*(Math.E-1);e.getByteTimeDomainData(h);var g=b(h)*(Math.E-1);c.ctx.fillRect(0,0,c.width,c.height),c.ctx.drawImage(m,0,0),c.ctx.drawImage(m,0,j+4);var k=Math.min(Math.floor(a*i),i),l=Math.min(Math.floor(g*i),i);k&&c.ctx.drawImage(n,0,0,k,j,0,0,k,j),l&&c.ctx.drawImage(n,0,0,l,j,0,j+4,l,j),ctx.drawImage(c.canvas,c.left,c.top)}},EventBus.on(EVENT.screenRender,function(){c.render()}),c},UI.app_controlPanel=function(){var a=UI.app_panelContainer(40),b=UI.app_songControl();a.addChild(b);var c=UI.checkboxbutton({label:"File",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"diskop_load":"topmain")}}),d=UI.checkboxbutton({label:"Options",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"options":"topmain")}}),e=UI.checkboxbutton({label:"Sample Edit",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"sample":"bottommain")}});a.addChild(c),a.addChild(d),a.addChild(e);var f={background:UI.Assets.buttonKeyScale9,hoverBackground:UI.Assets.buttonKeyHoverScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},g=UI.button(),h=UI.button();g.setProperties(f),g.setLabel("mod"),g.onDown=function(){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER)},a.addChild(g),h.setProperties(f),h.setLabel("XM"),h.onDown=function(){Tracker.setTrackerMode(TRACKERMODE.FASTTRACKER)},a.addChild(h);var i=[4,8,12,16],j=[];i.forEach(function(a){j.push(UI.button())}),j.forEach(function(b,c){b.setProperties(f),b.setLabel(""+i[c]),b.index=c,b.onDown=function(){if(!this.isDisabled){var a=this.index;j.forEach(function(b,c){b.setActive(c===a)}),Layout.setVisibleTracks(i[a])}},a.addChild(b)});var k=UI.label();k.setProperties({label:"Mode",labels:[{width:20,label:""},{width:78,label:"M"},{width:84,label:"Md"},{width:100,label:"Mode"}],font:fontSmall,width:100,height:20,textAlign:"right"}),a.addChild(k);var l=UI.label();l.setProperties({label:"Display",labels:[{width:10,label:""},{width:78,label:"t"},{width:84,label:"tr"},{width:100,label:"trck"},{width:120,label:"Display"}],font:fontSmall,width:100,height:20,textAlign:"right"}),a.addChild(l);var m=UI.spinBox();return m.setProperties({name:"Pattern",value:Tracker.getTrackCount(),max:32,min:2,size:"big",onChange:function(a){Tracker.setTrackCount(a)}}),a.addChild(m),a.onPanelResize=function(){a.innerHeight=a.height-2*Layout.defaultMargin;var f=Layout.defaultMargin,n=Layout.defaultMargin;if("2row"===Layout.controlPanelButtonLayout){var o=Math.floor((a.innerHeight-Layout.defaultMargin)/2);n=a.height-o-Layout.defaultMargin,a.innerHeight=o}b.setProperties({left:Layout.col1X,top:f,width:Layout.songControlWidth,height:a.innerHeight,songPatternSelector:"small"});var p=Layout.col1W-60;p=Math.max(p,120);var q=Math.floor((Layout.col1W-p)/2),r=Layout.col4X+q,s="Sample Edit";"1row"!==Layout.controlPanelButtonLayout&&(p=Math.floor(Layout.controlPanelButtonsWidth/3),q=0,r=Layout.controlPanelButtonsLeft+2*p,s="Sample");var t=a.innerHeight;c.setProperties({left:Layout.controlPanelButtonsLeft+1.5*q,top:n,width:p,height:t}),d.setProperties({left:c.left+p+q,top:n,width:p,height:t}),e.setProperties({left:r,top:n,width:p,height:t,label:s}),g.setProperties({left:Layout.modeButtonsLeft+(Layout.modeButtonsWidth-101),top:f,width:51,height:16}),h.setProperties({left:g.left+g.width-1,top:g.top,width:g.width,height:g.height});var u=g.left;j.forEach(function(a,b){a.setProperties({left:u,top:g.top+g.height,width:26,height:g.height}),u+=a.width-1,a.setActive(i[b]===Layout.visibleTracks),a.setDisabled(i[b]>Layout.maxVisibleTracks)}),k.setProperties({left:Layout.modeButtonsLeft,top:f+1,width:Layout.modeButtonsWidth-94,height:20}),l.setProperties({left:k.left,top:k.top+g.height,width:k.width,height:k.height}),m.setProperties({left:Layout.modeButtonsLeft,top:f,width:Layout.TrackCountSpinboxWidth,height:a.innerHeight})},a.onPanelResize(),a.renderInternal=function(){"2row"!==Layout.controlPanelButtonLayout&&(a.ctx.drawImage(Y.getImage("line_ver"),Layout.controlPanelButtonsLeft-2,0,2,a.height-1),a.ctx.drawImage(Y.getImage("line_ver"),Layout.modeButtonsLeft-2,0,2,a.height-1),"condensed"!==Layout.controlPanelButtonLayout&&(a.ctx.drawImage(Y.getImage("line_ver"),Layout.col4X-2,0,2,a.height-1),a.ctx.translate(.5,.5),a.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",a.ctx.lineWidth=1,a.ctx.beginPath(),a.ctx.moveTo(Layout.col2X+10,10),a.ctx.lineTo(Layout.col2X+10,20),a.ctx.lineTo(Layout.col4X-14,20),a.ctx.lineTo(Layout.col4X-14,10),a.ctx.moveTo(Layout.col4X+10,30),a.ctx.lineTo(Layout.col4X+10,20),a.ctx.lineTo(Layout.col5X-14,20),a.ctx.lineTo(Layout.col5X-14,30),a.ctx.stroke(),a.ctx.setTransform(1,0,0,1,0,0),c.render(),d.render(),e.render()))},EventBus.on(EVENT.showView,function(a){switch(a){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":c.setActive(!0),d.setActive(!1);break;case"options":c.setActive(!1),d.setActive(!0);break;case"topmain":c.setActive(!1),d.setActive(!1);break;case"main":c.setActive(!1),d.setActive(!1),e.setActive(!1);break;case"bottommain":e.setActive(!1);break;case"sample":e.setActive(!0)}}),EventBus.on(EVENT.trackerModeChanged,function(a){g.setActive(a===TRACKERMODE.PROTRACKER),h.setActive(a===TRACKERMODE.FASTTRACKER),Layout.setLayout()}),EventBus.on(EVENT.trackCountChange,function(a){m.setValue(a,!0)}),EventBus.on(EVENT.songLoaded,function(b){var c=b.channels;c>12&&c<16&&(c=16),c>8&&c<12&&(c=12),c>4&&c<8&&(c=8),c=Math.min(c,Layout.maxVisibleTracks),Layout.setVisibleTracks(c),a.onPanelResize()}),a};var Layout=function(){var a={};return a.defaultMargin=4,a.showAppSideBar=!1,a.setLayout=function(b,c){a.width=b||a.width,a.height=c||a.height;var d=a.width;if(a.sidebarWidth=a.showAppSideBar?200:0,d-=a.sidebarWidth,a.col1W=Math.floor((d-6*a.defaultMargin-3)/5),a.col2W=2*a.col1W+a.defaultMargin,a.col3W=3*a.col1W+2*a.defaultMargin,a.col4W=4*a.col1W+3*a.defaultMargin,a.col5W=5*a.col1W+4*a.defaultMargin,a.marginLeft=Math.floor((d-a.col5W)/2),a.marginRight=d-a.marginLeft-a.col5W,a.mainLeft=a.sidebarWidth,a.mainWidth=d,a.col1X=a.marginLeft,a.col2X=a.col1X+a.defaultMargin+a.col1W,a.col3X=a.col2X+a.defaultMargin+a.col1W,a.col4X=a.col3X+a.defaultMargin+a.col1W,a.col5X=a.col4X+a.defaultMargin+a.col1W,a.colHalfW=Math.floor(a.col1W/2),a.col31W=Math.floor((d-4*a.defaultMargin-5)/3),a.col32W=2*a.col31W+a.defaultMargin,a.col31X=a.col1X,a.col32X=a.col31X+a.defaultMargin+a.col31W,a.col33X=a.col32X+a.defaultMargin+a.col31W,a.prefered="col5",a.controlPanelHeight=40,a.controlPanelLayout="full",a.controlPanelButtonLayout="1row",a.controlPanelButtonsLeft=a.col2X,a.controlPanelButtonsWidth=a.col3W,a.modeButtonsWidth=a.col1W,a.modeButtonsLeft=a.col5X,a.songControlWidth=a.col1W,a.TrackCountSpinboxWidth=60,a.trackWidth=a.col1W,a.trackMargin=a.defaultMargin,a.visibleTracks=a.visibleTracks||4,a.infoPanelHeight=24,a.trackControlHeight=32,a.analyserHeight=66,a.pianoHeight=200,a.trackFont=fontMed,a.useCondensedTrackFont=!1,a.maxVisibleTracks=16,d<945&&(a.maxVisibleTracks=12),d<725&&(a.maxVisibleTracks=8),d<512&&(a.maxVisibleTracks=4),a.visibleTracks>a.maxVisibleTracks)return void a.setVisibleTracks(a.maxVisibleTracks);d<820&&(a.controlPanelButtonLayout="condensed",a.modeButtonsWidth=a.col1W+a.colHalfW,a.modeButtonsLeft=a.col5X-a.colHalfW,a.songControlWidth=a.modeButtonsWidth,a.controlPanelButtonsLeft=a.col2X+a.colHalfW,a.controlPanelButtonsWidth=a.col2W),d<650&&(a.controlPanelButtonLayout="2row",a.controlPanelHeight=80,a.controlPanelButtonsLeft=a.col1X,a.controlPanelButtonsWidth=a.col5W,a.controlPanelButtonsButton=Math.floor(a.controlPanelButtonsWidth/3),a.modeButtonsLeft=2*a.controlPanelButtonsButton-a.TrackCountSpinboxWidth,a.modeButtonsWidth=a.controlPanelButtonsButton+a.TrackCountSpinboxWidth+a.defaultMargin,a.songControlWidth=a.col2W+a.colHalfW+a.defaultMargin),d<620&&(a.prefered="col3"),a.height<800&&(a.pianoHeight=150),a.height<650&&(a.pianoHeight=100);var e=a.defaultMargin*(a.visibleTracks-1);a.showSideBar=a.visibleTracks<5&&d>620;var f=a.showSideBar?a.col4W:a.col5W;a.trackWidth=Math.floor((f-e)/a.visibleTracks),a.firstTrackOffsetLeft=0,a.trackWidth<125&&(a.firstTrackOffsetLeft=18,a.trackWidth=Math.floor((f-e-a.firstTrackOffsetLeft)/a.visibleTracks)),a.trackWidth<(Tracker.inFTMode()?100:78)&&(a.trackFont=fontSuperCondensed,a.useCondensedTrackFont=!0)},a.setVisibleTracks=function(b){a.visibleTracks=b,a.setLayout(),EventBus.trigger(EVENT.visibleTracksCountChange,b)},a}();UI.app_mainPanel=function(){function a(){e="patterndata",b=UI.radioGroup(),b.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0,zIndex:1}),b.setItems([{label:"About",active:!1},{label:"Song data",labels:[{width:30,label:"song"}],active:!1},{label:"Pattern data",labels:[{width:40,label:"pattern"}],active:!0},{label:"Instruments",labels:[{width:30,label:"Instr"}],active:!1}]),b.onChange=function(a){e="about",1===a&&(e="songdata"),2===a&&(e="patterndata"),3===a&&(e="instruments"),c.onPanelResize()},c.addChild(b),c.sortZIndex()}var b,c=UI.app_panelContainer(160),d="",e="",f=UI.button();f.setProperties({background:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.buttonDarkScale9,image:Y.getImage("logo_grey_70"),activeImage:Y.getImage("logo_colour_70")}),f.onDown=function(){f.toggleActive()},c.addChild(f);var g=UI.button();g.setProperties({background:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.panelInsetScale9,image:Y.getImage("tracker"),activeImage:function(){var a=Y.getImage("steffest"),b="undefined"==typeof versionNumber?"dev":versionNumber;if(b.indexOf(".")>0){var c=b.split(".");b=c[0]+"."+c[1]}b="Version "+b;var d=a.getContext("2d");return fontSmall.write(d,b,44,4),fontSmall.write(d,"By",44,13),a}()}),g.onDown=function(){g.toggleActive()},c.addChild(g);var h=UI.inputbox({name:"modName",onChange:function(a){Tracker.getSong().title=a,UI.setInfo(a)}});c.addChild(h);var i=UI.listbox();i.setItems([{label:"loading ...",data:1}]),c.addChild(i),i.onClick=function(a){Input.setFocusElement(i);var b=i.getItemAtPosition(i.eventX,i.eventY);b&&Tracker.setCurrentInstrumentIndex(b.data)};var j=UI.app_songPatternList();c.addChild(j);var k=window.fontFT,l=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);c.addChild(l);var m=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);c.addChild(m);var n=UI.spinBox();n.setProperties({name:"Pattern",label:"Pattern",labels:[{width:10,label:"Pat."},{width:140,label:"Pattern"}],value:0,max:100,min:0,font:k,onChange:function(a){Tracker.setCurrentPattern(a)}}),c.addChild(n);var o=UI.spinBox({name:"Instrument",label:"Instrument",labels:[{width:10,label:"Ins."},{width:123,label:"Instr"},{width:160,label:"Instrument"}],value:1,max:31,min:1,font:k,onChange:function(a){Tracker.setCurrentInstrumentIndex(a)}});c.addChild(o);var p=UI.spinBox({name:"SongLength",label:"Song length",labels:[{width:10,label:"Len."},{width:138,label:"Length"},{width:156,label:"Song len"},{width:178,label:"Song length"}],value:1,max:200,min:1,font:k,onChange:function(a){var b=Tracker.getSong().length;b>a?Tracker.removeFromPatternTable():b<a&&Tracker.addToPatternTable()}});c.addChild(p);var q=UI.spinBox({name:"SongRepeat",label:"Song repeat",labels:[{width:10,label:"Rep."},{width:138,label:"Repeat"},{width:156,label:"Song rep"},{width:178,label:"Song repeat"}],value:1,max:200,min:1,font:k,onChange:function(a){Tracker.getSong().restartPosition=a}});c.addChild(q);var r=UI.spinBox({name:"PatternLength",label:"Pattern length",labels:[{width:10,label:"Plen"},{width:138,label:"Pat len"},{width:166,label:"Pattern len"},{width:188,label:"Pattern length"}],value:64,max:128,min:1,font:k,onChange:function(a){Tracker.setPatternLength(a)}});c.addChild(r);var s=UI.spinBox({name:"BPMLength",label:"BPM",value:1,max:400,min:1,font:k,onChange:function(a){Tracker.setBPM(a)}});c.addChild(s);var t=UI.DiskOperations();t.setProperties({name:"diskoperations",zIndex:100}),c.addChild(t),UI.diskOperations=t;var u=UI.OptionsPanel();return u.setProperties({name:"options",zIndex:100}),c.addChild(u),c.onPanelResize=function(){var d=Layout.defaultMargin,k=20+2*d,v=50+d+d,w=c.height-50-4*d,x=28,y=Layout.col1W-2;if("col3"===Layout.prefered){b||a(),w=c.height-2*d,v=d,y=Layout.col32W-2,x=28,b.show(),b.setDimensions({left:Layout.col31X,width:Layout.col31W,top:d,height:w,visible:!0}),h.setDimensions({left:Layout.col32X,width:Layout.col32W,top:d,height:20}),i.setDimensions({left:Layout.col32X,width:Layout.col32W,top:k,height:c.height-k-2*d});var z={left:Layout.col32X,width:Layout.col32W,top:v,height:w};j.setDimensions(z),l.setDimensions(z),m.setDimensions(z),f.setDimensions({left:Layout.col32X,width:Layout.col32W,top:v,height:Math.floor(w/2)}),g.setDimensions({left:Layout.col32X,width:Layout.col32W,top:Math.floor(w/2)+1,height:Math.floor(w/2)});var A=Layout.col32X;s.setDimensions({left:A,top:l.top+3,width:y,height:x}),p.setDimensions({left:A,top:l.top+3+x,width:y,height:x}),q.setDimensions({left:A,top:l.top+3+2*x,width:y,height:x}),q.hide(),n.setDimensions({left:A,top:l.top+3+2*x,width:y,height:x}),r.setDimensions({left:A,top:l.top+3+3*x,width:y,height:x}),o.setDimensions({left:A,top:l.top+3+4*x,width:y,height:x}),f.toggle("about"===e),g.toggle("about"===e),h.toggle("instruments"===e),i.toggle("instruments"===e),j.toggle("songdata"===e),l.toggle("patterndata"===e),s.toggle("patterndata"===e),p.toggle("patterndata"===e),n.toggle("patterndata"===e),r.toggle("patterndata"===e),o.toggle("patterndata"===e),m.hide()}else b&&b.hide(),f.show(),g.show(),h.show(),i.show(),j.show(),l.show(),m.show(),s.show(),p.show(),n.show(),r.show(),o.show(),q.show(),f.setDimensions({left:Layout.col1X,top:d,width:Layout.col2W,height:50}),g.setDimensions({left:Layout.col3X,top:d,width:Layout.col1W,height:50}),h.setDimensions({left:Layout.col4X,width:Layout.col2W,top:d,height:20}),i.setDimensions({left:Layout.col4X,width:Layout.col2W,top:k,height:c.height-k-2*d}),j.setDimensions({left:Layout.col1X,width:Layout.col1W,top:v,height:w}),l.setDimensions({left:Layout.col2X,width:Layout.col1W,top:v,height:w}),m.setDimensions({left:Layout.col3X,width:Layout.col1W,top:v,height:w}),s.setDimensions({left:Layout.col2X,top:l.top+3,width:y,height:x}),p.setDimensions({left:Layout.col2X,top:l.top+3+x,width:y,height:x}),q.setDimensions({left:Layout.col2X,top:l.top+3+2*x,width:y,height:x}),n.setDimensions({left:Layout.col3X,top:l.top+3,width:y,height:x}),r.setDimensions({left:Layout.col3X,top:l.top+3+x,width:y,height:x}),o.setDimensions({left:Layout.col3X,top:l.top+3+2*x,width:y,height:x});t.setSize(c.width,c.height),u.setSize(c.width,c.height)},c.onPanelResize(),c.getCurrentView=function(){return d},EventBus.on(EVENT.songLoading,function(){h.setValue("Loading ...",!0)}),EventBus.on(EVENT.songPropertyChange,function(a){h.setValue(a.title,!0),p.setValue(a.length,!0),o.setMax(Tracker.getMaxInstruments()),q.setMax(a.length),a.restartPosition&&a.restartPosition>a.length&&(a.restartPosition=a.length),q.setValue(a.restartPosition||1)}),EventBus.on(EVENT.songBPMChange,function(a){s.setValue(a,!0)}),EventBus.on(EVENT.instrumentChange,function(a){i.setSelectedIndex(a-1),o.setValue(a,!0)}),EventBus.on(EVENT.instrumentNameChange,function(a){var b=Tracker.getInstrument(a);if(b)for(var c=i.getItems(),d=0,e=c.length;d<e;d++)if(c[d].data==a){c[d].label=a+" "+b.name,EventBus.trigger(EVENT.instrumentListChange,c);break}}),EventBus.on(EVENT.instrumentListChange,function(a){i.setItems(a)}),EventBus.on(EVENT.patternChange,function(a){n.setValue(a,!0),r.setValue(Tracker.getPatternLength(),!0)}),EventBus.on(EVENT.trackerModeChanged,function(a){r.setDisabled(a===TRACKERMODE.PROTRACKER),o.setMax(Tracker.getMaxInstruments())}),EventBus.on(EVENT.showView,function(a){switch(a){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":t.setView(a),t.show(),u.hide(),d=a,c.refresh();break;case"options":t.hide(),u.show(!0),d=a,c.refresh();break;case"topmain":case"main":t.hide(),u.hide(),d="",c.refresh()}}),c},UI.app_menu=function(a){var b=UI.app_panelContainer(32),c=UI.scale9Panel(5,0,20,26,{img:Y.getImage("menu"),left:4,top:0,right:40,bottom:0});b.addChild(c);var d=UI.menu(5,0,b.width,26,a);b.addChild(d),d.setItems([{label:"File",subItems:[{label:"New",command:COMMAND.newFile},{label:"Load Module",command:COMMAND.openFile},{label:"Save Module",command:COMMAND.saveFile},{label:"Open Random MOD Song",command:COMMAND.randomSong},{label:"Open Random XM Song",command:COMMAND.randomSongXM}]},{label:"Edit",subItems:[{label:"Cut",command:COMMAND.cut},{label:"Copy",command:COMMAND.copy},{label:"Paste",command:COMMAND.paste},{label:"Clear Track",command:COMMAND.clearTrack},{label:"Clear Pattern",command:COMMAND.clearPattern},{label:"Clear Song",command:COMMAND.clearSong},{label:"Clear Instruments",command:COMMAND.clearInstruments},{label:"Render Pattern 2 Sample",command:COMMAND.pattern2Sample}]},{label:"View",subItems:[{label:"Main",command:COMMAND.showMain},{label:"Options",command:COMMAND.showOptions},{label:"File Operations",command:COMMAND.showFileOperations},{label:"Sample Editor",command:COMMAND.showSampleEditor},{label:"Piano",command:COMMAND.togglePiano},{label:"Performance stats",command:COMMAND.showStats}]},{label:"Help",subItems:[{label:"About",command:COMMAND.showAbout},{label:"Documentation",command:COMMAND.showHelp},{label:"Sourcecode on Github",command:COMMAND.showGithub}]}]);var e=UI.vumeter();return e.connect(Audio.cutOffVolume),window.vumeter=e,b.onPanelResize=function(){var a=Math.max(Layout.col2W,250);Host.showInternalMenu||(c.hide(),a=0);var d=Layout.col5W-a,f=Layout.marginLeft+a+Layout.defaultMargin+Layout.mainLeft;b.left=Layout.mainLeft,a&&c.setDimensions({left:Layout.marginLeft,top:0,height:26,width:a}),e.setProperties({width:d,left:f})},b.onPanelResize(),b},UI.app_panelContainer=function(a){var b=UI.panel(0,0,canvas.width,a,!0),c=UI.scale9Panel(0,0,b.width,b.height,UI.Assets.panelMainScale9);return c.ignoreEvents=!0,b.addChild(c),b.onResize=function(){c.setSize(b.width,b.height),b.onPanelResize&&b.onPanelResize()},b},UI.app_patternPanel=function(){function a(){var a=m.getStartTrack(),c=Math.min(a+Layout.visibleTracks,Tracker.getTrackCount()),e=!(Layout.expandSampleViewHeight&&"sample"===g);for(b=0;b<f.length;b++)f[b].setProperties(b>=a&&b<c?{track:b,left:d+(Layout.trackWidth+Layout.trackMargin)*(b-a),top:Layout.defaultMargin+Layout.infoPanelHeight+Layout.analyserHeight,width:Layout.trackWidth,height:Layout.trackControlHeight,visible:e}:{track:b,top:-100,visible:!1})}var b,c,d,e=UI.app_panelContainer(80),f=[],g="main",h=UI.editPanel();e.addChild(h);var i=UI.InfoPanel();for(e.addChild(i),b=0;b<Tracker.getTrackCount();b++)f[b]=UI.trackControl(),e.addChild(f[b]);var j=UI.visualiser();j.connect(Audio.cutOffVolume),j.name="mainAnalyser";var k=UI.element();k.render=function(){},k.onClick=function(a){j.onClick(a)},e.addChild(k);var l=UI.pattern_sidebar();e.addChild(l);var m=UI.app_patternView();m.setProperties({name:"patternViewPanel"}),e.addChild(m);var n=UI.SampleView();return n.setProperties({name:"sampleViewPanel"}),e.addChild(n),e.onPanelResize=function(){Layout.showSideBar?"main"===g&&(l.show(),h.show()):(l.hide(),h.hide());var b=Layout.infoPanelHeight+Layout.trackControlHeight+Layout.analyserHeight+2*Layout.defaultMargin,f=e.height-b-Layout.defaultMargin;Layout.expandSampleViewHeight=f<280,Layout.expandSampleViewHeight&&"sample"===g?(j.hide(),h.hide()):(j.show(),Layout.showSideBar&&h.show()),c=Layout.showSideBar?Layout.col2X:Layout.col1X;var o=Layout.showSideBar?Layout.col4W:Layout.col5W;d=c+Layout.firstTrackOffsetLeft,h.setDimensions({left:Layout.col1X,top:Layout.defaultMargin,width:Layout.col1W,height:Layout.infoPanelHeight+Layout.analyserHeight}),i.setDimensions({left:Layout.showSideBar?Layout.col2X:Layout.col1X,top:0,width:Layout.showSideBar?Layout.col4W:Layout.col5W,height:Layout.infoPanelHeight}),m.setDimensions({left:c,top:b,width:o,height:f}),l.setDimensions({left:Layout.col1X,top:m.top-Layout.trackControlHeight,width:Layout.col1W,height:f+Layout.trackControlHeight}),j.setProperties({left:d+Layout.mainLeft,top:e.top+Layout.infoPanelHeight+3,width:o-Layout.firstTrackOffsetLeft,height:Layout.analyserHeight}),k.setDimensions({left:j.left-Layout.mainLeft,top:Layout.infoPanelHeight+3,width:j.width,height:j.height}),n.setProperties({left:0,top:Layout.expandSampleViewHeight?Layout.infoPanelHeight:b,width:e.width,height:Layout.expandSampleViewHeight?e.height-Layout.infoPanelHeight-Layout.defaultMargin-3:f}),a()},e.onPanelResize(),EventBus.on(EVENT.patternChange,function(){m.refresh()}),EventBus.on(EVENT.patternPosChange,function(){m.refresh()}),EventBus.on(EVENT.cursorPositionChange,function(){m.refresh()}),EventBus.on(EVENT.recordingChange,function(){m.refresh()}),EventBus.on(EVENT.trackStateChange,function(a){if(void 0!==a.track)if(a.solo)for(b=0;b<Tracker.getTrackCount();b++)b!=a.track&&f[b].setProperties({mute:!0});else if(a.wasSolo)for(b=0;b<Tracker.getTrackCount();b++)b!=a.track&&f[b].setProperties({mute:!1})}),EventBus.on(EVENT.trackCountChange,function(c){for(e.visibleTracks=Math.min(4,c),b=f.length;b<c;b++)f[b]=UI.trackControl(),f[b].setProperties({track:b,top:-200}),e.addChild(f[b]);a(),e.refresh()}),EventBus.on(EVENT.patternHorizontalScrollChange,function(){a()}),EventBus.on(EVENT.showView,function(a){switch(a){case"sample":n.show(),m.hide(),l.hide(),Layout.expandSampleViewHeight&&(j.hide(),h.hide()),g=a,e.onPanelResize(),e.refresh();break;case"bottommain":case"main":n.hide(),m.show(),j.show(),Layout.showSideBar&&(l.show(),h.show()),g="main",e.onPanelResize(),e.refresh()}}),EventBus.on(EVENT.visibleTracksCountChange,function(a){Layout.showSideBar?"main"===g&&(l.show(),h.show()):(l.hide(),h.hide()),e.onResize()}),e},UI.app_pianoView=function(){var a=UI.app_panelContainer(200);a.name="pianoViewPanel";var b,c,d=[],e=[0,2,4,5,7,9,11],f=[-1,1,0,3,0,-1,0,6,0,8,0,10,0,-1],g=Y.getImage("pianokey_white"),h=Y.getImage("pianokey_white_down"),i=Y.getImage("pianokey_black"),j=Y.getImage("pianokey_black_down"),k=0,l=3,m=1,n=UI.Assets.generate("button20_20");n.setLabel("x"),n.onClick=function(){App.doCommand(COMMAND.togglePiano)},a.addChild(n);var o=UI.spinBox();o.setProperties({name:"Octave",label:"Octave",value:1,max:l,min:m,left:4,top:2,height:28,width:150,font:window.fontMed,onChange:function(a){Input.setCurrentOctave(a)}}),a.addChild(o),a.onShow=function(){a.onPanelResize()},a.onPanelResize=function(){a.innerHeight=a.height-2*Layout.defaultMargin,n.setProperties({top:4,left:a.width-24})},a.onPanelResize(),EventBus.on(EVENT.pianoNoteOn,function(b){a.isVisible()&&(d[b]=!0,a.refresh())}),EventBus.on(EVENT.pianoNoteOff,function(b){a.isVisible()&&(d[b]=!1,a.refresh())});var p=function(a,b){var c=-1,d=a%420,g=Math.floor(a/420);if(b>=0)if(b>k+30){var h=Math.floor(d/60);c=e[h]+12*g}else{var i=Math.floor((d-15)/30);i<0&&(i=0),i>12&&(i=12),i%2==0?(h=i/2,c=e[h]):(c=f[i])<0&&(h=Math.floor(d/60),c=e[h]),c+=12*g}return c+1};return a.onDown=function(a){var d=a.x,e=a.y,f=p(d,e);f&&f!==b&&(Input.handleNoteOn(f+12*c),b&&Input.handleNoteOff(b+12*c),b=f)},a.onTouchUp=function(a){var d=a.x,e=a.y,f=p(d,e);f||(f=b),f&&(Input.handleNoteOff(f+12*c),b=void 0),b&&Input.handleNoteOff(b+12*c),b=void 0},a.onDrag=function(a){var d=a.x,e=a.y,f=p(d,e)
;f&&f!==b&&(Input.handleNoteOn(f+12*c),b&&Input.handleNoteOff(b+12*c),b=f)},a.renderInternal=function(b){if(a.isVisible()){if(b=!!b,this.needsRendering){for(var l=a.height-30,m=0,n=0;m<a.width;){var o=Math.floor(n/7),p=n%7,q=12*(c+o)+e[p]+1;a.ctx.drawImage(d[q]?h:g,m,30,64,l),n++,m+=60}k=Math.floor(l/1.7);var r=38;n=0;for(var s=0;r<a.width;){if(o=Math.floor(n/7),2!==(p=n%7)&&6!==p){q=12*(c+o)+f[2*p+1]+1;a.ctx.drawImage(d[q]?j:i,r,30,48,k),s++}n++,r+=60}}if(this.needsRendering=!1,b)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}},EventBus.on(EVENT.octaveChanged,function(a){c=a,o.setValue(c,!0)}),EventBus.on(EVENT.trackerModeChanged,function(a){l=Tracker.inFTMode()?7:3,m=Tracker.inFTMode()?0:1,o.setMax(l,!0),o.setMin(m,!0)}),a},UI.Assets=function(){var a={},b={};a.preLoad=function(a){function b(a){return a=e+a,f&&(a+="?v="+App.buildNumber),a}var c,d,e=Host.getBaseUrl(),f=Host.useUrlParams,g=function(){c&&d&&(c.forEach(function(a){a.img=d,Y.sprites[a.name]=Y.sprite(a)}),a&&a())};FetchService.json(b("skin/spritemap_v2.json"),function(a){c=a,g()}),Y.loadImage(b("skin/spritesheet_v2.png"),function(a){d=a,g()})},a.buttonLightScale9={left:2,top:2,right:4,bottom:4},a.buttonLightHoverScale9={left:2,top:2,right:4,bottom:4},a.buttonDarkScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkBlueScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkRedScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkRedHoverScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkGreenScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkActiveBlueScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkGreenHoverScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkGreenActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkRedActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkBlueActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkYellowActiveScale9={left:5,top:5,right:5,bottom:5},a.panelMainScale9={left:2,top:2,right:3,bottom:3},a.panelDarkScale9={left:3,top:3,right:3,bottom:2},a.panelDarkHoverScale9={left:3,top:3,right:3,bottom:2},a.panelDarkGreyScale9={left:3,top:3,right:3,bottom:2},a.panelDarkGreyBlueScale9={left:3,top:3,right:3,bottom:2},a.panelTransScale9={left:3,top:3,right:3,bottom:2},a.panelInsetScale9={left:2,top:2,right:2,bottom:2},a.panelDarkInsetScale9={left:2,top:2,right:2,bottom:2},a.buttonKeyScale9={left:5,top:5,right:5,bottom:5},a.buttonKeyHoverScale9={left:5,top:5,right:5,bottom:5},a.buttonKeyActiveScale9={left:5,top:5,right:5,bottom:5};var c={button20_20:{generate:function(c){var d,e=a.panelDarkScale9;if(d=UI.button(0,0,20,20),d.setProperties({background:e,hoverBackground:a.panelDarkHoverScale9,textAlign:"center",font:window.fontMed,paddingTop:2}),!c)return d;b.buttonUp20_20=d}},button30_30:{generate:function(c){var d;if(d=UI.scale9Panel(0,0,30,30,a.buttonLightScale9),!c)return d;b.buttonUp30_30=d}},buttonLight:{generate:function(c){var d,e=a.buttonLightScale9;if(d=UI.button(),d.setProperties({background:e,hoverBackground:a.buttonLightHoverScale9,textAlign:"center",font:window.fontMed}),!c)return d;b.buttonLight=d}},buttonDark:{generate:function(c){var d,e=a.buttonDarkScale9;if(d=UI.button(0,0,20,20),d.setProperties({background:e,hoverBackground:UI.Assets.buttonDarkBlueActiveScale9,activeBackground:UI.Assets.buttonDarkActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!c)return d;b.buttonDark=d}},buttonDarkBlue:{generate:function(c){var d;if(d=UI.button(0,0,20,20),d.setProperties({background:a.buttonDarkBlueScale9,activeBackground:UI.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!c)return d;b.buttonDarkBlue=d}},buttonDarkRed:{generate:function(c){var d;if(d=UI.button(0,0,20,20),d.setProperties({background:a.buttonDarkRedScale9,hoverBackground:UI.Assets.buttonDarkRedHoverScale9,activeBackground:UI.Assets.buttonDarkRedActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!c)return d;b.buttonDarkRed=d}},buttonDarkGreen:{generate:function(c){var d;if(d=UI.button(0,0,20,20),d.setProperties({background:a.buttonDarkGreenScale9,hoverBackground:UI.Assets.buttonDarkGreenHoverScale9,activeBackground:UI.Assets.buttonDarkGreenActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!c)return d;b.buttonDarkGreen=d}},buttonKey:{generate:function(c){var d;if(d=UI.button(0,0,20,20),d.setProperties({background:a.buttonKeyScale9,hoverBackground:UI.Assets.buttonKeyHoverScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark}),!c)return d;b.buttonKey=d}}};return a.init=function(){a.buttonLightScale9.img=Y.getImage("button_light"),a.buttonLightHoverScale9.img=Y.getImage("button_light_hover"),a.buttonDarkScale9.img=Y.getImage("button_inlay"),a.buttonDarkBlueScale9.img=Y.getImage("button_inlay_blue"),a.buttonDarkRedScale9.img=Y.getImage("button_inlay_red"),a.buttonDarkRedHoverScale9.img=Y.getImage("button_inlay_red_hover"),a.buttonDarkGreenScale9.img=Y.getImage("button_inlay_green"),a.buttonDarkGreenHoverScale9.img=Y.getImage("button_hover_green"),a.buttonDarkActiveScale9.img=Y.getImage("button_inlay_active"),a.buttonDarkGreenActiveScale9.img=Y.getImage("button_inlay_green_active"),a.buttonDarkRedActiveScale9.img=Y.getImage("button_inlay_red_active"),a.buttonDarkBlueActiveScale9.img=Y.getImage("button_inlay_blue_active"),a.buttonDarkYellowActiveScale9.img=Y.getImage("button_inlay_yellow_active"),a.panelMainScale9.img=Y.getImage("background"),a.panelDarkScale9.img=Y.getImage("bar"),a.panelDarkHoverScale9.img=Y.getImage("bar_hover"),a.panelDarkGreyScale9.img=Y.getImage("panel_dark_greyish"),a.panelDarkGreyBlueScale9.img=Y.getImage("panel_dark_blueish"),a.panelTransScale9.img=Y.getImage("panel_trans"),a.panelInsetScale9.img=Y.getImage("panel_inset"),a.panelDarkInsetScale9.img=Y.getImage("panel_dark"),a.buttonKeyScale9.img=Y.getImage("keybutton"),a.buttonKeyHoverScale9.img=Y.getImage("keybutton_hover"),a.buttonKeyActiveScale9.img=Y.getImage("keybutton_highlight3")},a.get=function(a){var d=b[a];if(d)return d;var e=c[a];e&&(e.isLoading||(e.isLoading=!0,e.generate(!0)))},a.put=function(a,c){b[a]=c},a.generate=function(a){return c[a]?c[a].generate():void 0},a}(),UI.animsprite=function(a,b,c,d,e,f){c=c||14,d=d||14;var g=UI.element(a,b,c,d,!0),h=["left","top","width","height","name"];g.setProperties=function(a){h.forEach(function(b){void 0!==a[b]&&(g[b]=a[b])}),g.setSize(g.width,g.height),g.setPosition(g.left,g.top)};var i=Y.getImage(e),j=0;return g.onShow=function(){UI.ticker.onEachTick2(function(){j++,j>=f&&(j=0),g.refresh()},0)},g.onHide=function(){UI.ticker.onEachTick2()},g.render=function(a){if(a=!!a,this.needsRendering&&(g.clearCanvas(),g.ctx.drawImage(i,j*c,0,c,d,0,0,c,d)),this.needsRendering=!1,a)return g.canvas;g.parentCtx.drawImage(g.canvas,g.left,g.top,g.width,g.height)},g};var BitmapFont=function(){function a(a){return f.fixedWidth?b:b[a]}var b,c,d,e,f={},g=[],h=!1,i=!1;return f.generate=function(j){var k=j.image,l=j.startX,m=j.startY;b=j.charWidth;var n=j.charHeight;e=j.spaceWidth||8;var o=j.margin,p=j.lineSpacing||0,q=j.charsPerLine,r=j.chars||"ABCDEFGHIJKLMNOPQRSTUVWXYZ";h=j.onlyUpperCase,i=!!j.debug,f.fontArray=[],f.colors={},d=o,c=n,f.fixedWidth=!0,f.charHeight=n,"number"!=typeof b&&(f.fixedWidth=!1,"string"==typeof b&&(b=b.split(""),b.forEach(function(a,c){b[c]=parseInt(a)}))),f.charWidth=b;for(var s=l,t=m,u=0,v=0,w=0,x=r.length;w<=x;w++){var y=document.createElement("canvas"),z=a(w)||1;y.width=z,y.height=n;var A=y.getContext("2d");if(f.fixedWidth)var B=l+w%q*(z+o),C=m+Math.floor(w/q)*(n+p);else B=s,C=t,s+=z+o,++v>=q[u]&&(u++,v=0,s=l,t+=c+p);A.drawImage(k,B,C,z,n,0,0,z,n);var D=r.charCodeAt(w);f.fontArray[D]=y,g[D]=z}},f.generateColor=function(a,b){a=a||"green",b=b||"rgba(107, 161, 65,0.9)";var c=[];f.fontArray.forEach(function(a,d){var e=document.createElement("canvas"),f=document.createElement("canvas");e.width=a.width,e.height=a.height,f.width=a.width,f.height=a.height;var g=e.getContext("2d"),h=f.getContext("2d");h.fillStyle=b,h.fillRect(0,0,16,16),h.globalCompositeOperation="destination-atop",h.drawImage(a,0,0),g.drawImage(f,0,0),g.globalCompositeOperation="darken",g.drawImage(a,0,0),c[d]=e}),f.colors[a]=c},f.getTextWidth=function(a,b){h&&(a=a.toUpperCase()),b=b||d;for(var c=0,f=0,i=a.length;f<i;f++){c+=(g[a.charCodeAt(f)]||e)+b}return c},f.write=function(a,b,i,j,k,l){h&&(b=b.toUpperCase());var m=f.colors[l]||f.fontArray;k=k||d,i=i||0,j=j||0;for(var n=i,o=0,p=b.length;o<p;o++){var q=b.charCodeAt(o),r=m[q],s=g[q];s||(s=e),r&&a.drawImage(r,n,j,s,c),n+=s+k}},f};UI.button=function(a,b,c,d,e){var f=UI.element(a,b,c,d);f.type="button",f.isActive=!1;var g,h,i,j,k,l,m,n,o=e||"",p="left",q=0,r=0,s=10,t=!0,u=["left","top","width","height","name","type","image","backgroundImage","background","active","hoverBackground","hoverImage","activeBackground","activeImage","font","label","textAlign","paddingTop","paddingTopActive","paddingLeft"];return f.setProperties=function(a){u.forEach(function(b){if(void 0!==a[b])switch(b){case"label":o=a[b];break;case"font":n=a[b];break;case"textAlign":p=a[b];break;case"paddingTop":q=parseInt(a[b]);break;case"paddingTopActive":r=parseInt(a[b]);break;case"paddingLeft":s=parseInt(a[b]);break;case"image":g=a[b];break;case"backgroundImage":h=a[b];break;case"activeImage":l=a[b];break;case"hoverImage":m=a[b],t=!0;break;case"background":a[b].img&&(h=void 0,i=UI.scale9Panel(0,0,0,0,a[b]),i.setParent(f));break;case"activeBackground":a[b].img&&(j=UI.scale9Panel(0,0,0,0,a[b]),j.setParent(f));break;case"hoverBackground":a[b].img&&(k=UI.scale9Panel(0,0,0,0,a[b]),k.setParent(f)),t=!0;break;default:f[b]=a[b]}}),i&&i.setSize(f.width,f.height),j&&j.setSize(f.width,f.height),k&&k.setSize(f.width,f.height),f.setSize(f.width,f.height),f.setPosition(f.left,f.top)},f.setBackgroundImage=function(a){h=a,f.refresh()},f.setFont=function(a){n=a,f.refresh()},f.setLabel=function(a){o=a,f.refresh()},f.toggleActive=function(){f.isActive=!f.isActive,f.refresh()},f.setActive=function(a){void 0===a&&(a=!0),f.isActive=!!a,f.refresh()},f.setDisabled=function(a){void 0===a&&(a=!0),f.isDisabled=a,a&&(f.isActive=!1),f.refresh()},f.onHover=function(a){t&&(f.isActive||(f.isHover=!0,f.refresh()))},f.onHoverExit=function(){t&&f.isHover&&(f.isHover=!1,f.refresh())},f.render=function(a){if(f.isVisible()){if(f.needsRendering){a=!!a;if(h)f.ctx.drawImage(h,0,0,f.width,f.height);else if(i)if(f.isActive&&j){if(j.render(),l){var b=Math.floor((f.height-l.height)/2),c=Math.floor((f.width-l.width)/2);f.ctx.drawImage(l,c,b)}}else{var d=g;if(f.isHover&&m&&(d=m),f.isHover&&k?k.render():i.render(),d){var b=Math.floor((f.height-d.height)/2),c=Math.floor((f.width-d.width)/2);f.ctx.drawImage(d,c,b)}}else f.ctx.fillStyle="grey",f.ctx.fillRect(0,0,f.width,f.height),f.ctx.fillStyle="black",f.ctx.rect(0,0,f.width,f.height),f.ctx.stroke();if(o){var e=Math.floor((f.height-10)/2)+(f.isActive?r:q),t=s;if(n){if("center"===p){var u=8*o.length;n.fixedWidth||(u=n.getTextWidth(o,0)),t=Math.floor((f.width-u)/2)}"right"===p&&(u=8*o.length,n.fixedWidth||(u=n.getTextWidth(o,0)),t=f.width-u-5),n.write(f.ctx,o,t,e,0)}else f.ctx.fillStyle="white",f.ctx.fillText(o,t,e)}f.isDisabled&&(f.ctx.fillStyle="rgba(34, 49, 85, 0.6)",f.ctx.fillRect(0,0,f.width,f.height)),f.renderInternal&&f.renderInternal()}if(f.needsRendering=!1,a)return f.canvas;f.parentCtx.drawImage(f.canvas,f.left,f.top,f.width,f.height)}},f},UI.checkbox=function(a,b,c,d){c=c||14,d=d||14;var e=UI.element(a,b,c,d,!0),f=["left","top","width","height","name","type","checked"];return e.setProperties=function(a){f.forEach(function(b){void 0!==a[b]&&(e[b]=a[b])}),e.setSize(e.width,e.height),e.setPosition(e.left,e.top)},e.setState=function(a,b){e.checked=a,e.refresh(),e.onToggle&&!b&&e.onToggle(e.checked)},e.onClick=function(a){e.setState(!e.checked)},e.check=function(){e.setState(!0)},e.unCheck=function(){e.setState(!1)},e.toggle=function(){e.setState(!e.checked)},e.render=function(a){if(a=!!a,this.needsRendering){e.clearCanvas();e.ctx.drawImage(Y.getImage(e.checked?"checkbox_on":"checkbox_off"),0,0)}if(this.needsRendering=!1,a)return e.canvas;e.parentCtx.drawImage(e.canvas,e.left,e.top,e.width,e.height)},e},UI.checkboxbutton=function(a){var b=UI.button(0,0,20,20);return a=a||{},b.setProperties({background:UI.Assets.buttonDarkBlueScale9,hoverBackground:UI.Assets.buttonDarkBlueActiveScale9,activeBackground:UI.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"left",paddingLeft:30,font:window.fontFT,label:a.label||""}),b.renderInternal=function(){b.ctx.drawImage(Y.getImage(b.isActive?"radio_active":"radio_inactive"),8,Math.floor(b.height/2)-5)},b.onDown=function(){b.toggleActive(),a.onDown&&a.onDown.bind(b).call()},b},UI.element=function(a,b,c,d){var e={};return e.left=a||0,e.top=b||0,e.width=c||20,e.height=d||20,e.visible=!0,e.needsRendering=!0,e.parentCtx=ctx,e.canvas=document.createElement("canvas"),e.canvas.width=c,e.canvas.height=d,e.ctx=e.canvas.getContext("2d"),e.children=[],e.hide=function(){e.visible=!1,e.onHide&&e.onHide()},e.show=function(a,b){e.visible=!0,a&&e.refresh(b),e.onShow&&e.onShow()},e.toggle=function(a){"boolean"==typeof a?a?e.show():e.hide():e.visible?e.hide():e.show()},e.isVisible=function(){for(var a=e.visible,b=e.parent;a&&b;)a=b.visible,b=b.parent;return a},e.containsPoint=function(a,b){var c=this.left,d=this.left+this.width,e=this.top,f=this.top+this.height;return a>=c&&a<=d&&b>=e&&b<=f},e.getElementAtPoint=function(a,b){a-=e.left+(e.scrollOffsetX||0),b-=e.top+(e.scrollOffsetY||0),e.scaleX&&(a/=e.scaleX),e.scaleY&&(b/=e.scaleY);for(var c,d=e.children.length-1;d>=0;d--){var f=e.children[d];if(f.isVisible()&&!f.ignoreEvents&&f.containsPoint(a,b)){c=f;break}}if(c){var g=c.getElementAtPoint(a,b);g?c=g:(c.eventX=a,c.eventY=b)}else c=e,c.eventX=a,c.eventY=b;return c},e.setParent=function(a){e.parent=a,a&&(e.parentCtx=a.ctx)},e.addChild=function(a){a.setParent(e),a.zIndex=a.zIndex||e.children.length,e.children.push(a)},e.getChild=function(a){for(var b,c=e.children.length;c;){if((b=e.children[c])&&b.name&&b.name==a)return b;c--}},e.refresh=function(a){if(e.needsRendering=!0,a)for(var b,c=e.children.length;c;)b=e.children[c],b&&b.refresh(),c--;this.visible&&e.parent&&e.parent.refresh&&e.parent.refresh()},e.setSize=function(a,b){e.width=Math.max(a,1),e.height=Math.max(b,1),e.canvas.width=e.width,e.canvas.height=e.height,e.onResize&&e.onResize(),e.refresh()},e.setPosition=function(a,b){e.left=a,e.top=b,e.refresh()},e.setDimensions=function(a){("boolean"!=typeof a.visible||a.visible)&&(e.setProperties?e.setProperties(a):(e.setPosition(a.left,a.top),e.setSize(a.width,a.height)))},e.clearCanvas=function(){e.ctx.clearRect(0,0,e.width,e.height)},e},UI.inputbox=function(a){var b,c,d,e=UI.element(),f=["left","top","width","height","name","type","onChange","backgroundImage"],g="",h="panel_dark";e.setProperties=function(a){f.forEach(function(b){void 0!==a[b]&&(e[b]=a[b])}),e.setSize(e.width,e.height),e.setPosition(e.left,e.top),i&&i.setSize(e.width,e.height),a.value&&(g=a.value),a.backgroundImage&&(h=a.backgroundImage)},a&&e.setProperties(a);var i=UI.scale9Panel(0,0,e.width,e.height,{img:Y.getImage(h),left:3,top:3,right:2,bottom:2});i.ignoreEvents=!0,e.addChild(i),e.render=function(a){if(a=!!a,e.isVisible()){if(this.needsRendering){i.render();var b=0;if(g&&fontMed){b=10;fontMed.write(e.ctx,g,b,6,0)}if(c){e.ctx.fillStyle="rgba(255,255,255,0.7)";e.ctx.fillRect(b+9*d+8,4,2,e.height-8)}}if(this.needsRendering=!1,a)return e.canvas;e.parentCtx.drawImage(e.canvas,e.left,e.top,e.width,e.height)}},e.setValue=function(a,b){g=a,e.refresh(),!b&&e.onChange&&e.onChange(g)},e.getValue=function(){return g},e.getItemAtPosition=function(a,b){b-=startY;var c=Math.floor(b/lineHeight)+visibleIndex;return c>=0&&c<items.length?items[c]:void 0},e.onClick=function(){b||e.activate()},e.activate=function(){d=-1,!b&&g&&(d=g.length-1),b=!0,Input.setFocusElement(e),j()},e.deActivate=function(){b&&(c=!1,b=!1,e.refresh(),Input.clearFocusElement())},e.onKeyDown=function(a,b){var c=!1;switch(a){case 8:g&&d>=0&&(g=g.substr(0,d)+g.substr(d+1),d--,e.onChange&&e.onChange(g)),c=!0;break;case 13:e.deActivate(),c=!0;break;case 37:d>=0&&d--,e.refresh(),c=!0;break;case 39:g&&(d++,d=Math.min(d,g.length-1),e.refresh()),c=!0;break;case 46:c=!0}if(!c&&a>31){var f=b.key;1==f.length&&f.match(/[a-z0-9\._:\-\ #]/i)&&(g=g.substr(0,d+1)+f+g.substr(d+1),e.onChange&&e.onChange(g),d++,e.refresh()),c=!0}return c};var j=function(){b&&(c=!c,e.refresh(),setTimeout(j,200))};return e},UI.knob=function(a){var b=UI.element();b.type="knob";var c,d="",e="left",f=0,g=0,h=50,i=h,j=["left","top","width","height","name","font","label","textAlign","paddingTop","disabled"],k=Y.getImage("knob_back"),l=Y.getImage("knob_back_inactive"),m=Y.getImage("knob_front");return b.width=k.width+32,b.height=k.height+32,b.setSize(b.width,b.height),b.setProperties=function(a){j.forEach(function(g){if(void 0!==a[g])switch(g){case"label":d=a[g];break;case"font":c=a[g];break;case"textAlign":e=a[g];break;case"paddingTop":f=parseInt(a[g]);break;case"disabled":b.isDisabled=!!a[g];default:b[g]=a[g]}}),b.setSize(b.width,b.height),b.setPosition(b.left,b.top)},b.setFont=function(a){c=a,b.refresh()},b.setLabel=function(a){d=a,b.refresh()},b.getLabel=function(){return d},b.setValue=function(a){g=a,b.refresh()},b.render=function(a){if(b.needsRendering){a=!!a,b.clearCanvas();var c=1;c=.8;var e=k.width*c,f=k.height*c,g=e/2,i=f/2;b.ctx.save(),b.ctx.translate(16+g,16+i),b.ctx.drawImage(b.isDisabled?l:k,-g,-i,e,f);var j=Math.abs(-230)+50,n=h/100*j-230,o=-230*Math.PI/180,p=n*Math.PI/180;b.ctx.fillStyle=b.isDisabled?"rgba(170,170,170,0.5)":"rgba(130,200,255,0.5)",b.ctx.beginPath(),b.ctx.arc(0,0,30,o,p,!1),b.ctx.arc(0,0,25,p,o,!0),b.ctx.fill();if(b.ctx.rotate((h/100*320-160)*Math.PI/180),b.ctx.drawImage(m,-g,-i,e,f),b.ctx.restore(),d){var q=(b.width-6*d.length)/2;q=16+g-3*d.length,fontSmall.write(b.ctx,d,q,f+16+4)}}if(b.needsRendering=!1,a)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)},b.onDragStart=function(){i=h},b.onDrag=function(a){if(!b.isDisabled){h=i+a.deltaY,h=Math.max(h,0),h=Math.min(h,100),b.refresh(),b.onChange&&b.onChange(h)}},b.onClick=function(a){Math.abs(a.x-a.startX)<3&&Math.abs(a.y-a.startY)<3&&b.toggleDisabled()},b.toggleDisabled=function(){b.isDisabled=!b.isDisabled,b.onToggle&&b.onToggle(!b.isDisabled),b.refresh()},b},UI.label=function(a){var b=UI.element();b.type="label";var c,d="",e="left",f=0,g=["left","top","width","height","name","font","label","textAlign","paddingTop"];return b.setProperties=function(a){g.forEach(function(g){if(void 0!==a[g])switch(g){case"label":d=a[g];break;case"font":c=a[g];break;case"textAlign":e=a[g];break;case"paddingTop":f=parseInt(a[g]);break;default:b[g]=a[g]}}),b.setSize(b.width,b.height),b.setPosition(b.left,b.top),a.labels&&(b.onResize=function(){var c=d;a.labels.forEach(function(a){b.width>=a.width&&(d=a.label)}),c!==d&&b.refresh()})},b.setFont=function(a){c=a,b.refresh()},b.setLabel=function(a){d=a,b.refresh()},b.render=function(a){if(b.isVisible()){if(b.needsRendering&&(a=!!a,b.clearCanvas(),d)){var g=Math.floor((b.height-10)/2)+f,h=10;if(c){var i;"center"==e&&(i=c.getTextWidth(d,0),h=Math.floor((b.width-i)/2)),"right"==e&&(i=c.getTextWidth(d,0),h=Math.floor(b.width-i)-10),c.write(b.ctx,d,h,g,0)}else b.ctx.fillStyle="white",b.ctx.fillText(d,h,g)}if(b.needsRendering=!1,a)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)}},a&&b.setProperties(a),b},UI.listbox=function(a,b,c,d){function e(){var a=m.length;o=Math.floor(g.height/p),g.centerSelection&&(o=1);var b=18,c=g.height-4-32,d=c;r=0,a>o&&(d=Math.floor(o/a*c),d<12&&(d=12),r=(c-d)/(a-o)),n&&r&&(b=Math.floor(18+r*n)),w.setProperties({left:g.width-18,top:b,width:16,height:d})}function f(){var a=m.length-1;return g.centerSelection||(a=m.length-o),a<0&&(a=0),a}var g=UI.element(a,b,c,d,!0);g.selectedIndex=0;var h,i,j=0,k=window.fontMed,l=window.fontSmall,m=[],n=0,o=0,p=18,q=10,r=0,s=["left","top","width","height","name","type","onChange","selectedIndex","centerSelection"];g.setProperties=function(a){s.forEach(function(b){void 0!==a[b]&&(g[b]=a[b])}),void 0!==a.font&&(k=a.font),g.setSize(g.width,g.height),g.setPosition(g.left,g.top),t.setSize(g.width,g.height),e(),u.setProperties({left:g.width-18,top:2,width:16,height:16,label:"↑"}),v.setProperties({left:g.width-18,top:g.height-19,width:16,height:16,label:"↓"}),g.centerSelection&&(q=Math.ceil((g.height-p)/2))},g.setSelectedIndex=function(a,b){g.selectedIndex=a,g.centerSelection&&(n=g.selectedIndex),e(),g.refresh(),!b&&g.onChange&&j!=g.selectedIndex&&g.onChange(),j=g.selectedIndex},g.getSelectedIndex=function(){return g.selectedIndex};var t=UI.scale9Panel(0,0,g.width,g.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});t.ignoreEvents=!0,g.addChild(t);var u=UI.Assets.generate("button20_20");g.addChild(u),u.onClick=function(){g.navigateUp()};var v=UI.Assets.generate("button20_20");g.addChild(v),v.onClick=function(){g.navigateDown()};var w=UI.scale9Panel(c-28,18,16,d-3,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});return w.onDragStart=function(){w.startDragIndex=n},w.onDrag=function(a){if(m.length>o&&r){var b=a.deltaY;n=Math.floor(w.startDragIndex+b/r),n=Math.min(n,f()),n=Math.max(n,0),g.centerSelection?g.setSelectedIndex(n):e()}},g.addChild(w),g.navigateUp=function(){n>0&&(n--,e()),g.centerSelection?g.setSelectedIndex(n):g.refresh()},g.navigateDown=function(){n<f()&&(n++,e()),g.centerSelection?g.setSelectedIndex(n):g.refresh()},g.render=function(a){if(a=!!a,g.isVisible()){if(this.needsRendering){t.render();for(var b=Y.getImage("line_hor"),c=0,d=m.length;c<d;c++){var e=m[c],f=10,i=6,j=q+(c-n)*p;if(j>0&&j<g.height){var o,r=g.ctx,s=j,x=j>=g.height-p;if(x){var y=g.height-j+1;y>1?(o=document.createElement("canvas"),o.width=g.width-2,o.height=y,r=o.getContext("2d"),s=4,i=6):r=void 0}if(r){h+n===c&&(r.fillStyle="rgba(110,130,220,0.07)",r.fillRect(0,s-i,g.width-2,p)),g.selectedIndex===c&&(r.fillStyle="rgba(110,130,220,0.15)",r.fillRect(0,s-i,g.width-2,p)),e.level&&(f+=10*e.level),e.icon&&(r.drawImage(e.icon,f,s-2),f+=e.icon.width+4);var z=e.label;if(k){if(e.info){var A=6*e.info.length+20;l.write(r,e.info,g.width-A,s,0),z=z.substr(0,Math.floor((g.width-A-f-26)/k.charWidth))}k.write(r,z,f,s,0)}j+=11,s+=11,b&&r.drawImage(b,0,s,g.width-2,2),x&&g.ctx.drawImage(o,0,j-11-4)}}}w.render(),u.render(),v.render()}if(this.needsRendering=!1,a)return g.canvas;g.parentCtx.drawImage(g.canvas,g.left,g.top,g.width,g.height)}},g.setItems=function(a){m=a,n=Math.min(n,f()),e(),g.refresh()},g.getItems=function(){return m},g.getItemAtPosition=function(a,b){b-=q;var c=Math.floor(b/p)+n;return c>=0&&c<m.length?m[c]:void 0},g.insertItemAfterIndex=function(a,b,c){},g.onMouseWheel=function(a){a.mouseWheels[0]>0?g.navigateUp():g.navigateDown()},g.onDragStart=function(a){g.startDragIndex=n},g.onDrag=function(a){if(m.length>o){n=g.startDragIndex-Math.round(a.deltaY/p),n=Math.max(n,0),n=Math.min(n,f()),g.centerSelection?g.setSelectedIndex(n):e()}},g.onHover=function(a){var b=Math.floor((g.eventY-q)/p);b!==i&&(h=b,i=h,g.refresh())},g.onHoverExit=function(){h&&(h=void 0,i=void 0,g.refresh())},g},UI.menu=function(a,b,c,d,e){var f=UI.element(a,b,c,d);f.keepSelection=!0;var g,h,i=["left","top","width","height","name","type","background","layout"],j=[];return f.setProperties=function(a){i.forEach(function(b){void 0!==a[b]&&(f[b]=a[b])}),a.background&&(h=UI.scale9Panel(0,0,f.width,f.height,a.background),h.ignoreEvents=!0,f.addChild(h)),f.setSize(f.width,f.height),f.setPosition(f.left,f.top)},f.onClick=function(a){if(g&&g.length){var b,c=a.x,d=0,e=g.length;for(b=0;b<e&&!(c<g[b].startX);b++)d=b;var h=g[d];for(b=0;b<e;b++)b!==d&&g[b].subMenu&&g[b].subMenu.hide();if(h){if(h.subMenu){var i=a.globalX-a.x;h.subMenu.setPosition((h.startX||0)+i,f.height),h.subMenu.toggle(),h.subMenu.parent.refresh()}h.command&&EventBus.trigger(EVENT.command,h.command)}}},f.render=function(a){if(f.isVisible()){if(a=!!a,this.needsRendering){var b=10;f.clearCanvas(),h&&h.render(),j.length?j.forEach(function(a){a.render()}):g&&g.forEach(function(a){a.startX=b,fontMed.write(f.ctx,a.label,b,10),b+=9*a.label.length+24})}if(this.needsRendering=!1,a)return f.canvas;f.parentCtx.drawImage(f.canvas,f.left,f.top,f.width,f.height)}},f.setItems=function(a){g=a,e=e||f.parent,j=[];var b={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},c=3,d=3;g.forEach(function(a,g){if("buttons"===f.layout){var h=UI.button(c,d,60,18);c+=60,1===g&&(c=3,d+=18),h.setProperties(b),h.setLabel(a.label),a.onClick&&(h.onClick=function(){a.onClick()}),j.push(h),f.addChild(h)}if(a.subItems){var i=UI.submenu();i.setProperties({background:UI.Assets.buttonLightScale9}),i.hide(),i.setItems(a.subItems),i.zIndex=200,e.addChild(i),a.subMenu=i}}),f.zIndex=9,f.refresh()},f.getItems=function(){return g},f.getItemAtPosition=function(a,b){b-=startY;var c=Math.floor(b/lineHeight)+visibleIndex;return c>=0&&c<g.length?g[c]:void 0},f},UI.modalDialog=function(a){var b=UI.element(),c="",d=["left","top","width","height","name","ok","cancel"];b.setProperties=function(a){d.forEach(function(c){void 0!==a[c]&&(b[c]=a[c])}),b.setSize(b.width,b.height),b.setPosition(b.left,b.top);var c=200;b.height<c&&(c=b.height-20);var h=Math.max(Math.floor(b.width/2),380);e.setSize(h,c),e.setPosition(Math.floor((b.width-h)/2),Math.floor((b.height-c)/2)),b.cancel?(f.setPosition(e.left+Math.floor(e.width/2)-110,e.top+e.height-40),g.setPosition(e.left+Math.floor(e.width/2)+10,e.top+e.height-40)):f.setPosition(e.left+Math.floor(e.width/2)-50,e.top+e.height-40)};var e=UI.scale9Panel(0,0,Math.floor(b.width/2),200,UI.Assets.panelMainScale9);e.ignoreEvents=!0,b.addChild(e);var f=UI.Assets.generate("buttonLight");f.setProperties({name:"okbutton",label:"OK",width:100,height:28}),b.addChild(f);var g=UI.Assets.generate("buttonLight");return g.setProperties({name:"cancelbutton",label:"Cancel",width:100,height:28}),b.addChild(g),b.render=function(a){if(a=!!a,this.needsRendering){if(b.ctx.fillStyle="rgba(0,0,0,0.6)",b.ctx.fillRect(0,0,b.width,b.height),e.render(),c){var d=c.split("/"),h=e.top+20,i=e.width-20;d.forEach(function(a){var c=10;if(fontFT){var d=fontFT.getTextWidth(a,0);c=e.left+10+Math.floor((i-d)/2),fontFT.write(b.ctx,a,c,h,0)}h+=12})}b.ok&&f.render(),b.cancel&&g.render()}if(this.needsRendering=!1,a)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)},b.setText=function(a){c=a},b.getText=function(){return c},b.close=function(){b.hide(),b.onClose&&b.onClose(),UI.removeModalElement(),delete b},b},UI.numberDisplay=function(a,b,c,d,e){function f(){for(var a=""+e;a.length<h;)a=i+a;return a}var g=UI.element(a,b,c,d);g.type="numberDisplay",g.isActive=!1;var e=e||0,h=4,i=" ",j=["left","top","width","height","name","value"];return g.setProperties=function(a){j.forEach(function(b){if(void 0!==a[b])switch(b){case"value":e=a[b];break;default:g[b]=a[b]}}),g.setSize(g.width,g.height),g.setPosition(g.left,g.top)},g.setValue=function(a){e=a,g.refresh()},g.setDisabled=function(a){void 0===a&&(a=!0),g.isDisabled=a,a&&(g.isActive=!1),g.refresh()},g.onResize=function(){h=Math.floor(g.width/9)-1},g.render=function(a){if(g.isVisible()){if(g.needsRendering){a=!!a,g.ctx.clearRect(0,0,g.width,g.height);var b=2,c=2,d=g.width-4,e=g.height-4;g.ctx.drawImage(Y.getImage("panel_inset_dark"),b,c,d,e),b+=4,c=7,window.fontLed.write(g.ctx,f(),b,c,0),g.isDisabled&&(g.ctx.fillStyle="rgba(34, 49, 85, 0.6)",g.ctx.fillRect(0,0,g.width,g.height)),g.renderInternal&&g.renderInternal()}if(g.needsRendering=!1,a)return g.canvas;g.parentCtx.drawImage(g.canvas,g.left,g.top,g.width,g.height)}},g},UI.panel=function(a,b,c,d){var e=UI.element(a,b,c,d);e.type="panel";var f=["left","top","width","height","name","type","zIndex","backgroundColor","borderColor"];return e.setProperties=function(a){f.forEach(function(b){void 0!==a[b]&&(e[b]=a[b])}),e.setSize(e.width,e.height),e.setPosition(e.left,e.top),e.setLayout&&e.setLayout(e.left,e.top,e.width,e.height)},e.render=function(a){if(e.isVisible()){if(a=!!a,this.needsRendering&&(e.clearCanvas(),e.backgroundColor&&(e.ctx.fillStyle=e.backgroundColor,e.ctx.fillRect(0,0,e.width,e.height)),e.borderColor&&(e.ctx.fillStyle=e.borderColor,e.ctx.rect(0,0,e.width,e.height),e.ctx.stroke()),this.children.forEach(function(a){a.render()}),e.renderInternal&&e.renderInternal()),this.needsRendering=!1,a)return e.canvas;e.parentCtx.drawImage(e.canvas,e.left,e.top,e.width,e.height)}},e.onClick=function(){},e.sortZIndex=function(){this.children.sort(function(a,b){return a.zIndex==b.zIndex?0:a.zIndex>b.zIndex||-1})},e},UI.radioGroup=function(a,b,c,d){var e,f,g,h=UI.element(a,b,c,d,!0),i=[],j="small",k="right",l=-3,m=13,n="radio",o=["left","top","width","height","name"];return h.setProperties=function(a){o.forEach(function(b){void 0!==a[b]&&(h[b]=a[b])}),h.setSize(h.width,h.height),h.setPosition(h.left,h.top),a.align&&(k=a.align),a.size&&(j=a.size),a.divider&&(f=a.divider),a.type&&(n=a.type),a.highLightSelection&&(g=!0)},h.onClick=function(a){h.setSelectedIndex(Math.floor((h.eventY-0+l)/m))},h.setSelectedIndex=function(a,b){a=Math.min(a,i.length-1);for(var c=0,d=i.length;c<d;c++)i[c].active=c==a;h.selectedIndex=a,h.refresh(),!b&&h.onChange&&e!=h.selectedIndex&&h.onChange(h.selectedIndex),e=h.selectedIndex},h.getSelectedIndex=function(){return h.selectedIndex},h.getSelectedItem=function(){return i[h.selectedIndex]},h.render=function(a){if(a=!!a,h.isVisible()){if(this.needsRendering){h.clearCanvas();var b=Y.getImage("radio_active"),c=Y.getImage("radio_inactive");m=Math.floor(h.height/i.length);var d=fontSmall,e=5,n=h.width-15;l=-3,"med"===j&&(b=Y.getImage("radio_big_active"),c=Y.getImage("radio_big_inactive"),l=-2,n=h.width-20,d=fontMed);var o=Math.floor((m-d.charHeight)/2);"left"===k&&(e=30,n=5);for(var p=Y.getImage("line_hor"),q=0,r=i.length;q<r;q++){var s=i[q],t=0+q*m,u=t+o;if("line"==f&&q>0&&h.ctx.drawImage(p,0,t,h.width,2),d){if("right"===k){var v=s.label;if((e=n-d.getTextWidth(s.label,0)-4)<0&&s.labels){var w=n-4;s.labels.forEach(function(a){a.width<=w&&(v=a.label)}),e=n-d.getTextWidth(v,0)-4}}d.write(h.ctx,v,e,u,0)}s.active?(g&&(h.ctx.fillStyle="rgba(100,100,255,0.1",h.ctx.fillRect(0,t,h.width-2,m)),h.ctx.drawImage(b,n,u+l)):h.ctx.drawImage(c,n,u+l)}}if(this.needsRendering=!1,a)return h.canvas;h.parentCtx.drawImage(h.canvas,h.left,h.top,h.width,h.height)}},h.setItems=function(a){h.selectedIndex=void 0,i=a;for(var b=0,c=i.length;b<c;b++)i[b].active&&(h.selectedIndex=b);h.refresh()},h.getItemAtPosition=function(a,b){b-=0;var c=Math.floor(b/m)+visibleIndex;return c>=0&&c<i.length?(i[c].index=c,i[c]):void 0},h},UI.rangeSlider=function(a){var b=UI.element();b.type="rangeslider";var c=["left","top","width","height","name","onChange"],d=Y.getImage("slider_knob"),e=Y.getImage("slider_knob_vert"),f=Y.getImage("slider_back"),g=Y.getImage("slider_back_vert"),h=!1,i=0,j=UI.scale9Panel(0,0,0,0,{img:f,left:4,right:4,top:0,bottom:0,scale:"repeatX"});b.addChild(j),j.ignoreEvents=!0;var k=0,l=0,m=0,n=0,o=0,p=100,q=0;return b.setProperties=function(a){c.forEach(function(c){void 0!==a[c]&&(b[c]=a[c])}),b.setSize(b.width,b.height),b.setPosition(b.left,b.top),void 0!==a.min&&(o=a.min),void 0!==a.max&&(p=a.max),void 0!==a.value&&b.setValue(a.value,!0),void 0!==a.vertical&&(h=!!a.vertical,j.setProperties({img:g,imgLeft:0,imgRight:0,imgTop:4,imgBottom:4,scale:"repeatY"}))},b.getValue=function(){return q},b.setValue=function(a,c){a>p&&(a=p),a<o&&(a=o);var e=!c&&q!==a;if(q=a,h){l=i*(1-(a-o)/(p-o))}else{k=(b.width-d.width)*a/p}b.refresh(),e&&!c&&b.onChange&&b.onChange(q)},b.setMax=function(a,c){p=a,!c&&q>p&&b.setValue(p)},b.setMin=function(a,c){o=a,!c&&q<o&&b.setValue(o)},b.render=function(a){if(b.needsRendering){a=!!a,b.clearCanvas();var c=Math.floor(b.width/2)+3,f=b.height;o<0&&(f=Math.floor(f/2)),b.ctx.fillStyle="rgba(255,255,255,0.1",
b.ctx.beginPath(),b.ctx.moveTo(c,f),b.ctx.lineTo(c,2),b.ctx.lineTo(c+6,2),b.ctx.fill(),o<0?(b.ctx.beginPath(),b.ctx.moveTo(c-6,f),b.ctx.lineTo(c-6,b.height),b.ctx.lineTo(c-6-6,b.height),b.ctx.fill()):(b.ctx.beginPath(),b.ctx.moveTo(c-6,f),b.ctx.lineTo(c-6,2),b.ctx.lineTo(c-6-6,2),b.ctx.fill()),j.render(),h?b.ctx.drawImage(e,-1,l,e.width,e.height):b.ctx.drawImage(d,k,-1,d.width,d.height)}if(b.needsRendering=!1,a)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)},b.onResize=function(){i=b.height-e.height+3,j.setSize(b.width,b.height),b.setValue(q,!0)},b.onDragStart=function(){m=k,n=l},b.onDrag=function(a){if(h){var c=a.deltaY;if(l=n+c,l<0&&(l=0),l>i&&(l=i),i>d.height){var e=p-o;q=e-Math.round(e*l/i)+o}else q=p}else{c=a.deltaX,k=m+c,k<0&&(k=0);var f=b.width-d.width;k>f&&(k=f),q=f>d.width?Math.round(p*k/f):0}b.refresh(),b.onChange&&b.onChange(q)},a&&b.setProperties(a),b},UI.scale9Panel=function(a,b,c,d,e){var f=UI.element(a,b,c,d,!0);f.type="scale9",e.scale=e.scale||"stretch",f.setProperties=function(a){var b=["left","top","width","height","name","type"];if(!a){var c={};return b.forEach(function(a){c[a]=f[a]}),c}b.forEach(function(b){void 0!==a[b]&&(f[b]=a[b])}),void 0!==a.img&&(e.img=a.img),void 0!==a.scale&&(e.scale=a.scale),void 0!==a.imgTop&&(e.top=a.imgTop),void 0!==a.imgBottom&&(e.bottom=a.imgBottom),void 0!==a.imgLeft&&(e.left=a.imgLeft),void 0!==a.imgRight&&(e.right=a.imgRight),f.setSize(f.width,f.height),f.setPosition(f.left,f.top)};var g=function(){var a=e.img;if(a){var b=a.width-e.left-e.right,c=a.height-e.top-e.bottom,d=f.width-e.left-e.right,g=f.height-e.top-e.bottom;if(f.clearCanvas(),e.top&&e.left&&f.ctx.drawImage(a,0,0,e.left,e.top,0,0,e.left,e.top),e.top&&f.ctx.drawImage(a,e.left,0,b,e.top,e.left,0,d,e.top),e.top&&e.right&&f.ctx.drawImage(a,e.left+b,0,e.right,e.top,e.left+d,0,e.right,e.top),e.left&&f.ctx.drawImage(a,0,e.top,e.left,c,0,e.top,e.left,g),"stretch"===e.scale&&f.ctx.drawImage(a,e.left,e.top,b,c,e.left,e.top,d,g),"repeatX"===e.scale)for(var h,i=e.left,j=e.left+d;i<j;)h=b,i+h>j&&(h=j-i),f.ctx.drawImage(a,e.left,e.top,h,c,i,e.top,h,c),i+=h;if("repeatY"===e.scale){var k=e.top;j=e.top+g;for(var l;k<j;)l=c,k+l>j&&(l=j-k),f.ctx.drawImage(a,e.left,e.top,b,l,e.left,k,b,l),k+=l}e.right&&f.ctx.drawImage(a,e.left+b,e.top,e.right,c,e.left+d,e.top,e.right,g),e.bottom&&e.left&&f.ctx.drawImage(a,0,e.top+c,e.left,e.bottom,0,e.top+g,e.left,e.bottom),e.bottom&&f.ctx.drawImage(a,e.left,e.top+c,b,e.bottom,e.left,e.top+g,d,e.bottom),e.bottom&&e.right&&f.ctx.drawImage(a,e.left+b,e.top+c,e.right,e.bottom,e.left+d,e.top+g,e.right,e.bottom)}};return f.render=function(a){if(a=!!a,f.isVisible()){if(f.needsRendering&&g(),f.needsRendering=!1,a)return f.canvas;f.parentCtx.drawImage(f.canvas,f.left,f.top)}},f},UI.submenu=function(a,b,c,d){var e,f,g,h,i=UI.element(a,b,c,d),j=["left","top","width","height","name","type"];return i.setProperties=function(a){j.forEach(function(b){void 0!==a[b]&&(i[b]=a[b])}),a.background&&(f=UI.scale9Panel(0,0,i.width,i.height,a.background),f.ignoreEvents=!0,i.addChild(f)),i.setSize(i.width,i.height),i.setPosition(i.left,i.top)},i.onHover=function(a){var b=Math.floor(i.eventY/26);b!=h&&(g=b,h=g,i.refresh())},i.onHoverExit=function(){g&&(g=void 0,h=void 0,i.refresh())},i.onClick=function(a){if(e&&e.length){var b=e[Math.floor(i.eventY/26)];b&&b.command&&(i.hide(),i.parent.refresh(),EventBus.trigger(EVENT.command,b.command))}},i.render=function(a){if(i.isVisible()){if(a=!!a,this.needsRendering){i.clearCanvas(),f&&f.render();for(var b=Y.getImage("line_hor"),c=0,d=i.width-3,h=e.length-1,j=0;j<=h;j++){var k=e[j];j==g&&(i.ctx.fillStyle="rgba(255,255,255,0.2)",i.ctx.fillRect(0,c,d,26)),k.label&&fontFT.write(i.ctx,k.label,9,c+9),c+=26,j<h&&i.ctx.drawImage(b,0,c,d,2)}}if(this.needsRendering=!1,a)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)}},i.setItems=function(a){e=a;var b=50;e.forEach(function(a){var c=a.label?9*a.label.length:0;c+=24,b=Math.max(b,c)}),i.setSize(b,26*e.length+4),f&&f.setSize(i.width,i.height),i.refresh()},i.getItems=function(){return e},i},UI.DiskOperationActions=function(){var a=UI.panel(),b=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);b.ignoreEvents=!0,a.addChild(b);var c=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);c.ignoreEvents=!0,a.addChild(c);var d=UI.label({label:"Action",font:fontSmall});a.addChild(d);var e=UI.radioGroup();return e.setProperties({align:"right",size:"med",divider:"line",type:"buttons",highLightSelection:!0}),e.setItems([{label:"load",active:!0},{label:"save",active:!1}]),e.onChange=function(a){EventBus.trigger(EVENT.diskOperationActionChange,this.getSelectedItem())},a.addChild(e),a.setLayout=function(){var f=a.width-2,g=70;a.height<100&&(g=a.height-20),UI.mainPanel&&(a.clearCanvas(),b.setProperties({left:0,top:0,height:a.height,width:a.width}),c.setProperties({left:1,top:1,height:16,width:f}),d.setProperties({left:-1,top:3,height:16,width:f}),e.setProperties({left:4,width:f-4,height:g,top:18}))},a.getAction=function(){var a=e.getSelectedIndex(),b="load";return 1==a&&(b="save"),b},a.setSelectedIndex=function(a){e.setSelectedIndex(a)},a},UI.DiskOperationSave=function(){function a(){var a=b,c=b.lastIndexOf("."),d="";c>=0&&(a=b.substr(0,c),d=b.substr(c));var e=k.getSelectedItem();e&&e.extention&&(d=e.extention),".mod"===d&&Tracker.inFTMode()&&(d=".xm"),m.setValue(a+d)}var b,c=UI.panel(),d=FILETYPE.module,e=FILETYPE.module,f=MODULETYPE.mod,g="local",h=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);h.ignoreEvents=!0,c.addChild(h);var j={};j[FILETYPE.module]=[{label:"module",active:!0,extention:".mod",fileType:FILETYPE.module},{label:"wav",active:!1,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.WAVE_PCM},{label:"mp3",active:!1,extention:".mp3",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.MP3}],j[FILETYPE.sample]=[{label:"wav 16 bit",active:!1,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RIFF_16BIT},{label:"wav 8 bit",active:!0,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RIFF_8BIT},{label:"RAW 8 bit",active:!1,extention:".sample",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RAW_8BIT}];var k=UI.radioGroup();k.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),k.setItems(j[FILETYPE.module]),k.onChange=function(b){var c=this.getSelectedItem();d=c&&c.fileType?c.fileType:FILETYPE.module,f=c&&c.fileFormat?c.fileFormat:MODULETYPE.mod,a()},c.addChild(k);var l=UI.button();l.setProperties({label:"Export",textAlign:"center",background:UI.Assets.buttonLightScale9,font:window.fontMed}),l.onClick=function(){if(e==FILETYPE.module&&(d==FILETYPE.module&&Editor.save(b,g),d==FILETYPE.sample&&BassoonProvider.renderFile(b,f===SAMPLETYPE.MP3)),e==FILETYPE.sample){var a=Tracker.getCurrentInstrument().sample;if(a){if(f===SAMPLETYPE.RAW_8BIT){var c=a.length,h=new ArrayBuffer(c),j=new BinaryStream(h,!0);j.clear(2);var k;for(i=0;i<a.length-2;i++)k=a.data[i]||0,j.writeByte(Math.round(127*k))}else j=encodeRIFFsample(a.data,f===SAMPLETYPE.RIFF_16BIT?16:8);var l=new Blob([j.buffer],{type:"application/octet-stream"});"dropbox"===g?Dropbox.putFile("/"+b,l):saveAs(l,b)}}},c.addChild(l);var m=UI.inputbox({name:"fileNameInput",height:20,onChange:function(a){b=a},backgroundImage:"panel_mid"});return c.addChild(m),c.setLayout=function(){var a=c.width-2;UI.mainPanel&&(c.clearCanvas(),h.setProperties({left:0,top:0,height:c.height,width:c.width}),m.setProperties({left:4,width:a-6,top:4}),l.setProperties({left:2,width:a,height:28,top:c.height-27}),k.setProperties({left:4,width:a-4,height:c.height-l.height-30,top:30}))},EventBus.on(EVENT.songPropertyChange,function(c){b=c.filename||"",a()}),EventBus.on(EVENT.diskOperationTargetChange,function(a){g=a,g.target&&(g=g.target),a&&a.fileType&&(e=a.fileType,e==FILETYPE.sample&&(b=Tracker.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")),e==FILETYPE.module&&(b=Tracker.getFileName()),j[e]&&(k.setItems(j[e]),k.onChange()))}),EventBus.on(EVENT.instrumentChange,function(d){c.isVisible()&&e==FILETYPE.sample&&(b=Tracker.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")||"Sample-"+Tracker.getCurrentInstrumentIndex(),a())}),EventBus.on(EVENT.trackerModeChanged,function(d){c.isVisible()&&e==FILETYPE.module&&(b=Tracker.getSong().filename||"",a())}),c},UI.DiskOperationTargets=function(){function a(a,b){var c=a.findIndex(function(a){return a.target===b});c>=0&&a.splice(c,1)}var b=UI.panel(),c=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);c.ignoreEvents=!0,b.addChild(c);var d=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);d.ignoreEvents=!0,b.addChild(d);var e=UI.label({label:"From",font:fontSmall});b.addChild(e);var f=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Modarchive:",target:"modarchive"},{label:"Modules.pl:",target:"modulespl"},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],g=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],h=[{label:"local:",target:"local",active:!0},{label:"Dropbox:",target:"dropbox"}];Host.useDropbox||(a(f,"dropbox"),a(g,"dropbox"),a(h,"dropbox"));var i=f,j="load",k=UI.radioGroup();return k.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),k.setItems(f),k.onChange=function(a){EventBus.trigger(EVENT.diskOperationTargetChange,this.getSelectedItem())},b.addChild(k),b.setLayout=function(){var a=b.width-3;if(UI.mainPanel){b.clearCanvas(),c.setProperties({left:0,top:0,height:b.height,width:b.width}),d.setProperties({left:2,top:1,height:16,width:a}),e.setProperties({left:-1,top:3,height:16,width:a});k.setProperties({width:a,height:b.height-18-2,left:2,top:18})}},b.getTarget=function(){return"bassoon"},EventBus.on(EVENT.diskOperationTargetChange,function(a){a&&a.fileType&&("save"===j?k.setItems(h):(a.fileType===FILETYPE.module&&(i=f),a.fileType===FILETYPE.sample&&(i=g),k.setItems(i)),k.setSelectedIndex(0))}),EventBus.on(EVENT.diskOperationActionChange,function(a){"save"===a.label?(e.setLabel("To"),j="save",k.setItems(h)):(e.setLabel("From"),j="load",k.setItems(i)),EventBus.trigger(EVENT.diskOperationTargetChange,k.getSelectedItem())}),EventBus.on(EVENT.dropboxConnectCancel,function(){k.setSelectedIndex(0)}),b},UI.DiskOperationType=function(){var a=UI.panel(),b=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);b.ignoreEvents=!0,a.addChild(b);var c=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);c.ignoreEvents=!0,a.addChild(c);var d=UI.label({label:"Type",font:fontSmall});a.addChild(d);var e=UI.radioGroup();return e.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),e.setItems([{label:"module",active:!0,fileType:FILETYPE.module},{label:"sample",active:!1,fileType:FILETYPE.sample}]),e.onChange=function(a){EventBus.trigger(EVENT.diskOperationTargetChange,this.getSelectedItem())},a.addChild(e),a.setLayout=function(){var f=a.width-2,g=70;a.height<100&&(g=a.height-20),UI.mainPanel&&(a.clearCanvas(),b.setProperties({left:0,top:0,height:a.height,width:a.width}),c.setProperties({left:1,top:1,height:16,width:f}),d.setProperties({left:-1,top:3,height:16,width:f}),e.setProperties({left:4,width:f-4,height:g,top:18}))},a.getType=function(){var a=e.getSelectedIndex(),b="modules";return 1==a&&(b="samples"),2==a&&(b="patterns"),b},a.setType=function(a){e.setSelectedIndex(a)},a},UI.DiskOperations=function(){function a(a,d){A.setSelectedIndex(d),n=d,a.isExpanded?(a.isExpanded=!1,b.refreshList()):(a.isExpanded=!0,a.children.length?b.refreshList():(a.children=[{title:"loading ..."}],b.refreshList(),c?c.get(a.url,function(b){o(a,b)}):FetchService.json(a.url,function(b){o(a,b)})))}var b=UI.panel();b.hide();var c,d="load",e="modules",f="",g=[],h=[],i=[],j=[],k=[],l=[],m=0,n=0,o=function(){},p=UI.scale9Panel(0,0,20,20,UI.Assets.panelMainScale9);p.ignoreEvents=!0,b.addChild(p);var q=UI.DiskOperationActions();b.addChild(q);var r=UI.DiskOperationType();b.addChild(r);var s=UI.DiskOperationTargets();b.addChild(s);var t=UI.DiskOperationSave();b.addChild(t);var u={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1,height:18,width:50},v=UI.button(),w=UI.button();w.setActive(!0),v.setProperties(u),v.setLabel("Save"),v.onDown=function(){q.setSelectedIndex(1)},b.addChild(v),w.setProperties(u),w.setLabel("Load"),w.onDown=function(){q.setSelectedIndex(0)},b.addChild(w);var x=UI.label({label:"Load module",font:fontMed});b.addChild(x);var y=UI.Assets.generate("button20_20");y.setLabel("x"),y.onClick=function(){App.doCommand(COMMAND.showTopMain)},b.addChild(y);var z=UI.Assets.generate("buttonKey");z.setLabel("browse"),z.onClick=function(){var a=document.createElement("input");a.type="file",a.onchange=function(a){Tracker.handleUpload(a.target.files)},a.click()},b.addChild(z),z.hide();var A=UI.listbox();b.addChild(A);var B=UI.button();return B.setProperties({background:UI.Assets.buttonDarkActiveScale9,image:Y.getImage("dropzone"),font:fontSmall,textAlign:"center"}),B.onClick=z.onClick,b.addChild(B),B.hide(),b.onShow=function(){b.onResize()},b.onResize=function(){if(b.isVisible()){b.clearCanvas(),p.setProperties({left:0,top:0,height:b.height,width:b.width});y.setProperties({top:3,width:20,heigth:18,left:b.width-30}),z.setProperties({top:y.top+2,width:55,height:18,left:y.left-60}),b.width>=730?(q.show(),x.show(),w.hide(),v.hide(),q.setProperties({top:5,left:Layout.col1X,width:Layout.col1W,height:b.height-10}),r.setProperties({top:5,left:Layout.col2X,width:Layout.col1W,height:b.height-10}),s.setProperties({top:5,left:Layout.col3X,width:Layout.col1W,height:b.height-10}),x.setProperties({left:Layout.col4X,top:5,height:20,width:Layout.col2W}),A.setProperties({left:Layout.col4X,width:Layout.col2W,top:24,height:b.height-24-5})):(q.hide(),x.hide(),w.show(),v.show(),w.setProperties({top:5,left:Layout.col3X}),v.setProperties({top:5,left:Layout.col3X+50}),r.setProperties({top:5,left:Layout.defaultMargin,width:Layout.col2W,height:b.height/2-5-16}),s.setProperties({top:b.height/2-16,left:Layout.defaultMargin,width:Layout.col2W,height:b.height/2+16}),A.setProperties({left:Layout.col3X,width:Layout.col3W,top:24,height:b.height-24-5})),"save"===d?(t.setProperties({left:A.left,width:A.width,top:A.top,height:A.height}),A.hide(),t.show()):(A.show(),t.hide()),B.setProperties({left:A.left,width:A.width,top:A.top,height:A.height})}},b.setView=function(a){f=a,b.refreshList("samples"===f?"samples":""),a.indexOf("_save")>0&&q.setSelectedIndex(1),a.indexOf("_load")>0&&q.setSelectedIndex(0),a.indexOf("_samples")>0&&r.setType(1),a.indexOf("_modules")>0&&r.setType(0)},b.refreshList=function(f){function p(a,b){a.forEach(function(a){var c;a.icon&&(c=Y.getImage(a.icon)),c||(c=Y.getImage("modules"===e?"module":"sample")),a.children&&(c=Y.getImage("disk")),s.push({label:a.title,data:a,level:b,index:t,icon:c,info:a.info}),g[t]=a,t++,a.children&&a.children.length&&a.isExpanded&&p(a.children,b+1)})}function q(a,b){g=[],t=0,b=b||0,p(a,0),A.setItems(s),A.setSelectedIndex(b)}if("save"!==d){var s=[],t=0;switch(e!==f&&A.setSelectedIndex(0,!0),e=f||e,"local"==e?(A.hide(),B.show(),z.show()):(A.show(),B.hide(),z.hide(),"bassoon"==e&&(e=r.getType())),e){case"modules":c=!1,x.setLabel("Load Module"),A.onClick=function(b){var c=A.getItemAtPosition(A.eventX,A.eventY);if(c&&c.data){var d=c.index;c=g[d],c.children?a(c,d):(A.setSelectedIndex(d),Tracker.load(c.url),App.doCommand(COMMAND.showTopMain))}},h.length?q(h,n):FetchService.json(Host.getBaseUrl()+"data/modules.json",function(a){a&&a.modules&&(h=a.modules,q(h,n))});break;case"modarchive":c=ModArchive,x.setLabel("Browse Modarchive"),A.onClick=function(b){var c=A.getItemAtPosition(A.eventX,A.eventY);if(c&&c.data){var d=c.index;c=g[d],c.children?a(c,d):(A.setSelectedIndex(d),Tracker.load(c.url),App.doCommand(COMMAND.showTopMain))}},o=function(a,c){c&&c.length?"... load more ..."==a.title&&a.parent?(a=a.parent,c.forEach(function(b){b.parent=a}),a.children.pop(),a.children=a.children.concat(c)):(c.forEach(function(b){b.parent=a}),a.children=c):a.children=[{title:"error loading data"}],b.refreshList()},j.length?q(j,0):(A.setItems([{label:"loading ..."}]),FetchService.json(Host.getBaseUrl()+"data/modarchive.json",function(a){a&&a.modarchive&&(j=a.modarchive,q(j,0))}));break;case"modulespl":c=ModulesPl,x.setLabel("Browse Modules.pl"),A.onClick=function(b){var c=A.getItemAtPosition(A.eventX,A.eventY);if(c&&c.data){var d=c.index;c=g[d],c.children?a(c,d):(A.setSelectedIndex(d),Tracker.load(c.url),App.doCommand(COMMAND.showTopMain))}},o=function(a,c){c&&c.length?"... load more ..."==a.title&&a.parent?(a=a.parent,c.forEach(function(b){b.parent=a}),a.children.pop(),a.children=a.children.concat(c)):(c.forEach(function(b){b.parent=a}),a.children=c):a.children=[{title:"error loading data"}],b.refreshList()},k.length?q(k,0):(A.setItems([{label:"loading ..."}]),FetchService.json(Host.getBaseUrl()+"data/modulespl.json",function(a){a&&a.modulespl&&(k=a.modulespl,q(k,0))}));break;case"dropbox":c=Dropbox,x.setLabel("Browse Your Dropbox"),UI.setStatus("Contacting Dropbox",!0),A.setItems([{label:"loading ..."}]),A.onClick=function(b){var c=A.getItemAtPosition(A.eventX,A.eventY);if(c&&c.data){var d=c.index;c=g[d],c.children?a(c,d):(A.setSelectedIndex(d),UI.setInfo(c.title),UI.setStatus("Loading from Dropbox",!0),Dropbox.getFile(c,function(a){var b=new FileReader;b.onload=function(){Tracker.processFile(b.result,c.title,function(a){UI.setStatus("Ready")})},b.readAsArrayBuffer(a)}))}},o=function(a,c){c&&c.length?(c.forEach(function(b){b.parent=a}),a.children=c):a.children=[{title:"error loading data"}],b.refreshList()},l.length?q(l,0):Dropbox.checkConnected(function(a){a?Dropbox.list("",function(a){UI.setStatus(""),l=a,q(a,0)}):Dropbox.showConnectDialog()});break;case"samples":c=!1,x.setLabel("Load Sample to slot "+Tracker.getCurrentInstrumentIndex()),A.onClick=function(a){var c=A.getItemAtPosition(A.eventX,A.eventY);if(c&&c.data){var d=c.index;c=g[d],c.children?(A.setSelectedIndex(d),m=d,c.isExpanded?(c.isExpanded=!1,b.refreshList()):(c.isExpanded=!0,c.children.length?b.refreshList():FetchService.json(c.url,function(a){a&&a.samples&&(c.children=a.samples,b.refreshList())}))):(A.setSelectedIndex(d),Tracker.load(c.url))}},o=function(a,c){c&&c.samples&&(a.children=c.samples,b.refreshList())},i.length?q(i,m):FetchService.json(Host.getBaseUrl()+"data/samples.json",function(a){a&&a.samples&&(i=a.samples,q(i,m))});break;case"local":c=!1,x.setLabel("Upload files")}}},b.playRandomSong=function(a){UI.setStatus("Fetching random song",!0),UI.setInfo(""),FetchService.json("https://www.stef.be/bassoontracker/api/random"+(a||""),function(a){a&&a.modarchive&&a.modarchive.module&&Tracker.load(a.modarchive.module.url)})},EventBus.on(EVENT.diskOperationTargetChange,function(a){var c=q.getAction();if(a&&a.target&&(a=a.target),a&&a.fileType&&(a.fileType===FILETYPE.module&&(a="modules"),a.fileType===FILETYPE.sample&&(a="samples")),void 0===a&&(a=s.getTarget()),"save"===c){d="save",e=r.getType();var f="Export Module";"samples"===e&&(f="Export Sample"),x.setLabel(f),w.isActive&&w.setActive(!1),v.isActive||v.setActive(!0),B.hide(),z.hide(),b.onResize(),"dropbox"===a&&Dropbox.checkConnected(function(a){a||Dropbox.showConnectDialog()})}else d="load",b.refreshList(a),w.isActive||w.setActive(!0),v.isActive&&v.setActive(!1)}),EventBus.on(EVENT.instrumentChange,function(a){b.isVisible()&&"samples"==e&&x.setLabel("Load Sample to slot "+Tracker.getCurrentInstrumentIndex())}),b},UI.editPanel=function(a,b,c,d,e){var f=UI.element(a,b,c,d,e);f.type="EditPanel";var g=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);f.addChild(g);for(var h=["clear","copy","paste"],i=function(a){switch(a.index){case 0:Editor.clearTrack(),UI.setStatus("Track cleared");break;case 1:Editor.clearPattern(),UI.setStatus("Pattern cleared");break;case 2:Editor.copyTrack(),UI.setStatus("Track copied");break;case 3:Editor.copyPattern(),UI.setStatus("Pattern copied");break;case 4:UI.setStatus(Editor.pasteTrack()?"Track pasted":"Nothing to paste!");break;case 5:UI.setStatus(Editor.pastePattern()?"Pattern pasted":"Nothing to paste!")}},j=[],k=0;k<6;k++){var l;l=UI.Assets.generate("buttonDark"),l.index=k,l.onClick=function(){i(this)},l.setProperties({label:"  "+h[Math.floor(k/2)],font:fontSmall,textAlign:"center",paddingTop:3}),f.addChild(l),j.push(l)}var m=["left","top","width","height","name","type"];return f.setProperties=function(a){m.forEach(function(b){if(void 0!==a[b])switch(b){default:f[b]=a[b]}}),f.setSize(f.width,f.height),f.setPosition(f.left,f.top),g.setSize(f.width,f.height);for(var b=Math.floor(f.width/2)-2,c=0;c<6;c++){j[c].setProperties({left:c%2*b+2,width:b,top:25+21*Math.floor(c/2),height:21})}},f.render=function(a){if(a=!!a,f.needsRendering){if(!f.isVisible())return;f.clearCanvas(),g.render(),window.fontMed.write(f.ctx,"↓Track",6,11,0),window.fontMed.write(f.ctx,"↓Pattern",j[1].left+6,11,0);for(var b=0;b<6;b++)j[b].render()}if(f.needsRendering=!1,a)return f.canvas;f.parentCtx.drawImage(f.canvas,f.left,f.top,f.width,f.height)},f},UI.Envelope=function(a){var b=UI.element();b.type=a;var c=UI.scale9Panel(0,0,b.width,b.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});c.ignoreEvents=!0;var d,e,f,g,h,i,j,k,l=-1;return b.onResize=function(){j=b.width/324,k=b.height/64},b.onHover=function(a){if(!f&&(l=-1,h=void 0,e&&e.enabled)){for(var c=Math.round(b.eventX/j),d=Math.round((b.height-b.eventY)/k),g=0,m=e.count;g<m;g++){var n=e.points[g]||[0,0];if(Math.abs(c-n[0])<6&&Math.abs(d-n[1])<6){l=g,h={p:e.points[g],minY:0,maxY:64},0===g?(h.minX=0,h.maxX=0):(h.minX=e.points[g-1][0],h.maxX=324,g<e.count-1&&(h.maxX=e.points[g+1][0]));break}}i!==l&&(i=l,b.refresh())}},b.onDragStart=function(a){h&&(g={startX:a.startX,startY:a.startY,pX:h.p[0],pY:h.p[1]},f=!0)},b.onDrag=function(a){if(f){g.deltaX=a.deltaX/j,g.deltaY=a.deltaY/k;var c=g.pX+g.deltaX;c=Math.min(h.maxX,c),c=Math.max(h.minX,c);var d=g.pY-g.deltaY;d=Math.min(h.maxY,d),d=Math.max(h.minY,d),h.p[0]=c,h.p[1]=d,b.refresh()}},b.onTouchUp=function(a){f=!1},b.setInstrument=function(a){d=a,e=a?a[b.type+"Envelope"]:void 0,b.refresh()},b.render=function(){if(this.needsRendering&&(c.width!==b.width&&c.setSize(b.width,b.height),b.ctx.drawImage(c.render(!0),0,0,b.width,b.height),b.ctx.lineWidth=1,"panning"===b.type&&(b.ctx.strokeStyle="#4a7c92",b.ctx.setLineDash([1,2]),i=Math.floor(b.height/2),b.ctx.beginPath(),b.ctx.moveTo(0,i),b.ctx.lineTo(b.width,i),b.ctx.stroke()),e&&e.count)){var a=b.width/324,d=b.height/64;b.ctx.strokeStyle=e.enabled?"rgba(120, 255, 50, 0.5)":"rgba(120, 120, 180, 0.5)",b.ctx.beginPath(),b.ctx.setLineDash([]);for(var f=0;f<e.count;f++){var g=e.points[f];if(g){var h=g[0]*a,i=b.height-g[1]*d,j=4,k=e.enabled?"#D2861B":"#546888";f===l&&(j=6,k="#FFFFFF"),b.ctx.fillStyle=k,0===f?b.ctx.moveTo(h,i):b.ctx.lineTo(h,i);var m=j/2;b.ctx.fillRect(h-m,i-m,j,j)}}if(b.ctx.stroke(),e.enabled){var n=e.points[e.loopStartPoint];n&&(e.sustain&&(b.ctx.strokeStyle="#67b6d2",b.ctx.setLineDash([1,2]),h=n[0]*a,b.ctx.beginPath(),b.ctx.moveTo(h,0),b.ctx.lineTo(h,b.height),b.ctx.stroke()),e.loop&&(b.ctx.strokeStyle="#d2b637",b.ctx.setLineDash([1,2]),h=n[0]*a,b.ctx.beginPath(),b.ctx.moveTo(h,0),b.ctx.lineTo(h,b.height),h=n[0]*a,b.ctx.moveTo(h,0),b.ctx.lineTo(h,b.height),b.ctx.stroke()))}}this.needsRendering=!1,b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)},b},UI.EnvelopePanel=function(a){var b=UI.panel();b.type=a;var c,d,e=!1,f=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);f.ignoreEvents=!0,b.addChild(f);var g=UI.label({label:a+" Envelope",font:fontSmall});g.onClick=function(){h.toggle()},b.addChild(g);var h=UI.checkbox();h.onToggle=function(a){d&&(d.enabled=a,k.refresh())},b.addChild(h);var i=UI.Assets.generate("button20_20");i.onDown=function(){if(d.enabled){if(d.points.length>d.count){var a=d.points[d.count-1]||[0,0],b=d.points[d.count];a[0]+10<320&&(b[0]<=a[0]&&(b[0]=a[0]+10),d.count++)}else{var c=d.points[d.points.length-1];if(c[0]+10<320){d.points.push([c[0]+10,32]),d.count=d.points.length}}k.refresh()}},i.setProperties({label:"+",width:18,height:18}),b.addChild(i);var j=UI.Assets.generate("button20_20");j.onDown=function(){d.enabled&&(d.points.length>2&&(d.count--,b.checkMax()),k.refresh())},j.setProperties({label:"-",width:18,height:18}),b.addChild(j);var k=UI.Envelope(a);b.addChild(k);var l=UI.panel(0,0,20,20),m=UI.checkbox(),n=UI.checkbox(),o=UI.spinBox(),p=UI.spinBox(),q=UI.spinBox();m.onToggle=function(a){o.setDisabled(!a),d.sustain=a,k.refresh()},n.onToggle=function(a){p.setDisabled(!a),q.setDisabled(!a),d.loop=a,k.refresh()},o.setProperties({label:" ",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontFT,onChange:function(a){d.sustainPoint=a,b.checkMax(),k.refresh()}}),p.setProperties({label:"From",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,onChange:function(a){d.loopStartPoint=a,b.checkMax(),k.refresh()}}),q.setProperties({label:"To",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,onChange:function(a){d.loopEndPoint=a,b.checkMax(),k.refresh()}});var r=UI.scale9Panel(0,0,l.width,l.height,UI.Assets.panelMainScale9);r.ignoreEvents=!0,l.addChild(r),l.addChild(o),l.addChild(p),l.addChild(q);var s=UI.label({label:"Sustain",font:fontSmall,width:60});l.addChild(s);var t=UI.label({label:"Loop",font:fontSmall,width:60});return l.addChild(t),l.addChild(m),l.addChild(n),b.addChild(l),b.setInstrument=function(b){b&&(d=b[a+"Envelope"],c=b,k.setInstrument(b),h.setState(d&&d.enabled),m.setState(d&&d.sustain),n.setState(d&&d.loop),o.setValue(d.sustainPoint||0),p.setValue(d.loopStartPoint||0),q.setValue(d.loopEndPoint||0))},b.setDisabled=function(a){e=a,b.ignoreEvents=e,b.refresh()},b.onResize=function(){l.setSize(120,b.height);var a=l.width;f.setSize(b.width-a-36,18),g.setSize(b.width-a,20),h.setPosition(2,2),g.setPosition(12,2),k.setPosition(0,20),k.setSize(b.width-a+1,b.height-22),r.setSize(l.width,l.height),l.setPosition(b.width-l.width,0),m.setPosition(4,4),s.setPosition(14,4),o.setProperties({left:10,top:20,width:100,height:28}),n.setPosition(5,50),t.setPosition(14,50),p.setProperties({left:10,top:70,width:100,height:28}),q.setProperties({left:10,top:98,width:100,height:28}),i.setPosition(f.width,f.top),j.setPosition(f.width+18,f.top)},b.renderInternal=function(){e&&(b.ctx.fillStyle="rgba(34, 49, 85, 0.4)",b.ctx.fillRect(0,0,b.width,b.height))},b.checkMax=function(){d.count&&(d.sustainPoint>=d.count&&o.setValue(d.count-1),d.loopStartPoint>=d.count&&p.setValue(d.count-1),d.loopEndPoint>=d.count&&q.setValue(d.count-1))},b},UI.fxPanel=function(a){function b(a,b){if(m&&!a.isDisabled){switch(a.getLabel()){case"volume":m.volumeValue(b);break;case"panning":m.panningValue((b-50)/50);break;case"high":m.highValue(b/100);break;case"mid":m.midValue(b/100);break;case"low":m.lowValue(b/100);break;case"lowPass":m.lowPassFrequencyValue(b/100);break;case"reverb":m.reverbValue(b)}}}function c(a,b){if(m){m.setState(a.getLabel(),b)}}var d=UI.panel();d.hide(),a=a||0;var e=UI.scale9Panel(0,0,20,20,UI.Assets.buttonDarkScale9);e.ignoreEvents=!0,d.addChild(e);for(var f=["volume","panning","high","mid","low","lowPass","reverb"],g=0,h=10,i=[],j=0,k=f.length;j<k;j++){var l=UI.knob();l.setProperties({top:g,left:h,label:f[j],disabled:j>1}),l.onChange=function(a){b(this,a)},l.onToggle=function(a){c(this,a)},d.addChild(l),i.push(l),j%2==0?h+=70:(h=10,g+=70)}var m;return Audio.filterChains&&(m=Audio.filterChains[a]),d.setLayout=function(){if(UI.mainPanel){e.setSize(d.width,d.height);var a=Math.max(1,Math.floor(d.width/70)),b=Math.floor((d.width-70*a)/2),c=Math.floor((d.width-2*b)/a),f=0;i.forEach(function(d,e){var g=e%a;d.setPosition(g*c+b,f),g===a-1&&(f+=70)})}},d},UI.InfoPanel=function(){var a,b=UI.element(),c="",d="",e="",f=UI.Assets.generate("buttonDark");f.setLabel("More info "),f.onClick=function(){a&&window.open(a)},b.addChild(f);var g=UI.animsprite(5,7,20,18,"boing",11);b.addChild(g),g.hide(),EventBus.on(EVENT.statusChange,function(f){f&&(void 0!==f.status&&(e=f.status),void 0!==f.info&&(c=f.info,d=f.source,a=f.url),void 0!==f.showSpinner&&g.toggle(!!f.showSpinner)),b.refresh()});var h=["left","top","width","height","name","type","zIndex"];return b.setProperties=function(a){h.forEach(function(c){void 0!==a[c]&&(b[c]=a[c])}),b.setSize(b.width,b.height),b.setPosition(b.left,b.top),b.setLayout&&b.setLayout(b.left,b.top,b.width,b.height)},b.setLayout=function(){var a=Layout.col1W,c="More Info";a<100&&(c="info"),a<45&&(c="i"),f.setProperties({width:Layout.col1W,height:24,top:2,left:Layout.col5X-2-b.left,label:c,font:fontFT})},b.render=function(d){if(b.isVisible()){if(d=!!d,this.needsRendering){b.clearCanvas(),a&&f.render();var h=c;e&&(h=e+": "+h);var i=6;g.isVisible()&&(g.render(),i+=20),window.fontFT.write(b.ctx,h,i,11,0)}if(this.needsRendering=!1,d)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)}},b};var Input=function(){function a(){if(i.length){var a=i.shift();if(a.source)try{a.source.stop()}catch(a){}}}var b={},c={};c.touches=[],c.mouseWheels=[];var d,e,f,g=0,h=!1,i=[],j={},k=!1,l=2,m=3,n=1,o=13;b.init=function(){function a(a){function b(b,f,g){c.isTouchDown=!0;var h=canvas.getBoundingClientRect();f-=h.left+window.pageXOffset,g-=h.top+window.pageYOffset,e=UI.getModalElement(),e?(e.eventX=f,e.eventY=g):e=UI.getEventElement(f,g),e&&d&&d.deActivate&&d.name!==e.name&&d.deActivate();var i=e?e.eventX:f,j=e?e.eventY:g,k={id:b,x:i,y:j,startX:i,startY:j,globalX:f,globalY:g,globalStartX:f,globalStartY:g,UIobject:e,isMeta:a.shiftKey||a.metaKey||a.ctrlKey||a.altKey};c.touches.push(k),k.UIobject&&(k.UIobject.onDragStart&&k.UIobject.onDragStart(k),k.UIobject.onDown&&k.UIobject.onDown(k))}if(a.preventDefault(),window.focus(),h||void 0!==Audio&&Audio.playSilence&&Audio.context&&"suspended"!==Audio.context.state&&(Audio.playSilence(),h=!0),a.touches&&a.touches.length>0)for(var f=a.changedTouches,g=0;g<f.length;g++){var i=f[g];b(i.identifier,i.pageX,i.pageY)}else{var j=p("notouch");j>=0&&c.touches.splice(j,1),b("notouch",a.pageX,a.pageY)}}function i(a){function b(a,b,d){if(a>=0){var e=c.touches[a];e.globalX=b-window.pageXOffset,e.globalY=d-window.pageYOffset,e.deltaX=e.globalX-e.globalStartX,e.deltaY=e.globalY-e.globalStartY,e.x=e.startX+e.deltaX,e.y=e.startY+e.deltaY,c.touches.splice(a,1,e),c.isTouchDown&&e.UIobject&&e.UIobject.onDrag&&(e.dragX=b,e.dragY=d,e.UIobject.onDrag(e))}}a.preventDefault();var d=canvas.getBoundingClientRect();if(a.touches&&a.touches.length>0)for(var e=a.changedTouches,g=0;g<e.length;g++){var h=e[g];b(p(h.identifier),h.pageX-d.left,h.pageY-d.top)}else{var i=a.pageX-d.left,j=a.pageY-d.top;if(b(p("notouch"),i,j),c.currentMouseX=i,c.currentMouseY=j,c.mouseMoved=(new Date).getTime(),SETTINGS.useHover){var k=UI.getEventElement(i,j);k&&k.onHover&&k.onHover(c),f&&f!=k&&f.onHoverExit&&f.onHoverExit(c,k),f=k}}}function j(a){function b(a){if(a>=0){var b=c.touches[a],d=b.startX-b.x,e=b.startY-b.y,f=Math.sqrt(d*d+e*e),g=!0;if(b.UIobject){var h=b.UIobject;h.keepSelection&&(g=!1),f<8&&h.onClick&&h.onClick(b),h.onTouchUp&&h.onTouchUp(b)}g&&f<8&&UI.clearSelection(),c.touches.splice(a,1)}}if(h||Audio&&Audio.checkState&&Audio.checkState(),c.isTouchDown=!1,a&&a.touches)for(var d=a.changedTouches,e=0;e<d.length;e++){var f=d[e];b(p(f.identifier))}else b(p("notouch"))}function m(a){a.preventDefault();var c=KEYBOARDTABLE[SETTINGS.keyboardTable]||KEYBOARDTABLE.azerty,e=a.keyCode,f=a.key,g={shift:a.shiftKey,control:a.ctrlKey,alt:a.altKey,command:a.metaKey};if(k=g.command||g.control||g.alt||g.shift,!f&&a.keyIdentifier){var h=a.keyIdentifier;h=h.replace("U+",""),f=String.fromCharCode(parseInt(h,16)).toLowerCase()}if(d&&d.onKeyDown){if(d.onKeyDown(e,a))return}switch(e){case 8:return Tracker.isRecording()?void(k?(Editor.removeNote(),Tracker.moveCurrentPatternPos(-1)):(j=Editor.getCurrentTrackPosition(),
0===j?Editor.putNote(0,0):!Tracker.inFTMode()||3!==j&&4!==j?Editor.putNoteParam(j,0):Editor.putNoteParam(j,-1),Tracker.moveCurrentPatternPos(1))):(Tracker.playPatternStep(Editor.getCurrentTrackPosition()),void Tracker.moveCurrentPatternPos(-1));case 9:return a.stopPropagation(),a.preventDefault(),void Editor.moveCursorPosition(k?-Editor.getStepsPerTrack():Editor.getStepsPerTrack());case 13:return void(Tracker.isRecording()&&k?(Editor.insertNote(),Tracker.moveCurrentPatternPos(1)):Tracker.togglePlay());case 16:break;case 27:UI.clearSelection();break;case 32:return void Tracker.toggleRecord();case 33:var i=Math.floor(Tracker.getPatternLength()/4);0===i&&(i=1);var j=Math.floor(Tracker.getCurrentPatternPos()/i)*i;return Tracker.getCurrentPatternPos()===j&&(j-=i),j<0&&(j=0),void Tracker.setCurrentPatternPos(j);case 34:return i=Math.floor(Tracker.getPatternLength()/4),0===i&&(i=1),j=Math.ceil(Tracker.getCurrentPatternPos()/i)*i,Tracker.getCurrentPatternPos()===j&&(j+=i),j>=Tracker.getPatternLength()-1&&(j=Tracker.getPatternLength()-1),void Tracker.setCurrentPatternPos(j);case 35:return void Tracker.setCurrentPatternPos(Tracker.getPatternLength()-1);case 36:return void Tracker.setCurrentPatternPos(0);case 37:return void Editor.moveCursorPosition(-1);case 38:return void Tracker.moveCurrentPatternPos(-1);case 39:return void Editor.moveCursorPosition(1);case 40:return void Tracker.moveCurrentPatternPos(1);case 46:return void(Tracker.isRecording()&&(j=Editor.getCurrentTrackPosition(),0===j?Editor.putNote(0,0):Editor.putNoteParam(j,0),Tracker.moveCurrentPatternPos(1)));case 112:case 113:case 114:case 115:case 116:case 117:case 118:return void b.setCurrentOctave(e-111);case 119:case 120:case 121:case 122:case 123:return;case 221:return}if(f&&e>40&&e<230){if(k&&e>=65&&e<=90){switch(a.stopPropagation(),a.preventDefault(),e){case 65:return void EventBus.trigger(EVENT.commandSelectAll);case 67:return void UI.copySelection(!0);case 86:return void UI.pasteSelection(!0);case 88:return void UI.cutSelection(!0);case 89:return void EventBus.trigger(EVENT.commandRedo);case 90:return void EventBus.trigger(EVENT.commandUndo)}return}var m=-1,n=c[f];"number"==typeof n&&(m=12*l+n,0===n&&(m=0)),b.handleNoteOn(m,f)}}function n(a){var c=a.key;if(!c&&a.keyIdentifier){var d=a.keyIdentifier;d=d.replace("U+",""),c=String.fromCharCode(parseInt(d,16)).toLowerCase()}var e=a.keyCode;if(y(e)&&(k=!1),c&&e>40&&e<200){var f=KEYBOARDTABLE[SETTINGS.keyboardTable]||KEYBOARDTABLE.azerty,g=f[c];if("number"==typeof g)return b.handleNoteOff(12*l+g)}}function o(a){if(c.currentMouseX){var b=c.currentMouseX,d=c.currentMouseY,e=UI.getEventElement(b,d);if(e&&e.onMouseWheel){var f=a.wheelDeltaY||a.wheelDelta||-a.detail;c.mouseWheels.unshift(f),c.mouseWheels.length>10&&c.mouseWheels.pop(),e.onMouseWheel(c)}}}function q(a){a.stopPropagation(),a.preventDefault()}function r(a){a.stopPropagation(),a.preventDefault()}function s(a){a.stopPropagation(),a.preventDefault(),Tracker.handleUpload(a.dataTransfer.files)}function t(){App.isPlugin||(clearTimeout(g),g=setTimeout(function(){UI.setSize(window.innerWidth,window.innerHeight)},100))}function u(a){UI.pasteSelection(!0)}function v(a){UI.copySelection(!0)}function w(a){UI.cutSelection(!0)}function x(a){}function y(a){return 16===a||17===a||18===a||91===a||93===a}canvas.addEventListener("mousedown",a,!1),canvas.addEventListener("mousemove",i,!1),canvas.addEventListener("mouseup",j,!1),canvas.addEventListener("touchstart",a,!1),canvas.addEventListener("touchmove",i,!1),canvas.addEventListener("touchend",j,!1),window.navigator.msPointerEnabled&&(canvas.addEventListener("MSPointerDown",a,!1),canvas.addEventListener("MSPointerMove",i,!1),canvas.addEventListener("MSPointerEnd",j,!1)),canvas.addEventListener("mousewheel",o,!1),canvas.addEventListener("DOMMouseScroll",o,!1),window.addEventListener("keydown",m,!1),window.addEventListener("keyup",n,!1),canvas.addEventListener("dragenter",q,!1),canvas.addEventListener("dragover",r,!1),canvas.addEventListener("drop",s,!1),window.addEventListener("paste",u,!1),window.addEventListener("copy",v,!1),window.addEventListener("cut",w,!1),window.addEventListener("delete",x,!1),App.isPlugin||window.addEventListener("resize",t,!1),t()};var p=function(a){for(var b=0;b<c.touches.length;b++)if(c.touches[b].id===a)return b;return-1};return b.setFocusElement=function(a){d&&d.deActivate&&d.deActivate(),d=a},b.clearFocusElement=function(){d&&d.deActivate&&d.deActivate(),d=void 0},b.clearInputNotes=function(){for(;i.length;)a()},b.getCurrentOctave=function(){return l},b.setCurrentOctave=function(a){a<=m&&a>=n&&(l=a,EventBus.trigger(EVENT.octaveChanged,l))},b.handleNoteOn=function(b,c,d){var e,f,g,h,k=!0;if(b>=0&&(o=b,UI.clearSelection(),f=Math.floor((b-1)/12)+1,g=(b-1)%12+1,h=OCTAVENOTES[g]))if(Tracker.inFTMode())if("OFF"===h.name)e={period:1,index:0},k=!1;else{var l=FTNotes[b];l&&(e={period:l.period,index:b})}else{var m=h.name+(f-1);e=NOTEPERIOD[m]}if(Tracker.isRecording())if(Editor.getCurrentTrackPosition()>0){k=!1;var n=/[0-9A-Fa-f]/g,p=-1;if(c=c||"",n.test(c)?p=parseInt(c,16):Tracker.inFTMode()&&5===Editor.getCurrentTrackPosition()&&(n=/[0-9A-Za-z]/g,n.test(c)&&(p=parseInt(c,36))),Tracker.inFTMode()&&3===Editor.getCurrentTrackPosition())switch(p=-1,c){case"0":p=0;break;case"1":p=1;break;case"2":p=2;break;case"3":p=3;break;case"4":p=4;break;case"-":p=5;break;case"+":p=6;break;case"d":case"D":p=7;break;case"u":case"U":p=8;break;case"s":case"S":p=9;break;case"v":case"V":p=10;break;case"p":case"P":p=11;break;case"<":p=12;break;case">":p=13;break;case"M":p=14}p>255&&(p=-1),p>=0&&(Editor.putNoteParam(Editor.getCurrentTrackPosition(),p),Tracker.moveCurrentPatternPos(1))}else{if(j[b])return;e&&(Editor.putNote(Tracker.getCurrentInstrumentIndex(),e.period,e.index),Tracker.isPlaying()||Tracker.moveCurrentPatternPos(1))}if(k&&e){if(j[b])return;var q=Tracker.getCurrentInstrument();if(q){if(e.index&&(q.setSampleForNoteIndex(e.index),q.sample.relativeNote)){e.index+=q.sample.relativeNote;var r=FTNotes[e.index];r&&(e.period=r.period)}Audio.checkState();var s=void 0;d&&(s={offset:{value:d}}),j[b]=q.play(e.index,e.period,void 0,void 0,s),j[b].instrument=q,j[b].isKey=!0,i.push(j[b]);var e=j[b];if(e.scheduled&&e.scheduled.vibrato){e.scheduled.vibrato+=q.scheduleAutoVibrato(e,2)}i.length>64&&a(),EventBus.trigger(EVENT.pianoNoteOn,b)}}},b.handleNoteOff=function(a){if(!SETTINGS.sustainKeyboardNotes&&j[a]&&j[a].source&&Audio.context){EventBus.trigger(EVENT.pianoNoteOff,a);try{j[a].instrument?j[a].instrument.noteOff(Audio.context.currentTime,j[a]):j[a].source.stop()}catch(a){}}j[a]=!1},b.isMetaKeyDown=function(){return k},b.getPrevIndex=function(){return o},EventBus.on(EVENT.second,function(){if(Audio.context){var a=Audio.context.currentTime;i.forEach(function(b){if(b&&b.time&&b.scheduled){if(b.scheduled.volume&&a+2>=b.scheduled.volume&&b.instrument){var c=b.instrument.scheduleEnvelopeLoop(b.volumeEnvelope,b.scheduled.volume,2);b.scheduled.volume+=c}b.scheduled.panning&&a+2>=b.scheduled.panning&&b.instrument&&(c=b.instrument.scheduleEnvelopeLoop(b.panningEnvelope,b.scheduled.panning,2),b.scheduled.panning+=c),b.scheduled.vibrato&&a+2>=b.scheduled.vibrato&&b.instrument&&(c=b.instrument.scheduleAutoVibrato(b,2),b.scheduled.vibrato+=c)}})}}),EventBus.on(EVENT.trackerModeChanged,function(a){Tracker.inFTMode()?(m=7,n=0,b.setCurrentOctave(l+2)):(m=3,n=1,b.setCurrentOctave(Math.min(Math.max(l-2,n),m)))}),b}();UI.MainPanel=function(){var a=UI.panel(0,0,canvas.width,canvas.height,!0);a.setProperties({backgroundColor:"#071028"}),a.name="mainPanel";var b={},c=UI.app_menu(a);a.addChild(c);var d=UI.app_mainPanel();a.addChild(d);var e=UI.app_controlPanel();a.addChild(e);var f=UI.app_patternPanel();a.addChild(f);var g=UI.app_sidebar();Layout.showAppSideBar&&a.addChild(g);var h=UI.app_pianoView();return h.hide(),a.addChild(h),a.createContextMenu=function(c){var d=b[c.name];return d||(d=UI.menu(100,100,128,42,a),d.zIndex=100,d.setProperties({background:UI.Assets.panelMainScale9,layout:"buttons"}),d.setItems(c.items),d.hide(),a.addChild(d),b[c.name]=d),d},a.onResize=function(){Layout.setLayout(a.width,a.height),c.setSize(Layout.mainWidth,c.height);var b=c.height;d.setSize(Layout.mainWidth,d.height),d.setPosition(Layout.mainLeft,b),b+=d.height,e.setSize(Layout.mainWidth,Layout.controlPanelHeight),e.setPosition(Layout.mainLeft,b),b+=e.height;var i=a.height-b;h.isVisible()&&(h.setSize(Layout.mainWidth,Layout.pianoHeight),h.setPosition(Layout.mainLeft,a.height-h.height),i-=h.height),f.setPosition(Layout.mainLeft,b),f.setSize(Layout.mainWidth,i),g.setPosition(0,0),g.setSize(Layout.sidebarWidth,a.height)},a.sortZIndex(),a.onResize(),EventBus.on(EVENT.toggleView,function(b){if("piano"===b){h.toggle();var c=a.height-f.top;h.isVisible()&&(h.setSize(Layout.mainWidth,Layout.pianoHeight),h.setPosition(Layout.mainLeft,a.height-h.height),c-=h.height),f.setSize(Layout.mainWidth,c)}"sidebar"===b&&(Layout.showAppSideBar=!Layout.showAppSideBar,Layout.setLayout(),a.onResize())}),EventBus.on(EVENT.showContextMenu,function(b){var c=a.createContextMenu(b),d=b.x;d+c.width>Layout.mainWidth&&(d=Layout.mainWidth-c.width),c.setPosition(d,b.y-c.height-2),c.show(),a.refresh()}),EventBus.on(EVENT.hideContextMenu,function(){for(var c in b)b[c].hide();a.refresh()}),a},UI.OptionsPanel=function(){var a=UI.panel();a.hide();var b=UI.scale9Panel(0,0,20,20,UI.Assets.panelMainScale9);b.ignoreEvents=!0,a.addChild(b),a.addChild(UI.label({label:"Options:",font:fontMed,left:5,height:18,top:9,width:200}));var c=UI.Assets.generate("button20_20");c.setLabel("x"),c.onClick=function(){App.doCommand(COMMAND.showTopMain)},a.addChild(c);var d=[{label:"VU bars",values:["NONE","COLOURS: AMIGA","TRANSPARENT"],setValue:function(a){SETTINGS.vubars=0===a?"none":2===a?"trans":"colour",Settings.saveSettings()},getValue:function(){var a=1;return"none"===SETTINGS.vubars&&(a=0),"trans"===SETTINGS.vubars&&(a=2),a}},{label:"Stereo",values:["Hard: Amiga","Balanced","None: mono"],setValue:function(a){Audio.setStereoSeparation(0===a?STEREOSEPARATION.FULL:2===a?STEREOSEPARATION.NONE:STEREOSEPARATION.BALANCED),Settings.saveSettings()},getValue:function(){var a=1;return SETTINGS.stereoSeparation===STEREOSEPARATION.NONE&&(a=2),SETTINGS.stereoSeparation===STEREOSEPARATION.FULL&&(a=0),a}},{label:"Keyboard Layout",labels:[{width:56,label:"Keyboard"},{width:110,label:"Keyboard Layout"}],values:["QWERTY","AZERTY","QWERTZ","Dvorak"],setValue:function(a){SETTINGS.keyboardTable=0===a?"qwerty":1===a?"azerty":2===a?"qwertz":"dvorak",Settings.saveSettings()},getValue:function(){var a=0;return"azerty"===SETTINGS.keyboardTable&&(a=1),"qwertz"===SETTINGS.keyboardTable&&(a=2),"dvorak"===SETTINGS.keyboardTable&&(a=3),a}},{label:"Screen refresh",labels:[{width:56,label:"Screen"},{width:100,label:"Screen refresh"}],values:["Smooth","Normal","Economical","Low CPU"],setValue:function(a){UI.skipFrame(a),Settings.saveSettings()},getValue:function(){return UI.getSkipFrame()}},{label:"Frequency table",labels:[{width:56,label:"Frequency"},{width:110,label:"Frequency table"}],values:["Linear","Amiga periods"],setValue:function(a){Tracker.useLinearFrequency=0===a},getValue:function(){return Tracker.useLinearFrequency?0:1}},{label:"Dropbox: existing file",labels:[{width:20,label:"Dropbox"},{width:80,label:"Dropbox save"},{width:160,label:"Dropbox existing file"}],values:["Rename","Overwrite"],setValue:function(a){SETTINGS.dropboxMode=0===a?"rename":"overwrite",Settings.saveSettings()},getValue:function(){var a=0;return"overwrite"===SETTINGS.dropboxMode&&(a=1),a}}];return d.forEach(function(b){var c=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);c.ignoreEvents=!0,a.addChild(c);var d=UI.label();d.setProperties({label:b.label,labels:b.labels,font:fontSmall,textAlign:"center"}),a.addChild(d),b.labelBox=c,b.label=d;for(var e=[],f=b.getValue(),g=0;g<b.values.length;g++){var h,i=b.values[g];i&&(h=UI.Assets.generate("buttonKey"),h.setProperties({label:i}),h.setActive(g===f),h.index=g,h.option=b,h.onClick=function(){this.isDisabled||activateOption(this)}),a.addChild(h),e.push(h)}b.buttons=e}),activateOption=function(a){var b=a.option;b.buttons.forEach(function(a){a.setActive(!1)}),a.setActive(!0),b.setValue(a.index)},a.onShow=function(){a.onResize()},a.onResize=function(){if(a.isVisible()){a.clearCanvas(),b.setProperties({left:0,top:0,height:a.height,width:a.width});c.setProperties({top:5,left:a.width-30});var e=[27,103],f=26,g=20,h=0,i=0,j=!1,k=d.length,l=d.length;a.width<600&&(j=!0,e=[27,103],f=18,g=18,l=4);var m=Math.floor((a.width-Layout.defaultMargin*(l+1))/l);d.forEach(function(b,c){var d=Layout.defaultMargin+h*(m+Layout.defaultMargin),l=e[i];c>=k&&(d=a.width+100),b.labelBox.setProperties({top:l,width:m,height:f,left:d}),b.label.setProperties({top:l+3,_width:Layout.col31W,width:m,height:f,left:d+2});for(var n=b.getValue(),o=0;o<b.buttons.length;o++){var p=b.buttons[o];p.setProperties({top:l+o*g+f,height:g,width:m,left:d}),p.setActive(o===n)}h++,j&&h>=4&&(h=0,i++)})}},EventBus.on(EVENT.songPropertyChange,function(){a.isVisible()&&a.onResize()}),EventBus.on(EVENT.trackerModeChanged,function(){var b=d[4];b.buttons&&b.buttons.length&&b.buttons.forEach(function(a){a.setDisabled(!Tracker.inFTMode())});var c=d[1];c.buttons&&c.buttons.length&&c.buttons.forEach(function(a){a.setDisabled(Tracker.inFTMode())}),a.isVisible()&&a.onResize()}),a},UI.SampleView=function(){function a(a){var b=Tracker.getCurrentInstrument();if(b)if(16===a)b.sample.bits=16,k.setActive(!1),l.setActive(!0);else{for(var c=0,d=b.sample.data.length;c<d;c++)b.sample.data[c]=Math.round(127*b.sample.data[c])/127;b.sample.bits=8,k.setActive(!0),l.setActive(!1)}}function b(a){"loop"===a?(x.show(),v.show(),u.show(),y.hide(),z.hide(),A.hide(),N.setActive(),P.setActive(!1),C.forEach(function(a){a.hide()})):(x.hide(),v.hide(),u.hide(),y.show(),z.show(),A.show(),N.setActive(!1),P.setActive(),C.forEach(function(a){a.show()})),f=a,d.onResize()}function c(a){C.forEach(function(b,c){b.setActive(a===c)});var b=Tracker.getCurrentInstrument();b&&(b.vibrato.type=a)}var d=UI.panel();d.hide();var e,f="loop",g=window.fontMed;g=window.fontCondensed;var h=UI.inputbox({name:"instrumentName",height:20,onChange:function(a){if(e){var b=Tracker.getInstrument(e);b&&(b.name=a),EventBus.trigger(EVENT.instrumentNameChange,e)}}});d.addChild(h);var i=UI.Assets.generate("button20_20");i.setLabel("x"),i.onClick=function(){App.doCommand(COMMAND.showBottomMain)},d.addChild(i);var j={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},k=UI.button(),l=UI.button();k.setProperties(j),k.setLabel("8"),k.setActive(!0),k.onDown=function(){a(8)},d.addChild(k),l.setProperties(j),l.setLabel("16"),l.onDown=function(){a(16)},d.addChild(l);var m=UI.WaveForm();d.addChild(m);var n=UI.EnvelopePanel("volume");d.addChild(n);var o=UI.EnvelopePanel("panning");d.addChild(o);var p=new UI.panel;p.setProperties({name:"instrumentSideButtonPanel"});var q=UI.spinBox({name:"Instrument",label:"",value:1,max:64,padLength:2,min:1,font:g,onChange:function(a){Tracker.setCurrentInstrumentIndex(a)}});d.addChild(q);var r=UI.sliderBox({label:"Volume",font:g,height:200,width:40,value:64,max:64,min:0,step:1,vertical:!0,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.sample.volume=a)}});p.addChild(r);var s=UI.sliderBox({name:"Finetune",label:"Finetune",font:g,value:0,max:7,min:-8,step:1,vertical:!0,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&b.setFineTune(a)}});p.addChild(s);var t=UI.sliderBox({name:"Panning",label:"Panning",font:g,value:0,max:127,min:-127,vertical:!0,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.panning=a,b.sample.panning=a)}});p.addChild(t);var u=UI.spinBox({name:"Repeat",label:"Start",value:0,max:65535,min:0,step:2,font:g,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.sample.loop.length+a>b.sample.length&&(a=b.sample.length-b.sample.loop.length,u.setValue(a,!0)),b.sample.loop.start=a),m.refresh()}});p.addChild(u);var v=UI.spinBox({name:"Repeat Length",label:"Length",value:0,max:65535,min:0,step:2,font:g,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.sample.loop.start+a>b.sample.length&&(a=b.sample.length-b.sample.loop.start,v.setValue(a,!0)),b.sample.loop.length=a),EventBus.trigger(EVENT.samplePropertyChange,{interal_loopLength:a}),m.refresh()}});p.addChild(v);var w=UI.sliderBox({name:"Fadeout",label:"Fadeout",value:0,max:4095,min:0,step:1,font:g,vertical:!0,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.fadeout=a)}});p.addChild(w);var x=UI.spinBox({name:"relativeNote",label:"RelativeNote",value:0,max:128,min:-127,step:1,font:g,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.sample.relativeNote=a)}});p.addChild(x);var y=UI.spinBox({name:"vibratoSpeed",label:"Vib Speed",value:0,max:63,min:0,step:1,font:g,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.vibrato.rate=a)}});p.addChild(y),y.hide();var z=UI.spinBox({name:"vibratoDepth",label:"Vib Depth",value:0,max:15,min:0,step:1,font:g,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.vibrato.depth=a)}});p.addChild(z),z.hide();var A=UI.spinBox({name:"vibratoSweep",label:"Vib Sweep",value:0,max:255,min:0,step:1,font:g,onChange:function(a){var b=Tracker.getCurrentInstrument();b&&(b.vibrato.sweep=a)}});p.addChild(A),A.hide();var B=["sin","square","saw","saw_inverse"],C=[];B.forEach(function(a,b){var d=UI.button();d.setProperties({background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,image:Y.getImage("wave_"+a),activeImage:Y.getImage("wave_"+a),isActive:!1}),d.onDown=function(){c(b)},d.hide(),p.addChild(d),C.push(d)}),c(0),d.addChild(p);var D=[],E=[{label:"Load",onClick:function(){EventBus.trigger(EVENT.showView,"diskop_samples_load")}},{label:"Play",onDown:function(){Input.handleNoteOn(Input.getPrevIndex())},onUp:function(){Input.handleNoteOff(Input.getPrevIndex()),Input.clearInputNotes(),m.stop()}},{label:"Range",onDown:function(){m.playSection("range")},onUp:function(){Input.handleNoteOff(Input.getPrevIndex()),Input.clearInputNotes(),m.stop()}},{label:"Loop",onDown:function(){m.playSection("loop")},onUp:function(){Input.handleNoteOff(Input.getPrevIndex()),Input.clearInputNotes(),m.stop()}},{label:"Stop",onClick:function(){Input.clearInputNotes(),m.stop()}},{label:"More",onClick:function(){J.toggle(),K.toggle(),L.toggle(),M.toggle(),n.toggle(),o.toggle(),d.refresh()}}],F=[{label:"Zoom In",width:62,onClick:function(){m.zoom(2)}},{label:"Out",width:38,onClick:function(){m.zoom(.5)}},{label:"All",width:50,onClick:function(){m.zoom(1)}},{value:0,width:50,type:"number",onSamplePropertyChange:function(a,b){void 0!==b.sampleLength&&a.setValue(b.sampleLength)}},{label:"Loop",width:50,onClick:function(){m.zoom("loop")}},{value:0,width:50,type:"number",onSamplePropertyChange:function(a,b){void 0!==b.loopLength&&a.setValue(b.loopLength),void 0!==b.interal_loopLength&&a.setValue(b.interal_loopLength)}},{label:"Range",width:50,onClick:function(){m.zoom("range")}},{value:"0",width:50,type:"number",onSamplePropertyChange:function(a,b){void 0!==b.rangeLength&&a.setValue(b.rangeLength)}}],G=[{label:"Reverse",onClick:function(){m.reverse()}},{label:"Invert",onClick:function(){m.invert()}},{label:"Upsample",onClick:function(){m.resample("up")}},{label:"DownSample",onClick:function(){m.resample("down")}}],H=[{label:"Maximize",onClick:function(){m.adjustVolume("max")}},{label:"Fade In",width:62,onClick:function(){m.adjustVolume("fadein")}},{label:"Out",width:38,onClick:function(){m.adjustVolume("fadeout")}},{label:"-5%",width:50,onClick:function(){m.adjustVolume(-5)}},{label:"+5%",width:50,onClick:function(){m.adjustVolume(5)}},{label:"-10%",width:50,onClick:function(){m.adjustVolume(-10)}},{label:"+10%",width:50,onClick:function(){m.adjustVolume(10)}}],I=[{label:"[",width:15,onClick:function(){m.select("start")}},{label:"All",width:70,onClick:function(){m.select("all")}},{label:"]",width:15,onClick:function(){m.select("end")}},{label:"None",width:50,onClick:function(){m.select("none")}},{label:"Loop",width:50,onClick:function(){m.select("loop")}},{label:"Cut",width:50,onClick:function(){UI.cutSelection()}},{label:"Copy",width:50,onClick:function(){UI.copySelection()}},{label:"Paste",onClick:function(){UI.pasteSelection()}}];E.forEach(function(a){var b=UI.Assets.generate("buttonLight");b.setLabel(a.label),b.onClick=a.onClick,b.onDown=a.onDown,b.onTouchUp=a.onUp,d.addChild(b),D.push(b)});var J=UI.buttonGroup("Display",F),K=UI.buttonGroup("Select",I),L=UI.buttonGroup("Edit",G),M=UI.buttonGroup("Volume",H);d.addChild(J),d.addChild(K),d.addChild(L),d.addChild(M);var N=UI.button();N.setProperties({background:UI.Assets.panelDarkGreyScale9,activeBackground:UI.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Loop",font:fontSmall,paddingTop:2,paddingTopActive:2,paddingLeft:20}),N.onDown=function(){b("loop")},d.addChild(N);var O=UI.checkbox();O.onToggle=function(a){var b=Tracker.getInstrument(e);b&&(b.sample.loop.enabled=a),u.setDisabled(!a),v.setDisabled(!a),m.refresh()},d.addChild(O);var P=UI.button();return P.setProperties({background:UI.Assets.panelDarkGreyScale9,activeBackground:UI.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Vibrato",font:fontSmall,paddingTop:2,paddingTopActive:2}),P.onDown=function(){b("vibrato")},d.addChild(P),d.onShow=function(){d.onResize()},d.onResize=function(){if(d.isVisible()){d.clearCanvas();var a=p.height-130-10,b=Math.ceil(p.width/4),c=0,e=2*b;p.width<170&&(b=Math.ceil(p.width/2),a=Math.floor(a/2),c=a,e=0),m.setPosition(Layout.col2X,20+Layout.defaultMargin+8),m.setSize(Layout.col4W,d.height-m.top-130-28-8),n.setPosition(Layout.col2X,m.top+m.height+Layout.defaultMargin+30),n.setSize(Layout.col2W,130),o.setPosition(Layout.col4X,n.top),o.setSize(Layout.col2W,130),L.setSize(Layout.col1W,130),J.setSize(Layout.col1W,130),K.setSize(Layout.col1W,130),M.setSize(Layout.col1W,130),J.setPosition(Layout.col2X,m.top+m.height+Layout.defaultMargin+30),K.setPosition(Layout.col3X,J.top),L.setPosition(Layout.col4X,J.top),M.setPosition(Layout.col5X,J.top);var f=0,g=100;Tracker.inFTMode()&&(f=40,g=0),h.setProperties({top:Layout.defaultMargin,left:Layout.col2X+71,width:Layout.col4W-71-25-Layout.defaultMargin-f}),i.setProperties({top:Layout.defaultMargin,left:h.left+h.width+Layout.defaultMargin+f}),k.setProperties({top:Layout.defaultMargin,width:20,height:20,left:h.left+h.width+Layout.defaultMargin-2+g}),l.setProperties({top:Layout.defaultMargin,width:20,height:20,left:h.left+h.width+Layout.defaultMargin+18+g}),p.setProperties({left:0,top:0,width:Layout.col1W,height:d.height}),q.setProperties({left:Layout.col2X,top:1,width:68,height:28}),r.setProperties({left:0,top:0,width:b,height:a}),s.setProperties({left:b,top:0,width:b,height:a}),w.setProperties({left:e,top:c,width:b,height:a}),t.setProperties({left:e+b,top:c,width:b,height:a});var j=m.top+m.height+Layout.defaultMargin,B=Layout.col4W/D.length;D.forEach(function(a,b){a.setProperties({width:B,height:28,left:Layout.col2X+B*b,top:j})}),N.setProperties({width:Layout.col1W/2,height:18,left:2,top:n.top}),O.setPosition(N.left+2,N.top+2),P.setProperties({width:N.width,height:N.height,left:N.left+N.width,top:N.top});u.setProperties({left:0,top:N.top+24,width:Layout.col1W,height:34}),v.setProperties({left:0,top:N.top+24+34,width:Layout.col1W,height:34}),x.setProperties({left:0,top:N.top+24+68,width:Layout.col1W,height:34}),y.setProperties({left:0,top:P.top+22,width:Layout.col1W,height:30}),z.setProperties({left:0,top:P.top+22+30,width:Layout.col1W,height:30}),A.setProperties({left:0,top:P.top+22+60,width:Layout.col1W,height:30});var E=Math.floor((Layout.col1W-4)/4),F=Layout.col1W-4*E;C.forEach(function(a,b){a.setProperties({left:F+b*E,top:P.top+22+90,width:E,height:17})})}},EventBus.on(EVENT.instrumentChange,function(a){e=a,q.setValue(a,!0);var b=Tracker.getInstrument(a);b?(h.setValue(b.name,!0),s.setValue(b.getFineTune()),w.setValue(b.fadeout||0),y.setValue(b.vibrato.rate||0),z.setValue(b.vibrato.depth||0),A.setValue(b.vibrato.sweep||0),c(b.vibrato.type||0),b.sample&&(u.setMax(b.sample.length,!0),v.setMax(b.sample.length,!0),r.setValue(b.sample.volume),t.setValue(b.sample.panning||0),u.setValue(b.sample.loop.start,!0),v.setValue(b.sample.loop.length,!0),x.setValue(b.sample.relativeNote),O.setState(b.sample.loop.enabled),8===b.sample.bits?(k.setActive(!0),l.setActive(!1)):(k.setActive(!1),l.setActive(!0))),m.setInstrument(b),n.setInstrument(b),o.setInstrument(b)):(m.setInstrument(),n.setInstrument(),o.setInstrument(),h.setValue("",!0),r.setValue(0),t.setValue(0),s.setValue(0),u.setValue(0),v.setValue(0),x.setValue(0),w.setValue(0))}),EventBus.on(EVENT.samplePlay,function(a){d.visible&&a&&a.instrumentIndex===e&&m.play(a.startPeriod)}),EventBus.on(EVENT.songPropertyChange,function(a){q.setMax(a.instruments.length-1)}),EventBus.on(EVENT.trackerModeChanged,function(a){s.setMax(a===TRACKERMODE.PROTRACKER?7:127,!0),s.setMin(a===TRACKERMODE.PROTRACKER?-8:-128,!0);var c=Tracker.getInstrument(e);c&&s.setValue(c.getFineTune(),!0),n.setDisabled(!Tracker.inFTMode()),o.setDisabled(!Tracker.inFTMode()),x.setDisabled(!Tracker.inFTMode()),y.setDisabled(!Tracker.inFTMode()),z.setDisabled(!Tracker.inFTMode()),A.setDisabled(!Tracker.inFTMode()),w.setDisabled(!Tracker.inFTMode()),t.setDisabled(!Tracker.inFTMode()),q.setMax(Tracker.getMaxInstruments()),a===TRACKERMODE.PROTRACKER?(u.setProperties({step:2}),v.setProperties({step:2}),c&&(c.sample.loop.start=2*Math.floor(c.sample.loop.start/2),c.sample.loop.length=2*Math.floor(c.sample.loop.length/2),u.setValue(c.sample.loop.start,!0),v.setValue(c.sample.loop.length,!0)),b("loop")):(u.setProperties({step:1}),v.setProperties({step:1})),d.onResize()}),EventBus.on(EVENT.samplePropertyChange,function(a){Tracker.getInstrument(e)&&(void 0!==a.loopStart&&u.setValue(a.loopStart),void 0!==a.loopLength&&v.setValue(a.loopLength))}),EventBus.on(EVENT.sampleIndexChange,function(a){if(d.visible&&a===e){Tracker.getInstrument(e);EventBus.trigger(EVENT.instrumentChange,e)}}),d},UI.sliderBox=function(a){function b(){for(var a=""+j;a.length<n;)a=o+a;return a}function c(a){void 0!==a.name&&(d.name=a.name),void 0!==a.left&&(d.left=a.left),void 0!==a.top&&(d.top=a.top),void 0!==a.width&&(d.width=a.width),void 0!==a.height&&(d.height=a.height),void 0!==a.label&&(i=a.label),void 0!==a.value&&(j=a.value),void 0!==a.font&&(e=a.font),void 0!==a.min&&(k=a.min),void 0!==a.max&&(l=a.max),void 0!==a.step&&(m=a.step),void 0!==a.onChange&&(g=a.onChange),void 0!==a.vertical&&(h=!!a.vertical,x&&x.setProperties({vertical:h}))}var d=UI.element();d.type="sliderBox";var e,f,g,h,i="",j=0,k=0,l=100,m=1,n=4,o=" ",p=0,q=0,r=0,s=0,t=10,u=10,v=!1,w=Y.getImage("line_ver");a&&c(a),l>9999&&(n=5);var x=UI.rangeSlider({min:k,max:l,height:20,width:20,vertical:!!h,onChange:function(a){j=a,g&&g(a)}});return d.addChild(x),d.setProperties=function(a){if(!a)return f;f=a||{},c(f),d.setSize(d.width,d.height),d.setPosition(d.left,d.top)},d.setValue=function(a,b){j=a,x.setValue(j,b),d.refresh(),!b&&g&&g(j)},d.getValue=function(){return j},d.setMax=function(a,b){l=a,!b&&j>l&&d.setValue(l),x.setMax(l,b)},d.setMin=function(a,b){k=a,!b&&j<k&&d.setValue(k),x.setMin(k,b)},d.setDisabled=function(a){v=a,d.refresh(),d.ignoreEvents=v},d.render=function(a){if(a=!!a,d.needsRendering&&(d.clearCanvas(),d.ctx.drawImage(Y.getImage("panel_inset_dark"),r,s,t,u),window.fontLed.write(d.ctx,b(),r+4,s+2,0),x.render(),e?e.write(d.ctx,i,p,q,0):(d.ctx.fillStyle="white",d.ctx.fillText(i,p,q)),h&&d.ctx.drawImage(w,d.width-2,0,2,d.height),v&&(d.ctx.fillStyle="rgba(34, 49, 85, 0.6)",d.ctx.fillRect(1,0,d.width-1,d.height))),d.needsRendering=!1,a)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top,d.width,d.height)},d.onMouseWheel=function(a){a.mouseWheels[0]>0?(j++,j>l&&(j=l),d.setValue(j)):(j--,j<k&&(j=k),d.setValue(j))},x.onMouseWheel=d.onMouseWheel,d.onResize=function(){t=40,u=19,5==n&&(t=48,r-=8),h?(x.setSize(20,d.height-36),x.setPosition(Math.floor((d.width-20)/2),0),r=Math.floor((d.width-40)/2),s=d.height-32,p=Math.floor((d.width-e.getTextWidth(i,0))/2),q=d.height-10):(x.setSize(d.width,20),x.setPosition(0,d.height-20),r=d.width-40,s=2)},d},UI.spinBox=function(a){function b(){for(var a=""+k;a.length<o;)a=p+a;return a}function c(a){void 0!==a.size&&(i=a.size),void 0!==a.name&&(d.name=a.name),void 0!==a.left&&(d.left=a.left),void 0!==a.top&&(d.top=a.top),void 0!==a.width&&(d.width=a.width),void 0!==a.height&&(d.height=a.height),void 0!==a.label&&(j=a.label),void 0!==a.labels&&(e=a.labels),void 0!==a.value&&(k=a.value),void 0!==a.font&&(f=a.font),void 0!==a.min&&(l=a.min),void 0!==a.max&&(m=a.max),void 0!==a.step&&(n=a.step),void 0!==a.onChange&&(h=a.onChange),void 0!==a.padLength&&(o=a.padLength),void 0!==a.disabled&&(q=!!a.disabled)}var d=UI.element();d.type="spinBox";var e,f,g,h,i="medium",j="",k=0,l=0,m=100,n=1,o=4,p=" ",q=!1;a&&c(a),m>9999&&(o=5);var r=UI.Assets.generate("button20_20");r.onDown=function(){q||(k-=n,k<l&&(k=l),d.setValue(k),UI.ticker.onEachTick4(function(){k-=n,k<l&&(k=l),d.setValue(k)},10))},r.onTouchUp=function(){UI.ticker.onEachTick4()},r.setProperties({name:"buttonDown",label:"↓"}),d.addChild(r);var s=UI.Assets.generate("button20_20");return s.onDown=function(){q||(k+=n,k>m&&(k=m),d.setValue(k),UI.ticker.onEachTick4(function(){k+=n,k>m&&(k=m),d.setValue(k)},10))},s.onTouchUp=function(){UI.ticker.onEachTick4()},s.setProperties({name:"buttonUp",label:"↑"}),d.addChild(s),d.setProperties=function(a){if(!a)return g;g=a||{},c(g),d.setSize(d.width,d.height),d.setPosition(d.left,d.top),"big"===i?(o=2,s.setProperties({left:d.width-r.width,height:Math.floor(d.height/2),top:0}),r.setProperties({left:s.left,height:s.height,top:d.height-s.height})):(r.setProperties({left:d.width-r.width,top:3}),s.setProperties({left:d.width-s.width-r.width,top:3}))},d.setValue=function(a,b){k=a,d.refresh(),!b&&h&&h(k)},d.getValue=function(){return k},d.setMax=function(a,b){m=a,!b&&k>m&&d.setValue(m)},d.setMin=function(a){l=a,k<l&&d.setValue(l)},d.setDisabled=function(a){q=a,d.refresh()},d.render=function(a){if(a=!!a,d.isVisible()){if(d.needsRendering){if(d.clearCanvas(),j&&(f?f.write(d.ctx,j,6,11,0):(d.ctx.fillStyle="white",d.ctx.fillText(j,10,10))),s.render(),r.render(),"big"===i)d.ctx.drawImage(Y.getImage("panel_inset_dark"),s.left-36,1,34,d.height-2),window.fontLedBig.write(d.ctx,b(),s.left-31,4,0);else{var c=s.left-32-10,e=2,g=40;2===o&&(g=24,c+=16),3===o&&(g=32,c+=8),5===o&&(g=48,c-=8),d.ctx.drawImage(Y.getImage("panel_inset_dark"),c,e,g,24),c+=4,e=7,window.fontLed.write(d.ctx,b(),c,e,0)}q&&(d.ctx.fillStyle="rgba(34, 49, 85, 0.6)",d.ctx.fillRect(1,0,d.width-1,d.height))}if(d.needsRendering=!1,a)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top,d.width,d.height)}},d.onMouseWheel=function(a){q||(a.mouseWheels[0]>0?(k++,k>m&&(k=m),d.setValue(k)):(k--,k<l&&(k=l),d.setValue(k)))},d.onResize=function(){var a=j;e&&e.forEach(function(a){d.width>=a.width&&(j=a.label)}),a!==j&&d.refresh()},d};var StateManager=function(){var a={},b={};return a.registerEdit=function(a){var c=a.target+"_"+a.id,d=b[c]||{undo:[],redo:[]};d.undo.push(a),d.undo.length>50&&d.undo.shift(),d.redo=[],b[c]=d},a.undo=function(){var a=Tracker.getCurrentPattern(),c=EDITACTION.PATTERN+"_"+a,d=b[c];if(d&&d.undo&&d.undo.length){var e=d.undo.pop(),f=Tracker.getSong().patterns[a];switch(e.type){case EDITACTION.NOTE:case EDITACTION.TRACK:case EDITACTION.PATTERN:e.data.forEach(function(a){if(f){(f[a.position.row][a.position.track]||new Note).populate(a.from)}}),EventBus.trigger(EVENT.patternChange,a)}d.redo.push(e)}},a.redo=function(){var a=Tracker.getCurrentPattern(),c=EDITACTION.PATTERN+"_"+a,d=b[c];if(d&&d.redo&&d.redo.length){var e=d.redo.pop(),f=Tracker.getSong().patterns[a];switch(e.type){case EDITACTION.NOTE:case EDITACTION.TRACK:case EDITACTION.PATTERN:e.data.forEach(function(a){if(f){
var b=f[a.position.row][a.position.track]||new Note;a.to?b.populate(a.to):b.clear()}}),EventBus.trigger(EVENT.patternChange,a)}d.undo.push(e)}},a.createNoteUndo=function(a,b,c,d){return{target:EDITACTION.PATTERN,type:EDITACTION.NOTE,id:a,data:[{position:{track:b,row:c},from:d.duplicate()}]}},a.createTrackUndo=function(a){return{target:EDITACTION.PATTERN,type:EDITACTION.TRACK,id:a,data:[]}},a.createPatternUndo=function(a){return{target:EDITACTION.PATTERN,type:EDITACTION.PATTERN,id:a,data:[]}},a.addNote=function(a,b,c,d){var e={position:{track:b,row:c},from:d.duplicate()};return a.data.push(e),e},a}();UI.ticker=function(){var a,b,c,d,e,f,g={},h=0,i=0,j=!1;return g.onEachTick2=function(d,f){e=0,c=f||0,a=d,j=a||b},g.onEachTick4=function(c,e){f=0,d=e||0,b=c,j=a||b},EventBus.on(EVENT.screenRefresh,function(){j&&(h=1-h)&&(i=1-i,a&&++e>c&&a(),i&&b&&++f>d&&b())}),g}(),UI.WaveForm=function(){function a(){return h||i}function b(a){var b,c=g.sample.loop.start||0;if(a===F.loopStart)return c<z?-10:c>A?-10:(B=A-z,b=Math.floor((c-z)/B*q.width),Math.max(z>5?0:5,b));var d=c+g.sample.loop.length;return d<z?-10:d>A?-10:(b=Math.floor((d-z)/B*q.width),Math.min(b,q.width-(A>l-6?6:0)))}function c(a){var b;if(a===F.rangeStart)return r<z?-10:r>A?-10:(B=A-z,b=Math.floor((r-z)/B*q.width),Math.max(z>5?0:5,b));var c=r+t;return c<z?-10:c>A?-10:(b=Math.floor((c-z)/B*q.width),Math.min(b,q.width-(A>l-6?6:0)))}function d(a){var b={};return t?(b.tail=f.slice(r+t),b.range=f.slice(r,r+t),b.head=f.slice(0,r)):a?(b.range=[],b.tail=f.slice(r),b.head=f.slice(0,r)):(b.tail=[],b.range=f.slice(0,f.length),b.head=[]),b}function e(a){f=a.head.concat(a.range).concat(a.tail),g.sample.data=f,g.sample.length=f.length,p=!0,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),p=!1,G.refresh(),q.refresh()}var f,g,h,i,j,k,l,m,n,o,p,q=UI.element(),r=0,s=0,t=0,u=0,v=0,w=0,x=!1,y=1,z=0,A=0,B=0,C=[],D=0,E=0,F={loopStart:1,loopEnd:2,rangeStart:3,rangeEnd:4},G=UI.element(),H=UI.scale9Panel(0,0,q.width,q.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});H.ignoreEvents=!0;var I=UI.scale9Panel(1,0,100,18,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});return I.onDragStart=function(){I.startDragIndex=z,I.startLeft=I.left},I.onDrag=function(a){var b=a.deltaX,c=I.startLeft+b,d=q.width-I.width-1;c=Math.max(c,1),c=Math.min(c,d),I.setPosition(c,I.top);var e=c/(d-1);B=A-z,z=Math.floor((l-B)*e),A=z+B,G.refresh()},q.addChild(I),EventBus.on(EVENT.screenRefresh,function(){a()&&q.isVisible()&&q.refresh()}),q.onDragStart=function(a){var d=a.startX;if(g.sample.loop.enabled){var e=b(F.loopEnd);if(Math.abs(d-e)<5)return u=F.loopEnd,void(w=g.sample.loop.length);if(e=b(F.loopStart),Math.abs(d-e)<5)return u=F.loopStart,void(w=g.sample.loop.start)}if(t&&(e=c(F.rangeEnd),Math.abs(d-e)<5))return u=F.rangeEnd,void(w=t);if(r&&(e=c(F.rangeStart),Math.abs(d-e)<5))return u=F.rangeStart,void(w=r);i=!0,m=n=a.startX;var f=g.sample.length/q.width/y;r=s=Math.round(z+m*f),t=0,EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:t})},q.onDrag=function(a){var b=g.sample.length/q.width/y;if(u&&(u===F.loopStart||u===F.loopEnd)){v=u;var c=a.deltaX,d=w+Math.round(b*c);Tracker.inFTMode()||(d-=d%2);var e={};return u===F.loopStart?(d=Math.min(d,l-2),d=Math.max(d,0),(e.loopStart=d)+g.sample.loop.length>l&&(e.loopLength=l-e.loopStart)):(d=Math.max(d,2),d=Math.min(d,l-g.sample.loop.start),e.loopLength=d),void EventBus.trigger(EVENT.samplePropertyChange,e)}if(u&&(u===F.rangeStart||u===F.rangeEnd))return v=u,c=a.deltaX,d=w+Math.round(b*c),u===F.rangeStart?(d=Math.min(d,l-2),d=Math.max(d,0),(r=d)+t>l&&(t=l-r)):(d=Math.max(d,2),d=Math.min(d,l-r),t=d),EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:t}),void q.refresh();n=a.x,s=Math.round(z+n*b),t=s-r,EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:Math.abs(t)})},q.onTouchUp=function(a){i&&r>s&&(t=r-s,r=s,s=r+t,q.refresh()),i=!1,u=0,x=!1,t&&UI.setSelection(q.processSelection)},q.onDown=function(a){x=!0},q.onHover=function(a){if(!i&&!u&&!x){var d=v;x||(v=0);var e=q.eventX;if(r&&(f=c(F.rangeStart),Math.abs(e-f)<5))return v=F.rangeStart,void(d!==v&&q.refresh());if(s){var f=c(F.rangeEnd);if(Math.abs(e-f)<5)return v=F.rangeEnd,void(d!==v&&q.refresh())}if(g.sample.loop.enabled){if(f=b(F.loopEnd),Math.abs(e-f)<5)return v=F.loopEnd,void(d!==v&&q.refresh());if(f=b(F.loopStart),Math.abs(e-f)<5)return v=F.loopStart,void(d!==v&&q.refresh())}d!==v&&q.refresh()}},q.onResize=function(){G.setPosition(0,0),G.setSize(q.width,q.height),I.setPosition(I.left,q.height-18),y>1&&I.setSize(Math.floor(q.width/y),18)},q.setInstrument=function(a){g=a,a?(f=g.sample.data,l=f.length):(f=void 0,l=0),EventBus.trigger(EVENT.samplePropertyChange,{sampleLength:l,loopLength:a?a.sample.loop.length:0}),p||(h=!1,q.zoom(1),r=0,s=0,t=0,q.refresh())},q.play=function(a){y>1||(E=D,h=!0,j=(new Date).getTime(),k=Audio.getSampleRateForPeriod(a),q.refresh())},q.playSection=function(a){"range"===a&&(D=r,Input.handleNoteOn(Input.getPrevIndex(),void 0,D),D=0),"loop"===a&&(D=g.sample.loop.start,Input.handleNoteOn(Input.getPrevIndex(),void 0,D),D=0)},q.stop=function(){h=!1,q.refresh()},q.zoom=function(a){var b=!1;if("range"===a)if(t){z=r,B=t,A=z+B,y=l/B;var c=q.width/y,d=q.width-c-2;I.setPosition(Math.floor(z/(l-B)*d),I.top),b=!0}else a=1;"loop"===a&&(g.sample.loop.enabled&&(z=g.sample.loop.start,B=g.sample.loop.length,A=z+B,y=l/B,c=q.width/y,d=q.width-c-2,I.setPosition(Math.floor(z/(l-B)*d),I.top)),b=!0),1!==a&&1!==y||(y=1,z=0),b||(y*=a,y=Math.max(y,1),B=Math.floor(l/y),A=z+B),I.setSize(Math.floor(q.width/y),18),o=y>1,o&&A>l&&(z=l-B,A=l,I.setPosition(q.width-I.width-1,I.top)),G.refresh(),q.refresh()},q.select=function(a){"all"===a&&(r=0,s=f.length,t=f.length,q.refresh()),"none"===a&&(r=0,s=0,t=0,q.refresh()),"loop"===a&&g.sample.loop.length>2&&(r=g.sample.loop.start,t=g.sample.loop.length,s=r+t,q.refresh()),"start"===a&&(r=0,t=s-r,q.refresh()),"end"===a&&(s=f.length,t=s-r,q.refresh()),EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:t}),UI.setSelection(q.processSelection)},q.render=function(){if(this.needsRendering){if(G.needsRendering){if(G.clearCanvas(),G.ctx.fillStyle="rgb(13, 19, 27)",G.ctx.fillRect(0,0,q.width,q.height),G.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",H.width!==q.width&&H.setSize(q.width,q.height),G.ctx.drawImage(H.render(!0),0,0,q.width,q.height),f&&f.length&&q.width){1===y&&(z=0,A=l),B=A-z;var a=B/q.width,d=q.height/2;G.ctx.beginPath();for(var e=q.height/2-2,i=0;i<q.width;i++){var m=Math.floor(i*a),n=f[z+m]*e;0===i?G.ctx.moveTo(i,d+n):G.ctx.lineTo(i,d+n)}G.ctx.stroke()}G.needsRendering=!1}if(q.ctx.drawImage(G.canvas,0,0),h&&l){var p=(new Date).getTime(),u=p-j,m=E+k*u/1e3;if(g.sample.loop.enabled&&m>g.sample.loop.start){m=g.sample.loop.start+(m-g.sample.loop.start)%g.sample.loop.length;var w=m/l*q.width;q.ctx.fillStyle="rgb(241, 162, 71)",q.ctx.fillRect(w,0,1,q.height)}else if(m>l)h=!1;else{var w=m/l*q.width;q.ctx.fillStyle="rgb(241, 162, 71)",q.ctx.fillRect(w,0,1,q.height)}}if(g.sample.loop.length>2||g.sample.loop.enabled){var x=g.sample.loop.enabled?"rgb(241, 220, 71)":"rgba(150, 150, 150,0.7)";q.ctx.fillStyle=x,v===F.loopStart&&(q.ctx.fillStyle="white");var C=b(F.loopStart);q.ctx.fillRect(C,0,1,q.height-1),q.ctx.fillRect(C-4,0,4,10),q.ctx.fillStyle=x,v===F.loopEnd&&(q.ctx.fillStyle="white"),C=b(F.loopEnd),q.ctx.fillRect(C,0,1,q.height-1),q.ctx.fillRect(C+1,0,4,10)}var D=-1,J=-1;s&&(x="rgb(241, 131, 71)",q.ctx.fillStyle=x,v===F.rangeEnd&&(q.ctx.fillStyle="white"),J=c(F.rangeEnd),q.ctx.fillRect(J,0,1,q.height-1),q.ctx.fillRect(J+1,11,4,10)),r&&(r<z?D=0:(x="rgb(241, 131, 71)",q.ctx.fillStyle=x,v===F.rangeStart&&(q.ctx.fillStyle="white"),D=c(F.rangeStart),q.ctx.fillRect(D,0,1,q.height-1),q.ctx.fillRect(D-4,11,4,10)),r+t<z&&(D=J=-1)),D!==J&&(D>=0&&(J=Math.min(J,q.width))<=0&&(J=q.width),q.ctx.fillStyle="rgba(241, 162, 71,0.1)",q.ctx.fillRect(D,0,J-D,q.height)),o&&I.render()}this.needsRendering=!1,q.parentCtx.drawImage(q.canvas,q.left,q.top,q.width,q.height)},q.adjustVolume=function(a){var b,c,f,g=d(),h=!1;if("max"===a){var i=0,j=0;for(c=0,f=g.range.length;c<f;c++)i=Math.min(i,g.range[c]),j=Math.max(j,g.range[c]);if((b=1/Math.max(j,-i))>1){for(c=0,f=g.range.length;c<f;c++)g.range[c]=g.range[c]*b;h=!0}}if("fadein"===a){for(c=0,f=g.range.length-1;c<=f;c++)b=c/f,g.range[c]=g.range[c]*b;h=!0}if("fadeout"===a){for(c=0,f=g.range.length-1;c<=f;c++)b=1-c/f,g.range[c]=g.range[c]*b;h=!0}if(!h){if("number"==typeof a)for(b=1+1/a,c=0,f=g.range.length-1;c<=f;c++)g.range[c]=Math.min(Math.max(g.range[c]*b,-1),1);h=!0}h&&e(g)},q.reverse=function(){var a=d();a.range=a.range.reverse(),e(a)},q.invert=function(){for(var a=d(),b=0,c=a.range.length-1;b<=c;b++)a.range[b]=-a.range[b];e(a)},q.resample=function(a){var b=d(),c=[];if("up"===a){for(var f=0,h=b.range.length;f<h;f++)c.push(b.range[f]),c.push(b.range[f]);g.sample.loop.start=Math.floor(2*g.sample.loop.start),g.sample.loop.length=Math.floor(2*g.sample.loop.length),r*=2,t*=2,s=r+t}else{for(var f=0,h=b.range.length;f<h;f+=2)c.push(b.range[f]);g.sample.loop.start=Math.floor(g.sample.loop.start/2),g.sample.loop.length=Math.floor(g.sample.loop.length/2),r=Math.floor(r/2),t=Math.floor(t/2),s=r+t}Tracker.inFTMode()||(g.sample.loop.start=g.sample.loop.start-g.sample.loop.start%2,g.sample.loop.length=g.sample.loop.length-g.sample.loop.length%2),b.range=c,e(b)},q.processSelection=function(a){if(q.isVisible())switch(a){case SELECTION.RESET:return!1;case SELECTION.CLEAR:q.adjustVolume(0);break;case SELECTION.COPY:case SELECTION.CUT:if(t>0){var b=d();C=b.range.slice(0),a===SELECTION.CUT&&(b.range=[],e(b),t=0,s=r+t,EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:t}),q.refresh())}break;case SELECTION.PASTE:b=d(!0),r?b.range=b.range.concat(C):b.tail=b.tail.concat(C),e(b);break;case SELECTION.POSITION:}},EventBus.on(EVENT.commandSelectAll,function(){q.isVisible()&&q.select("all")}),q},Yascal.sprite=function(a){var b={};if(b.canvas=document.createElement("canvas"),b.ctx=b.canvas.getContext("2d"),a&&(a.width&&(b.canvas.width=a.width,b.canvas.height=a.height||a.width),a.img)){var c=a.x||0,d=a.y||0,e=b.canvas.width,f=b.canvas.height;b.ctx.drawImage(a.img,c,d,e,f,0,0,e,f)}return b},FilterChain=function(a){function b(){if(k=j,w&&(n=n||d(),k.connect(n),k=n),x&&(o=o||e(),k.connect(o),k=o),y&&(p=p||f(),k.connect(p),k=p),z&&(q=q||g(),k.connect(q),k=q),A&&(r=r||H.createConvolver(),s=s||H.createGain(),s.gain.value=0,k.connect(s),s.connect(r),l=r),B){var a=H.createWaveShaper();a.curve=h(400),a.oversample="4x"}v&&(t=t||Audio.context.createStereoPanner(),k.connect(t),k=t),m=m||H.createGain(),k.connect(m),l&&l.connect(m),k=m}function c(){j.disconnect(),n&&n.disconnect(),o&&o.disconnect(),p&&p.disconnect(),q&&q.disconnect(),s&&s.disconnect(),t&&t.disconnect(),l=void 0}function d(){var a=H.createBiquadFilter();return a.type="highshelf",a.frequency.value=3200,a.gain.value=E,a}function e(){var a=H.createBiquadFilter();return a.type="peaking",a.frequency.value=1e3,a.Q.value=.5,a.gain.value=D,a}function f(){var a=H.createBiquadFilter();return a.type="lowshelf",a.frequency.value=320,a.gain.value=C,a}function g(){var a=H.createBiquadFilter();return a.type="lowpass",a.frequency.value=5e3,a}function h(a){for(var b,c="number"==typeof a?a:50,d=new Float32Array(44100),e=Math.PI/180,f=0;f<44100;++f)b=2*f/44100-1,d[f]=(3+c)*b*20*e/(Math.PI+c*Math.abs(b));return d}var i={};a=a||{volume:!0,panning:!0};a={volume:!0,panning:!0};var j,k,l,m,n,o,p,q,r,s,t,u=a.volume,v=a.panning&&Audio.context.createStereoPanner,w=a.high,x=a.mid,y=a.low,z=a.lowPass,A=a.reverb,B=a.distortion,C=0,D=0,E=0,F=70,G=0,H=Audio.context;return j=H.createGain(),j.gain.value=1,k=j,i.lowValue=function(a){if(y){if(void 0!==a){C=a,p.gain.value=20*C}return C}},i.midValue=function(a){if(x){if(void 0!==a){D=a,o.gain.value=20*D}return D}},i.highValue=function(a){if(w){if(void 0!==a){E=a,n.gain.value=20*E}return E}},i.lowPassFrequencyValue=function(a){if(z){var b=Audio.context.sampleRate/2,c=Math.log(b/40)/Math.LN2;q.frequency.value=b*Math.pow(2,c*(a-1))}},i.lowPassQualityValue=function(a){z&&(q.Q.value=30*a)},i.reverbValue=function(a){if(A){if(!r.buffer){var b=cachedAssets.audio["data/reverb/sportcentre.m4a"];if(b)r.buffer=b;else{PreLoader().load(["data/reverb/sportcentre.m4a"],PRELOADTYPE.audio,function(){r.buffer=cachedAssets.audio["data/reverb/sportcentre.m4a"]})}}var c=parseInt(a)/100;s.gain.value=c*c}},i.volumeValue=function(a){if(u){if(void 0!==a){F=a;var b=a/100;m.gain.value=b*b}return F}},i.panningValue=function(a,b){if(v)return void 0!==a&&(G=a,b?t.pan.setValueAtTime(G,b):t.pan.setValueAtTime(G,Audio.context.currentTime)),G},i.setState=function(a,d){c(),"high"===a&&(w=!!d),"mid"===a&&(x=!!d),"low"===a&&(y=!!d),"lowPass"===a&&(z=!!d),"reverb"===a&&(A=!!d),"panning"===a&&(v=!!d&&Audio.context.createStereoPanner),b()},i.input=function(){return j},i.output=function(){return k},function(){b(),i.volumeValue(F)}(),i};var FileDetector=function(){var a={},b={unknown:{name:"UNKNOWN"},unsupported:{name:"UNSUPPORTED"},mod_ProTracker:{name:"PROTRACKER",isMod:!0,loader:function(){return ProTracker()}},mod_SoundTracker:{name:"SOUNDTRACKER",isMod:!0,loader:function(){return SoundTracker()}},mod_FastTracker:{name:"FASTTRACKER",isMod:!0,loader:function(){return FastTracker()}},sample:{name:"SAMPLE",isSample:!0},zip:{name:"ZIP"}};return a.detect=function(a,c){function d(a){return a<128}var e=a.length,f="";if("Extended Module: "==(f=a.readString(17,0)))return b.mod_FastTracker;if(e>1100&&(f=a.readString(4,1080)),"M.K."==f)return b.mod_ProTracker;if("M!K!"==f)return b.mod_ProTracker;if("M&K!"==f)return b.mod_ProTracker;if("FLT4"==f)return b.mod_ProTracker;if("2CHN"==f)return b.mod_ProTracker;if("6CHN"==f)return b.mod_ProTracker;if("8CHN"==f)return b.mod_ProTracker;if("10CH"==f)return b.mod_ProTracker;if("12CH"==f)return b.mod_ProTracker;if("14CH"==f)return b.mod_ProTracker;if("16CH"==f)return b.mod_ProTracker;if("18CH"==f)return b.mod_ProTracker;if("20CH"==f)return b.mod_ProTracker;if("22CH"==f)return b.mod_ProTracker;if("24CH"==f)return b.mod_ProTracker;if("26CH"==f)return b.mod_ProTracker;if("28CH"==f)return b.mod_ProTracker;if("30CH"==f)return b.mod_ProTracker;if("32CH"==f)return b.mod_ProTracker;var g="";if(c&&c.length>4&&(g=c.substr(c.length-4)),".wav"==(g=g.toLowerCase()))return b.sample;if(".mp3"==g)return b.sample;if(".iff"==g)return b.sample;if(".zip"==g)return b.zip;if("PK"==a.readString(2,0))return b.zip;if(c&&c.indexOf(".")>=0&&e>1624){if(function(){a.goto(0);for(var b=0;b<20;b++)if(!d(a.readByte()))return!1;for(var c=0,f=0,g=0;g<15;g++){for(b=0;b<22;b++)if(!d(a.readByte()))return!1;a.jump(-22);if("st-"==a.readString(22).toLowerCase().substr(0,3)&&(f+=10),f>20)return!0;c+=a.readWord(),a.jump(6)}return!(2*c+1624>e)}())return b.mod_SoundTracker}return b.sample},a}(),FastTracker=function(){var a={};return a.load=function(b,c){function d(a){for(a.points=[],t=0;t<12;t++)a.points.push(a.raw.slice(2*t,2*t+2));return 1&a.type&&(a.enabled=!0),2&a.type&&(a.sustain=!0),4&a.type&&(a.loop=!0),a}Tracker.setTrackerMode(TRACKERMODE.FASTTRACKER),Tracker.clearInstruments(1);var e={},f={patterns:[],instruments:[]};b.litteEndian=!0,b.goto(17),f.title=b.readString(20),b.jump(1),e.trackerName=b.readString(20),e.trackerVersion=b.readByte(),e.trackerVersion=b.readByte()+"."+e.trackerVersion,e.headerSize=b.readDWord(),e.songlength=b.readWord(),e.restartPosition=b.readWord(),e.numberOfChannels=b.readWord(),e.numberOfPatterns=b.readWord(),e.numberOfInstruments=b.readWord(),e.flags=b.readWord(),Tracker.useLinearFrequency=e.flags%2==1,e.defaultTempo=b.readWord(),e.defaultBPM=b.readWord();for(var g=[],h=0,i=0;i<e.songlength;++i)g[i]=b.readUbyte(),h<g[i]&&(h=g[i]);f.patternTable=g,f.length=e.songlength,f.channels=e.numberOfChannels,f.restartPosition=e.restartPosition+1;var j=60+e.headerSize;for(b.goto(j),i=0;i<e.numberOfPatterns;i++){var k=[],l={};l.headerSize=b.readDWord(),l.packingType=b.readUbyte(),l.patternLength=b.readWord(),l.patternSize=b.readWord(),j+=l.headerSize,b.goto(j);for(var m=0;m<l.patternLength;m++){var n,o=[];for(n=0;n<e.numberOfChannels;n++){var p=Note(),q=b.readUbyte();128&q?(1&q&&p.setIndex(b.readUbyte()),2&q&&(p.instrument=b.readUbyte()),4&q&&(p.volumeEffect=b.readUbyte()),8&q&&(p.effect=b.readUbyte()),16&q&&(p.param=b.readUbyte())):(p.setIndex(q),p.instrument=b.readUbyte(),p.volumeEffect=b.readUbyte(),p.effect=b.readUbyte(),p.param=b.readUbyte()),o.push(p)}k.push(o)}j+=l.patternSize,b.goto(j),f.patterns.push(k)}var r=[];for(i=1;i<=e.numberOfInstruments;++i){var s=Instrument();try{if(s.filePosition=b.index,s.headerSize=b.readDWord(),s.name=b.readString(22),s.type=b.readUbyte(),s.numberOfSamples=b.readWord(),s.samples=[],s.sampleHeaderSize=0,s.numberOfSamples>0){s.sampleHeaderSize=b.readDWord(),s.sampleHeaderSize=Math.max(s.sampleHeaderSize,40),s.sampleHeaderSize>200&&(s.sampleHeaderSize=40);for(var t=0;t<96;t++)s.sampleNumberForNotes.push(b.readUbyte());for(t=0;t<24;t++)s.volumeEnvelope.raw.push(b.readWord());for(t=0;t<24;t++)s.panningEnvelope.raw.push(b.readWord());s.volumeEnvelope.count=b.readUbyte(),s.panningEnvelope.count=b.readUbyte(),s.volumeEnvelope.sustainPoint=b.readUbyte(),s.volumeEnvelope.loopStartPoint=b.readUbyte(),s.volumeEnvelope.loopEndPoint=b.readUbyte(),s.panningEnvelope.sustainPoint=b.readUbyte(),s.panningEnvelope.loopStartPoint=b.readUbyte(),s.panningEnvelope.loopEndPoint=b.readUbyte(),s.volumeEnvelope.type=b.readUbyte(),s.panningEnvelope.type=b.readUbyte(),s.vibrato.type=b.readUbyte(),s.vibrato.sweep=b.readUbyte(),s.vibrato.depth=Math.min(b.readUbyte(),15),s.vibrato.rate=b.readUbyte(),s.fadeout=b.readWord(),s.reserved=b.readWord(),s.volumeEnvelope=d(s.volumeEnvelope),s.panningEnvelope=d(s.panningEnvelope)}}catch(a){}if(j+=s.headerSize,b.goto(j),0===s.numberOfSamples){var u=Sample();s.samples.push(u)}else{if(b.isEOF(1))break;for(var v=0;v<s.numberOfSamples;v++)u=Sample(),u.length=b.readDWord(),u.loop.start=b.readDWord(),u.loop.length=b.readDWord(),u.volume=b.readUbyte(),u.finetuneX=b.readByte(),u.type=b.readUbyte(),u.panning=b.readUbyte()-128,u.relativeNote=b.readByte(),u.reserved=b.readByte(),u.name=b.readString(22),u.bits=8,s.samples.push(u),j+=s.sampleHeaderSize,b.goto(j);for(v=0;v<s.numberOfSamples;v++)if(u=s.samples[v],u.length){j+=u.length,16&u.type&&(u.bits=16,u.type^=16,u.length>>=1,u.loop.start>>=1,u.loop.length>>=1),u.loop.type=u.type||0,u.loop.enabled=!!u.loop.type;var w=u.length,x=0;if(16===u.bits)for(var y=0;y<w;y++){var z=b.readShort()+x;z<-32768?z+=65536:z>32767&&(z-=65536),x=z,u.data.push(z/32768)}else for(y=0;y<w;y++)z=b.readByte()+x,z<-128?z+=256:z>127&&(z-=256),x=z,u.data.push(z/127);if(u.loop.type===LOOPTYPE.PINGPONG){var A=u.data.slice(u.loop.start,u.loop.start+u.loop.length);u.data=u.data.slice(0,u.loop.start+u.loop.length),u.data=u.data.concat(A.reverse()),u.loop.length=2*u.loop.length,u.length=u.loop.start+u.loop.length}b.goto(j)}}s.setSampleIndex(0),Tracker.setInstrument(i,s),r.push({label:i+" "+s.name,data:i})}return EventBus.trigger(EVENT.instrumentListChange,r),f.instruments=Tracker.getInstruments(),Tracker.setBPM(e.defaultBPM),Tracker.setAmigaSpeed(e.defaultTempo),a.validate(f),f},a.write=function(a){var b=Tracker.getSong(),c=Tracker.getInstruments(),d=Tracker.getTrackCount(),e="undefined"==typeof versionNumber?"dev":versionNumber,f=0;for(j=0;j<128;j++){var g=b.patternTable[j]||0;f=Math.max(f,g)}var h=336;for(j=0;j<=f;j++)b.patterns[j]&&(h+=9+b.patterns[j].length*d*5);for(j=1;j<c.length;j++){var i=c[j];i&&i.hasSamples()?i.samples.forEach(function(a){var b=a.length;16===a.bits&&(b*=2),h+=283+b}):h+=29}var j,k=new ArrayBuffer(h),l=new BinaryStream(k,!1);for(l.writeStringSection("Extended Module: ",17),l.writeStringSection(b.title,20),l.writeByte(26),l.writeStringSection("BassoonTracker "+e,20),l.writeByte(4),l.writeByte(1),l.writeDWord(276),l.writeWord(b.length),l.writeWord(0),l.writeWord(Tracker.getTrackCount()),l.writeWord(f+1),l.writeWord(c.length-1),l.writeWord(Tracker.useLinearFrequency?1:0),l.writeWord(Tracker.getAmigaSpeed()),l.writeWord(Tracker.getBPM()),j=0;j<256;j++)l.writeUByte(b.patternTable[j]||0);for(j=0;j<=f;j++){var m=b.patterns[j],n=0,o=0;if(m&&(n=m.length,o=n*d*5),l.writeDWord(9),l.writeUByte(0),l.writeWord(n),l.writeWord(o),m)for(var p=0,q=m.length;p<q;p++)for(var r=m[p],s=0;s<d;s++){var t=r[s]||{};l.writeUByte(t.index||0),l.writeUByte(t.instrument||0),l.writeUByte(t.volumeEffect||0),l.writeUByte(t.effect||0),l.writeUByte(t.param||0)}}for(j=1;j<c.length;j++)if((i=c[j])&&i.hasSamples()){i.numberOfSamples=i.samples.length,l.writeDWord(243),l.writeStringSection(i.name,22),l.writeUByte(0),l.writeWord(i.numberOfSamples);var u=(i.volumeEnvelope.enabled?1:0)+(i.volumeEnvelope.sustain?2:0)+(i.volumeEnvelope.loop?4:0),v=(i.panningEnvelope.enabled?1:0)+(i.panningEnvelope.sustain?2:0)+(i.panningEnvelope.loop?4:0);l.writeDWord(40);for(var w=0;w<96;w++)l.writeUByte(i.sampleNumberForNotes[w]||0);for(w=0;w<12;w++){var x=i.volumeEnvelope.points[w]||[0,0];l.writeWord(x[0]),l.writeWord(x[1])}for(w=0;w<12;w++)x=i.panningEnvelope.points[w]||[0,0],l.writeWord(x[0]),l.writeWord(x[1]);l.writeUByte(i.volumeEnvelope.count||0),l.writeUByte(i.panningEnvelope.count||0),l.writeUByte(i.volumeEnvelope.sustainPoint||0),l.writeUByte(i.volumeEnvelope.loopStartPoint||0),l.writeUByte(i.volumeEnvelope.loopEndPoint||0),l.writeUByte(i.panningEnvelope.sustainPoint||0),l.writeUByte(i.panningEnvelope.loopStartPoint||0),l.writeUByte(i.panningEnvelope.loopEndPoint||0),l.writeUByte(u),l.writeUByte(v),l.writeUByte(i.vibrato.type||0),l.writeUByte(i.vibrato.sweep||0),l.writeUByte(i.vibrato.depth||0),l.writeUByte(i.vibrato.rate||0),l.writeWord(i.fadeout||0),l.writeWord(0);for(var y=0;y<i.numberOfSamples;y++){var z=i.samples[y],A=0;z.loop.length>2&&z.loop.enabled&&(A=1);var B=z.length,C=z.loop.start,D=z.loop.length;16===z.bits&&(A+=16,B*=2,C*=2,D*=2),l.writeDWord(B),l.writeDWord(C),l.writeDWord(D),l.writeUByte(z.volume),l.writeByte(z.finetuneX),l.writeUByte(A),l.writeUByte((z.panning||0)+128),l.writeUByte(z.relativeNote||0),l.writeUByte(0),l.writeStringSection(z.name||"",22)}for(y=0;y<i.numberOfSamples;y++){z=i.samples[y];var E,F=0,G=0;if(16===z.bits)for(w=0,q=z.length;w<q;w++)E=Math.round(32768*z.data[w]),F=E-G,G=E,F<-32768?F+=65536:F>32767&&(F-=65536),l.writeWord(F);else for(w=0,q=z.length;w<q;w++)E=Math.round(127*z.data[w]),F=E-G,G=E,F<-128?F+=256:F>127&&(F-=256),l.writeByte(F)}}else l.writeDWord(29),l.writeStringSection(i?i.name:"",22),l.writeUByte(0),l.writeWord(0);a&&a(l)},a.validate=function(a){function b(a,b){var c=!0;if(a.points&&a.points[0])if(0===a.points[0][0])for(var d=0,e=1;e<a.count;e++){var f=a.points[e];f&&f[0]>d?d=f[0]:c=!1}else c=!1;else c=!1;return c?a:"volume"===b?{raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6}:{raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5}}a.instruments.forEach(function(a){a.volumeEnvelope=b(a.volumeEnvelope,"volume"),a.panningEnvelope=b(a.panningEnvelope,"panning");for(var c=a.samples.length-1,d=0,e=a.sampleNumberForNotes.length;d<e;d++)a.sampleNumberForNotes[d]=Math.min(a.sampleNumberForNotes[d],c)})},a},ProTracker=function(){var a={};return a.load=function(a,b){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER),Tracker.useLinearFrequency=!1,Tracker.clearInstruments(31);var c={patterns:[],restartPosition:1},d=4;c.typeId=a.readString(4,1080),c.title=a.readString(20,0),"2CHN"===c.typeId&&(d=2),"6CHN"===c.typeId&&(d=6),"8CHN"===c.typeId&&(d=8),"10CH"===c.typeId&&(d=10),"12CH"===c.typeId&&(d=12),"14CH"===c.typeId&&(d=14),"16CH"===c.typeId&&(d=16),"18CH"===c.typeId&&(d=18),"20CH"===c.typeId&&(d=20),"22CH"===c.typeId&&(d=22),"24CH"===c.typeId&&(d=24),"26CH"===c.typeId&&(d=26),"28CH"===c.typeId&&(d=28),"30CH"===c.typeId&&(d=30),"32CH"===c.typeId&&(d=32),c.channels=d;var e=0;for(m=1;m<=31;++m){var f=a.readString(22),g=a.readWord(),h=Instrument();h.name=f,h.sample.length=h.sample.realLen=g<<1;var i=a.readUbyte();i>7&&(i-=16),h.setFineTune(i),h.sample.volume=a.readUbyte(),h.sample.loop.start=a.readWord()<<1,h.sample.loop.length=a.readWord()<<1,h.sample.loop.enabled=h.sample.loop.length>2,h.sample.loop.type=LOOPTYPE.FORWARD,h.pointer=e,e+=h.sample.length,h.setSampleIndex(0),Tracker.setInstrument(m,h)}c.instruments=Tracker.getInstruments(),a.goto(950),c.length=a.readUbyte(),a.jump(1);for(var k=[],l=0,m=0;m<128;++m)(k[m]=a.readUbyte())>l&&(l=k[m]);for(c.patternTable=k,a.goto(1084),m=0;m<=l;++m){for(var n=[],o=0;o<64;o++){var p,q=[];for(p=0;p<d;p++){var r=Note(),s=a.readUint();r.setPeriod(s>>16&4095),r.effect=s>>8&15,r.instrument=s>>24&240|s>>12&15,r.param=255&s,q.push(r)}for(p=d;p<Tracker.getTrackCount();p++)q.push(Note());n.push(q)}c.patterns.push(n)}var t=[];for(m=1;m<=31;m++)if(h=Tracker.getInstrument(m)){var u=h.sample.length;for(h.sample.loop.length>2&&SETTINGS.unrollShortLoops&&h.sample.loop.length<1e3&&(u=Math.min(u,h.sample.loop.start+h.sample.loop.length),h.sample.length=u),j=0;j<u;j++){var v=a.readByte();j<2&&(v=0),h.sample.data.push(v/127)}if((SETTINGS.unrollShortLoops||SETTINGS.unrollLoops)&&h.sample.loop.length>2){var w=Math.ceil(4e4/h.sample.loop.length)+1;SETTINGS.unrollLoops||(w=0);var x=!1,y=0;SETTINGS.unrollShortLoops&&h.sample.loop.length<1600&&(w=Math.floor(1e3/h.sample.loop.length),x=!0);for(var z=0;z<w;z++){var A=h.sample.loop.start,B=A+h.sample.loop.length;for(j=A;j<B;j++)h.sample.data.push(h.sample.data[j]);y+=h.sample.loop.length}x&&y&&(h.sample.loop.length+=y,h.sample.length+=y)}t.push({label:m+" "+h.name,data:m})}return EventBus.trigger(EVENT.instrumentListChange,t),c},a.write=function(a){var b=Tracker.getSong(),c=Tracker.getInstruments(),d=Tracker.getTrackCount(),e=Tracker.getPatternLength(),f=1084,g=0;for(i=0;i<128;i++){var h=b.patternTable[i]||0;g=Math.max(g,h)}f+=(g+1)*(256*d),c.forEach(function(a){a&&(a.setSampleIndex(0),f+=a.sample.length)});var i,j=new ArrayBuffer(f),k=new BinaryStream(j,!0);for(k.writeStringSection(b.title,20),c.forEach(function(a){a?(a.sample.length=Math.min(a.sample.length,131070),k.writeStringSection(a.name,22),k.writeWord(a.sample.length>>1),k.writeUByte(a.sample.finetune),k.writeUByte(a.sample.volume),k.writeWord(a.sample.loop.start>>1),k.writeWord(a.sample.loop.length>>1)):k.clear(30)}),k.writeUByte(b.length),k.writeUByte(127),i=0;i<128;i++){var h=b.patternTable[i]||0;k.writeUByte(h)}for(k.writeString(8==d?"8CHN":"M.K."),i=0;i<=g;i++)for(var l=b.patterns[i],m=0;m<e;m++)for(var n=l[m],o=0;o<d;o++){var p=n[o],q=0,r=p.instrument;r>15&&(q=16,r=p.instrument-16);var s=(q<<24)+(p.period<<16)+(r<<12)+(p.effect<<8)+p.param;k.writeUint(s)}c.forEach(function(a){if(a&&a.sample.data&&a.sample.length){k.clear(2);var b;for(i=0;i<a.sample.length-2;i++)b=a.sample.data[i]||0,k.writeByte(Math.round(127*b))}}),a&&a(k)},a},SoundTracker=function(){var a={};return a.load=function(a,b){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER),Tracker.useLinearFrequency=!1,Tracker.clearInstruments(15);var c={patterns:[],restartPosition:1};c.typeId="ST",c.channels=4,c.title=a.readString(20,0);var d=0;for(k=1;k<=15;++k){var e=a.readString(22),f=a.readWord(),g=Instrument();g.name=e,g.sample.length=g.realLen=f<<1,g.sample.volume=a.readWord(),g.setFineTune(0),g.sample.loop.start=a.readWord(),g.sample.loop.length=a.readWord()<<1,g.sample.loop.enabled=g.sample.loop.length>2,g.sample.loop.type=LOOPTYPE.FORWARD,g.pointer=d,d+=g.sample.length,g.setSampleIndex(0),Tracker.setInstrument(k,g)}c.instruments=Tracker.getInstruments(),a.goto(470),c.length=a.readUbyte(),c.speed=a.readUbyte();for(var h=[],i=0,k=0;k<128;++k)(h[k]=a.readUbyte())>i&&(i=h[k]);for(c.patternTable=h,a.goto(600),k=0;k<=i;++k){for(var l=[],m=0;m<64;m++){var n,o=[];for(n=0;n<4;n++){var p={},q=a.readUint();p.period=q>>16&4095,p.effect=q>>8&15,p.instrument=q>>24&240|q>>12&15,p.param=255&q,o.push(p)}for(n=4;n<Tracker.getTrackCount();n++)o.push({note:0,effect:0,instrument:0,param:0});l.push(o)}c.patterns.push(l)}var r=[];for(k=1;k<=15;k++)if(g=Tracker.getInstrument(k)){var s=g.sample.length;for(j=0;j<s;j++){var t=a.readByte();j<2&&(t=0),g.sample.data.push(t/127)}r.push({label:k+" "+g.name,data:k})}return EventBus.trigger(EVENT.instrumentListChange,r),c},a};!function(a){"use strict";function b(){function a(a){var b,c,e,f,g,h,j=d.dyn_tree,k=d.stat_desc.static_tree,l=d.stat_desc.extra_bits,m=d.stat_desc.extra_base,o=d.stat_desc.max_length,p=0;for(f=0;f<=i;f++)a.bl_count[f]=0;for(j[2*a.heap[a.heap_max]+1]=0,b=a.heap_max+1;b<n;b++)c=a.heap[b],f=j[2*j[2*c+1]+1]+1,f>o&&(f=o,p++),j[2*c+1]=f,c>d.max_code||(a.bl_count[f]++,g=0,c>=m&&(g=l[c-m]),h=j[2*c],a.opt_len+=h*(f+g),k&&(a.static_len+=h*(k[2*c+1]+g)));if(0!==p){do{for(f=o-1;0===a.bl_count[f];)f--;a.bl_count[f]--,a.bl_count[f+1]+=2,a.bl_count[o]--,p-=2}while(p>0);for(f=o;0!==f;f--)for(c=a.bl_count[f];0!==c;)(e=a.heap[--b])>d.max_code||(j[2*e+1]!=f&&(a.opt_len+=(f-j[2*e+1])*j[2*e],j[2*e+1]=f),c--)}}function b(a,b){var c=0;do{c|=1&a,a>>>=1,c<<=1}while(--b>0);return c>>>1}function c(a,c,d){var e,f,g,h=[],j=0;for(e=1;e<=i;e++)h[e]=j=j+d[e-1]<<1;for(f=0;f<=c;f++)0!==(g=a[2*f+1])&&(a[2*f]=b(h[g]++,g))}var d=this;d.build_tree=function(b){var e,f,g,h=d.dyn_tree,i=d.stat_desc.static_tree,j=d.stat_desc.elems,k=-1;for(b.heap_len=0,b.heap_max=n,e=0;e<j;e++)0!==h[2*e]?(b.heap[++b.heap_len]=k=e,b.depth[e]=0):h[2*e+1]=0;for(;b.heap_len<2;)g=b.heap[++b.heap_len]=k<2?++k:0,h[2*g]=1,b.depth[g]=0,b.opt_len--,i&&(b.static_len-=i[2*g+1]);for(d.max_code=k,e=Math.floor(b.heap_len/2);e>=1;e--)b.pqdownheap(h,e);g=j;do{e=b.heap[1],b.heap[1]=b.heap[b.heap_len--],b.pqdownheap(h,1),f=b.heap[1],b.heap[--b.heap_max]=e,b.heap[--b.heap_max]=f,h[2*g]=h[2*e]+h[2*f],b.depth[g]=Math.max(b.depth[e],b.depth[f])+1,h[2*e+1]=h[2*f+1]=g,b.heap[1]=g++,b.pqdownheap(h,1)}while(b.heap_len>=2);b.heap[--b.heap_max]=b.heap[1],a(b),c(h,d.max_code,b.bl_count)}}function c(a,b,c,d,e){var f=this;f.static_tree=a,f.extra_bits=b,f.extra_base=c,f.elems=d,f.max_length=e}function d(a,b,c,d,e){var f=this;f.good_length=a,f.max_lazy=b,f.nice_length=c,f.max_chain=d,f.func=e}function e(a,b,c,d){var e=a[2*b],f=a[2*c];return e<f||e==f&&d[b]<=d[c]}function f(){function a(){var a;for(Ea=2*Aa,Ga[Ia-1]=0,a=0;a<Ia-1;a++)Ga[a]=0;Va=N[Wa].max_lazy,Ya=N[Wa].good_length,Za=N[Wa].nice_length,Ua=N[Wa].max_chain,Qa=0,Ma=0,Sa=0,Na=Ta=_-1,Pa=0,Ha=0}function d(){var a;for(a=0;a<m;a++)$a[2*a]=0;for(a=0;a<j;a++)_a[2*a]=0;for(a=0;a<k;a++)ab[2*a]=0;$a[2*o]=1,bb.opt_len=bb.static_len=0,hb=jb=0}function f(){cb.dyn_tree=$a,cb.stat_desc=c.static_l_desc,db.dyn_tree=_a,db.stat_desc=c.static_d_desc,eb.dyn_tree=ab,eb.stat_desc=c.static_bl_desc,lb=0,mb=0,kb=8,d()}function g(a,b){var c,d,e=-1,f=a[1],g=0,h=7,i=4;for(0===f&&(h=138,i=3),a[2*(b+1)+1]=65535,c=0;c<=b;c++)d=f,f=a[2*(c+1)+1],++g<h&&d==f||(g<i?ab[2*d]+=g:0!==d?(d!=e&&ab[2*d]++,ab[2*p]++):g<=10?ab[2*q]++:ab[2*r]++,g=0,e=d,0===f?(h=138,i=3):d==f?(h=6,i=3):(h=7,i=4))}function h(){var a;for(g($a,cb.max_code),g(_a,db.max_code),eb.build_tree(bb),a=k-1;a>=3&&0===ab[2*b.bl_order[a]+1];a--);return bb.opt_len+=3*(a+1)+5+5+4,a}function i(a){bb.pending_buf[bb.pending++]=a}function n(a){i(255&a),i(a>>>8&255)}function H(a){i(a>>8&255),i(255&a)}function ca(a,b){var c,d=b;mb>s-d?(c=a,lb|=c<<mb&65535,n(lb),lb=c>>>s-mb,mb+=d-s):(lb|=a<<mb&65535,mb+=d)}function da(a,b){var c=2*a;ca(65535&b[c],65535&b[c+1])}function ea(a,b){var c,d,e=-1,f=a[1],g=0,h=7,i=4;for(0===f&&(h=138,i=3),c=0;c<=b;c++)if(d=f,f=a[2*(c+1)+1],!(++g<h&&d==f)){if(g<i)do{da(d,ab)}while(0!=--g);else 0!==d?(d!=e&&(da(d,ab),g--),da(p,ab),ca(g-3,2)):g<=10?(da(q,ab),ca(g-3,3)):(da(r,ab),ca(g-11,7));g=0,e=d,0===f?(h=138,i=3):d==f?(h=6,i=3):(h=7,i=4)}}function fa(a,c,d){var e;for(ca(a-257,5),ca(c-1,5),ca(d-4,4),e=0;e<d;e++)ca(ab[2*b.bl_order[e]+1],3);ea($a,a-1),ea(_a,c-1)}function ga(){16==mb?(n(lb),lb=0,mb=0):mb>=8&&(i(255&lb),lb>>>=8,mb-=8)}function ha(){ca(Z<<1,3),da(o,c.static_ltree),ga(),1+kb+10-mb<9&&(ca(Z<<1,3),da(o,c.static_ltree),ga()),kb=7}function ia(a,c){var d,e,f;if(bb.pending_buf[ib+2*hb]=a>>>8&255,bb.pending_buf[ib+2*hb+1]=255&a,bb.pending_buf[fb+hb]=255&c,hb++,0===a?$a[2*c]++:(jb++,a--,$a[2*(b._length_code[c]+l+1)]++,
_a[2*b.d_code(a)]++),0==(8191&hb)&&Wa>2){for(d=8*hb,e=Qa-Ma,f=0;f<j;f++)d+=_a[2*f]*(5+b.extra_dbits[f]);if(d>>>=3,jb<Math.floor(hb/2)&&d<Math.floor(e/2))return!0}return hb==gb-1}function ja(a,c){var d,e,f,g,h=0;if(0!==hb)do{d=bb.pending_buf[ib+2*h]<<8&65280|255&bb.pending_buf[ib+2*h+1],e=255&bb.pending_buf[fb+h],h++,0===d?da(e,a):(f=b._length_code[e],da(f+l+1,a),g=b.extra_lbits[f],0!==g&&(e-=b.base_length[f],ca(e,g)),d--,f=b.d_code(d),da(f,c),0!==(g=b.extra_dbits[f])&&(d-=b.base_dist[f],ca(d,g)))}while(h<hb);da(o,a),kb=a[2*o+1]}function ka(){mb>8?n(lb):mb>0&&i(255&lb),lb=0,mb=0}function la(a,b,c){ka(),kb=8,c&&(n(b),n(~b)),bb.pending_buf.set(Da.subarray(a,a+b),bb.pending),bb.pending+=b}function ma(a,b,c){ca((Y<<1)+(c?1:0),3),la(a,b,!0)}function na(a,b,e){var f,g,i=0;Wa>0?(cb.build_tree(bb),db.build_tree(bb),i=h(),f=bb.opt_len+3+7>>>3,(g=bb.static_len+3+7>>>3)<=f&&(f=g)):f=g=b+5,b+4<=f&&a!=-1?ma(a,b,e):g==f?(ca((Z<<1)+(e?1:0),3),ja(c.static_ltree,c.static_dtree)):(ca(($<<1)+(e?1:0),3),fa(cb.max_code+1,db.max_code+1,i+1),ja($a,_a)),d(),e&&ka()}function oa(a){na(Ma>=0?Ma:-1,Qa-Ma,a),Ma=Qa,va.flush_pending()}function pa(){var a,b,c,d;do{if(0===(d=Ea-Sa-Qa)&&0===Qa&&0===Sa)d=Aa;else if(d==-1)d--;else if(Qa>=Aa+Aa-ba){Da.set(Da.subarray(Aa,Aa+Aa),0),Ra-=Aa,Qa-=Aa,Ma-=Aa,a=Ia,c=a;do{b=65535&Ga[--c],Ga[c]=b>=Aa?b-Aa:0}while(0!=--a);a=Aa,c=a;do{b=65535&Fa[--c],Fa[c]=b>=Aa?b-Aa:0}while(0!=--a);d+=Aa}if(0===va.avail_in)return;a=va.read_buf(Da,Qa+Sa,d),Sa+=a,Sa>=_&&(Ha=255&Da[Qa],Ha=(Ha<<La^255&Da[Qa+1])&Ka)}while(Sa<ba&&0!==va.avail_in)}function qa(a){var b,c=65535;for(c>xa-5&&(c=xa-5);;){if(Sa<=1){if(pa(),0===Sa&&a==x)return P;if(0===Sa)break}if(Qa+=Sa,Sa=0,b=Ma+c,(0===Qa||Qa>=b)&&(Sa=Qa-b,Qa=b,oa(!1),0===va.avail_out))return P;if(Qa-Ma>=Aa-ba&&(oa(!1),0===va.avail_out))return P}return oa(a==A),0===va.avail_out?a==A?R:P:a==A?S:Q}function ra(a){var b,c,d=Ua,e=Qa,f=Ta,g=Qa>Aa-ba?Qa-(Aa-ba):0,h=Za,i=Ca,j=Qa+aa,k=Da[e+f-1],l=Da[e+f];Ta>=Ya&&(d>>=2),h>Sa&&(h=Sa);do{if(b=a,Da[b+f]==l&&Da[b+f-1]==k&&Da[b]==Da[e]&&Da[++b]==Da[e+1]){e+=2,b++;do{}while(Da[++e]==Da[++b]&&Da[++e]==Da[++b]&&Da[++e]==Da[++b]&&Da[++e]==Da[++b]&&Da[++e]==Da[++b]&&Da[++e]==Da[++b]&&Da[++e]==Da[++b]&&Da[++e]==Da[++b]&&e<j);if(c=aa-(j-e),e=j-aa,c>f){if(Ra=a,f=c,c>=h)break;k=Da[e+f-1],l=Da[e+f]}}}while((a=65535&Fa[a&i])>g&&0!=--d);return f<=Sa?f:Sa}function sa(a){for(var b,c=0;;){if(Sa<ba){if(pa(),Sa<ba&&a==x)return P;if(0===Sa)break}if(Sa>=_&&(Ha=(Ha<<La^255&Da[Qa+(_-1)])&Ka,c=65535&Ga[Ha],Fa[Qa&Ca]=Ga[Ha],Ga[Ha]=Qa),0!==c&&(Qa-c&65535)<=Aa-ba&&Xa!=v&&(Na=ra(c)),Na>=_)if(b=ia(Qa-Ra,Na-_),Sa-=Na,Na<=Va&&Sa>=_){Na--;do{Qa++,Ha=(Ha<<La^255&Da[Qa+(_-1)])&Ka,c=65535&Ga[Ha],Fa[Qa&Ca]=Ga[Ha],Ga[Ha]=Qa}while(0!=--Na);Qa++}else Qa+=Na,Na=0,Ha=255&Da[Qa],Ha=(Ha<<La^255&Da[Qa+1])&Ka;else b=ia(0,255&Da[Qa]),Sa--,Qa++;if(b&&(oa(!1),0===va.avail_out))return P}return oa(a==A),0===va.avail_out?a==A?R:P:a==A?S:Q}function ta(a){for(var b,c,d=0;;){if(Sa<ba){if(pa(),Sa<ba&&a==x)return P;if(0===Sa)break}if(Sa>=_&&(Ha=(Ha<<La^255&Da[Qa+(_-1)])&Ka,d=65535&Ga[Ha],Fa[Qa&Ca]=Ga[Ha],Ga[Ha]=Qa),Ta=Na,Oa=Ra,Na=_-1,0!==d&&Ta<Va&&(Qa-d&65535)<=Aa-ba&&(Xa!=v&&(Na=ra(d)),Na<=5&&(Xa==u||Na==_&&Qa-Ra>4096)&&(Na=_-1)),Ta>=_&&Na<=Ta){c=Qa+Sa-_,b=ia(Qa-1-Oa,Ta-_),Sa-=Ta-1,Ta-=2;do{++Qa<=c&&(Ha=(Ha<<La^255&Da[Qa+(_-1)])&Ka,d=65535&Ga[Ha],Fa[Qa&Ca]=Ga[Ha],Ga[Ha]=Qa)}while(0!=--Ta);if(Pa=0,Na=_-1,Qa++,b&&(oa(!1),0===va.avail_out))return P}else if(0!==Pa){if(b=ia(0,255&Da[Qa-1]),b&&oa(!1),Qa++,Sa--,0===va.avail_out)return P}else Pa=1,Qa++,Sa--}return 0!==Pa&&(b=ia(0,255&Da[Qa-1]),Pa=0),oa(a==A),0===va.avail_out?a==A?R:P:a==A?S:Q}function ua(b){return b.total_in=b.total_out=0,b.msg=null,bb.pending=0,bb.pending_out=0,wa=V,za=x,f(),a(),B}var va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb=this,cb=new b,db=new b,eb=new b;bb.depth=[];var fb,gb,hb,ib,jb,kb,lb,mb;bb.bl_count=[],bb.heap=[],$a=[],_a=[],ab=[],bb.pqdownheap=function(a,b){for(var c=bb.heap,d=c[b],f=b<<1;f<=bb.heap_len&&(f<bb.heap_len&&e(a,c[f+1],c[f],bb.depth)&&f++,!e(a,d,c[f],bb.depth));)c[b]=c[f],b=f,f<<=1;c[b]=d},bb.deflateInit=function(a,b,c,d,e,f){return d||(d=X),e||(e=J),f||(f=w),a.msg=null,b==t&&(b=6),e<1||e>I||d!=X||c<9||c>15||b<0||b>9||f<0||f>v?E:(a.dstate=bb,Ba=c,Aa=1<<Ba,Ca=Aa-1,Ja=e+7,Ia=1<<Ja,Ka=Ia-1,La=Math.floor((Ja+_-1)/_),Da=new Uint8Array(2*Aa),Fa=[],Ga=[],gb=1<<e+6,bb.pending_buf=new Uint8Array(4*gb),xa=4*gb,ib=Math.floor(gb/2),fb=3*gb,Wa=b,Xa=f,ya=255&d,ua(a))},bb.deflateEnd=function(){return wa!=U&&wa!=V&&wa!=W?E:(bb.pending_buf=null,Ga=null,Fa=null,Da=null,bb.dstate=null,wa==V?F:B)},bb.deflateParams=function(a,b,c){var d=B;return b==t&&(b=6),b<0||b>9||c<0||c>v?E:(N[Wa].func!=N[b].func&&0!==a.total_in&&(d=a.deflate(y)),Wa!=b&&(Wa=b,Va=N[Wa].max_lazy,Ya=N[Wa].good_length,Za=N[Wa].nice_length,Ua=N[Wa].max_chain),Xa=c,d)},bb.deflateSetDictionary=function(a,b,c){var d,e=c,f=0;if(!b||wa!=U)return E;if(e<_)return B;for(e>Aa-ba&&(e=Aa-ba,f=c-e),Da.set(b.subarray(f,f+e),0),Qa=e,Ma=e,Ha=255&Da[0],Ha=(Ha<<La^255&Da[1])&Ka,d=0;d<=e-_;d++)Ha=(Ha<<La^255&Da[d+(_-1)])&Ka,Fa[d&Ca]=Ga[Ha],Ga[Ha]=d;return B},bb.deflate=function(a,b){var c,d,e,f,g;if(b>A||b<0)return E;if(!a.next_out||!a.next_in&&0!==a.avail_in||wa==W&&b!=A)return a.msg=O[D-E],E;if(0===a.avail_out)return a.msg=O[D-G],G;if(va=a,f=za,za=b,wa==U&&(d=X+(Ba-8<<4)<<8,e=(Wa-1&255)>>1,e>3&&(e=3),d|=e<<6,0!==Qa&&(d|=T),d+=31-d%31,wa=V,H(d)),0!==bb.pending){if(va.flush_pending(),0===va.avail_out)return za=-1,B}else if(0===va.avail_in&&b<=f&&b!=A)return va.msg=O[D-G],G;if(wa==W&&0!==va.avail_in)return a.msg=O[D-G],G;if(0!==va.avail_in||0!==Sa||b!=x&&wa!=W){switch(g=-1,N[Wa].func){case K:g=qa(b);break;case L:g=sa(b);break;case M:g=ta(b)}if(g!=R&&g!=S||(wa=W),g==P||g==R)return 0===va.avail_out&&(za=-1),B;if(g==Q){if(b==y)ha();else if(ma(0,0,!1),b==z)for(c=0;c<Ia;c++)Ga[c]=0;if(va.flush_pending(),0===va.avail_out)return za=-1,B}}return b!=A?B:C}}function g(){var a=this;a.next_in_index=0,a.next_out_index=0,a.avail_in=0,a.total_in=0,a.avail_out=0,a.total_out=0}function h(a){var b=this,c=new g,d=x,e=new Uint8Array(512),f=a?a.level:t;void 0===f&&(f=t),c.deflateInit(f),c.next_out=e,b.append=function(a,b){var f,g=[],h=0,i=0,j=0;if(a.length){c.next_in_index=0,c.next_in=a,c.avail_in=a.length;do{if(c.next_out_index=0,c.avail_out=512,c.deflate(d)!=B)throw new Error("deflating: "+c.msg);c.next_out_index&&g.push(512==c.next_out_index?new Uint8Array(e):new Uint8Array(e.subarray(0,c.next_out_index))),j+=c.next_out_index,b&&c.next_in_index>0&&c.next_in_index!=h&&(b(c.next_in_index),h=c.next_in_index)}while(c.avail_in>0||0===c.avail_out);return f=new Uint8Array(j),g.forEach(function(a){f.set(a,i),i+=a.length}),f}},b.flush=function(){var a,b,d=[],f=0,g=0;do{if(c.next_out_index=0,c.avail_out=512,(a=c.deflate(A))!=C&&a!=B)throw new Error("deflating: "+c.msg);512-c.avail_out>0&&d.push(new Uint8Array(e.subarray(0,c.next_out_index))),g+=c.next_out_index}while(c.avail_in>0||0===c.avail_out);return c.deflateEnd(),b=new Uint8Array(g),d.forEach(function(a){b.set(a,f),f+=a.length}),b}}var i=15,j=30,k=19,l=256,m=l+1+29,n=2*m+1,o=256,p=16,q=17,r=18,s=16,t=-1,u=1,v=2,w=0,x=0,y=1,z=3,A=4,B=0,C=1,D=2,E=-2,F=-3,G=-5,H=[0,1,2,3,4,4,5,5,6,6,6,6,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,0,0,16,17,18,18,19,19,20,20,20,20,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29];b._length_code=[0,1,2,3,4,5,6,7,8,8,9,9,10,10,11,11,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28],b.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],b.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],b.d_code=function(a){return a<256?H[a]:H[256+(a>>>7)]},b.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],b.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],b.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],b.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],c.static_ltree=[12,8,140,8,76,8,204,8,44,8,172,8,108,8,236,8,28,8,156,8,92,8,220,8,60,8,188,8,124,8,252,8,2,8,130,8,66,8,194,8,34,8,162,8,98,8,226,8,18,8,146,8,82,8,210,8,50,8,178,8,114,8,242,8,10,8,138,8,74,8,202,8,42,8,170,8,106,8,234,8,26,8,154,8,90,8,218,8,58,8,186,8,122,8,250,8,6,8,134,8,70,8,198,8,38,8,166,8,102,8,230,8,22,8,150,8,86,8,214,8,54,8,182,8,118,8,246,8,14,8,142,8,78,8,206,8,46,8,174,8,110,8,238,8,30,8,158,8,94,8,222,8,62,8,190,8,126,8,254,8,1,8,129,8,65,8,193,8,33,8,161,8,97,8,225,8,17,8,145,8,81,8,209,8,49,8,177,8,113,8,241,8,9,8,137,8,73,8,201,8,41,8,169,8,105,8,233,8,25,8,153,8,89,8,217,8,57,8,185,8,121,8,249,8,5,8,133,8,69,8,197,8,37,8,165,8,101,8,229,8,21,8,149,8,85,8,213,8,53,8,181,8,117,8,245,8,13,8,141,8,77,8,205,8,45,8,173,8,109,8,237,8,29,8,157,8,93,8,221,8,61,8,189,8,125,8,253,8,19,9,275,9,147,9,403,9,83,9,339,9,211,9,467,9,51,9,307,9,179,9,435,9,115,9,371,9,243,9,499,9,11,9,267,9,139,9,395,9,75,9,331,9,203,9,459,9,43,9,299,9,171,9,427,9,107,9,363,9,235,9,491,9,27,9,283,9,155,9,411,9,91,9,347,9,219,9,475,9,59,9,315,9,187,9,443,9,123,9,379,9,251,9,507,9,7,9,263,9,135,9,391,9,71,9,327,9,199,9,455,9,39,9,295,9,167,9,423,9,103,9,359,9,231,9,487,9,23,9,279,9,151,9,407,9,87,9,343,9,215,9,471,9,55,9,311,9,183,9,439,9,119,9,375,9,247,9,503,9,15,9,271,9,143,9,399,9,79,9,335,9,207,9,463,9,47,9,303,9,175,9,431,9,111,9,367,9,239,9,495,9,31,9,287,9,159,9,415,9,95,9,351,9,223,9,479,9,63,9,319,9,191,9,447,9,127,9,383,9,255,9,511,9,0,7,64,7,32,7,96,7,16,7,80,7,48,7,112,7,8,7,72,7,40,7,104,7,24,7,88,7,56,7,120,7,4,7,68,7,36,7,100,7,20,7,84,7,52,7,116,7,3,8,131,8,67,8,195,8,35,8,163,8,99,8,227,8],c.static_dtree=[0,5,16,5,8,5,24,5,4,5,20,5,12,5,28,5,2,5,18,5,10,5,26,5,6,5,22,5,14,5,30,5,1,5,17,5,9,5,25,5,5,5,21,5,13,5,29,5,3,5,19,5,11,5,27,5,7,5,23,5],c.static_l_desc=new c(c.static_ltree,b.extra_lbits,l+1,m,i),c.static_d_desc=new c(c.static_dtree,b.extra_dbits,0,j,i),c.static_bl_desc=new c(null,b.extra_blbits,0,k,7);var I=9,J=8,K=0,L=1,M=2,N=[new d(0,0,0,0,K),new d(4,4,8,4,L),new d(4,5,16,8,L),new d(4,6,32,32,L),new d(4,4,16,16,M),new d(8,16,32,32,M),new d(8,16,128,128,M),new d(8,32,128,256,M),new d(32,128,258,1024,M),new d(32,258,258,4096,M)],O=["need dictionary","stream end","","","stream error","data error","","buffer error","",""],P=0,Q=1,R=2,S=3,T=32,U=42,V=113,W=666,X=8,Y=0,Z=1,$=2,_=3,aa=258,ba=aa+_+1;g.prototype={deflateInit:function(a,b){var c=this;return c.dstate=new f,b||(b=i),c.dstate.deflateInit(c,a,b)},deflate:function(a){var b=this;return b.dstate?b.dstate.deflate(b,a):E},deflateEnd:function(){var a=this;if(!a.dstate)return E;var b=a.dstate.deflateEnd();return a.dstate=null,b},deflateParams:function(a,b){var c=this;return c.dstate?c.dstate.deflateParams(c,a,b):E},deflateSetDictionary:function(a,b){var c=this;return c.dstate?c.dstate.deflateSetDictionary(c,a,b):E},read_buf:function(a,b,c){var d=this,e=d.avail_in;return e>c&&(e=c),0===e?0:(d.avail_in-=e,a.set(d.next_in.subarray(d.next_in_index,d.next_in_index+e),b),d.next_in_index+=e,d.total_in+=e,e)},flush_pending:function(){var a=this,b=a.dstate.pending;b>a.avail_out&&(b=a.avail_out),0!==b&&(a.next_out.set(a.dstate.pending_buf.subarray(a.dstate.pending_out,a.dstate.pending_out+b),a.next_out_index),a.next_out_index+=b,a.dstate.pending_out+=b,a.total_out+=b,a.avail_out-=b,0===(a.dstate.pending-=b)&&(a.dstate.pending_out=0))}};var ca=a.zip||a;ca.Deflater=ca._jzlib_Deflater=h}(this),function(a){"use strict";function b(){function a(a,b,c,d,j,k,m,o,q,r,s){var t,u,v,w,x,z,A,B,C,D,E,F,G,H,I;D=0,x=c;do{e[a[b+D]]++,D++,x--}while(0!==x);if(e[0]==c)return m[0]=-1,o[0]=0,h;for(B=o[0],z=1;z<=y&&0===e[z];z++);for(A=z,B<z&&(B=z),x=y;0!==x&&0===e[x];x--);for(v=x,B>x&&(B=x),o[0]=B,H=1<<z;z<x;z++,H<<=1)if((H-=e[z])<0)return l;if((H-=e[x])<0)return l;for(e[x]+=H,i[1]=z=0,D=1,G=2;0!=--x;)i[G]=z+=e[D],G++,D++;x=0,D=0;do{0!==(z=a[b+D])&&(s[i[z]++]=x),D++}while(++x<c);for(c=i[v],i[0]=x=0,D=0,w=-1,F=-B,g[0]=0,E=0,I=0;A<=v;A++)for(t=e[A];0!=t--;){for(;A>F+B;){if(w++,F+=B,I=v-F,I=I>B?B:I,(u=1<<(z=A-F))>t+1&&(u-=t+1,G=A,z<I))for(;++z<I&&!((u<<=1)<=e[++G]);)u-=e[G];if(I=1<<z,r[0]+I>p)return l;g[w]=E=r[0],r[0]+=I,0!==w?(i[w]=x,f[0]=z,f[1]=B,z=x>>>F-B,f[2]=E-g[w-1]-z,q.set(f,3*(g[w-1]+z))):m[0]=E}for(f[1]=A-F,D>=c?f[0]=192:s[D]<d?(f[0]=s[D]<256?0:96,f[2]=s[D++]):(f[0]=k[s[D]-d]+16+64,f[2]=j[s[D++]-d]),u=1<<A-F,z=x>>>F;z<I;z+=u)q.set(f,3*(E+z));for(z=1<<A-1;0!=(x&z);z>>>=1)x^=z;for(x^=z,C=(1<<F)-1;(x&C)!=i[w];)w--,F-=B,C=(1<<F)-1}return 0!==H&&1!=v?n:h}function b(a){var b;for(c||(c=[],d=[],e=new Int32Array(y+1),f=[],g=new Int32Array(y),i=new Int32Array(y+1)),d.length<a&&(d=[]),b=0;b<a;b++)d[b]=0;for(b=0;b<y+1;b++)e[b]=0;for(b=0;b<3;b++)f[b]=0;g.set(e.subarray(0,y),0),i.set(e.subarray(0,y+1),0)}var c,d,e,f,g,i,j=this;j.inflate_trees_bits=function(e,f,g,h,i){var j;return b(19),c[0]=0,j=a(e,0,19,19,null,null,g,f,h,c,d),j==l?i.msg="oversubscribed dynamic bit lengths tree":j!=n&&0!==f[0]||(i.msg="incomplete dynamic bit lengths tree",j=l),j},j.inflate_trees_dynamic=function(e,f,g,i,j,k,o,p,q){var r;return b(288),c[0]=0,(r=a(g,0,e,257,u,v,k,i,p,c,d))!=h||0===i[0]?(r==l?q.msg="oversubscribed literal/length tree":r!=m&&(q.msg="incomplete literal/length tree",r=l),r):(b(288),r=a(g,e,f,0,w,x,o,j,p,c,d),r!=h||0===j[0]&&e>257?(r==l?q.msg="oversubscribed distance tree":r==n?(q.msg="incomplete distance tree",r=l):r!=m&&(q.msg="empty distance tree with lengths",r=l),r):h)}}function c(){function a(a,b,c,d,e,f,g,j){var k,m,n,p,q,r,s,t,u,v,w,x,y,z,A,B;s=j.next_in_index,t=j.avail_in,q=g.bitb,r=g.bitk,u=g.write,v=u<g.read?g.read-u-1:g.end-u,w=o[a],x=o[b];do{for(;r<20;)t--,q|=(255&j.read_byte(s++))<<r,r+=8;if(k=q&w,m=c,n=d,B=3*(n+k),0!==(p=m[B]))for(;;){if(q>>=m[B+1],r-=m[B+1],0!=(16&p)){for(p&=15,y=m[B+2]+(q&o[p]),q>>=p,r-=p;r<15;)t--,q|=(255&j.read_byte(s++))<<r,r+=8;for(k=q&x,m=e,n=f,B=3*(n+k),p=m[B];;){if(q>>=m[B+1],r-=m[B+1],0!=(16&p)){for(p&=15;r<p;)t--,q|=(255&j.read_byte(s++))<<r,r+=8;if(z=m[B+2]+(q&o[p]),q>>=p,r-=p,v-=y,u>=z)A=u-z,u-A>0&&2>u-A?(g.window[u++]=g.window[A++],g.window[u++]=g.window[A++],y-=2):(g.window.set(g.window.subarray(A,A+2),u),u+=2,A+=2,y-=2);else{A=u-z;do{A+=g.end}while(A<0);if(p=g.end-A,y>p){if(y-=p,u-A>0&&p>u-A)do{g.window[u++]=g.window[A++]}while(0!=--p);else g.window.set(g.window.subarray(A,A+p),u),u+=p,A+=p,p=0;A=0}}if(u-A>0&&y>u-A)do{g.window[u++]=g.window[A++]}while(0!=--y);else g.window.set(g.window.subarray(A,A+y),u),u+=y,A+=y,y=0;break}if(0!=(64&p))return j.msg="invalid distance code",y=j.avail_in-t,y=r>>3<y?r>>3:y,t+=y,s-=y,r-=y<<3,g.bitb=q,g.bitk=r,j.avail_in=t,j.total_in+=s-j.next_in_index,j.next_in_index=s,g.write=u,l;k+=m[B+2],k+=q&o[p],B=3*(n+k),p=m[B]}break}if(0!=(64&p))return 0!=(32&p)?(y=j.avail_in-t,y=r>>3<y?r>>3:y,t+=y,s-=y,r-=y<<3,g.bitb=q,g.bitk=r,j.avail_in=t,j.total_in+=s-j.next_in_index,j.next_in_index=s,g.write=u,i):(j.msg="invalid literal/length code",y=j.avail_in-t,y=r>>3<y?r>>3:y,t+=y,s-=y,r-=y<<3,g.bitb=q,g.bitk=r,j.avail_in=t,j.total_in+=s-j.next_in_index,j.next_in_index=s,g.write=u,l);if(k+=m[B+2],k+=q&o[p],B=3*(n+k),0===(p=m[B])){q>>=m[B+1],r-=m[B+1],g.window[u++]=m[B+2],v--;break}}else q>>=m[B+1],r-=m[B+1],g.window[u++]=m[B+2],v--}while(v>=258&&t>=10);return y=j.avail_in-t,y=r>>3<y?r>>3:y,t+=y,s-=y,r-=y<<3,g.bitb=q,g.bitk=r,j.avail_in=t,j.total_in+=s-j.next_in_index,j.next_in_index=s,g.write=u,h}var b,c,d,e,f=this,g=0,j=0,m=0,n=0,p=0,q=0,r=0,s=0,t=0,u=0;f.init=function(a,f,g,h,i,j){b=z,r=a,s=f,d=g,t=h,e=i,u=j,c=null},f.proc=function(f,v,w){var x,y,J,K,L,M,N,O=0,P=0,Q=0;for(Q=v.next_in_index,K=v.avail_in,O=f.bitb,P=f.bitk,L=f.write,M=L<f.read?f.read-L-1:f.end-L;;)switch(b){case z:if(M>=258&&K>=10&&(f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,w=a(r,s,d,t,e,u,f,v),Q=v.next_in_index,K=v.avail_in,O=f.bitb,P=f.bitk,L=f.write,M=L<f.read?f.read-L-1:f.end-L,w!=h)){b=w==i?G:I;break}m=r,c=d,j=t,b=A;case A:for(x=m;P<x;){if(0===K)return f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);w=h,K--,O|=(255&v.read_byte(Q++))<<P,P+=8}if(y=3*(j+(O&o[x])),O>>>=c[y+1],P-=c[y+1],0===(J=c[y])){n=c[y+2],b=F;break}if(0!=(16&J)){p=15&J,g=c[y+2],b=B;break}if(0==(64&J)){m=J,j=y/3+c[y+2];break}if(0!=(32&J)){b=G;break}return b=I,v.msg="invalid literal/length code",w=l,f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);case B:for(x=p;P<x;){if(0===K)return f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);w=h,K--,O|=(255&v.read_byte(Q++))<<P,P+=8}g+=O&o[x],O>>=x,P-=x,m=s,c=e,j=u,b=C;case C:for(x=m;P<x;){if(0===K)return f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);w=h,K--,O|=(255&v.read_byte(Q++))<<P,P+=8}if(y=3*(j+(O&o[x])),O>>=c[y+1],P-=c[y+1],0!=(16&(J=c[y]))){p=15&J,q=c[y+2],b=D;break}if(0==(64&J)){m=J,j=y/3+c[y+2];break}return b=I,v.msg="invalid distance code",w=l,f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);case D:for(x=p;P<x;){if(0===K)return f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);w=h,K--,O|=(255&v.read_byte(Q++))<<P,P+=8}q+=O&o[x],O>>=x,P-=x,b=E;case E:for(N=L-q;N<0;)N+=f.end;for(;0!==g;){if(0===M&&(L==f.end&&0!==f.read&&(L=0,M=L<f.read?f.read-L-1:f.end-L),0===M&&(f.write=L,w=f.inflate_flush(v,w),L=f.write,M=L<f.read?f.read-L-1:f.end-L,L==f.end&&0!==f.read&&(L=0,M=L<f.read?f.read-L-1:f.end-L),0===M)))return f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);f.window[L++]=f.window[N++],M--,N==f.end&&(N=0),g--}b=z;break;case F:if(0===M&&(L==f.end&&0!==f.read&&(L=0,M=L<f.read?f.read-L-1:f.end-L),0===M&&(f.write=L,w=f.inflate_flush(v,w),L=f.write,M=L<f.read?f.read-L-1:f.end-L,L==f.end&&0!==f.read&&(L=0,M=L<f.read?f.read-L-1:f.end-L),0===M)))return f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);w=h,f.window[L++]=n,M--,b=z;break;case G:if(P>7&&(P-=8,K++,Q--),f.write=L,w=f.inflate_flush(v,w),L=f.write,M=L<f.read?f.read-L-1:f.end-L,f.read!=f.write)return f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);b=H;case H:return w=i,f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);case I:return w=l,f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w);default:return w=k,f.bitb=O,f.bitk=P,v.avail_in=K,v.total_in+=Q-v.next_in_index,v.next_in_index=Q,f.write=L,f.inflate_flush(v,w)}},f.free=function(){}}function d(a,d){var e,f=this,g=K,j=0,m=0,q=0,r=[0],s=[0],t=new c,u=0,v=new Int32Array(3*p),w=new b;f.bitk=0,f.bitb=0,f.window=new Uint8Array(d),f.end=d,f.read=0,f.write=0,f.reset=function(a,b){b&&(b[0]=0),g==Q&&t.free(a),g=K,f.bitk=0,f.bitb=0,f.read=f.write=0},f.reset(a,null),f.inflate_flush=function(a,b){var c,d,e;return d=a.next_out_index,e=f.read,c=(e<=f.write?f.write:f.end)-e,c>a.avail_out&&(c=a.avail_out),0!==c&&b==n&&(b=h),a.avail_out-=c,a.total_out+=c,a.next_out.set(f.window.subarray(e,e+c),d),d+=c,e+=c,e==f.end&&(e=0,f.write==f.end&&(f.write=0),c=f.write-e,c>a.avail_out&&(c=a.avail_out),0!==c&&b==n&&(b=h),a.avail_out-=c,a.total_out+=c,a.next_out.set(f.window.subarray(e,e+c),d),d+=c,e+=c),a.next_out_index=d,f.read=e,b},f.proc=function(a,c){var d,n,p,x,y,z,A,B;for(x=a.next_in_index,y=a.avail_in,n=f.bitb,p=f.bitk,z=f.write,A=z<f.read?f.read-z-1:f.end-z;;)switch(g){case K:for(;p<3;){if(0===y)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);c=h,y--,n|=(255&a.read_byte(x++))<<p,p+=8}switch(d=7&n,u=1&d,d>>>1){case 0:n>>>=3,p-=3,d=7&p,n>>>=d,p-=d,g=L;break;case 1:var C=[],D=[],E=[[]],F=[[]];b.inflate_trees_fixed(C,D,E,F),t.init(C[0],D[0],E[0],0,F[0],0),n>>>=3,p-=3,g=Q;break;case 2:n>>>=3,p-=3,g=N;break;case 3:return n>>>=3,p-=3,g=T,a.msg="invalid block type",c=l,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c)}break;case L:for(;p<32;){if(0===y)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);c=h,y--,n|=(255&a.read_byte(x++))<<p,p+=8}if((~n>>>16&65535)!=(65535&n))return g=T,a.msg="invalid stored block lengths",c=l,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);j=65535&n,n=p=0,g=0!==j?M:0!==u?R:K;break;case M:if(0===y)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);if(0===A&&(z==f.end&&0!==f.read&&(z=0,A=z<f.read?f.read-z-1:f.end-z),0===A&&(f.write=z,c=f.inflate_flush(a,c),z=f.write,A=z<f.read?f.read-z-1:f.end-z,z==f.end&&0!==f.read&&(z=0,A=z<f.read?f.read-z-1:f.end-z),0===A)))return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);if(c=h,d=j,d>y&&(d=y),d>A&&(d=A),f.window.set(a.read_buf(x,d),z),x+=d,y-=d,z+=d,A-=d,0!=(j-=d))break;g=0!==u?R:K;break;case N:for(;p<14;){if(0===y)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);c=h,y--,n|=(255&a.read_byte(x++))<<p,p+=8}if(m=d=16383&n,(31&d)>29||(d>>5&31)>29)return g=T,a.msg="too many length or distance symbols",c=l,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);if(d=258+(31&d)+(d>>5&31),!e||e.length<d)e=[];else for(B=0;B<d;B++)e[B]=0;n>>>=14,p-=14,q=0,g=O;case O:for(;q<4+(m>>>10);){for(;p<3;){if(0===y)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);c=h,y--,n|=(255&a.read_byte(x++))<<p,p+=8}e[J[q++]]=7&n,n>>>=3,p-=3}for(;q<19;)e[J[q++]]=0;if(r[0]=7,(d=w.inflate_trees_bits(e,r,s,v,a))!=h)return c=d,c==l&&(e=null,g=T),f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);q=0,g=P;case P:for(;;){if(d=m,q>=258+(31&d)+(d>>5&31))break;var G,H;for(d=r[0];p<d;){if(0===y)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);c=h,y--,n|=(255&a.read_byte(x++))<<p,p+=8}if(d=v[3*(s[0]+(n&o[d]))+1],(H=v[3*(s[0]+(n&o[d]))+2])<16)n>>>=d,p-=d,e[q++]=H;else{for(B=18==H?7:H-14,G=18==H?11:3;p<d+B;){if(0===y)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);c=h,y--,n|=(255&a.read_byte(x++))<<p,p+=8}if(n>>>=d,p-=d,G+=n&o[B],n>>>=B,p-=B,B=q,d=m,B+G>258+(31&d)+(d>>5&31)||16==H&&B<1)return e=null,g=T,a.msg="invalid bit length repeat",c=l,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);H=16==H?e[B-1]:0;do{e[B++]=H}while(0!=--G);q=B}}s[0]=-1;var I=[],U=[],V=[],W=[];if(I[0]=9,U[0]=6,d=m,(d=w.inflate_trees_dynamic(257+(31&d),1+(d>>5&31),e,I,U,V,W,v,a))!=h)return d==l&&(e=null,g=T),c=d,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);t.init(I[0],U[0],v,V[0],v,W[0]),g=Q;case Q:if(f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,(c=t.proc(f,a,c))!=i)return f.inflate_flush(a,c);if(c=h,t.free(a),x=a.next_in_index,y=a.avail_in,n=f.bitb,p=f.bitk,z=f.write,A=z<f.read?f.read-z-1:f.end-z,0===u){g=K;break}g=R;case R:if(f.write=z,c=f.inflate_flush(a,c),z=f.write,A=z<f.read?f.read-z-1:f.end-z,f.read!=f.write)return f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);g=S;case S:return c=i,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);case T:return c=l,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c);default:return c=k,f.bitb=n,f.bitk=p,a.avail_in=y,a.total_in+=x-a.next_in_index,a.next_in_index=x,f.write=z,f.inflate_flush(a,c)}},f.free=function(a){f.reset(a,null),f.window=null,v=null},f.set_dictionary=function(a,b,c){f.window.set(a.subarray(b,b+c),0),f.read=f.write=c},f.sync_point=function(){return g==L?1:0}}function e(){function a(a){return a&&a.istate?(a.total_in=a.total_out=0,a.msg=null,a.istate.mode=ba,a.istate.blocks.reset(a,null),h):k}var b=this;b.mode=0,b.method=0,b.was=[0],b.need=0,b.marker=0,b.wbits=0,b.inflateEnd=function(a){return b.blocks&&b.blocks.free(a),b.blocks=null,h},b.inflateInit=function(c,e){return c.msg=null,b.blocks=null,e<8||e>15?(b.inflateEnd(c),k):(b.wbits=e,c.istate.blocks=new d(c,1<<e),a(c),h)},b.inflate=function(a,b){var c,d;if(!a||!a.istate||!a.next_in)return k;for(b=b==r?n:h,c=n;;)switch(a.istate.mode){case W:if(0===a.avail_in)return c;if(c=b,a.avail_in--,a.total_in++,(15&(a.istate.method=a.read_byte(a.next_in_index++)))!=V){a.istate.mode=da,a.msg="unknown compression method",a.istate.marker=5;break}if(8+(a.istate.method>>4)>a.istate.wbits){a.istate.mode=da,a.msg="invalid window size",a.istate.marker=5;break}a.istate.mode=X;case X:if(0===a.avail_in)return c;if(c=b,a.avail_in--,a.total_in++,d=255&a.read_byte(a.next_in_index++),((a.istate.method<<8)+d)%31!=0){a.istate.mode=da,a.msg="incorrect header check",a.istate.marker=5;break}if(0==(d&U)){a.istate.mode=ba;break}a.istate.mode=Y;case Y:if(0===a.avail_in)return c;c=b,a.avail_in--,a.total_in++,a.istate.need=(255&a.read_byte(a.next_in_index++))<<24&4278190080,a.istate.mode=Z;case Z:if(0===a.avail_in)return c;c=b,a.avail_in--,a.total_in++,a.istate.need+=(255&a.read_byte(a.next_in_index++))<<16&16711680,a.istate.mode=$;case $:if(0===a.avail_in)return c;c=b,a.avail_in--,a.total_in++,a.istate.need+=(255&a.read_byte(a.next_in_index++))<<8&65280,a.istate.mode=_;case _:return 0===a.avail_in?c:(c=b,a.avail_in--,a.total_in++,a.istate.need+=255&a.read_byte(a.next_in_index++),a.istate.mode=aa,j);case aa:return a.istate.mode=da,a.msg="need dictionary",a.istate.marker=0,k;case ba:if((c=a.istate.blocks.proc(a,c))==l){a.istate.mode=da,a.istate.marker=0;break}if(c==h&&(c=b),c!=i)return c;c=b,a.istate.blocks.reset(a,a.istate.was),a.istate.mode=ca;case ca:return i;case da:return l;default:return k}},b.inflateSetDictionary=function(a,b,c){var d=0,e=c;return a&&a.istate&&a.istate.mode==aa?(e>=1<<a.istate.wbits&&(e=(1<<a.istate.wbits)-1,d=c-e),a.istate.blocks.set_dictionary(b,d,e),a.istate.mode=ba,h):k},b.inflateSync=function(b){var c,d,e,f,g;if(!b||!b.istate)return k;if(b.istate.mode!=da&&(b.istate.mode=da,b.istate.marker=0),0===(c=b.avail_in))return n;for(d=b.next_in_index,e=b.istate.marker;0!==c&&e<4;)b.read_byte(d)==ea[e]?e++:e=0!==b.read_byte(d)?0:4-e,d++,c--;return b.total_in+=d-b.next_in_index,b.next_in_index=d,b.avail_in=c,b.istate.marker=e,4!=e?l:(f=b.total_in,g=b.total_out,a(b),b.total_in=f,b.total_out=g,b.istate.mode=ba,h)},b.inflateSyncPoint=function(a){return a&&a.istate&&a.istate.blocks?a.istate.blocks.sync_point():k}}function f(){}function g(){var a=this,b=new f,c=q,d=new Uint8Array(512),e=!1;b.inflateInit(),b.next_out=d,a.append=function(a,f){var g,j,k=[],l=0,m=0,o=0;if(0!==a.length){b.next_in_index=0,b.next_in=a,b.avail_in=a.length;do{if(b.next_out_index=0,b.avail_out=512,0!==b.avail_in||e||(b.next_in_index=0,e=!0),g=b.inflate(c),e&&g===n){if(0!==b.avail_in)throw new Error("inflating: bad input")}else if(g!==h&&g!==i)throw new Error("inflating: "+b.msg);if((e||g===i)&&b.avail_in===a.length)throw new Error("inflating: bad input");b.next_out_index&&k.push(512===b.next_out_index?new Uint8Array(d):new Uint8Array(d.subarray(0,b.next_out_index))),o+=b.next_out_index,f&&b.next_in_index>0&&b.next_in_index!=l&&(f(b.next_in_index),l=b.next_in_index)}while(b.avail_in>0||0===b.avail_out);return j=new Uint8Array(o),k.forEach(function(a){j.set(a,m),m+=a.length}),j}},a.flush=function(){b.inflateEnd()}}
var h=0,i=1,j=2,k=-2,l=-3,m=-4,n=-5,o=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],p=1440,q=0,r=4,s=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],t=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],u=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],v=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],w=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],x=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],y=15;b.inflate_trees_fixed=function(a,b,c,d){return a[0]=9,b[0]=5,c[0]=s,d[0]=t,h};var z=0,A=1,B=2,C=3,D=4,E=5,F=6,G=7,H=8,I=9,J=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],K=0,L=1,M=2,N=3,O=4,P=5,Q=6,R=7,S=8,T=9,U=32,V=8,W=0,X=1,Y=2,Z=3,$=4,_=5,aa=6,ba=7,ca=12,da=13,ea=[0,0,255,255];f.prototype={inflateInit:function(a){var b=this;return b.istate=new e,a||(a=15),b.istate.inflateInit(b,a)},inflate:function(a){var b=this;return b.istate?b.istate.inflate(b,a):k},inflateEnd:function(){var a=this;if(!a.istate)return k;var b=a.istate.inflateEnd(a);return a.istate=null,b},inflateSync:function(){var a=this;return a.istate?a.istate.inflateSync(a):k},inflateSetDictionary:function(a,b){var c=this;return c.istate?c.istate.inflateSetDictionary(c,a,b):k},read_byte:function(a){return this.next_in.subarray(a,a+1)[0]},read_buf:function(a,b){return this.next_in.subarray(a,a+b)}};var fa=a.zip||a;fa.Inflater=fa._jzlib_Inflater=g}(this),function(a){"use strict";function b(a){a.scripts&&a.scripts.length>0&&importScripts.apply(void 0,a.scripts),postMessage({type:"importScripts"})}function c(b){var c=a[b.codecClass],d=b.sn;if(j[d])throw Error("duplicated sn");j[d]={codec:new c(b.options),crcInput:"input"===b.crcType,crcOutput:"output"===b.crcType,crc:new g},postMessage({type:"newTask",sn:d})}function d(a){var b=a.sn,d=a.type,e=a.data,f=j[b];!f&&a.codecClass&&(c(a),f=j[b]);var g,h="append"===d,i=k();if(h)try{g=f.codec.append(e,function(a){postMessage({type:"progress",sn:b,loaded:a})})}catch(a){throw delete j[b],a}else delete j[b],g=f.codec.flush();var l=k()-i;i=k(),e&&f.crcInput&&f.crc.append(e),g&&f.crcOutput&&f.crc.append(g);var m=k()-i,n={type:d,sn:b,codecTime:l,crcTime:m},o=[];g&&(n.data=g,o.push(g.buffer)),h||!f.crcInput&&!f.crcOutput||(n.crc=f.crc.get());try{postMessage(n,o)}catch(a){postMessage(n)}}function e(a,b,c){var d={type:a,sn:b,error:f(c)};postMessage(d)}function f(a){return{message:a.message,stack:a.stack}}function g(){this.crc=-1}function h(){}if(a.zWorkerInitialized)throw new Error("z-worker.js should be run only once");a.zWorkerInitialized=!0,addEventListener("message",function(a){var b=a.data,c=b.type,d=b.sn,f=i[c];if(f)try{f(b)}catch(a){e(c,d,a)}});var i={importScripts:b,newTask:c,append:d,flush:d},j={},k=a.performance?a.performance.now.bind(a.performance):Date.now;g.prototype.append=function(a){for(var b=0|this.crc,c=this.table,d=0,e=0|a.length;d<e;d++)b=b>>>8^c[255&(b^a[d])];this.crc=b},g.prototype.get=function(){return~this.crc},g.prototype.table=function(){var a,b,c,d=[];for(a=0;a<256;a++){for(c=a,b=0;b<8;b++)1&c?c=c>>>1^3988292384:c>>>=1;d[a]=c}return d}(),a.NOOP=h,h.prototype.append=function(a,b){return a},h.prototype.flush=function(){}}(this);var Instrument=function(){function a(a,c,d){var e=Tracker.getProperties().tickTime,f=a.sustain?a.sustainPoint+1:a.count;a.loopStartPoint=Math.min(a.loopStartPoint,a.count-1),a.loopEndPoint=Math.min(a.loopEndPoint,a.count-1);var g=a.loop&&a.loopStartPoint<a.loopEndPoint;a.sustain&&a.sustainPoint<=a.loopStartPoint&&(g=!1),g&&(f=a.loopEndPoint+1);var h=0,i=0;if(c.gain)var j=c.gain,k=0,l=64;else j=c.pan,k=32,l=32;j.setValueAtTime((a.points[0][1]-k)/l,d);for(var m=1;m<f;m++){var n=a.points[m];i=n[0],h=i*e,j.linearRampToValueAtTime((n[1]-k)/l,d+h)}return!!g&&b.scheduleEnvelopeLoop(c,d,2,h)}var b={};return b.type="sample",b.name="",b.instrumentIndex=0,b.sampleIndex=-1,b.fadeout=128,b.data=[],b.samples=[Sample()],b.sample=b.samples[0],b.volumeEnvelope={raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6},b.panningEnvelope={raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5},b.vibrato={},b.sampleNumberForNotes=[],b.play=function(a,c,d,e,f,g){return Tracker.inFTMode()&&(c=b.getPeriodForNote(a)),Audio.playSample(b.instrumentIndex,c,d,e,f,g,a)},b.noteOn=function(c){var d,e,f={};if(b.volumeEnvelope.enabled){d=Audio.context.createGain();var g=b.volumeEnvelope,h=a(g,d,c);h&&(f.volume=c+h)}return b.panningEnvelope.enabled&&Audio.usePanning&&(e=Audio.context.createStereoPanner(),g=b.panningEnvelope,(h=a(g,e,c))&&(f.panning=c+h)),b.vibrato.rate&&b.vibrato.depth&&(f.ticks=0,f.vibrato=c,f.vibratoFunction=b.getAutoVibratoFunction()),{volume:d,panning:e,scheduled:f}},b.noteOff=function(a,c){function d(){c.volume.gain.cancelScheduledValues(a),c.volumeFadeOut.gain.cancelScheduledValues(a),c.volumeEnvelope&&c.volumeEnvelope.gain.cancelScheduledValues(a),c.panningEnvelope&&c.panningEnvelope.pan.cancelScheduledValues(a),c.scheduled=void 0}if(c&&c.volume){if(Tracker.inFTMode()){var e=Tracker.getProperties().tickTime;if(b.volumeEnvelope.enabled){if(b.volumeEnvelope.sustain&&c.volumeEnvelope){d();var f=0,g=b.volumeEnvelope.points[b.volumeEnvelope.sustainPoint];g&&(f=g[0]*e);for(var h=b.volumeEnvelope.sustainPoint;h<b.volumeEnvelope.count;h++){var i=b.volumeEnvelope.points[h];i&&c.volumeEnvelope.gain.linearRampToValueAtTime(i[1]/64,a+i[0]*e-f)}}if(b.fadeout){c.volumeFadeOut.gain.linearRampToValueAtTime(0,a+65536/b.fadeout*e/2)}}else d(),c.volumeFadeOut.gain.linearRampToValueAtTime(0,a+.1);if(b.panningEnvelope.enabled&&Audio.usePanning&&c.panningEnvelope)for(f=0,g=b.panningEnvelope.points[b.panningEnvelope.sustainPoint],g&&(f=g[0]*e),h=b.panningEnvelope.sustainPoint;h<b.panningEnvelope.count;h++)(i=b.panningEnvelope.points[h])&&c.panningEnvelope.pan.linearRampToValueAtTime((i[1]-32)/32,a+i[0]*e-f);return 100}if(d(),!c.isKey||!c.volume)return 0;c.volume.gain.linearRampToValueAtTime(0,a+.5)}},b.scheduleEnvelopeLoop=function(a,c,d,e){e=e||0;var f=Tracker.getProperties().tickTime;if(a.gain)var g=b.volumeEnvelope,h=a.gain,i=0,j=64;else g=b.panningEnvelope,h=a.pan,i=32,j=32;var k=g.points[g.loopStartPoint],l=k[0];if(g.loop&&g.loopStartPoint<g.loopEndPoint)for(;e<d;)for(var m=e,n=g.loopStartPoint;n<=g.loopEndPoint;n++)k=g.points[n],e=m+(k[0]-l)*f,h.linearRampToValueAtTime((k[1]-i)/j,c+e);return e},b.scheduleAutoVibrato=function(a,c){var d=0;a.scheduled.ticks=a.scheduled.ticks||0;var e=Tracker.getProperties().tickTime,f=-b.vibrato.rate/40,g=b.vibrato.depth/8;Tracker.useLinearFrequency&&(g*=4);var h,i,j,k;for(a.source&&(h=a.startPeriod,i=a.scheduled.vibratoFunction||Audio.waveFormFunction.sine,j=a.scheduled.vibrato||Audio.context.currentTime,k=0);d<c;){if(d+=e,h){var l=1;b.vibrato.sweep&&a.scheduled.ticks<b.vibrato.sweep&&(l=1-(b.vibrato.sweep-a.scheduled.ticks)/b.vibrato.sweep);Tracker.setPeriodAtTime(a,i(h,a.scheduled.ticks,f,g*l),j+k*e),k++}a.scheduled.ticks++}return d},b.getAutoVibratoFunction=function(){switch(b.vibrato.type){case 1:return Audio.waveFormFunction.square;case 2:return Audio.waveFormFunction.saw;case 3:return Audio.waveFormFunction.sawInverse}return Audio.waveFormFunction.sine},b.resetVolume=function(a,c){if(c.volumeFadeOut&&(c.volumeFadeOut.gain.cancelScheduledValues(a),c.volumeFadeOut.gain.setValueAtTime(1,a)),c.volumeEnvelope){c.volumeEnvelope.gain.cancelScheduledValues(a);var d=Tracker.getProperties().tickTime,e=b.volumeEnvelope.sustain?b.volumeEnvelope.sustainPoint+1:b.volumeEnvelope.count;c.volumeEnvelope.gain.setValueAtTime(b.volumeEnvelope.points[0][1]/64,a);for(var f=1;f<e;f++){var g=b.volumeEnvelope.points[f];c.volumeEnvelope.gain.linearRampToValueAtTime(g[1]/64,a+g[0]*d)}}},b.getFineTune=function(){return Tracker.inFTMode()?b.sample.finetuneX:b.sample.finetune},b.setFineTune=function(a){Tracker.inFTMode()?(b.sample.finetuneX=a,b.sample.finetune=a>>4):(a>7&&(a-=15),b.sample.finetune=a,b.sample.finetuneX=a<<4)},b.getPeriodForNote=function(a,c){var d=0;return Tracker.useLinearFrequency?(d=7680-64*(a-1),c&&(d-=b.getFineTune()/2)):(d=FTNotes[a].period,c&&b.getFineTune()&&(d=Audio.getFineTuneForNote(a,b.getFineTune()))),d},b.setSampleForNoteIndex=function(a){var c=b.sampleNumberForNotes[a-1];c!==b.sampleIndex&&"number"==typeof c&&b.setSampleIndex(c)},b.setSampleIndex=function(a){b.sampleIndex!==a&&(b.sample=b.samples[a],b.sampleIndex=a,EventBus.trigger(EVENT.sampleIndexChange,b.instrumentIndex))},b.hasSamples=function(){for(var a=0,c=b.samples.length;a<c;a++)if(b.samples[a].length)return!0},b.hasVibrato=function(){return b.vibrato.rate&&b.vibrato.depth},b},Note=function(){var a={};return a.period=0,a.index=0,a.effect=0,a.instrument=0,a.param=0,a.volumeEffect=0,a.setPeriod=function(b){a.period=b,a.index=FTPeriods[b]||0},a.setIndex=function(b){a.index=b;var c=FTNotes[b];c?1===(a.period=c.modPeriod||c.period)&&(a.period=0):a.period=0},a.clear=function(){a.instrument=0,a.period=0,a.effect=0,a.param=0,a.index=0,a.volumeEffect=0},a.duplicate=function(){return{instrument:a.instrument,period:a.period,effect:a.effect,param:a.param,volumeEffect:a.volumeEffect,note:a.index}},a.populate=function(b){a.instrument=b.instrument||0,a.period=b.period||0,a.effect=b.effect||0,a.param=b.param||0,a.volumeEffect=b.volumeEffect||0,a.index=b.note||b.index||0},a},Sample=function(){var a={};return a.data=[],a.length=0,a.name="",a.bits=8,a.volume=64,a.finetune=0,a.finetuneX=0,a.panning=0,a.relativeNote=0,a.loop={enabled:!1,start:0,length:0,type:0},a.check=function(){for(var b=0,c=0,d=0,e=a.data.length;d<e;d++)b=Math.min(b,a.data[d]),c=Math.max(c,a.data[d]);return{min:b,max:c}},a},BassoonProvider=function(){function a(a,b,e){if(e){var f=!1,g=b.lastIndexOf(".");g>=0&&(f=b.substr(g+1).toLowerCase()===e.toLowerCase()),f||(b+="."+e)}UI.setStatus("Downloading ..."),d=!1,setTimeout(function(){UI.setStatus("")},3e3),document.location.href=c+"storage/"+a+"?dl=1&name="+b}var b={},c="https://www.stef.be/bassoontracker/api/",d=!1;return b.putFile=function(){var a=c+"storage/put/";Editor.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(b){Tracker.getFileName();FetchService.sendBinary(a,b.buffer,function(a){})})},b.renderFile=function(b,e){if(!d){d=!0;var f=c+"storage/render/"+(Tracker.inFTMode()?"xm":"mod"),b=b||Tracker.getFileName();UI.setStatus("saving file ...",!0),Editor.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(g){FetchService.sendBinary(f,g.buffer,function(h){if("error"===h)UI.setStatus("error saving file"),d=!1;else{var i=h;UI.setStatus("rendering file ...",!0),f=c+"storage/convert/"+i,FetchService.sendBinary(f,g.buffer,function(h){"error"===h?(UI.setStatus("Error rendering file ..."),d=!1):(i=h,e?(UI.setStatus("Converting file to mp3...",!0),f=c+"storage/wavtomp3/"+i,FetchService.sendBinary(f,g.buffer,function(c){"error"===c?(UI.setStatus("Error converting file to mp3..."),d=!1):a(c,b,"mp3")})):a(i,b,"wav"))})}})})}},b.proxyUrl=function(a){return c+"proxy?"+encodeURIComponent(a)},b}(),Dropbox=function(){var a={};return a.isConnected=!1,a.checkConnected=function(b){a.isConnected&&b&&b(!0),dropboxService.getAccessToken()?dropboxService("users/get_current_account",void 0,{onComplete:function(c){c&&c.account_id&&(a.isConnected=!0,b&&b(!0))},onError:function(){b&&b(!1)}}):b&&b(!1)},a.showConnectDialog=function(){var a=UI.modalDialog();a.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0,cancel:!0}),a.onClick=function(b){var c=a.getElementAtPoint(b.x,b.y);c&&c.name&&(UI.setStatus(""),"okbutton"===c.name?Dropbox.authenticate():(a.close(),EventBus.trigger(EVENT.dropboxConnectCancel)))},a.setText("DROPBOX ://BassoonTracker is not yet connected to DropBox//Do you want to do that now?//(BassoonTracker will only have access/to its own BassoonTracker folder)"),UI.setModalElement(a)},a.authenticate=function(){dropboxService.clearAccessToken(),dropboxService.authenticate({client_id:"ukk9z4f0nd1xa13",redirect_uri:"https://www.stef.be/bassoontracker/auth/dropbox.html"},{onComplete:function(a){},onError:function(a){}})},a.list=function(a,b){dropboxService("files/list_folder",{path:a},function(a){var c=[];a.entries.forEach(function(a){if(a[".tag"]&&"folder"===a[".tag"])c.push({title:a.name,url:a.path_lower,children:[]});else{c.push({title:a.name+" ("+(Math.floor(a.size/1e3)+"kb")+")"||"---",url:a.id,path:a.path_display})}}),b(c)})},a.get=function(b,c){a.list(b,c)},a.getFile=function(a,b){dropboxService("files/download",{path:a.url},function(a,c,d){b(c)})},a.putFile=function(a,b,c){var d={path:a};"overwrite"===SETTINGS.dropboxMode?d.mode="overwrite":(d.mode="add",d.autorename=!0),dropboxService("files/upload",d,b,{onComplete:function(a,b,d){c&&c(a)},onError:function(a,b,d){c&&c(!1)}})},a}(),ModArchive=function(){function a(a){j.length?a&&a(j):c("genres",function(b){if(b){var c={};b.forEach(function(a){if(a.parent){var b={title:a.name,count:a.count,info:a.count+" >",children:[],url:"genre/"+a.id};c[a.parent]||(c[a.parent]=[]),c[a.parent].push(b)}}),b.forEach(function(a){if(!a.parent){var b={title:a.name,children:c[a.id]||[]},d=0;b.children.forEach(function(a){d+=a.count}),b.info=d+" >",j.push(b)}})}a&&a(j)})}function b(a){k.length?a&&a(k):c("artists",function(b){b&&b.forEach(function(a){k.push({title:a.handle,children:[],info:a.count+" >",url:"artist/"+a.id})}),a&&a(k)})}function c(a,b){FetchService.json(h+a,function(a){b(a)})}function d(a,b){FetchService.json(i+a,function(a){a&&a.modarchive&&(a=a.modarchive),b(a)})}function e(a){var b=[];return a&&a.forEach(function(a){b.push({title:a.title||"---",url:"https://api.modarchive.org/downloads.php?moduleid="+a.id,icon:a.format,info:formatFileSize(a.size)})}),b}function f(a,b){var c=[];if(a){if(a.module){var d=a.module;d.forEach?d.forEach(function(a){c.push({title:a.songtitle||"---",url:a.url,icon:"mod"})}):c.push({title:d.songtitle||"---",url:d.url,icon:"mod"})}if(a.totalpages){var e=parseInt(a.totalpages);if(e>1){var f=b[0]+"/",g=parseInt(b[1]||1);isNaN(g)&&(g=1),"artist/"!=f&&"genre/"!=f||(f+=b[1]+"/",g=parseInt(b[2]||1),isNaN(g)&&(g=1)),e>g&&(f+=g+1,c.push({title:"... load more ...",children:[],url:f}))}}}return c}var g={},h="http://localhost:3000/";h="https://www.stef.be/bassoontracker/api/ma/";var i="https://www.stef.be/bassoontracker/api/",j=[],k=[];return g.get=function(g,h){var i=g.split("/");g=i[0];var j=i[1]||"",k=i[2]||"";switch(g){case"genres":a(h);break;case"artists":b(h);break;case"genre":c("genre/"+j,function(a){h(e(a))});break;case"toprating":k=j||1,d("toprating/"+k,function(a){h(f(a,i))});break;case"topreview":k=j||1,d("topreview/"+k,function(a){h(f(a,i))});break;case"artist":var l="artist/"+j;k&&(l+="/"+k),c(l,function(a){h(e(a))});break;default:h([])}},g}(),ModulesPl=function(){function a(a){j.length?a&&a(j):d("artists",function(b){b&&b.forEach(function(a){j.push({title:a.handle,info:a.count+" >",url:"artist/"+a.id,children:[]})}),a&&a(j)})}function b(a){i.length?a&&a(i):d("genres",function(b){b&&b.forEach(function(a){i.push({title:a.name,url:"genre/"+a.name,children:[],info:a.count+" >"})}),a&&a(i)})}function c(a,b,c){var f="genre/"+a;b&&(b=parseInt(b),f+="/"+b),d(f,function(a){c(e(a))})}function d(a,b){FetchService.json(g+a,function(a){b(a)})}function e(a,b){var c=[];return a&&a.forEach(function(a){var d=formatFileSize(a.size),e=a.title||"---";b&&(e=a[b]+": "+e),c.push({title:e,url:h+a.id,info:d,icon:a.format})}),c}var f={},g="https://www.stef.be/bassoontracker/api/mpl/",h="https://www.stef.be/bassoontracker/api/modules.pl/",i=[],j=[];return f.get=function(f,g){var h=f.split("/");f=h[0];var i=h[1]||"",j=h[2]||"";switch(f){case"genres":b(g);break;case"genre":c(i,j,g);break;case"toprating":j=i||1,d("toprating/"+j,function(a){g(e(a,"rate"))});break;case"topscore":j=i||1,d("topscore/"+j,function(a){g(e(a,"score"))});break;case"artists":a(g);break;case"artist":var k="artist/"+i;j&&(k+="/"+j),d(k,function(a){g(e(a))});break;default:g([])}},f}();return{init:Tracker.init,load:Tracker.load,playSong:Tracker.playSong,stop:Tracker.stop,togglePlay:Tracker.togglePlay,isPlaying:Tracker.isPlaying,getTrackCount:Tracker.getTrackCount,getSong:Tracker.getSong,getStateAtTime:Tracker.getStateAtTime,setCurrentSongPosition:Tracker.setCurrentSongPosition,audio:Audio}}();