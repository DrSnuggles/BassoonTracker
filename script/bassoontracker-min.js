/*BassoonTracker v0.4.0 by Steffest - build 2021-04-16 - Full source on https://github.com/steffest/BassoonTracker */
var BassoonTracker=function(){function G(e){if(window.location.getParameter)return window.location.getParameter(e);if(location.search)for(var t=location.search.substring(1).split("&"),n=0;n<t.length;n++){var i=t[n].split("=");if(i[0]&&i[0]==e)return i[1]||!0}}function r(e){var t="k";return isNaN(e)&&(e=0),1e3<(e=Math.round(e/1e3))&&(e=Math.round(e/100)/10,t="MB"),e+t}function D(e,t){function o(e){(e=0===e?e:e||r.index)<0&&(e=0),r.length<=e&&(e=r.length-1),r.index=e}var r={index:0,litteEndian:!t,goto:function(e){o(e)},jump:function(e){this.goto(this.index+e)},readByte:function(e){o(e);var t=this.dataView.getInt8(this.index);return this.index++,t},writeByte:function(e,t){o(t),this.dataView.setInt8(this.index,e),this.index++},readUbyte:function(e){o(e);var t=this.dataView.getUint8(this.index);return this.index++,t},writeUByte:function(e,t){o(t),this.dataView.setUint8(this.index,e),this.index++},readUint:function(e){o(e);var t=this.dataView.getUint32(this.index,this.litteEndian);return this.index+=4,t},writeUint:function(e,t){o(t),this.dataView.setUint32(this.index,e,this.litteEndian),this.index+=4},readBytes:function(e,t){o(t);var n=new Uint8Array(e),i=this.index;(e+=i)>this.length&&(e=this.length);for(var a=0;i<e;++i)n.setUint8(a++,this.dataView.getUint8(i));return this.index=e,n},readString:function(e,t){o(t);var n=this.index,i=this.dataView,a="";for((e+=n)>this.length&&(e=this.length);n<e;++n){var r=i.getUint8(n);if(0==r)break;a+=String.fromCharCode(r)}return this.index=e,a},writeString:function(e,t){o(t);for(var n=this.dataView,i=e.length,a=0;a<i;a++)n.setUint8(this.index+a,e.charCodeAt(a));this.index+=i},writeStringSection:function(e,t,n,i){o(i),n=n||0;var a=(e=e||"").length;(t=t||1)<a&&(e=e.substr(0,t)),r.writeString(e),r.fill(n,t-a)},readWord:function(e){o(e);var t=this.dataView.getUint16(this.index,this.litteEndian);return this.index+=2,t},writeWord:function(e,t){o(t),this.dataView.setUint16(this.index,e,this.litteEndian),this.index+=2}};return r.readLong=r.readDWord=r.readUint,r.writeLong=r.writeDWord=r.writeUint,r.readShort=function(e,t){o(t);var n=this.dataView.getInt16(this.index,this.litteEndian);return this.index+=2,n},r.clear=function(e){r.fill(0,e)},r.fill=function(e,t){e=e||0,t=t||0;for(var n=0;n<t;n++)r.writeByte(e)},r.isEOF=function(e){return this.length-(e=e||0)<=this.index},e&&(r.buffer=e,r.dataView=new DataView(e),r.length=e.byteLength),r}function o(t,e){function n(){var e={};return e.name=t.readString(4),e.size=t.readDWord(),e}t.litteEndian=!1,t.goto(12);for(var i=n();"BODY"!=i.name&&!t.isEOF(10);)"NAME"==i.name?e.name=t.readString(i.size):t.jump(i.size),i=n();if("BODY"==i.name)for(var a=0;a<i.size;a++){var r=t.readByte();e.data.push(r/127)}}function s(e,t,n){_e.context.decodeAudioData(e.buffer,function(e){e?(t.data=e.getChannelData(0),t.data&&!t.data.concat&&(t.data=Array.from(t.data)),t.length=e.length,n&&n()):alert("error decoding file data: "+url)},function(e){n&&n()})}function l(e,t){e.goto(0);for(var n=0;n<t.length;n++){var i=e.readByte();t.data.push(i/127)}}function d(e,t,n){e.litteEndian=!0,e.goto(4);var i={};i.chunkSize=e.readDWord(),i.format=e.readString(4),i.subChunk=e.readString(4),i.subChuckSize=e.readDWord();var a=e.index+i.subChuckSize;if(i.audioFormat=e.readWord(),i.numberOfChannels=e.readWord(),i.sampleRate=e.readDWord(),i.byteRate=e.readDWord(),i.blockalign=e.readWord(),i.bits=e.readWord(),e.goto(a),i.dataChunk=e.readString(4),i.dataChuckSize=e.readDWord(),8===i.bits){t.length=i.dataChuckSize;for(var r=0;r<t.length;r++){var o=e.readUbyte();t.data.push((o-=128)/128)}}else s(e,t,n)}var c,le={images:{},audio:{},json:{},arrayBuffer:{}},de=void 0,T=1,M=2,ce={instrumentChange:1,patternChange:2,patternPosChange:3,patternTableChange:4,recordingChange:5,cursorPositionChange:6,trackStateChange:7,playingChange:8,playTypeChange:9,songPositionChange:10,songSpeedChange:11,songBPMChange:12,samplePlay:13,screenRefresh:14,screenRender:15,songPropertyChange:16,instrumentNameChange:17,command:18,pianoNoteOn:19,pianoNoteOff:20,statusChange:21,diskOperationTargetChange:22,diskOperationActionChange:23,trackCountChange:24,patternHorizontalScrollChange:25,songLoaded:26,songLoading:27,trackerModeChanged:28,instrumentListChange:29,showView:30,toggleView:31,visibleTracksCountChange:32,filterChainCountChange:33,fxPanelToggle:34,samplePropertyChange:35,sampleIndexChange:36,second:37,minute:38,dropboxConnect:39,dropboxConnectCancel:40,trackScopeClick:41,octaveChanged:42,skipFrameChanged:43,showContextMenu:44,hideContextMenu:45,clockEventExpired:46,commandUndo:50,commandRedo:51,commandSelectAll:52,songEnd:53,patternEnd:54,songSpeedChangeIgnored:55,songBPMChangeIgnored:56,commandProcessSample:57,pluginRenderHook:58,menuLayoutChanged:59,midiIn:60},z={newFile:1,openFile:2,saveFile:3,clearTrack:4,clearPattern:5,clearSong:6,clearInstruments:7,showMain:8,showOptions:9,showFileOperations:10,showSampleEditor:11,showAbout:12,showHelp:13,togglePiano:14,showTopMain:15,showBottomMain:16,randomSong:17,randomSongXM:18,showGithub:19,showStats:20,cut:21,copy:22,paste:23,pattern2Sample:24,toggleAppSideBar:25,undo:26,redo:27,nibbles:28},F=1,L=2,I=1,A=2,g=1,u=2,p={RAW_8BIT:1,WAVE_PCM:2,IFF_8SVX:3,MP3:4,RIFF_8BIT:5,RIFF_16BIT:6},h=1,f=2,m=3,E=1,B=2,ue=1,he=2,fe=3,ge=4,pe=5,me=6,O=7,N=8,a=1,v=2,b=3,w=4,x=5,k=6,P=7,Y={C1:{period:856,name:"C-1",tune:[907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814]},Cs1:{period:808,name:"C#1",tune:[856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768]},D1:{period:762,name:"D-1",tune:[808,802,796,791,785,779,774,768,762,757,752,746,741,736,730,725]},Ds1:{period:720,name:"D#1",tune:[762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684]},E1:{period:678,name:"E-1",tune:[720,715,709,704,699,694,689,684,678,674,670,665,660,655,651,646]},F1:{period:640,name:"F-1",tune:[678,675,670,665,660,655,651,646,640,637,632,628,623,619,614,610]},Fs1:{period:604,name:"F#1",tune:[640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575]},G1:{period:570,name:"G-1",tune:[604,601,597,592,588,584,580,575,570,567,563,559,555,551,547,543]},Gs1:{period:538,name:"G#1",tune:[570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513]},A1:{period:508,name:"A-1",tune:[538,535,532,528,524,520,516,513,508,505,502,498,495,491,487,484]},As1:{period:480,name:"A#1",tune:[508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457]},B1:{period:453,name:"B-1",tune:[480,477,474,470,467,463,460,457,453,450,447,444,441,437,434,431]},C2:{period:428,name:"C-2",tune:[453,450,447,444,441,437,434,431,428,425,422,419,416,413,410,407]},Cs2:{period:404,name:"C#2",tune:[428,425,422,419,416,413,410,407,404,401,398,395,392,390,387,384]},D2:{period:381,name:"D-2",tune:[404,401,398,395,392,390,387,384,381,379,376,373,370,368,365,363]},Ds2:{period:360,name:"D#2",tune:[381,379,376,373,370,368,365,363,360,357,355,352,350,347,345,342]},E2:{period:339,name:"E-2",tune:[360,357,355,352,350,347,345,342,339,337,335,332,330,328,325,323]},F2:{period:320,name:"F-2",tune:[339,337,335,332,330,328,325,323,320,318,316,314,312,309,307,305]},Fs2:{period:302,name:"F#2",tune:[320,318,316,314,312,309,307,305,302,300,298,296,294,292,290,288]},G2:{period:285,name:"G-2",tune:[302,300,298,296,294,292,290,288,285,284,282,280,278,276,274,272]},Gs2:{period:269,name:"G#2",tune:[285,284,282,280,278,276,274,272,269,268,266,264,262,260,258,256]},A2:{period:254,name:"A-2",tune:[269,268,266,264,262,260,258,256,254,253,251,249,247,245,244,242]},As2:{period:240,name:"A#2",tune:[254,253,251,249,247,245,244,242,240,239,237,235,233,232,230,228]},B2:{period:226,name:"B-2",tune:[240,238,237,235,233,232,230,228,226,225,224,222,220,219,217,216]},C3:{period:214,name:"C-3",tune:[226,225,223,222,220,219,217,216,214,213,211,209,208,206,205,204]},Cs3:{period:202,name:"C#3",tune:[214,212,211,209,208,206,205,203,202,201,199,198,196,195,193,192]},D3:{period:190,name:"D-3",tune:[202,200,199,198,196,195,193,192,190,189,188,187,185,184,183,181]},Ds3:{period:180,name:"D#3",tune:[190,189,188,187,185,184,183,181,180,179,177,176,175,174,172,171]},E3:{period:170,name:"E-3",tune:[180,179,177,176,175,174,172,171,170,169,167,166,165,164,163,161]},F3:{period:160,name:"F-3",tune:[170,169,167,166,165,164,163,161,160,159,158,157,156,155,154,152]},Fs3:{period:151,name:"F#3",tune:[160,159,158,157,156,155,154,152,151,150,149,148,147,146,145,144]},G3:{period:143,name:"G-3",tune:[151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136]},Gs3:{period:135,name:"G#3",tune:[143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128]},A3:{period:127,name:"A-3",tune:[135,134,133,132,131,130,129,128,127,126,125,125,124,123,122,121]},As3:{period:120,name:"A#3",tune:[127,126,125,125,123,123,122,121,120,119,118,118,117,116,115,114]},B3:{period:113,name:"B-3",tune:[120,119,118,118,117,116,115,114,113,113,112,111,110,109,109,108]}},K={None:{name:"---"},C0:{name:"C-0",period:6848},Cs0:{name:"C#0",period:6464},D0:{name:"D-0",period:6096},Ds0:{name:"D#0",period:5760},E0:{name:"E-0",period:5424},F0:{name:"F-0",period:5120},Fs0:{name:"F#0",period:4832},G0:{name:"G-0",period:4560},Gs0:{name:"G#0",period:4304},A0:{name:"A-0",period:4064},As0:{name:"A#0",period:3840},B0:{name:"B-0",period:3624},C1:{name:"C-1",period:3424},Cs1:{name:"C#1",period:3232},D1:{name:"D-1",period:3048},Ds1:{name:"D#1",period:2880},E1:{name:"E-1",period:2712},F1:{name:"F-1",period:2560},Fs1:{name:"F#1",period:2416},G1:{name:"G-1",period:2280},Gs1:{name:"G#1",period:2152},A1:{name:"A-1",period:2032},As1:{name:"A#1",period:1920},B1:{name:"B-1",period:1812},C2:{name:"C-2",period:1712},Cs2:{name:"C#2",period:1616},D2:{name:"D-2",period:1524},Ds2:{name:"D#2",period:1440},E2:{name:"E-2",period:1356},F2:{name:"F-2",period:1280},Fs2:{name:"F#2",period:1208},G2:{name:"G-2",period:1140},Gs2:{name:"G#2",period:1076},A2:{name:"A-2",period:1016},As2:{name:"A#2",period:960},B2:{name:"B-2",period:906},C3:{name:"C-3",period:856},Cs3:{name:"C#3",period:808},D3:{name:"D-3",period:762},Ds3:{name:"D#3",period:720},E3:{name:"E-3",period:678},F3:{name:"F-3",period:640},Fs3:{name:"F#3",period:604},G3:{name:"G-3",period:570},Gs3:{name:"G#3",period:538},A3:{name:"A-3",period:508},As3:{name:"A#3",period:480},B3:{name:"B-3",period:453},C4:{name:"C-4",period:428},Cs4:{name:"C#4",period:404},D4:{name:"D-4",period:381},Ds4:{name:"D#4",period:360},E4:{name:"E-4",period:339},F4:{name:"F-4",period:320},Fs4:{name:"F#4",period:302},G4:{name:"G-4",period:285},Gs4:{name:"G#4",period:269},A4:{name:"A-4",period:254},As4:{name:"A#4",period:240},B4:{name:"B-4",period:226.5,modPeriod:226},C5:{name:"C-5",period:214},Cs5:{name:"C#5",period:202},D5:{name:"D-5",period:190.5,modPeriod:190},Ds5:{name:"D#5",period:180},E5:{name:"E-5",period:169.5,modPeriod:170},F5:{name:"F-5",period:160},Fs5:{name:"F#5",period:151},G5:{name:"G-5",period:142.5,modPeriod:143},Gs5:{name:"G#5",period:134.5,modPeriod:135},A5:{name:"A-5",period:127},As5:{name:"A#5",period:120},B5:{name:"B-5",period:113.25,modPeriod:113},C6:{name:"C-6",period:107},Cs6:{name:"C#6",period:101},D6:{name:"D-6",period:95.25,modPeriod:95},Ds6:{name:"D#6",period:90},E6:{name:"E-6",period:84.75,modPeriod:85},F6:{name:"F-6",period:80},Fs6:{name:"F#6",period:75.5,modPeriod:75},G6:{name:"G-6",period:71.25,modPeriod:71},Gs6:{name:"G#6",period:67.25,modPeriod:67},A6:{name:"A-6",period:63.5,modPeriod:63},As6:{name:"A#6",period:60},B6:{name:"B-6",period:56.625,modPeriod:56},C7:{name:"C-7",period:53.5,modPeriod:53},Cs7:{name:"C#7",period:50.5,modPeriod:50},D7:{name:"D-7",period:47.625,modPeriod:47},Ds7:{name:"D#7",period:45},E7:{name:"E-7",period:42.375,modPeriod:42},F7:{name:"F-7",period:40},Fs7:{name:"F#7",period:37.75,modPeriod:37},G7:{name:"G-7",period:35.625,modPeriod:35},Gs7:{name:"G#7",period:33.625,modPeriod:33},A7:{name:"A-7",period:31.75,modPeriod:31},As7:{name:"A#7",period:30},B7:{name:"B-7",period:28.3125,modPeriod:28},C8:{name:"C-8",period:26.75},Cs8:{name:"C#8",period:25.25},D8:{name:"D-8",period:23.8125},Ds8:{name:"D#8",period:22.5},E8:{name:"E-8",period:21.1875},F8:{name:"F-8",period:20},Fs8:{name:"F#8",period:18.875},G8:{name:"G-8",period:17.8125},Gs8:{name:"G#8",period:16.8125},A8:{name:"A-8",period:15.875},As8:{name:"A#8",period:15},B8:{name:"B-8",period:14.15625},C9:{name:"C-9",period:13.375},Cs9:{name:"C#9",period:12.625},D9:{name:"D-9",period:11.90625},Ds9:{name:"D#9",period:11.25},E9:{name:"E-9",period:10.59375},F9:{name:"F-9",period:10},Fs9:{name:"F#9",period:9.4375},G9:{name:"G-9",period:8.90625},Gs9:{name:"G#9",period:8.40625},A9:{name:"A-9",period:7.9375},As9:{name:"A#9",period:7.5},B9:{name:"B-9",period:7.078125},C10:{name:"C-10",period:6.6875},Cs10:{name:"C#10",period:6.3125},D10:{name:"D-10",period:5.953125},Ds10:{name:"D#10",period:5.625},E10:{name:"E-10",period:5.296875},F10:{name:"F-10",period:5},Fs10:{name:"F#10",period:4.71875},G10:{name:"G-10",period:4.453125},Gs10:{name:"G#10",period:4.203125},A10:{name:"A-10",period:3.96875},As10:{name:"A#10",period:3.75},B10:{name:"B-10",period:3.5390625},C11:{name:"C-11",period:3.34375},Cs11:{name:"C#11",period:3.15625},D11:{name:"D-11",period:2.9765625},Ds11:{name:"D#11",period:2.8125},E11:{name:"E-11",period:2.6484375},F11:{name:"F-11",period:2.5},Fs11:{name:"F#11",period:2.359375},G11:{name:"G-11",period:2.2265625},Gs11:{name:"G#11",period:2.1015625},A11:{name:"A-11",period:1.984375},As11:{name:"A#11",period:1.875},B11:{name:"B-11",period:1.76953125},OFF:{name:"OFF",period:0}},ve=145,e=0,t=1,n=2,C=3,S=4,y=5,_=6,R=7,V=8,U=9,W=10,H=11,X=12,q=13,Z=14,J=15,Q=16,$=17,ee=18,te=19,ne=20,ie=21,ae=22,re=23,oe=24,se=25,be=26,we=27,xe={0:{name:"OFF"},1:{name:"C"},2:{name:"Cs"},3:{name:"D"},4:{name:"Ds"},5:{name:"E"},6:{name:"F"},7:{name:"Fs"},8:{name:"G"},9:{name:"Gs"},10:{name:"A"},11:{name:"As"},12:{name:"B"}},ke={azerty:{a:q,z:J,e:$,r:ee,t:ne,y:ae,u:oe,i:se,o:we,"é":Z,'"':Q,"(":te,"§":ie,"è":re,"ç":be,w:t,x:C,c:y,v:_,b:V,n:W,",":X,";":q,":":J,s:n,d:S,g:R,h:U,j:H,"<":e},dvorak:{"'":q,",":J,".":$,p:ee,y:ne,f:ae,g:oe,c:se,r:we,2:Z,3:Q,5:te,6:ie,7:re,9:be,";":t,q:C,j:y,k:_,x:V,b:W,m:X,w:q,v:J,o:n,e:S,i:R,d:U,h:H,n:Z,"\\":e},qwerty:{q:q,w:J,e:$,r:ee,t:ne,y:ae,u:oe,i:se,o:we,2:Z,3:Q,5:te,6:ie,7:re,9:be,z:t,x:C,c:y,v:_,b:V,n:W,m:X,",":q,".":J,s:n,d:S,g:R,h:U,j:H,"\\":e},qwertz:{q:q,w:J,e:$,r:ee,t:ne,z:ae,u:oe,i:se,o:we,2:Z,3:Q,5:te,6:ie,7:re,9:be,y:t,x:C,c:y,v:_,b:V,n:W,m:X,",":q,".":J,s:n,d:S,g:R,h:U,j:H,"\\":e}},Pe=1,Ce=2,Se={unrollLoops:!1,unrollShortLoops:!1,sustainKeyboardNotes:!1,useHover:!0,keyboardTable:"qwerty",vubars:!0,stereoSeparation:f,emulateProtracker1OffsetBug:!0,loadInitialFile:!0},ye=(c={},{on:function(e,t){var n=c[e];return n||(c[e]=n=[]),n.push(t),n.length},off:function(e,t){var n=c[e];n&&(n[t-1]=void 0)},trigger:function(e,t){var n=c[e];if(n){var i,a=n.length;for(i=0;i<a;i++)n[i]&&n[i](t,e)}}}),_e=function(){function a(e,t){(n=e.createGain()).gain.setValueAtTime(1,0);n.connect(t||e.destination),(r=e.createGain()).connect(n),M.setMasterVolume(1),(o=e.createBiquadFilter()).type="lowpass",o.frequency.setValueAtTime(2e4,0),o.connect(r),M.masterVolume=r,M.cutOffVolume=n,M.lowPassfilter=o}var I,r,n,o,T,M={};window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var t,i,A,s,E,D,F=[],l=[],d=f,c=0,L=[[],[],[]],B=0,R=4143.569,u={volume:!0,panning:!0,high:!0,mid:!0,low:!0,lowPass:!0,reverb:!0,distortion:!1},V=!1;return AudioContext&&(I=new AudioContext),M.init=function(e,t){function n(){var e=FilterChain(u);e.output().connect(o),F.push(e)}if(M.context=I=e=e||I,e){E=!!_e.context.createStereoPanner,D=void 0!==Ne,a(e,t);var i=ot.getTrackCount();for(F=[],T=0;T<i;T++)n();M.filterChains=F,M.usePanning=E,V||(ye.on(ce.trackStateChange,function(e){void 0!==e.track&&F[e.track]&&F[e.track].volumeValue(e.mute?0:70)}),ye.on(ce.trackCountChange,function(e){for(T=F.length;T<e;T++)n();ye.trigger(ce.filterChainCountChange,e),M.setStereoSeparation(d)}),ye.on(ce.trackerModeChanged,function(e){M.setStereoSeparation()}))}},M.enable=function(){n.gain.setValueAtTime(1,0),M.cutOff=!1},M.disable=function(){n.gain.setValueAtTime(0,0),M.cutOff=!0;L.forEach(function(e,t){e.forEach(function(e){e.gain.cancelScheduledValues(0),e.gain.setValueAtTime(0,0)}),L[t]=[]})},M.checkState=function(){I&&"suspended"===I.state&&I.resume&&I.resume()},M.playSample=function(e,t,n,i,a,r,o){var s;V?s=A:(s=I,M.enable()),t=t||428,void 0===i&&(i=D?Ne.getCurrentTrack():0),r=r||I.currentTime,o===ve&&(n=0);var l,d,c,u=ot.getInstrument(e),h=t,f=0;if(u){var g,p,m=0,v=0;n=void 0===n?100*u.sample.volume/64:n,f=(u.sample.panning||0)/128,ot.inFTMode()?ot.useLinearFrequency?t-=u.getFineTune()/2:u.getFineTune()&&(t=M.getFineTuneForNote(o,u.getFineTune())):u.getFineTune()&&(t=M.getFineTuneForPeriod(t,u.getFineTune())),p=M.getSampleRateForPeriod(t);var b=1;u.sample.data.length?(v=u.sample.data.length,a&&a.offset&&(v<=a.offset.value&&(a.offset.value=v-1),m=a.offset.value/s.sampleRate),g=s.createBuffer(1,v,s.sampleRate),b=p/s.sampleRate):(g=s.createBuffer(1,1,s.sampleRate),m=0);var w=g.getChannelData(0);for(T=0;T<v;T++)w[T]=u.sample.data[T];R=p;var x=s.createBufferSource();x.buffer=g;var k=s.createGain();if(k.gain.value=n/100,k.gain.setValueAtTime(n/100,r),u.sample.loop.enabled&&2<u.sample.loop.length&&(Se.unrollLoops||(x.loop=!0,x.loopStart=u.sample.loop.start/s.sampleRate,x.loopEnd=(u.sample.loop.start+u.sample.loop.length)/s.sampleRate)),u.volumeEnvelope.enabled||u.panningEnvelope.enabled||u.hasVibrato()){var P=u.noteOn(r),C=x;P.volume&&(x.connect(l=P.volume),C=l),P.panning&&(C.connect(d=P.panning),C=d),c=P.scheduled,C.connect(k)}else x.connect(k);var S=_e.context.createGain();if(S.gain.setValueAtTime(0,r),S.gain.linearRampToValueAtTime(1,r+.01),k.connect(S),E){var y=_e.context.createStereoPanner();y.pan.setValueAtTime(f,r),S.connect(y),y.connect(F[i].input())}else S.connect(F[i].input());x.playbackRate.value=b;x.start(r+0,m);var _={source:x,volume:k,panning:y,volumeEnvelope:l,panningEnvelope:d,volumeFadeOut:S,startVolume:n,currentVolume:n,startPeriod:t,basePeriod:h,noteIndex:o,startPlaybackRate:b,sampleRate:p,instrumentIndex:e,effects:a,track:i,time:r,scheduled:c};return L[B].push(k),V||ye.trigger(ce.samplePlay,_),_}return{}},M.playSilence=function(){if(I){var e=I.createBufferSource();e.connect(r);try{e.start()}catch(e){}}},M.playRaw=function(e,t){if(I&&e&&e.length){var n;n=I.createBuffer(1,e.length,I.sampleRate);var i=t/audioContext.sampleRate,a=I.createBufferSource();a.buffer=n,a.loop=!0,a.playbackRate.value=i,a.connect(r),a.start()}},M.isRecording=function(){return t},M.startRecording=function(){if(!t&&I&&I.createMediaStreamDestination){var e=I.createMediaStreamDestination();(i=new MediaRecorder(e.stream)).ondataavailable=function(e){l.push(e.data)},i.onstop=function(e){var t=new Blob(l,{type:"audio/ogg; codecs=opus"});Ie(t,"recording.opus")},r.connect(e),i.start(),t=!0}},M.stopRecording=function(){t&&(t=!1,i.stop())},M.startRendering=function(e){V=!0,A=new OfflineAudioContext(2,44100*e,44100),s=I,M.context=A,M.init(A)},M.stopRendering=function(t){V=!1,A.startRendering().then(function(e){t&&t(e)}).catch(function(e){}),a(M.context=s),M.init(s)},M.setStereoSeparation=function(e){var t,n=ot.getTrackCount();if(ot.inFTMode())t=0;else switch(d=e=e||d){case m:t=0,Se.stereoSeparation=m;break;case h:t=1,Se.stereoSeparation=h;break;default:t=.5,Se.stereoSeparation=f}for(T=0;T<n;T++){var i=F[T];i&&i.panningValue(T%4==0||T%4==3?-t:t)}},M.getPrevSampleRate=function(){return R},M.context=I,M.getSemiToneFrom=function(e,t,n){var i=e;if(n&&(e=(e=M.getFineTuneBasePeriod(e,n))||i),t){var a=et[e];if(a){var r=it.indexOf(a.name),o=it[r+t];if(o){var s=nt[o];s&&(i=s.period,n&&(i=M.getFineTuneForPeriod(i,n)))}}}return i},M.getNearestSemiTone=function(e,t){var n=8;if(t){var i=ot.getInstrument(t);i&&i.sample.finetune&&(n+=i.sample.finetune)}var a=1e5,r=e;for(var o in Y)if(Y.hasOwnProperty(o)){var s=Y[o].tune[n],l=Math.abs(s-e);l<a&&(a=l,r=s)}return r},M.getFineTuneForPeriod=function(e,t){var n=e,i=et[e];if(i&&i.tune){var a=8+t;0<=a&&a<i.tune.length&&(n=i.tune[a])}return n},M.getFineTuneForNote=function(e,t){if(e===ve)return 1;var n=at[e],i=0<t?at[e+1]:at[e-1];if(n&&i){var a=Math.abs(i.period-n.period)/127;return n.period-a*t}return n?n.period:1e5},M.getFineTuneBasePeriod=function(e,t){var n=e,i=tt[t];return i&&(n=i[e]),n},M.getSampleRateForPeriod=function(e){return ot.inFTMode()?ot.useLinearFrequency?8363*Math.pow(2,(4608-e)/768):3579364/e:3546895/e},M.limitAmigaPeriod=function(e){return e=Math.max(e,113),e=Math.min(e,856)},M.setAmigaLowPassFilter=function(e,t){o.frequency.setValueAtTime(e?2e3:2e4,t)},M.setMasterVolume=function(e,t){e*=.7,r.gain.setValueAtTime(c,t=t||I.currentTime),r.gain.linearRampToValueAtTime(e,t+.02),c=e},M.slideMasterVolume=function(e,t){r.gain.linearRampToValueAtTime(e*=.7,t=t||I.currentTime),c=e},M.getLastMasterVolume=function(){return c/.7},M.clearScheduledNotesCache=function(){2<++B&&(B=0),L[B]=[]},M.waveFormFunction={sine:function(e,t,n,i){return e+Math.sin(t*n*.8)*i*1.7},saw:function(e,t,n,i){var a=1-Math.abs(t*n/7%1);return e+(a=(a=2*a-1)*i*-2)},square:function(e,t,n,i){var a=Math.sin(t*n)<=0?-1:1;return e+(a=a*i*2)},sawInverse:function(e,t,n,i){var a=Math.abs(t*n/7%1);return e+(a=(a=2*a-1)*i*-2)}},M}();!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t():e[e.__dropbox_export||"dropboxService"]=t()}(this,function(){"use strict";function f(e){return"[object Function]"==g.call(e)}function e(n,e){var t=[].slice.call(arguments),i=v[n]||{},a=i.baseUri||"https://api.dropboxapi.com/2/",r=i.format||"rpc",o=i.contentType||null===i.contentType?null:b[r],s=t[t.length-1],l=2<t.length&&("[object Object]"==g.call(s)||f(s))?s:{};f(l)&&(l={onComplete:l});var d,c={};Promise&&(d=new Promise(function(e,t){c.resolve=e,c.reject=t}));var u=new XMLHttpRequest;u.open("POST",a+n,!0),u.setRequestHeader("Authorization","Bearer "+(p("__dbat")||"000000000000000000000000_00000-000000000000000000000000000000000")),"content-download"==r&&(u.responseType="blob"),e&&e.responseType&&(u.responseType=e.responseType,delete e.responseType),o&&u.setRequestHeader("Content-Type",o),!e||"content-upload"!=r&&"content-download"!=r||u.setRequestHeader("Dropbox-API-Arg",JSON.stringify(e)),l.onDownloadProgress&&u.addEventListener("progress",l.onDownloadProgress),l.onUploadProgress&&u.upload&&u.upload.addEventListener("progress",l.onUploadProgress),(l.onError||m)&&u.addEventListener("error",function(e){var t=l.onError&&l.onError(e.target);d&&c.reject&&c.reject(e.target),m&&m(e.target,t)}),u.onreadystatechange=function(){if(4==u.readyState)if(200==u.status){var e=JSON.parse(u.getResponseHeader("dropbox-api-result")||u.responseText);"auth/token/revoke"==n&&p("__dbat",""),l.onComplete&&l.onComplete(e,u.response,u),d&&c.resolve&&c.resolve(e,u.response,u)}else{var t=l.onError&&l.onError(u);d&&c.reject&&c.reject(u),m&&m(u,t)}};var h=2<t.length&&"content-upload"==r?t[2]:void 0;return(h=h||(e&&"rpc"==r?JSON.stringify(e):null))?u.send(h):u.send(),d}var g={}.toString,t="https://content.dropboxapi.com/2/",p=function(e,t){return 1<arguments.length?localStorage[e]=t:localStorage[e]},m=void 0,v={"auth/token/revoke":{contentType:null},"users/get_current_account":{contentType:"application/json"},"files/upload":{baseUri:t,format:"content-upload"},"files/get_thumbnail":{baseUri:t,format:"content-download"},"files/download":{baseUri:t,format:"content-download"},"files/get_preview":{baseUri:t,format:"content-download"},"files/upload_session/append":{baseUri:t,format:"content-upload"},"files/upload_session/append_v2":{baseUri:t,format:"content-upload"},"files/upload_session/finish":{baseUri:t,format:"content-upload"},"files/upload_session/start":{baseUri:t,format:"content-upload"},"files/get_shared_link_file":{baseUri:t,format:"content-download"}},b={rpc:"application/json","content-upload":"application/octet-stream"};return e.setGlobalErrorHandler=function(e){m=e},e.setTokenStore=function(e){p=e},e.authenticate=function(e,t){f(t=t||{})&&(t={onComplete:t}),"[object String]"==g.call(e=e||{})&&(e={client_id:e}),e.redirect_uri=e.redirect_uri||window.location.href;var n,i={};if(Promise&&(n=new Promise(function(e,t){i.resolve=e,i.reject=t})),p("__dbat"))return t.onComplete(),n&&n.resolve&&n.resolve(),n;var a=window.location.hash.replace(/^#/,"").split("&").reduce(function(e,t){return""==t||(t=t.split("="),e[decodeURIComponent(t[0])]=decodeURIComponent(t[1])),e},{}),r=p("__dbcsrf");if(a.state&&r&&a.state==r)if(a.access_token)p("__dbat",a.access_token),p("__dbcsrf",""),window.location.replace(window.location.href.replace(/#.*/,""));else{var o=t.onError&&t.onError(a);n&&n.reject&&n.reject(a),m&&m(a,o)}else r=""+Math.floor(1e5*Math.random()),p("__dbcsrf",r),window.location="https://www.dropbox.com/1/oauth2/authorize?response_type=token&client_id="+encodeURIComponent(e.client_id)+"&redirect_uri="+encodeURIComponent(e.redirect_uri)+"&state="+encodeURIComponent(r);return n},e.getAccessToken=function(){return p("__dbat")},e.clearAccessToken=function(){return p("__dbat","")},e});var Ie=Ie||function(s){"use strict";if(!(void 0===s||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var l=function(){return s.URL||s.webkitURL||s},d=s.document.createElementNS("http://www.w3.org/1999/xhtml","a"),c="download"in d,u=/constructor/i.test(s.HTMLElement)||s.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent),f=function(e){(s.setImmediate||s.setTimeout)(function(){throw e},0)},g=function(e){setTimeout(function(){"string"==typeof e?l().revokeObjectURL(e):e.remove()},4e4)},p=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},i=function(e,n,t){t||(e=p(e));function i(){!function(e,t,n){for(var i=(t=[].concat(t)).length;i--;){var a=e["on"+t[i]];if("function"==typeof a)try{a.call(e,n||e)}catch(e){f(e)}}}(r,"writestart progress write writeend".split(" "))}var a,r=this,o="application/octet-stream"===e.type;if(r.readyState=r.INIT,c)return a=l().createObjectURL(e),void setTimeout(function(){var e,t;d.href=a,d.download=n,e=d,t=new MouseEvent("click"),e.dispatchEvent(t),i(),g(a),r.readyState=r.DONE});!function(){if((h||o&&u)&&s.FileReader){var t=new FileReader;return t.onloadend=function(){var e=h?t.result:t.result.replace(/^data:[^;]*;/,"data:attachment/file;");s.open(e,"_blank")||(s.location.href=e),e=void 0,r.readyState=r.DONE,i()},t.readAsDataURL(e),r.readyState=r.INIT}(a=a||l().createObjectURL(e),o)?s.location.href=a:s.open(a,"_blank")||(s.location.href=a);r.readyState=r.DONE,i(),g(a)}()},e=i.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=p(e)),navigator.msSaveOrOpenBlob(e,t)}:(e.abort=function(){},e.readyState=e.INIT=0,e.WRITING=1,e.DONE=2,e.error=e.onwritestart=e.onprogress=e.onwrite=e.onabort=e.onerror=e.onwriteend=null,function(e,t,n){return new i(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=Ie:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return Ie}),function(a,r,e){function o(n,e){if(!r[n]){if(!a[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var i=r[n]={exports:{}};a[n][0].call(i.exports,function(e){var t=a[n][1][e];return o(t||e)},i,i.exports)}return r[n].exports}for(var s="function"==typeof require&&require,t=0;t<e.length;t++)o(e[t])}({1:[function(e,t,n){var i=e("./lib/WAAClock");t.exports=i,"undefined"!=typeof window&&(window.WAAClock=i)},{"./lib/WAAClock":2}],3:[function(e,t,n){var i=t.exports={};i.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;t!==window&&null!==t||"process-tick"!==e.data||(e.stopPropagation(),0<n.length&&n.shift()())},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),i.title="browser",i.browser=!0,i.env={},i.argv=[],i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")}},{}],2:[function(e,t,n){var i=e("__browserify_process");if("undefined"!=typeof window&&!AudioContext)throw new Error("This browser doesn't seem to support web audio API");function a(e,t,n){this.clock=e,this.func=n,this.repeatTime=null,this.toleranceLate=r,this.toleranceEarly=o,this._armed=!1,this._latestTime=null,this._earliestTime=null,this.schedule(t)}var r=.1,o=.001;a.prototype.clear=function(){return this.clock._removeEvent(this),this},a.prototype.repeat=function(e){if(0===e)throw new Error("delay cannot be 0");return this.repeatTime=e,this},a.prototype.tolerance=function(e){return"number"==typeof e.late&&(this.toleranceLate=e.late),"number"==typeof e.early&&(this.toleranceEarly=e.early),this._update(),this},a.prototype.isRepeated=function(){return null!==this.repeatTime},a.prototype.schedule=function(e){this._armed=!0,this.deadline=e,this._update(),this._earliestTime<=this.clock.context.currentTime&&(this.clock._removeEvent(this),this._execute())},a.prototype._execute=function(){this._armed=!1,this.clock.context.currentTime<this._latestTime?this.func(this):ye&&ye.trigger(ce.clockEventExpired),!1===this._armed&&this.isRepeated()&&this.schedule(this.deadline+this.repeatTime)},a.prototype._update=function(){this._latestTime=this.deadline+this.toleranceLate,this._earliestTime=this.deadline-this.toleranceEarly,this.clock._removeEvent(this),this.clock._insertEvent(this)};var s=t.exports=function(e,t){this.toleranceEarly=(t=t||{}).toleranceEarly||o,this.toleranceLate=t.toleranceLate||r,this.context=e,this._events=[],this._started=!1};s.prototype.setTimeout=function(e,t){return this._createEvent(e,this._absTime(t))},s.prototype.callbackAtTime=function(e,t){return this._createEvent(e,t)},s.prototype.timeStretch=function(n,e,i){var a=this.context.currentTime;return e.forEach(function(e){e.isRepeated()&&e.repeat(e.repeatTime*i);var t=n+i*(e.deadline-n);if(e.isRepeated())for(;t-e.toleranceEarly<=a;)t+=e.repeatTime;e.schedule(t)}),e},s.prototype.start=function(){if(!1===this._started){var e=this;this._started=!0,this._events=[];this._clockNode=this.context.createScriptProcessor(256,1,1),this._clockNode.connect(this.context.destination),this._clockNode.onaudioprocess=function(){i.nextTick(function(){e._tick()})}}},s.prototype.stop=function(){!0===this._started&&(this._started=!1,this._clockNode.disconnect())},s.prototype._tick=function(){for(var e=this._events.shift();e&&e._earliestTime<=this.context.currentTime;)e._execute(),e=this._events.shift();e&&this._events.unshift(e)},s.prototype._createEvent=function(e,t){var n=new a(this,t,e);return n.tolerance({late:this.toleranceLate,early:this.toleranceEarly}),n},s.prototype._insertEvent=function(e){this._events.splice(this._indexByTime(e._earliestTime),0,e)},s.prototype._removeEvent=function(e){var t=this._events.indexOf(e);-1!==t&&this._events.splice(t,1)},s.prototype._indexByTime=function(e){for(var t,n=0,i=this._events.length;n<i;)t=Math.floor((n+i)/2),this._events[t]._earliestTime<e?n=t+1:i=t;return n},s.prototype._absTime=function(e){return e+this.context.currentTime},s.prototype._relTime=function(e){return e-this.context.currentTime}},{__browserify_process:3}]},{},[1]),function(P){"use strict";function n(){this.crc=-1}function u(){}function C(e,t){var n,i;return n=new ArrayBuffer(e),i=new Uint8Array(n),t&&i.set(t,0),{buffer:n,array:i,view:new DataView(n)}}function e(){}function t(i){var a,r=this;r.size=0,r.init=function(e,t){var n=new Blob([i],{type:L});(a=new o(n)).init(function(){r.size=a.size,e()},t)},r.readUint8Array=function(e,t,n,i){a.readUint8Array(e,t,n,i)}}function i(d){var c,n=this;n.size=0,n.init=function(e){for(var t=d.length;"="==d.charAt(t-1);)t--;c=d.indexOf(",")+1,n.size=Math.floor(.75*(t-c)),e()},n.readUint8Array=function(e,t,n){var i,a=C(t),r=4*Math.floor(e/3),o=4*Math.ceil((e+t)/3),s=P.atob(d.substring(r+c,o+c)),l=e-3*Math.floor(r/4);for(i=l;i<l+t;i++)a.array[i-l]=s.charCodeAt(i);n(a.array)}}function o(r){var t=this;t.size=0,t.init=function(e){t.size=r.size,e()},t.readUint8Array=function(e,t,n,i){var a=new FileReader;a.onload=function(e){n(new Uint8Array(e.target.result))},a.onerror=i;try{a.readAsArrayBuffer(function(e,t,n){if(t<0||n<0||e.size<t+n)throw new RangeError("offset:"+t+", length:"+n+", size:"+e.size);return e.slice?e.slice(t,t+n):e.webkitSlice?e.webkitSlice(t,t+n):e.mozSlice?e.mozSlice(t,t+n):e.msSlice?e.msSlice(t,t+n):void 0}(r,e,t))}catch(e){i(e)}}}function a(a){var n=this;n.size=0,n.init=function(e,t){n.size=a.byteLength,e()},n.readUint8Array=function(e,t,n,i){n(new Uint8Array(a.slice(e,e+t)))}}function r(){}function s(i){var a;this.init=function(e){a=new Blob([],{type:L}),e()},this.writeUint8Array=function(e,t){a=new Blob([a,b?e:e.buffer],{type:L}),t()},this.getData=function(t,e){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=e,n.readAsText(a,i)}}function l(t){var r="",o="";this.init=function(e){r+="data:"+(t||"")+";base64,",e()},this.writeUint8Array=function(e,t){var n,i=o.length,a=o;for(o="",n=0;n<3*Math.floor((i+e.length)/3)-i;n++)a+=String.fromCharCode(e[n]);for(;n<e.length;n++)o+=String.fromCharCode(e[n]);2<a.length?r+=P.btoa(a):o=a,t()},this.getData=function(e){e(r+P.btoa(o))}}function d(n){var i;this.init=function(e){i=new Blob([],{type:n}),e()},this.writeUint8Array=function(e,t){i=new Blob([i,b?e:e.buffer],{type:n}),t()},this.getData=function(e){e(i)}}function c(){var a;this.init=function(e,t){a=new Uint8Array,e()},this.writeUint8Array=function(e,t,n){var i=new Uint8Array(a.length+e.length);i.set(a),i.set(e,a.length),a=i,t()},this.getData=function(e){e(a.buffer)}}function S(a,n,e,r,t,o,s,i,l,d){function c(){a.removeEventListener("message",u,!1),i(g,p)}function u(e){var t=e.data,n=t.data,i=t.error;if(i)return i.toString=function(){return"Error: "+this.message},void l(i);if(t.sn===v)switch("number"==typeof t.codecTime&&(a.codecTime+=t.codecTime),"number"==typeof t.crcTime&&(a.crcTime+=t.crcTime),t.type){case"append":n?(g+=n.length,r.writeUint8Array(n,function(){h()},d)):h();break;case"flush":p=t.crc,n?(g+=n.length,r.writeUint8Array(n,function(){c()},d)):c();break;case"progress":s&&s(f+t.loaded,o)}}function h(){(f=m*F)<=o?e.readUint8Array(t+f,Math.min(F,o-f),function(e){s&&s(f,o);var t=0===f?n:{sn:v};t.type="append",t.data=e;try{a.postMessage(t,[e.buffer])}catch(e){a.postMessage(t)}m++},l):a.postMessage({sn:v,type:"flush"})}var f,g,p,m=0,v=n.sn;g=0,a.addEventListener("message",u,!1),h()}function y(i,t,a,r,o,e,s,l,d,c){var u,h=0,f=0,g="input"===e,p="output"===e,m=new n;!function n(){var e;if((u=h*F)<o)t.readUint8Array(r+u,Math.min(F,o-u),function(e){var t;try{t=i.append(e,function(e){s&&s(u+e,o)})}catch(e){return void d(e)}t?(f+=t.length,a.writeUint8Array(t,function(){h++,setTimeout(n,1)},c),p&&m.append(t)):(h++,setTimeout(n,1)),g&&m.append(e),s&&s(u,o)},d);else{try{e=i.flush()}catch(e){return void d(e)}e?(p&&m.append(e),f+=e.length,a.writeUint8Array(e,function(){l(f,m.get())},c)):l(f,m.get())}}()}function _(e,t,n,i,a,r,o,s,l,d,c){P.zip.useWebWorkers&&o?S(e,{sn:t,codecClass:"NOOP",crcType:"input"},n,i,a,r,l,s,d,c):y(new u,n,i,a,r,"input",l,s,d,c)}function h(e){var t,n,i="",a=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)i+=127<(n=255&e.charCodeAt(t))?a[n-128]:String.fromCharCode(n);return i}function f(e){return decodeURIComponent(escape(e))}function g(e){var t,n="";for(t=0;t<e.length;t++)n+=String.fromCharCode(e[t]);return n}function I(e,t,n,i,a){e.version=t.view.getUint16(n,!0),e.bitFlag=t.view.getUint16(n+2,!0),e.compressionMethod=t.view.getUint16(n+4,!0),e.lastModDateRaw=t.view.getUint32(n+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,n=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&n)>>11,(2016&n)>>5,2*(31&n),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?(!i&&8==(8&e.bitFlag)||(e.crc32=t.view.getUint32(n+10,!0),e.compressedSize=t.view.getUint32(n+14,!0),e.uncompressedSize=t.view.getUint32(n+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(n+22,!0),e.extraFieldLength=t.view.getUint16(n+24,!0)):a(x)):a(w)}function p(w,t,x){function u(){}var k=0;u.prototype.getData=function(h,a,f,g){function p(e,t){var n,i;g&&(n=t,(i=C(4)).view.setUint32(0,n),b.crc32!=i.view.getUint32(0))?x("CRC failed."):h.getData(function(e){a(e)})}function m(e){x(e||D)}function v(e){x(e||"Error while writing file data.")}var b=this;w.readUint8Array(b.offset,30,function(e){var u,t=C(e.length,e);1347093252==t.view.getUint32(0)?(I(b,t,4,!1,x),u=b.offset+30+b.filenameLength+b.extraFieldLength,h.init(function(){var e,t,n,i,a,r,o,s,l,d,c;0===b.compressionMethod?_(b._worker,k++,w,h,u,b.compressedSize,g,p,f,m,v):(e=b._worker,t=k++,n=w,i=h,a=u,r=b.compressedSize,o=p,s=f,l=m,d=v,c=g?"output":"none",P.zip.useWebWorkers?S(e,{sn:t,codecClass:"Inflater",crcType:c},n,i,a,r,s,o,l,d):y(new P.zip.Inflater,n,i,a,r,c,s,o,l,d))},v)):x(A)},m)};var n={getEntries:function(d){var c=this._worker;!function(i){function e(e,n){w.readUint8Array(w.size-e,e,function(e){for(var t=e.length-a;0<=t;t--)if(80===e[t]&&75===e[t+1]&&5===e[t+2]&&6===e[t+3])return void i(new DataView(e.buffer,t,a));n()},function(){x(E)})}var a=22;if(w.size<a)x(A);else{var t=a+65536;e(a,function(){e(Math.min(t,w.size),function(){x(A)})})}}(function(e){var t,l;t=e.getUint32(16,!0),l=e.getUint16(8,!0),t<0||w.size<=t?x(A):w.readUint8Array(t,w.size-t,function(e){var t,n,i,a,r=0,o=[],s=C(e.length,e);for(t=0;t<l;t++){if((n=new u)._worker=c,1347092738!=s.view.getUint32(r))return void x(A);I(n,s,r+6,!0,x),n.commentLength=s.view.getUint16(r+32,!0),n.directory=16==(16&s.view.getUint8(r+38)),n.offset=s.view.getUint32(r+42,!0),i=g(s.array.subarray(r+46,r+46+n.filenameLength)),n.filename=(2048==(2048&n.bitFlag)?f:h)(i),n.directory||"/"!=n.filename.charAt(n.filename.length-1)||(n.directory=!0),a=g(s.array.subarray(r+46+n.filenameLength+n.extraFieldLength,r+46+n.filenameLength+n.extraFieldLength+n.commentLength)),n.comment=(2048==(2048&n.bitFlag)?f:h)(a),o.push(n),r+=46+n.filenameLength+n.extraFieldLength+n.commentLength}d(o)},function(){x(E)})})},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};P.zip.useWebWorkers?M("inflater",function(e){n._worker=e,t(n)},function(e){x(e)}):t(n)}function k(e){return unescape(encodeURIComponent(e))}function T(e){var t,n=[];for(t=0;t<e.length;t++)n.push(e.charCodeAt(t));return n}function m(g,t,s,p){function m(e){s(e||"Error while writing zip file.")}function v(e){s(e||D)}var l={},b=[],w=0,x=0,n={add:function(n,d,i,c,u){function h(e,t){var n=C(16);w+=e||0,n.view.setUint32(0,1347094280),void 0!==t&&(a.view.setUint32(10,t,!0),n.view.setUint32(4,t,!0)),d&&(n.view.setUint32(8,e,!0),a.view.setUint32(14,e,!0),n.view.setUint32(12,d.size,!0),a.view.setUint32(18,d.size,!0)),g.writeUint8Array(n.array,function(){w+=16,i()},m)}function e(){var e,t;(u=u||{},n=n.trim(),u.directory&&"/"!=n.charAt(n.length-1)&&(n+="/"),l.hasOwnProperty(n))?s("File already exists."):(r=T(k(n)),b.push(n),e=function(){var e,t,n,i,a,r,o,s,l;d?p||0===u.level?_(f,x++,d,g,0,d.size,!0,h,c,v,m):(e=f,t=x++,n=d,i=g,a=u.level,r=h,o=c,s=v,l=m,P.zip.useWebWorkers?S(e,{sn:t,options:{level:a},codecClass:"Deflater",crcType:"input"},n,i,0,n.size,o,r,s,l):y(new P.zip.Deflater,n,i,0,n.size,"input",o,r,s,l)):h()},o=u.lastModDate||new Date,a=C(26),l[n]={headerArray:a.array,directory:u.directory,filename:r,offset:w,comment:T(k(u.comment||""))},a.view.setUint32(0,335546376),u.version&&a.view.setUint8(0,u.version),p||0===u.level||u.directory||a.view.setUint16(4,2048),a.view.setUint16(6,(o.getHours()<<6|o.getMinutes())<<5|o.getSeconds()/2,!0),a.view.setUint16(8,(o.getFullYear()-1980<<4|o.getMonth()+1)<<5|o.getDate(),!0),a.view.setUint16(22,r.length,!0),(t=C(30+r.length)).view.setUint32(0,1347093252),t.array.set(a.array,4),t.array.set(r,30),w+=t.array.length,g.writeUint8Array(t.array,e,m))}var a,r,o,f=this._worker;d?d.init(e,v):e()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var t,n,i,a=0,r=0;for(n=0;n<b.length;n++)a+=46+(i=l[b[n]]).filename.length+i.comment.length;for(t=C(a+22),n=0;n<b.length;n++)i=l[b[n]],t.view.setUint32(r,1347092738),t.view.setUint16(r+4,5120),t.array.set(i.headerArray,r+6),t.view.setUint16(r+32,i.comment.length,!0),i.directory&&t.view.setUint8(r+38,16),t.view.setUint32(r+42,i.offset,!0),t.array.set(i.filename,r+46),t.array.set(i.comment,r+46+i.filename.length),r+=46+i.filename.length+i.comment.length;t.view.setUint32(r,1347093766),t.view.setUint16(r+8,b.length,!0),t.view.setUint16(r+10,b.length,!0),t.view.setUint32(r+12,a,!0),t.view.setUint32(r+16,w,!0),g.writeUint8Array(t.array,function(){g.getData(e)},m)},_worker:null};P.zip.useWebWorkers?M("deflater",function(e){n._worker=e,t(n)},function(e){s(e)}):t(n)}function M(e,i,a){function r(e){s.terminate(),a(e)}if(null===P.zip.workerScripts||null===P.zip.workerScriptsPath){var t,n,o;if(P.zip.workerScripts){if(t=P.zip.workerScripts[e],!Array.isArray(t))return void a(new Error("zip.workerScripts."+e+" is not an array!"));n=t,o=document.createElement("a"),t=n.map(function(e){return o.href=e,o.href})}else(t=B[e].slice(0))[0]=(P.zip.workerScriptsPath||"")+t[0];var s=new Worker(t[0]);s.codecTime=s.crcTime=0,s.postMessage({type:"importScripts",scripts:t.slice(1)}),s.addEventListener("message",function e(t){var n=t.data;if(n.error)return s.terminate(),void a(n.error);"importScripts"===n.type&&(s.removeEventListener("message",e),s.removeEventListener("error",r),i(s))}),s.addEventListener("error",r)}else a(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."))}function v(e){}var b,A="File format is not recognized.",w="File contains encrypted entry.",x="File is using Zip64 (4gb+ file size).",E="Error while reading zip file.",D="Error while reading file data.",F=524288,L="text/plain";try{b=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}n.prototype.append=function(e){for(var t=0|this.crc,n=this.table,i=0,a=0|e.length;i<a;i++)t=t>>>8^n[255&(t^e[i])];this.crc=t},n.prototype.get=function(){return~this.crc},n.prototype.table=function(){var e,t,n,i=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)1&n?n=n>>>1^3988292384:n>>>=1;i[e]=n}return i}(),u.prototype.append=function(e){return e},u.prototype.flush=function(){},(t.prototype=new e).constructor=t,(i.prototype=new e).constructor=i,(o.prototype=new e).constructor=o,(a.prototype=new e).constructor=a,r.prototype.getData=function(e){e(this.data)},(s.prototype=new r).constructor=s,(l.prototype=new r).constructor=l,(d.prototype=new r).constructor=d,c.prototype=new r;var B={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};P.zip={Reader:e,Writer:r,BlobReader:o,ArrayBufferReader:a,Data64URIReader:i,TextReader:t,BlobWriter:d,ArrayBufferWriter:c.prototype.constructor=c,Data64URIWriter:l,TextWriter:s,createReader:function(e,t,n){e.init(function(){p(e,t,n)},n=n||v)},createWriter:function(e,t,n,i){i=!!i,e.init(function(){m(e,t,n,i)},n=n||v)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(this);var Te,Me,Ae,Ee,De,Fe,Le,Be,Re,Ve,Ue,We,ze,Oe=((Te={}).buildNumber="undefined"==typeof buildNumber?"":buildNumber,Te.init=function(){"object"==typeof Mt&&Se&&Se.midi&&"disabled"!==Se.midi&&Mt.init(),ye.on(ce.command,function(e){switch(window.focus(),e){case z.newFile:ot.new();break;case z.openFile:ye.trigger(ce.showView,"diskop_modules_load");break;case z.saveFile:ye.trigger(ce.showView,"diskop_modules_save");break;case z.clearTrack:Ne.clearTrack();break;case z.clearPattern:Ne.clearPattern();break;case z.clearInstruments:ot.clearInstruments();break;case z.clearSong:Ne.clearSong();break;case z.showMain:ye.trigger(ce.showView,"main");break;case z.showTopMain:ye.trigger(ce.showView,"topmain");break;case z.showBottomMain:ye.trigger(ce.showView,"bottommain");break;case z.showOptions:ye.trigger(ce.showView,"options");break;case z.showFileOperations:ye.trigger(ce.showView,"diskop_load");break;case z.showSampleEditor:ye.trigger(ce.showView,"sample");break;case z.togglePiano:ye.trigger(ce.toggleView,"piano");break;case z.toggleAppSideBar:ye.trigger(ce.toggleView,"sidebar");break;case z.showAbout:var t=de.modalDialog();t.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0}),t.onClick=t.close;var n=Xe.getVersionNumber();Xe.getBuildNumber(),t.setText("BassoonTracker//Old School Amiga MOD and XM tracker/in plain javascript//©2017-2021 by Steffest//version "+n+"//Fork me on Github!"),de.setModalElement(t);break;case z.showHelp:window.open("https://www.stef.be/bassoontracker/docs/");break;case z.randomSong:de.diskOperations.playRandomSong();break;case z.randomSongXM:de.diskOperations.playRandomSong("xm");break;case z.showGithub:window.open("https://github.com/steffest/bassoontracker");break;case z.showStats:if(document.getElementById("MrDStats"))break;var i=document.createElement("script");i.onload=function(){var t=new Stats;document.body.appendChild(t.dom),requestAnimationFrame(function e(){t.update(),requestAnimationFrame(e)})},i.src="script/plugins/stats.js",document.head.appendChild(i);break;case z.cut:de.cutSelection(!0);break;case z.copy:de.copySelection(!0);break;case z.paste:de.pasteSelection(!0);break;case z.pattern2Sample:Ne.renderTrackToBuffer();break;case z.undo:ye.trigger(ce.commandUndo);break;case z.redo:ye.trigger(ce.commandRedo);break;case z.nibbles:sn.load("Nibbles",function(){Nibbles.init({UI:de,Input:ht,Y:lt,EventBus:ye,EVENT:ce,COMMAND:z,Layout:ct})})}})},Te.doCommand=function(e){ye.trigger(ce.command,e)},Te),Ne=(Be=Le=Fe=De=Ee=0,Re={},(Ae={}).getStepsPerTrack=function(){return ot.inFTMode()?8:6},Ae.setCurrentCursorPosition=function(e){Fe=e;var t=Ae.getStepsPerTrack();Ee=Math.floor(Fe/t),De=Fe%t,Me!==Fe&&ye.trigger(ce.cursorPositionChange,Fe),Me=Fe},Ae.getCurrentCursorPosition=function(){return Fe},Ae.moveCursorPosition=function(e){var t=Ae.getStepsPerTrack(),n=Fe+e,i=ot.getTrackCount()*t-1;i<n&&(n=0),n<0&&(n=i),Ae.setCurrentCursorPosition(n)},Ae.getCurrentTrack=function(){return Ee},Ae.setCurrentTrack=function(e){var t=Ae.getStepsPerTrack();Ae.setCurrentCursorPosition(e*t+De)},Ae.getCurrentTrackPosition=function(){return De},Ae.setCurrentTrackPosition=function(e){var t=Ae.getStepsPerTrack();Ae.setCurrentCursorPosition(Ee*t+e)},Ae.putNote=function(e,t,n,i){var a=ot.getSong().patterns[Le][Be][Ee]||new Nt,r=_t.createNoteUndo(Le,Ee,Be,a);a&&(a.instrument=e,n?a.setIndex(n):a.setPeriod(t),"number"==typeof i&&(ot.inFTMode()?a.volumeEffect=i+16:(a.effect=12,a.param=i))),r.data[0].to=a.duplicate(),_t.registerEdit(r),ot.getSong().patterns[Le][Be][Ee]=a,ye.trigger(ce.patternChange,Le)},Ae.putNoteParam=function(e,t){var n,i,a=ot.getSong().patterns[Le][Be][Ee],r=_t.createNoteUndo(Le,Ee,Be,a);if(a){if(1==e||2==e){var o=a.instrument;n=o>>4,i=15&o,1==e&&(n=t),2==e&&(i=t),a.instrument=(n<<4)+i}var s=0;if(ot.inFTMode()&&(s=2,3==e||4==e)){var l=a.volumeEffect;n=l>>4||1,i=15&l,3==e&&(n=t+1),4==e&&(i=t),a.volumeEffect=(n<<4)+i,a.volumeEffect<16&&(a.volumeEffect=0)}if(e==3+s&&(a.effect=t),e==4+s||e==5+s){var d=a.param;n=d>>4,i=15&d,e==4+s&&(n=t),e==5+s&&(i=t),a.param=(n<<4)+i}}r.data[0].to=a.duplicate(),_t.registerEdit(r),ot.getSong().patterns[Le][Be][Ee]=a,ye.trigger(ce.patternChange,Le)},Ae.clearTrack=function(){var e=ot.getCurrentPatternData().length,t=_t.createTrackUndo(Le);t.name="Clear Track";for(var n=0;n<e;n++){var i=ot.getSong().patterns[Le][n][Ee];i&&(_t.addNote(t,Ee,n,i),i.clear())}_t.registerEdit(t),ye.trigger(ce.patternChange,Le)},Ae.clearPattern=function(){var e=ot.getCurrentPatternData().length,t=_t.createPatternUndo(Le);t.name="Clear Pattern";for(var n=0;n<e;n++)for(var i=0;i<ot.getTrackCount();i++){var a=ot.getSong().patterns[Le][n][i];a&&(_t.addNote(t,i,n,a),a.clear())}_t.registerEdit(t),ye.trigger(ce.patternChange,Le)},Ae.clearSong=function(){var e=ot.getSong();ot.setCurrentPattern(0),Ae.clearPattern(),e.patterns=[e.patterns[0]],e.length=1;for(var t=[],n=e.restartPosition=0;n<128;++n)t[n]=0;e.patternTable=t,ot.setAmigaSpeed(6),ot.setBPM(125),ot.setCurrentSongPosition(1),ye.trigger(ce.songPropertyChange,e),ye.trigger(ce.patternTableChange)},Ae.copyTrack=function(e){var t=void 0!==e;t||(e=Ee);for(var n=ot.getCurrentPatternData().length,i=[],a=0;a<n;a++){var r=ot.getSong().patterns[Le][a][e]||new Nt;i.push(r.duplicate())}if(t)return i;Re.track=i},Ae.copyPattern=function(){for(var e=[],t=0;t<ot.getTrackCount();t++){var n=Ae.copyTrack(t);e.push(n)}Re.pattern=e},Ae.getPasteData=function(){return Re},Ae.pasteTrack=function(e,t,n){var i=void 0!==e,a=t;if(i||(e=Ee,a=Re.track),a){var r;n?r=n:(r=_t.createTrackUndo(Le)).name="Paste Track";for(var o=ot.getCurrentPatternData().length,s=ot.getSong().patterns[Le],l=0;l<o;l++){var d=s[l][e];d||(d=new Nt,s[l][e]=d);var c=a[l],u=_t.addNote(r,e,l,d);d.populate(u.to=c)}return i||ye.trigger(ce.patternChange,Le),n||_t.registerEdit(r),!0}return!1},Ae.pastePattern=function(){var e=Re.pattern;if(e){var t=_t.createPatternUndo(Le);t.name="Paste Pattern";for(var n=0;n<ot.getTrackCount();n++)Ae.pasteTrack(n,e[n],t);return _t.registerEdit(t),ye.trigger(ce.patternChange,Le),!0}return!1},Ae.insertNote=function(){for(var e=ot.getSong().patterns[Le].length-2,t=Be,n=e;t<=n;n--){var i=ot.getSong().patterns[Le][n][Ee],a=ot.getSong().patterns[Le][n+1][Ee];a.instrument=i.instrument,a.period=i.period,a.effect=i.effect,a.volumeEffect=i.volumeEffect,a.param=i.param,a.index=i.index}(i=ot.getSong().patterns[Le][Be][Ee])&&i.clear(),ye.trigger(ce.patternChange,Le)},Ae.removeNote=function(e,t){if(void 0===e&&(e=Ee),void 0===t&&(t=Be),0!==t){for(var n=t,i=ot.getSong().patterns[Le].length-1,a=n;a<=i;a++){var r=ot.getSong().patterns[Le][a][e],o=ot.getSong().patterns[Le][a-1][e];o.instrument=r.instrument,o.period=r.period,o.effect=r.effect,o.volumeEffect=r.volumeEffect,o.param=r.param,o.index=r.index}(r=ot.getSong().patterns[Le][i][e])&&r.clear(),ye.trigger(ce.patternChange,Le)}},Ae.addToPatternTable=function(e,t){var n=ot.getSong();if(void 0===e&&(e=n.length),t=t||0,e===n.length)n.patternTable[e]=t,n.length++;else{for(var i=n.length;e<i;i--)n.patternTable[i]=n.patternTable[i-1];n.patternTable[e]=t,n.length++}ye.trigger(ce.songPropertyChange,n),ye.trigger(ce.patternTableChange)},Ae.removeFromPatternTable=function(e){var t=ot.getSong();if(!(t.length<2)){if(void 0===e&&(e=t.length-1),e===t.length-1)t.patternTable[e]=0,t.length--;else{for(var n=e;n<t.length;n++)t.patternTable[n]=t.patternTable[n+1];t.length--}var i=ot.getCurrentSongPosition();i===t.length&&ot.setCurrentSongPosition(i-1),ye.trigger(ce.songPropertyChange,t),ye.trigger(ce.patternTableChange)}},Ae.renderTrackToBuffer=function(e,t){var n=ot.getSong(),i=0,a=ot.getCurrentSongPosition(),r=ot.getCurrentPatternData().length,o=.1,s=ot.getProperties(),l=s.ticksPerStep,d=s.tickTime,c=1,u=(a=0)+c;for(u=Math.min(u,n.length),_e.startRendering(l*d*r*(c=u-a)+.2);a<u;){var h=n.patterns[n.patternTable[a]];for(r=h.length;i<r;)ot.playPatternStep(i,o,h),o+=l*d,i++;i=0,a++}_e.stopRendering(function(e){Ae.buffer2Sample(e)})},Ae.save=function(i,a){de.setStatus("Exporting ...",!0),Ae.buildBinary(ot.inFTMode()?u:g,function(e){var t=new Blob([e.buffer],{type:"application/octet-stream"}),n=i||Ae.getFileName();"function"!=typeof a?"dropbox"===a?(Ge.info("save to dropbox "+n),Qt.putFile("/"+n,t,function(e){de.setStatus(e?"":"Error while saving to Dropbox ...")})):(Ge.info("save "+n),Ie(t,n),de.setStatus("")):a(t)})},Ae.importSample=function(e,t){var n=ot.getCurrentInstrument()||Ot();n.name=t,n.sample.length=e.length,n.sample.loop.start=0,n.sample.loop.length=0,n.setFineTune(0),n.sample.volume=64,n.sample.data=[],n.sample.name=t,function(e,t,n){var i=p.RAW_8BIT,a=l;e.goto(0);var r=e.readString(4);if("RIFF"==r&&(i=p.WAVE_PCM,a=d),"FORM"==r&&(e.goto(8),"8SVX"==e.readString(4)&&(i=p.IFF_8SVX,a=o)),t&&t.name&&".mp3"==t.name.toLowerCase().slice(-4)&&(i=p.MP3,a=s),t&&a)a(e,t,n);else{if(!n)return;n(i)}}(e,n.sample,function(){ye.trigger(ce.instrumentChange,ot.getCurrentInstrumentIndex()),ye.trigger(ce.instrumentNameChange,ot.getCurrentInstrumentIndex()),function(){if(ot.getTrackerMode()===Pe&&131070<n.sample.length){var e=de.modalDialog();e.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0}),e.onClick=e.close,e.setText("Warning//The maximum sample lenght in .MOD format is 128kb//If you save in .MOD format/this sample will be truncated.//Please try downsampling or trimming the sample/to below 131072 bytes/or switch to .XM format"),de.setModalElement(e)}}()}),ye.trigger(ce.instrumentChange,ot.getCurrentInstrumentIndex()),ye.trigger(ce.instrumentNameChange,ot.getCurrentInstrumentIndex())},Ae.buffer2Sample=function(e){var t=ot.getCurrentInstrument()||Ot(),n="pattern "+ot.getCurrentPattern();t.name=n,t.sample.loop.start=0,t.sample.loop.length=0,t.setFineTune(0),t.sample.volume=64,t.sample.name=n;var a=e.getChannelData(0);t.sample.data=[];var r=Math.floor(_e.context.sampleRate/10);for(i=r,len=a.length;i<len;i+=4)t.sample.data.push(a[i]);t.sample.length=t.sample.data.length,ye.trigger(ce.instrumentChange,ot.getCurrentInstrumentIndex()),ye.trigger(ce.instrumentNameChange,ot.getCurrentInstrumentIndex())},Ae.buildBinary=function(e,t){var n;(e=e||g)===g&&(n=Rt()),e===u&&(n=Bt()),n&&n.write(t)},Ae.loadInitialFile=function(){var e=G("file");e?"http://"===(e=decodeURIComponent(e)).substr(0,7).toLowerCase()&&"https:"===document.location.protocol?e=Xt.proxyUrl(e):"proxy/"===e.substr(0,6).toLowerCase()&&(e=Xt.proxyUrl(e.substr(6))):Se.loadInitialFile&&(e=Xe.getBaseUrl()+"demomods/Tinytune.mod"),e&&ot.load(e,!0,void 0,!0)},ye.on(ce.trackerModeChanged,function(e){Ae.setCurrentTrackPosition(0)}),ye.on(ce.patternChange,function(e){Le=e}),ye.on(ce.patternPosChange,function(e){Be=e.current}),ye.on(ce.trackCountChange,function(e){e*Ae.getStepsPerTrack()<=Fe&&Ae.setCurrentTrack(e-1)}),Ae),He=((Ve={}).get=function(e,t){Ve.ajax({url:e,success:function(e){t(e)},error:function(e){t(void 0,e)}})},Ve.post=function(e,t,n){var i=t;if("object"==typeof t){for(var a in i="",t)t.hasOwnProperty(a)&&(i+="&"+a+"="+encodeURIComponent(t[a]));i.length&&(i=i.substr(1))}Ve.ajax({method:"POST",url:e,data:i,datatype:"form",success:function(e){n(e)},error:function(e){n(void 0,e)}})},Ve.sendBinary=function(e,t,n){Ve.ajax({method:"POST",url:e,data:t,success:function(e){n(e)},error:function(e){n(void 0,e)}})},Ve.json=function(e,t){void 0===t&&(t=function(){}),Ve.ajax({url:e,cache:!1,datatype:"json",headers:[{key:"Accept",value:"application/json"}],success:function(e){t(e)},error:function(e){t(void 0,e)}})},Ve.html=function(e,t){Ve.ajax({url:e,cache:!1,datatype:"html",success:function(e){t(e)},error:function(e){t(void 0,e)}})},Ve.ajax=function(t){var n=new XMLHttpRequest;t.error=t.error||function(){t.success(!1)},"jsonp"===t.datatype&&t.error(n);var e=t.url;if("boolean"==typeof t.cache&&!t.cache&&Xe.useUrlParams){var i=(new Date).getTime();e+=0<e.indexOf("?")?"&r="+i:"?r="+i}var a=t.method||"GET";n.onreadystatechange=function(){if(!(n.readyState<4)&&4===n.readyState)if(200!==n.status&&201!==n.status)t.error(n);else{var e=n.responseText;"json"===t.datatype&&(e=JSON.parse(e)),"html"===t.datatype&&((e=document.createElement("div")).innerHTML=n.responseText),t.success(e)}},n.ontimeout=function(e){},n.open(a,e,!0),n.timeout=t.timeout||3e4,t.headers&&t.headers.forEach(function(e){n.setRequestHeader(e.key,e.value)});var r=t.data||"";"POST"===a&&t.data&&"form"===t.datatype&&n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send(r)},Ve),Xe=((We={}).useUrlParams=!0,We.useDropbox=!0,We.showInternalMenu=!0,We.useWebWorkers=!0,We.useInitialLoad=!0,We.init=function(){"object"==typeof HostBridge&&((Ue=HostBridge).init(),"boolean"==typeof Ue.useUrlParams&&(We.useUrlParams=Ue.useUrlParams),"boolean"==typeof Ue.useDropbox&&(We.useDropbox=Ue.useDropboxs),"boolean"==typeof Ue.showInternalMenu&&(We.showInternalMenu=Ue.showInternalMenu),"boolean"==typeof Ue.useWebWorkers&&(We.useWebWorkers=Ue.useWebWorkers))},We.getBaseUrl=function(){return Ue&&Ue.getBaseUrl?Ue.getBaseUrl():void 0!==Ke&&Ke.baseUrl||""},We.getRemoteUrl=function(){return Ue&&Ue.getRemoteUrl?Ue.getRemoteUrl():""},We.getVersionNumber=function(){return"undefined"!=typeof versionNumber?versionNumber:Ue&&Ue.getVersionNumber?Ue.getVersionNumber():"dev"},We.getBuildNumber=function(){return"undefined"!=typeof buildNumber?buildNumber:Ue&&Ue.getBuildNumber?Ue.getBuildNumber():(new Date).getTime()},We.signalReady=function(){Ue&&Ue.signalReady&&Ue.signalReady()},We.putFile=function(e,t){},We),Ge=function(){var e={};e.info=function(e){t("info",e)},e.warn=function(e){t("warn",e)},e.error=function(e){t("error",e)};var t=function(e,t){var n,i=de.stats(),a="undefined"==typeof versionNumber?"dev":versionNumber;n={"Á":"A","Ă":"A","Ắ":"A","Ặ":"A","Ằ":"A","Ẳ":"A","Ẵ":"A","Ǎ":"A","Â":"A","Ấ":"A","Ậ":"A","Ầ":"A","Ẩ":"A","Ẫ":"A","Ä":"A","Ǟ":"A","Ȧ":"A","Ǡ":"A","Ạ":"A","Ȁ":"A","À":"A","Ả":"A","Ȃ":"A","Ā":"A","Ą":"A","Å":"A","Ǻ":"A","Ḁ":"A","Ⱥ":"A","Ã":"A","Ꜳ":"AA","Æ":"AE","Ǽ":"AE","Ǣ":"AE","Ꜵ":"AO","Ꜷ":"AU","Ꜹ":"AV","Ꜻ":"AV","Ꜽ":"AY","Ḃ":"B","Ḅ":"B","Ɓ":"B","Ḇ":"B","Ƀ":"B","Ƃ":"B","Ć":"C","Č":"C","Ç":"C","Ḉ":"C","Ĉ":"C","Ċ":"C","Ƈ":"C","Ȼ":"C","Ď":"D","Ḑ":"D","Ḓ":"D","Ḋ":"D","Ḍ":"D","Ɗ":"D","Ḏ":"D","ǲ":"D","ǅ":"D","Đ":"D","Ƌ":"D","Ǳ":"DZ","Ǆ":"DZ","É":"E","Ĕ":"E","Ě":"E","Ȩ":"E","Ḝ":"E","Ê":"E","Ế":"E","Ệ":"E","Ề":"E","Ể":"E","Ễ":"E","Ḙ":"E","Ë":"E","Ė":"E","Ẹ":"E","Ȅ":"E","È":"E","Ẻ":"E","Ȇ":"E","Ē":"E","Ḗ":"E","Ḕ":"E","Ę":"E","Ɇ":"E","Ẽ":"E","Ḛ":"E","Ꝫ":"ET","Ḟ":"F","Ƒ":"F","Ǵ":"G","Ğ":"G","Ǧ":"G","Ģ":"G","Ĝ":"G","Ġ":"G","Ɠ":"G","Ḡ":"G","Ǥ":"G","Ḫ":"H","Ȟ":"H","Ḩ":"H","Ĥ":"H","Ⱨ":"H","Ḧ":"H","Ḣ":"H","Ḥ":"H","Ħ":"H","Í":"I","Ĭ":"I","Ǐ":"I","Î":"I","Ï":"I","Ḯ":"I","İ":"I","Ị":"I","Ȉ":"I","Ì":"I","Ỉ":"I","Ȋ":"I","Ī":"I","Į":"I","Ɨ":"I","Ĩ":"I","Ḭ":"I","Ꝺ":"D","Ꝼ":"F","Ᵹ":"G","Ꞃ":"R","Ꞅ":"S","Ꞇ":"T","Ꝭ":"IS","Ĵ":"J","Ɉ":"J","Ḱ":"K","Ǩ":"K","Ķ":"K","Ⱪ":"K","Ꝃ":"K","Ḳ":"K","Ƙ":"K","Ḵ":"K","Ꝁ":"K","Ꝅ":"K","Ĺ":"L","Ƚ":"L","Ľ":"L","Ļ":"L","Ḽ":"L","Ḷ":"L","Ḹ":"L","Ⱡ":"L","Ꝉ":"L","Ḻ":"L","Ŀ":"L","Ɫ":"L","ǈ":"L","Ł":"L","Ǉ":"LJ","Ḿ":"M","Ṁ":"M","Ṃ":"M","Ɱ":"M","Ń":"N","Ň":"N","Ņ":"N","Ṋ":"N","Ṅ":"N","Ṇ":"N","Ǹ":"N","Ɲ":"N","Ṉ":"N","Ƞ":"N","ǋ":"N","Ñ":"N","Ǌ":"NJ","Ó":"O","Ŏ":"O","Ǒ":"O","Ô":"O","Ố":"O","Ộ":"O","Ồ":"O","Ổ":"O","Ỗ":"O","Ö":"O","Ȫ":"O","Ȯ":"O","Ȱ":"O","Ọ":"O","Ő":"O","Ȍ":"O","Ò":"O","Ỏ":"O","Ơ":"O","Ớ":"O","Ợ":"O","Ờ":"O","Ở":"O","Ỡ":"O","Ȏ":"O","Ꝋ":"O","Ꝍ":"O","Ō":"O","Ṓ":"O","Ṑ":"O","Ɵ":"O","Ǫ":"O","Ǭ":"O","Ø":"O","Ǿ":"O","Õ":"O","Ṍ":"O","Ṏ":"O","Ȭ":"O","Ƣ":"OI","Ꝏ":"OO","Ɛ":"E","Ɔ":"O","Ȣ":"OU","Ṕ":"P","Ṗ":"P","Ꝓ":"P","Ƥ":"P","Ꝕ":"P","Ᵽ":"P","Ꝑ":"P","Ꝙ":"Q","Ꝗ":"Q","Ŕ":"R","Ř":"R","Ŗ":"R","Ṙ":"R","Ṛ":"R","Ṝ":"R","Ȑ":"R","Ȓ":"R","Ṟ":"R","Ɍ":"R","Ɽ":"R","Ꜿ":"C","Ǝ":"E","Ś":"S","Ṥ":"S","Š":"S","Ṧ":"S","Ş":"S","Ŝ":"S","Ș":"S","Ṡ":"S","Ṣ":"S","Ṩ":"S","Ť":"T","Ţ":"T","Ṱ":"T","Ț":"T","Ⱦ":"T","Ṫ":"T","Ṭ":"T","Ƭ":"T","Ṯ":"T","Ʈ":"T","Ŧ":"T","Ɐ":"A","Ꞁ":"L","Ɯ":"M","Ʌ":"V","Ꜩ":"TZ","Ú":"U","Ŭ":"U","Ǔ":"U","Û":"U","Ṷ":"U","Ü":"U","Ǘ":"U","Ǚ":"U","Ǜ":"U","Ǖ":"U","Ṳ":"U","Ụ":"U","Ű":"U","Ȕ":"U","Ù":"U","Ủ":"U","Ư":"U","Ứ":"U","Ự":"U","Ừ":"U","Ử":"U","Ữ":"U","Ȗ":"U","Ū":"U","Ṻ":"U","Ų":"U","Ů":"U","Ũ":"U","Ṹ":"U","Ṵ":"U","Ꝟ":"V","Ṿ":"V","Ʋ":"V","Ṽ":"V","Ꝡ":"VY","Ẃ":"W","Ŵ":"W","Ẅ":"W","Ẇ":"W","Ẉ":"W","Ẁ":"W","Ⱳ":"W","Ẍ":"X","Ẋ":"X","Ý":"Y","Ŷ":"Y","Ÿ":"Y","Ẏ":"Y","Ỵ":"Y","Ỳ":"Y","Ƴ":"Y","Ỷ":"Y","Ỿ":"Y","Ȳ":"Y","Ɏ":"Y","Ỹ":"Y","Ź":"Z","Ž":"Z","Ẑ":"Z","Ⱬ":"Z","Ż":"Z","Ẓ":"Z","Ȥ":"Z","Ẕ":"Z","Ƶ":"Z","Ĳ":"IJ","Œ":"OE","ᴀ":"A","ᴁ":"AE","ʙ":"B","ᴃ":"B","ᴄ":"C","ᴅ":"D","ᴇ":"E","ꜰ":"F","ɢ":"G","ʛ":"G","ʜ":"H","ɪ":"I","ʁ":"R","ᴊ":"J","ᴋ":"K","ʟ":"L","ᴌ":"L","ᴍ":"M","ɴ":"N","ᴏ":"O","ɶ":"OE","ᴐ":"O","ᴕ":"OU","ᴘ":"P","ʀ":"R","ᴎ":"N","ᴙ":"R","ꜱ":"S","ᴛ":"T","ⱻ":"E","ᴚ":"R","ᴜ":"U","ᴠ":"V","ᴡ":"W","ʏ":"Y","ᴢ":"Z","á":"a","ă":"a","ắ":"a","ặ":"a","ằ":"a","ẳ":"a","ẵ":"a","ǎ":"a","â":"a","ấ":"a","ậ":"a","ầ":"a","ẩ":"a","ẫ":"a","ä":"a","ǟ":"a","ȧ":"a","ǡ":"a","ạ":"a","ȁ":"a","à":"a","ả":"a","ȃ":"a","ā":"a","ą":"a","ᶏ":"a","ẚ":"a","å":"a","ǻ":"a","ḁ":"a","ⱥ":"a","ã":"a","ꜳ":"aa","æ":"ae","ǽ":"ae","ǣ":"ae","ꜵ":"ao","ꜷ":"au","ꜹ":"av","ꜻ":"av","ꜽ":"ay","ḃ":"b","ḅ":"b","ɓ":"b","ḇ":"b","ᵬ":"b","ᶀ":"b","ƀ":"b","ƃ":"b","ɵ":"o","ć":"c","č":"c","ç":"c","ḉ":"c","ĉ":"c","ɕ":"c","ċ":"c","ƈ":"c","ȼ":"c","ď":"d","ḑ":"d","ḓ":"d","ȡ":"d","ḋ":"d","ḍ":"d","ɗ":"d","ᶑ":"d","ḏ":"d","ᵭ":"d","ᶁ":"d","đ":"d","ɖ":"d","ƌ":"d","ı":"i","ȷ":"j","ɟ":"j","ʄ":"j","ǳ":"dz","ǆ":"dz","é":"e","ĕ":"e","ě":"e","ȩ":"e","ḝ":"e","ê":"e","ế":"e","ệ":"e","ề":"e","ể":"e","ễ":"e","ḙ":"e","ë":"e","ė":"e","ẹ":"e","ȅ":"e","è":"e","ẻ":"e","ȇ":"e","ē":"e","ḗ":"e","ḕ":"e","ⱸ":"e","ę":"e","ᶒ":"e","ɇ":"e","ẽ":"e","ḛ":"e","ꝫ":"et","ḟ":"f","ƒ":"f","ᵮ":"f","ᶂ":"f","ǵ":"g","ğ":"g","ǧ":"g","ģ":"g","ĝ":"g","ġ":"g","ɠ":"g","ḡ":"g","ᶃ":"g","ǥ":"g","ḫ":"h","ȟ":"h","ḩ":"h","ĥ":"h","ⱨ":"h","ḧ":"h","ḣ":"h","ḥ":"h","ɦ":"h","ẖ":"h","ħ":"h","ƕ":"hv","í":"i","ĭ":"i","ǐ":"i","î":"i","ï":"i","ḯ":"i","ị":"i","ȉ":"i","ì":"i","ỉ":"i","ȋ":"i","ī":"i","į":"i","ᶖ":"i","ɨ":"i","ĩ":"i","ḭ":"i","ꝺ":"d","ꝼ":"f","ᵹ":"g","ꞃ":"r","ꞅ":"s","ꞇ":"t","ꝭ":"is","ǰ":"j","ĵ":"j","ʝ":"j","ɉ":"j","ḱ":"k","ǩ":"k","ķ":"k","ⱪ":"k","ꝃ":"k","ḳ":"k","ƙ":"k","ḵ":"k","ᶄ":"k","ꝁ":"k","ꝅ":"k","ĺ":"l","ƚ":"l","ɬ":"l","ľ":"l","ļ":"l","ḽ":"l","ȴ":"l","ḷ":"l","ḹ":"l","ⱡ":"l","ꝉ":"l","ḻ":"l","ŀ":"l","ɫ":"l","ᶅ":"l","ɭ":"l","ł":"l","ǉ":"lj",ſ:"s","ẜ":"s","ẛ":"s","ẝ":"s","ḿ":"m","ṁ":"m","ṃ":"m","ɱ":"m","ᵯ":"m","ᶆ":"m","ń":"n","ň":"n","ņ":"n","ṋ":"n","ȵ":"n","ṅ":"n","ṇ":"n","ǹ":"n","ɲ":"n","ṉ":"n","ƞ":"n","ᵰ":"n","ᶇ":"n","ɳ":"n","ñ":"n","ǌ":"nj","ó":"o","ŏ":"o","ǒ":"o","ô":"o","ố":"o","ộ":"o","ồ":"o","ổ":"o","ỗ":"o","ö":"o","ȫ":"o","ȯ":"o","ȱ":"o","ọ":"o","ő":"o","ȍ":"o","ò":"o","ỏ":"o","ơ":"o","ớ":"o","ợ":"o","ờ":"o","ở":"o","ỡ":"o","ȏ":"o","ꝋ":"o","ꝍ":"o","ⱺ":"o","ō":"o","ṓ":"o","ṑ":"o","ǫ":"o","ǭ":"o","ø":"o","ǿ":"o","õ":"o","ṍ":"o","ṏ":"o","ȭ":"o","ƣ":"oi","ꝏ":"oo","ɛ":"e","ᶓ":"e","ɔ":"o","ᶗ":"o","ȣ":"ou","ṕ":"p","ṗ":"p","ꝓ":"p","ƥ":"p","ᵱ":"p","ᶈ":"p","ꝕ":"p","ᵽ":"p","ꝑ":"p","ꝙ":"q","ʠ":"q","ɋ":"q","ꝗ":"q","ŕ":"r","ř":"r","ŗ":"r","ṙ":"r","ṛ":"r","ṝ":"r","ȑ":"r","ɾ":"r","ᵳ":"r","ȓ":"r","ṟ":"r","ɼ":"r","ᵲ":"r","ᶉ":"r","ɍ":"r","ɽ":"r","ↄ":"c","ꜿ":"c","ɘ":"e","ɿ":"r","ś":"s","ṥ":"s","š":"s","ṧ":"s","ş":"s","ŝ":"s","ș":"s","ṡ":"s","ṣ":"s","ṩ":"s","ʂ":"s","ᵴ":"s","ᶊ":"s","ȿ":"s","ɡ":"g","ᴑ":"o","ᴓ":"o","ᴝ":"u","ť":"t","ţ":"t","ṱ":"t","ț":"t","ȶ":"t","ẗ":"t","ⱦ":"t","ṫ":"t","ṭ":"t","ƭ":"t","ṯ":"t","ᵵ":"t","ƫ":"t","ʈ":"t","ŧ":"t","ᵺ":"th","ɐ":"a","ᴂ":"ae","ǝ":"e","ᵷ":"g","ɥ":"h","ʮ":"h","ʯ":"h","ᴉ":"i","ʞ":"k","ꞁ":"l","ɯ":"m","ɰ":"m","ᴔ":"oe","ɹ":"r","ɻ":"r","ɺ":"r","ⱹ":"r","ʇ":"t","ʌ":"v","ʍ":"w","ʎ":"y","ꜩ":"tz","ú":"u","ŭ":"u","ǔ":"u","û":"u","ṷ":"u","ü":"u","ǘ":"u","ǚ":"u","ǜ":"u","ǖ":"u","ṳ":"u","ụ":"u","ű":"u","ȕ":"u","ù":"u","ủ":"u","ư":"u","ứ":"u","ự":"u","ừ":"u","ử":"u","ữ":"u","ȗ":"u","ū":"u","ṻ":"u","ų":"u","ᶙ":"u","ů":"u","ũ":"u","ṹ":"u","ṵ":"u","ᵫ":"ue","ꝸ":"um","ⱴ":"v","ꝟ":"v","ṿ":"v","ʋ":"v","ᶌ":"v","ⱱ":"v","ṽ":"v","ꝡ":"vy","ẃ":"w","ŵ":"w","ẅ":"w","ẇ":"w","ẉ":"w","ẁ":"w","ⱳ":"w","ẘ":"w","ẍ":"x","ẋ":"x","ᶍ":"x","ý":"y","ŷ":"y","ÿ":"y","ẏ":"y","ỵ":"y","ỳ":"y","ƴ":"y","ỷ":"y","ỿ":"y","ȳ":"y","ẙ":"y","ɏ":"y","ỹ":"y","ź":"z","ž":"z","ẑ":"z","ʑ":"z","ⱬ":"z","ż":"z","ẓ":"z","ȥ":"z","ẕ":"z","ᵶ":"z","ᶎ":"z","ʐ":"z","ƶ":"z","ɀ":"z","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ĳ":"ij","œ":"oe","ﬆ":"st","ₐ":"a","ₑ":"e","ᵢ":"i","ⱼ":"j","ₒ":"o","ᵣ":"r","ᵤ":"u","ᵥ":"v","ₓ":"x"},t=t.split(" ").join("-").replace(/[^A-Za-z0-9\[\] ]/g,function(e){return n[e]||e}).toLowerCase().replace(/[^a-z0-9\-]+/g,""),He.get("https://www.stef.be/bassoontracker/api/log/"+e+"/"+t+"/"+i.averageFps+"/"+i.skipRenderSteps+"/"+a+"/"+Je.width+"x"+Je.height+"/"+i.averageRenderFps+"/"+devicePixelRatio,function(e){})};return e}(),je=ze={init:function(){Xe.init(),ot.init(),_e.init(),de.startMeasure(),de.init(function(){if(window.focus(),ze.isBrowserSupported=_e.context&&window.requestAnimationFrame,ze.isBrowserSupported)Ke.readSettings(),Oe.init(),Xe.signalReady(),Ne.loadInitialFile();else{var e=de.modalDialog();e.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0}),e.onDown=function(){window.location.href="https://www.google.com/chrome/"},e.setText("Sorry//Your browser does not support WebAudio//Supported browsers are/Chrome,Firefox,Safari and Edge"),de.setModalElement(e)}})}};!Xe.customConfig&&document.addEventListener&&document.addEventListener("DOMContentLoaded",je.init);var Ye,Ke=Ye={readSettings:function(){var t=$e.get("bassoonTrackerSettings");try{t=JSON.parse(t)}catch(e){t=void 0}Ye.set(t)},saveSettings:function(){var e={vubars:Se.vubars,keyboardTable:Se.keyboardTable,stereoSeparation:Se.stereoSeparation,dropboxMode:Se.dropboxMode,skipFrame:de.getSkipFrame(),midi:Se.midi,highDPI:Se.highDPI,showKey:Se.showKey,showMidi:Se.showMidi};$e.set("bassoonTrackerSettings",JSON.stringify(e))},reset:function(){qe(),Ye.saveSettings()},set:function(e){if(qe(),e){for(var t in e)if(Se.hasOwnProperty(t)&&e.hasOwnProperty(t)&&(Se[t]=e[t],"skipFrame"===t)){var n=parseInt(Se[t],10);isNaN(n)||de.skipFrame(n)}Se.stereoSeparation&&_e.setStereoSeparation(Se.stereoSeparation),Se.highDPI&&de.scaleToDevicePixelRatio(Se.highDPI)}}};function qe(){Se.keyboardTable="qwerty",Se.vubars="colour",Se.stereoSeparation=f,Se.dropboxMode="rename",Se.skipFrame=1,Se.canvasId="canvas",Se.midi="disabled",de.skipFrame(Se.skipFrame),Se.highDPI=!1,Se.showKey=!1,Se.showMidi=!1}var Ze,Je,Qe,$e={get:function(e){return localStorage.getItem(e)},set:function(e,t){return localStorage.setItem(e,t)}},et={},tt={},nt={},it=[],at=[],rt=[],ot=function(){function e(l){l=l||0,(a=a||new WAAClock(_e.context)).start(),_e.enable(),de&&de.setStatus("Playing"),H=[],X=[];var d=(x=w.patterns[l]).length,c={},u=0,h=_e.context.currentTime+.1,f=.2,g=x,p=P;A=[],k=a.setTimeout(function(e){1<u&&k.repeat(f=1);var t=e.deadline+f;for(_e.clearScheduledNotesCache();h<t;){if(c.pause&&!ot.autoPlay){if(!c.pasuseHandled){var n=h-_e.context.currentTime;0<n&&setTimeout(function(){U.pause(),U.setAmigaSpeed(6)},Math.round(1e3*n)+100),c.pasuseHandled=!0}return}if(U.setStateAtTime(h,{patternPos:u,songPos:p}),de||U.setCurrentSongPosition(p),c.patternDelay){for(c.patternDelay--,i=0;i<y;i++)v(i,h);h+=W*z}else if(c=m(u,h,g,p),h+=W*z,d<=++u||c.patternBreak){if(c.positionBreak&&c.targetSongPosition==p||(H=[],X=[]),u=0,ot.getPlayType()==F){var a=c.positionBreak?c.targetSongPosition:++p;w.length<=a&&(a=w.restartPosition?w.restartPosition-1:0,ye.trigger(ce.songEnd)),w.length<=a&&(a=0),(g=w.patterns[l=w.patternTable[p=a]])||(g=b(),w.patterns[l]=g),d=g.length,c.patternBreak&&g.length<(u=c.targetPatternPosition||0)&&(u=0)}else c.patternBreak&&I<(u=c.targetPatternPosition||0)&&(u=0);ye.trigger(ce.patternEnd,h-W*z)}}for(i=0;i<y;i++){var r=O[i];if(r&&r.time&&r.scheduled){var o=U.getInstrument(r.instrumentIndex);if(r.scheduled.volume&&r.scheduled.volume<=h+f){var s=o.scheduleEnvelopeLoop(r.volumeEnvelope,r.scheduled.volume,2);r.scheduled.volume+=s}r.scheduled.panning&&r.scheduled.panning<=h+f&&(s=o.scheduleEnvelopeLoop(r.panningEnvelope,r.scheduled.panning,2),r.scheduled.panning+=s)}}},.01).repeat(f).tolerance({early:.1})}function m(e,t,n,i){for(var a,r=(n=n||x)[e],o=y,s={},l=0;l<o;l++)(d=r[l])&&d.effect&&15===d.effect&&(d.param<32?(ot.setAmigaSpeed(d.param),0===d.param&&(s.pause=!0)):ot.setBPM(d.param));for(l=0;l<o;l++){var d=r[l];if(d){var c={position:i,step:e},u=t;if(M)u+=(Math.random()*M*2-M)/1e3;(a=h(d,l,u,c)).patternBreak&&(s.patternBreak=!0,s.targetPatternPosition=a.targetPatternPosition||0),a.positionBreak&&(s.positionBreak=!0,s.targetPatternPosition=a.targetPatternPosition||0,s.targetSongPosition=a.targetSongPosition||0),a.patternDelay&&(s.patternDelay=a.patternDelay)}}for(l=0;l<o;l++)v(l,t);return s}function h(e,t,n,i){var a=100,r={},o=e.instrument,s=e.period,l=e.index;s&&!o&&(o=O[t].currentInstrument,a="number"==typeof O[t].currentVolume?O[t].currentVolume:a,Se.emulateProtracker1OffsetBug&&o&&N[t].offset&&N[t].offset.instrument===o&&(r.offset=N[t].offset)),"number"==typeof e.instrument&&(E=U.getInstrument(e.instrument))&&(a=E.sample.volume/64*100,Se.emulateProtracker1OffsetBug&&(N[t].offset=N[t].offset||{},N[t].offset.value=0,N[t].offset.instrument=e.instrument));var d=a,c=!0;if("number"==typeof o&&(E=U.getInstrument(o)),l&&U.inFTMode())if(97===l&&(l=ve),l===ve){var u=E||U.getInstrument(O[t].currentInstrument);a=d=u?u.noteOff(n,O[t]):0,c=!1}else if(E&&(E.setSampleForNoteIndex(l),E.sample.relativeNote&&(l+=E.sample.relativeNote)),U.useLinearFrequency)s=7680-64*(l-1);else{var h=at[l];h&&(s=h.period)}var f,g,p=e.param,m={};if(e.volumeEffect&&U.inFTMode()){var v=e.volumeEffect;if(f=v>>4,g=15&v,15<v&&v<=80)r.volume={value:a=d=(v-16)/64*100};else switch(f){case 6:r.fade={value:-1*g*100/64};break;case 7:r.fade={value:100*g/64};break;case 8:r.fade={value:100*-g/64,fine:!0};break;case 9:r.fade={value:100*g/64,fine:!0};break;case 10:case 11:break;case 12:r.panning={value:17*(v-192),slide:!1};break;case 13:r.panning={value:v,slide:!0}}}switch(e.effect){case 0:if(p){f=p>>4,g=15&p;var b=0;if(E=E||U.getInstrument(O[t].currentInstrument),U.inFTMode()){if(E){var w=l||O[t].noteIndex,x=E.getPeriodForNote(w,!0);l===ve?r.arpeggio=N[t].arpeggio:(r.arpeggio={root:x,interval1:x-E.getPeriodForNote(w+f,!0),interval2:x-E.getPeriodForNote(w+g,!0),step:1},N[t].arpeggio=r.arpeggio)}}else x=s||O[t].startPeriod,E&&(b=E.getFineTune())&&(x=_e.getFineTuneForPeriod(x,b)),r.arpeggio={root:x,interval1:x-_e.getSemiToneFrom(x,f,b),interval2:x-_e.getSemiToneFrom(x,g,b),step:1}}e.instrument&&(r.volume={value:a});break;case 1:p*=-1,U.inFTMode()&&!p&&N[t].slideUp&&(p=N[t].slideUp.value),r.slide={value:p},N[t].slideUp=r.slide;break;case 2:U.inFTMode()&&!p&&N[t].slideDown&&(p=N[t].slideDown.value),r.slide={value:p},N[t].slideDown=r.slide;break;case 3:c=!1;var k=s;if(U.inFTMode()&&l===ve&&(k=0),O[t].currentInstrument&&(o=O[t].currentInstrument),k&&o)(E=U.getInstrument(o))&&E.getFineTune()&&(k=U.inFTMode()?E.getPeriodForNote(l,!0):_e.getFineTuneForPeriod(k,E.getFineTune()));(S=N[t].slide)&&(p=p||S.value),r.slide={value:p,target:k=k||N[t].defaultSlideTarget,canUseGlissando:!0,resetVolume:!!e.instrument,volume:a},N[t].slide=r.slide,e.instrument&&(r.volume={value:a});break;case 4:e.instrument&&(O[t].startVolume&&(r.volume={value:d}),O[t].vibratoTimer=0);var P=(f=p>>4)*W/64,C=N[t].vibrato;0==f&&C&&(P=C.freq),0==(g=15&p)&&C&&(g=C.amplitude),r.vibrato={amplitude:g,freq:P},N[t].vibrato=r.vibrato;break;case 5:var S;c=!1,(k=s)&&o&&(E=U.getInstrument(o))&&E.getFineTune()&&(k=U.inFTMode()?_e.getFineTuneForNote(l,E.getFineTune()):_e.getFineTuneForPeriod(k,E.getFineTune())),p=1,(S=N[t].slide)&&(k=k||(S.target||0),p=S.value),r.slide={value:p,target:k},N[t].slide=r.slide,e.instrument&&(r.volume={value:a}),(p=e.param)&&(e.param<16?p*=-1:p=e.param>>4,r.fade={value:p=100*p/64,resetOnStep:!!e.instrument},N[t].fade=r.fade);break;case 6:e.instrument&&(O[t].startVolume&&(r.volume={value:d}),O[t].vibratoTimer=0),e.param?(e.param<16?p*=-1:p=15&e.param,r.fade={value:p=100*p/64},N[t].fade=r.fade):ot.inFTMode()&&N[t].fade&&(r.fade=N[t].fade),N[t].vibrato&&(r.vibrato=N[t].vibrato);break;case 7:s&&!e.instrument&&(O[t].startVolume&&(r.volume={value:d}),O[t].tremoloTimer=0);var y=g=15&p,_=(P=(f=p>>4)*W/64,N[t].tremolo);0==f&&_&&(P=_.freq),0==g&&_&&(y=_.amplitude),r.tremolo={amplitude:y,freq:P},N[t].tremolo=r.tremolo;break;case 8:r.panning={value:p,slide:!1};break;case 9:!(p<<=8)&&N[t].offset&&(p=N[t].offset.stepValue||N[t].offset.value||0);var I=p;Se.emulateProtracker1OffsetBug&&!e.instrument&&N[t].offset&&(p+=N[t].offset.value),r.offset={value:p,stepValue:I},N[t].offset=N[t].offset||{},N[t].offset.value=r.offset.value,N[t].offset.stepValue=r.offset.stepValue,Se.emulateProtracker1OffsetBug&&(e.instrument&&(N[t].offset.instrument=e.instrument),s&&(N[t].offset.value+=I)),e.instrument&&(r.volume={value:a});break;case 10:if(e.param<16?p*=-1:p=e.param>>4,p=100*p/64,!e.param){var T=N[t].fade;T&&(p=T.value)}r.fade={value:p,resetOnStep:!!e.instrument},U.inFTMode()&&(N[t].fade=r.fade);break;case 11:ot.autoPlay||(m.patternBreak=!0,m.positionBreak=!0,m.targetSongPosition=e.param,m.targetPatternPosition=0);break;case 12:r.volume={value:d=e.param/64*100};break;case 13:m.patternBreak=!0,m.targetPatternPosition=10*(f=p>>4)+(g=15&p);break;case 14:var M=p>>4,A=15&p;switch(M){case 0:U.inFTMode()||_e.setAmigaLowPassFilter(!A,n);break;case 1:!(A*=-1)&&N[t].fineSlide&&(A=N[t].fineSlide.value),r.slide={value:A,fine:!0},N[t].fineSlide=r.slide;break;case 2:!A&&N[t].fineSlide&&(A=N[t].fineSlide.value),r.slide={value:A,fine:!0},N[t].fineSlide=r.slide;break;case 3:N[t].glissando=!!A;break;case 4:switch(A){case 1:R=_e.waveFormFunction.saw;break;case 2:R=_e.waveFormFunction.square;break;case 3:case 4:R=_e.waveFormFunction.sine;break;case 5:R=_e.waveFormFunction.saw;break;case 6:R=_e.waveFormFunction.square;break;case 7:default:R=_e.waveFormFunction.sine}break;case 5:if(o){var E=U.getInstrument(o);r.fineTune={original:E.getFineTune(),instrument:E},E.setFineTune(A)}break;case 6:A?(X[t]=X[t]||0,X[t]<A?(X[t]++,m.patternBreak=!0,m.positionBreak=!0,m.targetSongPosition=i.position,m.targetPatternPosition=H[t]||0):X[t]=0):H[t]=i.step;break;case 7:switch(A){case 1:V=_e.waveFormFunction.saw;break;case 2:V=_e.waveFormFunction.square;break;case 3:case 4:V=_e.waveFormFunction.sine;break;case 5:V=_e.waveFormFunction.saw;break;case 6:V=_e.waveFormFunction.square;break;case 7:default:V=_e.waveFormFunction.sine}break;case 8:break;case 9:A&&(r.reTrigger={value:A});break;case 10:r.fade={value:A=100*A/64,fine:!0};break;case 11:r.fade={value:-(A=100*A/64),fine:!0};break;case 12:A?A<W&&(r.cutNote={value:A}):c=!1;break;case 13:A&&(A<W?n+=z*A:c=!1);break;case 14:m.patternDelay=A}break;case 15:break;case 16:p=Math.min(p,64),U.isPlugin||_e.setMasterVolume(p/64,n);break;case 17:f=p>>4,g=15&p;var D=64*_e.getLastMasterVolume(),F=0;if(f){var L=n+f*z;F=f*(W-1)}else g&&(L=n+g*z,F=-g*(W-1));F&&(p=(D+F)/64,p=Math.max(0,p),p=Math.min(1,p),_e.slideMasterVolume(p,L));break;case 20:U.inFTMode()&&(u=E||U.getInstrument(O[t].currentInstrument),e.param&&W<=e.param||(c=!1,u?e.param?(r.noteOff={value:e.param},c=!0):a=d=u.noteOff(n,O[t]):a=0));break;case 21:case 25:break;case 27:r.reTrigger={value:e.param}}return c&&o&&s&&(B(t,n),O[t]={},E&&(O[t]=E.play(l,s,d,t,r,n)),N[t].defaultSlideTarget=O[t].startPeriod),o&&(O[t].currentInstrument=o,r.fineTune&&r.fineTune.instrument&&r.fineTune.instrument.setFineTune(r.fineTune.original||0)),E&&E.hasVibrato()&&(O[t].hasAutoVibrato=!0),O[t].effects=r,O[t].note=e,m}function B(e,t){try{if(O[e].source){var n=O[e].volume.gain;n.setValueAtTime(O[e].currentVolume/100,t-.002),n.linearRampToValueAtTime(0,t),O[e].source.stop(t+.02)}}catch(e){}}function _(e,t){var n=U.getInstrument(e.instrumentIndex);if(n){var i=-n.vibrato.rate/40,a=n.vibrato.depth/8;if(U.useLinearFrequency&&(a*=4),e.vibratoTimer=e.vibratoTimer||0,n.vibrato.sweep&&e.vibratoTimer<n.vibrato.sweep)a*=1-(n.vibrato.sweep-e.vibratoTimer)/n.vibrato.sweep;var r=n.getAutoVibratoFunction()(t,e.vibratoTimer,i,a);return e.vibratoTimer++,r}return t}function v(e,t){var n=O[e],i=n.effects;if(n&&i){var a,r=!1;if(n.startVibratoTimer=n.vibratoTimer||0,n.resetPeriodOnStep&&n.source)U.setPeriodAtTime(n,u=n.currentPeriod||n.startPeriod,t),n.resetPeriodOnStep=!1;if(i.volume){var o=i.volume.value;n.volume&&n.volume.gain.setValueAtTime(o/100,t),n.currentVolume=o}if(i.panning&&(255===(a=i.panning.value)&&(a=254),n.panning&&n.panning.pan.setValueAtTime((a-127)/127,t)),i.fade){var s;a=i.fade.value;var l=1;s=i.fade.resetOnStep?n.startVolume:n.currentVolume;var d=W;i.fade.fine&&(l=0,d=1);for(var c=l;c<d;c++)n.volume&&(n.volume.gain.setValueAtTime(s/100,t+c*z),s+=a,s=Math.max(s,0),s=Math.min(s,100));n.currentVolume=s}if(i.slide&&n.source){var u=p=n.currentPeriod||n.startPeriod;d=W;i.slide.fine&&(d=2);var h,f=i.slide.value;if(U.inFTMode()&&U.useLinearFrequency&&(f=4*i.slide.value),a=Math.abs(f),U.inFTMode()&&i.slide.resetVolume&&(n.volumeFadeOut||n.volumeEnvelope))(h=U.getInstrument(n.instrumentIndex))&&h.resetVolume(t,n);n.vibratoTimer=n.startVibratoTimer;for(c=1;c<d;c++){i.slide.target?(N[e].defaultSlideTarget=i.slide.target,u<i.slide.target?i.slide.target<(u+=a)&&(u=i.slide.target):(u-=a)<i.slide.target&&(u=i.slide.target)):(u+=f,N[e].defaultSlideTarget&&(N[e].defaultSlideTarget+=f)),U.inFTMode()||(u=_e.limitAmigaPeriod(u));var g=u;i.slide.canUseGlissando&&N[e].glissando&&(g=_e.getNearestSemiTone(u,n.instrumentIndex)),g!==n.currentPeriod&&(n.currentPeriod=u,n.hasAutoVibrato&&U.inFTMode()&&(u=_(n,u),r=!0),U.setPeriodAtTime(n,g,t+c*z))}}if(i.arpeggio&&n.source){var p=n.currentPeriod||n.startPeriod;n.resetPeriodOnStep=!0,n.vibratoTimer=n.startVibratoTimer;for(c=0;c<W;c++){var m=c%3;0==m&&(u=p),1==m&&i.arpeggio.interval1&&(u=p-i.arpeggio.interval1),2==m&&i.arpeggio.interval2&&(u=p-i.arpeggio.interval2),n.hasAutoVibrato&&U.inFTMode()&&(u=_(n,u),r=!0),U.setPeriodAtTime(n,u,t+c*z)}}if(i.vibrato||n.hasAutoVibrato&&!r){i.vibrato=i.vibrato||{freq:0,amplitude:0};var v=i.vibrato.freq,b=i.vibrato.amplitude;if(U.inFTMode()&&U.useLinearFrequency&&(b*=4),n.vibratoTimer=n.vibratoTimer||0,n.source){n.resetPeriodOnStep=!0,p=n.currentPeriod||n.startPeriod,n.vibratoTimer=n.startVibratoTimer;for(c=0;c<W;c++)u=R(p,n.vibratoTimer,v,b),n.hasAutoVibrato&&U.inFTMode()?(u=_(n,u),r=!0):n.vibratoTimer++,U.setPeriodAtTime(n,u,t+c*z)}}if(i.tremolo){v=i.tremolo.freq,b=i.tremolo.amplitude;if(n.tremoloTimer=n.tremoloTimer||0,n.volume){var w=n.startVolume;for(c=0;c<W;c++)(w=V(w,n.tremoloTimer,v,b))<0&&(w=0),100<w&&(w=100),n.volume.gain.setValueAtTime(w/100,t+c*z),n.currentVolume=w,n.tremoloTimer++}}if(i.cutNote&&(n.volume&&n.volume.gain.setValueAtTime(0,t+i.cutNote.value*z),n.currentVolume=0),i.noteOff)(h=U.getInstrument(n.instrumentIndex))&&(n.currentVolume=h.noteOff(t+i.noteOff.value*z,n));if(i.reTrigger){var x=n.instrumentIndex,k=n.startPeriod;o=n.startVolume;for(var P=n.noteIndex,C=i.reTrigger.value||1,S=C;S<W;){var y=t+S*z;B(e,y),O[e]=_e.playSample(x,k,o,e,i,y,P),S+=C}}}}function o(){de&&de.setInfo(w.title),w.channels&&U.setTrackCount(w.channels),C=n=r=t=void 0,U.setCurrentSongPosition(0),U.setCurrentPatternPos(0),U.setCurrentInstrumentIndex(1),U.clearEffectCache(),ye.trigger(ce.songLoaded,w),ye.trigger(ce.songPropertyChange,w)}function s(){ye.trigger(ce.songBPMChangeIgnored,0),ye.trigger(ce.songSpeedChangeIgnored,0),U.setAmigaSpeed(6),U.setBPM(125),V=R=_e.waveFormFunction.sine,N=[],O=[];for(var e=0;e<y;e++)O.push({}),N.push({});U.useLinearFrequency=!1,U.setTrackerMode(Pe,!0),U.isPlugin||_e.setMasterVolume(1),_e.setAmigaLowPassFilter(!1,0),void 0!==_t&&_t.clear()}function b(){for(var e=[],t=0;t<I;t++){var n,i=[];for(n=0;n<y;n++)i.push(Nt());e.push(i)}return e}var a,w,r,n,t,x,R,V,k,U={},l=!(U.isMaster=!0),d=!1,c=[],u=1,f=0,g=0,p=F,P=0,C=0,S=125,W=6,z=2.5/S,y=4,I=64,T=Pe,M=0,O=[],N=[],A=[],H=[],X=[];U.init=function(t){for(var e=0;e<y;e++)O.push({}),N.push({});for(e=-8;e<8;e++)tt[e]={};for(var n in Y)if(Y.hasOwnProperty(n)){var i=Y[n];if(it.push((nt[(et[i.period]=i).name]=i).name),i.tune)for(e=-8;e<8;e++){tt[e][i.tune[e+8]]=i.period}}var a=0;for(n in K)if(K.hasOwnProperty(n)){var r=K[n];r.period||(r.period=1),at.push(r),rt[r.period]=a,r.modPeriod&&(rt[r.modPeriod]=a),a++}t&&(Xe.init(),_e.init(t.audioContext,t.audioDestination),t.plugin&&(U.isPlugin=!0,de.initPlugin(t),"boolean"==typeof t.isMaster&&(U.isMaster=t.isMaster),t.handler&&(ye.on(ce.songBPMChange,function(e){t.handler(ce.songBPMChange,e)}),ye.on(ce.songBPMChangeIgnored,function(e){t.handler(ce.songBPMChangeIgnored,e)}),ye.on(ce.songSpeedChange,function(e){t.handler(ce.songSpeedChange,e)}),ye.on(ce.songSpeedChangeIgnored,function(e){t.handler(ce.songSpeedChangeIgnored,e)}),ye.on(ce.patternEnd,function(e){t.handler(ce.patternEnd,e)}))))},U.setMaster=function(e){U.isMaster=e},U.isMaster=function(){return!!U.isMaster},U.setCurrentInstrumentIndex=function(e){if(w.instruments[e])r!=(u=e)&&ye.trigger(ce.instrumentChange,u),r=u;else if(e<=U.getMaxInstruments()){for(var t=w.instruments.length,n=e;t<=n;t++)U.setInstrument(t,Ot());var i=[];for(t=1;t<=n;t++){i.push({label:t+" "+(w.instruments[t]||{name:""}).name,data:t}),ye.trigger(ce.instrumentListChange,i)}r!=(u=e)&&ye.trigger(ce.instrumentChange,u),r=u}},U.getCurrentInstrumentIndex=function(){return u},U.getCurrentInstrument=function(){return c[u]},U.getMaxInstruments=function(){return U.inFTMode()?128:31},U.setCurrentPattern=function(e){(x=w.patterns[f=e])||(x=b(),w.patterns[f]=x),I=x.length,n!=f&&ye.trigger(ce.patternChange,f),n=f},U.getCurrentPattern=function(){return f},U.getCurrentPatternData=function(){return x},U.updatePatternTable=function(e,t){ye.trigger(ce.patternTableChange,w.patternTable[e]=t),e==P&&(n=void 0,ot.setCurrentPattern(t))},U.setCurrentPatternPos=function(e){t!=(g=e)&&ye.trigger(ce.patternPosChange,{current:g,prev:t}),t=g},U.getCurrentPatternPos=function(){return g},U.moveCurrentPatternPos=function(e){var t=g+e,n=I-1;t<0&&(t=n),n<t&&(t=0),U.setCurrentPatternPos(t)},U.getCurrentSongPosition=function(){return P},U.setCurrentSongPosition=function(e,t){(P=e)!=C&&(ye.trigger(ce.songPositionChange,P),w.patternTable&&U.setCurrentPattern(w.patternTable[P]),C=P,t&&U.isPlaying()&&(U.stop(),U.togglePlay()))},U.setPlayType=function(e){ye.trigger(ce.playTypeChange,p=e)},U.getPlayType=function(){return p},U.playSong=function(){U.stop(),_e.checkState(),U.setPlayType(F),d=!0,e(f),ye.trigger(ce.playingChange,d)},U.playPattern=function(){U.stop(),_e.checkState(),g=0,U.setPlayType(L),d=!0,e(f),ye.trigger(ce.playingChange,d)},U.stop=function(){a&&a.stop(),_e.disable(),U.isPlugin||_e.setMasterVolume(1),de&&(de.setStatus("Ready"),ht.clearInputNotes()),U.clearEffectCache();for(var e=0;e<y;e++)if(O[e].source)try{O[e].source.stop()}catch(e){}ye.trigger(ce.playingChange,d=!1)},U.pause=function(){a&&a.stop(),ye.trigger(ce.playingChange,d=!1)},U.togglePlay=function(){U.isPlaying()?U.stop():p==L?U.playPattern():U.playSong()},U.getProperties=function(){return{ticksPerStep:W,tickTime:z}},U.playPatternStep=m,U.cutNote=B,U.setBPM=function(e,t){var n=t&&t.isMaster;U.isMaster||n?(a&&a.timeStretch(_e.context.currentTime,[k],S/e),n||ye.trigger(ce.songBPMChangeIgnored,S),z=2.5/(S=e),ye.trigger(ce.songBPMChange,S)):ye.trigger(ce.songBPMChangeIgnored,e)},U.getBPM=function(){return S},U.setAmigaSpeed=function(e,t){U.isMaster||t&&t.isMaster?ye.trigger(ce.songSpeedChange,W=e):ye.trigger(ce.songSpeedChangeIgnored,e)},U.getAmigaSpeed=function(){return W},U.getSwing=function(){return M},U.setSwing=function(e){M=e},U.getPatternLength=function(){return I},U.setPatternLength=function(e){var t=w.patterns[f].length;if(t!==(I=e)){if(t<I)for(var n=t;n<I;n++){var i,a=[];for(i=0;i<y;i++)a.push(Nt());w.patterns[f].push(a)}else w.patterns[f]=w.patterns[f].splice(0,I),I<=g&&U.setCurrentPatternPos(I-1);ye.trigger(ce.patternChange,f)}},U.getTrackCount=function(){return y},U.setTrackCount=function(e){y=e;for(var t=O.length;t<y;t++)O.push({});for(t=N.length;t<y;t++)N.push({});ye.trigger(ce.trackCountChange,y)},U.toggleRecord=function(){U.stop(),ye.trigger(ce.recordingChange,l=!l)},U.isPlaying=function(){return d},U.isRecording=function(){return l},U.setStateAtTime=function(e,t){A.push({time:e,state:t})},U.getStateAtTime=function(e){for(var t=void 0,n=0,i=A.length;n<i;n++){if(!(A[0].time<e))return t;t=A.shift().state}return t},U.getTimeStates=function(){return A},U.setPeriodAtTime=function(e,t,n){if(t=Math.max(t,1),U.inFTMode()&&U.useLinearFrequency)var i=8363*Math.pow(2,(4608-t)/768)/_e.context.sampleRate;else i=e.startPeriod/t,i*=e.startPlaybackRate;e.source.playbackRate.setValueAtTime(i,n),e.source.playbackRate.setValueAtTime(i,n+.005)},U.load=function(o,s,l,t){(o=o||"demomods/StardustMemories.mod").indexOf("://")<0&&0!==o.indexOf("/")&&(o=Xe.getBaseUrl()+o),de&&(de.setInfo(""),de.setLoading());function n(e){t&&!Xe.useInitialLoad||U.processFile(e,d,function(e){if(de&&de.setStatus("Ready"),e){var t="",n="";if("string"==typeof o){if(0<o.indexOf("modarchive.org")){var i=o.split("moduleid=")[1];w.filename=i.split("#")[1]||i,n="modArchive",t="https://modarchive.org/index.php?request=view_by_moduleid&query="+(i=(i=i.split("#")[0]).split("&")[0]),ye.trigger(ce.songPropertyChange,w)}0<o.indexOf("modules.pl")&&(i=o.split("modules.pl/")[1],w.filename=i.split("#")[1]||i,n="modules.pl",t="http://www.modules.pl/?id=module&mod="+(i=(i=i.split("#")[0]).split("&")[0]),ye.trigger(ce.songPropertyChange,w))}de&&de.setInfo(w.title,n,t)}if(de&&e&&!s){var a=window.location.pathname,r=a.substring(a.lastIndexOf("/")+1);window.history.pushState&&window.history.pushState({},d,r+"?file="+encodeURIComponent(o))}e&&E(s),l&&l()})}var e,i,a,d="";"string"==typeof o?(d=o.substr(o.lastIndexOf("/")+1),e=o,i=function(e){n(e)},(a=new XMLHttpRequest).open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(e){var t=a.response;t&&200===a.status?i&&i(t):void 0!==Ne&&i&&i(!1)},a.send(null)):(d=o.name||"",s=!0,n(o.buffer||o))};var E=function(e){var t=G("autoplay");ot.autoPlay&&(t="1"),!de&&e&&(t="1"),"true"!=t&&"1"!=t||ot.playSong()};return U.handleUpload=function(e){if(e.length){var t=e[0],n=new FileReader;n.onload=function(){U.processFile(n.result,t.name,function(e){de&&de.setStatus("Ready")})},n.readAsArrayBuffer(t)}},U.processFile=function(e,i,a){var t=!1,n=new D(e,!0),r=Lt.detect(n,i);r&&"ZIP"==r.name&&(de&&de.setStatus("Extracting Zip file",!0),zip.workerScriptsPath="script/src/lib/zip/",zip.useWebWorkers=Xe.useWebWorkers,zip.createReader(new zip.ArrayBufferReader(e),function(e){var t,n=0;e.getEntries(function(e){e&&e.length&&e.forEach(function(e){n<e.uncompressedSize&&(n=e.uncompressedSize,t=e)}),t?t.getData(new zip.ArrayBufferWriter,function(e){e&&e.byteLength&&U.processFile(e,i,a)}):a&&a(!1)})},function(e){a&&a(!1)})),r.isMod&&r.loader&&(t=!0,U.isPlaying()&&U.stop(),s(),(w=r.loader().load(n,i)).filename=i,o()),r.isSample&&void 0!==Ne&&Ne.importSample(n,i),a&&a(t)},U.getSong=function(){return w},U.getInstruments=function(){return c},U.getInstrument=function(e){return c[e]},U.setInstrument=function(e,t){c[t.instrumentIndex=e]=t},U.clearEffectCache=function(){N=[];for(var e=0;e<y;e++)N.push({})},U.clearInstruments=function(e){if(w){var t=[],n=e||w.instruments.length-1;for(c=[],i=1;i<=n;i++)U.setInstrument(i,Ot()),t.push({label:i+" ",data:i});w.instruments=c,ye.trigger(ce.instrumentListChange,t),ye.trigger(ce.instrumentChange,u)}},U.setTrackerMode=function(e,t){function n(){T=e,Se.emulateProtracker1OffsetBug=!U.inFTMode(),ye.trigger(ce.trackerModeChanged,e)}e===Pe&&!t&&32<ot.getInstruments().length?de.showDialog("WARNING !!!//This file has more than 31 instruments./If you save this file as .MOD, only the first 31 instruments will be included.//Are you sure you want to continue?",function(){n()},function(){}):n()},U.getTrackerMode=function(){return T},U.inFTMode=function(){return T===Ce},U.new=function(){s(),w={patterns:[],instruments:[]},U.clearInstruments(31),w.typeId="M.K.",w.title="new song",w.length=1,w.restartPosition=0,w.patterns.push(b());for(var e=[],t=0;t<128;++t)e[t]=0;w.patternTable=e,o()},U.clearInstrument=function(){c[u]=Ot(),ye.trigger(ce.instrumentChange,u),ye.trigger(ce.instrumentNameChange,u)},U.getFileName=function(){return w.filename||(w.title?w.title.replace(/ /g,"-").replace(/\W/g,"")+".mod":"new.mod")},U.useLinearFrequency=!0,U}(),st=Ze={sprites:{},getImage:function(e){return Ze.sprites[e]?Ze.sprites[e].canvas:void 0},loadImage:function(e,t){var n=new Image;n.onload=function(){t&&t(n)},n.onerror=function(){},n.src=e}},lt=st;(de=function(){function e(e){if(!e.length)return 0;for(var t=0,n=0,i=e.length;n<i;n++)t+=e[n];return t/i}var i,a,r,o,s,l,d,c,u,t,n,h,f={},g=!1,p=[],m=1200,v=!0,b=0,w=0,x=0,k=0,P=0,C=0,S=0,y=0,_=100,I=[],T=[],M=0,A=!1,E={},D=G("tracks");if(8==D&&(m=1200),16==D&&(m=1600),32<=D&&(m=3200),h=window.performance&&performance.now?function(){return performance.now()}:Date.now,!window.requestAnimationFrame){var F=0;window.requestAnimationFrame=function(e,t){var n=(new Date).getTime(),i=Math.max(0,16-(n-F)),a=window.setTimeout(function(){e(n+i)},i);return F=n+i,a}}f.init=function(e){Je=document.getElementById("canvas"),(Qe=Je.getContext("2d")).imageSmoothingEnabled=!1;var t=window.innerWidth,n=window.innerHeight;m<t&&(t=m),2e3<n&&(n=2e3),a=n,Je.width=i=t,Je.height=a,Qe.fillStyle="black",Qe.fillRect(0,0,Je.width,Je.height),Qe.fillStyle="#78828F",Qe.font="20px sans-serif",Qe.textAlign="center",Qe.fillText("Loading ...",Je.width/2,Je.height/2),de.Assets.preLoad(function(){L(),ht.init(),B(),"undefined"!=typeof versionNumber&&He.json("package.json?ts="+(new Date).getTime(),function(e){if(e&&e.version&&e.version!==versionNumber){var t=localStorage.getItem("updatemessageshown")||0;if(t=parseInt(t,10),isNaN(t)&&(t=0),window.reload=function(){localStorage.setItem("updatemessageshown",(new Date).getTime()),window.location.reload(!0)},18e5<(new Date).getTime()-t){var n=document.createElement("div");n.className="message",n.innerHTML='A new version of BassoonTracker is available. Please <a href="#" onclick="reload()">refresh your browser</a>',document.body.appendChild(n)}}}),e&&e()})},f.initPlugin=function(e){if(e.canvas)Je=e.canvas;else{Je=document.getElementById("canvas");var t=window.innerWidth;m<t&&(t=m),2e3<t&&(t=2e3),Je.width=t}(Qe=Je.getContext("2d")).fillStyle="black",Qe.fillRect(0,0,Je.width,Je.height),Ke.baseUrl=e.baseUrl,Oe.isPlugin=!0,buildNumber=Math.random(),de.Assets.preLoad(function(){L(),B(),Ke.readSettings(),Oe.init(),e.callback&&e.callback()})},f.setSize=function(e,t){m<e&&(e=m),2e3<t&&(t=2e3),t<200&&(t=200),e===Je.width&&t===Je.height||(Qe.clearRect(0,0,Je.width,Je.height),i=e,a=t,f.scaleToDevicePixelRatio(g),f.mainPanel.setSize(e,t),c&&c.setProperties({width:e,height:t}),v=!0)},f.scaleToDevicePixelRatio=function(e){g=!!e,e&&1<devicePixelRatio?(Je.width=i*devicePixelRatio,Je.height=a*devicePixelRatio,Qe.scale(devicePixelRatio,devicePixelRatio),Qe.imageSmoothingEnabled=!1):(Je.width=i,Je.height=a),Je.style.width=i+"px",Je.style.height=a+"px",de.mainPanel.refresh()};var L=function(){var e=lt.getImage("font");(r=ut()).generate({image:e,startX:1,startY:1,charWidth:6,charHeight:6,spaceWidth:6,margin:0,charsPerLine:42,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.+-_#>",onlyUpperCase:!0}),window.fontSmall=r,(o=ut()).generate({image:e,startX:1,startY:110,charWidth:8,charHeight:8,spaceWidth:8,margin:1,charsPerLine:26,lineSpacing:1,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789↑↓-#:.!©_?;()=/+<>&[]{}\\*%$'\"`°,",onlyUpperCase:!0}),o.generateColor("green","rgba(80, 140, 0,0.9)"),o.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontMed=o,(s=ut()).generate({image:e,startX:1,startY:10,charWidth:11,charHeight:11,spaceWidth:11,margin:1,charsPerLine:20,lineSpacing:3,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.,-_",onlyUpperCase:!0}),window.fontBig=s,(l=ut()).generate({image:e,startX:1,startY:145,charHeight:12,spaceWidth:4,margin:1,charsPerLine:[26,26,40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890#©_-&\"'()!.,?+=*$/\\;:[]{}",charWidth:"888888883888998888888899987777757735739777757578987777777777778868864553348767888435555",onlyUpperCase:!1,debug:!1}),window.fontFT=l,(d=ut()).generate({image:e,startX:1,startY:184,charHeight:10,spaceWidth:5,margin:0,charsPerLine:[26,26,10],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",charWidth:"6666556625656666666666666655555455245365555454566555",onlyUpperCase:!1}),window.fontCondensed=d;var t=ut();t.generate({image:e,startX:2,startY:208,charHeight:8,charWidth:4,spaceWidth:4,margin:0,charsPerLine:[45],lineSpacing:0,chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_.-#+><↑↓",onlyUpperCase:!0}),t.generateColor("green","rgba(80, 140, 0,0.9)"),t.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontSuperCondensed=t;var n=ut();n.generate({image:e,startX:107,startY:68,charWidth:8,charHeight:13,spaceWidth:8,margin:0,charsPerLine:20,chars:" 0123456789-"}),window.fontLed=n;var i=ut();i.generate({image:e,startX:9,startY:82,charWidth:14,charHeight:22,spaceWidth:8,margin:0,charsPerLine:11,chars:" 0123456789"}),window.fontLedBig=i;var a=ut();a.generate({image:e,startX:1,startY:216,charHeight:9,spaceWidth:5,margin:0,charsPerLine:[40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890():-",charWidth:"7777667736768777877778887746666666664434",onlyUpperCase:!0}),window.fontDark=a,de.Assets.init(),de.mainPanel=de.MainPanel(),p.push(de.mainPanel)},B=function(e){var t=!0;if(ot.isPlaying()){var n=ot.getStateAtTime(_e.context.currentTime+.01);n&&(n.patternPos!==E.patternPos&&(ot.setCurrentPatternPos(n.patternPos),E.patternPos=n.patternPos),n.songPos!==E.songPos&&(ot.setCurrentSongPosition(n.songPos),E.songPos=n.songPos))}b&&(t=b<++w);var i=_e.context?_e.context.currentTime:0;if(t){var a=1e3/((k=h())-P);T.push(a),20<T.length&&T.shift(),60<a&&(t=!1)}t&&(w=0,P=k,ye.trigger(ce.screenRefresh),c&&c.needsRendering&&(de.mainPanel.refresh(),v=!0),v&&(p.forEach(function(e){e.needsRendering&&e.render()}),ye.trigger(ce.screenRender),c&&(c.render(),v=!1))),i&&(y++,(x=x||i)+1<i&&(u=y/(i-x),_=Math.min(_,u),x=i,y=0,I.push(u),20<I.length&&I.shift(),!A&&5<I.length&&(Ge.info("init "+Math.round(S)),A=!0),ye.trigger(ce.second))),window.requestAnimationFrame(B)};return f.setModalElement=function(e){ht.setFocusElement(c=e)},f.getModalElement=function(){return c},f.removeModalElement=function(){c&&ht.clearFocusElement(),c=void 0,de.mainPanel.refresh(),v=!0},f.setSelection=function(e){n=t=e},f.getSelection=function(){return t},f.clearSelection=function(){t&&t(ue)&&(t=void 0)},f.copySelection=function(e){t&&(t(ge),e&&t(ue)),t=void 0},f.cutSelection=function(e){t&&(t(fe),e&&t(ue)),t=void 0},f.deleteSelection=function(){t&&t(O),t=void 0},f.pasteSelection=function(e){!t&&n&&(t=n)(me),t&&(t(pe),e&&t(ue)),t=void 0},f.showContextMenu=function(e){ye.trigger(ce.showContextMenu,e)},f.hideContextMenu=function(){ye.trigger(ce.hideContextMenu)},f.showDialog=function(e,n,i,a){var r=de.modalDialog();r.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!!n,cancel:!!i,input:!!a}),r.onClick=function(e){var t;if(a&&"dialoginput"===(t=r.getElementAtPoint(e.x,e.y)).name)return void t.activate();i?(t=r.getElementAtPoint(e.x,e.y))&&t.name&&("okbutton"===t.name?"function"==typeof n&&n(r.inputValue):"function"==typeof i&&i(),r.close()):(r.close(),n&&n(r.inputValue))},r.onKeyDown=function(e){switch(e){case 13:var t=r.inputValue;return r.close(),n&&n(t),!0;case 27:return r.close(),i&&i(),!0}},r.setText(e),de.setModalElement(r)},f.getChildren=function(){return p},f.getEventElement=function(e,t){for(var n=void 0,i=0,a=p.length;i<a;i++){var r=p[i];if(r.isVisible()&&r.containsPoint(e,t)){n=r;break}}return n&&n.children&&n.children.length&&(n=n.getElementAtPoint(e,t)),n},f.getInternalPoint=function(e,t,n){for(var i={left:0,top:0};n.parent;)i.left+=n.left,i.top+=n.top,n=n.parent;return{x:e-i.left,y:t-i.top}},f.setLoading=function(){f.setStatus("Loading",!0),ye.trigger(ce.songLoading)},f.setStatus=function(e,t){ye.trigger(ce.statusChange,{status:e,showSpinner:!!t})},f.setInfo=function(e,t,n){ye.trigger(ce.statusChange,{info:e,source:t,url:n})},f.stats=function(){return{fps:u,minFps:_,averageFps:e(I),averageRenderFps:e(T),fpsList:I,skipRenderSteps:b}},f.startMeasure=function(){_e.context&&(C=_e.context.currentTime)},f.measure=function(e){if(_e.context){0}},f.endMeasure=function(){_e.context&&(S=1e3*(_e.context.currentTime-C))},f.children=p,f.getAverageFps=function(){return 2<I.length?e(I):60},f.resetAverageFps=function(){var e=I.pop();I=e?[e]:[]},f.skipFrame=function(e){Se.skipFrame=b=e,ye.trigger(ce.skipFrameChanged,b)},f.getSkipFrame=function(){return b},ye.on(ce.clockEventExpired,function(){var e=h();2e3<e-M&&(Ge.warn("throttling back"),b<4?f.skipFrame(b+1):Ge.warn("Browser can't keep up"),M=e)}),f}()).app_sidebar=function(){function t(e){var t=c[e];t&&(d.setSelectedIndex(e),u=e,ot.autoPlay=h=!0,ot.load(t.url))}function e(){h&&(c.length<=++u&&(u=0),ot.stop(),t(u))}var n=de.panel(0,0,200,200);n.setProperties({name:"sideBar"});var i=de.scale9Panel(0,0,n.width,n.height,{img:lt.getImage("background"),left:3,top:3,right:4,bottom:4});i.ignoreEvents=!0,n.addChild(i);var a=de.label();a.setProperties({label:"Playlist:",font:fontFT}),n.addChild(a);var r=de.Assets.generate("buttonKey");n.addChild(r),r.onClick=function(){Oe.doCommand(z.toggleAppSideBar)};var o=de.Assets.generate("buttonKey");o.setLabel("Next"),o.onClick=function(){e()};var s=de.Assets.generate("buttonKey");s.setLabel("Toggle UI"),s.onClick=function(){};var l=de.scale9Panel(0,0,n.width,n.height,{img:lt.getImage("background"),left:3,top:3,right:4,bottom:4});l.ignoreEvents=!0,n.addChild(l),n.addChild(o),n.addChild(s);var d=de.listbox(2,50,100,100);d.setProperties({font:window.fontFT}),n.addChild(d);var c=[{label:"Demomusic",url:"demomods/demomusic.mod"},{label:"Stardust Memories",url:"demomods/StardustMemories.mod"},{label:"Space Debry",url:"demomods/spacedeb.mod"}],u=0,h=!1;d.onChange=function(e){},d.onClick=function(){var e=d.getItemAtPosition(d.eventX,d.eventY);e&&e.url&&t(e.index)},n.onResize=function(){i.setSize(n.width,n.height),r.setPosition(n.width-22,2),a.setSize(n.width,ct.trackControlHeight),l.setPosition(2,32),l.setSize(n.width-4,54),o.setPosition(8,36),o.setProperties({width:n.width<50?20:100}),o.setLabel(n.width<50?">":"Next"),s.setPosition(8,56),s.setProperties({width:n.width<50?20:100}),s.setLabel(n.width<50?"-":"Toggle UI");d.setProperties({left:2,top:88,width:n.width-4,height:n.height-88-ct.defaultMargin}),n.width<50?(a.hide(),l.hide(),d.hide(),o.setPosition(2,36)):(a.show(),l.show(),d.show())},ye.on(ce.songEnd,function(){e()}),n.onResize();var f=Xe.getBaseUrl()+"demomods/Playlist/";return He.get(f+"list.txt",function(e){(e=e.split("\n")).forEach(function(e){e&&c.push({label:e,url:f+e})}),c.forEach(function(e,t){e.index=t}),u=0,h=!1,d.setItems(c)}),n},de.buttonGroup=function(e,t){var o=de.panel();o.hide();var s=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);s.ignoreEvents=!0,o.addChild(s);var n=de.label({label:e,font:fontSmall,width:60,top:1});o.addChild(n);var l=[];return t.forEach(function(t){if("number"===t.type){var n=de.numberDisplay({autoPadding:!0});n.setValue(t.value)}else(n=de.Assets.generate("buttonLight")).setLabel(t.label),n.onClick=t.onClick;n.widthParam=t.width||100,o.addChild(n),l.push(n),t.onSamplePropertyChange&&ye.on(ce.samplePropertyChange,function(e){t.onSamplePropertyChange(n,e)})}),o.onResize=function(){s.setSize(o.width,18);var n=20,i=(o.height-n-2)/4,a=o.width,r=0;l.forEach(function(e,t){e.setProperties({width:Math.floor(a*e.widthParam/100),height:i,left:Math.floor(r*a/100),top:n}),95<(r+=e.widthParam)&&(r=0,n+=i)})},o},de.pattern_sidebar=function(){var i=de.panel();i.setProperties({name:"sideButtonPanel"});var a=de.label();a.setProperties({label:"DEMOSONGS:",font:fontFT}),i.addChild(a);for(var r=[],o=[{label:"Demomusic",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/demomusic.mod")}},{label:"Stardust",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/StardustMemories.mod")}},{label:"Space Debris",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/spacedeb.mod")}},{label:"Tinytune",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/Tinytune.mod")}},{label:"Lotus 2",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/lotus20.mod")}},{label:"Professionaltracker",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/hoffman_and_daytripper_-_professional_tracker.mod")}},{label:"XM: Ambrozia",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/Ambrozia.xm")}},{label:"8CHN: AceMan",onClick:function(){ot.load(Xe.getRemoteUrl()+"demomods/AceMan.mod")}},{label:"Random MOD",onClick:function(){Oe.doCommand(z.randomSong)}},{label:"Random XM",onClick:function(){Oe.doCommand(z.randomSongXM)}}],s=0;s<o.length;s++){var e=o[s],t=de.button();t.info=e,t.onClick=e.onClick,i.addChild(r[s]=t)}var l=de.button();l.setProperties({label:"",textAlign:"center",background:de.Assets.buttonLightScale9,hoverBackground:de.Assets.buttonLightHoverScale9,image:lt.getImage("piano"),font:window.fontMed}),l.onClick=function(){Oe.doCommand(z.togglePiano)},i.addChild(l);var d=de.button();return d.setProperties({label:"",textAlign:"center",background:de.Assets.buttonLightScale9,hoverBackground:de.Assets.buttonLightHoverScale9,image:lt.getImage("nibbles")}),d.onClick=function(){Oe.doCommand(z.nibbles)},i.addChild(d),i.onResize=function(){a.setSize(i.width,ct.trackControlHeight);for(l.setProperties({left:0,top:i.height-30,width:i.width,height:30}),d.setProperties({left:0,top:i.height-30-30,width:i.width,height:30}),s=0;s<o.length;s++){var e=r[s],t=30*s+a.height,n=0;d.top-30<t&&(n=-500),e.setProperties({left:n,top:t,width:i.width,height:30,label:e.info.label,textAlign:"left",background:de.Assets.buttonLightScale9,hoverBackground:de.Assets.buttonLightHoverScale9,font:window.fontFT})}},i.onResize(),i},de.app_patternView=function(e,t,n,u){function B(e,t,n){if(ot.inFTMode())var i="i"+e.index+"."+N.charWidth;else i="p"+e.period+"."+N.charWidth;if(!c[i]){var a=document.createElement("canvas");a.height=Z,a.width=3*N.charWidth+2;var r=a.getContext("2d");if(ot.inFTMode())if(e.index){var o=at[e.index];97===e.index&&(o=at[ve]);var s=o?o.name:"???"}else{s="---";var l=rt[e.period];l&&(o=at[l])&&(s=o.name)}else s=(l=et[e.period])?l.name:"---";N.write(r,s,0,0,0),c[i]=a}Y.ctx.drawImage(c[i],t,n)}function R(e,t,n){t+=3*N.charWidth+4;var i="n"+e.instrument+"."+(H?e.volumeEffect:"")+"."+e.effect+"."+e.param+"."+N.charWidth;if(!f[i]){var a=document.createElement("canvas");a.height=Z,a.width=7*N.charWidth+10;var r=a.getContext("2d"),o=h(e.instrument,2,"0");"00"==o&&(o="..");var s=0;if(N.write(r,o,s,0,0,"green"),H){s+=2*N.charWidth+4;var l=e.volumeEffect||0;if(l&&(l-=16),l<80)o=h(l,2,"0");else{var d=(l>>4).toString(16).toUpperCase(),c=(15&l).toString(16).toUpperCase();o=(d={5:"-",6:"+",7:"↓",8:"↑",9:"S",A:"V",B:"P",C:"<",D:">",E:"M"}[d]||d)+c}e.volumeEffect||(o=".."),N.write(r,o,s,0,0)}s+=2*N.charWidth+4,o=(15<e.effect?function(e,t,n){if(u=e.toString(36).toUpperCase(),t&&u.length<t)for(n=n||"0";u.length<t;)u=n+u;return u}:h)(e.effect),"000"===(o+=h(e.param,2,"0"))&&(o="..."),N.write(r,o,s,0,0,"orange"),f[i]=a}Y.ctx.drawImage(f[i],t,n)}function V(e,t,n,i,a){if(ot.isPlaying()&&e&&e.period&&p[i]!==a){var r=100;if(12===e.effect)r=100*e.param/64;else{var o=ot.getInstrument(e.instrument);o&&(r=100*o.sample.volume/64)}re[i]=r,p[i]=a}if(re[i]){X=!0;var s=re[i]*se/100,l=100*s/se;if("colour"===Se.vubars){var d=lt.getImage("vubar");Y.ctx.drawImage(d,0,100-l,26,l,t,n-s,10,s)}else"trans"===Se.vubars&&(Y.ctx.fillStyle="rgba(120,190,255,0.3)",Y.ctx.fillRect(t,n-s,10,s));re[i]-=oe,re[i]<0&&(re[i]=0)}}function U(e,t,n){var i=""+e;e<10&&(i="0"+i);var a=i+"."+N.charWidth;if(!l[a]){var r=document.createElement("canvas");r.height=Z,r.width=3*N.charWidth;var o=r.getContext("2d"),s=!1;e%4==0&&(s="orange"),N.write(o,i,0,0,0,s),l[a]=r}Y.ctx.drawImage(l[a],t,n)}function h(e,t,n){if(u=e.toString(16).toUpperCase(),t&&u.length<t)for(n=n||"0";u.length<t;)u=n+u;return u}function W(){var e=ot.getCurrentPatternPos()||0;if(K){var t=1,n=Y.height-2,i=n;a=0,1<O&&((i=Math.floor(K/O*n))<12&&(i=12),a=(n-i)/(O-1)),e&&a&&(t=Math.floor(1+a*e)),ne.setProperties({left:Y.width-16,top:t,width:16,height:i})}}function z(){var e=Y.width,t=Math.floor(e/ot.getTrackCount()*q),n=(e-t)/(ot.getTrackCount()-q),i=Y.height-20;q>=ot.getTrackCount()&&(i=-200),ie.setProperties({top:i,width:t,left:0+Math.floor(Q*n)})}function d(){ee={start:[$.start[0],$.start[1]],end:[$.end[0],$.end[1]]};for(var e=0;e<2;e++)$.end[e]<$.start[e]&&(ee.start[e]=$.end[e],ee.end[e]=$.start[e])}function i(e){te?($.end=[ot.getCurrentPatternPos(),Ne.getCurrentTrack()],d()):($.start=[e.prev||0,Ne.getCurrentTrack()],$.end=[e.current,Ne.getCurrentTrack()],$.top=$.left=1e5,d(),te=!0,Y.showSelectionUI()),Y.refresh()}var O,N,H,X,G,j,Y=de.panel(e,t,n,u),K=0,q=8,Z=13,J=0,a=0,Q=0,c={},f={},l={},$={},ee={},g=[],te=!1,ne=de.scale9Panel(n-28,18,16,u-3,{img:lt.getImage("bar"),left:2,top:2,right:3,bottom:3});ne.onDragStart=function(){ot.isPlaying()||(ne.startDragIndex=ot.getCurrentPatternPos())},ne.onDrag=function(e){if(!ot.isPlaying()&&K&&a){var t=Math.floor(ne.startDragIndex+e.deltaY/a);t=Math.min(t,O-1),t=Math.max(t,0),ot.setCurrentPatternPos(t)}},Y.addChild(ne),W();var ie=de.scale9Panel(n-28,18,16,16,{img:lt.getImage("bar"),left:2,top:2,right:3,bottom:3});ie.onDragStart=function(){ie.startDragIndex=Q},ie.onDrag=function(e){var t=ot.getTrackCount()-q,n=Math.floor(e.deltaX/((Y.width-ie.width)/t));Y.setHorizontalScroll(ie.startDragIndex+n),Y.onResize()},Y.addChild(ie);for(var ae=[],r=0,o=ot.getTrackCount();r<o;r++){var s=de.fxPanel(r);ae.push(s),Y.addChild(s)}var re=[],p=[],oe=5,se=70;return Y.setHorizontalScroll=function(e){var t=ot.getTrackCount()-q;e!=Q&&0<=e&&e<=t&&(ye.trigger(ce.patternHorizontalScrollChange,Q=e),z())},Y.onResize=function(){G=ct.firstTrackOffsetLeft,j=ct.trackMargin;var e=Y.height;(q=ct.visibleTracks)<ot.getTrackCount()&&(e-=24);for(var t=0;t<q;t++){if((s=ae[Q+t])&&s.visible)s.setPosition(G+t*(ct.trackWidth+j),0),s.setSize(ct.trackWidth,e),s.setLayout(),s.show()}},Y.render=function(){if(Y.isVisible()){if(this.needsRendering){Y.clearCanvas();var e=ot.getCurrentPattern()||0,t=ot.getCurrentPatternPos()||0,n=ot.getSong();if(!n)return;N=ct.trackFont,O=ot.getPatternLength();var i=q<ot.getTrackCount(),a=Y.height-30,r=(H=ot.inFTMode())?92:72,o=9,s=28;ct.useCondensedTrackFont&&(r=H?46:36,o=5,s=15);var l=10,d=Math.floor((ct.trackWidth-r)/2)+l,c=!1;G&&(c=!(d=l=0)),i&&(a-=24),(K=Math.ceil(a/Z))%2==0&&K--;var u=Math.floor(K/2),h=t-u,f=h+K,g=Z+2,p=(J=Math.floor((a+g)/2))-u*Z+4,m=J,v=J+g,b=le.darkPanel;if(!b&&lt.getImage("panel_dark")){var w=de.scale9Panel(0,0,ct.trackWidth,m,{img:lt.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});le.darkPanel=w.render(!0),b=le.darkPanel}var x=[];X=!1,m<se&&(oe=(se=m)/10);for(var k=0;k<q;k++){var P=Q+k;if(x[P]=!(ae[P]&&ae[P].visible),x[P]){var C=G+k*(ct.trackWidth+j);Y.ctx.drawImage(b,C,0,ct.trackWidth,m),Y.ctx.drawImage(b,C,v,ct.trackWidth,m),ae[P]&&(ae[P].left=C)}}var S=n.patterns[e];if(S){ot.isRecording()?Y.ctx.fillStyle="#A50B0F":Y.ctx.fillStyle="#202E58",Y.ctx.fillRect(0,J,+Y.width,g);var y,_=Ne.getCurrentTrackPosition(),I=o;y=c?(C=G+(Ne.getCurrentTrack()-Q)*(ct.trackWidth+j))+Math.floor((ct.trackWidth-r)/2)+_*I-1:G+d+(Ne.getCurrentTrack()-Q)*ct.trackWidth+_*I-1,0<_?(y+=2*I+1,2<_&&(y+=2),4<_&&H&&(y+=2)):I=s,Y.ctx.fillStyle="rgba(220,220,220,.3)",Y.ctx.fillRect(y,J,I,Z+2),Y.ctx.fillStyle="rgba(200,150,70,.3)";var T=8*N.charWidth+14;H&&(T+=2*N.charWidth+2);for(k=h;k<f;k++)if(0<=k&&k<ot.getPatternLength()){var M=S[k],A=p+(k-h)*Z,E=!0;A<J&&(A-=3,E=!1),J+Z<A&&(A+=3,E=!1),U(k,l,A),E&&(U(k,l,A),U(k,l,A));for(var D=0;D<q;D++)if(x[P=D+Q]&&P<ot.getTrackCount()){var F,L=M[P]||Nt();F=c?(C=G+D*(ct.trackWidth+j))+(ct.trackWidth-r>>1):G+d+D*ct.trackWidth,te&&ee.start[0]<=k&&k<=ee.end[0]&&ee.start[1]<=P&&P<=ee.end[1]&&($.top=Math.min($.top,A-2),$.left=Math.min($.left,F-2),Y.ctx.fillRect(F-2,A-2,T,Z)),E&&(B(L,F,A),B(L,F,A),(ot.isPlaying()||re[D]&&"none"!==Se.vubars)&&V(L,F-12,J,D,e+"."+t)),B(L,F,A),R(L,F,A)}X&&setTimeout(function(){Y.refresh()},20)}}for(D=0;D<q;D++)x[P=D+Q]||ae[P].render();for(W(),ne.render(),i&&(z(),ie.render()),D=0;D<q;D++)x[P=D+Q]&&N.write(Y.ctx,""+(P+1),C=G+D*(ct.trackWidth+j)+2,2,0,void 0)}this.needsRendering=!1,Y.parentCtx.drawImage(Y.canvas,Y.left,Y.top,Y.width,Y.height)}},Y.onMouseWheel=function(e){if(!ot.isPlaying()){var t=ot.getCurrentPatternPos();0<e.mouseWheels[0]?t&&ot.moveCurrentPatternPos(-1):t<O-1&&ot.moveCurrentPatternPos(1)}},Y.onDragStart=function(e){if(ie.startDragIndex=Q,!ot.isPlaying()&&(Y.startDragPos=ot.getCurrentPatternPos(),e.isMeta||ot.isRecording())){var t=Math.floor((e.x-ct.firstTrackOffsetLeft)/(ct.trackWidth+ct.trackMargin)),n=Ne.getStepsPerTrack();Ne.setCurrentCursorPosition((Q+t)*n),de.clearSelection(),Y.startDragTrackX=t*(ct.trackWidth+ct.trackMargin)+ct.firstTrackOffsetLeft;var i=Math.floor((e.y-J)/Z);$.start=[ot.getCurrentPatternPos()+i,Ne.getCurrentTrack()],$.end=$.start,$.top=$.left=1e5,Y.refresh()}},Y.onDrag=function(e){if(q<ot.getTrackCount()&&!e.isMeta&&!ot.isRecording()){var t=ot.getTrackCount()-q,n=e.deltaX,i=Math.floor(n/((Y.width-ie.width)/t));Y.setHorizontalScroll(ie.startDragIndex-i)}if(!ot.isPlaying()){n=Math.round(e.deltaY/Z);var a=Y.startDragPos-n;if(a=Math.max(a,0),a=Math.min(a,O-1),e.isMeta||ot.isRecording()){te=!0,n=Math.floor(e.deltaY/Z);var r=Math.floor(e.deltaX/ct.trackWidth);$.end=[$.start[0]+n,Ne.getCurrentTrack()+r],d(),Y.refresh()}else ot.setCurrentPatternPos(a)}},Y.onTouchUp=function(){te&&Y.showSelectionUI()},Y.onClick=function(e){var t=Math.floor((e.x-ct.firstTrackOffsetLeft)/(ct.trackWidth+ct.trackMargin)),n=Ne.getStepsPerTrack();Ne.setCurrentCursorPosition((Q+t)*n)},Y.getStartTrack=function(){return Q},Y.processSelection=function(e){if(Y.isVisible())switch(e){case ue:return te=!1,de.hideContextMenu(),Y.refresh(),!0;case he:if((r=ot.getCurrentPatternData())&&te){(o=_t.createRangeUndo(ot.getCurrentPattern())).name="Clear Selection";for(var t=ee.start[0];t<=ee.end[0];t++)for(var n=r[t],i=ee.start[1];i<=ee.end[1];i++){(s=n[i])&&(_t.addNote(o,i,t,s),s.clear())}}_t.registerEdit(o),Y.refresh();break;case ge:case fe:if(g=[],(r=ot.getCurrentPatternData())&&te)for(t=ee.start[0];t<=ee.end[0];t++){if(n=r[t]){var a=[];for(i=ee.start[1];i<=ee.end[1];i++){(s=n[i]||new Nt)&&a.push(s.duplicate())}g.push(a)}}if(e===fe&&te){(o=_t.createRangeUndo(ot.getCurrentPattern())).name="Cut Selection";for(t=ee.start[0];t<=ee.end[0];t++){if(n=r[t])for(i=ee.start[1];i<=ee.end[1];i++){_t.addNote(o,i,t,s=n[i]),s&&s.clear()}}_t.registerEdit(o)}Y.refresh();break;case pe:var r;if((r=ot.getCurrentPatternData())&&te&&g.length){var o;(o=_t.createRangeUndo(ot.getCurrentPattern())).name="Paste Selection";for(t=0;t<g.length;t++){a=g[t];if(n=r[ee.start[0]+t])for(i=0;i<a.length;i++){var s,l=ee.start[1]+i;!(s=n[l])&&l<ot.getTrackCount()&&(s=new Nt,n[l]=s),s&&(_t.addNote(o,l,ee.start[0]+t,s),s.populate(a[i]))}}_t.registerEdit(o)}Y.refresh();break;case me:$.start=$.end=[ot.getCurrentPatternPos(),Ne.getCurrentTrack()],d(),te=!0,Y.refresh()}},Y.showSelectionUI=function(){de.setSelection(Y.processSelection),de.showContextMenu({name:"patternActions",items:[{label:"Clear",onClick:function(){Y.processSelection(he)}},{label:"Cut",onClick:function(){Y.processSelection(fe)}},{label:"Copy",onClick:function(){Y.processSelection(ge)}},{label:"Paste",onClick:function(){Y.processSelection(pe)}}],x:$.left+Y.left+Y.parent.left,y:$.top+Y.top+Y.parent.top})},ye.on(ce.patternPosChange,function(e){ht.isMetaKeyDown()&&!ot.isPlaying()&&i(e)}),ye.on(ce.cursorPositionChange,function(e){ht.isMetaKeyDown()&&!ot.isPlaying()&&i({current:ot.getCurrentPatternPos(),prev:ot.getCurrentPatternPos()})}),ye.on(ce.trackCountChange,function(e){q<e&&(q=e),Q=Math.min(Q,e-q),Q=Math.max(Q,0);for(var t=ae.length,n=e;t<n;t++){var i=de.fxPanel(t);ae.push(i),Y.addChild(i)}Y.onResize(),Y.refresh()}),ye.on(ce.songLoaded,function(){Y.setHorizontalScroll(0)}),ye.on(ce.visibleTracksCountChange,function(){Q=0,Y.onResize(),Y.refresh()}),ye.on(ce.trackerModeChanged,function(){Y.refresh()}),ye.on(ce.fxPanelToggle,function(e){if((s=ae[e]).visible)s.hide();else{var t=Y.height;q<ot.getTrackCount()&&(t-=24),s.setPosition(s.left,0),s.setSize(ct.trackWidth,t),s.setLayout(),s.show()}Y.refresh()}),ye.on(ce.skipFrameChanged,function(e){oe=5*(e+1)}),ye.on(ce.commandSelectAll,function(){Y.isVisible()&&(de.clearSelection(),$.start=[0,Ne.getCurrentTrack()],$.end=[ot.getCurrentPatternData().length-1,Ne.getCurrentTrack()],d(),te=!0,$.top=$.left=1e5,Y.showSelectionUI(),Y.refresh())}),Y},de.app_songControl=function(e,t,n,i,a){var r=de.element(e,t,n,i,a);r.type="songControl";var o=de.radioGroup();o.setItems([{label:"song",active:!0},{label:"pattern",labels:[{width:10,label:"p"},{width:20,label:"pat"}],active:!1}]),o.onChange=function(e){ot.setPlayType(0==e?F:L)},r.addChild(o);var s={};s.play=de.Assets.generate("buttonDarkGreen"),s.play.setProperties({image:lt.getImage("play_green"),hoverImage:lt.getImage("play_green_hover"),activeImage:lt.getImage("play_active_red"),activeBackground:de.Assets.buttonDarkRedActiveScale9}),s.play.onClick=function(){s.play.toggleActive(),ot.isPlaying()?ot.stop():ot.getPlayType()==F?ot.playSong():ot.playPattern()},s.play.setProperties({name:"buttonPlay"}),r.addChild(s.play),s.record=de.Assets.generate("buttonDarkRed"),s.record.setProperties({image:lt.getImage("record"),hoverImage:lt.getImage("record_hover"),activeImage:lt.getImage("record_active")}),s.record.onClick=function(){ot.toggleRecord()},s.record.setProperties({name:"buttonRecord"}),r.addChild(s.record),s.song=de.Assets.generate("buttonDark"),s.song.onClick=function(){ot.playSong()},s.song.setProperties({label:"Song"}),r.addChild(s.song),s.pattern=de.Assets.generate("buttonDark"),s.pattern.onClick=function(){ot.playPattern()},s.pattern.setProperties({label:"Pattern"}),r.addChild(s.pattern),ye.on(ce.recordingChange,function(e){s.record.setActive(e)}),ye.on(ce.playingChange,function(e){s.play.setActive(e)}),ye.on(ce.playTypeChange,function(e){o.setSelectedIndex(e==F?0:1,!0)});var l=["left","top","width","height","name","type","songPatternSelector"];return r.setProperties=function(t){l.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top);var e=Math.floor(r.width/3);o.setProperties({left:0,width:e,top:0,height:r.height,align:"right"}),s.play.setProperties({left:e,width:e,top:0,height:r.height}),s.record.setProperties({left:2*e,width:e,top:0,height:r.height}),"big"==r.songPatternSelector&&(o.left=-500,e=Math.floor(r.width/4)+1,s.play.setProperties({left:0,width:e}),s.record.setProperties({left:e,width:e}),s.song.setProperties({left:2*e,width:e,top:0,height:r.height}),s.pattern.setProperties({left:3*e,width:e,top:0,height:r.height}))},r.render=function(e){if(e=!!e,r.needsRendering&&(r.clearCanvas(),"small"==r.songPatternSelector&&o.render(),s.play.render(),s.record.render(),"big"==r.songPatternSelector&&(s.song.render(),s.pattern.render())),r.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)},r},de.app_songPatternList=function(e){function r(e){return(e=""+e).length<2&&(e="0"+e),e}var t=de.panel(),n=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);t.addChild(n);var o=de.listbox();o.setItems([{label:"01:00",data:1}]),o.onClick=function(){var e=o.getItemAtPosition(o.eventX,o.eventY);if(e){var t=e.index;e!==o.getSelectedIndex()&&o.setSelectedIndex(t)}},t.addChild(o);var i=de.Assets.generate("button20_20");i.setLabel("↑"),i.onDown=function(){var e=o.getSelectedIndex(),t=ot.getSong().patternTable[e];ot.updatePatternTable(e,++t),de.ticker.onEachTick4(function(){var e=o.getSelectedIndex(),t=ot.getSong().patternTable[e];ot.updatePatternTable(e,++t)},5)},i.onTouchUp=function(){de.ticker.onEachTick4()},t.addChild(i);var a=de.Assets.generate("button20_20");a.setLabel("↓"),a.onDown=function(){var e=o.getSelectedIndex(),t=ot.getSong().patternTable[e];0<t&&t--,ot.updatePatternTable(e,t),de.ticker.onEachTick4(function(){var e=o.getSelectedIndex(),t=ot.getSong().patternTable[e];0<t&&t--,ot.updatePatternTable(e,t)},5)},a.onTouchUp=function(){de.ticker.onEachTick4()},t.addChild(a);var s=de.Assets.generate("button20_20");s.setLabel("Ins"),s.onDown=function(){var e=o.getSelectedIndex();Ne.addToPatternTable(e)},s.setProperties({width:40,height:20}),t.addChild(s);var l=de.Assets.generate("button20_20");return l.setLabel("Del"),l.onDown=function(){var e=o.getSelectedIndex();Ne.removeFromPatternTable(e)},l.setProperties({width:40,height:20}),t.addChild(l),t.onResize=function(){n.setSize(t.width,t.height),o.setProperties({left:0,top:0,width:t.width-42,height:t.height,centerSelection:!0,onChange:function(){ot.setCurrentSongPosition(o.getSelectedIndex(),!0)}}),a.setPosition(t.width-22,Math.floor(t.height/2)-10),i.setPosition(t.width-42,a.top),s.setPosition(i.left,i.top-22),l.setPosition(i.left,i.top+22)},ye.on(ce.patternTableChange,function(e){t.setPatternTable(ot.getSong().patternTable)}),t.setPatternTable=function(e){for(var t=[],n=0,i=ot.getSong().length;n<i;n++){var a=e[n];t.push({label:r(n+1)+":"+r(a),data:a,index:n})}o.setItems(t)},ye.on(ce.songLoaded,function(e){t.setPatternTable(e.patternTable)}),ye.on(ce.songPositionChange,function(e){o.setSelectedIndex(e,!0)}),t},de.trackControl=function(e,t,n,i,a){function r(e){ye.trigger(ce.trackStateChange,{track:o.track,solo:s.solo.isActive,mute:s.mute.isActive,wasSolo:e})}var o=de.element(e,t,n,i,a);o.type="trackControl",o.track=0;var s={};s.solo=de.Assets.generate("buttonDark"),s.solo.setProperties({activeImage:lt.getImage("solo.png"),activeBackground:de.Assets.buttonDarkGreenActiveScale9}),s.solo.onClick=function(){var e=s.solo.isActive;s.solo.toggleActive(),s.mute.isActive&&s.mute.toggleActive(),r(e)},s.solo.setProperties({name:"buttonSolo",label:"S"}),o.addChild(s.solo),s.mute=de.Assets.generate("buttonDark"),s.mute.setProperties({activeImage:lt.getImage("mute"),activeBackground:de.Assets.buttonDarkRedActiveScale9}),s.mute.onClick=function(){s.mute.toggleActive(),s.solo.isActive&&s.solo.toggleActive(),r()},s.mute.setProperties({name:"buttonMute",label:"M"}),o.addChild(s.mute),s.fx=de.Assets.generate("buttonDark"),s.fx.onClick=function(){s.fx.toggleActive(),ye.trigger(ce.fxPanelToggle,o.track)},s.fx.setProperties({name:"buttonFX",label:"FX"}),o.addChild(s.fx);var l=["left","top","width","height","name","type","track","solo","mute","visible"];return o.setProperties=function(t){l.forEach(function(e){if(void 0!==t[e])switch(e){case"solo":s.mute.isActive&&s.mute.setActive(!1),s.solo.setActive(t[e]),r();break;case"mute":s.solo.isActive&&s.solo.setActive(!1),s.mute.setActive(t[e]),r();break;default:o[e]=t[e]}}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top);var e=Math.floor(o.width/3)+1;s.solo.setProperties({left:0,width:e,top:0,height:o.height}),s.mute.setProperties({left:e-1,width:e,top:0,height:o.height}),s.fx.setProperties({left:2*e-2,width:e,top:0,height:o.height})},o.render=function(e){if(o.isVisible()){if(e=!!e,o.needsRendering&&(o.clearCanvas(),o.ctx.fillStyle="white",o.ctx.fillText("",10,10),s.solo.render(),s.mute.render(),s.fx.render()),o.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)}},ye.on(ce.trackScopeClick,function(e){e===o.track&&s.mute.onClick()}),o},de.visualiser=function(){function i(){m=[];var e=ot.getTrackCount(),t=f.height;4<ot.getTrackCount()&&(e=Math.ceil(ot.getTrackCount()/2),t=f.height/2);for(var n=f.width/e,i=0;i<ot.getTrackCount();i++){var a=i*n,r=0;e<=i&&(a=(i-e)*n,r=f.height-t),m[i]={left:Math.floor(a),top:Math.floor(r),width:Math.floor(n),height:Math.floor(t),lineLeft:Math.ceil(a+n/70),lineWidth:Math.floor(n-n/30)}}}var a,h,f=de.panel(),e=["wave","spectrum","tracks"],t=2,r=e[t],g=[],p=[],m=[],v=256;f.ctx.fillStyle="black",f.ctx.lineWidth=2,f.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",f.init=function(){function n(){var e=_e.context.createAnalyser();e.smoothingTimeConstant=0,e.fftSize=v,g.push(e)}if(_e.context){(a=_e.context.createAnalyser()).minDecibels=-90,a.maxDecibels=-10,a.smoothingTimeConstant=.85;for(var e=0;e<ot.getTrackCount();e++)n();i()}h=lt.getImage("oscilloscope"),ye.on(ce.filterChainCountChange,function(e){for(var t=g.length;t<e;t++)n();i(),f.connect()}),ye.on(ce.trackStateChange,function(e){void 0!==e.track&&(p[e.track]=e.mute)}),f.needsRendering=!0},f.connect=function(e){if(_e.context){e&&e.connect(a);for(var t=0;t<ot.getTrackCount();t++)_e.filterChains[t].output().connect(g[t])}},f.nextMode=function(){e.length<=++t&&(t=0),r=e[t]};return f.render=function(){_e.context&&f.isVisible()&&function(){f.ctx.clearRect(0,0,f.width,f.height),f.ctx.lineWidth=2,f.ctx.strokeStyle="rgba(120, 255, 50, 0.5)";for(var e,t,n=!_e.cutOff,i=0;i<ot.getTrackCount();i++){var a=g[i],r=m[i],o=p[i];if(f.ctx.drawImage(h,r.left,r.top,r.width,r.height),a){var s;f.ctx.beginPath();var l=r.lineLeft,d=r.lineWidth;if(n&&!o){a.fftSize=v,e=a.fftSize,t=new Uint8Array(e),a.getByteTimeDomainData(t);for(var c=d/e,u=0;u<e;u++){s=t[u]/128*r.height/2+r.top,0===u?f.ctx.moveTo(l,s):f.ctx.lineTo(l,s),l+=c}}else f.ctx.moveTo(l,s=r.height/2+r.top),f.ctx.lineTo(l+d-1,s);f.ctx.stroke(),o&&(f.ctx.fillStyle="rgba(34, 49, 85, 0.5)",f.ctx.fillRect(r.left,r.top,r.width,r.height))}}Qe.drawImage(f.canvas,f.left,f.top)}()},f.init(),f.onResize=function(){i()},ye.on(ce.screenRender,function(){f.render()}),ye.on(ce.second,function(){ot.isPlaying()&&de.getAverageFps()<32&&32<v&&(v>>=1,v=Math.max(v,32),de.resetAverageFps())}),f.onClick=function(e){if("tracks"===r)for(var t=0;t<ot.getTrackCount();t++){var n=m[t],i=e.x,a=e.y;if(n.left<i&&i<n.left+n.width&&n.top<a&&a<n.top+n.height){ye.trigger(ce.trackScopeClick,t);break}}},f},de.vumeter=function(){function t(){u.width=h.width=c,u.height=h.height=6;var e=Math.floor(c/12);f.clearRect(0,0,u.width,u.height),g.clearRect(0,0,h.width,h.height);for(var t=0;t<e;t++){var n=p,i=m;e/3<=t&&(n=v,i=b),e/1.5<=t&&(n=w,i=x),f.drawImage(n,12*t,0,10,6),g.drawImage(i,12*t,0,10,6)}d.ctx.fillStyle="#253352"}function a(e){for(var t=e.length,n=128,i=128,a=0;a<t;a++){var r=e[a];r<n?n=r:i<r&&(i=r)}return(i-n)/255}var r,o,s,l,d=de.panel();d.left=400,d.top=9,_e.context&&((r=_e.context.createAnalyser()).minDecibels=-90,r.maxDecibels=-10,r.smoothingTimeConstant=.85,(o=_e.context.createAnalyser()).minDecibels=-90,o.maxDecibels=-10,o.smoothingTimeConstant=.85,o.fftSize=r.fftSize=32,l=new Uint8Array(r.fftSize));var c=500,u=document.createElement("canvas"),h=document.createElement("canvas"),f=u.getContext("2d"),g=h.getContext("2d"),p=lt.getImage("vu_green"),m=lt.getImage("vu_green_active"),v=lt.getImage("vu_yellow"),b=lt.getImage("vu_yellow_active"),w=lt.getImage("vu_red"),x=lt.getImage("vu_red_active");return d.setSize(c,16),t(),d.needsRendering=!0,d.connect=function(e){if(_e.context){var t=_e.context.createChannelSplitter(2);e.connect(t),t.connect(r,0),t.connect(o,1),s=!0}},d.setProperties=function(e){c=e.width,d.left=e.left,d.setSize(c,16),t()},d.render=function(){if(s){r.getByteTimeDomainData(l);var e=a(l)*(Math.E-1);o.getByteTimeDomainData(l);var t=a(l)*(Math.E-1);d.ctx.fillRect(0,0,d.width,d.height),d.ctx.drawImage(u,0,0),d.ctx.drawImage(u,0,10);var n=Math.min(Math.floor(e*c),c),i=Math.min(Math.floor(t*c),c);n&&d.ctx.drawImage(h,0,0,n,6,0,0,n,6),i&&d.ctx.drawImage(h,0,0,i,6,0,10,i,6),Qe.drawImage(d.canvas,d.left,d.top)}},ye.on(ce.screenRender,function(){d.render()}),d};var dt,ct=dt={defaultMargin:4,showAppSideBar:!(de.app_controlPanel=function(){var d=de.app_panelContainer(40),c=de.app_songControl();d.addChild(c);var u=de.checkboxbutton({label:"File",onDown:function(){ye.trigger(ce.showView,this.isActive?"diskop_load":"topmain")}}),h=de.checkboxbutton({label:"Options",onDown:function(){ye.trigger(ce.showView,this.isActive?"options":"topmain")}}),f=de.checkboxbutton({label:"Sample Edit",onDown:function(){ye.trigger(ce.showView,this.isActive?"sample":"bottommain")}});d.addChild(u),d.addChild(h),d.addChild(f);var n={background:de.Assets.buttonKeyScale9,hoverBackground:de.Assets.buttonKeyHoverScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},g=de.button(),p=de.button();g.setProperties(n),g.setLabel("mod"),g.onDown=function(){ot.setTrackerMode(Pe)},d.addChild(g),p.setProperties(n),p.setLabel("XM"),p.onDown=function(){ot.setTrackerMode(Ce)},d.addChild(p);var m=[4,8,12,16],v=[];m.forEach(function(e){v.push(de.button())}),v.forEach(function(e,t){e.setProperties(n),e.setLabel(""+m[t]),e.index=t,e.onDown=function(){if(!this.isDisabled){var n=this.index;v.forEach(function(e,t){e.setActive(t===n)}),ct.setVisibleTracks(m[n])}},d.addChild(e)});var b=de.label();b.setProperties({label:"Mode",labels:[{width:20,label:""},{width:78,label:"M"},{width:84,label:"Md"},{width:100,label:"Mode"}],font:fontSmall,width:100,height:20,textAlign:"right"}),b.ignoreEvents=!0,d.addChild(b);var w=de.label();w.setProperties({label:"Display",labels:[{width:10,label:""},{width:78,label:"t"},{width:84,label:"tr"},{width:100,label:"trck"},{width:120,label:"Display"}],font:fontSmall,width:100,height:20,textAlign:"right"}),w.ignoreEvents=!0,d.addChild(w);var x=de.spinBox();return x.setProperties({name:"Pattern",value:ot.getTrackCount(),max:32,min:2,size:"big",padLength:2,trackUndo:!0,undoLabel:"Change Track count",onChange:function(e){ot.setTrackCount(e)}}),d.addChild(x),d.onPanelResize=function(){d.innerHeight=d.height-2*ct.defaultMargin;var e=ct.defaultMargin,t=ct.defaultMargin;if("2row"===ct.controlPanelButtonLayout){var n=Math.floor((d.innerHeight-ct.defaultMargin)/2);t=d.height-n-ct.defaultMargin,d.innerHeight=n}c.setProperties({left:ct.col1X,top:e,width:ct.songControlWidth,height:d.innerHeight,songPatternSelector:"small"});var i=ct.col1W-60;i=Math.max(i,120);var a=Math.floor((ct.col1W-i)/2),r=ct.col4X+a,o="Sample Edit";"1row"!==ct.controlPanelButtonLayout&&(i=Math.floor(ct.controlPanelButtonsWidth/3),a=0,r=ct.controlPanelButtonsLeft+2*i,o="Sample");var s=d.innerHeight;u.setProperties({left:ct.controlPanelButtonsLeft+1.5*a,top:t,width:i,height:s}),h.setProperties({left:u.left+i+a,top:t,width:i,height:s}),f.setProperties({left:r,top:t,width:i,height:s,label:o}),g.setProperties({left:ct.modeButtonsLeft+(ct.modeButtonsWidth-101),top:e,width:51,height:16}),p.setProperties({left:g.left+g.width-1,top:g.top,width:g.width,height:g.height});var l=g.left;v.forEach(function(e,t){e.setProperties({left:l,top:g.top+g.height,width:26,height:g.height}),l+=e.width-1,e.setActive(m[t]===ct.visibleTracks),e.setDisabled(ct.maxVisibleTracks<m[t])}),b.setProperties({left:ct.modeButtonsLeft,top:e+1,width:ct.modeButtonsWidth-94,height:20}),w.setProperties({left:b.left,top:b.top+g.height,width:b.width,height:b.height}),x.setProperties({left:ct.modeButtonsLeft,top:e,width:ct.TrackCountSpinboxWidth,height:d.innerHeight})},d.onPanelResize(),d.renderInternal=function(){"2row"!==ct.controlPanelButtonLayout&&(d.ctx.drawImage(lt.getImage("line_ver"),ct.controlPanelButtonsLeft-2,0,2,d.height-1),d.ctx.drawImage(lt.getImage("line_ver"),ct.modeButtonsLeft-2,0,2,d.height-1),"condensed"!==ct.controlPanelButtonLayout&&(d.ctx.drawImage(lt.getImage("line_ver"),ct.col4X-2,0,2,d.height-1),d.ctx.translate(.5,.5),d.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",d.ctx.lineWidth=1,d.ctx.beginPath(),d.ctx.moveTo(ct.col2X+10,10),d.ctx.lineTo(ct.col2X+10,20),d.ctx.lineTo(ct.col4X-14,20),d.ctx.lineTo(ct.col4X-14,10),d.ctx.moveTo(ct.col4X+10,30),d.ctx.lineTo(ct.col4X+10,20),d.ctx.lineTo(ct.col5X-14,20),d.ctx.lineTo(ct.col5X-14,30),d.ctx.stroke(),d.ctx.setTransform(1,0,0,1,0,0),u.render(),h.render(),f.render()))},ye.on(ce.showView,function(e){switch(e){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":u.setActive(!0),h.setActive(!1);break;case"options":u.setActive(!1),h.setActive(!0);break;case"topmain":u.setActive(!1),h.setActive(!1);break;case"main":u.setActive(!1),h.setActive(!1),f.setActive(!1);break;case"bottommain":f.setActive(!1);break;case"sample":f.setActive(!0)}}),ye.on(ce.trackerModeChanged,function(e){g.setActive(e===Pe),p.setActive(e===Ce),ct.setLayout()}),ye.on(ce.trackCountChange,function(e){x.setValue(e,!0)}),ye.on(ce.songLoaded,function(e){var t=e.channels;12<t&&t<16&&(t=16),8<t&&t<12&&(t=12),4<t&&t<8&&(t=8),t=Math.min(t,ct.maxVisibleTracks),ct.setVisibleTracks(t),d.onPanelResize()}),d}),setLayout:function(e,t){dt.width=e||dt.width,dt.height=t||dt.height;var n=dt.width;if(dt.sidebarWidth=dt.showAppSideBar?200:0,n-=dt.sidebarWidth,dt.col1W=Math.floor((n-6*dt.defaultMargin-3)/5),dt.col2W=2*dt.col1W+dt.defaultMargin,dt.col3W=3*dt.col1W+2*dt.defaultMargin,dt.col4W=4*dt.col1W+3*dt.defaultMargin,dt.col5W=5*dt.col1W+4*dt.defaultMargin,dt.marginLeft=Math.floor((n-dt.col5W)/2),dt.marginRight=n-dt.marginLeft-dt.col5W,dt.mainLeft=dt.sidebarWidth,dt.mainWidth=n,dt.col1X=dt.marginLeft,dt.col2X=dt.col1X+dt.defaultMargin+dt.col1W,dt.col3X=dt.col2X+dt.defaultMargin+dt.col1W,dt.col4X=dt.col3X+dt.defaultMargin+dt.col1W,dt.col5X=dt.col4X+dt.defaultMargin+dt.col1W,dt.colHalfW=Math.floor(dt.col1W/2),dt.col31W=Math.floor((n-4*dt.defaultMargin-5)/3),dt.col32W=2*dt.col31W+dt.defaultMargin,dt.col31X=dt.col1X,dt.col32X=dt.col31X+dt.defaultMargin+dt.col31W,dt.col33X=dt.col32X+dt.defaultMargin+dt.col31W,dt.prefered="col5",dt.controlPanelHeight=40,dt.controlPanelLayout="full",dt.controlPanelButtonLayout="1row",dt.controlPanelButtonsLeft=dt.col2X,dt.controlPanelButtonsWidth=dt.col3W,dt.modeButtonsWidth=dt.col1W,dt.modeButtonsLeft=dt.col5X,dt.songControlWidth=dt.col1W,dt.TrackCountSpinboxWidth=60,dt.trackWidth=dt.col1W,dt.trackMargin=dt.defaultMargin,dt.visibleTracks=dt.visibleTracks||4,dt.infoPanelHeight=24,dt.trackControlHeight=32,dt.analyserHeight=66,dt.pianoHeight=200,dt.trackFont=fontMed,dt.useCondensedTrackFont=!1,dt.maxVisibleTracks=16,n<945&&(dt.maxVisibleTracks=12),n<725&&(dt.maxVisibleTracks=8),n<512&&(dt.maxVisibleTracks=4),dt.maxVisibleTracks<dt.visibleTracks)dt.setVisibleTracks(dt.maxVisibleTracks);else{n<820&&(dt.controlPanelButtonLayout="condensed",dt.modeButtonsWidth=dt.col1W+dt.colHalfW,dt.modeButtonsLeft=dt.col5X-dt.colHalfW,dt.songControlWidth=dt.modeButtonsWidth,dt.controlPanelButtonsLeft=dt.col2X+dt.colHalfW,dt.controlPanelButtonsWidth=dt.col2W),n<650&&(dt.controlPanelButtonLayout="2row",dt.controlPanelHeight=80,dt.controlPanelButtonsLeft=dt.col1X,dt.controlPanelButtonsWidth=dt.col5W,dt.controlPanelButtonsButton=Math.floor(dt.controlPanelButtonsWidth/3),dt.modeButtonsLeft=2*dt.controlPanelButtonsButton-dt.TrackCountSpinboxWidth,dt.modeButtonsWidth=dt.controlPanelButtonsButton+dt.TrackCountSpinboxWidth+dt.defaultMargin,dt.songControlWidth=dt.col2W+dt.colHalfW+dt.defaultMargin),n<620&&(dt.prefered="col3"),dt.height<800&&(dt.pianoHeight=150),dt.height<650&&(dt.pianoHeight=100);var i=dt.defaultMargin*(dt.visibleTracks-1);dt.showSideBar=dt.visibleTracks<5&&620<n;var a=dt.showSideBar?dt.col4W:dt.col5W;dt.trackWidth=Math.floor((a-i)/dt.visibleTracks),dt.firstTrackOffsetLeft=0,dt.trackWidth<125&&(dt.firstTrackOffsetLeft=18,dt.trackWidth=Math.floor((a-i-dt.firstTrackOffsetLeft)/dt.visibleTracks));var r=ot.inFTMode()?100:78;dt.trackWidth<r&&(dt.trackFont=fontSuperCondensed,dt.useCondensedTrackFont=!0)}},setVisibleTracks:function(e){dt.visibleTracks=e,dt.setLayout(),ye.trigger(ce.visibleTracksCountChange,e)}};de.app_mainPanel=function(){function l(){g.show(),p.show(),m.show(),_.show(),P.show(),S.show(),v.show(),b.show(),C.show(),k.show(),y.show(),w.show(),x.show(),"col3"===ct.prefered?d&&d.show():d&&d.hide()}var d,c,u=de.app_panelContainer(160),h="",f="",g=de.button();g.setProperties({background:de.Assets.panelInsetScale9,activeBackground:de.Assets.buttonDarkScale9,image:lt.getImage("logo_grey_70"),activeImage:lt.getImage("logo_colour_70")}),g.onDown=function(){g.toggleActive()},u.addChild(g);var p=de.button();p.setProperties({background:de.Assets.panelInsetScale9,activeBackground:de.Assets.panelInsetScale9,image:lt.getImage("tracker"),activeImage:function(){var e=lt.getImage("steffest"),t="undefined"==typeof versionNumber?"dev":versionNumber;if(0<t.indexOf(".")){var n=t.split(".");t=n[0]+"."+n[1]}t="Version "+t;var i=e.getContext("2d");return fontSmall.write(i,t,44,4),fontSmall.write(i,"By",44,13),e}()}),p.onDown=function(){p.toggleActive()},u.addChild(p);var m=de.inputbox({name:"modName",trackUndo:!0,onChange:function(e){ot.getSong().title=e,de.setInfo(e)}});u.addChild(m);var v=de.listbox();v.setItems([{label:"loading ...",data:1}]),u.addChild(v),v.onClick=function(e){ht.setFocusElement(v);var t=v.getItemAtPosition(v.eventX,v.eventY);t&&ot.setCurrentInstrumentIndex(t.data)};var b=de.app_songPatternList();u.addChild(b);var e=window.fontFT,w=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);u.addChild(w);var x=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);u.addChild(x);var k=de.spinBox();k.setProperties({name:"Pattern",label:"Pattern",labels:[{width:10,label:"Pat."},{width:140,label:"Pattern"}],value:0,max:100,min:0,font:e,onChange:function(e){ot.setCurrentPattern(e)}}),u.addChild(k);var P=de.spinBox({name:"Instrument",label:"Instrument",labels:[{width:10,label:"Ins."},{width:123,label:"Instr"},{width:160,label:"Instrument"}],value:1,max:31,min:1,font:e,onChange:function(e){ot.setCurrentInstrumentIndex(e)}});u.addChild(P);var C=de.spinBox({name:"SongLength",label:"Song length",labels:[{width:10,label:"Len."},{width:138,label:"Length"},{width:156,label:"Song len"},{width:178,label:"Song length"}],value:1,max:200,min:1,font:e,trackUndo:!0,undoLabel:"Change Song length",onChange:function(e){var t=ot.getSong().length;e<t?Ne.removeFromPatternTable():t<e&&Ne.addToPatternTable()}});u.addChild(C);var S=de.spinBox({name:"SongRepeat",label:"Song repeat",labels:[{width:10,label:"Rep."},{width:138,label:"Repeat"},{width:156,label:"Song rep"},{width:178,label:"Song repeat"}],value:1,max:200,min:1,font:e,onChange:function(e){ot.getSong().restartPosition=e}});u.addChild(S);var y=de.spinBox({name:"PatternLength",label:"Pattern length",labels:[{width:10,label:"Plen"},{width:138,label:"Pat len"},{width:166,label:"Pattern len"},{width:188,label:"Pattern length"}],value:64,max:128,min:1,font:e,trackUndo:!0,undoLabel:"Change Pattern length",onChange:function(e){ot.setPatternLength(e)}});u.addChild(y);var _=de.spinBox({name:"BPMLength",label:"BPM",value:1,max:400,min:1,font:e,trackUndo:!0,undoLabel:"Change Song Tempo",onChange:function(e){ot.setBPM(e)}});u.addChild(_);var I=de.DiskOperations();I.setProperties({name:"diskoperations",zIndex:100}),u.addChild(I),de.diskOperations=I;var T=de.OptionsPanel();return T.setProperties({name:"options",zIndex:100}),u.addChild(T),u.onPanelResize=function(){var e=ct.defaultMargin,t=20+2*e,n=50+e+e,i=u.height-50-4*e,a=28,r=ct.col1W-2;if("col3"===ct.prefered){d||(f="patterndata",(d=de.radioGroup()).setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0,zIndex:1}),d.setItems([{label:"About",active:!1},{label:"Song data",labels:[{width:30,label:"song"}],active:!1},{label:"Pattern data",labels:[{width:40,label:"pattern"}],active:!0},{label:"Instruments",labels:[{width:30,label:"Instr"}],active:!1}]),d.onChange=function(e){f="about",1===e&&(f="songdata"),2===e&&(f="patterndata"),3===e&&(f="instruments"),u.onPanelResize()},u.addChild(d),u.sortZIndex()),i=u.height-2*e,n=e,r=ct.col32W-2,a=28,h?d.hide():d.show(),d.setDimensions({left:ct.col31X,width:ct.col31W,top:e,height:i,visible:!0}),m.setDimensions({left:ct.col32X,width:ct.col32W,top:e,height:20}),v.setDimensions({left:ct.col32X,width:ct.col32W,top:t,height:u.height-t-2*e});var o={left:ct.col32X,width:ct.col32W,top:n,height:i};b.setDimensions(o),w.setDimensions(o),x.setDimensions(o),g.setDimensions({left:ct.col32X,width:ct.col32W,top:n,height:Math.floor(i/2)}),p.setDimensions({left:ct.col32X,width:ct.col32W,top:Math.floor(i/2)+1,height:Math.floor(i/2)});var s=ct.col32X;_.setDimensions({left:s,top:w.top+3,width:r,height:a}),C.setDimensions({left:s,top:w.top+3+a,width:r,height:a}),S.setDimensions({left:s,top:w.top+3+2*a,width:r,height:a}),S.hide(),k.setDimensions({left:s,top:w.top+3+2*a,width:r,height:a}),y.setDimensions({left:s,top:w.top+3+3*a,width:r,height:a}),P.setDimensions({left:s,top:w.top+3+4*a,width:r,height:a}),h||(g.toggle("about"===f),p.toggle("about"===f),m.toggle("instruments"===f),v.toggle("instruments"===f),b.toggle("songdata"===f),w.toggle("patterndata"===f),_.toggle("patterndata"===f),C.toggle("patterndata"===f),k.toggle("patterndata"===f),y.toggle("patterndata"===f),P.toggle("patterndata"===f)),x.hide()}else d&&d.hide(),h||l(),g.setDimensions({left:ct.col1X,top:e,width:ct.col2W,height:50}),p.setDimensions({left:ct.col3X,top:e,width:ct.col1W,height:50}),m.setDimensions({left:ct.col4X,width:ct.col2W,top:e,height:20}),v.setDimensions({left:ct.col4X,width:ct.col2W,top:t,height:u.height-t-2*e}),b.setDimensions({left:ct.col1X,width:ct.col1W,top:n,height:i}),w.setDimensions({left:ct.col2X,width:ct.col1W,top:n,height:i}),x.setDimensions({left:ct.col3X,width:ct.col1W,top:n,height:i}),_.setDimensions({left:ct.col2X,top:w.top+3,width:r,height:a}),C.setDimensions({left:ct.col2X,top:w.top+3+a,width:r,height:a}),S.setDimensions({left:ct.col2X,top:w.top+3+2*a,width:r,height:a}),k.setDimensions({left:ct.col3X,top:w.top+3,width:r,height:a}),y.setDimensions({left:ct.col3X,top:w.top+3+a,width:r,height:a}),P.setDimensions({left:ct.col3X,top:w.top+3+2*a,width:r,height:a});I.setSize(u.width,u.height),T.setSize(u.width,u.height),c&&c.setSize(u.width,u.height)},u.onPanelResize(),u.getCurrentView=function(){return h},ye.on(ce.songLoading,function(){m.setValue("Loading ...",!0)}),ye.on(ce.songPropertyChange,function(e){m.setValue(e.title,!0),C.setValue(e.length,!0),P.setMax(ot.getMaxInstruments(),!0),S.setMax(e.length,!0),e.restartPosition&&e.length<e.restartPosition&&(e.restartPosition=e.length),S.setValue(e.restartPosition||1,!0)}),ye.on(ce.songBPMChange,function(e){_.setValue(e,!0)}),ye.on(ce.instrumentChange,function(e){v.setSelectedIndex(e-1),P.setValue(e,!0)}),ye.on(ce.instrumentNameChange,function(e){var t=ot.getInstrument(e);if(t)for(var n=v.getItems(),i=0,a=n.length;i<a;i++)if(n[i].data==e){n[i].label=e+" "+t.name,ye.trigger(ce.instrumentListChange,n);break}}),ye.on(ce.instrumentListChange,function(e){v.setItems(e)}),ye.on(ce.patternChange,function(e){k.setValue(e,!0),y.setValue(ot.getPatternLength(),!0)}),ye.on(ce.trackerModeChanged,function(e){y.setDisabled(e===Pe),P.setMax(ot.getMaxInstruments())}),ye.on(ce.pluginRenderHook,function(e){e.target&&"main"===e.target&&(c?c.children=[]:(c=de.panel(0,0,u.width,u.height),u.addChild(c)),c.renderOverride=e.render,c.renderInternal=e.renderInternal,e.setRenderTarget&&e.setRenderTarget(c),I.hide(),T.hide(),g.hide(),p.hide(),m.hide(),_.hide(),P.hide(),S.hide(),v.hide(),b.hide(),C.hide(),k.hide(),y.hide(),w.hide(),x.hide(),d&&d.hide(),h="custom",c.show(),u.refresh())}),ye.on(ce.showView,function(e){switch(e){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":c&&c.hide(),I.setView(e),I.show(),T.hide(),h=e,u.refresh();break;case"options":c&&c.hide(),I.hide(),T.show(!0),h=e,u.refresh();break;case"topmain":case"main":c&&c.hide(),I.hide(),T.hide(),h="",l(),u.refresh()}}),u},de.app_menu=function(e){function t(e){e.setState(!0),clearTimeout(e.timeout),e.timeout=setTimeout(function(){e.setState(!1)},100)}var i=de.app_panelContainer(32),a=de.scale9Panel(5,0,20,26,{img:lt.getImage("menu"),left:4,top:0,right:40,bottom:0});i.addChild(a);var n=de.menu(5,0,i.width,26,e);n.name="MainMenu",i.addChild(n),n.setItems([{label:"File",subItems:[{label:"New",command:z.newFile},{label:"Load Module",command:z.openFile},{label:"Save Module",command:z.saveFile},{label:"Open Random MOD Song",command:z.randomSong},{label:"Open Random XM Song",command:z.randomSongXM}]},{label:"Edit",subItems:[{label:function(){return _t.getUndoLabel()},command:z.undo,disabled:function(){return!_t.canUndo()}},{label:function(){return _t.getRedoLabel()},command:z.redo,disabled:function(){return!_t.canRedo()}},{label:"Cut",command:z.cut},{label:"Copy",command:z.copy},{label:"Clear",subItems:[{label:"Clear Track",command:z.clearTrack},{label:"Clear Pattern",command:z.clearPattern},{label:"Clear Song",command:z.clearSong},{label:"Clear Instruments",command:z.clearInstruments}]},{label:"Paste",command:z.paste},{label:"Render Pattern 2 Sample",command:z.pattern2Sample}]},{label:"View",subItems:[{label:"Main",command:z.showMain},{label:"Options",command:z.showOptions},{label:"File Operations",command:z.showFileOperations},{label:"Sample Editor",command:z.showSampleEditor},{label:"Piano",command:z.togglePiano},{label:"Nibbles",command:z.nibbles},{label:"Performance stats",command:z.showStats}]},{label:"Help",subItems:[{label:"About",command:z.showAbout},{label:"Documentation",command:z.showHelp},{label:"Sourcecode on Github",command:z.showGithub}]}]);var r=de.vumeter();r.connect(_e.cutOffVolume),window.vumeter=r;var o=de.label({font:fontSmall,label:"Key"});o.ignoreEvents=!0;var s=de.checkbox(0,0,13,13);s.ignoreEvents=!0;var l=de.label({font:fontSmall,label:"Midi"});l.ignoreEvents=!0;var d=de.checkbox(0,0,13,13);return d.ignoreEvents=!0,i.addChild(o),i.addChild(s),i.addChild(l),i.addChild(d),i.onPanelResize=function(){var e=Math.max(ct.col2W,250);Xe.showInternalMenu||(a.hide(),e=0);var t=ct.col5W-e;(Se.showKey||Se.showMidi)&&(t-=50);var n=ct.marginLeft+e+ct.defaultMargin+ct.mainLeft;i.left=ct.mainLeft,e&&a.setDimensions({left:ct.marginLeft,top:0,height:26,width:e}),r.setProperties({width:t,left:n}),o.setProperties({top:4,left:i.width-56,width:40,height:20}),s.setProperties({top:4,left:i.width-20}),Se.showKey?(o.show(),s.show()):(o.hide(),s.hide()),Se.showMidi?(l.setProperties({top:14,left:o.left,width:o.width,height:o.height}),d.setProperties({top:16,left:s.left}),l.show(),d.show()):(l.hide(),d.hide())},i.renderInternal=function(){Se.showMidi&&!Mt.isEnabled()&&(i.ctx.fillStyle="rgba(34, 49, 85, 0.5)",i.ctx.fillRect(l.left,d.top,50,d.height))},i.onPanelResize(),ye.on(ce.menuLayoutChanged,function(){i.onPanelResize()}),ye.on(ce.pianoNoteOn,function(){Se.showKey&&t(s)}),ye.on(ce.midiIn,function(){Se.showMidi&&t(d)}),i},de.app_panelContainer=function(e){var t=de.panel(0,0,Je.width,e,!0),n=de.scale9Panel(0,0,t.width,t.height,de.Assets.panelMainScale9);return n.ignoreEvents=!0,t.addChild(n),t.onResize=function(){n.setSize(t.width,t.height),t.onPanelResize&&t.onPanelResize()},t},de.app_patternPanel=function(){function i(){var e=p.getStartTrack(),t=Math.min(e+ct.visibleTracks,ot.getTrackCount()),n=!(ct.expandSampleViewHeight&&"sample"===d);for(a=0;a<l.length;a++)l[a].setProperties(e<=a&&a<t?{track:a,left:o+(ct.trackWidth+ct.trackMargin)*(a-e),top:ct.defaultMargin+ct.infoPanelHeight+ct.analyserHeight,width:ct.trackWidth,height:ct.trackControlHeight,visible:n}:{track:a,top:-100,visible:!1})}var a,r,o,s=de.app_panelContainer(80),l=[],d="main",c=de.editPanel();s.addChild(c);var u=de.InfoPanel();for(s.addChild(u),a=0;a<ot.getTrackCount();a++)l[a]=de.trackControl(),s.addChild(l[a]);var h=de.visualiser();h.connect(_e.cutOffVolume),h.name="mainAnalyser";var f=de.element();f.render=function(){},f.onClick=function(e){h.onClick(e)},s.addChild(f);var g=de.pattern_sidebar();s.addChild(g);var p=de.app_patternView();p.setProperties({name:"patternViewPanel"}),s.addChild(p);var m=de.SampleView();return m.setProperties({name:"sampleViewPanel"}),s.addChild(m),s.onPanelResize=function(){ct.showSideBar?"main"===d&&(g.show(),c.show()):(g.hide(),c.hide());var e=ct.infoPanelHeight+ct.trackControlHeight+ct.analyserHeight+2*ct.defaultMargin,t=s.height-e-ct.defaultMargin;ct.expandSampleViewHeight=t<280,ct.expandSampleViewHeight&&"sample"===d?(h.hide(),c.hide()):(h.show(),ct.showSideBar&&c.show());var n=ct.showSideBar?ct.col4W:ct.col5W;o=(r=ct.showSideBar?ct.col2X:ct.col1X)+ct.firstTrackOffsetLeft,c.setDimensions({left:ct.col1X,top:ct.defaultMargin,width:ct.col1W,height:ct.infoPanelHeight+ct.analyserHeight}),u.setDimensions({left:ct.showSideBar?ct.col2X:ct.col1X,top:0,width:ct.showSideBar?ct.col4W:ct.col5W,height:ct.infoPanelHeight}),p.setDimensions({left:r,top:e,width:n,height:t}),g.setDimensions({left:ct.col1X,top:p.top-ct.trackControlHeight,width:ct.col1W,height:t+ct.trackControlHeight}),h.setProperties({left:o+ct.mainLeft,top:s.top+ct.infoPanelHeight+3,width:n-ct.firstTrackOffsetLeft,height:ct.analyserHeight}),f.setDimensions({left:h.left-ct.mainLeft,top:ct.infoPanelHeight+3,width:h.width,height:h.height}),m.setProperties({left:0,top:ct.expandSampleViewHeight?ct.infoPanelHeight:e,width:s.width,height:ct.expandSampleViewHeight?s.height-ct.infoPanelHeight-ct.defaultMargin-3:t}),i()},s.onPanelResize(),ye.on(ce.patternChange,function(){p.refresh()}),ye.on(ce.patternPosChange,function(){p.refresh()}),ye.on(ce.cursorPositionChange,function(){p.refresh()}),ye.on(ce.recordingChange,function(){p.refresh()}),ye.on(ce.trackStateChange,function(e){if(void 0!==e.track)if(e.solo)for(a=0;a<ot.getTrackCount();a++)a!=e.track&&l[a].setProperties({mute:!0});else if(e.wasSolo)for(a=0;a<ot.getTrackCount();a++)a!=e.track&&l[a].setProperties({mute:!1})}),ye.on(ce.trackCountChange,function(e){for(s.visibleTracks=Math.min(4,e),a=l.length;a<e;a++)l[a]=de.trackControl(),l[a].setProperties({track:a,top:-200}),s.addChild(l[a]);i(),s.refresh()}),ye.on(ce.patternHorizontalScrollChange,function(){i()}),ye.on(ce.showView,function(e){switch(e){case"sample":m.show(),p.hide(),g.hide(),ct.expandSampleViewHeight&&(h.hide(),c.hide()),d=e,s.onPanelResize(),s.refresh();break;case"bottommain":case"main":m.hide(),p.show(),h.show(),ct.showSideBar&&(g.show(),c.show()),d="main",s.onPanelResize(),s.refresh()}}),ye.on(ce.visibleTracksCountChange,function(e){ct.showSideBar?"main"===d&&(g.show(),c.show()):(g.hide(),c.hide()),s.onResize()}),s},de.app_pianoView=function(){var l=de.app_panelContainer(200);l.name="pianoViewPanel";var n,d,c=[],u=[0,2,4,5,7,9,11],h=[-1,1,0,3,0,-1,0,6,0,8,0,10,0,-1],f=lt.getImage("pianokey_white"),g=lt.getImage("pianokey_white_down"),p=lt.getImage("pianokey_black"),m=lt.getImage("pianokey_black_down"),v=0,t=3,i=1,e=de.Assets.generate("button20_20");e.setLabel("x"),e.onClick=function(){Oe.doCommand(z.togglePiano)},l.addChild(e);var a=de.spinBox();a.setProperties({name:"Octave",label:"Octave",value:1,max:t,min:i,left:4,top:2,height:28,width:150,font:window.fontMed,onChange:function(e){ht.setCurrentOctave(e)}}),l.addChild(a),l.onShow=function(){l.onPanelResize()},l.onPanelResize=function(){l.innerHeight=l.height-2*ct.defaultMargin,e.setProperties({top:4,left:l.width-24})},l.onPanelResize(),ye.on(ce.pianoNoteOn,function(e){l.isVisible()&&(c[e]=!0,l.refresh())}),ye.on(ce.pianoNoteOff,function(e){l.isVisible()&&(c[e]=!1,l.refresh())});function r(e,t){var n=-1,i=e%420,a=Math.floor(e/420);if(0<=t)if(v+30<t){var r=Math.floor(i/60);n=u[r]+12*a}else{var o=Math.floor((i-15)/30);o<0&&(o=0),12<o&&(o=12),o%2==0?n=u[r=o/2]:(n=h[o])<0&&(r=Math.floor(i/60),n=u[r]),n+=12*a}return n+1}return l.onDown=function(e){var t=r(e.x,e.y);t&&t!==n&&(ht.handleNoteOn(t+12*d),n&&ht.handleNoteOff(n+12*d),n=t)},l.onTouchUp=function(e){var t=r(e.x,e.y);(t=t||n)&&(ht.handleNoteOff(t+12*d),n=void 0),n&&ht.handleNoteOff(n+12*d),n=void 0},l.onDrag=function(e){var t=r(e.x,e.y);t&&t!==n&&(ht.handleNoteOn(t+12*d),n&&ht.handleNoteOff(n+12*d),n=t)},l.renderInternal=function(e){if(l.isVisible()){if(e=!!e,this.needsRendering){for(var t=l.height-30,n=0,i=0;n<l.width;){var a=Math.floor(i/7),r=i%7,o=12*(d+a)+u[r]+1;l.ctx.drawImage(c[o]?g:f,n,30,64,t),i++,n+=60}v=Math.floor(t/1.7);var s=38;for(i=0;s<l.width;){if(a=Math.floor(i/7),2!==(r=i%7)&&6!==r)l.ctx.drawImage(c[o=12*(d+a)+h[2*r+1]+1]?m:p,s,30,48,v),0;i++,s+=60}}if(this.needsRendering=!1,e)return l.canvas;l.parentCtx.drawImage(l.canvas,l.left,l.top,l.width,l.height)}},ye.on(ce.octaveChanged,function(e){a.setValue(d=e,!0)}),ye.on(ce.trackerModeChanged,function(e){t=ot.inFTMode()?7:3,i=ot.inFTMode()?0:1,a.setMax(t,!0),a.setMin(i,!0)}),l},de.Assets=function(){var i={},a={};i.preLoad=function(e){function t(e){return e=r+e,o&&(e+="?v="+Oe.buildNumber),e}function n(){i&&a&&(i.forEach(function(e){e.img=a,lt.sprites[e.name]=lt.sprite(e)}),e&&e())}var i,a,r=Xe.getBaseUrl(),o=Xe.useUrlParams;He.json(t("skin/spritemap_v4.json"),function(e){i=e,n()}),lt.loadImage(t("skin/spritesheet_v4.png"),function(e){a=e,n()})},i.buttonLightScale9={left:2,top:2,right:4,bottom:4},i.buttonLightHoverScale9={left:2,top:2,right:4,bottom:4},i.buttonDarkScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkBlueScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkRedScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkRedHoverScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkGreenScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkActiveBlueScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkGreenHoverScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkGreenActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkRedActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkBlueActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkYellowActiveScale9={left:5,top:5,right:5,bottom:5},i.panelMainScale9={left:2,top:2,right:3,bottom:3},i.panelDarkScale9={left:3,top:3,right:3,bottom:2},i.panelDarkHoverScale9={left:3,top:3,right:3,bottom:2},i.panelDarkGreyScale9={left:3,top:3,right:3,bottom:2},i.panelDarkGreyBlueScale9={left:3,top:3,right:3,bottom:2},i.panelTransScale9={left:3,top:3,right:3,bottom:2},i.panelInsetScale9={left:2,top:2,right:2,bottom:2},i.panelDarkInsetScale9={left:2,top:2,right:2,bottom:2},i.buttonKeyScale9={left:5,top:5,right:5,bottom:5},i.buttonKeyHoverScale9={left:5,top:5,right:5,bottom:5},i.buttonKeyActiveScale9={left:5,top:5,right:5,bottom:5};var r={button20_20:{generate:function(e){var t,n=i.panelDarkScale9;if((t=de.button(0,0,20,20)).setProperties({background:n,hoverBackground:i.panelDarkHoverScale9,textAlign:"center",font:window.fontMed,paddingTop:2}),!e)return t;a.buttonUp20_20=t}},button30_30:{generate:function(e){var t;if(t=de.scale9Panel(0,0,30,30,i.buttonLightScale9),!e)return t;a.buttonUp30_30=t}},buttonLight:{generate:function(e){var t,n=i.buttonLightScale9;if((t=de.button()).setProperties({background:n,hoverBackground:i.buttonLightHoverScale9,textAlign:"center",font:window.fontMed}),!e)return t;a.buttonLight=t}},buttonDark:{generate:function(e){var t,n=i.buttonDarkScale9;if((t=de.button(0,0,20,20)).setProperties({background:n,hoverBackground:de.Assets.buttonDarkBlueActiveScale9,activeBackground:de.Assets.buttonDarkActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;a.buttonDark=t}},buttonDarkBlue:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonDarkBlueScale9,activeBackground:de.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;a.buttonDarkBlue=t}},buttonDarkRed:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonDarkRedScale9,hoverBackground:de.Assets.buttonDarkRedHoverScale9,activeBackground:de.Assets.buttonDarkRedActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;a.buttonDarkRed=t}},buttonDarkGreen:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonDarkGreenScale9,hoverBackground:de.Assets.buttonDarkGreenHoverScale9,activeBackground:de.Assets.buttonDarkGreenActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;a.buttonDarkGreen=t}},buttonKey:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonKeyScale9,hoverBackground:de.Assets.buttonKeyHoverScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark}),!e)return t;a.buttonKey=t}}};return i.init=function(){i.buttonLightScale9.img=lt.getImage("button_light"),i.buttonLightHoverScale9.img=lt.getImage("button_light_hover"),i.buttonDarkScale9.img=lt.getImage("button_inlay"),i.buttonDarkBlueScale9.img=lt.getImage("button_inlay_blue"),i.buttonDarkRedScale9.img=lt.getImage("button_inlay_red"),i.buttonDarkRedHoverScale9.img=lt.getImage("button_inlay_red_hover"),i.buttonDarkGreenScale9.img=lt.getImage("button_inlay_green"),i.buttonDarkGreenHoverScale9.img=lt.getImage("button_hover_green"),i.buttonDarkActiveScale9.img=lt.getImage("button_inlay_active"),i.buttonDarkGreenActiveScale9.img=lt.getImage("button_inlay_green_active"),i.buttonDarkRedActiveScale9.img=lt.getImage("button_inlay_red_active"),i.buttonDarkBlueActiveScale9.img=lt.getImage("button_inlay_blue_active"),i.buttonDarkYellowActiveScale9.img=lt.getImage("button_inlay_yellow_active"),i.panelMainScale9.img=lt.getImage("background"),i.panelDarkScale9.img=lt.getImage("bar"),i.panelDarkHoverScale9.img=lt.getImage("bar_hover"),i.panelDarkGreyScale9.img=lt.getImage("panel_dark_greyish"),i.panelDarkGreyBlueScale9.img=lt.getImage("panel_dark_blueish"),i.panelTransScale9.img=lt.getImage("panel_trans"),i.panelInsetScale9.img=lt.getImage("panel_inset"),i.panelDarkInsetScale9.img=lt.getImage("panel_dark"),i.buttonKeyScale9.img=lt.getImage("keybutton"),i.buttonKeyHoverScale9.img=lt.getImage("keybutton_hover"),i.buttonKeyActiveScale9.img=lt.getImage("keybutton_highlight3")},i.get=function(e){var t=a[e];if(t)return t;var n=r[e];n&&(n.isLoading||(n.isLoading=!0,n.generate(!0)))},i.put=function(e,t){a[e]=t},i.generate=function(e){return r[e]?r[e].generate():void 0},i}(),de.animsprite=function(e,t,n,i,a,r){var o=de.element(e,t,n=n||14,i=i||14,!0),s=["left","top","width","height","name"];o.setProperties=function(t){s.forEach(function(e){void 0!==t[e]&&(o[e]=t[e])}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top)};var l=lt.getImage(a),d=0;return o.onShow=function(){de.ticker.onEachTick2(function(){r<=++d&&(d=0),o.refresh()},0)},o.onHide=function(){de.ticker.onEachTick2()},o.render=function(e){if(e=!!e,this.needsRendering&&(o.clearCanvas(),o.ctx.drawImage(l,d*n,0,n,i,0,0,n,i)),this.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)},o};var ut=function(){var P,C,S,y,_={},I=[],T=!1;return _.generate=function(e){var t=e.image,n=e.startX,i=e.startY;P=e.charWidth;var a=e.charHeight;y=e.spaceWidth||8;var r=e.margin,o=e.lineSpacing||0,s=e.charsPerLine,l=e.chars||"ABCDEFGHIJKLMNOPQRSTUVWXYZ";T=e.onlyUpperCase,_.fontArray=[],_.colors={},S=r,C=a,_.fixedWidth=!0,_.charHeight=a,"number"!=typeof P&&(_.fixedWidth=!1,"string"==typeof P&&(P=P.split("")).forEach(function(e,t){P[t]=parseInt(e)})),_.charWidth=P;for(var d,c=n,u=i,h=0,f=0,g=0,p=l.length;g<=p;g++){var m=document.createElement("canvas"),v=(d=g,(_.fixedWidth?P:P[d])||1);m.width=v,m.height=a;var b=m.getContext("2d");if(_.fixedWidth)var w=n+g%s*(v+r),x=i+Math.floor(g/s)*(a+o);else w=c,x=u,c+=v+r,s[h]<=++f&&(h++,f=0,c=n,u+=C+o);b.drawImage(t,w,x,v,a,0,0,v,a);var k=l.charCodeAt(g);_.fontArray[k]=m,I[k]=v}},_.generateColor=function(e,o){e=e||"green",o=o||"rgba(107, 161, 65,0.9)";var s=[];_.fontArray.forEach(function(e,t){var n=document.createElement("canvas"),i=document.createElement("canvas");n.width=e.width,n.height=e.height,i.width=e.width,i.height=e.height;var a=n.getContext("2d"),r=i.getContext("2d");r.fillStyle=o,r.fillRect(0,0,16,16),r.globalCompositeOperation="destination-atop",r.drawImage(e,0,0),a.drawImage(i,0,0),a.globalCompositeOperation="darken",a.drawImage(e,0,0),s[t]=n}),_.colors[e]=s},_.getTextWidth=function(e,t){T&&(e=e.toUpperCase()),t=t||S;for(var n=0,i=0,a=e.length;i<a;i++){var r=e.charCodeAt(i);n+=(I[r]||y)+t}return n},_.write=function(e,t,n,i,a,r){T&&(t=t.toUpperCase());var o=_.colors[r]||_.fontArray;a=a||S,i=i||0;for(var s=n=n||0,l=0,d=t.length;l<d;l++){var c=t.charCodeAt(l),u=o[c],h=I[c];h=h||y,u&&e.drawImage(u,s,i,h,C),s+=h+a}},_};de.button=function(e,t,n,i,a){var s=de.element(e,t,n,i);s.type="button";var l,d,c,u,h,f,g,p,m=a||"",v="left",b=0,w=0,x=10,r=!(s.isActive=!1),o=["left","top","width","height","name","type","image","backgroundImage","background","active","hoverBackground","hoverImage","activeBackground","activeImage","font","label","textAlign","paddingTop","paddingTopActive","paddingLeft","checkbox","radio"];return s.setProperties=function(t){o.forEach(function(e){if(void 0!==t[e])switch(e){case"label":m=t[e];break;case"font":p=t[e];break;case"textAlign":v=t[e];break;case"paddingTop":b=parseInt(t[e]);break;case"paddingTopActive":w=parseInt(t[e]);break;case"paddingLeft":x=parseInt(t[e]);break;case"image":l=t[e];break;case"backgroundImage":d=t[e];break;case"activeImage":f=t[e];break;case"hoverImage":g=t[e],r=!0;break;case"background":t[e].img&&(d=void 0,(c=de.scale9Panel(0,0,0,0,t[e])).setParent(s));break;case"activeBackground":t[e].img&&(u=de.scale9Panel(0,0,0,0,t[e])).setParent(s);break;case"hoverBackground":t[e].img&&(h=de.scale9Panel(0,0,0,0,t[e])).setParent(s),r=!0;break;default:s[e]=t[e]}}),c&&c.setSize(s.width,s.height),u&&u.setSize(s.width,s.height),h&&h.setSize(s.width,s.height),s.setSize(s.width,s.height),s.setPosition(s.left,s.top),t.labels&&(s.onResize=function(){var e=m;t.labels.forEach(function(e){e.width<=s.width&&(m=e.label)}),e!==m&&s.refresh()})},s.setBackgroundImage=function(e){d=e,s.refresh()},s.setFont=function(e){p=e,s.refresh()},s.setLabel=function(e){m=e,s.refresh()},s.toggleActive=function(){s.isActive=!s.isActive,s.refresh()},s.setActive=function(e){void 0===e&&(e=!0),s.isActive=!!e,s.refresh()},s.setDisabled=function(e){void 0===e&&(e=!0),(s.isDisabled=e)&&(s.isActive=!1),s.refresh()},s.onHover=function(e){r&&(s.isActive||(s.isHover=!0,s.refresh()))},s.onHoverExit=function(){r&&s.isHover&&(s.isHover=!1,s.refresh())},s.render=function(e){if(s.isVisible()){if(s.needsRendering){e=!!e;if(d)s.ctx.drawImage(d,0,0,s.width,s.height);else if(c)if(s.isActive&&u){if(u.render(),f){var t=Math.floor((s.height-f.height)/2),n=Math.floor((s.width-f.width)/2);s.ctx.drawImage(f,n,t)}}else{var i=l;if(s.isHover&&g&&(i=g),s.isHover&&h?h.render():c.render(),i){t=Math.floor((s.height-i.height)/2),n=Math.floor((s.width-i.width)/2);s.ctx.drawImage(i,n,t)}}else s.ctx.fillStyle="grey",s.ctx.fillRect(0,0,s.width,s.height),s.ctx.fillStyle="black",s.ctx.rect(0,0,s.width,s.height),s.ctx.stroke();if(m){var a=Math.floor((s.height-10)/2)+(s.isActive?w:b),r=x;if(p){if("center"===v){var o=8*m.length;p.fixedWidth||(o=p.getTextWidth(m,0)),r=Math.floor((s.width-o)/2)}"right"===v&&(o=8*m.length,p.fixedWidth||(o=p.getTextWidth(m,0)),r=s.width-o-5),p.write(s.ctx,m,r,a,0)}else s.ctx.fillStyle="white",s.ctx.fillText(m,r,a)}s.isDisabled&&(s.ctx.fillStyle="rgba(34, 49, 85, 0.6)",s.ctx.fillRect(0,0,s.width,s.height)),s.renderInternal&&s.renderInternal()}if(s.needsRendering=!1,e)return s.canvas;s.parentCtx.drawImage(s.canvas,s.left,s.top,s.width,s.height)}},s},de.checkbox=function(e,t,n,i){var a=de.element(e,t,n=n||14,i=i||14,!0),r=["left","top","width","height","name","type","checked"];return a.setProperties=function(t){r.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top)},a.setState=function(e,t){a.checked=e,a.refresh(),a.onToggle&&!t&&a.onToggle(a.checked)},a.onClick=function(e){a.setState(!a.checked)},a.check=function(){a.setState(!0)},a.unCheck=function(){a.setState(!1)},a.toggle=function(){a.setState(!a.checked)},a.render=function(e){if(e=!!e,a.isVisible()){if(this.needsRendering){a.clearCanvas();var t=lt.getImage(a.checked?"checkbox_on":"checkbox_off");a.ctx.drawImage(t,0,0)}if(this.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}},a},de.checkboxbutton=function(e){var n=de.button(0,0,20,20);return n.setProperties({background:(e=e||{}).background||de.Assets.buttonDarkBlueScale9,hoverBackground:e.hoverBackground||de.Assets.buttonDarkBlueActiveScale9,activeBackground:e.activeBackground||de.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"left",paddingLeft:30,font:e.font||window.fontFT,label:e.label||"",labels:e.labels||void 0,checkbox:e.checkbox||!1}),n.renderInternal=function(){if(n.checkbox)var e=lt.getImage(n.isActive?"checkbox_on":"checkbox_off"),t=7;else e=lt.getImage(n.isActive?"radio_active":"radio_inactive"),t=5;n.ctx.drawImage(e,8,Math.floor(n.height/2)-t)},n.onDown=function(){n.toggleActive(),e.onDown&&e.onDown.bind(n).call()},n},de.element=function(e,t,n,i){var o={};return o.left=e||0,o.top=t||0,o.width=n||20,o.height=i||20,o.visible=!0,o.needsRendering=!0,o.parentCtx=Qe,o.canvas=document.createElement("canvas"),o.canvas.width=n,o.canvas.height=i,o.ctx=o.canvas.getContext("2d"),o.children=[],o.hide=function(){o.visible=!1,o.onHide&&o.onHide()},o.show=function(e,t){o.visible=!0,e&&o.refresh(t),o.onShow&&o.onShow()},o.toggle=function(e){"boolean"==typeof e?e?o.show():o.hide():o.visible?o.hide():o.show()},o.isVisible=function(){for(var e=o.visible,t=o.parent;e&&t;)e=t.visible,t=t.parent;return e},o.containsPoint=function(e,t){return this.left<=e&&e<=this.left+this.width&&this.top<=t&&t<=this.top+this.height},o.getElementAtPoint=function(e,t){var n;e-=o.left+(o.scrollOffsetX||0),t-=o.top+(o.scrollOffsetY||0),o.scaleX&&(e/=o.scaleX),o.scaleY&&(t/=o.scaleY);for(var i=o.children.length-1;0<=i;i--){var a=o.children[i];if(a.isVisible()&&!a.ignoreEvents&&a.containsPoint(e,t)){n=a;break}}if(n){var r=n.getElementAtPoint(e,t);r?n=r:(n.eventX=e,n.eventY=t)}else(n=o).eventX=e,n.eventY=t;return n},o.setParent=function(e){(o.parent=e)&&(o.parentCtx=e.ctx)},o.addChild=function(e){e.setParent(o),e.zIndex=e.zIndex||o.children.length,o.children.push(e)},o.getChild=function(e){for(var t,n=o.children.length;n;){if((t=o.children[n])&&t.name&&t.name==e)return t;n--}},o.refresh=function(e){if(o.needsRendering=!0,e)for(var t,n=o.children.length;n;)(t=o.children[n])&&t.refresh(),n--;this.visible&&o.parent&&o.parent.refresh&&o.parent.refresh()},o.setSize=function(e,t){o.width=Math.max(e,1),o.height=Math.max(t,1),o.canvas.width=o.width,o.canvas.height=o.height,o.onResize&&o.onResize(),o.refresh()},o.setPosition=function(e,t){o.left=e,o.top=t,o.refresh()},o.setDimensions=function(e){"boolean"==typeof e.visible&&!e.visible||(o.setProperties?o.setProperties(e):(o.setPosition(e.left,e.top),o.setSize(e.width,e.height)))},o.clearCanvas=function(){o.ctx.clearRect(0,0,o.width,o.height)},o},de.image=function(e,t,n,i,a){var r=de.element(e,t,n=n||14,i=i||14,!0),o=["left","top","width","height","name"];r.setProperties=function(t){o.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top)};var s=lt.getImage(a);return r.render=function(e){if(e=!!e,r.isVisible()){if(this.needsRendering&&(r.clearCanvas(),s))switch(r.scale){case"stretch":r.ctx.drawImage(s,0,0,r.width,r.height);break;default:var t=r.width-s.width>>1,n=r.height-s.height>>1;"top"===r.verticalAlign&&(n=0),"right"===r.horizintalAlign&&(t=r.width-s.width),r.ctx.drawImage(s,t,n)}if(this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},r},de.inputbox=function(e){var t,n,a,r=de.element(),i=["left","top","width","height","name","type","onChange","onSubmit","backgroundImage","trackUndo","undoLabel","undoInstrument"],o="",s="",l="panel_dark";r.setProperties=function(t){i.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),d&&d.setSize(r.width,r.height),t.value&&(o=t.value),t.backgroundImage&&(l=t.backgroundImage)},e&&r.setProperties(e);var d=de.scale9Panel(0,0,r.width,r.height,{img:lt.getImage(l),left:3,top:3,right:2,bottom:2});d.ignoreEvents=!0,r.addChild(d),r.render=function(e){if(e=!!e,r.isVisible()){if(this.needsRendering){d.render();var t=0;if(o&&fontMed){t=10;fontMed.write(r.ctx,o,t,6,0)}if(n){r.ctx.fillStyle="rgba(255,255,255,0.7)";r.ctx.fillRect(t+9*a+8,4,2,r.height-8)}}if(this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},r.setValue=function(e,t){if(e!==o&&(s=o),o=e,r.refresh(),!t&&r.onChange){if(r.trackUndo){var n=_t.createValueUndo(r);n.name=r.undoLabel||"Change "+r.name,r.undoInstrument&&(n.instrument=ot.getCurrentInstrumentIndex(),n.id+=n.instrument),_t.registerEdit(n)}r.onChange(o)}},r.getValue=function(){return o},r.getPrevValue=function(){return s},r.getItemAtPosition=function(e,t){t-=startY;var n=Math.floor(t/lineHeight)+visibleIndex;return 0<=n&&n<items.length?items[n]:void 0},r.onClick=function(){t||r.activate()},r.activate=function(){t||(a=o?o.length-1:-1,t=!0,ht.setFocusElement(r),c())},r.deActivate=function(e){t&&(t=n=!1,r.refresh(),ht.clearFocusElement(),e&&r.onSubmit&&r.onSubmit(o))},r.onKeyDown=function(e,t){var n=!1;switch(e){case 8:o&&0<=a&&(r.setValue(o.substr(0,a)+o.substr(a+1)),a--),n=!0;break;case 9:case 13:case 27:r.deActivate(13===e),n=!0;break;case 37:0<=a&&a--,r.refresh(),n=!0;break;case 39:o&&(a++,a=Math.min(a,o.length-1),r.refresh()),n=!0;break;case 46:o&&a<o.length-1&&r.setValue(o.substr(0,a+1)+o.substr(a+2)),n=!0;break;case 89:case 90:if(ht.isMetaKeyDown())return void r.deActivate()}if(!n&&31<e){var i=t.key;1===i.length&&i.match(/[a-z0-9\._:\-\ #]/i)&&(r.setValue(o.substr(0,a+1)+i+o.substr(a+1)),a++),n=!0}return n};var c=function(){t&&(n=!n,r.refresh(),setTimeout(c,300))};return r},de.knob=function(e){var l=de.element();l.type="knob";var d="",c=50,t=c,n=["left","top","width","height","name","font","label","textAlign","paddingTop","disabled"],u=lt.getImage("knob_back"),h=lt.getImage("knob_back_inactive"),f=lt.getImage("knob_front");return l.width=u.width+32,l.height=u.height+32,l.setSize(l.width,l.height),l.setProperties=function(t){n.forEach(function(e){if(void 0!==t[e])switch(e){case"label":d=t[e];break;case"font":0;break;case"textAlign":0;break;case"paddingTop":parseInt(t[e]);break;case"disabled":l.isDisabled=!!t[e];default:l[e]=t[e]}}),l.setSize(l.width,l.height),l.setPosition(l.left,l.top)},l.setFont=function(e){l.refresh()},l.setLabel=function(e){d=e,l.refresh()},l.getLabel=function(){return d},l.setValue=function(e){l.refresh()},l.getValue=function(){return c},l.render=function(e){if(l.needsRendering){e=!!e,l.clearCanvas();var t=.8*u.width,n=.8*u.height,i=t/2,a=n/2;l.ctx.save(),l.ctx.translate(16+i,16+a),l.ctx.drawImage(l.isDisabled?h:u,-i,-a,t,n);var r=Math.abs(-230)+50,o=-230*Math.PI/180,s=(c/100*r-230)*Math.PI/180;if(l.ctx.fillStyle=l.isDisabled?"rgba(170,170,170,0.5)":"rgba(130,200,255,0.5)",l.ctx.beginPath(),l.ctx.arc(0,0,30,o,s,!1),l.ctx.arc(0,0,25,s,o,!0),l.ctx.fill(),l.ctx.rotate((c/100*320-160)*Math.PI/180),l.ctx.drawImage(f,-i,-a,t,n),l.ctx.restore(),d){fontSmall.write(l.ctx,d,16+i-3*d.length,16+n+4)}}if(l.needsRendering=!1,e)return l.canvas;l.parentCtx.drawImage(l.canvas,l.left,l.top,l.width,l.height)},l.onDragStart=function(){t=c},l.onDrag=function(e){l.isDisabled||(c=t+e.deltaY,c=Math.max(c,0),c=Math.min(c,100),l.refresh(),l.onChange&&l.onChange(c))},l.onClick=function(e){Math.abs(e.x-e.startX)<3&&Math.abs(e.y-e.startY)<3&&l.toggleDisabled()},l.toggleDisabled=function(){l.isDisabled=!l.isDisabled,l.onToggle&&l.onToggle(!l.isDisabled),l.refresh()},l},de.label=function(e){var a,r=de.element(),o="",s="left",l=0,n=["left","top","width","height","name","font",r.type="label","textAlign","paddingTop"];return r.setProperties=function(t){n.forEach(function(e){if(void 0!==t[e])switch(e){case"label":o=t[e];break;case"font":a=t[e];break;case"textAlign":s=t[e];break;case"paddingTop":l=parseInt(t[e]);break;default:r[e]=t[e]}}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),t.labels&&(r.onResize=function(){var e=o;t.labels.forEach(function(e){e.width<=r.width&&(o=e.label)}),e!==o&&r.refresh()})},r.setFont=function(e){a=e,r.refresh()},r.getFont=function(){return a},r.setLabel=function(e){o=e,r.refresh()},r.render=function(e){if(r.isVisible()){if(r.needsRendering&&(e=!!e,r.clearCanvas(),o)){var t,n=Math.floor((r.height-10)/2)+l,i=10;if(a)"center"==s&&(t=a.getTextWidth(o,0),i=Math.floor((r.width-t)/2)),"right"==s&&(t=a.getTextWidth(o,0),i=Math.floor(r.width-t)-10),a.write(r.ctx,o,i,n,0);else r.ctx.fillStyle="white",r.ctx.fillText(o,i,n)}if(r.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},e&&r.setProperties(e),r},de.listbox=function(e,t,n,i){function a(){var e=w.length;l=Math.floor(m.height/18),m.centerSelection&&(l=1);var t=18,n=m.height-4-32,i=n;d=0,l<e&&((i=Math.floor(l/e*n))<12&&(i=12),d=(n-i)/(e-l)),x&&d&&(t=Math.floor(18+d*x)),y.setProperties({left:m.width-18,top:t,width:16,height:i})}function r(){var e=w.length-1;return m.centerSelection||(e=w.length-l),e<0&&(e=0),e}var p,o,m=de.element(e,t,n,i,!0),s=m.selectedIndex=0,v=window.fontMed,b=window.fontSmall,w=[],x=0,l=0,k=10,d=0,c=["left","top","width","height","name","type","onChange","selectedIndex","centerSelection"];m.setProperties=function(t){c.forEach(function(e){void 0!==t[e]&&(m[e]=t[e])}),void 0!==t.font&&(v=t.font),m.setSize(m.width,m.height),m.setPosition(m.left,m.top),P.setSize(m.width,m.height),a(),C.setProperties({left:m.width-18,top:2,width:16,height:16,label:"↑"}),S.setProperties({left:m.width-18,top:m.height-19,width:16,height:16,label:"↓"}),m.centerSelection&&(k=Math.ceil((m.height-18)/2))},m.setSelectedIndex=function(e,t){m.selectedIndex=e,m.centerSelection&&(x=m.selectedIndex),a(),m.refresh(),!t&&m.onChange&&s!=m.selectedIndex&&m.onChange(),s=m.selectedIndex},m.getSelectedIndex=function(){return m.selectedIndex};var P=de.scale9Panel(0,0,m.width,m.height,{img:lt.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});P.ignoreEvents=!0,m.addChild(P);var C=de.Assets.generate("button20_20");m.addChild(C),C.onClick=function(){m.navigateUp()};var S=de.Assets.generate("button20_20");m.addChild(S),S.onClick=function(){m.navigateDown()};var y=de.scale9Panel(n-28,18,16,i-3,{img:lt.getImage("bar"),left:2,top:2,right:3,bottom:3});return y.onDragStart=function(){y.startDragIndex=x},y.onDrag=function(e){l<w.length&&d&&(x=Math.floor(y.startDragIndex+e.deltaY/d),x=Math.min(x,r()),x=Math.max(x,0),m.centerSelection?m.setSelectedIndex(x):a())},m.addChild(y),m.navigateUp=function(){0<x&&(x--,a()),m.centerSelection?m.setSelectedIndex(x):m.refresh()},m.navigateDown=function(){x<r()&&(x++,a()),m.centerSelection?m.setSelectedIndex(x):m.refresh()},m.render=function(e){if(e=!!e,m.isVisible()){if(this.needsRendering){P.render();for(var t=lt.getImage("line_hor"),n=0,i=w.length;n<i;n++){var a=w[n],r=10,o=6,s=k+18*(n-x);if(0<s&&s<m.height){var l,d=m.ctx,c=s,u=m.height-18<=s;if(u){var h=m.height-s+1;1<h?((l=document.createElement("canvas")).width=m.width-2,l.height=h,d=l.getContext("2d"),c=4,o=6):d=void 0}if(d){p+x===n&&(d.fillStyle="rgba(110,130,220,0.07)",d.fillRect(0,c-o,m.width-2,18)),m.selectedIndex===n&&(d.fillStyle="rgba(110,130,220,0.15)",d.fillRect(0,c-o,m.width-2,18)),a.level&&(r+=10*a.level),a.icon&&(d.drawImage(a.icon,r,c-2),r+=a.icon.width+4);var f=a.label;if(v){if(a.info){var g=6*a.info.length+20;b.write(d,a.info,m.width-g,c,0),f=f.substr(0,Math.floor((m.width-g-r-26)/v.charWidth))}v.write(d,f,r,c,0)}s+=11,c+=11,t&&d.drawImage(t,0,c,m.width-2,2),u&&m.ctx.drawImage(l,0,s-11-4)}}}y.render(),C.render(),S.render()}if(this.needsRendering=!1,e)return m.canvas;m.parentCtx.drawImage(m.canvas,m.left,m.top,m.width,m.height)}},m.setItems=function(e){w=e,x=Math.min(x,r()),a(),m.refresh()},m.getItems=function(){return w},m.getItemAtPosition=function(e,t){t-=k;var n=Math.floor(t/18)+x;return 0<=n&&n<w.length?w[n]:void 0},m.insertItemAfterIndex=function(e,t,n){},m.onMouseWheel=function(e){0<e.mouseWheels[0]?m.navigateUp():m.navigateDown()},m.onDragStart=function(e){m.startDragIndex=x},m.onDrag=function(e){if(l<w.length){var t=Math.round(e.deltaY/18);x=m.startDragIndex-t,x=Math.max(x,0),x=Math.min(x,r()),m.centerSelection?m.setSelectedIndex(x):a()}},m.onHover=function(e){var t=Math.floor((m.eventY-k)/18);t!==o&&(o=p=t,m.refresh())},m.onHoverExit=function(){p&&(o=p=void 0,m.refresh())},m},de.menu=function(e,t,n,i,s){function a(e){if(l&&l.length)for(var t=0,n=l.length;t<n;t++){var i=l[t];if(i.startX-12<=e&&e<=i.startX+i.width+12)return t}return-1}var l,d=de.element(e,t,n,i);d.keepSelection=!0;var r,o,c,u,h=["left","top","width","height","name","type","background","layout"],f=[];return d.setProperties=function(t){h.forEach(function(e){void 0!==t[e]&&(d[e]=t[e])}),t.background&&((r=de.scale9Panel(0,0,d.width,d.height,t.background)).ignoreEvents=!0,d.addChild(r)),d.setSize(d.width,d.height),d.setPosition(d.left,d.top)},d.onClick=function(e){var n=a(e.x);if(l.forEach(function(e,t){t!==n&&e.subMenu&&e.subMenu.hide()}),!(n<0)){var t=l[n];if(o=void 0,ht.setFocusElement(d),t.subMenu)t.subMenu.setPosition((t.startX||0)+(e.globalX-e.x),d.height),t.subMenu.toggle(),t.subMenu.parent.refresh(),t.subMenu.isVisible()&&(o=n);t.command&&ye.trigger(ce.command,t.command)}},d.onHover=function(e){var t=a(d.eventX);t!==u&&(u=c=t,d.refresh()),t<0||0<=o&&o!==t&&d.activateSubmenu(t)},d.onHoverExit=function(){c&&(u=c=void 0,d.refresh())},d.onKeyDown=function(e){var t;switch(e){case 13:if(a=d.getActiveSubItem())if(a.item.subMenu&&a.item.subMenu.isVisible()&&0<=a.item.subMenu.getSelectedIndex()){var n=a.item.subMenu.getSelectedIndex(),i=a.item.subMenu.getItems()[n];i&&a.item.subMenu.executeItem(i)}else a.menu.executeItem(a.item);t=!0;break;case 27:d.deActivate(),t=!0;break;case 37:if(0<=o)(a=d.getActiveSubItem())&&a.item.subMenu&&a.item.subMenu.isVisible()?a.menu.deActivateSubmenu():d.activateSubmenu(Math.max(o-1,0));t=!0;break;case 39:if(0<=o)(a=d.getActiveSubItem())&&a.item.subMenu&&!a.item.subMenu.isVisible()?a.menu.activateSubmenu(a.item):d.activateSubmenu(Math.min(o+1,l.length-1));t=!0;break;case 38:if(0<=o)if((a=d.getActiveSubItem())&&a.item.subMenu&&a.item.subMenu.isVisible())a.item.subMenu.setSelectedIndex(a.item.subMenu.getSelectedIndex()-1);else(r=l[o])&&r.subMenu&&r.subMenu.setSelectedIndex(r.subMenu.getSelectedIndex()-1);t=!0;break;case 40:var a,r;if(0<=o)if((a=d.getActiveSubItem())&&a.item.subMenu&&a.item.subMenu.isVisible())a.item.subMenu.setSelectedIndex(a.item.subMenu.getSelectedIndex()+1);else(r=l[o])&&r.subMenu&&r.subMenu.setSelectedIndex(r.subMenu.getSelectedIndex()+1);t=!0}return t},d.deActivate=function(e){if(0<=o){var t=l[o];t&&t.subMenu&&(e&&"submenu"===e.type&&e.mainMenu&&e.mainMenu.name===d.name||(t.subMenu.hide(),o=void 0,d.refresh(),ht.clearFocusElement()))}},d.activateSubmenu=function(e){if(e!==o){o=e,l.forEach(function(e,t){t!==o&&e.subMenu&&e.subMenu.hide()});var t=l[e];if(t&&t.subMenu)o=e,t.subMenu.setPosition((t.startX||0)+d.left,d.height),t.subMenu.toggle(),t.subMenu.parent.refresh()}},d.getActiveSubItem=function(){if(0<=o){var e=l[o];if(e&&e.subMenu){var t=e.subMenu.getSelectedIndex();if(0<=t)return{menu:e.subMenu,item:e.subMenu.getItems()[t]}}}},d.render=function(e){if(d.isVisible()){if(e=!!e,this.needsRendering){var i=10;d.clearCanvas(),r&&r.render(),f.length?f.forEach(function(e){e.render()}):l&&l.forEach(function(e,t){var n=9*e.label.length;e.startX=i,e.width=n,t===c&&(d.ctx.fillStyle="rgba(179,195,243,0.1)",d.ctx.fillRect(i-12,0,20+n,30)),fontMed.write(d.ctx,e.label,i,10),i+=24+n})}if(this.needsRendering=!1,e)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top,d.width,d.height)}},d.setItems=function(e){l=e,s=s||d.parent;var a={background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!(f=[]),textAlign:"center",font:window.fontDark,paddingTopActive:1},r=3,o=3;l.forEach(function(e,t){if("buttons"===d.layout){var n=de.button(r,o,60,18);r+=60,1===t&&(r=3,o+=18),n.setProperties(a),n.setLabel(e.label),e.onClick&&(n.onClick=function(){e.onClick()}),f.push(n),d.addChild(n)}if(e.subItems){var i=de.submenu();i.setProperties({background:de.Assets.buttonLightScale9}),i.hide(),i.setItems(e.subItems),i.zIndex=200,s.addChild(i),i.mainMenu=d,e.subMenu=i}}),d.zIndex=9,d.refresh()},d.getItems=function(){return l},d},de.modalDialog=function(e){var r,o=de.element(),n="",i=["left","top","width","height","name","ok","cancel","input"];o.setProperties=function(t){i.forEach(function(e){void 0!==t[e]&&(o[e]=t[e])}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top);var e=200;o.height<e&&(e=o.height-20);var n=Math.max(Math.floor(o.width/2),380);s.setSize(n,e),s.setPosition(Math.floor((o.width-n)/2),Math.floor((o.height-e)/2)),o.cancel?(l.setPosition(s.left+Math.floor(s.width/2)-110,s.top+s.height-40),d.setPosition(s.left+Math.floor(s.width/2)+10,s.top+s.height-40)):l.setPosition(s.left+Math.floor(s.width/2)-50,s.top+s.height-40),o.input&&(r||(r=de.inputbox({name:"dialoginput",width:200,height:28,value:"",onChange:function(){o.inputValue=r.getValue()},onSubmit:function(e){o.inputValue=e,o.onKeyDown(13)}}),o.addChild(r),setTimeout(function(){r.activate()},0)),r.setProperties({left:s.left+50,top:s.top+s.height-80,width:s.width-100,height:28}))};var s=de.scale9Panel(0,0,Math.floor(o.width/2),200,de.Assets.panelMainScale9);s.ignoreEvents=!0,o.addChild(s);var l=de.Assets.generate("buttonLight");l.setProperties({name:"okbutton",label:"OK",width:100,height:28}),o.addChild(l);var d=de.Assets.generate("buttonLight");return d.setProperties({name:"cancelbutton",label:"Cancel",width:100,height:28}),o.addChild(d),o.onKeyDown=function(e){switch(e){case 13:return o.close(),!0}},o.render=function(e){if(e=!!e,this.needsRendering){if(o.clearCanvas(),o.ctx.fillStyle="rgba(0,0,0,0.6)",o.ctx.fillRect(0,0,o.width,o.height),s.render(),n){var t=n.split("/"),i=s.top+20,a=s.width-20;t.forEach(function(e){var t=10;if(fontFT){var n=fontFT.getTextWidth(e,0);t=s.left+10+Math.floor((a-n)/2),fontFT.write(o.ctx,e,t,i,0)}i+=12})}o.ok&&l.render(),o.cancel&&d.render(),r&&r.render()}if(this.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)},o.setText=function(e){n=e},o.getText=function(){return n},o.close=function(){o.hide(),o.onClose&&o.onClose(),de.removeModalElement(),delete o},o},de.numberDisplay=function(e){function t(t){k.forEach(function(e){if(void 0!==t[e])switch(e){case"value":u=t[e];break;case"onChange":r=t[e];break;case"min":n=t[e];break;case"max":f=t[e];break;case"step":g=t[e];break;case"size":v=t[e];break;case"autoPadding":b=!!t[e];break;default:s[e]=t[e]}}),c="big"===v?window.fontLedBig:window.fontLed,x=w[v]}function o(){for(var e=""+u;e.length<s.padLength;)e=p+e;return e}function i(e){m=e;var t=o().length,n=t-(""+u).length;t<m&&(m=t),m<n&&(m=n),s.refresh()}function a(e){var t=o().split("");t.splice(m+e,1);var n=parseInt(t.join("").trim());isNaN(n)&&(n=0),s.updateValue(n)}var s=de.element();s.type="numberDisplay",s.isActive=!1,s.isDisabled=!1;var l,d,r,c,u=0,h=0,n=0,f=100,g=1,p=" ",m=0,v="medium",b=!(s.padLength=4),w={small:{x:4,y:3,c:0},medium:{x:6,y:7,c:0},big:{x:7,y:4,c:-2}},x=w.medium,k=["left","top","width","height","name","value","onChange","min","max","step","padLength","size","autoPadding","trackUndo","undoLabel","undoInstrument"];e&&t(e),s.setProperties=function(e){t(e),s.setSize(s.width,s.height),s.setPosition(s.left,s.top),9999<f&&s.padLength<5&&(s.padLength=5)},s.setValue=function(e,t){if(e!==u&&(h=u),u=e,s.refresh(),!t&&r){if(s.trackUndo){var n=_t.createValueUndo(s);n.name=s.undoLabel||"Change "+s.name,s.undoInstrument&&(n.instrument=ot.getCurrentInstrumentIndex(),n.id+=n.instrument),_t.registerEdit(n)}r(u)}},s.updateValue=function(e){f<e&&(e=f),e<n&&(e=n),s.setValue(e)},s.getValue=function(){return u},s.getPrevValue=function(){return h},s.setDisabled=function(e){void 0===e&&(e=!0),(s.isDisabled=e)&&(s.isActive=!1),s.refresh()},s.setFocus=function(e){(l=!!e)?(ht.setFocusElement(s),m=o().length,P()):ht.clearFocusElement(),s.refresh()},s.togglFocus=function(){s.setFocus(!l)},s.setMax=function(e,t){f=e,!t&&f<u&&s.setValue(f)},s.setMin=function(e){u<(n=e)&&s.setValue(n)},s.onClick=function(){s.isDisabled||r&&s.togglFocus()},s.onMouseWheel=function(e){s.isDisabled||r&&s.updateValue(0<e.mouseWheels[0]?u+g:u-g)},s.onKeyDown=function(e,t){var n=t.key;switch(t.keyCode){case 8:a(-1);break;case 9:case 13:case 27:ht.clearFocusElement();break;case 37:i(m-1);break;case 38:s.updateValue(u+1);break;case 39:i(m+1);break;case 40:s.updateValue(u-1);break;case 46:a(0)}switch(n){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":!function(e){var t=o().split("");t.splice(m,0,e);var n=parseInt(t.join("").trim());isNaN(n)&&(n=0),s.updateValue(n)}(n)}return!0},s.onResize=function(){b&&(s.padLength=Math.floor(s.width/8)-1)},s.activate=function(){l=!0,m=o().length,d=!0,P()},s.deActivate=function(){l&&(d=l=!1,s.refresh(),ht.clearFocusElement())},s.render=function(e){if(s.isVisible()){var t=l?"panel_inset_dark_active":"panel_inset_dark_inactive";if(s.needsRendering){e=!!e,s.ctx.clearRect(0,0,s.width,s.height);var n=s.paddingLeft||0,i=s.paddingTop||0,a=s.width-n-(s.paddingRight||0),r=s.height-i-(s.paddingBottom||0);if(s.ctx.drawImage(lt.getImage(t),n,i,a,r),c)if(n+=x.x,i=x.y,c.write(s.ctx,o(),n,i,0),d)s.ctx.fillStyle="rgba(255,201,65,0.7)",s.ctx.fillRect(n+m*c.charWidth+x.c,i,2,c.charHeight);s.renderInternal&&s.renderInternal(),s.isDisabled&&(s.ctx.fillStyle="rgba(34, 49, 85, 0.6)",s.ctx.fillRect(0,0,s.width,s.height))}if(s.needsRendering=!1,e)return s.canvas;s.parentCtx.drawImage(s.canvas,s.left,s.top,s.width,s.height)}};var P=function(){l?(d=!d,setTimeout(P,300)):d=!1,s.refresh()};return s},de.panel=function(e,t,n,i){var a=de.element(e,t,n,i);a.type="panel";var r=["left","top","width","height","name","type","zIndex","backgroundColor","borderColor"];return a.setProperties=function(t){r.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top),a.setLayout&&a.setLayout(a.left,a.top,a.width,a.height)},a.render=function(e){if(a.isVisible()){if(e=!!e,this.needsRendering&&(a.renderOverride?a.renderOverride():(a.clearCanvas(),a.backgroundColor&&(a.ctx.fillStyle=a.backgroundColor,a.ctx.fillRect(0,0,a.width,a.height)),a.borderColor&&(a.ctx.fillStyle=a.borderColor,a.ctx.rect(0,0,a.width,a.height),a.ctx.stroke()),this.children.forEach(function(e){e.render()}),a.renderInternal&&a.renderInternal())),this.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}},a.onClick=function(){},a.sortZIndex=function(){this.children.sort(function(e,t){return e.zIndex==t.zIndex?0:t.zIndex<e.zIndex||-1})},a},de.radioGroup=function(e,t,n,i){var a,p,m,v=de.element(e,t,n,i,!0),b=[],w="small",x="right",k=-3,P=13,r=["left","top","width","height","name"];return v.setProperties=function(t){r.forEach(function(e){void 0!==t[e]&&(v[e]=t[e])}),v.setSize(v.width,v.height),v.setPosition(v.left,v.top),t.align&&(x=t.align),t.size&&(w=t.size),t.divider&&(p=t.divider),t.type&&0,t.highLightSelection&&(m=!0)},v.onClick=function(e){v.setSelectedIndex(Math.floor((+v.eventY+k)/P))},v.setSelectedIndex=function(e,t){e=Math.min(e,b.length-1);for(var n=0,i=b.length;n<i;n++)b[n].active=n==e;v.selectedIndex=e,v.refresh(),!t&&v.onChange&&a!=v.selectedIndex&&v.onChange(v.selectedIndex),a=v.selectedIndex},v.getSelectedIndex=function(){return v.selectedIndex},v.getSelectedItem=function(){return b[v.selectedIndex]},v.render=function(e){if(e=!!e,v.isVisible()){if(this.needsRendering){v.clearCanvas();var t=lt.getImage("radio_active"),n=lt.getImage("radio_inactive");P=Math.floor(v.height/b.length);var i=fontSmall,a=5,r=v.width-15;k=-3,"med"===w&&(t=lt.getImage("radio_big_active"),n=lt.getImage("radio_big_inactive"),k=-2,r=v.width-20,i=fontMed);var o=Math.floor((P-i.charHeight)/2);"left"===x&&(a=30,r=5);for(var s=lt.getImage("line_hor"),l=0,d=b.length;l<d;l++){var c=b[l],u=0+l*P,h=u+o;if("line"==p&&0<l&&v.ctx.drawImage(s,0,u,v.width,2),i){var f=c.label;if("right"===x&&(a=r-i.getTextWidth(c.label,0)-4)<0&&c.labels){var g=r-4;c.labels.forEach(function(e){e.width<=g&&(f=e.label)}),a=r-i.getTextWidth(f,0)-4}i.write(v.ctx,f,a,h,0)}c.active?(m&&(v.ctx.fillStyle="rgba(100,100,255,0.1",v.ctx.fillRect(0,u,v.width-2,P)),v.ctx.drawImage(t,r,h+k)):v.ctx.drawImage(n,r,h+k)}}if(this.needsRendering=!1,e)return v.canvas;v.parentCtx.drawImage(v.canvas,v.left,v.top,v.width,v.height)}},v.setItems=function(e){v.selectedIndex=void 0;for(var t=0,n=(b=e).length;t<n;t++)b[t].active&&(v.selectedIndex=t);v.refresh()},v.getItemAtPosition=function(e,t){t=+t;var n=Math.floor(t/P)+visibleIndex;return 0<=n&&n<b.length?(b[n].index=n,b[n]):void 0},v},de.rangeSlider=function(e){var r=de.element();r.type="rangeslider";var n=["left","top","width","height","name","onChange"],o=lt.getImage("slider_knob"),i=lt.getImage("slider_knob_vert"),t=lt.getImage("slider_back"),a=lt.getImage("slider_back_vert"),s=!1,l=0,d=de.scale9Panel(0,0,0,0,{img:t,left:4,right:4,top:0,bottom:0,scale:"repeatX"});r.addChild(d),d.ignoreEvents=!0;var c=0,u=0,h=0,f=0,g=0,p=100,m=0;return r.setProperties=function(t){n.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),void 0!==t.min&&(g=t.min),void 0!==t.max&&(p=t.max),void 0!==t.value&&r.setValue(t.value,!0),void 0!==t.vertical&&(s=!!t.vertical,d.setProperties({img:a,imgLeft:0,imgRight:0,imgTop:4,imgBottom:4,scale:"repeatY"}))},r.getValue=function(){return m},r.setValue=function(e,t){p<e&&(e=p),e<g&&(e=g);var n=!t&&m!==e;(m=e,s)?u=l*(1-(e-g)/(p-g)):c=(r.width-o.width)*e/p;r.refresh(),n&&!t&&r.onChange&&r.onChange(m)},r.setMax=function(e,t){p=e,!t&&p<m&&r.setValue(p)},r.setMin=function(e,t){g=e,!t&&m<g&&r.setValue(g)},r.render=function(e){if(r.needsRendering){e=!!e,r.clearCanvas();var t=Math.floor(r.width/2)+3,n=r.height;g<0&&(n=Math.floor(n/2)),r.ctx.fillStyle="rgba(255,255,255,0.1",r.ctx.beginPath(),r.ctx.moveTo(t,n),r.ctx.lineTo(t,2),r.ctx.lineTo(t+6,2),r.ctx.fill(),g<0?(r.ctx.beginPath(),r.ctx.moveTo(t-6,n),r.ctx.lineTo(t-6,r.height),r.ctx.lineTo(t-6-6,r.height)):(r.ctx.beginPath(),r.ctx.moveTo(t-6,n),r.ctx.lineTo(t-6,2),r.ctx.lineTo(t-6-6,2)),r.ctx.fill(),d.render(),s?r.ctx.drawImage(i,-1,u,i.width,i.height):r.ctx.drawImage(o,c,-1,o.width,o.height)}if(r.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)},r.onResize=function(){l=r.height-i.height+3,d.setSize(r.width,r.height),r.setValue(m,!0)},r.onDragStart=function(){h=c,f=u},r.onDrag=function(e){if(s){var t=e.deltaY;if((u=f+t)<0&&(u=0),l<u&&(u=l),o.height<l){var n=p-g,i=n-Math.round(n*u/l);m=i+g}else m=p}else{(c=h+(t=e.deltaX))<0&&(c=0);var a=r.width-o.width;a<c&&(c=a),m=o.width<a?Math.round(p*c/a):0}r.refresh(),r.onChange&&r.onChange(m)},e&&r.setProperties(e),r},de.scale9Panel=function(e,t,n,i,c){var u=de.element(e,t,n,i,!0);u.type="scale9",c.scale=c.scale||"stretch",u.setProperties=function(t){var e=["left","top","width","height","name","type"];if(!t){var n={};return e.forEach(function(e){n[e]=u[e]}),n}e.forEach(function(e){void 0!==t[e]&&(u[e]=t[e])}),void 0!==t.img&&(c.img=t.img),void 0!==t.scale&&(c.scale=t.scale),void 0!==t.imgTop&&(c.top=t.imgTop),void 0!==t.imgBottom&&(c.bottom=t.imgBottom),void 0!==t.imgLeft&&(c.left=t.imgLeft),void 0!==t.imgRight&&(c.right=t.imgRight),u.setSize(u.width,u.height),u.setPosition(u.left,u.top)};return u.render=function(e){if(e=!!e,u.isVisible()){if(u.needsRendering&&function(){var e=c.img;if(e){var t=e.width-c.left-c.right,n=e.height-c.top-c.bottom,i=u.width-c.left-c.right,a=u.height-c.top-c.bottom;if(u.clearCanvas(),c.top&&c.left&&u.ctx.drawImage(e,0,0,c.left,c.top,0,0,c.left,c.top),c.top&&u.ctx.drawImage(e,c.left,0,t,c.top,c.left,0,i,c.top),c.top&&c.right&&u.ctx.drawImage(e,c.left+t,0,c.right,c.top,c.left+i,0,c.right,c.top),c.left&&u.ctx.drawImage(e,0,c.top,c.left,n,0,c.top,c.left,a),"stretch"===c.scale&&u.ctx.drawImage(e,c.left,c.top,t,n,c.left,c.top,i,a),"repeatX"===c.scale)for(var r,o=c.left,s=c.left+i;o<s;)s<o+(r=t)&&(r=s-o),u.ctx.drawImage(e,c.left,c.top,r,n,o,c.top,r,n),o+=r;if("repeatY"===c.scale){var l,d=c.top;for(s=c.top+a;d<s;)s<d+(l=n)&&(l=s-d),u.ctx.drawImage(e,c.left,c.top,t,l,c.left,d,t,l),d+=l}c.right&&u.ctx.drawImage(e,c.left+t,c.top,c.right,n,c.left+i,c.top,c.right,a),c.bottom&&c.left&&u.ctx.drawImage(e,0,c.top+n,c.left,c.bottom,0,c.top+a,c.left,c.bottom),c.bottom&&u.ctx.drawImage(e,c.left,c.top+n,t,c.bottom,c.left,c.top+a,i,c.bottom),c.bottom&&c.right&&u.ctx.drawImage(e,c.left+t,c.top+n,c.right,c.bottom,c.left+i,c.top+a,c.right,c.bottom)}}(),u.needsRendering=!1,e)return u.canvas;u.parentCtx.drawImage(u.canvas,u.left,u.top)}},u},de.submenu=function(e,t,n,i){function l(e){return"function"==typeof e.disabled?e.disabled():!!e.disabled}function d(e){return"function"==typeof e.label?e.label():e.label}var c,u=de.element(e,t,n,i);u.type="submenu";var h,f,a,r,o=["left","top","width","height","name","type"];return u.setProperties=function(t){o.forEach(function(e){void 0!==t[e]&&(u[e]=t[e])}),t.background&&((h=de.scale9Panel(0,0,u.width,u.height,t.background)).ignoreEvents=!0,u.addChild(h)),u.setSize(u.width,u.height),u.setPosition(u.left,u.top)},u.onHover=function(e){var t=Math.floor(u.eventY/26);t!==a&&u.setSelectedIndex(t)},u.onHoverExit=function(){f&&(a=f=void 0,u.refresh())},u.onShow=function(){a=f=0},u.onHide=function(){r&&(r.subMenu.hide(),r=void 0)},u.setSelectedIndex=function(e){(f=Math.min(e,c.length-1))<0&&(f=0);var t=c[a=f];t.subItems?u.activateSubmenu(t):r&&(r.subMenu.hide(),r=void 0),u.refresh()},u.getSelectedIndex=function(){return void 0!==f?f:-1},u.onClick=function(e){if(c&&c.length){var t=c[Math.floor(u.eventY/26)];u.executeItem(t)}},u.executeItem=function(e){l(e)||e&&(e.command?(u.hide(),u.parent.refresh(),u.mainMenu&&u.mainMenu.deActivate(),ye.trigger(ce.command,e.command)):e.subItems&&u.toggleSubmenu(e))},u.activateSubmenu=function(e){if(!e.subMenu){var t=de.submenu();t.setProperties({background:de.Assets.buttonLightScale9}),t.hide(),t.setItems(e.subItems),t.zIndex=300,u.parent.addChild(t),t.mainMenu=u.mainMenu,e.subMenu=t}var n=u.left+u.width-20;de.mainPanel.width<n+e.subMenu.width&&(n=de.mainPanel.width-e.subMenu.width),e.subMenu.setPosition(n,u.top+26*e.index),e.subMenu.show(),r=e,u.refresh()},u.deActivateSubmenu=function(){r&&(r.subMenu.hide(),r=void 0,u.refresh())},u.toggleSubmenu=function(e){e.subMenu&&e.subMenu.isVisible()?u.deActivateSubmenu():u.activateSubmenu(e)},u.render=function(e){if(u.isVisible()){if(e=!!e,this.needsRendering){u.clearCanvas(),h&&h.render();for(var t=lt.getImage("line_hor"),n=0,i=u.width-3,a=c.length-1,r=0;r<=a;r++){var o=c[r],s=l(o);r!==f||s||(u.ctx.fillStyle="rgba(255,255,255,0.2)",u.ctx.fillRect(0,n,i,26)),o.label&&fontFT.write(u.ctx,d(o),9,n+9),o.subItems&&fontMed.write(u.ctx,">",u.width-16,n+9+2),s&&(u.ctx.fillStyle="rgba(88,105,129,0.6)",u.ctx.fillRect(0,n,i,26)),n+=26,r<a&&u.ctx.drawImage(t,0,n,i,2)}}if(this.needsRendering=!1,e)return u.canvas;u.parentCtx.drawImage(u.canvas,u.left,u.top,u.width,u.height)}},u.setItems=function(e){var i=50;(c=e).forEach(function(e,t){var n=e.label?9*d(e).length:0;n+=24,i=Math.max(i,n),e.index=t}),u.setSize(i,26*c.length+4),h&&h.setSize(u.width,u.height),r=a=f=void 0,u.refresh()},u.getItems=function(){return c},u},de.DiskOperationActions=function(){var n=de.panel(),i=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);i.ignoreEvents=!0,n.addChild(i);var a=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);a.ignoreEvents=!0,n.addChild(a);var r=de.label({label:"Action",font:fontSmall});n.addChild(r);var o=de.radioGroup();return o.setProperties({align:"right",size:"med",divider:"line",type:"buttons",highLightSelection:!0}),o.setItems([{label:"load",active:!0},{label:"save",active:!1}]),o.onChange=function(e){ye.trigger(ce.diskOperationActionChange,this.getSelectedItem())},n.addChild(o),n.setLayout=function(){var e=n.width-2,t=70;n.height<100&&(t=n.height-20),de.mainPanel&&(n.clearCanvas(),i.setProperties({left:0,top:0,height:n.height,width:n.width}),a.setProperties({left:1,top:1,height:16,width:e}),r.setProperties({left:-1,top:3,height:16,width:e}),o.setProperties({left:4,width:e-4,height:t,top:18}))},n.getAction=function(){var e="load";return 1==o.getSelectedIndex()&&(e="save"),e},n.setSelectedIndex=function(e){o.setSelectedIndex(e)},n},de.DiskOperationSave=function(){function n(){var e=r,t=r.lastIndexOf("."),n="";0<=t&&(e=r.substr(0,t),n=r.substr(t));var i=u.getSelectedItem();i&&i.extention&&(n=i.extention),".mod"===n&&ot.inFTMode()&&(n=".xm"),f.setValue(e+n)}var r,t=de.panel(),o=I,s=I,l=g,d="local",a=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);a.ignoreEvents=!0,t.addChild(a);var c={};c[I]=[{label:"module",active:!0,extention:".mod",fileType:I},{label:"wav",active:!1,extention:".wav",fileType:A,fileFormat:p.WAVE_PCM},{label:"mp3",active:!1,extention:".mp3",fileType:A,fileFormat:p.MP3}],c[A]=[{label:"wav 16 bit",active:!1,extention:".wav",fileType:A,fileFormat:p.RIFF_16BIT},{label:"wav 8 bit",active:!0,extention:".wav",fileType:A,fileFormat:p.RIFF_8BIT},{label:"RAW 8 bit",active:!1,extention:".sample",fileType:A,fileFormat:p.RAW_8BIT}];var u=de.radioGroup();u.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),u.setItems(c[I]),u.onChange=function(e){var t=this.getSelectedItem();o=t&&t.fileType?t.fileType:I,l=t&&t.fileFormat?t.fileFormat:g,n()},t.addChild(u);var h=de.button();h.setProperties({label:"Export",textAlign:"center",background:de.Assets.buttonLightScale9,font:window.fontMed}),h.onClick=function(){if(s==I&&(o==I&&Ne.save(r,d),o==A&&Xt.renderFile(r,l===p.MP3)),s==A){var e=ot.getCurrentInstrument().sample;if(e){if(l===p.RAW_8BIT){var t,n=new D(new ArrayBuffer(e.length),!0);for(n.clear(2),i=0;i<e.length-2;i++)t=e.data[i]||0,n.writeByte(Math.round(127*t))}else n=function(e,t){var n=e.length,i=8e3;16===t&&(n=2*e.length,i=16e3);var a=n;a%2==1&&a++;var r=new D(new ArrayBuffer(46+a),!1);if(r.goto(0),r.writeString("RIFF"),r.writeDWord(38+a),r.writeString("WAVE"),r.writeString("fmt "),r.writeDWord(18),r.writeWord(1),r.writeWord(1),r.writeDWord(8e3),r.writeDWord(i),r.writeWord(Math.floor(t/8)),r.writeWord(t),r.writeWord(0),r.writeString("data"),r.writeDWord(n),16===t)for(var o=0;o<e.length;o++)r.writeWord(32767*e[o]);else for(o=0;o<e.length;o++)r.writeUByte(Math.round(127*e[o])+127);return n<a&&r.writeUByte(0),r}(e.data,l===p.RIFF_16BIT?16:8);var a=new Blob([n.buffer],{type:"application/octet-stream"});"dropbox"===d?Qt.putFile("/"+r,a):Ie(a,r)}}},t.addChild(h);var f=de.inputbox({name:"fileNameInput",height:20,onChange:function(e){r=e},backgroundImage:"panel_mid"});return t.addChild(f),t.setLayout=function(){var e=t.width-2;de.mainPanel&&(t.clearCanvas(),a.setProperties({left:0,top:0,height:t.height,width:t.width}),f.setProperties({left:4,width:e-6,top:4}),h.setProperties({left:2,width:e,height:28,top:t.height-27}),u.setProperties({left:4,width:e-4,height:t.height-h.height-30,top:30}))},ye.on(ce.songPropertyChange,function(e){r=e.filename||"",n()}),ye.on(ce.diskOperationTargetChange,function(e){(d=e).target&&(d=d.target),e&&e.fileType&&((s=e.fileType)==A&&(r=ot.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")),s==I&&(r=ot.getFileName()),c[s]&&(u.setItems(c[s]),u.onChange()))}),ye.on(ce.instrumentChange,function(e){t.isVisible()&&s==A&&(r=ot.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")||"Sample-"+ot.getCurrentInstrumentIndex(),n())}),ye.on(ce.trackerModeChanged,function(e){t.isVisible()&&s==I&&(r=ot.getSong().filename||"",n())}),t},de.DiskOperationTargets=function(){function e(e,t){var n=e.findIndex(function(e){return e.target===t});0<=n&&e.splice(n,1)}var t=de.panel(),n=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);n.ignoreEvents=!0,t.addChild(n);var i=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);i.ignoreEvents=!0,t.addChild(i);var a=de.label({label:"From",font:fontSmall});t.addChild(a);var r=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Modarchive:",target:"modarchive"},{label:"Modules.pl:",target:"modulespl"},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],o=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],s=[{label:"local:",target:"local",active:!0},{label:"Dropbox:",target:"dropbox"}];Xe.useDropbox||(e(r,"dropbox"),e(o,"dropbox"),e(s,"dropbox"));var l=r,d="load",c=de.radioGroup();return c.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),c.setItems(r),c.onChange=function(e){ye.trigger(ce.diskOperationTargetChange,this.getSelectedItem())},t.addChild(c),t.setLayout=function(){var e=t.width-3;if(de.mainPanel){t.clearCanvas(),n.setProperties({left:0,top:0,height:t.height,width:t.width}),i.setProperties({left:2,top:1,height:16,width:e}),a.setProperties({left:-1,top:3,height:16,width:e});c.setProperties({width:e,height:t.height-18-2,left:2,top:18})}},t.getTarget=function(){return"bassoon"},ye.on(ce.diskOperationTargetChange,function(e){e&&e.fileType&&("save"===d?c.setItems(s):(e.fileType===I&&(l=r),e.fileType===A&&(l=o),c.setItems(l)),c.setSelectedIndex(0))}),ye.on(ce.diskOperationActionChange,function(e){"save"===e.label?(a.setLabel("To"),d="save",c.setItems(s)):(a.setLabel("From"),d="load",c.setItems(l)),ye.trigger(ce.diskOperationTargetChange,c.getSelectedItem())}),ye.on(ce.dropboxConnectCancel,function(){c.setSelectedIndex(0)}),t},de.DiskOperationType=function(){var n=de.panel(),i=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);i.ignoreEvents=!0,n.addChild(i);var a=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);a.ignoreEvents=!0,n.addChild(a);var r=de.label({label:"Type",font:fontSmall});n.addChild(r);var o=de.radioGroup();return o.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),o.setItems([{label:"module",active:!0,fileType:I},{label:"sample",active:!1,fileType:A}]),o.onChange=function(e){ye.trigger(ce.diskOperationTargetChange,this.getSelectedItem())},n.addChild(o),n.setLayout=function(){var e=n.width-2,t=70;n.height<100&&(t=n.height-20),de.mainPanel&&(n.clearCanvas(),i.setProperties({left:0,top:0,height:n.height,width:n.width}),a.setProperties({left:1,top:1,height:16,width:e}),r.setProperties({left:-1,top:3,height:16,width:e}),o.setProperties({left:4,width:e-4,height:t,top:18}))},n.getType=function(){var e=o.getSelectedIndex(),t="modules";return 1==e&&(t="samples"),2==e&&(t="patterns"),t},n.setType=function(e){o.setSelectedIndex(e)},n},de.DiskOperations=function(){function i(t,e){y.setSelectedIndex(e),m=e,t.isExpanded?(t.isExpanded=!1,o.refreshList()):(t.isExpanded=!0,t.children.length?o.refreshList():(t.children=[{title:"loading ..."}],o.refreshList(),n?n.get(t.url,function(e){v(t,e)}):He.json(t.url,function(e){v(t,e)})))}var o=de.panel();o.hide();var n,s="load",l="modules",d=[],c=[],u=[],h=[],f=[],g=[],p=0,m=0,v=function(){},e=de.scale9Panel(0,0,20,20,de.Assets.panelMainScale9);e.ignoreEvents=!0,o.addChild(e);var a=de.DiskOperationActions();o.addChild(a);var b=de.DiskOperationType();o.addChild(b);var r=de.DiskOperationTargets();o.addChild(r);var t=de.DiskOperationSave();o.addChild(t);var w={background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1,height:18,width:50},x=de.button(),k=de.button();k.setActive(!0),x.setProperties(w),x.setLabel("Save"),x.onDown=function(){a.setSelectedIndex(1)},o.addChild(x),k.setProperties(w),k.setLabel("Load"),k.onDown=function(){a.setSelectedIndex(0)},o.addChild(k);var P=de.label({label:"Load module",font:fontMed});o.addChild(P);var C=de.Assets.generate("button20_20");C.setLabel("x"),C.onClick=function(){Oe.doCommand(z.showTopMain)},o.addChild(C);var S=de.Assets.generate("buttonKey");S.setLabel("browse"),S.onClick=function(){var e=document.createElement("input");e.type="file",e.onchange=function(e){ot.handleUpload(e.target.files)},e.click()},o.addChild(S),S.hide();var y=de.listbox();o.addChild(y);var _=de.button();return _.setProperties({background:de.Assets.buttonDarkActiveScale9,image:lt.getImage("dropzone"),font:fontSmall,textAlign:"center"}),_.onClick=S.onClick,o.addChild(_),_.hide(),o.onShow=function(){o.onResize()},o.onResize=function(){if(o.isVisible()){o.clearCanvas(),e.setProperties({left:0,top:0,height:o.height,width:o.width});C.setProperties({top:3,width:20,heigth:18,left:o.width-30}),S.setProperties({top:C.top+2,width:55,height:18,left:C.left-60}),730<=o.width?(a.show(),P.show(),k.hide(),x.hide(),a.setProperties({top:5,left:ct.col1X,width:ct.col1W,height:o.height-10}),b.setProperties({top:5,left:ct.col2X,width:ct.col1W,height:o.height-10}),r.setProperties({top:5,left:ct.col3X,width:ct.col1W,height:o.height-10}),P.setProperties({left:ct.col4X,top:5,height:20,width:ct.col2W}),y.setProperties({left:ct.col4X,width:ct.col2W,top:24,height:o.height-24-5})):(a.hide(),P.hide(),k.show(),x.show(),k.setProperties({top:5,left:ct.col3X}),x.setProperties({top:5,left:ct.col3X+50}),b.setProperties({top:5,left:ct.defaultMargin,width:ct.col2W,height:o.height/2-5-16}),r.setProperties({top:o.height/2-16,left:ct.defaultMargin,width:ct.col2W,height:o.height/2+16}),y.setProperties({left:ct.col3X,width:ct.col3W,top:24,height:o.height-24-5})),"save"===s?(t.setProperties({left:y.left,width:y.width,top:y.top,height:y.height}),y.hide(),t.show()):(y.show(),t.hide()),_.setProperties({left:y.left,width:y.width,top:y.top,height:y.height})}},o.setView=function(e){o.refreshList("samples"===e?"samples":""),0<e.indexOf("_save")&&a.setSelectedIndex(1),0<e.indexOf("_load")&&a.setSelectedIndex(0),0<e.indexOf("_samples")&&b.setType(1),0<e.indexOf("_modules")&&b.setType(0)},o.refreshList=function(e){function t(e,t){d=[],r=0,t=t||0,function n(e,i){e.forEach(function(e){var t;e.icon&&(t=lt.getImage(e.icon)),t=t||lt.getImage("modules"===l?"module":"sample"),e.children&&(t=lt.getImage("disk")),a.push({label:e.title,data:e,level:i,index:r,icon:t,info:e.info}),d[r]=e,r++,e.children&&e.children.length&&e.isExpanded&&n(e.children,i+1)})}(e,0),y.setItems(a),y.setSelectedIndex(t)}if("save"!==s){var a=[],r=0;switch(l!==e&&y.setSelectedIndex(0,!0),"local"==(l=e||l)?(y.hide(),_.show(),S.show()):(y.show(),_.hide(),S.hide(),"bassoon"==l&&(l=b.getType())),l){case"modules":n=!1,P.setLabel("Load Module"),y.onClick=function(e){var t=y.getItemAtPosition(y.eventX,y.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?i(t,n):(y.setSelectedIndex(n),ot.load(t.url),Oe.doCommand(z.showTopMain))}},c.length?t(c,m):He.json(Xe.getBaseUrl()+"data/modules.json",function(e){e&&e.modules&&t(c=e.modules,m)});break;case"modarchive":n=$t,P.setLabel("Browse Modarchive"),y.onClick=function(e){var t=y.getItemAtPosition(y.eventX,y.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?i(t,n):(y.setSelectedIndex(n),ot.load(t.url),Oe.doCommand(z.showTopMain))}},v=function(t,e){e&&e.length?"... load more ..."==t.title&&t.parent?(t=t.parent,e.forEach(function(e){e.parent=t}),t.children.pop(),t.children=t.children.concat(e)):(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},h.length?t(h,0):(y.setItems([{label:"loading ..."}]),He.json(Xe.getBaseUrl()+"data/modarchive.json",function(e){e&&e.modarchive&&t(h=e.modarchive,0)}));break;case"modulespl":n=en,P.setLabel("Browse Modules.pl"),y.onClick=function(e){var t=y.getItemAtPosition(y.eventX,y.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?i(t,n):(y.setSelectedIndex(n),ot.load(t.url),Oe.doCommand(z.showTopMain))}},v=function(t,e){e&&e.length?"... load more ..."==t.title&&t.parent?(t=t.parent,e.forEach(function(e){e.parent=t}),t.children.pop(),t.children=t.children.concat(e)):(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},f.length?t(f,0):(y.setItems([{label:"loading ..."}]),He.json(Xe.getBaseUrl()+"data/modulespl.json",function(e){e&&e.modulespl&&t(f=e.modulespl,0)}));break;case"dropbox":n=Qt,P.setLabel("Browse Your Dropbox"),de.setStatus("Contacting Dropbox",!0),y.setItems([{label:"loading ..."}]),y.onClick=function(e){var n=y.getItemAtPosition(y.eventX,y.eventY);if(n&&n.data){var t=n.index;(n=d[t]).children?i(n,t):(y.setSelectedIndex(t),de.setInfo(n.title),de.setStatus("Loading from Dropbox",!0),Qt.getFile(n,function(e){var t=new FileReader;t.onload=function(){ot.processFile(t.result,n.title,function(e){de.setStatus("Ready")})},t.readAsArrayBuffer(e)}))}},v=function(t,e){e&&e.length?(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},g.length?t(g,0):Qt.checkConnected(function(e){e?Qt.list("",function(e){de.setStatus(""),t(g=e,0)}):Qt.showConnectDialog()});break;case"samples":n=!1,P.setLabel("Load Sample to slot "+ot.getCurrentInstrumentIndex()),y.onClick=function(e){var t=y.getItemAtPosition(y.eventX,y.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?(y.setSelectedIndex(n),p=n,t.isExpanded?(t.isExpanded=!1,o.refreshList()):(t.isExpanded=!0,t.children.length?o.refreshList():He.json(t.url,function(e){e&&e.samples&&(t.children=e.samples,o.refreshList())}))):(y.setSelectedIndex(n),ot.load(t.url))}},v=function(e,t){t&&t.samples&&(e.children=t.samples,o.refreshList())},u.length?t(u,p):He.json(Xe.getBaseUrl()+"data/samples.json",function(e){e&&e.samples&&t(u=e.samples,p)});break;case"local":n=!1,P.setLabel("Upload files")}}},o.playRandomSong=function(e){de.setStatus("Fetching random song",!0),de.setInfo(""),He.json("https://www.stef.be/bassoontracker/api/random"+(e||""),function(e){e&&e.modarchive&&e.modarchive.module&&ot.load(e.modarchive.module.url)})},ye.on(ce.diskOperationTargetChange,function(e){var t=a.getAction();if(e&&e.target&&(e=e.target),e&&e.fileType&&(e.fileType===I&&(e="modules"),e.fileType===A&&(e="samples")),void 0===e&&(e=r.getTarget()),"save"===t){s="save";var n="Export Module";"samples"===(l=b.getType())&&(n="Export Sample"),P.setLabel(n),k.isActive&&k.setActive(!1),x.isActive||x.setActive(!0),_.hide(),S.hide(),o.onResize(),"dropbox"===e&&Qt.checkConnected(function(e){e||Qt.showConnectDialog()})}else s="load",o.refreshList(e),k.isActive||k.setActive(!0),x.isActive&&x.setActive(!1)}),ye.on(ce.instrumentChange,function(e){o.isVisible()&&"samples"==l&&P.setLabel("Load Sample to slot "+ot.getCurrentInstrumentIndex())}),o},de.editPanel=function(e,t,n,i,a){var r=de.element(e,t,n,i,a);r.type="EditPanel";var o=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);r.addChild(o);function s(e){switch(e.index){case 0:Ne.clearTrack(),de.setStatus("Track cleared");break;case 1:Ne.clearPattern(),de.setStatus("Pattern cleared");break;case 2:Ne.copyTrack(),de.setStatus("Track copied");break;case 3:Ne.copyPattern(),de.setStatus("Pattern copied");break;case 4:de.setStatus(Ne.pasteTrack()?"Track pasted":"Nothing to paste!");break;case 5:de.setStatus(Ne.pastePattern()?"Pattern pasted":"Nothing to paste!")}}for(var l=["clear","copy","paste"],d=[],c=0;c<6;c++){var u;(u=de.Assets.generate("buttonDark")).index=c,u.onClick=function(){s(this)},u.setProperties({label:"  "+l[Math.floor(c/2)],font:fontSmall,textAlign:"center",paddingTop:3}),r.addChild(u),d.push(u)}var h=["left","top","width","height","name","type"];return r.setProperties=function(t){h.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),o.setSize(r.width,r.height);for(var e=Math.floor(r.width/2)-2,n=0;n<6;n++){var i=n%2,a=Math.floor(n/2);d[n].setProperties({left:i*e+2,width:e,top:25+21*a,height:21})}},r.render=function(e){if(e=!!e,r.needsRendering){if(!r.isVisible())return;r.clearCanvas(),o.render(),window.fontMed.write(r.ctx,"↓Track",6,11,0),window.fontMed.write(r.ctx,"↓Pattern",d[1].left+6,11,0);for(var t=0;t<6;t++)d[t].render()}if(r.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)},r},de.Envelope=function(e){var f=de.element();f.type=e;var g,o,i,s,p=de.scale9Panel(0,0,f.width,f.height,{img:lt.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});p.ignoreEvents=!0;var l,d,c,m=-1;return f.onResize=function(){d=f.width/324,c=f.height/64},f.onHover=function(e){if(!o&&(m=-1,s=void 0,g&&g.enabled)){for(var t=Math.round(f.eventX/d),n=Math.round((f.height-f.eventY)/c),i=0,a=g.count;i<a;i++){var r=g.points[i]||[0,0];if(Math.abs(t-r[0])<6&&Math.abs(n-r[1])<6){s={p:g.points[m=i],minY:0,maxY:64},0===i?(s.minX=0,s.maxX=0):(s.minX=g.points[i-1][0],s.maxX=324,i<g.count-1&&(s.maxX=g.points[i+1][0]));break}}l!==m&&(l=m,f.refresh())}},f.onDragStart=function(e){s&&(i={startX:e.startX,startY:e.startY,pX:s.p[0],pY:s.p[1]},o=!0)},f.onDrag=function(e){if(o){i.deltaX=e.deltaX/d,i.deltaY=e.deltaY/c;var t=i.pX+i.deltaX;t=Math.min(s.maxX,t),t=Math.max(s.minX,t);var n=i.pY-i.deltaY;n=Math.min(s.maxY,n),n=Math.max(s.minY,n),s.p[0]=t,s.p[1]=n,f.refresh()}},f.onTouchUp=function(e){o=!1},f.setInstrument=function(e){g=e?e[f.type+"Envelope"]:void 0,f.refresh()},f.render=function(){function e(e){f.ctx.beginPath(),f.ctx.moveTo(e,0),f.ctx.lineTo(e,f.height),f.ctx.stroke()}if(this.needsRendering&&(p.width!==f.width&&p.setSize(f.width,f.height),f.ctx.drawImage(p.render(!0),0,0,f.width,f.height),f.ctx.lineWidth=1,"panning"===f.type&&(f.ctx.strokeStyle="#4a7c92",f.ctx.setLineDash([1,2]),o=Math.floor(f.height/2),f.ctx.beginPath(),f.ctx.moveTo(0,o),f.ctx.lineTo(f.width,o),f.ctx.stroke()),g&&g.count)){var t=f.width/324,n=f.height/64;f.ctx.strokeStyle=g.enabled?"rgba(120, 255, 50, 0.5)":"rgba(120, 120, 180, 0.5)",f.ctx.beginPath(),f.ctx.setLineDash([]);for(var i=0;i<g.count;i++){var a=g.points[i];if(a){var r=a[0]*t,o=f.height-a[1]*n,s=4,l=g.enabled?"#D2861B":"#546888";i===m&&(s=6,l="#FFFFFF"),f.ctx.fillStyle=l,0===i?f.ctx.moveTo(r,o):f.ctx.lineTo(r,o);var d=s/2;f.ctx.fillRect(r-d,o-d,s,s)}}if(f.ctx.stroke(),g.enabled){if(g.sustain){var c=g.points[g.sustainPoint||0];c&&(f.ctx.strokeStyle="#67b6d2",f.ctx.setLineDash([1,2]),e(c[0]*t))}if(g.loop){f.ctx.strokeStyle="#d2b637",f.ctx.setLineDash([1,2]);var u=g.points[g.loopStartPoint||0],h=g.points[g.loopEndPoint||0];u&&e(u[0]*t),h&&e(h[0]*t)}}}this.needsRendering=!1,f.parentCtx.drawImage(f.canvas,f.left,f.top,f.width,f.height)},f},de.EnvelopePanel=function(t){var i,n=de.panel();n.type=t;var a=!1,r=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);r.ignoreEvents=!0,n.addChild(r);var o=de.label({label:t+" Envelope",font:fontSmall});o.onClick=function(){s.toggle()},n.addChild(o);var s=de.checkbox();s.onToggle=function(e){i&&(i.enabled=e,c.refresh())},n.addChild(s);var l=de.Assets.generate("button20_20");l.onDown=function(){if(i.enabled){if(i.count<i.points.length){var e=i.points[i.count-1]||[0,0],t=i.points[i.count];e[0]+10<320&&(t[0]<=e[0]&&(t[0]=e[0]+10),i.count++)}else{var n=i.points[i.points.length-1];if(n[0]+10<320)i.points.push([n[0]+10,32]),i.count=i.points.length}c.refresh()}},l.setProperties({label:"+",width:18,height:18}),n.addChild(l);var d=de.Assets.generate("button20_20");d.onDown=function(){i.enabled&&(2<i.count&&(i.count--,n.checkMax()),c.refresh())},d.setProperties({label:"-",width:18,height:18}),n.addChild(d);var c=de.Envelope(t);n.addChild(c);var u=de.panel(0,0,20,20),h=de.checkbox(),f=de.checkbox(),g=de.spinBox(),p=de.spinBox(),m=de.spinBox();h.onToggle=function(e){g.setDisabled(!e),i.sustain=e,c.refresh()},f.onToggle=function(e){p.setDisabled(!e),m.setDisabled(!e),i.loop=e,c.refresh()},g.setProperties({label:" ",name:n.type+" envelope sustain",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontFT,trackUndo:!0,undoInstrument:!0,onChange:function(e){i.sustainPoint=e,n.checkMax(),c.refresh()}}),p.setProperties({label:"From",name:n.type+" envelope loop from",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,trackUndo:!0,undoInstrument:!0,onChange:function(e){i.loopStartPoint=e,n.checkMax(),c.refresh()}}),m.setProperties({label:"To",name:n.type+" envelope loop to",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,trackUndo:!0,undoInstrument:!0,onChange:function(e){i.loopEndPoint=e,n.checkMax(),c.refresh()}});var v=de.scale9Panel(0,0,u.width,u.height,de.Assets.panelMainScale9);v.ignoreEvents=!0,u.addChild(v),u.addChild(g),u.addChild(p),u.addChild(m);var b=de.label({label:"Sustain",font:fontSmall,width:60});u.addChild(b);var w=de.label({label:"Loop",font:fontSmall,width:60});return u.addChild(w),u.addChild(h),u.addChild(f),n.addChild(u),n.setInstrument=function(e){e&&(i=e[t+"Envelope"],c.setInstrument(e),s.setState(i&&i.enabled),h.setState(i&&i.sustain),f.setState(i&&i.loop),g.setValue(i.sustainPoint||0,!0),p.setValue(i.loopStartPoint||0,!0),m.setValue(i.loopEndPoint||0,!0))},n.setDisabled=function(e){n.ignoreEvents=a=e,n.refresh()},n.onResize=function(){u.setSize(120,n.height);var e=u.width;r.setSize(n.width-e-36,18),o.setSize(n.width-e,20),s.setPosition(2,2),o.setPosition(12,2),c.setPosition(0,20),c.setSize(n.width-e+1,n.height-22),v.setSize(u.width,u.height),u.setPosition(n.width-u.width,0),h.setPosition(4,4),b.setPosition(14,4),g.setProperties({left:10,top:20,width:100,height:28}),f.setPosition(5,50),w.setPosition(14,50),p.setProperties({left:10,top:70,width:100,height:28}),m.setProperties({left:10,top:98,width:100,height:28}),l.setPosition(r.width,r.top),d.setPosition(r.width+18,r.top)},n.renderInternal=function(){a&&(n.ctx.fillStyle="rgba(34, 49, 85, 0.4)",n.ctx.fillRect(0,0,n.width,n.height))},n.checkMax=function(){i.count&&(i.count<=i.sustainPoint&&g.setValue(i.count-1),i.count<=i.loopStartPoint&&p.setValue(i.count-1),i.count<=i.loopEndPoint&&m.setValue(i.count-1))},n},de.fxPanel=function(e){function t(e,t){if(i&&!e.isDisabled)switch(e.getLabel()){case"volume":i.volumeValue(t);break;case"panning":i.panningValue((t-50)/50);break;case"high":i.highValue(t/100);break;case"mid":i.midValue(t/100);break;case"low":i.lowValue(t/100);break;case"lowPass":i.lowPassFrequencyValue(t/100);break;case"reverb":i.reverbValue(t)}}function n(e,t){if(i){var n=e.getLabel();i.setState(n,t)}}var s=de.panel();s.hide(),e=e||0;var l=de.scale9Panel(0,0,20,20,de.Assets.buttonDarkScale9);l.ignoreEvents=!0,s.addChild(l);for(var i,a=["volume","panning","high","mid","low","lowPass","reverb"],r=0,o=10,d=[],c=0,u=a.length;c<u;c++){var h=de.knob();h.setProperties({top:r,left:o,label:a[c],disabled:1<c}),h.onChange=function(e){t(this,e)},h.onToggle=function(e){n(this,e),t(this,this.getValue())},s.addChild(h),d.push(h),c%2==0?o+=70:(o=10,r+=70)}return _e.filterChains&&(i=_e.filterChains[e]),s.setLayout=function(){if(de.mainPanel){l.setSize(s.width,s.height);var i=Math.max(1,Math.floor(s.width/70)),a=Math.floor((s.width-70*i)/2),r=Math.floor((s.width-2*a)/i),o=0;d.forEach(function(e,t){var n=t%i;e.setPosition(n*r+a,o),n==i-1&&(o+=70)})}},s},de.InfoPanel=function(){var i,a=de.element(),r="",o="",s=de.Assets.generate("buttonDark");s.setLabel("More info "),s.onClick=function(){i&&window.open(i)},a.addChild(s);var l=de.animsprite(5,7,20,18,"boing",11);a.addChild(l),l.hide(),ye.on(ce.statusChange,function(e){e&&(void 0!==e.status&&(o=e.status),void 0!==e.info&&(r=e.info,i=e.url),void 0!==e.showSpinner&&l.toggle(!!e.showSpinner)),a.refresh()});var e=["left","top","width","height","name","type","zIndex"];return a.setProperties=function(t){e.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top),a.setLayout&&a.setLayout(a.left,a.top,a.width,a.height)},a.setLayout=function(){var e=ct.col1W,t="More Info";e<100&&(t="info"),e<45&&(t="i"),s.setProperties({width:ct.col1W,height:24,top:2,left:ct.col5X-2-a.left,label:t,font:fontFT})},a.render=function(e){if(a.isVisible()){if(e=!!e,this.needsRendering){a.clearCanvas(),i&&s.render();var t=r;o&&(t=o+": "+t);var n=6;l.isVisible()&&(l.render(),n+=20),window.fontFT.write(a.ctx,t,n,11,0)}if(this.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}},a};var ht=function(){function m(){if(v.length){var e=v.shift();if(e.source)try{e.source.stop()}catch(e){}}}var c,l,u={},d={};d.touches=[];var h,r=0,o=!(d.mouseWheels=[]),v=[],b={},f=!1,g=2,t=3,n=1,w=13;u.init=function(){function e(s){function e(e,t,n){d.isTouchDown=!0;var i=Je.getBoundingClientRect();t-=i.left+window.pageXOffset,n-=i.top+window.pageYOffset,(l=de.getModalElement())?(l.eventX=t,l.eventY=n):l=de.getEventElement(t,n),l&&c&&c.deActivate&&c.name!==l.name&&c.deActivate(l);var a=l?l.eventX:t,r=l?l.eventY:n,o={id:e,x:a,y:r,startX:a,startY:r,globalX:t,globalY:n,globalStartX:t,globalStartY:n,UIobject:l,isMeta:s.shiftKey||s.metaKey||s.ctrlKey||s.altKey};d.touches.push(o),o.UIobject&&(o.UIobject.onDragStart&&o.UIobject.onDragStart(o),o.UIobject.onDown&&o.UIobject.onDown(o))}if(s.preventDefault(),window.focus(),o||void 0!==_e&&_e.playSilence&&_e.context&&"suspended"!==_e.context.state&&(_e.playSilence(),o=!0),s.touches&&0<s.touches.length)for(var t=s.changedTouches,n=0;n<t.length;n++){var i=t[n];e(i.identifier,i.pageX,i.pageY)}else{var a=p("notouch");0<=a&&d.touches.splice(a,1),e("notouch",s.pageX,s.pageY)}}function t(e){function t(e,t,n){if(0<=e){var i=d.touches[e];i.globalX=t-window.pageXOffset,i.globalY=n-window.pageYOffset,i.deltaX=i.globalX-i.globalStartX,i.deltaY=i.globalY-i.globalStartY,i.x=i.startX+i.deltaX,i.y=i.startY+i.deltaY,d.touches.splice(e,1,i),d.isTouchDown&&i.UIobject&&i.UIobject.onDrag&&(i.dragX=t,i.dragY=n,i.UIobject.onDrag(i))}}e.preventDefault();var n=Je.getBoundingClientRect();if(e.touches&&0<e.touches.length)for(var i=e.changedTouches,a=0;a<i.length;a++){var r=i[a];t(p(r.identifier),r.pageX-n.left,r.pageY-n.top)}else{var o=e.pageX-n.left,s=e.pageY-n.top;if(t(p("notouch"),o,s),d.currentMouseX=o,d.currentMouseY=s,d.mouseMoved=(new Date).getTime(),Se.useHover){var l=de.getEventElement(o,s);l&&l.onHover&&l.onHover(d),h&&h!=l&&h.onHoverExit&&h.onHoverExit(d,l),h=l}}}function n(e){function t(e){if(0<=e){var t=d.touches[e],n=t.startX-t.x,i=t.startY-t.y,a=Math.sqrt(n*n+i*i),r=!0;if(t.UIobject){var o=t.UIobject;o.keepSelection&&(r=!1),a<8&&o.onClick&&o.onClick(t),o.onTouchUp&&o.onTouchUp(t)}r&&a<8&&de.clearSelection(),d.touches.splice(e,1)}}if(o||_e&&_e.checkState&&_e.checkState(),d.isTouchDown=!1,e&&e.touches)for(var n=e.changedTouches,i=0;i<n.length;i++){t(p(n[i].identifier))}else t(p("notouch"))}function i(e){if(e.preventDefault(),d.currentMouseX){var t=de.getEventElement(d.currentMouseX,d.currentMouseY);if(t&&t.onMouseWheel){d.mouseWheels.unshift(e.wheelDeltaY||e.wheelDelta||-e.detail),10<d.mouseWheels.length&&d.mouseWheels.pop(),t.onMouseWheel(d)}}}function a(){Oe.isPlugin||(clearTimeout(r),r=setTimeout(function(){de.setSize(window.innerWidth,window.innerHeight)},100))}Je.addEventListener("mousedown",e,!1),Je.addEventListener("mousemove",t,!1),Je.addEventListener("mouseup",n,!1),Je.addEventListener("mouseout",function(e){d.isTouchDown&&n(e)},!1),Je.addEventListener("touchstart",e,!1),Je.addEventListener("touchmove",t,!1),Je.addEventListener("touchend",n,!1),window.navigator.msPointerEnabled&&(Je.addEventListener("MSPointerDown",e,!1),Je.addEventListener("MSPointerMove",t,!1),Je.addEventListener("MSPointerEnd",n,!1)),Je.addEventListener("mousewheel",i,!1),Je.addEventListener("DOMMouseScroll",i,!1),window.addEventListener("keydown",function(e){e.preventDefault();var t=ke[Se.keyboardTable]||ke.azerty,n=e.keyCode,i=e.key,a={shift:e.shiftKey,control:e.ctrlKey,alt:e.altKey,command:e.metaKey};if(f=a.command||a.control||a.alt||a.shift,!i&&e.keyIdentifier){var r=e.keyIdentifier;r=r.replace("U+",""),i=String.fromCharCode(parseInt(r,16)).toLowerCase()}if(c&&c.onKeyDown&&c.onKeyDown(n,e))return;switch(n){case 8:return ot.isRecording()?void(f?(Ne.removeNote(),ot.moveCurrentPatternPos(-1)):(0===(s=Ne.getCurrentTrackPosition())?Ne.putNote(0,0):!ot.inFTMode()||3!==s&&4!==s?Ne.putNoteParam(s,0):Ne.putNoteParam(s,-1),ot.moveCurrentPatternPos(1))):(ot.playPatternStep(Ne.getCurrentTrackPosition()),void ot.moveCurrentPatternPos(-1));case 9:return e.stopPropagation(),e.preventDefault(),void Ne.moveCursorPosition(f?-Ne.getStepsPerTrack():Ne.getStepsPerTrack());case 13:return void(ot.isRecording()&&f?(Ne.insertNote(),ot.moveCurrentPatternPos(1)):ot.togglePlay());case 16:break;case 27:de.clearSelection();break;case 32:return void ot.toggleRecord();case 33:var o=Math.floor(ot.getPatternLength()/4);0===o&&(o=1);var s=Math.floor(ot.getCurrentPatternPos()/o)*o;return ot.getCurrentPatternPos()===s&&(s-=o),s<0&&(s=0),void ot.setCurrentPatternPos(s);case 34:return 0===(o=Math.floor(ot.getPatternLength()/4))&&(o=1),s=Math.ceil(ot.getCurrentPatternPos()/o)*o,ot.getCurrentPatternPos()===s&&(s+=o),s>=ot.getPatternLength()-1&&(s=ot.getPatternLength()-1),void ot.setCurrentPatternPos(s);case 35:return void ot.setCurrentPatternPos(ot.getPatternLength()-1);case 36:return void ot.setCurrentPatternPos(0);case 37:return void Ne.moveCursorPosition(-1);case 38:return void ot.moveCurrentPatternPos(-1);case 39:return void Ne.moveCursorPosition(1);case 40:return void ot.moveCurrentPatternPos(1);case 46:return void(ot.isRecording()&&(0===(s=Ne.getCurrentTrackPosition())?Ne.putNote(0,0):Ne.putNoteParam(s,0),ot.moveCurrentPatternPos(1)));case 112:case 113:case 114:case 115:case 116:case 117:case 118:return void u.setCurrentOctave(n-111);case 119:case 120:case 121:case 122:case 123:case 221:return}if(i&&40<n&&n<230){if(f&&65<=n&&n<=90){switch(e.stopPropagation(),e.preventDefault(),n){case 65:return void ye.trigger(ce.commandSelectAll);case 67:return void de.copySelection(!0);case 86:return void de.pasteSelection(!0);case 88:return void de.cutSelection(!0);case 89:return void ye.trigger(ce.commandRedo);case 90:return void ye.trigger(ce.commandUndo)}return}var l=-1,d=t[i];"number"==typeof d&&(l=12*g+d,0===d&&(l=0)),u.handleNoteOn(l,i)}},!1),window.addEventListener("keyup",function(e){var t=e.key;if(!t&&e.keyIdentifier){var n=e.keyIdentifier;n=n.replace("U+",""),t=String.fromCharCode(parseInt(n,16)).toLowerCase()}var i,a=e.keyCode;if(16!==(i=a)&&17!==i&&18!==i&&91!==i&&93!==i||(f=!1),t&&40<a&&a<200){var r=(ke[Se.keyboardTable]||ke.azerty)[t];if("number"==typeof r)return u.handleNoteOff(12*g+r)}},!1),Je.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),Je.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),Je.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),ot.handleUpload(e.dataTransfer.files)},!1),window.addEventListener("paste",function(e){de.pasteSelection(!0)},!1),window.addEventListener("copy",function(e){de.copySelection(!0)},!1),window.addEventListener("cut",function(e){de.cutSelection(!0)},!1),window.addEventListener("undo",function(e){},!1),window.addEventListener("delete",function(e){},!1),Oe.isPlugin||window.addEventListener("resize",a,!1),a()};var p=function(e){for(var t=0;t<d.touches.length;t++)if(d.touches[t].id===e)return t;return-1};return u.setFocusElement=function(e){var t=e.name||e.type;if(c){if((c.name||c.type)===t)return;c.deActivate&&c.deActivate()}c=e},u.clearFocusElement=function(e){if(e){e.deActivate&&e.deActivate(),c&&c.name===e.name&&(c=void 0)}else c&&c.deActivate&&c.deActivate(),c=void 0},u.getFocusElement=function(){return c},u.clearInputNotes=function(){for(;v.length;)m()},u.getCurrentOctave=function(){return g},u.setCurrentOctave=function(e){e<=t&&n<=e&&ye.trigger(ce.octaveChanged,g=e)},u.handleNoteOn=function(e,t,n,i){var a,r,o,s=!0;if(0<=e&&(w=e,de.clearSelection(),r=Math.floor((e-1)/12)+1,o=xe[(e-1)%12+1]))if(ot.inFTMode())if("OFF"===o.name)s=!(a={period:1,index:0});else{var l=at[e];l&&(a={period:l.period,index:e})}else a=Y[o.name+(r-1)];if(ot.isRecording())if(0<Ne.getCurrentTrackPosition()){s=!1;var d=/[0-9A-Fa-f]/g,c=-1;if(d.test(t=t||"")?c=parseInt(t,16):ot.inFTMode()&&5===Ne.getCurrentTrackPosition()&&(d=/[0-9A-Za-z]/g).test(t)&&(c=parseInt(t,36)),ot.inFTMode()&&3===Ne.getCurrentTrackPosition())switch(c=-1,t){case"0":c=0;break;case"1":c=1;break;case"2":c=2;break;case"3":c=3;break;case"4":c=4;break;case"-":c=5;break;case"+":c=6;break;case"d":case"D":c=7;break;case"u":case"U":c=8;break;case"s":case"S":c=9;break;case"v":case"V":c=10;break;case"p":case"P":c=11;break;case"<":c=12;break;case">":c=13;break;case"M":c=14}255<c&&(c=-1),0<=c&&(Ne.putNoteParam(Ne.getCurrentTrackPosition(),c),ot.moveCurrentPatternPos(1))}else{if(b[e])return;a&&(Ne.putNote(ot.getCurrentInstrumentIndex(),a.period,a.index,i),ot.isPlaying()||ot.moveCurrentPatternPos(1))}if(s&&a){if(b[e])return;var u=ot.getCurrentInstrument();if(u){if(a.index&&(u.setSampleForNoteIndex(a.index),u.sample.relativeNote)){a.index+=u.sample.relativeNote;var h=at[a.index];h&&(a.period=h.period)}_e.checkState();var f=void 0;n&&(f={offset:{value:n}}),"number"==typeof i&&(i=100*i/64),b[e]=u.play(a.index,a.period,i,void 0,f),b[e].instrument=u,b[e].isKey=!0,v.push(b[e]);var g=b[e];if(g.scheduled&&g.scheduled.vibrato){var p=u.scheduleAutoVibrato(g,2);g.scheduled.vibrato+=p}64<v.length&&m(),ye.trigger(ce.pianoNoteOn,e)}}},u.handleNoteOff=function(e,t){if(!Se.sustainKeyboardNotes&&b[e]&&b[e].source&&_e.context){ye.trigger(ce.pianoNoteOff,e);try{b[e].instrument?b[e].instrument.noteOff(_e.context.currentTime,b[e]):b[e].source.stop()}catch(e){}}b[e]=!1,t&&ot.inFTMode()&&ot.isRecording()&&ot.isPlaying()&&(Ne.putNoteParam(5,20),Ne.putNoteParam(7,1))},u.isMetaKeyDown=function(){return f},u.getPrevIndex=function(){return w},ye.on(ce.second,function(){if(_e.context){var n=_e.context.currentTime;v.forEach(function(e){if(e&&e.time&&e.scheduled){if(e.scheduled.volume&&e.scheduled.volume<=n+2&&e.instrument){var t=e.instrument.scheduleEnvelopeLoop(e.volumeEnvelope,e.scheduled.volume,2);e.scheduled.volume+=t}e.scheduled.panning&&e.scheduled.panning<=n+2&&e.instrument&&(t=e.instrument.scheduleEnvelopeLoop(e.panningEnvelope,e.scheduled.panning,2),e.scheduled.panning+=t),e.scheduled.vibrato&&e.scheduled.vibrato<=n+2&&e.instrument&&(t=e.instrument.scheduleAutoVibrato(e,2),e.scheduled.vibrato+=t)}})}}),ye.on(ce.trackerModeChanged,function(e){ot.inFTMode()?(t=7,n=0,u.setCurrentOctave(g+2)):(t=3,n=1,u.setCurrentOctave(Math.min(Math.max(g-2,n),t)))}),u}();de.MainPanel=function(){var i=de.panel(0,0,Je.width,Je.height,!0);i.setProperties({backgroundColor:"#071028"}),i.name="mainPanel";var n={},a=de.app_menu(i);i.addChild(a);var r=de.app_mainPanel();i.addChild(r);var o=de.app_controlPanel();i.addChild(o);var s=de.app_patternPanel();i.addChild(s);var l=de.app_sidebar();ct.showAppSideBar&&i.addChild(l);var d=de.app_pianoView();return d.hide(),i.addChild(d),i.createContextMenu=function(e){var t=n[e.name];return t||((t=de.menu(100,100,128,42,i)).zIndex=100,t.setProperties({background:de.Assets.panelMainScale9,layout:"buttons"}),t.setItems(e.items),t.hide(),i.addChild(t),n[e.name]=t),t},i.onResize=function(){ct.setLayout(i.width,i.height),a.setSize(ct.mainWidth,a.height);var e=a.height;r.setSize(ct.mainWidth,r.height),r.setPosition(ct.mainLeft,e),e+=r.height,o.setSize(ct.mainWidth,ct.controlPanelHeight),o.setPosition(ct.mainLeft,e);var t=i.height-(e+=o.height);d.isVisible()&&(d.setSize(ct.mainWidth,ct.pianoHeight),d.setPosition(ct.mainLeft,i.height-d.height),t-=d.height),s.setPosition(ct.mainLeft,e),s.setSize(ct.mainWidth,t),l.setPosition(0,0),l.setSize(ct.sidebarWidth,i.height)},i.sortZIndex(),i.onResize(),ye.on(ce.toggleView,function(e){if("piano"===e){d.toggle();var t=i.height-s.top;d.isVisible()&&(d.setSize(ct.mainWidth,ct.pianoHeight),d.setPosition(ct.mainLeft,i.height-d.height),t-=d.height),s.setSize(ct.mainWidth,t)}"sidebar"===e&&(ct.showAppSideBar=!ct.showAppSideBar,ct.setLayout(),i.onResize())}),ye.on(ce.showContextMenu,function(e){var t=i.createContextMenu(e),n=e.x;ct.mainWidth<n+t.width&&(n=ct.mainWidth-t.width),t.setPosition(n,e.y-t.height-2),t.show(),i.refresh()}),ye.on(ce.hideContextMenu,function(){for(var e in n)n[e].hide();i.refresh()}),i},de.OptionsPanel=function(){var p=de.panel();p.hide();var t=de.scale9Panel(0,0,20,20,de.Assets.panelMainScale9);t.ignoreEvents=!0,p.addChild(t);var e=de.label({label:"Options:",font:fontMed,left:5,height:18,top:9,width:200});p.addChild(e);var n=de.Assets.generate("button20_20");n.setLabel("x"),n.onClick=function(){Oe.doCommand(z.showTopMain)},p.addChild(n);var i=[{label:"VU bars",values:["NONE","COLOURS: AMIGA","TRANSPARENT"],valueLabels:{"COLOURS: AMIGA":[{width:56,label:"AMIGA"},{width:110,label:"COLOURS: AMIGA"}]},setValue:function(e){Se.vubars=0===e?"none":2===e?"trans":"colour",Ke.saveSettings()},getValue:function(){var e=1;return"none"===Se.vubars&&(e=0),"trans"===Se.vubars&&(e=2),e}},{label:"Stereo",values:["Hard: Amiga","Balanced","None: mono"],setValue:function(e){_e.setStereoSeparation(0===e?h:2===e?m:f),Ke.saveSettings()},getValue:function(){var e=1;return Se.stereoSeparation===m&&(e=2),Se.stereoSeparation===h&&(e=0),e}},{label:"Keyboard Layout",labels:[{width:56,label:"Keyboard"},{width:110,label:"Keyboard Layout"}],values:["QWERTY","AZERTY","QWERTZ","Dvorak"],setValue:function(e){Se.keyboardTable=0===e?"qwerty":1===e?"azerty":2===e?"qwertz":"dvorak",Ke.saveSettings()},getValue:function(){var e=0;return"azerty"===Se.keyboardTable&&(e=1),"qwertz"===Se.keyboardTable&&(e=2),"dvorak"===Se.keyboardTable&&(e=3),e},checkBoxes:[{label:"Show Key Input",labels:[{width:60,label:"Show"},{width:100,label:"Show Key"},{width:150,label:"Show Key Input"}],getValue:function(){return Se.showKey},handler:function(e){Se.showKey=e,Ke.saveSettings(),ye.trigger(ce.menuLayoutChanged)}}]},{label:"Screen refresh",labels:[{width:56,label:"Screen"},{width:100,label:"Screen refresh"}],values:["Smooth","Normal","Economical","Low CPU"],setValue:function(e){de.skipFrame(e),Ke.saveSettings()},getValue:function(){return de.getSkipFrame()},checkBoxes:[{label:"Optimize High DPI",labels:[{width:60,label:"H-DPI"},{width:100,label:"High DPI"},{width:155,label:"Optimize High DPI"}],getValue:function(){return Se.highDPI},handler:function(e){Se.highDPI=e,Ke.saveSettings(),de.scaleToDevicePixelRatio(e)}}]},{label:"Frequency table",labels:[{width:56,label:"Frequency"},{width:110,label:"Frequency table"}],values:["Linear","Amiga periods"],valueLabels:{"Amiga periods":[{width:56,label:"AMIGA"},{width:110,label:"Amiga periods"}]},setValue:function(e){ot.useLinearFrequency=0===e},getValue:function(){return ot.useLinearFrequency?0:1}},{label:"Dropbox: existing file",labels:[{width:20,label:"Dropbox"},{width:80,label:"Dropbox save"},{width:160,label:"Dropbox existing file"}],values:["Rename","Overwrite"],setValue:function(e){Se.dropboxMode=0===e?"rename":"overwrite",Ke.saveSettings()},getValue:function(){var e=0;return"overwrite"===Se.dropboxMode&&(e=1),e}},{label:"Midi-in",labels:[{width:20,label:"Midi"},{width:80,label:"Midi-in"}],values:["Disabled","Enabled Note","Enabled Note-Volume"],valueLabels:{"Enabled Note":[{width:80,label:"Note"},{width:150,label:"Enabled Note"}],"Enabled Note-Volume":[{width:80,label:"Note-Volume"},{width:150,label:"Enabled Note-Volume"}]},setValue:function(e){0===e?(Se.midi="disabled",Mt.disable()):(Se.midi=1===e?"enabled-note":"enabled",Mt.enable()),Ke.saveSettings()},getValue:function(){var e=0;return"enabled-note"===Se.midi&&(e=1),"enabled"===Se.midi&&(e=2),e},checkBoxes:[{label:"Show Midi Input",labels:[{width:60,label:"Show"},{width:100,label:"Show Midi"},{width:150,label:"Show Midi Input"}],getValue:function(){return Se.showMidi},handler:function(e){Se.showMidi=e,Ke.saveSettings(),ye.trigger(ce.menuLayoutChanged)}}]}];return i.forEach(function(e){var t=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);t.ignoreEvents=!0,p.addChild(t);var n=de.label();n.setProperties({label:e.label,labels:e.labels,font:fontSmall,textAlign:"center"}),p.addChild(n),e.labelBox=t,e.label=n;for(var i=[],a=(e.getValue(),0);a<e.values.length;a++){var r,o=e.values[a];if(o)(r=de.Assets.generate("buttonKey")).setProperties(e.valueLabels&&e.valueLabels[o]?{label:o,labels:e.valueLabels[o]}:{label:o}),r.index=a,r.option=e,r.onClick=function(){this.isDisabled||activateOption(this)};p.addChild(r),i.push(r)}if(e.buttons=i,e.checkBoxes){var s=e.checkBoxes[0],l=de.checkboxbutton({background:de.Assets.panelDarkInsetScale9,hoverBackground:de.Assets.panelInsetScale9,activeBackground:de.Assets.panelDarkInsetScale9,label:s.label,labels:s.labels,checkbox:!0});l.getValue=s.getValue,p.addChild(l),l.onClick=function(){s.handler(l.isActive)},e.checkBox=l}}),activateOption=function(e){var t=e.option;t.buttons.forEach(function(e){e.setActive(!1)}),e.setActive(!0),t.setValue(e.index)},p.onShow=function(){p.onResize()},p.onResize=function(){if(p.isVisible()){p.clearCanvas(),t.setProperties({left:0,top:0,height:p.height,width:p.width});n.setProperties({top:5,left:p.width-30});var s=[27,103],l=20,d=20,c=0,u=0,h=!1,f=i.length,e=i.length;p.width<600&&(h=!0,s=[27,103],d=l=18,e=4);var g=Math.floor((p.width-ct.defaultMargin*(e+1))/e);i.forEach(function(e,t){var n=ct.defaultMargin+c*(g+ct.defaultMargin),i=s[u];f<=t&&(n=p.width+100),e.labelBox.setProperties({top:i,width:g,height:l,left:n}),e.label.setProperties({top:i+3,_width:ct.col31W,width:g,height:l,left:n+2});for(var a=e.getValue(),r=0;r<e.buttons.length;r++){var o=e.buttons[r];o.setProperties({top:i+r*d+l,height:d,width:g,left:n}),o.setActive(r===a)}e.checkBox&&(e.checkBox.setProperties({top:p.height-d-7,height:d+4,width:g,left:n}),e.checkBox.setActive(e.checkBox.getValue())),c++,h&&4<=c&&(c=0,u++)})}},ye.on(ce.songPropertyChange,function(){p.isVisible()&&p.onResize()}),ye.on(ce.trackerModeChanged,function(){var e=i[4];e.buttons&&e.buttons.length&&e.buttons.forEach(function(e){e.setDisabled(!ot.inFTMode())});var t=i[1];t.buttons&&t.buttons.length&&t.buttons.forEach(function(e){e.setDisabled(ot.inFTMode())}),p.isVisible()&&p.onResize()}),p},de.SampleView=function(){function e(e){var t=ot.getCurrentInstrument();if(t)if(16===e)g.setActive(!(t.sample.bits=16)),p.setActive(!0);else{for(var n=0,i=t.sample.data.length;n<i;n++)t.sample.data[n]=Math.round(127*t.sample.data[n])/127;t.sample.bits=8,g.setActive(!0),p.setActive(!1)}}function n(e){"loop"===e?(I.show(),y.show(),S.show(),T.hide(),M.hide(),A.hide(),V.setActive(),W.setActive(!1),E.forEach(function(e){e.hide()})):(I.hide(),y.hide(),S.hide(),T.show(),M.show(),A.show(),V.setActive(!1),W.setActive(),E.forEach(function(e){e.show()})),u.onResize()}function i(n){E.forEach(function(e,t){e.setActive(n===t)});var e=ot.getCurrentInstrument();e&&(e.vibrato.type=n)}var a,u=de.panel();u.name="SampleView",u.hide();var t=window;t=window.fontCondensed;var h=de.inputbox({name:"instrumentName",height:20,trackUndo:!0,undoInstrument:!0,onChange:function(e){if(a){var t=ot.getInstrument(a);t&&(t.name=e),ye.trigger(ce.instrumentNameChange,a)}}});u.addChild(h);var f=de.Assets.generate("button20_20");f.setLabel("x"),f.onClick=function(){Oe.doCommand(z.showBottomMain)},u.addChild(f);var r={background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},g=de.button(),p=de.button();g.setProperties(r),g.setLabel("8"),g.setActive(!0),g.onDown=function(){e(8)},u.addChild(g),p.setProperties(r),p.setLabel("16"),p.onDown=function(){e(16)},u.addChild(p);var m=de.WaveForm();u.addChild(m),m.onMouseWheel=function(e){m.zoom(0<e.mouseWheels[0]?1.01:.99)};var v=de.EnvelopePanel("volume");u.addChild(v);var b=de.EnvelopePanel("panning");u.addChild(b);var w=new de.panel;w.setProperties({name:"instrumentSideButtonPanel"});var x=de.spinBox({name:"Instrument",label:"",value:1,max:64,padLength:2,min:1,font:t,onChange:function(e){ot.setCurrentInstrumentIndex(e)}});u.addChild(x);var k=de.sliderBox({name:"Volume",label:"Volume",font:t,height:200,width:40,value:64,max:64,min:0,step:1,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.sample.volume=e)}});w.addChild(k);var P=de.sliderBox({name:"Finetune",label:"Finetune",font:t,value:0,max:7,min:-8,step:1,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&t.setFineTune(e)}});w.addChild(P);var C=de.sliderBox({name:"Panning",label:"Panning",font:t,value:0,max:127,min:-127,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.panning=e,t.sample.panning=e)}});w.addChild(C);var S=de.spinBox({name:"Repeat",label:"Start",value:0,max:65535,min:0,step:2,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.sample.length<t.sample.loop.length+e&&S.setValue(e=t.sample.length-t.sample.loop.length,!0),t.sample.loop.start=e),m.refresh()}});w.addChild(S);var y=de.spinBox({name:"Repeat Length",label:"Length",value:0,max:65535,min:0,step:2,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.sample.length<t.sample.loop.start+e&&y.setValue(e=t.sample.length-t.sample.loop.start,!0),t.sample.loop.length=e),ye.trigger(ce.samplePropertyChange,{interal_loopLength:e}),m.refresh()}});w.addChild(y);var _=de.sliderBox({name:"Fadeout",label:"Fadeout",value:0,max:4095,min:0,step:1,font:t,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.fadeout=e)}});w.addChild(_);var I=de.spinBox({name:"relativeNote",label:"RelativeNote",value:0,max:128,min:-127,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.sample.relativeNote=e)}});w.addChild(I);var T=de.spinBox({name:"vibratoSpeed",label:"Vib Speed",value:0,max:63,min:0,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.vibrato.rate=e)}});w.addChild(T),T.hide();var M=de.spinBox({name:"vibratoDepth",label:"Vib Depth",value:0,max:15,min:0,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.vibrato.depth=e)}});w.addChild(M),M.hide();var A=de.spinBox({name:"vibratoSweep",label:"Vib Sweep",value:0,max:255,min:0,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=ot.getCurrentInstrument();t&&(t.vibrato.sweep=e)}});w.addChild(A),A.hide();var E=[];["sin","square","saw","saw_inverse"].forEach(function(e,t){var n=de.button();n.setProperties({background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,image:lt.getImage("wave_"+e),activeImage:lt.getImage("wave_"+e),isActive:!1}),n.onDown=function(){i(t)},n.hide(),w.addChild(n),E.push(n)}),i(0),u.addChild(w);var D=[],o=[{label:"Zoom In",width:62,onClick:function(){m.zoom(2)}},{label:"Out",width:38,onClick:function(){m.zoom(.5)}},{label:"All",width:50,onClick:function(){m.zoom(1)}},{value:0,width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.sampleLength&&e.setValue(t.sampleLength)}},{label:"Loop",width:50,onClick:function(){m.zoom("loop")}},{value:0,width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.loopLength&&e.setValue(t.loopLength),void 0!==t.interal_loopLength&&e.setValue(t.interal_loopLength)}},{label:"Range",width:50,onClick:function(){m.zoom("range")}},{value:"0",width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.rangeLength&&e.setValue(t.rangeLength)}}],s=[{label:"Reverse",onClick:function(){m.reverse()}},{label:"Invert",onClick:function(){m.invert()}},{label:"Upsample",onClick:function(){m.resample("up")}},{label:"DownSample",onClick:function(){m.resample("down")}}],l=[{label:"Maximize",onClick:function(){m.adjustVolume("max")}},{label:"Fade In",width:62,onClick:function(){m.adjustVolume("fadein")}},{label:"Out",width:38,onClick:function(){m.adjustVolume("fadeout")}},{label:"-5%",width:50,onClick:function(){m.adjustVolume(-5)}},{label:"+5%",width:50,onClick:function(){m.adjustVolume(5)}},{label:"-10%",width:50,onClick:function(){m.adjustVolume(-10)}},{label:"+10%",width:50,onClick:function(){m.adjustVolume(10)}}],d=[{label:"[",width:15,onClick:function(){m.select("start")}},{label:"All",width:70,onClick:function(){m.select("all")}},{label:"]",width:15,onClick:function(){m.select("end")}},{label:"None",width:50,onClick:function(){m.select("none")}},{label:"Loop",width:50,onClick:function(){m.select("loop")}},{label:"Cut",width:50,onClick:function(){de.cutSelection()}},{label:"Copy",width:50,onClick:function(){de.copySelection()}},{label:"Paste",onClick:function(){de.pasteSelection()}}];[{label:"Load",onClick:function(){ye.trigger(ce.showView,"diskop_samples_load")}},{label:"Play",onDown:function(){ht.handleNoteOn(ht.getPrevIndex())},onUp:function(){ht.handleNoteOff(ht.getPrevIndex()),ht.clearInputNotes(),m.stop()}},{label:"Range",onDown:function(){m.playSection("range")},onUp:function(){ht.handleNoteOff(ht.getPrevIndex()),ht.clearInputNotes(),m.stop()}},{label:"Loop",onDown:function(){m.playSection("loop")},onUp:function(){ht.handleNoteOff(ht.getPrevIndex()),ht.clearInputNotes(),m.stop()}},{label:"Stop",onClick:function(){ht.clearInputNotes(),m.stop()}},{label:"More",onClick:function(){F.toggle(),L.toggle(),B.toggle(),R.toggle(),v.toggle(),b.toggle(),u.refresh()}}].forEach(function(e){var t=de.Assets.generate("buttonLight");t.setLabel(e.label),t.onClick=e.onClick,t.onDown=e.onDown,t.onTouchUp=e.onUp,u.addChild(t),D.push(t)});var F=de.buttonGroup("Display",o),L=de.buttonGroup("Select",d),B=de.buttonGroup("Edit",s),R=de.buttonGroup("Volume",l);u.addChild(F),u.addChild(L),u.addChild(B),u.addChild(R);var V=de.button();V.setProperties({background:de.Assets.panelDarkGreyScale9,activeBackground:de.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Loop",font:fontSmall,paddingTop:2,paddingTopActive:2,paddingLeft:20}),V.onDown=function(){n("loop")},u.addChild(V);var U=de.checkbox();U.onToggle=function(e){var t=ot.getInstrument(a);t&&(t.sample.loop.enabled=e),S.setDisabled(!e),y.setDisabled(!e),m.refresh()},u.addChild(U);var W=de.button();return W.setProperties({background:de.Assets.panelDarkGreyScale9,activeBackground:de.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Vibrato",font:fontSmall,paddingTop:2,paddingTopActive:2}),W.onDown=function(){n("vibrato")},u.addChild(W),u.onShow=function(){ht.setFocusElement(u),u.onResize()},u.onKeyDown=function(e,t){if(u.visible)switch(e){case 37:return m.scroll(-1),!0;case 39:return m.scroll(1),!0;case 46:return de.deleteSelection(),!0}},u.onResize=function(){if(u.isVisible()){u.clearCanvas();var e=130,t=w.height-e-10,n=Math.ceil(w.width/4),i=0,a=2*n;w.width<170&&(n=Math.ceil(w.width/2),i=t=Math.floor(t/2),a=0),m.setPosition(ct.col2X,20+ct.defaultMargin+8),m.setSize(ct.col4W,u.height-m.top-e-28-8),v.setPosition(ct.col2X,m.top+m.height+ct.defaultMargin+30),v.setSize(ct.col2W,e),b.setPosition(ct.col4X,v.top),b.setSize(ct.col2W,e),B.setSize(ct.col1W,e),F.setSize(ct.col1W,e),L.setSize(ct.col1W,e),R.setSize(ct.col1W,e),F.setPosition(ct.col2X,m.top+m.height+ct.defaultMargin+30),L.setPosition(ct.col3X,F.top),B.setPosition(ct.col4X,F.top),R.setPosition(ct.col5X,F.top);var r=0,o=100;ot.inFTMode()&&(r=40,o=0),h.setProperties({top:ct.defaultMargin,left:ct.col2X+71,width:ct.col4W-71-25-ct.defaultMargin-r}),f.setProperties({top:ct.defaultMargin,left:h.left+h.width+ct.defaultMargin+r}),g.setProperties({top:ct.defaultMargin,width:20,height:20,left:h.left+h.width+ct.defaultMargin-2+o}),p.setProperties({top:ct.defaultMargin,width:20,height:20,left:h.left+h.width+ct.defaultMargin+18+o}),w.setProperties({left:0,top:0,width:ct.col1W,height:u.height}),x.setProperties({left:ct.col2X,top:1,width:68,height:28}),k.setProperties({left:0,top:0,width:n,height:t}),P.setProperties({left:n,top:0,width:n,height:t}),_.setProperties({left:a,top:i,width:n,height:t}),C.setProperties({left:a+n,top:i,width:n,height:t});var s=m.top+m.height+ct.defaultMargin,l=ct.col4W/D.length;D.forEach(function(e,t){e.setProperties({width:l,height:28,left:ct.col2X+l*t,top:s})}),V.setProperties({width:ct.col1W/2,height:18,left:2,top:v.top}),U.setPosition(V.left+2,V.top+2),W.setProperties({width:V.width,height:V.height,left:V.left+V.width,top:V.top});S.setProperties({left:0,top:V.top+24,width:ct.col1W,height:34}),y.setProperties({left:0,top:V.top+24+34,width:ct.col1W,height:34}),I.setProperties({left:0,top:V.top+24+68,width:ct.col1W,height:34}),T.setProperties({left:0,top:W.top+22,width:ct.col1W,height:30}),M.setProperties({left:0,top:W.top+22+30,width:ct.col1W,height:30}),A.setProperties({left:0,top:W.top+22+60,width:ct.col1W,height:30});var d=Math.floor((ct.col1W-4)/4),c=ct.col1W-4*d;E.forEach(function(e,t){e.setProperties({left:c+t*d,top:W.top+22+90,width:d,height:17})})}},ye.on(ce.instrumentChange,function(e){x.setValue(a=e,!0);var t=ot.getInstrument(e);t?(h.setValue(t.name,!0),P.setValue(t.getFineTune(),!0),_.setValue(t.fadeout||0,!0),T.setValue(t.vibrato.rate||0,!0),M.setValue(t.vibrato.depth||0,!0),A.setValue(t.vibrato.sweep||0,!0),i(t.vibrato.type||0),t.sample&&(S.setMax(t.sample.length,!0),y.setMax(t.sample.length,!0),k.setValue(t.sample.volume,!0),C.setValue(t.sample.panning||0,!0),S.setValue(t.sample.loop.start,!0),y.setValue(t.sample.loop.length,!0),I.setValue(t.sample.relativeNote,!0),U.setState(t.sample.loop.enabled,!0),8===t.sample.bits?(g.setActive(!0),p.setActive(!1)):(g.setActive(!1),p.setActive(!0))),m.setInstrument(t),v.setInstrument(t),b.setInstrument(t)):(m.setInstrument(),v.setInstrument(),b.setInstrument(),h.setValue("",!0),k.setValue(0,!0),C.setValue(0,!0),P.setValue(0,!0),S.setValue(0,!0),y.setValue(0,!0),I.setValue(0,!0),_.setValue(0,!0))}),ye.on(ce.samplePlay,function(e){u.visible&&e&&e.instrumentIndex===a&&m.play(e.startPeriod,e.effects&&e.effects.offset?e.effects.offset.value:0)}),ye.on(ce.songPropertyChange,function(e){x.setMax(e.instruments.length-1)}),ye.on(ce.trackerModeChanged,function(e){P.setMax(e===Pe?7:127,!0),P.setMin(e===Pe?-8:-128,!0);var t=ot.getInstrument(a);t&&P.setValue(t.getFineTune(),!0),v.setDisabled(!ot.inFTMode()),b.setDisabled(!ot.inFTMode()),I.setDisabled(!ot.inFTMode()),T.setDisabled(!ot.inFTMode()),M.setDisabled(!ot.inFTMode()),A.setDisabled(!ot.inFTMode()),_.setDisabled(!ot.inFTMode()),C.setDisabled(!ot.inFTMode()),x.setMax(ot.getMaxInstruments()),e===Pe?(S.setProperties({step:2}),y.setProperties({step:2}),t&&(t.sample.loop.start=2*Math.floor(t.sample.loop.start/2),t.sample.loop.length=2*Math.floor(t.sample.loop.length/2),S.setValue(t.sample.loop.start,!0),y.setValue(t.sample.loop.length,!0)),n("loop")):(S.setProperties({step:1}),y.setProperties({step:1})),u.onResize()}),ye.on(ce.samplePropertyChange,function(e){ot.getInstrument(a)&&(void 0!==e.loopStart&&S.setValue(e.loopStart,e.internal),void 0!==e.loopLength&&y.setValue(e.loopLength,e.internal))}),ye.on(ce.sampleIndexChange,function(e){if(u.visible&&e===a){ot.getInstrument(a);ye.trigger(ce.instrumentChange,a)}}),u},de.sliderBox=function(e){function t(t){x.forEach(function(e){if(void 0!==t[e])switch(e){case"label":o=t[e];break;case"value":l=s=t[e];break;case"min":d=t[e];break;case"max":c=t[e];break;case"step":0;break;case"onChange":i=t[e];break;case"font":n=t[e];break;case"vertical":a=!!t[e],k&&k.setProperties({vertical:a});break;default:r[e]=t[e]}})}var n,i,a,r=de.element(),o="",s=0,l=0,d=0,c=100,u=4,h=0,f=0,g=0,p=0,m=10,v=10,b=!(r.type="sliderBox"),w=lt.getImage("line_ver"),x=["left","top","width","height","name","label","value","onChange","min","max","step","vertical","font","trackUndo","undoLabel","undoInstrument"];e&&t(e),9999<c&&(u=5);var k=de.rangeSlider({min:d,max:c,height:20,width:20,vertical:!!a,onChange:function(e){e!==s&&r.setValue(e)}});r.addChild(k);var P=de.numberDisplay({min:d,max:c,padLength:4,size:"small",onChange:function(e){e!==s&&r.setValue(e)}});return P.paddingBottom=-1,r.addChild(P),r.setProperties=function(e){t(e),r.setSize(r.width,r.height),r.setPosition(r.left,r.top)},r.setValue=function(e,t){if(e!==s&&(l=s),k.setValue(s=e,t),P.setValue(s,t),r.refresh(),!t&&i){if(r.trackUndo){var n=_t.createValueUndo(r);n.name=r.undoLabel||"Change "+r.name,r.undoInstrument&&(n.instrument=ot.getCurrentInstrumentIndex(),n.id+=n.instrument),_t.registerEdit(n)}i(s)}},r.getValue=function(){return s},r.getPrevValue=function(){return l},r.setMax=function(e,t){c=e,!t&&c<s&&r.setValue(c),k.setMax(c,t),P.setMax(c,t)},r.setMin=function(e,t){d=e,!t&&s<d&&r.setValue(d),k.setMin(d,t),P.setMin(d,t)},r.setDisabled=function(e){b=e,r.refresh(),r.ignoreEvents=b},r.render=function(e){if(e=!!e,r.needsRendering&&(r.clearCanvas(),k.render(),P.render(),n?n.write(r.ctx,o,h,f,0):(r.ctx.fillStyle="white",r.ctx.fillText(o,h,f)),a&&r.ctx.drawImage(w,r.width-2,0,2,r.height),b&&(r.ctx.fillStyle="rgba(34, 49, 85, 0.6)",r.ctx.fillRect(1,0,r.width-1,r.height))),r.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)},r.onMouseWheel=function(e){0<e.mouseWheels[0]?c<++s&&(s=c):--s<d&&(s=d),r.setValue(s)},k.onMouseWheel=r.onMouseWheel,r.onResize=function(){m=40,v=20,5==u&&(m=48,g-=8),a?(k.setSize(20,r.height-36),k.setPosition(Math.floor((r.width-20)/2),0),g=Math.floor((r.width-40)/2),p=r.height-32,h=Math.floor((r.width-n.getTextWidth(o,0))/2),f=r.height-10):(k.setSize(r.width,20),k.setPosition(0,r.height-20),g=r.width-40,p=2),P.setSize(m,v),P.setPosition(g,p)},r},de.spinBox=function(e){function t(e){void 0!==e.size&&(r=e.size),void 0!==e.label&&(o=e.label),void 0!==e.labels&&(i=e.labels),void 0!==e.font&&(a=e.font),void 0!==e.step&&(s=e.step)}var n=de.numberDisplay(e);n.type="spinBox";var i,a,r="medium",o="",s=1;e&&t(e);var l=de.Assets.generate("button20_20");l.onDown=function(){n.isDisabled||(n.updateValue(n.getValue()-s),de.ticker.onEachTick4(function(){n.updateValue(n.getValue()-s)},10))},l.onTouchUp=function(){de.ticker.onEachTick4()},l.setProperties({name:"buttonDown",label:"↓"}),n.addChild(l);var d=de.Assets.generate("button20_20");d.onDown=function(){n.isDisabled||(n.updateValue(n.getValue()+s),de.ticker.onEachTick4(function(){n.updateValue(n.getValue()+s)},10))},d.onTouchUp=function(){de.ticker.onEachTick4()},d.setProperties({name:"buttonUp",label:"↑"}),n.addChild(d);var c=n.setProperties;return n.setProperties=function(e){t(e),c&&c(e)},n.renderInternal=function(){o&&(a?a.write(n.ctx,o,6,11,0):(n.ctx.fillStyle="white",n.ctx.fillText(o,10,10))),d.render(),l.render()},n.onResize=function(){i&&i.forEach(function(e){e.width<=n.width&&(o=e.label)}),"big"===r?(d.setProperties({left:n.width-l.width,height:Math.floor(n.height/2),top:0}),l.setProperties({left:d.left,height:d.height,top:n.height-d.height}),n.paddingLeft=2,n.paddingRight=d.width,n.paddingBottom=-1,n.paddingTop=-1):(l.setProperties({left:n.width-l.width,top:3}),d.setProperties({left:n.width-d.width-l.width,top:3}),n.paddingLeft=d.left-8*n.padLength-10-4,n.paddingRight=d.width+l.width+1,n.paddingBottom=n.height-d.height-8)},n};var ft,gt,pt,mt,vt,bt,wt,xt,kt,Pt,Ct,St,yt,_t=(pt={undo:[],redo:[]},(gt={}).registerEdit=function(e){var t=!0;if(!ft){if(pt.undo.length)switch(e.type){case x:var n=pt.undo[pt.undo.length-1];n&&n.type===e.type&&n.id===e.id&&(t=!1,n.to=e.to)}t&&(pt.undo.push(e),100<pt.undo.length&&pt.undo.shift(),pt.redo=[])}},gt.undo=function(){if(pt.undo.length){var e=pt.undo.pop();switch(ft=!0,e.instrument&&e.instrument!==ot.getCurrentInstrumentIndex()&&ot.setCurrentInstrumentIndex(e.instrument),e.type){case b:case w:case v:case a:var t=ot.getSong().patterns[e.id];e.id!==ot.getCurrentPattern()&&ot.setCurrentPattern(e.id),e.data.forEach(function(e){t&&(t[e.position.row][e.position.track]||new Nt).populate(e.from)}),ye.trigger(ce.patternChange,e.id);break;case x:e.target.setValue(e.from);break;case k:e.target===P&&(e.undo=!0,e.redo=!1,ye.trigger(ce.showView,"sample"),ye.trigger(ce.commandProcessSample,e))}pt.redo.push(e),ft=!1,e.name&&de.setStatus("Undo "+e.name)}},gt.redo=function(){if(pt.redo.length){var e=pt.redo.pop();switch(ft=!0,e.instrument&&e.instrument!==ot.getCurrentInstrumentIndex()&&ot.setCurrentInstrumentIndex(e.instrument),e.type){case b:case w:case v:case a:var n=ot.getSong().patterns[e.id];e.id!==ot.getCurrentPattern()&&ot.setCurrentPattern(e.id),e.data.forEach(function(e){if(n){var t=n[e.position.row][e.position.track]||new Nt;e.to?t.populate(e.to):t.clear()}}),ye.trigger(ce.patternChange,e.id);break;case x:e.target.setValue(e.to);break;case k:e.target===P&&(e.undo=!1,e.redo=!0,ye.trigger(ce.showView,"sample"),ye.trigger(ce.commandProcessSample,e))}pt.undo.push(e),ft=!1,e.name&&de.setStatus("Redo "+e.name)}},gt.createNoteUndo=function(e,t,n,i){return{target:a,type:b,id:e,data:[{position:{track:t,row:n},from:i.duplicate()}]}},gt.createTrackUndo=function(e){return{target:a,type:v,id:e,data:[]}},gt.createPatternUndo=function(e){return{target:a,type:a,id:e,data:[]}},gt.createRangeUndo=function(e){return{target:a,type:w,id:e,data:[]}},gt.createValueUndo=function(e){return{target:e,type:x,id:e.name,from:e.getPrevValue(),to:e.getValue()}},gt.createSampleUndo=function(e,t,n){return{target:P,type:k,id:"sample"+ot.getCurrentInstrumentIndex(),instrument:ot.getCurrentInstrumentIndex(),from:t||0,to:n||0,action:e}},gt.addNote=function(e,t,n,i){var a={position:{track:t,row:n},from:i?i.duplicate():{}};return e.data.push(a),a},gt.getHistory=function(){return pt},gt.clear=function(){pt={undo:[],redo:[]}},gt.lock=function(){ft=!0},gt.unLock=function(){ft=!1},gt.canUndo=function(){return 0<pt.undo.length},gt.canRedo=function(){return 0<pt.redo.length},gt.getUndoLabel=function(){var e="";return pt.undo.length&&(e=pt.undo[pt.undo.length-1].name||""),"Undo "+e},gt.getRedoLabel=function(){var e="";return pt.redo.length&&(e=pt.redo[pt.redo.length-1].name||""),"Redo "+e},ye.on(ce.commandUndo,gt.undo),ye.on(ce.commandRedo,gt.redo),gt);de.ticker=(St=Ct=0,yt=!(Pt={}),Pt.onEachTick2=function(e,t){xt=0,bt=t||0,yt=(mt=e)||vt},Pt.onEachTick4=function(e,t){kt=0,wt=t||0,vt=e,yt=mt||vt},ye.on(ce.screenRefresh,function(){yt&&(Ct=1-Ct)&&(St=1-St,mt&&bt<++xt&&mt(),St&&vt&&wt<++kt&&vt())}),Pt),de.WaveForm=function(){function h(e){var t,n=p.sample.loop.start||0;if(e===F)return n<T||M<n?-10:(A=M-T,t=Math.floor((n-T)/A*k.width),Math.max(5<T?0:5,t));var i=n+p.sample.loop.length;return i<T||M<i?-10:(t=Math.floor((i-T)/A*k.width),Math.min(t,k.width-(w-6<M?6:0)))}function f(e){var t;if(e===B)return P<T||M<P?-10:(A=M-T,t=Math.floor((P-T)/A*k.width),Math.max(5<T?0:5,t));var n=P+S;return n<T||M<n?-10:(t=Math.floor((n-T)/A*k.width),Math.min(t,k.width-(w-6<M?6:0)))}function d(e){var t={};return S?(t.tail=g.slice(P+S),t.range=g.slice(P,P+S),t.head=g.slice(0,P)):e?(t.range=[],t.tail=g.slice(P),t.head=g.slice(0,P)):(t.tail=[],t.range=g.slice(0,g.length),t.head=[]),t}function c(e){g=e.head.concat(e.range).concat(e.tail),p.sample.data=g,p.sample.length=g.length,s=!0,ye.trigger(ce.instrumentChange,ot.getCurrentInstrumentIndex()),s=!1,V.refresh(),k.refresh()}function i(){var e=p.sample.loop.start,t=p.sample.loop.length,n=p.sample.length;e<0&&(e=0),t<0&&(t=0),n<e+t&&(n<e&&(e=n),t=n-e),e===p.sample.loop.start&&t===p.sample.loop.length||(p.sample.loop.start=e,p.sample.loop.length=t,s=!0,ye.trigger(ce.instrumentChange,ot.getCurrentInstrumentIndex()),s=!1,V.refresh(),k.refresh())}function n(e){(e.loopStart||e.loopLength)&&(p.sample.loop.start=e.loopStart||0,p.sample.loop.length=e.loopLength||0,s=!0,ye.trigger(ce.instrumentChange,ot.getCurrentInstrumentIndex()),s=!1)}var g,p,m,a,v,b,w,r,o,x,s,k=de.element(),P=-1,C=-1,S=0,l=0,y=0,u=0,_=!(k.name="Waveform"),I=1,T=0,M=0,A=0,E=[],D=0,F=1,L=2,B=3,R=4,V=de.element(),U=de.scale9Panel(0,0,k.width,k.height,{img:lt.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});U.ignoreEvents=!0;var W=de.scale9Panel(1,0,100,18,{img:lt.getImage("bar"),left:2,top:2,right:3,bottom:3});return W.onDragStart=function(){W.startDragIndex=T,W.startLeft=W.left},W.onDrag=function(e){var t=W.startLeft+e.deltaX,n=k.width-W.width-1;t=Math.max(t,1),t=Math.min(t,n),W.setPosition(t,W.top),A=M-T,T=Math.floor((w-A)*(t/(n-1))),M=T+A,V.refresh()},k.addChild(W),ye.on(ce.screenRefresh,function(){(m||a)&&k.isVisible()&&k.refresh()}),k.scroll=function(e){var t=W.left+e,n=k.width-W.width-1;t=Math.max(t,1),t=Math.min(t,n),W.setPosition(t,W.top),A=M-T,T=Math.floor((w-A)*(t/(n-1))),M=T+A,V.refresh()},k.onDragStart=function(e){var t=e.startX;if(p.sample.loop.enabled){var n=h(L);if(Math.abs(t-n)<5)return l=L,void(u=p.sample.loop.length);if(n=h(F),Math.abs(t-n)<5)return l=F,void(u=p.sample.loop.start)}return S&&(n=f(R),Math.abs(t-n)<5)?(l=R,void(u=S)):0<=P&&(n=f(B),Math.abs(t-n)<5)?(l=B,void(u=P)):(a=!0,r=o=e.startX,P=C=Math.round(T+r*(p.sample.length/k.width/I)),void ye.trigger(ce.samplePropertyChange,{rangeLength:S=0}))},k.onDrag=function(e){var t=p.sample.length/k.width/I;if(l&&(l===F||l===L)){y=l;var n=e.deltaX,i=u+Math.round(t*n);ot.inFTMode()||(i-=i%2);var a={};return l===F?(i=Math.min(i,w-2),i=Math.max(i,0),a.loopStart=i,w<a.loopStart+p.sample.loop.length&&(a.loopLength=w-a.loopStart)):(i=Math.max(i,2),i=Math.min(i,w-p.sample.loop.start),a.loopLength=i),ye.trigger(ce.samplePropertyChange,a),void k.refresh()}if(l&&(l===B||l===R))return y=l,n=e.deltaX,i=u+Math.round(t*n),l===B?(i=Math.min(i,w-2),i=Math.max(i,0),w<(P=i)+S&&(S=w-P)):(i=Math.max(i,2),i=Math.min(i,w-P),S=i),ye.trigger(ce.samplePropertyChange,{rangeLength:S}),void k.refresh();o=e.x,C=Math.round(T+o*t),C=Math.max(C,0),S=C-P,ye.trigger(ce.samplePropertyChange,{rangeLength:Math.abs(S)})},k.onTouchUp=function(e){a&&C<P&&(S=P-C,C=(P=C)+S,k.refresh()),l=0,_=a=!1,S&&de.setSelection(k.processSelection)},k.onDown=function(e){_=!0},k.onHover=function(e){if(!a&&!l&&!_){var t=y;_||(y=0);var n=k.eventX;if(0<=P&&(i=f(B),Math.abs(n-i)<5))return void(t!==(y=B)&&k.refresh());if(0<=C){var i=f(R);if(Math.abs(n-i)<5)return void(t!==(y=R)&&k.refresh())}if(p.sample.loop.enabled){if(i=h(L),Math.abs(n-i)<5)return void(t!==(y=L)&&k.refresh());if(i=h(F),Math.abs(n-i)<5)return void(t!==(y=F)&&k.refresh())}t!==y&&k.refresh()}},k.onResize=function(){V.setPosition(0,0),V.setSize(k.width,k.height),W.setPosition(W.left,k.height-18),1<I&&W.setSize(Math.floor(k.width/I),18)},k.setInstrument=function(e){w=(p=e)?(g=p.sample.data).length:(g=void 0,0),ye.trigger(ce.samplePropertyChange,{sampleLength:w,loopLength:e?e.sample.loop.length:0,internal:!0}),s||(m=!1,k.zoom(1),C=P=-1,S=0,k.refresh())},k.play=function(e,t){1<I||(D=t=t||0,m=!0,v=(new Date).getTime(),b=_e.getSampleRateForPeriod(e),k.refresh())},k.playSection=function(e){"range"===e&&ht.handleNoteOn(ht.getPrevIndex(),void 0,P),"loop"===e&&ht.handleNoteOn(ht.getPrevIndex(),void 0,p.sample.loop.start)},k.stop=function(){m=!1,k.refresh()},k.zoom=function(e){var t=!1;if("range"===e)if(S){M=(T=P)+(A=S);var n=k.width/(I=w/A),i=k.width-n-2;W.setPosition(Math.floor(T/(w-A)*i),W.top),t=!0}else e=1;"loop"===e&&(p.sample.loop.enabled&&(M=(T=p.sample.loop.start)+(A=p.sample.loop.length),i=k.width-(n=k.width/(I=w/A))-2,W.setPosition(Math.floor(T/(w-A)*i),W.top)),t=!0),1!==e&&1!==I||(I=1,T=0),t||(I*=e,I=Math.max(I,1),A=Math.floor(w/I),M=T+A),W.setSize(Math.floor(k.width/I),18),(x=1<I)&&w<M&&(T=w-A,M=w,W.setPosition(k.width-W.width-1,W.top)),V.refresh(),k.refresh()},k.select=function(e,t,n){switch(e){case"all":P=0,S=C=g.length,k.refresh();break;case"none":C=P=-1,S=0,k.refresh();break;case"loop":2<p.sample.loop.length&&(C=(P=p.sample.loop.start)+(S=p.sample.loop.length),k.refresh());break;case"start":S=C-(P=0),k.refresh();break;case"end":S=(C=g.length)-P,k.refresh();break;case"range":C=(P=t)+(S=n),k.refresh()}ye.trigger(ce.samplePropertyChange,{rangeLength:S}),de.setSelection(k.processSelection)},k.render=function(){if(this.needsRendering){if(V.needsRendering){if(V.clearCanvas(),V.ctx.fillStyle="rgb(13, 19, 27)",V.ctx.fillRect(0,0,k.width,k.height),V.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",U.width!==k.width&&U.setSize(k.width,k.height),V.ctx.drawImage(U.render(!0),0,0,k.width,k.height),g&&g.length&&k.width){1===I&&(T=0,M=w);var e=(A=M-T)/k.width,t=k.height/2;V.ctx.beginPath();for(var n=k.height/2-2,i=0;i<k.width;i++){var a=Math.floor(i*e),r=g[T+a]*-n;0===i?V.ctx.moveTo(i,t+r):V.ctx.lineTo(i,t+r)}V.ctx.stroke()}V.needsRendering=!1}if(k.ctx.drawImage(V.canvas,0,0),m&&w){var o=(new Date).getTime();a=D+b*(o-v)/1e3;if(p.sample.loop.enabled&&p.sample.loop.start<a){var s=(a=p.sample.loop.start+(a-p.sample.loop.start)%p.sample.loop.length)/w*k.width;k.ctx.fillStyle="rgb(241, 162, 71)",k.ctx.fillRect(s,0,1,k.height)}else if(w<a)m=!1;else{s=a/w*k.width;k.ctx.fillStyle="rgb(241, 162, 71)",k.ctx.fillRect(s,0,1,k.height)}}if(2<p.sample.loop.length||p.sample.loop.enabled){var l=p.sample.loop.enabled?"rgb(241, 220, 71)":"rgba(150, 150, 150,0.7)";k.ctx.fillStyle=l,y===F&&(k.ctx.fillStyle="white");var d=h(F);k.ctx.fillRect(d,0,1,k.height-1),k.ctx.fillRect(d-4,0,4,10),k.ctx.fillStyle=l,y===L&&(k.ctx.fillStyle="white"),d=h(L),k.ctx.fillRect(d,0,1,k.height-1),k.ctx.fillRect(d+1,0,4,10)}var c=-1,u=-1;0<=C&&(k.ctx.fillStyle=l="rgb(241, 131, 71)",y===R&&(k.ctx.fillStyle="white"),u=f(R),k.ctx.fillRect(u,0,1,k.height-1),k.ctx.fillRect(u+1,11,4,10)),0<=P&&(P<T?c=0:(k.ctx.fillStyle=l="rgb(241, 131, 71)",y===B&&(k.ctx.fillStyle="white"),c=f(B),k.ctx.fillRect(c,0,1,k.height-1),k.ctx.fillRect(c-4,11,4,10)),P+S<T&&(c=u=-1)),c!==u&&(0<=c&&(u=Math.min(u,k.width))<=0&&(u=k.width),k.ctx.fillStyle="rgba(241, 162, 71,0.1)",k.ctx.fillRect(c,0,u-c,k.height)),x&&W.render()}this.needsRendering=!1,k.parentCtx.drawImage(k.canvas,k.left,k.top,k.width,k.height)},k.adjustVolume=function(e){var t,n,i,a=d(),r=!1,o=_t.createSampleUndo(N,P,S);if(o.data=a.range.slice(0),o.name="Adjust Volume","max"===e){var s=0,l=0;for(n=0,i=a.range.length;n<i;n++)s=Math.min(s,a.range[n]),l=Math.max(l,a.range[n]);if(1<(t=1/Math.max(l,-s))){for(n=0,i=a.range.length;n<i;n++)a.range[n]=a.range[n]*t;r=!0}}if("fadein"===e){for(n=0,i=a.range.length-1;n<=i;n++)a.range[n]=a.range[n]*(t=n/i);r=!0}if("fadeout"===e){for(n=0,i=a.range.length-1;n<=i;n++)a.range[n]=a.range[n]*(t=1-n/i);r=!0}if(!r){if("number"==typeof e)for(t=1+1/e,n=0,i=a.range.length-1;n<=i;n++)a.range[n]=Math.min(Math.max(a.range[n]*t,-1),1);r=!0}r&&(o.dataTo=a.range.slice(0),_t.registerEdit(o),c(a))},k.reverse=function(){var e=d(),t=_t.createSampleUndo(N,P,S);t.data=e.range.slice(0),t.name="Reverse Sample",e.range=e.range.reverse(),t.dataTo=e.range.slice(0),_t.registerEdit(t),c(e)},k.invert=function(){var e=d(),t=_t.createSampleUndo(N,P,S);t.data=e.range.slice(0),t.name="Reverse Sample";for(var n=0,i=e.range.length-1;n<=i;n++)e.range[n]=-e.range[n];t.dataTo=e.range.slice(0),_t.registerEdit(t),c(e)},k.resample=function(e){var t=d(),n=[],i=_t.createSampleUndo(N,P,S);if(i.data=t.range.slice(0),i.name="Resample Sample",i.loopStart=p.sample.loop.start,i.loopLength=p.sample.loop.length,"up"===e){for(var a=0,r=t.range.length;a<r;a++)n.push(t.range[a]),n.push(t.range[a]);p.sample.loop.start=Math.floor(2*p.sample.loop.start),p.sample.loop.length=Math.floor(2*p.sample.loop.length),C=(P*=2)+(S*=2)}else{for(a=0,r=t.range.length;a<r;a+=2)n.push(t.range[a]);p.sample.loop.start=Math.floor(p.sample.loop.start/2),p.sample.loop.length=Math.floor(p.sample.loop.length/2),P=Math.floor(P/2),S=Math.floor(S/2),C=P+S}ot.inFTMode()||(p.sample.loop.start=p.sample.loop.start-p.sample.loop.start%2,p.sample.loop.length=p.sample.loop.length-p.sample.loop.length%2),i.dataTo=(t.range=n).slice(0),_t.registerEdit(i),c(t)},k.processSelection=function(e){if(k.isVisible())switch(e){case ue:return!1;case he:k.adjustVolume(0);break;case ge:case fe:if(0<S){var t=d();if(E=t.range.slice(0),e===fe)(n=_t.createSampleUndo(fe,P,S)).data=t.range.slice(0),n.name="cut sample",n.loopStart=p.sample.loop.start,n.loopLength=p.sample.loop.length,_t.registerEdit(n),t.range=[],c(t),i(),C=P+(S=0),ye.trigger(ce.samplePropertyChange,{rangeLength:S}),k.refresh()}break;case O:if(0<S)(t=d()).range=[],c(t),C=P+(S=0),ye.trigger(ce.samplePropertyChange,{rangeLength:S}),k.refresh();break;case pe:var n;t=d(!0),P<0&&(P=g.length),(n=_t.createSampleUndo(pe,P,E.length)).name="paste sample",n.data=t.range.slice(0),n.dataTo=E.slice(0),n.loopStart=p.sample.loop.start,n.loopLength=p.sample.loop.length,_t.registerEdit(n),0<=P?t.range=E:t.tail=t.tail.concat(E),c(t),i(),setTimeout(function(){k.select("range",P,E.length)},10)}},ye.on(ce.commandSelectAll,function(){k.isVisible()&&k.select("all")}),ye.on(ce.commandProcessSample,function(e){if(k.isVisible()){if(e.undo)switch(e.action){case fe:k.select("range",e.from,0),(t=d(!0)).range=e.data,c(t),n(e),k.select("range",e.from,e.data.length);break;case pe:k.select("range",e.from,e.to),(t=d(!0)).range=e.data,c(t),n(e),k.select("range",e.from,e.data.length);break;case N:k.select("range",e.from,e.to),(t=d()).range=e.data,c(t),e.to&&k.select("range",e.from,e.data.length)}if(e.redo)switch(e.action){case fe:k.select("range",e.from,e.data.length),(t=d()).range=[],c(t),k.select("range",e.from,0);break;case pe:k.select("range",e.from,e.data.length||0),(t=d(!0)).range=e.dataTo,c(t),i(),k.select("range",e.from,e.dataTo.length);break;case N:var t;k.select("range",e.from,e.to),(t=d()).range=e.dataTo,c(t),e.to&&k.select("range",e.from,e.data.length)}}}),k},st.sprite=function(e){var t={};if(t.canvas=document.createElement("canvas"),t.ctx=t.canvas.getContext("2d"),e&&(e.width&&(t.canvas.width=e.width,t.canvas.height=e.height||e.width),e.img)){var n=t.canvas.width,i=t.canvas.height;t.ctx.drawImage(e.img,e.x||0,e.y||0,n,i,0,0,n,i)}return t},FilterChain=function(e){function n(){var e,t,n,i;if(o=r,v&&(d=d||((e=I.createBiquadFilter()).type="highshelf",e.frequency.value=3200,e.gain.value=y,e),o.connect(d),o=d),b&&(c=c||((t=I.createBiquadFilter()).type="peaking",t.frequency.value=1e3,t.Q.value=.5,t.gain.value=S,t),o.connect(c),o=c),w&&(u=u||((n=I.createBiquadFilter()).type="lowshelf",n.frequency.value=320,n.gain.value=C,n),o.connect(u),o=u),x&&(h=h||((i=I.createBiquadFilter()).type="lowpass",i.frequency.value=5e3,i),o.connect(h),o=h),k&&(f=f||I.createConvolver(),(g=g||I.createGain()).gain.value=0,o.connect(g),g.connect(f),s=f),P){var a=I.createWaveShaper();a.curve=function(e){for(var t,n="number"==typeof e?e:50,i=new Float32Array(44100),a=Math.PI/180,r=0;r<44100;++r)i[r]=(3+n)*(t=2*r/44100-1)*20*a/(Math.PI+n*Math.abs(t));return i}(400),a.oversample="4x"}m&&(p=p||_e.context.createStereoPanner(),o.connect(p),o=p),l=l||I.createGain(),o.connect(l),s&&s.connect(l),o=l}var t={};e=e||{volume:!0,panning:!0};var r,o,s,l,d,c,u,h,f,g,p,i=(e={volume:!0,panning:!0}).volume,m=e.panning&&_e.context.createStereoPanner,v=e.high,b=e.mid,w=e.low,x=e.lowPass,k=e.reverb,P=e.distortion,C=0,S=0,y=0,a=70,_=0,I=_e.context;return(r=I.createGain()).gain.value=1,o=r,t.lowValue=function(e){if(w){if(void 0!==e){u.gain.value=20*(C=e)}return C}},t.midValue=function(e){if(b){if(void 0!==e){c.gain.value=20*(S=e)}return S}},t.highValue=function(e){if(v){if(void 0!==e){d.gain.value=20*(y=e)}return y}},t.lowPassFrequencyValue=function(e){if(x){var t=_e.context.sampleRate/2,n=Math.log(t/40)/Math.LN2,i=Math.pow(2,n*(e-1));h.frequency.value=t*i}},t.lowPassQualityValue=function(e){x&&(h.Q.value=30*e)},t.reverbValue=function(e){if(k){if(!f.buffer){var t=le.audio["data/reverb/sportcentre.m4a"];if(t)f.buffer=t;else(r={load:function(e,t,n){r.type=t||T,r.loadCount=0,r.max=e.length,r.next=n;for(var i=0,a=e.length;i<a;i++)o(e[i])}},o=function(t){if(r.type==T){var e=new Image;e.onload=function(){le.images[t]=this,++r.loadCount==r.max&&r.next&&r.next()},e.onerror=function(){alert("BufferLoader: XHR error")},e.src=t}if(r.type==M){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",t,!0),n.onload=function(){_e.context.decodeAudioData(n.response,function(e){e?(le.audio[t]=e,++r.loadCount==r.max&&r.next&&r.next()):alert("error decoding file data: "+t)},function(e){})},n.onerror=function(){alert("BufferLoader: XHR error")},n.send()}},r).load(["data/reverb/sportcentre.m4a"],M,function(){f.buffer=le.audio["data/reverb/sportcentre.m4a"]})}var r,o,n=parseInt(e)/100;g.gain.value=n*n}},t.volumeValue=function(e){if(i){if(void 0!==e){var t=(a=e)/100;l.gain.value=t*t}return a}},t.panningValue=function(e,t){if(m)return void 0!==e&&p.pan.setValueAtTime(_=e,t||_e.context.currentTime),_},t.setState=function(e,t){r.disconnect(),d&&d.disconnect(),c&&c.disconnect(),u&&u.disconnect(),h&&h.disconnect(),g&&g.disconnect(),p&&p.disconnect(),s=void 0,"high"===e&&(v=!!t),"mid"===e&&(b=!!t),"low"===e&&(w=!!t),"lowPass"===e&&(x=!!t),"reverb"===e&&(k=!!t),"panning"===e&&(m=!!t&&_e.context.createStereoPanner),n()},t.input=function(){return r},t.output=function(){return o},n(),t.volumeValue(a),t};var It,Tt,Mt=((Tt={}).init=function(){if(!navigator.requestMIDIAccess)return!1;navigator.requestMIDIAccess().then(function(e){It=!0;var t=Array.from(e.inputs.values());t.forEach(function(e){e.onmidimessage=At}),t.length&&ye.trigger(ce.midiIn)},function(){})},Tt.enable=function(){Mt.init()},Tt.disable=function(){It=!1,ye.trigger(ce.midiIn)},Tt.isEnabled=function(){return!!It},Tt);function At(e){if(It){var t=e.data;switch(t[0]){case 128:case 129:Et(t[1]);break;case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:(t[2]?function(e,t){var n,i=e-47,a=ht.getCurrentOctave();"enabled"===Se.midi&&(n=t+1>>1);ht.handleNoteOn(i+12*a,void 0,void 0,n)}:Et)(t[1],t[2]);break;case 176:break;case 192:ot.setCurrentInstrumentIndex(t[1]+1)}ye.trigger(ce.midiIn)}}function Et(e){var t=e-47,n=ht.getCurrentOctave();ht.handleNoteOff(t+12*n,"enabled"===Se.midi)}var Dt,Ft,Lt=(Ft={unknown:{name:"UNKNOWN"},unsupported:{name:"UNSUPPORTED"},mod_ProTracker:{name:"PROTRACKER",isMod:!0,loader:function(){return Rt()}},mod_SoundTracker:{name:"SOUNDTRACKER",isMod:!0,loader:function(){return Vt()}},mod_FastTracker:{name:"FASTTRACKER",isMod:!0,loader:function(){return Bt()}},sample:{name:"SAMPLE",isSample:!0},zip:{name:"ZIP"}},(Dt={}).detect=function(a,e){function r(e){return e<128}var o=a.length,t="";if("Extended Module: "==(t=a.readString(17,0)))return Ft.mod_FastTracker;if(1100<o&&(t=a.readString(4,1080)),"M.K."==t)return Ft.mod_ProTracker;if("M!K!"==t)return Ft.mod_ProTracker;if("M&K!"==t)return Ft.mod_ProTracker;if("FLT4"==t)return Ft.mod_ProTracker;if("2CHN"==t)return Ft.mod_ProTracker;if("6CHN"==t)return Ft.mod_ProTracker;if("8CHN"==t)return Ft.mod_ProTracker;if("10CH"==t)return Ft.mod_ProTracker;if("12CH"==t)return Ft.mod_ProTracker;if("14CH"==t)return Ft.mod_ProTracker;if("16CH"==t)return Ft.mod_ProTracker;if("18CH"==t)return Ft.mod_ProTracker;if("20CH"==t)return Ft.mod_ProTracker;if("22CH"==t)return Ft.mod_ProTracker;if("24CH"==t)return Ft.mod_ProTracker;if("26CH"==t)return Ft.mod_ProTracker;if("28CH"==t)return Ft.mod_ProTracker;if("30CH"==t)return Ft.mod_ProTracker;if("32CH"==t)return Ft.mod_ProTracker;var n="";return e&&4<e.length&&(n=e.substr(e.length-4)),".wav"==(n=n.toLowerCase())||".mp3"==n||".iff"==n?Ft.sample:".zip"==n||"PK"==a.readString(2,0)?Ft.zip:e&&0<=e.indexOf(".")&&1624<o&&function(){a.goto(0);for(var e=0;e<20;e++)if(!r(a.readByte()))return;for(var t=0,n=0,i=0;i<15;i++){for(e=0;e<22;e++)if(!r(a.readByte()))return;if(a.jump(-22),"st-"==a.readString(22).toLowerCase().substr(0,3)&&(n+=10),20<n)return 1;t+=a.readWord(),a.jump(6)}return!(o<2*t+1624)}()?Ft.mod_SoundTracker:Ft.sample},Dt),Bt=function(){var _={load:function(e,t){function n(e){for(e.points=[],b=0;b<12;b++)e.points.push(e.raw.slice(2*b,2*b+2));return 1&e.type&&(e.enabled=!0),2&e.type&&(e.sustain=!0),4&e.type&&(e.loop=!0),e}ot.setTrackerMode(Ce,!0),ot.clearInstruments(1);var i={},a={patterns:[],instruments:[]};e.litteEndian=!0,e.goto(17),a.title=e.readString(20),e.jump(1),i.trackerName=e.readString(20),i.trackerVersion=e.readByte(),i.trackerVersion=e.readByte()+"."+i.trackerVersion,i.headerSize=e.readDWord(),i.songlength=e.readWord(),i.restartPosition=e.readWord(),i.numberOfChannels=e.readWord(),i.numberOfPatterns=e.readWord(),i.numberOfInstruments=e.readWord(),i.flags=e.readWord(),ot.useLinearFrequency=i.flags%2==1,i.defaultTempo=e.readWord(),i.defaultBPM=e.readWord();for(var r=[],o=0,s=0;s<i.songlength;++s)r[s]=e.readUbyte(),o<r[s]&&(o=r[s]);a.patternTable=r,a.length=i.songlength,a.channels=i.numberOfChannels,a.restartPosition=i.restartPosition+1;var l=60+i.headerSize;for(e.goto(l),s=0;s<i.numberOfPatterns;s++){var d=[],c={};c.headerSize=e.readDWord(),c.packingType=e.readUbyte(),c.patternLength=e.readWord(),c.patternSize=e.readWord(),e.goto(l+=c.headerSize);for(var u=0;u<c.patternLength;u++){var h,f=[];for(h=0;h<i.numberOfChannels;h++){var g=Nt(),p=e.readUbyte();128&p?(1&p&&g.setIndex(e.readUbyte()),2&p&&(g.instrument=e.readUbyte()),4&p&&(g.volumeEffect=e.readUbyte()),8&p&&(g.effect=e.readUbyte()),16&p&&(g.param=e.readUbyte())):(g.setIndex(p),g.instrument=e.readUbyte(),g.volumeEffect=e.readUbyte(),g.effect=e.readUbyte(),g.param=e.readUbyte()),f.push(g)}d.push(f)}e.goto(l+=c.patternSize),a.patterns.push(d)}var m=[];for(s=1;s<=i.numberOfInstruments;++s){var v=Ot();try{if(v.filePosition=e.index,v.headerSize=e.readDWord(),v.name=e.readString(22),v.type=e.readUbyte(),v.numberOfSamples=e.readWord(),v.samples=[],(v.sampleHeaderSize=0)<v.numberOfSamples){v.sampleHeaderSize=e.readDWord(),v.sampleHeaderSize=Math.max(v.sampleHeaderSize,40),200<v.sampleHeaderSize&&(v.sampleHeaderSize=40);for(var b=0;b<96;b++)v.sampleNumberForNotes.push(e.readUbyte());for(b=0;b<24;b++)v.volumeEnvelope.raw.push(e.readWord());for(b=0;b<24;b++)v.panningEnvelope.raw.push(e.readWord());v.volumeEnvelope.count=e.readUbyte(),v.panningEnvelope.count=e.readUbyte(),v.volumeEnvelope.sustainPoint=e.readUbyte(),v.volumeEnvelope.loopStartPoint=e.readUbyte(),v.volumeEnvelope.loopEndPoint=e.readUbyte(),v.panningEnvelope.sustainPoint=e.readUbyte(),v.panningEnvelope.loopStartPoint=e.readUbyte(),v.panningEnvelope.loopEndPoint=e.readUbyte(),v.volumeEnvelope.type=e.readUbyte(),v.panningEnvelope.type=e.readUbyte(),v.vibrato.type=e.readUbyte(),v.vibrato.sweep=e.readUbyte(),v.vibrato.depth=Math.min(e.readUbyte(),15),v.vibrato.rate=e.readUbyte(),v.fadeout=e.readWord(),v.reserved=e.readWord(),v.volumeEnvelope=n(v.volumeEnvelope),v.panningEnvelope=n(v.panningEnvelope)}}catch(e){}if(e.goto(l+=v.headerSize),0===v.numberOfSamples){var w=Ht();v.samples.push(w)}else{if(e.isEOF(1))break;for(var x=0;x<v.numberOfSamples;x++)(w=Ht()).length=e.readDWord(),w.loop.start=e.readDWord(),w.loop.length=e.readDWord(),w.volume=e.readUbyte(),w.finetuneX=e.readByte(),w.type=e.readUbyte(),w.panning=e.readUbyte()-128,w.relativeNote=e.readByte(),w.reserved=e.readByte(),w.name=e.readString(22),w.bits=8,v.samples.push(w),e.goto(l+=v.sampleHeaderSize);for(x=0;x<v.numberOfSamples;x++)if((w=v.samples[x]).length){l+=w.length,16&w.type&&(w.bits=16,w.type^=16,w.length>>=1,w.loop.start>>=1,w.loop.length>>=1),w.loop.type=w.type||0,w.loop.enabled=!!w.loop.type;var k=w.length,P=0;if(16===w.bits)for(var C=0;C<k;C++){var S=e.readShort()+P;S<-32768?S+=65536:32767<S&&(S-=65536),w.data.push((P=S)/32768)}else for(C=0;C<k;C++)(S=e.readByte()+P)<-128?S+=256:127<S&&(S-=256),w.data.push((P=S)/127);if(w.loop.type===B){var y=w.data.slice(w.loop.start,w.loop.start+w.loop.length);w.data=w.data.slice(0,w.loop.start+w.loop.length),w.data=w.data.concat(y.reverse()),w.loop.length=2*w.loop.length,w.length=w.loop.start+w.loop.length}e.goto(l)}}v.setSampleIndex(0),ot.setInstrument(s,v),m.push({label:s+" "+v.name,data:s})}return ye.trigger(ce.instrumentListChange,m),a.instruments=ot.getInstruments(),ot.setBPM(i.defaultBPM),ot.setAmigaSpeed(i.defaultTempo),_.validate(a),a},write:function(e){var t=ot.getSong(),n=ot.getInstruments(),i=ot.getTrackCount(),a="undefined"==typeof versionNumber?"dev":versionNumber,r=0;for(o=0;o<128;o++){r=Math.max(r,t.patternTable[o]||0)}var o,s=336;for(o=0;o<=r;o++)t.patterns[o]&&(s+=9+t.patterns[o].length*i*5);for(o=1;o<n.length;o++){var l=n[o];l&&l.hasSamples()?l.samples.forEach(function(e){var t=e.length;16===e.bits&&(t*=2),s+=283+t}):s+=29}var d=new D(new ArrayBuffer(s),!1);for(d.writeStringSection("Extended Module: ",17),d.writeStringSection(t.title,20),d.writeByte(26),d.writeStringSection("BassoonTracker "+a,20),d.writeByte(4),d.writeByte(1),d.writeDWord(276),d.writeWord(t.length),d.writeWord(0),d.writeWord(ot.getTrackCount()),d.writeWord(r+1),d.writeWord(n.length-1),d.writeWord(ot.useLinearFrequency?1:0),d.writeWord(ot.getAmigaSpeed()),d.writeWord(ot.getBPM()),o=0;o<256;o++)d.writeUByte(t.patternTable[o]||0);for(o=0;o<=r;o++){var c=t.patterns[o],u=0,h=0;if(c&&(h=(u=c.length)*i*5),d.writeDWord(9),d.writeUByte(0),d.writeWord(u),d.writeWord(h),c)for(var f=0,g=c.length;f<g;f++)for(var p=c[f],m=0;m<i;m++){var v=p[m]||{};d.writeUByte(v.index||0),d.writeUByte(v.instrument||0),d.writeUByte(v.volumeEffect||0),d.writeUByte(v.effect||0),d.writeUByte(v.param||0)}}for(o=1;o<n.length;o++)if((l=n[o])&&l.hasSamples()){l.numberOfSamples=l.samples.length,d.writeDWord(243),d.writeStringSection(l.name,22),d.writeUByte(0),d.writeWord(l.numberOfSamples);var b=(l.volumeEnvelope.enabled?1:0)+(l.volumeEnvelope.sustain?2:0)+(l.volumeEnvelope.loop?4:0),w=(l.panningEnvelope.enabled?1:0)+(l.panningEnvelope.sustain?2:0)+(l.panningEnvelope.loop?4:0);d.writeDWord(40);for(var x=0;x<96;x++)d.writeUByte(l.sampleNumberForNotes[x]||0);for(x=0;x<12;x++){var k=l.volumeEnvelope.points[x]||[0,0];d.writeWord(k[0]),d.writeWord(k[1])}for(x=0;x<12;x++)d.writeWord((k=l.panningEnvelope.points[x]||[0,0])[0]),d.writeWord(k[1]);d.writeUByte(l.volumeEnvelope.count||0),d.writeUByte(l.panningEnvelope.count||0),d.writeUByte(l.volumeEnvelope.sustainPoint||0),d.writeUByte(l.volumeEnvelope.loopStartPoint||0),d.writeUByte(l.volumeEnvelope.loopEndPoint||0),d.writeUByte(l.panningEnvelope.sustainPoint||0),d.writeUByte(l.panningEnvelope.loopStartPoint||0),d.writeUByte(l.panningEnvelope.loopEndPoint||0),d.writeUByte(b),d.writeUByte(w),d.writeUByte(l.vibrato.type||0),d.writeUByte(l.vibrato.sweep||0),d.writeUByte(l.vibrato.depth||0),d.writeUByte(l.vibrato.rate||0),d.writeWord(l.fadeout||0),d.writeWord(0);for(var P=0;P<l.numberOfSamples;P++){var C=l.samples[P],S=0;2<C.loop.length&&C.loop.enabled&&(S=1);var y=C.length,_=C.loop.start,I=C.loop.length;16===C.bits&&(S+=16,y*=2,_*=2,I*=2),d.writeDWord(y),d.writeDWord(_),d.writeDWord(I),d.writeUByte(C.volume),d.writeByte(C.finetuneX),d.writeUByte(S),d.writeUByte((C.panning||0)+128),d.writeUByte(C.relativeNote||0),d.writeUByte(0),d.writeStringSection(C.name||"",22)}for(P=0;P<l.numberOfSamples;P++){var T,M=0,A=0;if(16===(C=l.samples[P]).bits)for(x=0,g=C.length;x<g;x++)M=(T=Math.round(32768*C.data[x]))-A,A=T,M<-32768?M+=65536:32767<M&&(M-=65536),d.writeWord(M);else for(x=0,g=C.length;x<g;x++)M=(T=Math.round(127*C.data[x]))-A,A=T,M<-128?M+=256:127<M&&(M-=256),d.writeByte(M)}}else d.writeDWord(29),d.writeStringSection(l?l.name:"",22),d.writeUByte(0),d.writeWord(0);e&&e(d)},validate:function(e){function a(e,t){var n=!0;if(e.points&&e.points[0])if(0===e.points[0][0])for(var i=0,a=1;a<e.count;a++){var r=e.points[a];r&&i<r[0]?i=r[0]:n=!1}else n=!1;else n=!1;return n?e:"volume"===t?{raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6}:{raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5}}e.instruments.forEach(function(e){e.volumeEnvelope=a(e.volumeEnvelope,"volume"),e.panningEnvelope=a(e.panningEnvelope,"panning");for(var t=e.samples.length-1,n=0,i=e.sampleNumberForNotes.length;n<i;n++)e.sampleNumberForNotes[n]=Math.min(e.sampleNumberForNotes[n],t)})}};return _},Rt=function(){var e={load:function(e,t){ot.setTrackerMode(Pe,!0),ot.useLinearFrequency=!1,ot.clearInstruments(31);var n={patterns:[],restartPosition:1},i=4;n.typeId=e.readString(4,1080),n.title=e.readString(20,0),"2CHN"===n.typeId&&(i=2),"6CHN"===n.typeId&&(i=6),"8CHN"===n.typeId&&(i=8),"10CH"===n.typeId&&(i=10),"12CH"===n.typeId&&(i=12),"14CH"===n.typeId&&(i=14),"16CH"===n.typeId&&(i=16),"18CH"===n.typeId&&(i=18),"20CH"===n.typeId&&(i=20),"22CH"===n.typeId&&(i=22),"24CH"===n.typeId&&(i=24),"26CH"===n.typeId&&(i=26),"28CH"===n.typeId&&(i=28),"30CH"===n.typeId&&(i=30),"32CH"===n.typeId&&(i=32),n.channels=i;var a=0;for(u=1;u<=31;++u){var r=e.readString(22),o=e.readWord(),s=Ot();s.name=r,s.sample.length=s.sample.realLen=o<<1;var l=e.readUbyte();16<l&&(l%=16),7<l&&(l-=16),s.setFineTune(l),s.sample.volume=e.readUbyte(),s.sample.loop.start=e.readWord()<<1,s.sample.loop.length=e.readWord()<<1,s.sample.loop.enabled=2<s.sample.loop.length,s.sample.loop.type=E,s.pointer=a,a+=s.sample.length,s.setSampleIndex(0),ot.setInstrument(u,s)}n.instruments=ot.getInstruments(),e.goto(950),n.length=e.readUbyte(),e.jump(1);for(var d=[],c=0,u=0;u<128;++u)d[u]=e.readUbyte(),c<d[u]&&(c=d[u]);for(n.patternTable=d,e.goto(1084),u=0;u<=c;++u){for(var h=[],f=0;f<64;f++){var g,p=[];for(g=0;g<i;g++){var m=Nt(),v=e.readUint();m.setPeriod(v>>16&4095),m.effect=v>>8&15,m.instrument=v>>24&240|v>>12&15,m.param=255&v,p.push(m)}for(g=i;g<ot.getTrackCount();g++)p.push(Nt());h.push(p)}n.patterns.push(h)}var b=[];for(u=1;u<=31;u++)if(s=ot.getInstrument(u)){var w=s.sample.length;for(2<s.sample.loop.length&&Se.unrollShortLoops&&s.sample.loop.length<1e3&&(w=Math.min(w,s.sample.loop.start+s.sample.loop.length),s.sample.length=w),j=0;j<w;j++){var x=e.readByte();j<2&&(x=0),s.sample.data.push(x/127)}if((Se.unrollShortLoops||Se.unrollLoops)&&2<s.sample.loop.length){var k=Math.ceil(4e4/s.sample.loop.length)+1;Se.unrollLoops||(k=0);var P=!1,C=0;Se.unrollShortLoops&&s.sample.loop.length<1600&&(k=Math.floor(1e3/s.sample.loop.length),P=!0);for(var S=0;S<k;S++){var y=s.sample.loop.start,_=y+s.sample.loop.length;for(j=y;j<_;j++)s.sample.data.push(s.sample.data[j]);C+=s.sample.loop.length}P&&C&&(s.sample.loop.length+=C,s.sample.length+=C)}b.push({label:u+" "+s.name,data:u})}return ye.trigger(ce.instrumentListChange,b),n},write:function(e){var t=ot.getSong(),n=ot.getInstruments(),i=ot.getTrackCount(),a=ot.getPatternLength(),r=1084,o=0;for(l=0;l<128;l++){var s=t.patternTable[l]||0;o=Math.max(o,s)}r+=(o+1)*(256*i),32<ot.getInstruments().length&&de.showDialog("WARNING !!!//This file has more than 31 instruments.//Only the first 31 instruments will be included.");var l;for(l=1;l<=31;l++){(v=n[l])&&(v.setSampleIndex(0),r+=v.sample.length)}var d=new D(new ArrayBuffer(r),!0);for(d.writeStringSection(t.title,20),l=1;l<=31;l++){(v=n[l])?(v.sample.length=Math.min(v.sample.length,131070),d.writeStringSection(v.name,22),d.writeWord(v.sample.length>>1),d.writeUByte(v.sample.finetune),d.writeUByte(v.sample.volume),d.writeWord(v.sample.loop.start>>1),d.writeWord(v.sample.loop.length>>1)):d.clear(30)}for(d.writeUByte(t.length),d.writeUByte(127),l=0;l<128;l++){d.writeUByte(s=t.patternTable[l]||0)}for(d.writeString(8==i?"8CHN":"M.K."),l=0;l<=o;l++)for(var c=t.patterns[l],u=0;u<a;u++)for(var h=c[u],f=0;f<i;f++)if(h){var g=h[f],p=0,m=g.instrument;15<m&&(m=g.instrument-(p=16)),d.writeUint((p<<24)+(g.period<<16)+(m<<12)+(g.effect<<8)+g.param)}else d.writeUint(0);for(l=1;l<=31;l++){var v;if((v=n[l])&&v.sample.data&&v.sample.length)for(var b=0;b<v.sample.length;b++)d.writeByte(Math.round(127*(v.sample.data[b]||0)))}e&&e(d)}};return e},Vt=function(){var e={load:function(e,t){ot.setTrackerMode(Pe,!0),ot.useLinearFrequency=!1,ot.clearInstruments(15);var n={patterns:[],restartPosition:1};n.typeId="ST",n.channels=4,n.title=e.readString(20,0);var i=0;for(d=1;d<=15;++d){var a=e.readString(22),r=e.readWord(),o=Ot();o.name=a,o.sample.length=o.realLen=r<<1,o.sample.volume=e.readWord(),o.setFineTune(0),o.sample.loop.start=e.readWord(),o.sample.loop.length=e.readWord()<<1,o.sample.loop.enabled=2<o.sample.loop.length,o.sample.loop.type=E,o.pointer=i,i+=o.sample.length,o.setSampleIndex(0),ot.setInstrument(d,o)}n.instruments=ot.getInstruments(),e.goto(470),n.length=e.readUbyte(),n.speed=e.readUbyte();for(var s=[],l=0,d=0;d<128;++d)s[d]=e.readUbyte(),l<s[d]&&(l=s[d]);for(n.patternTable=s,e.goto(600),d=0;d<=l;++d){for(var c=[],u=0;u<64;u++){var h,f=[];for(h=0;h<4;h++){var g={},p=e.readUint();g.period=p>>16&4095,g.effect=p>>8&15,g.instrument=p>>24&240|p>>12&15,g.param=255&p,f.push(g)}for(h=4;h<ot.getTrackCount();h++)f.push({note:0,effect:0,instrument:0,param:0});c.push(f)}n.patterns.push(c)}var m=[];for(d=1;d<=15;d++)if(o=ot.getInstrument(d)){var v=o.sample.length;for(j=0;j<v;j++){var b=e.readByte();j<2&&(b=0),o.sample.data.push(b/127)}m.push({label:d+" "+o.name,data:d})}return ye.trigger(ce.instrumentListChange,m),n}};return e};!function(e){"use strict";function ue(){function l(e,t){for(var n=0;n|=1&e,e>>>=1,n<<=1,0<--t;);return n>>>1}var f=this;f.build_tree=function(e){var t,n,i,a=f.dyn_tree,r=f.stat_desc.static_tree,o=f.stat_desc.elems,s=-1;for(e.heap_len=0,e.heap_max=p,t=0;t<o;t++)0!==a[2*t]?(e.heap[++e.heap_len]=s=t,e.depth[t]=0):a[2*t+1]=0;for(;e.heap_len<2;)a[2*(i=e.heap[++e.heap_len]=s<2?++s:0)]=1,e.depth[i]=0,e.opt_len--,r&&(e.static_len-=r[2*i+1]);for(f.max_code=s,t=Math.floor(e.heap_len/2);1<=t;t--)e.pqdownheap(a,t);for(i=o;t=e.heap[1],e.heap[1]=e.heap[e.heap_len--],e.pqdownheap(a,1),n=e.heap[1],e.heap[--e.heap_max]=t,e.heap[--e.heap_max]=n,a[2*i]=a[2*t]+a[2*n],e.depth[i]=Math.max(e.depth[t],e.depth[n])+1,a[2*t+1]=a[2*n+1]=i,e.heap[1]=i++,e.pqdownheap(a,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e){var t,n,i,a,r,o,s=f.dyn_tree,l=f.stat_desc.static_tree,d=f.stat_desc.extra_bits,c=f.stat_desc.extra_base,u=f.stat_desc.max_length,h=0;for(a=0;a<=g;a++)e.bl_count[a]=0;for(s[2*e.heap[e.heap_max]+1]=0,t=e.heap_max+1;t<p;t++)u<(a=s[2*s[2*(n=e.heap[t])+1]+1]+1)&&(a=u,h++),s[2*n+1]=a,f.max_code<n||(e.bl_count[a]++,r=0,c<=n&&(r=d[n-c]),e.opt_len+=(o=s[2*n])*(a+r),l&&(e.static_len+=o*(l[2*n+1]+r)));if(0!==h){do{for(a=u-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[u]--,h-=2}while(0<h);for(a=u;0!==a;a--)for(n=e.bl_count[a];0!==n;)i=e.heap[--t],f.max_code<i||(s[2*i+1]!=a&&(e.opt_len+=(a-s[2*i+1])*s[2*i],s[2*i+1]=a),n--)}}(e),function(e,t,n){var i,a,r,o=[],s=0;for(i=1;i<=g;i++)o[i]=s=s+n[i-1]<<1;for(a=0;a<=t;a++)0!==(r=e[2*a+1])&&(e[2*a]=l(o[r]++,r))}(a,f.max_code,e.bl_count)}}function he(e,t,n,i,a){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=a}function t(e,t,n,i,a){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=a}function fe(e,t,n,i){var a=e[2*t],r=e[2*n];return a<r||a==r&&i[t]<=i[n]}function n(){function o(){var e;for(e=0;e<286;e++)J[2*e]=0;for(e=0;e<30;e++)Q[2*e]=0;for(e=0;e<19;e++)$[2*e]=0;J[512]=1,se.opt_len=se.static_len=0,ne=r=0}function s(e,t){var n,i,a=-1,r=e[1],o=0,s=7,l=4;for(0===r&&(s=138,l=3),e[2*(t+1)+1]=65535,n=0;n<=t;n++)i=r,r=e[2*(n+1)+1],++o<s&&i==r||(o<l?$[2*i]+=o:0!==i?(i!=a&&$[2*i]++,$[32]++):o<=10?$[34]++:$[36]++,a=i,l=(o=0)===r?(s=138,3):i==r?(s=6,3):(s=7,4))}function l(e){se.pending_buf[se.pending++]=e}function d(e){l(255&e),l(e>>>8&255)}function c(e,t){var n,i=t;16-i<oe?(d(re|=(n=e)<<oe&65535),re=n>>>16-oe,oe+=i-16):(re|=e<<oe&65535,oe+=i)}function u(e,t){var n=2*e;c(65535&t[n],65535&t[1+n])}function h(e,t){var n,i,a=-1,r=e[1],o=0,s=7,l=4;for(0===r&&(s=138,l=3),n=0;n<=t;n++)if(i=r,r=e[2*(n+1)+1],!(++o<s&&i==r)){if(o<l)for(;u(i,$),0!=--o;);else 0!==i?(i!=a&&(u(i,$),o--),u(16,$),c(o-3,2)):o<=10?(u(17,$),c(o-3,3)):(u(18,$),c(o-11,7));a=i,l=(o=0)===r?(s=138,3):i==r?(s=6,3):(s=7,4)}}function f(){16==oe?(d(re),oe=re=0):8<=oe&&(l(255&re),re>>>=8,oe-=8)}function g(e,t){var n,i,a;if(se.pending_buf[ie+2*ne]=e>>>8&255,se.pending_buf[ie+2*ne+1]=255&e,se.pending_buf[ee+ne]=255&t,ne++,0===e?J[2*t]++:(r++,e--,J[2*(ue._length_code[t]+256+1)]++,Q[2*ue.d_code(e)]++),0==(8191&ne)&&2<Y){for(n=8*ne,i=O-V,a=0;a<30;a++)n+=Q[2*a]*(5+ue.extra_dbits[a]);if(n>>>=3,r<Math.floor(ne/2)&&n<Math.floor(i/2))return!0}return ne==te-1}function p(e,t){var n,i,a,r,o=0;if(0!==ne)for(;n=se.pending_buf[ie+2*o]<<8&65280|255&se.pending_buf[ie+2*o+1],i=255&se.pending_buf[ee+o],o++,0===n?u(i,e):(u((a=ue._length_code[i])+256+1,e),0!==(r=ue.extra_lbits[a])&&c(i-=ue.base_length[a],r),u(a=ue.d_code(--n),t),0!==(r=ue.extra_dbits[a])&&c(n-=ue.base_dist[a],r)),o<ne;);u(256,e),ae=e[513]}function m(){8<oe?d(re):0<oe&&l(255&re),oe=re=0}function v(e,t,n){var i,a,r;c(0+(n?1:0),3),i=e,a=t,r=!0,m(),ae=8,r&&(d(a),d(~a)),se.pending_buf.set(M.subarray(i,i+a),se.pending),se.pending+=a}function t(e,t,n){var i,a,r=0;0<Y?(le.build_tree(se),de.build_tree(se),r=function(){var e;for(s(J,le.max_code),s(Q,de.max_code),ce.build_tree(se),e=18;3<=e&&0===$[2*ue.bl_order[e]+1];e--);return se.opt_len+=3*(e+1)+5+5+4,e}(),(a=se.static_len+3+7>>>3)<=(i=se.opt_len+3+7>>>3)&&(i=a)):i=a=t+5,t+4<=i&&-1!=e?v(e,t,n):a==i?(c(2+(n?1:0),3),p(he.static_ltree,he.static_dtree)):(c(4+(n?1:0),3),function(e,t,n){var i;for(c(e-257,5),c(t-1,5),c(n-4,4),i=0;i<n;i++)c($[2*ue.bl_order[i]+1],3);h(J,e-1),h(Q,t-1)}(le.max_code+1,de.max_code+1,r+1),p(J,Q)),o(),n&&m()}function b(e){t(0<=V?V:-1,O-V,e),V=O,P.flush_pending()}function w(){var e,t,n,i;do{if(0===(i=a-H-O)&&0===O&&0===H)i=_;else if(-1==i)i--;else if(_+_-262<=O){for(M.set(M.subarray(_,_+_),0),N-=_,O-=_,V-=_,n=e=F;t=65535&E[--n],E[n]=_<=t?t-_:0,0!=--e;);for(n=e=_;t=65535&A[--n],A[n]=_<=t?t-_:0,0!=--e;);i+=_}if(0===P.avail_in)return;e=P.read_buf(M,O+H,i),3<=(H+=e)&&(D=((D=255&M[O])<<R^255&M[O+1])&B)}while(H<262&&0!==P.avail_in)}function x(e){var t,n,i=G,a=O,r=X,o=_-262<O?O-(_-262):0,s=Z,l=T,d=O+258,c=M[a+r-1],u=M[a+r];q<=X&&(i>>=2),H<s&&(s=H);do{if(M[(t=e)+r]==u&&M[t+r-1]==c&&M[t]==M[a]&&M[++t]==M[a+1]){a+=2,t++;do{}while(M[++a]==M[++t]&&M[++a]==M[++t]&&M[++a]==M[++t]&&M[++a]==M[++t]&&M[++a]==M[++t]&&M[++a]==M[++t]&&M[++a]==M[++t]&&M[++a]==M[++t]&&a<d);if(n=258-(d-a),a=d-258,r<n){if(N=e,s<=(r=n))break;c=M[a+r-1],u=M[a+r]}}}while((e=65535&A[e&l])>o&&0!=--i);return r<=H?r:H}function k(e){return e.total_in=e.total_out=0,e.msg=null,se.pending=0,C=113,y=se.pending_out=0,le.dyn_tree=J,le.stat_desc=he.static_l_desc,de.dyn_tree=Q,de.stat_desc=he.static_d_desc,ce.dyn_tree=$,ce.stat_desc=he.static_bl_desc,oe=re=0,ae=8,o(),function(){var e;for(a=2*_,e=E[F-1]=0;e<F-1;e++)E[e]=0;j=ge[Y].max_lazy,q=ge[Y].good_length,Z=ge[Y].nice_length,G=ge[Y].max_chain,U=X=2,D=z=H=V=O=0}(),0}var P,C,S,y,_,I,T,M,a,A,E,D,F,L,B,R,V,U,W,z,O,N,H,X,G,j,Y,K,q,Z,J,Q,$,ee,te,ne,ie,r,ae,re,oe,se=this,le=new ue,de=new ue,ce=new ue;se.depth=[],se.bl_count=[],se.heap=[],J=[],Q=[],$=[],se.pqdownheap=function(e,t){for(var n=se.heap,i=n[t],a=t<<1;a<=se.heap_len&&(a<se.heap_len&&fe(e,n[a+1],n[a],se.depth)&&a++,!fe(e,i,n[a],se.depth));)n[t]=n[a],t=a,a<<=1;n[t]=i},se.deflateInit=function(e,t,n,i,a,r){return i=i||8,a=a||8,r=r||0,e.msg=null,-1==t&&(t=6),a<1||9<a||8!=i||n<9||15<n||t<0||9<t||r<0||2<r?-2:(e.dstate=se,T=(_=1<<(I=n))-1,B=(F=1<<(L=a+7))-1,R=Math.floor((L+3-1)/3),M=new Uint8Array(2*_),A=[],E=[],te=1<<a+6,se.pending_buf=new Uint8Array(4*te),S=4*te,ie=Math.floor(te/2),ee=3*te,Y=t,K=r,k(e))},se.deflateEnd=function(){return 42!=C&&113!=C&&666!=C?-2:(se.pending_buf=null,se.dstate=M=A=E=null,113==C?-3:0)},se.deflateParams=function(e,t,n){var i=0;return-1==t&&(t=6),t<0||9<t||n<0||2<n?-2:(ge[Y].func!=ge[t].func&&0!==e.total_in&&(i=e.deflate(1)),Y!=t&&(j=ge[Y=t].max_lazy,q=ge[Y].good_length,Z=ge[Y].nice_length,G=ge[Y].max_chain),K=n,i)},se.deflateSetDictionary=function(e,t,n){var i,a=n,r=0;if(!t||42!=C)return-2;if(a<3)return 0;for(_-262<a&&(r=n-(a=_-262)),M.set(t.subarray(r,r+a),0),V=O=a,D=((D=255&M[0])<<R^255&M[1])&B,i=0;i<=a-3;i++)A[i&T]=E[D=(D<<R^255&M[i+2])&B],E[D]=i;return 0},se.deflate=function(e,t){var n,i,a,r,o,s;if(4<t||t<0)return-2;if(!e.next_out||!e.next_in&&0!==e.avail_in||666==C&&4!=t)return e.msg=pe[4],-2;if(0===e.avail_out)return e.msg=pe[7],-5;if(P=e,r=y,y=t,42==C&&(i=8+(I-8<<4)<<8,3<(a=(Y-1&255)>>1)&&(a=3),i|=a<<6,0!==O&&(i|=32),C=113,l((s=i+=31-i%31)>>8&255),l(255&s)),0!==se.pending){if(P.flush_pending(),0===P.avail_out)return y=-1,0}else if(0===P.avail_in&&t<=r&&4!=t)return P.msg=pe[7],-5;if(666==C&&0!==P.avail_in)return e.msg=pe[7],-5;if(0!==P.avail_in||0!==H||0!=t&&666!=C){switch(o=-1,ge[Y].func){case 0:o=function(e){var t,n=65535;for(S-5<n&&(n=S-5);;){if(H<=1){if(w(),0===H&&0==e)return 0;if(0===H)break}if(O+=H,t=V+n,((H=0)===O||t<=O)&&(H=O-t,O=t,b(!1),0===P.avail_out))return 0;if(_-262<=O-V&&(b(!1),0===P.avail_out))return 0}return b(4==e),0===P.avail_out?4==e?2:0:4==e?3:1}(t);break;case 1:o=function(e){for(var t,n=0;;){if(H<262){if(w(),H<262&&0==e)return 0;if(0===H)break}if(3<=H&&(n=65535&E[D=(D<<R^255&M[O+2])&B],A[O&T]=E[D],E[D]=O),0!==n&&(O-n&65535)<=_-262&&2!=K&&(U=x(n)),3<=U)if(t=g(O-N,U-3),H-=U,U<=j&&3<=H){for(U--;n=65535&E[D=(D<<R^255&M[++O+2])&B],A[O&T]=E[D],E[D]=O,0!=--U;);O++}else O+=U,U=0,D=((D=255&M[O])<<R^255&M[O+1])&B;else t=g(0,255&M[O]),H--,O++;if(t&&(b(!1),0===P.avail_out))return 0}return b(4==e),0===P.avail_out?4==e?2:0:4==e?3:1}(t);break;case 2:o=function(e){for(var t,n,i=0;;){if(H<262){if(w(),H<262&&0==e)return 0;if(0===H)break}if(3<=H&&(i=65535&E[D=(D<<R^255&M[O+2])&B],A[O&T]=E[D],E[D]=O),X=U,W=N,U=2,0!==i&&X<j&&(O-i&65535)<=_-262&&(2!=K&&(U=x(i)),U<=5&&(1==K||3==U&&4096<O-N)&&(U=2)),3<=X&&U<=X){for(n=O+H-3,t=g(O-1-W,X-3),H-=X-1,X-=2;++O<=n&&(i=65535&E[D=(D<<R^255&M[O+2])&B],A[O&T]=E[D],E[D]=O),0!=--X;);if(z=0,U=2,O++,t&&(b(!1),0===P.avail_out))return 0}else if(0!==z){if((t=g(0,255&M[O-1]))&&b(!1),O++,H--,0===P.avail_out)return 0}else z=1,O++,H--}return 0!==z&&(t=g(0,255&M[O-1]),z=0),b(4==e),0===P.avail_out?4==e?2:0:4==e?3:1}(t)}if(2!=o&&3!=o||(C=666),0==o||2==o)return 0===P.avail_out&&(y=-1),0;if(1==o){if(1==t)c(2,3),u(256,he.static_ltree),f(),1+ae+10-oe<9&&(c(2,3),u(256,he.static_ltree),f()),ae=7;else if(v(0,0,!1),3==t)for(n=0;n<F;n++)E[n]=0;if(P.flush_pending(),0===P.avail_out)return y=-1,0}}return 4!=t?0:1}}function i(){this.next_in_index=0,this.next_out_index=0,this.avail_in=0,this.total_in=0,this.avail_out=0,this.total_out=0}var g=15,p=573,a=[0,1,2,3,4,4,5,5,6,6,6,6,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,0,0,16,17,18,18,19,19,20,20,20,20,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29];ue._length_code=[0,1,2,3,4,5,6,7,8,8,9,9,10,10,11,11,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28],ue.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],ue.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],ue.d_code=function(e){return e<256?a[e]:a[256+(e>>>7)]},ue.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ue.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],ue.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],ue.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],he.static_ltree=[12,8,140,8,76,8,204,8,44,8,172,8,108,8,236,8,28,8,156,8,92,8,220,8,60,8,188,8,124,8,252,8,2,8,130,8,66,8,194,8,34,8,162,8,98,8,226,8,18,8,146,8,82,8,210,8,50,8,178,8,114,8,242,8,10,8,138,8,74,8,202,8,42,8,170,8,106,8,234,8,26,8,154,8,90,8,218,8,58,8,186,8,122,8,250,8,6,8,134,8,70,8,198,8,38,8,166,8,102,8,230,8,22,8,150,8,86,8,214,8,54,8,182,8,118,8,246,8,14,8,142,8,78,8,206,8,46,8,174,8,110,8,238,8,30,8,158,8,94,8,222,8,62,8,190,8,126,8,254,8,1,8,129,8,65,8,193,8,33,8,161,8,97,8,225,8,17,8,145,8,81,8,209,8,49,8,177,8,113,8,241,8,9,8,137,8,73,8,201,8,41,8,169,8,105,8,233,8,25,8,153,8,89,8,217,8,57,8,185,8,121,8,249,8,5,8,133,8,69,8,197,8,37,8,165,8,101,8,229,8,21,8,149,8,85,8,213,8,53,8,181,8,117,8,245,8,13,8,141,8,77,8,205,8,45,8,173,8,109,8,237,8,29,8,157,8,93,8,221,8,61,8,189,8,125,8,253,8,19,9,275,9,147,9,403,9,83,9,339,9,211,9,467,9,51,9,307,9,179,9,435,9,115,9,371,9,243,9,499,9,11,9,267,9,139,9,395,9,75,9,331,9,203,9,459,9,43,9,299,9,171,9,427,9,107,9,363,9,235,9,491,9,27,9,283,9,155,9,411,9,91,9,347,9,219,9,475,9,59,9,315,9,187,9,443,9,123,9,379,9,251,9,507,9,7,9,263,9,135,9,391,9,71,9,327,9,199,9,455,9,39,9,295,9,167,9,423,9,103,9,359,9,231,9,487,9,23,9,279,9,151,9,407,9,87,9,343,9,215,9,471,9,55,9,311,9,183,9,439,9,119,9,375,9,247,9,503,9,15,9,271,9,143,9,399,9,79,9,335,9,207,9,463,9,47,9,303,9,175,9,431,9,111,9,367,9,239,9,495,9,31,9,287,9,159,9,415,9,95,9,351,9,223,9,479,9,63,9,319,9,191,9,447,9,127,9,383,9,255,9,511,9,0,7,64,7,32,7,96,7,16,7,80,7,48,7,112,7,8,7,72,7,40,7,104,7,24,7,88,7,56,7,120,7,4,7,68,7,36,7,100,7,20,7,84,7,52,7,116,7,3,8,131,8,67,8,195,8,35,8,163,8,99,8,227,8],he.static_dtree=[0,5,16,5,8,5,24,5,4,5,20,5,12,5,28,5,2,5,18,5,10,5,26,5,6,5,22,5,14,5,30,5,1,5,17,5,9,5,25,5,5,5,21,5,13,5,29,5,3,5,19,5,11,5,27,5,7,5,23,5],he.static_l_desc=new he(he.static_ltree,ue.extra_lbits,257,286,g),he.static_d_desc=new he(he.static_dtree,ue.extra_dbits,0,30,g),he.static_bl_desc=new he(null,ue.extra_blbits,0,19,7);var ge=[new t(0,0,0,0,0),new t(4,4,8,4,1),new t(4,5,16,8,1),new t(4,6,32,32,1),new t(4,4,16,16,2),new t(8,16,32,32,2),new t(8,16,128,128,2),new t(8,32,128,256,2),new t(32,128,258,1024,2),new t(32,258,258,4096,2)],pe=["need dictionary","stream end","","","stream error","data error","","buffer error","",""];i.prototype={deflateInit:function(e,t){return this.dstate=new n,this.dstate.deflateInit(this,e,t=t||g)},deflate:function(e){return this.dstate?this.dstate.deflate(this,e):-2},deflateEnd:function(){if(!this.dstate)return-2;var e=this.dstate.deflateEnd();return this.dstate=null,e},deflateParams:function(e,t){return this.dstate?this.dstate.deflateParams(this,e,t):-2},deflateSetDictionary:function(e,t){return this.dstate?this.dstate.deflateSetDictionary(this,e,t):-2},read_buf:function(e,t,n){var i=this.avail_in;return n<i&&(i=n),0===i?0:(this.avail_in-=i,e.set(this.next_in.subarray(this.next_in_index,this.next_in_index+i),t),this.next_in_index+=i,this.total_in+=i,i)},flush_pending:function(){var e=this,t=e.dstate.pending;e.avail_out<t&&(t=e.avail_out),0!==t&&(e.next_out.set(e.dstate.pending_buf.subarray(e.dstate.pending_out,e.dstate.pending_out+t),e.next_out_index),e.next_out_index+=t,e.dstate.pending_out+=t,e.total_out+=t,e.avail_out-=t,e.dstate.pending-=t,0===e.dstate.pending&&(e.dstate.pending_out=0))}};var r=e.zip||e;r.Deflater=r._jzlib_Deflater=function(e){var s=new i,l=new Uint8Array(512),t=e?e.level:-1;void 0===t&&(t=-1),s.deflateInit(t),s.next_out=l,this.append=function(e,t){var n,i=[],a=0,r=0,o=0;if(e.length){s.next_in_index=0,s.next_in=e,s.avail_in=e.length;do{if(s.next_out_index=0,s.avail_out=512,0!=s.deflate(0))throw new Error("deflating: "+s.msg);s.next_out_index&&i.push(512==s.next_out_index?new Uint8Array(l):new Uint8Array(l.subarray(0,s.next_out_index))),o+=s.next_out_index,t&&0<s.next_in_index&&s.next_in_index!=a&&(t(s.next_in_index),a=s.next_in_index)}while(0<s.avail_in||0===s.avail_out);return n=new Uint8Array(o),i.forEach(function(e){n.set(e,r),r+=e.length}),n}},this.flush=function(){var e,t,n=[],i=0,a=0;do{if(s.next_out_index=0,s.avail_out=512,1!=(e=s.deflate(4))&&0!=e)throw new Error("deflating: "+s.msg);0<512-s.avail_out&&n.push(new Uint8Array(l.subarray(0,s.next_out_index))),a+=s.next_out_index}while(0<s.avail_in||0===s.avail_out);return s.deflateEnd(),t=new Uint8Array(a),n.forEach(function(e){t.set(e,i),i+=e.length}),t}}}(this),function(e){"use strict";function D(){function c(e,t,n,i,a,r,o,s,l,d,c){var u,h,f,g,p,m,v,b,w,x,k,P,C,S,y;for(x=0,p=n;_[e[t+x]]++,x++,0!==--p;);if(_[0]==n)return o[0]=-1,s[0]=0,F;for(b=s[0],m=1;m<=A&&0===_[m];m++);for(b<(v=m)&&(b=m),p=A;0!==p&&0===_[p];p--);for((f=p)<b&&(b=p),s[0]=b,S=1<<m;m<p;m++,S<<=1)if((S-=_[m])<0)return R;if((S-=_[p])<0)return R;for(_[p]+=S,M[1]=m=0,x=1,C=2;0!=--p;)M[C]=m+=_[x],C++,x++;for(x=p=0;0!==(m=e[t+x])&&(c[M[m]++]=p),x++,++p<n;);for(n=M[f],M[0]=p=0,g=-1,P=-b,y=k=T[x=0]=0;v<=f;v++)for(u=_[v];0!=u--;){for(;P+b<v;){if(g++,y=b<(y=f-(P+=b))?b:y,(h=1<<(m=v-P))>u+1&&(h-=u+1,C=v,m<y))for(;++m<y&&!((h<<=1)<=_[++C]);)h-=_[C];if(W<d[0]+(y=1<<m))return R;T[g]=k=d[0],d[0]+=y,0!==g?(M[g]=p,I[0]=m,I[1]=b,I[2]=k-T[g-1]-(m=p>>>P-b),l.set(I,3*(T[g-1]+m))):o[0]=k}for(I[1]=v-P,n<=x?I[0]=192:c[x]<i?(I[0]=c[x]<256?0:96,I[2]=c[x++]):(I[0]=r[c[x]-i]+16+64,I[2]=a[c[x++]-i]),h=1<<v-P,m=p>>>P;m<y;m+=h)l.set(I,3*(k+m));for(m=1<<v-1;0!=(p&m);m>>>=1)p^=m;for(p^=m,w=(1<<P)-1;(p&w)!=M[g];)g--,w=(1<<(P-=b))-1}return 0!==S&&1!=f?V:F}function u(e){var t;for(h||(h=[],f=[],_=new Int32Array(A+1),I=[],T=new Int32Array(A),M=new Int32Array(A+1)),f.length<e&&(f=[]),t=0;t<e;t++)f[t]=0;for(t=0;t<A+1;t++)_[t]=0;for(t=0;t<3;t++)I[t]=0;T.set(_.subarray(0,A),0),M.set(_.subarray(0,A+1),0)}var h,f,_,I,T,M;this.inflate_trees_bits=function(e,t,n,i,a){var r;return u(19),(r=c(e,h[0]=0,19,19,null,null,n,t,i,h,f))==R?a.msg="oversubscribed dynamic bit lengths tree":r!=V&&0!==t[0]||(a.msg="incomplete dynamic bit lengths tree",r=R),r},this.inflate_trees_dynamic=function(e,t,n,i,a,r,o,s,l){var d;return u(288),(d=c(n,h[0]=0,e,257,p,m,r,i,s,h,f))!=F||0===i[0]?(d==R?l.msg="oversubscribed literal/length tree":d!=g&&(l.msg="incomplete literal/length tree",d=R),d):(u(288),(d=c(n,e,t,0,v,b,o,a,s,h,f))!=F||0===a[0]&&257<e?(d==R?l.msg="oversubscribed distance tree":d==V?(l.msg="incomplete distance tree",d=R):d!=g&&(l.msg="empty distance tree with lengths",d=R),d):F)}}function n(){function f(e,t,n,i,a,r,o,s){var l,d,c,u,h,f,g,p,m,v,b,w,x,k,P,C;g=s.next_in_index,p=s.avail_in,h=o.bitb,f=o.bitk,v=(m=o.write)<o.read?o.read-m-1:o.end-m,b=U[e],w=U[t];do{for(;f<20;)p--,h|=(255&s.read_byte(g++))<<f,f+=8;if(0!==(u=(d=n)[C=3*((c=i)+(l=h&b))]))for(;;){if(h>>=d[C+1],f-=d[C+1],0!=(16&u)){for(x=d[C+2]+(h&U[u&=15]),h>>=u,f-=u;f<15;)p--,h|=(255&s.read_byte(g++))<<f,f+=8;for(u=(d=a)[C=3*((c=r)+(l=h&w))];;){if(h>>=d[C+1],f-=d[C+1],0!=(16&u)){for(u&=15;f<u;)p--,h|=(255&s.read_byte(g++))<<f,f+=8;if(k=d[C+2]+(h&U[u]),h>>=u,f-=u,v-=x,k<=m)0<m-(P=m-k)&&m-P<2?(o.window[m++]=o.window[P++],o.window[m++]=o.window[P++]):(o.window.set(o.window.subarray(P,P+2),m),m+=2,P+=2),x-=2;else{for(P=m-k;(P+=o.end)<0;);if((u=o.end-P)<x){if(x-=u,0<m-P&&m-P<u)for(;o.window[m++]=o.window[P++],0!=--u;);else o.window.set(o.window.subarray(P,P+u),m),m+=u,P+=u,u=0;P=0}}if(0<m-P&&m-P<x)for(;o.window[m++]=o.window[P++],0!=--x;);else o.window.set(o.window.subarray(P,P+x),m),m+=x,P+=x,x=0;break}if(0!=(64&u))return s.msg="invalid distance code",p+=x=f>>3<(x=s.avail_in-p)?f>>3:x,g-=x,f-=x<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,R;l+=d[C+2],u=d[C=3*(c+(l+=h&U[u]))]}break}if(0!=(64&u))return 0!=(32&u)?(p+=x=f>>3<(x=s.avail_in-p)?f>>3:x,g-=x,f-=x<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,L):(s.msg="invalid literal/length code",p+=x=f>>3<(x=s.avail_in-p)?f>>3:x,g-=x,f-=x<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,R);if(l+=d[C+2],0===(u=d[C=3*(c+(l+=h&U[u]))])){h>>=d[C+1],f-=d[C+1],o.window[m++]=d[C+2],v--;break}}else h>>=d[C+1],f-=d[C+1],o.window[m++]=d[C+2],v--}while(258<=v&&10<=p);return p+=x=f>>3<(x=s.avail_in-p)?f>>3:x,g-=x,f-=x<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,F}var g,p,m,v,b=0,w=0,x=0,k=0,P=0,C=0,S=0,y=0,_=0,I=0;this.init=function(e,t,n,i,a,r){g=T,S=e,y=t,m=n,_=i,v=a,I=r,p=null},this.proc=function(e,t,n){var i,a,r,o,s,l,d,c=0,u=0,h=0;for(h=t.next_in_index,o=t.avail_in,c=e.bitb,u=e.bitk,l=(s=e.write)<e.read?e.read-s-1:e.end-s;;)switch(g){case T:if(258<=l&&10<=o&&(e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,n=f(S,y,m,_,v,I,e,t),h=t.next_in_index,o=t.avail_in,c=e.bitb,u=e.bitk,l=(s=e.write)<e.read?e.read-s-1:e.end-s,n!=F)){g=n==L?X:j;break}x=S,p=m,w=_,g=M;case M:for(i=x;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(h++))<<u,u+=8}if(c>>>=p[(a=3*(w+(c&U[i])))+1],u-=p[a+1],0===(r=p[a])){k=p[a+2],g=H;break}if(0!=(16&r)){P=15&r,b=p[a+2],g=E;break}if(0==(64&r)){x=r,w=a/3+p[a+2];break}if(0==(32&r))return g=j,t.msg="invalid literal/length code",n=R,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);g=X;break;case E:for(i=P;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(h++))<<u,u+=8}b+=c&U[i],c>>=i,u-=i,x=y,p=v,w=I,g=z;case z:for(i=x;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(h++))<<u,u+=8}if(c>>=p[(a=3*(w+(c&U[i])))+1],u-=p[a+1],0!=(16&(r=p[a]))){P=15&r,C=p[a+2],g=O;break}if(0!=(64&r))return g=j,t.msg="invalid distance code",n=R,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);x=r,w=a/3+p[a+2];break;case O:for(i=P;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(h++))<<u,u+=8}C+=c&U[i],c>>=i,u-=i,g=N;case N:for(d=s-C;d<0;)d+=e.end;for(;0!==b;){if(0===l&&(s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l&&(e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l)))return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);e.window[s++]=e.window[d++],l--,d==e.end&&(d=0),b--}g=T;break;case H:if(0===l&&(s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l&&(e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l)))return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=F,e.window[s++]=k,l--,g=T;break;case X:if(7<u&&(u-=8,o++,h--),e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,e.read!=e.write)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);g=G;case G:return n=L,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);case j:return n=R,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);default:return n=B,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n)}},this.free=function(){}}function i(e,t){var x,k=this,P=K,C=0,S=0,y=0,_=[0],I=[0],T=new n,M=0,A=new Int32Array(3*W),E=new D;k.bitk=0,k.bitb=0,k.window=new Uint8Array(t),k.end=t,k.read=0,k.write=0,k.reset=function(e,t){t&&(t[0]=0),P==ee&&T.free(e),P=K,k.bitk=0,k.bitb=0,k.read=k.write=0},k.reset(e,null),k.inflate_flush=function(e,t){var n,i,a;return i=e.next_out_index,e.avail_out<(n=((a=k.read)<=k.write?k.write:k.end)-a)&&(n=e.avail_out),0!==n&&t==V&&(t=F),e.avail_out-=n,e.total_out+=n,e.next_out.set(k.window.subarray(a,a+n),i),i+=n,(a+=n)==k.end&&(a=0,k.write==k.end&&(k.write=0),e.avail_out<(n=k.write-a)&&(n=e.avail_out),0!==n&&t==V&&(t=F),e.avail_out-=n,e.total_out+=n,e.next_out.set(k.window.subarray(a,a+n),i),i+=n,a+=n),e.next_out_index=i,k.read=a,t},k.proc=function(e,t){var n,i,a,r,o,s,l,d;for(r=e.next_in_index,o=e.avail_in,i=k.bitb,a=k.bitk,l=(s=k.write)<k.read?k.read-s-1:k.end-s;;)switch(P){case K:for(;a<3;){if(0===o)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(r++))<<a,a+=8}switch(M=1&(n=7&i),n>>>1){case 0:i>>>=3,i>>>=n=7&(a-=3),a-=n,P=q;break;case 1:var c=[],u=[],h=[[]],f=[[]];D.inflate_trees_fixed(c,u,h,f),T.init(c[0],u[0],h[0],0,f[0],0),i>>>=3,a-=3,P=ee;break;case 2:i>>>=3,a-=3,P=J;break;case 3:return i>>>=3,a-=3,P=ie,e.msg="invalid block type",t=R,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t)}break;case q:for(;a<32;){if(0===o)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(r++))<<a,a+=8}if((~i>>>16&65535)!=(65535&i))return P=ie,e.msg="invalid stored block lengths",t=R,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);C=65535&i,i=a=0,P=0!==C?Z:0!==M?te:K;break;case Z:if(0===o)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);if(0===l&&(s==k.end&&0!==k.read&&(l=(s=0)<k.read?k.read-s-1:k.end-s),0===l&&(k.write=s,t=k.inflate_flush(e,t),l=(s=k.write)<k.read?k.read-s-1:k.end-s,s==k.end&&0!==k.read&&(l=(s=0)<k.read?k.read-s-1:k.end-s),0===l)))return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);if(t=F,o<(n=C)&&(n=o),l<n&&(n=l),k.window.set(e.read_buf(r,n),s),r+=n,o-=n,s+=n,l-=n,0!=(C-=n))break;P=0!==M?te:K;break;case J:for(;a<14;){if(0===o)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(r++))<<a,a+=8}if(S=n=16383&i,29<(31&n)||29<(n>>5&31))return P=ie,e.msg="too many length or distance symbols",t=R,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);if(n=258+(31&n)+(n>>5&31),!x||x.length<n)x=[];else for(d=0;d<n;d++)x[d]=0;i>>>=14,a-=14,y=0,P=Q;case Q:for(;y<4+(S>>>10);){for(;a<3;){if(0===o)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(r++))<<a,a+=8}x[Y[y++]]=7&i,i>>>=3,a-=3}for(;y<19;)x[Y[y++]]=0;if(_[0]=7,(n=E.inflate_trees_bits(x,_,I,A,e))!=F)return(t=n)==R&&(x=null,P=ie),k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);y=0,P=$;case $:for(;!(258+(31&(n=S))+(n>>5&31)<=y);){var g,p;for(n=_[0];a<n;){if(0===o)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(r++))<<a,a+=8}if((p=A[3*(I[0]+(i&U[n=A[3*(I[0]+(i&U[n]))+1]]))+2])<16)i>>>=n,a-=n,x[y++]=p;else{for(d=18==p?7:p-14,g=18==p?11:3;a<n+d;){if(0===o)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(r++))<<a,a+=8}if(a-=n,g+=(i>>>=n)&U[d],i>>>=d,a-=d,258+(31&(n=S))+(n>>5&31)<(d=y)+g||16==p&&d<1)return x=null,P=ie,e.msg="invalid bit length repeat",t=R,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);for(p=16==p?x[d-1]:0;x[d++]=p,0!=--g;);y=d}}I[0]=-1;var m=[],v=[],b=[],w=[];if(m[0]=9,v[0]=6,(n=E.inflate_trees_dynamic(257+(31&(n=S)),1+(n>>5&31),x,m,v,b,w,A,e))!=F)return n==R&&(x=null,P=ie),t=n,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);T.init(m[0],v[0],A,b[0],A,w[0]),P=ee;case ee:if(k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,(t=T.proc(k,e,t))!=L)return k.inflate_flush(e,t);if(t=F,T.free(e),r=e.next_in_index,o=e.avail_in,i=k.bitb,a=k.bitk,l=(s=k.write)<k.read?k.read-s-1:k.end-s,0===M){P=K;break}P=te;case te:if(k.write=s,t=k.inflate_flush(e,t),l=(s=k.write)<k.read?k.read-s-1:k.end-s,k.read!=k.write)return k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);P=ne;case ne:return t=L,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);case ie:return t=R,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t);default:return t=B,k.bitb=i,k.bitk=a,e.avail_in=o,e.total_in+=r-e.next_in_index,e.next_in_index=r,k.write=s,k.inflate_flush(e,t)}},k.free=function(e){k.reset(e,null),A=k.window=null},k.set_dictionary=function(e,t,n){k.window.set(e.subarray(t,t+n),0),k.read=k.write=n},k.sync_point=function(){return P==q?1:0}}function t(){function o(e){return e&&e.istate?(e.total_in=e.total_out=0,e.msg=null,e.istate.mode=7,e.istate.blocks.reset(e,null),F):B}var n=this;n.mode=0,n.method=0,n.was=[0],n.need=0,n.marker=0,n.wbits=0,n.inflateEnd=function(e){return n.blocks&&n.blocks.free(e),n.blocks=null,F},n.inflateInit=function(e,t){return n.blocks=e.msg=null,t<8||15<t?(n.inflateEnd(e),B):(e.istate.blocks=new i(e,1<<(n.wbits=t)),o(e),F)},n.inflate=function(e,t){var n,i;if(!e||!e.istate||!e.next_in)return B;for(t=4==t?V:F,n=V;;)switch(e.istate.mode){case 0:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,8!=(15&(e.istate.method=e.read_byte(e.next_in_index++)))){e.istate.mode=13,e.msg="unknown compression method",e.istate.marker=5;break}if(e.istate.wbits<8+(e.istate.method>>4)){e.istate.mode=13,e.msg="invalid window size",e.istate.marker=5;break}e.istate.mode=1;case 1:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,i=255&e.read_byte(e.next_in_index++),((e.istate.method<<8)+i)%31!=0){e.istate.mode=13,e.msg="incorrect header check",e.istate.marker=5;break}if(0==(32&i)){e.istate.mode=7;break}e.istate.mode=2;case 2:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need=(255&e.read_byte(e.next_in_index++))<<24&4278190080,e.istate.mode=3;case 3:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<16&16711680,e.istate.mode=4;case 4:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<8&65280,e.istate.mode=5;case 5:return 0===e.avail_in?n:(n=t,e.avail_in--,e.total_in++,e.istate.need+=255&e.read_byte(e.next_in_index++),e.istate.mode=6,2);case 6:return e.istate.mode=13,e.msg="need dictionary",e.istate.marker=0,B;case 7:if((n=e.istate.blocks.proc(e,n))==R){e.istate.mode=13,e.istate.marker=0;break}if(n==F&&(n=t),n!=L)return n;n=t,e.istate.blocks.reset(e,e.istate.was),e.istate.mode=12;case 12:return L;case 13:return R;default:return B}},n.inflateSetDictionary=function(e,t,n){var i=0,a=n;return e&&e.istate&&6==e.istate.mode?(1<<e.istate.wbits<=a&&(i=n-(a=(1<<e.istate.wbits)-1)),e.istate.blocks.set_dictionary(t,i,a),e.istate.mode=7,F):B},n.inflateSync=function(e){var t,n,i,a,r;if(!e||!e.istate)return B;if(13!=e.istate.mode&&(e.istate.mode=13,e.istate.marker=0),0===(t=e.avail_in))return V;for(n=e.next_in_index,i=e.istate.marker;0!==t&&i<4;)e.read_byte(n)==s[i]?i++:i=0!==e.read_byte(n)?0:4-i,n++,t--;return e.total_in+=n-e.next_in_index,e.next_in_index=n,e.avail_in=t,4!=(e.istate.marker=i)?R:(a=e.total_in,r=e.total_out,o(e),e.total_in=a,e.total_out=r,e.istate.mode=7,F)},n.inflateSyncPoint=function(e){return e&&e.istate&&e.istate.blocks?e.istate.blocks.sync_point():B}}function a(){}var F=0,L=1,B=-2,R=-3,g=-4,V=-5,U=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],W=1440,r=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],o=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],p=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],m=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],v=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],b=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],A=15;D.inflate_trees_fixed=function(e,t,n,i){return e[0]=9,t[0]=5,n[0]=r,i[0]=o,F};var T=0,M=1,E=2,z=3,O=4,N=5,H=6,X=7,G=8,j=9,Y=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],K=0,q=1,Z=2,J=3,Q=4,$=5,ee=6,te=7,ne=8,ie=9,s=[0,0,255,255];a.prototype={inflateInit:function(e){return this.istate=new t,this.istate.inflateInit(this,e=e||15)},inflate:function(e){return this.istate?this.istate.inflate(this,e):B},inflateEnd:function(){if(!this.istate)return B;var e=this.istate.inflateEnd(this);return this.istate=null,e},inflateSync:function(){return this.istate?this.istate.inflateSync(this):B},inflateSetDictionary:function(e,t){return this.istate?this.istate.inflateSetDictionary(this,e,t):B},read_byte:function(e){return this.next_in.subarray(e,e+1)[0]},read_buf:function(e,t){return this.next_in.subarray(e,e+t)}};var l=e.zip||e;l.Inflater=l._jzlib_Inflater=function(){var l=new a,d=new Uint8Array(512),c=!1;l.inflateInit(),l.next_out=d,this.append=function(e,t){var n,i,a=[],r=0,o=0,s=0;if(0!==e.length){l.next_in_index=0,l.next_in=e,l.avail_in=e.length;do{if(l.next_out_index=0,l.avail_out=512,0!==l.avail_in||c||(c=!(l.next_in_index=0)),n=l.inflate(0),c&&n===V){if(0!==l.avail_in)throw new Error("inflating: bad input")}else if(n!==F&&n!==L)throw new Error("inflating: "+l.msg);if((c||n===L)&&l.avail_in===e.length)throw new Error("inflating: bad input");l.next_out_index&&a.push(512===l.next_out_index?new Uint8Array(d):new Uint8Array(d.subarray(0,l.next_out_index))),s+=l.next_out_index,t&&0<l.next_in_index&&l.next_in_index!=r&&(t(l.next_in_index),r=l.next_in_index)}while(0<l.avail_in||0===l.avail_out);return i=new Uint8Array(s),a.forEach(function(e){i.set(e,o),o+=e.length}),i}},this.flush=function(){l.inflateEnd()}}}(this),function(i){"use strict";function h(e){var t=i[e.codecClass],n=e.sn;if(f[n])throw Error("duplicated sn");f[n]={codec:new t(e.options),crcInput:"input"===e.crcType,crcOutput:"output"===e.crcType,crc:new a},postMessage({type:"newTask",sn:n})}function e(e){var t=e.sn,n=e.type,i=e.data,a=f[t];!a&&e.codecClass&&(h(e),a=f[t]);var r,o="append"===n,s=g();if(o)try{r=a.codec.append(i,function(e){postMessage({type:"progress",sn:t,loaded:e})})}catch(e){throw delete f[t],e}else delete f[t],r=a.codec.flush();var l=g()-s;s=g(),i&&a.crcInput&&a.crc.append(i),r&&a.crcOutput&&a.crc.append(r);var d=g()-s,c={type:n,sn:t,codecTime:l,crcTime:d},u=[];r&&u.push((c.data=r).buffer),o||!a.crcInput&&!a.crcOutput||(c.crc=a.crc.get());try{postMessage(c,u)}catch(e){postMessage(c)}}function a(){this.crc=-1}function t(){}i.zWorkerInitialized&&(i.zWorkerInitialized=!0),addEventListener("message",function(e){var t=e.data,n=t.type,i=t.sn,a=r[n];if(a)try{a(t)}catch(e){!function(e,t,n){var i,a={type:e,sn:t,error:{message:(i=n).message,stack:i.stack}};postMessage(a)}(n,i,e)}});var r={importScripts:function(e){e.scripts&&0<e.scripts.length&&importScripts.apply(void 0,e.scripts),postMessage({type:"importScripts"})},newTask:h,append:e,flush:e},f={},g=i.performance?i.performance.now.bind(i.performance):Date.now;a.prototype.append=function(e){for(var t=0|this.crc,n=this.table,i=0,a=0|e.length;i<a;i++)t=t>>>8^n[255&(t^e[i])];this.crc=t},a.prototype.get=function(){return~this.crc},a.prototype.table=function(){var e,t,n,i=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)1&n?n=n>>>1^3988292384:n>>>=1;i[e]=n}return i}(),(i.NOOP=t).prototype.append=function(e){return e},t.prototype.flush=function(){}}(this);var Ut,Wt,zt,Ot=function(){function o(e,t,n){var i=ot.getProperties().tickTime,a=e.sustain?e.sustainPoint+1:e.count;e.loopStartPoint=Math.min(e.loopStartPoint,e.count-1),e.loopEndPoint=Math.min(e.loopEndPoint,e.count-1);var r=e.loop&&e.loopStartPoint<e.loopEndPoint;e.sustain&&e.sustainPoint<=e.loopStartPoint&&(r=!1),r&&(a=e.loopEndPoint+1);var o=0;if(t.gain)var s=t.gain,l=0,d=64;else s=t.pan,d=l=32;s.setValueAtTime((e.points[0][1]-l)/d,n);for(var c=1;c<a;c++){var u=e.points[c];s.linearRampToValueAtTime((u[1]-l)/d,n+(o=u[0]*i))}return!!r&&f.scheduleEnvelopeLoop(t,n,2,o)}var f={type:"sample",name:"",instrumentIndex:0,sampleIndex:-1,fadeout:128,data:[]};return f.samples=[Ht()],f.sample=f.samples[0],f.volumeEnvelope={raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6},f.panningEnvelope={raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5},f.vibrato={},f.sampleNumberForNotes=[],f.play=function(e,t,n,i,a,r){return ot.inFTMode()&&(t=f.getPeriodForNote(e)),_e.playSample(f.instrumentIndex,t,n,i,a,r,e)},f.noteOn=function(e){var t,n,i={};if(f.volumeEnvelope.enabled){t=_e.context.createGain();var a=f.volumeEnvelope,r=o(a,t,e);r&&(i.volume=e+r)}return f.panningEnvelope.enabled&&_e.usePanning&&(n=_e.context.createStereoPanner(),(r=o(a=f.panningEnvelope,n,e))&&(i.panning=e+r)),f.vibrato.rate&&f.vibrato.depth&&(i.ticks=0,i.vibrato=e,i.vibratoFunction=f.getAutoVibratoFunction()),{volume:t,panning:n,scheduled:i}},f.noteOff=function(e,t){function n(){t.volume.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeEnvelope&&t.volumeEnvelope.gain.cancelScheduledValues(e),t.panningEnvelope&&t.panningEnvelope.pan.cancelScheduledValues(e),t.scheduled=void 0}if(t&&t.volume){if(ot.inFTMode()){var i=ot.getProperties().tickTime;if(f.volumeEnvelope.enabled){if(f.volumeEnvelope.sustain&&t.volumeEnvelope){n();var a=0,r=f.volumeEnvelope.points[f.volumeEnvelope.sustainPoint];r&&(a=r[0]*i);for(var o=f.volumeEnvelope.sustainPoint;o<f.volumeEnvelope.count;o++){var s=f.volumeEnvelope.points[o];s&&t.volumeEnvelope.gain.linearRampToValueAtTime(s[1]/64,e+s[0]*i-a)}}if(f.fadeout)t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+65536/f.fadeout*i/2)}else n(),t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+.1);if(f.panningEnvelope.enabled&&_e.usePanning&&t.panningEnvelope)for(a=0,(r=f.panningEnvelope.points[f.panningEnvelope.sustainPoint])&&(a=r[0]*i),o=f.panningEnvelope.sustainPoint;o<f.panningEnvelope.count;o++)(s=f.panningEnvelope.points[o])&&t.panningEnvelope.pan.linearRampToValueAtTime((s[1]-32)/32,e+s[0]*i-a);return 100}if(n(),!t.isKey||!t.volume)return 0;t.volume.gain.linearRampToValueAtTime(0,e+.5)}},f.scheduleEnvelopeLoop=function(e,t,n,i){i=i||0;var a=ot.getProperties().tickTime;if(e.gain)var r=f.volumeEnvelope,o=e.gain,s=0,l=64;else r=f.panningEnvelope,o=e.pan,l=s=32;var d=r.points[r.loopStartPoint],c=d[0];if(r.loop&&r.loopStartPoint<r.loopEndPoint)for(;i<n;)for(var u=i,h=r.loopStartPoint;h<=r.loopEndPoint;h++)o.linearRampToValueAtTime(((d=r.points[h])[1]-s)/l,t+(i=u+(d[0]-c)*a));return i},f.scheduleAutoVibrato=function(e,t){var n=0;e.scheduled.ticks=e.scheduled.ticks||0;var i,a,r,o,s=ot.getProperties().tickTime,l=-f.vibrato.rate/40,d=f.vibrato.depth/8;for(ot.useLinearFrequency&&(d*=4),e.source&&(i=e.startPeriod,a=e.scheduled.vibratoFunction||_e.waveFormFunction.sine,r=e.scheduled.vibrato||_e.context.currentTime,o=0);n<t;){if(n+=s,i){var c=1;f.vibrato.sweep&&e.scheduled.ticks<f.vibrato.sweep&&(c=1-(f.vibrato.sweep-e.scheduled.ticks)/f.vibrato.sweep);var u=a(i,e.scheduled.ticks,l,d*c);ot.setPeriodAtTime(e,u,r+o*s),o++}e.scheduled.ticks++}return n},f.getAutoVibratoFunction=function(){switch(f.vibrato.type){case 1:return _e.waveFormFunction.square;case 2:return _e.waveFormFunction.saw;case 3:return _e.waveFormFunction.sawInverse}return _e.waveFormFunction.sine},f.resetVolume=function(e,t){if(t.volumeFadeOut&&(t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.setValueAtTime(1,e)),t.volumeEnvelope){t.volumeEnvelope.gain.cancelScheduledValues(e);var n=ot.getProperties().tickTime,i=f.volumeEnvelope.sustain?f.volumeEnvelope.sustainPoint+1:f.volumeEnvelope.count;t.volumeEnvelope.gain.setValueAtTime(f.volumeEnvelope.points[0][1]/64,e);for(var a=1;a<i;a++){var r=f.volumeEnvelope.points[a];t.volumeEnvelope.gain.linearRampToValueAtTime(r[1]/64,e+r[0]*n)}}},f.getFineTune=function(){return ot.inFTMode()?f.sample.finetuneX:f.sample.finetune},f.setFineTune=function(e){ot.inFTMode()?(f.sample.finetuneX=e,f.sample.finetune=e>>4):(7<e&&(e-=16),f.sample.finetune=e,f.sample.finetuneX=e<<4)},f.getPeriodForNote=function(e,t){var n=0;return ot.useLinearFrequency?(n=7680-64*(e-1),t&&(n-=f.getFineTune()/2)):(n=at[e].period,t&&f.getFineTune()&&(n=_e.getFineTuneForNote(e,f.getFineTune()))),n},f.setSampleForNoteIndex=function(e){var t=f.sampleNumberForNotes[e-1];t!==f.sampleIndex&&"number"==typeof t&&f.setSampleIndex(t)},f.setSampleIndex=function(e){f.sampleIndex!==e&&(f.sample=f.samples[e],f.sampleIndex=e,ye.trigger(ce.sampleIndexChange,f.instrumentIndex))},f.hasSamples=function(){for(var e=0,t=f.samples.length;e<t;e++)if(f.samples[e].length)return!0},f.hasVibrato=function(){return f.vibrato.rate&&f.vibrato.depth},f},Nt=function(){var n={period:0,index:0,effect:0,instrument:0,param:0,volumeEffect:0,setPeriod:function(e){n.period=e,n.index=rt[e]||0},setIndex:function(e){var t=at[n.index=e];t?(n.period=t.modPeriod||t.period,1===n.period&&(n.period=0)):n.period=0},clear:function(){n.instrument=0,n.period=0,n.effect=0,n.param=0,n.index=0,n.volumeEffect=0},duplicate:function(){return{instrument:n.instrument,period:n.period,effect:n.effect,param:n.param,volumeEffect:n.volumeEffect,note:n.index}},populate:function(e){n.instrument=e.instrument||0,n.period=e.period||0,n.effect=e.effect||0,n.param=e.param||0,n.volumeEffect=e.volumeEffect||0,n.index=e.note||e.index||0}};return n},Ht=function(){var a={data:[],length:0,name:"",bits:8,volume:64,finetune:0,finetuneX:0,panning:0,relativeNote:0,loop:{enabled:!1,start:0,length:0,type:0},check:function(){for(var e=0,t=0,n=0,i=a.data.length;n<i;n++)e=Math.min(e,a.data[n]),t=Math.max(t,a.data[n]);return{min:e,max:t}}};return a},Xt=(zt=!(Wt="https://www.stef.be/bassoontracker/api/"),(Ut={}).putFile=function(){Ne.buildBinary(ot.inFTMode()?u:g,function(e){ot.getFileName(),He.sendBinary("https://www.stef.be/bassoontracker/api/storage/put/",e.buffer,function(e){})})},Ut.renderFile=function(i,a){if(!zt){zt=!0;var r=Wt+"storage/render/"+(ot.inFTMode()?"xm":"mod");i=i||ot.getFileName(),de.setStatus("saving file ...",!0),Ge.info("Rendering "+i),Ne.buildBinary(ot.inFTMode()?u:g,function(n){He.sendBinary(r,n.buffer,function(e){if("error"===e)de.setStatus("error saving file"),zt=!1;else{var t=e;de.setStatus("rendering file ...",!0),He.sendBinary(r=Wt+"storage/convert/"+t,n.buffer,function(e){"error"===e?(de.setStatus("Error rendering file ..."),zt=!1):(t=e,a?(de.setStatus("Converting file to mp3...",!0),He.sendBinary(r=Wt+"storage/wavtomp3/"+t,n.buffer,function(e){"error"===e?(de.setStatus("Error converting file to mp3..."),zt=!1):Gt(e,i,"mp3")})):Gt(t,i,"wav"))})}})})}},Ut.proxyUrl=function(e){return Wt+"proxy?"+encodeURIComponent(e)},Ut);function Gt(e,t,n){if(n){var i=!1,a=t.lastIndexOf(".");0<=a&&(i=t.substr(a+1).toLowerCase()===n.toLowerCase()),i||(t+="."+n)}de.setStatus("Downloading ..."),zt=!1,setTimeout(function(){de.setStatus("")},3e3),document.location.href=Wt+"storage/"+e+"?dl=1&name="+t}var jt,Yt,Kt,qt,Zt,Jt,Qt=((jt={}).isConnected=!1,jt.checkConnected=function(t){jt.isConnected&&t&&t(!0),dropboxService.getAccessToken()?dropboxService("users/get_current_account",void 0,{onComplete:function(e){e&&e.account_id&&(jt.isConnected=!0,t&&t(!0))},onError:function(){t&&t(!1)}}):t&&t(!1)},jt.showConnectDialog=function(){var n=de.modalDialog();n.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0,cancel:!0}),n.onClick=function(e){var t=n.getElementAtPoint(e.x,e.y);t&&t.name&&(de.setStatus(""),"okbutton"===t.name?Qt.authenticate():(n.close(),ye.trigger(ce.dropboxConnectCancel)))},n.setText("DROPBOX ://BassoonTracker is not yet connected to DropBox//Do you want to do that now?//(BassoonTracker will only have access/to its own BassoonTracker folder)"),de.setModalElement(n)},jt.authenticate=function(){dropboxService.clearAccessToken(),dropboxService.authenticate({client_id:"ukk9z4f0nd1xa13",redirect_uri:"https://www.stef.be/bassoontracker/auth/dropbox.html"},{onComplete:function(e){},onError:function(e){}})},jt.list=function(e,t){dropboxService("files/list_folder",{path:e},function(e){var n=[];e.entries.forEach(function(e){if(e[".tag"]&&"folder"===e[".tag"])n.push({title:e.name,url:e.path_lower,children:[]});else{var t=Math.floor(e.size/1e3)+"kb";n.push({title:e.name+" ("+t+")"||"---",url:e.id,path:e.path_display})}}),t(n)})},jt.get=function(e,t){jt.list(e,t)},jt.getFile=function(e,i){dropboxService("files/download",{path:e.url},function(e,t,n){i(t)})},jt.putFile=function(e,t,i){var n={path:e};"overwrite"===Se.dropboxMode?n.mode="overwrite":(n.mode="add",n.autorename=!0),dropboxService("files/upload",n,t,{onComplete:function(e,t,n){i&&i(e)},onError:function(e,t,n){i&&i(!1)}})},jt),$t=function(){function l(e,t){He.json(n+e,function(e){t(e)})}function d(e,t){He.json("https://www.stef.be/bassoontracker/api/"+e,function(e){e&&e.modarchive&&(e=e.modarchive),t(e)})}function c(e){var t=[];return e&&e.forEach(function(e){t.push({title:e.title||"---",url:"https://api.modarchive.org/downloads.php?moduleid="+e.id,icon:e.format,info:r(e.size)})}),t}function u(e,t){var n=[];if(e){if(e.module){var i=e.module;i.forEach?i.forEach(function(e){n.push({title:e.songtitle||"---",url:e.url,icon:"mod"})}):n.push({title:i.songtitle||"---",url:i.url,icon:"mod"})}if(e.totalpages){var a=parseInt(e.totalpages);if(1<a){var r=t[0]+"/",o=parseInt(t[1]||1);isNaN(o)&&(o=1),"artist/"!=r&&"genre/"!=r||(r+=t[1]+"/",o=parseInt(t[2]||1),isNaN(o)&&(o=1)),o<a&&n.push({title:"... load more ...",children:[],url:r+=o+1})}}}return n}var e={},n="http://localhost:3000/";n="https://www.stef.be/bassoontracker/api/ma/";var h=[],f=[];return e.get=function(e,t){var n,a,i=e.split("/"),r=i[1]||"",o=i[2]||"";switch(e=i[0]){case"genres":a=t,h.length?a&&a(h):l("genres",function(e){if(e){var i={};e.forEach(function(e){if(e.parent){var t={title:e.name,count:e.count,info:e.count+" >",children:[],url:"genre/"+e.id};i[e.parent]||(i[e.parent]=[]),i[e.parent].push(t)}}),e.forEach(function(e){if(!e.parent){var t={title:e.name,children:i[e.id]||[]},n=0;t.children.forEach(function(e){n+=e.count}),t.info=n+" >",h.push(t)}})}a&&a(h)});break;case"artists":n=t,f.length?n&&n(f):l("artists",function(e){e&&e.forEach(function(e){f.push({title:e.handle,children:[],info:e.count+" >",url:"artist/"+e.id})}),n&&n(f)});break;case"genre":l("genre/"+r,function(e){t(c(e))});break;case"toprating":d("toprating/"+(o=r||1),function(e){t(u(e,i))});break;case"topreview":d("topreview/"+(o=r||1),function(e){t(u(e,i))});break;case"artist":var s="artist/"+r;o&&(s+="/"+o),l(s,function(e){t(c(e))});break;default:t([])}},e}(),en=(Kt="https://www.stef.be/bassoontracker/api/mpl/",qt="https://www.stef.be/bassoontracker/api/modules.pl/",Zt=[],Jt=[],(Yt={}).get=function(e,t){var n,i,a,r,o,s=e.split("/"),l=s[1]||"",d=s[2]||"";switch(e=s[0]){case"genres":o=t,Zt.length?o&&o(Zt):tn("genres",function(e){e&&e.forEach(function(e){Zt.push({title:e.name,url:"genre/"+e.name,children:[],info:e.count+" >"})}),o&&o(Zt)});break;case"genre":a=t,r="genre/"+l,(i=d)&&(r+="/"+(i=parseInt(i))),tn(r,function(e){a(nn(e))});break;case"toprating":tn("toprating/"+(d=l||1),function(e){t(nn(e,"rate"))});break;case"topscore":tn("topscore/"+(d=l||1),function(e){t(nn(e,"score"))});break;case"artists":n=t,Jt.length?n&&n(Jt):tn("artists",function(e){e&&e.forEach(function(e){Jt.push({title:e.handle,info:e.count+" >",url:"artist/"+e.id,children:[]})}),n&&n(Jt)});break;case"artist":var c="artist/"+l;d&&(c+="/"+d),tn(c,function(e){t(nn(e))});break;default:t([])}},Yt);function tn(e,t){He.json(Kt+e,function(e){t(e)})}function nn(e,i){var a=[];return e&&e.forEach(function(e){var t=r(e.size),n=e.title||"---";i&&(n=e[i]+": "+n),a.push({title:n,url:qt+e.id,info:t,icon:e.format})}),a}var an,rn,on,sn=(rn={Nibbles:["script/plugins/games/nibbles/nibbles.js","script/plugins/games/nibbles/logo.png","script/plugins/games/nibbles/levels.png","script/plugins/games/nibbles/player1.png"]},on={},(an={}).register=function(e){on[e.name]=e},an.load=function(a,t){function r(e){n<=++i&&(a.loaded=!0,a.onLoad&&a.onLoad(),t&&t())}var e=a.name||a;if("object"==typeof window[e])t&&t();else{"string"==typeof a&&(a={name:a,src:rn[a]});var n,i,o=on[a.name];if(o)o.loading||t&&t();else a.src?(a.loading=!0,n=a.src.length,i=0,a.src.forEach(function(e){var n,t,i;switch(e.split(".").pop().toLowerCase()){case"js":t=e,(i=document.createElement("script")).type="application/javascript",i.src=t,i.addEventListener("error",r,!1),i.addEventListener("load",r,!1),document.getElementsByTagName("head")[0].appendChild(i);break;case"png":lt.loadImage(n=e,function(e){var t=n.split("/").pop().split(".")[0];lt.sprites[a.name+"."+t]=lt.sprite({img:e,width:e.width,height:e.height}),r()});break;default:r()}})):t&&t()}},an);return{init:ot.init,load:ot.load,playSong:ot.playSong,stop:ot.stop,togglePlay:ot.togglePlay,isPlaying:ot.isPlaying,getTrackCount:ot.getTrackCount,getSong:ot.getSong,getInstruments:ot.getInstruments,getStateAtTime:ot.getStateAtTime,getTimeStates:ot.getTimeStates,setCurrentSongPosition:ot.setCurrentSongPosition,setBPM:ot.setBPM,getBPM:ot.getBPM,setAmigaSpeed:ot.setAmigaSpeed,getAmigaSpeed:ot.getAmigaSpeed,setMaster:ot.setMaster,isMaster:ot.isMaster,audio:_e}};"undefined"!=typeof HostBridge&&HostBridge.customConfig||(BassoonTracker=BassoonTracker());